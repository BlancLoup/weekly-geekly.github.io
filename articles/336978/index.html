<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Traffic mirroring on Juniper MX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will talk about traffic mirroring on Juniper MX series routers. After Cisco, Huawei or Arista switches, the configuration of SPAN and RSPAN o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Traffic mirroring on Juniper MX</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/c3d/370/d2e/c3d370d2e3d548b0b390f5cf2f20930c.jpg" alt="image alt"></div><br>  Today we will talk about traffic mirroring on Juniper MX series routers.  After Cisco, Huawei or Arista switches, the configuration of SPAN and RSPAN on JunOS will seem very complicated, but the complex (at first glance) configuration hides the enormous capabilities of the MX platform in the area of ‚Äã‚Äãtraffic mirroring.  Although Juniper‚Äôs approach is complex at first glance, it becomes simple and straightforward if you don‚Äôt stupidly copy-paste configs from one box to another, but understand what is being done and why.  JunOS ideology suggests using filter based forwarding (FBF) for mirroring purposes, which gives us some flexibility in implementing complex traffic mirroring schemes. <br><br>  So, let's begin.  We will look at a few examples of mirroring: <br><br>  1. Local mirroring from port to port <br>  2. Mirroring into two or more consumers <br>  3. Mirroring to a remote host <br>  4. Selective mirroring for two or more consumers <br>  5. Local mirroring of L2 traffic <br>  6. Mirroring L2 traffic to a remote server <br>  7. Using more than two mirroring instances on one FPC 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So let's start in order. <a name="habracut"></a><br><br>  <b>Local mirroring from port to port.</b> <br><br>  Our test bench will be constantly changing - we will add consumers, change their desires for the received copy of traffic, etc.  At the first stage, the test bench looks like this: <br><img src="https://habrastorage.org/web/6c5/76b/2cd/6c576b2cdee14d7ebf290b5e5da106b8.png"><br><blockquote>  Note: at first I wanted to use a traffic generator, but then I decided that the packets generated by hping3 tcp / udp / icmp caught on a traffic analyzer (as the analyzer was used simply on the host with ubuntu server 14.04 on board) would be more obvious than just counters from ports in pps (for example, you can compare the relevance of sent and received data).  Counters should be used when carrying out load testing to check the performance of the router when using this functionality.  But there is no point in checking the performance on the virtual MX - it‚Äôs still going to rest on the capabilities of the virusization server. </blockquote><br>  Suppose that there is some kind of traffic exchange between Server-1 (11.0.0.1) and Server-2 (12.0.0.1).  The owners of the Analyzer-1 server want to see what exactly is transferred between these two servers, so we need to configure sending a copy of all traffic between Server-1 and Server-2 to Analyzer-1 ‚Äî that is, do local mirroring.  So let's get started. <br><br>  In theory, this should work like this: we create a mirroring instance in which we specify the parameters of the incoming traffic (how often the traffic is mirrored) and the outgoing parameters to which ports or ports to poison the traffic.  In order to send traffic to the instance created by us, you need to interface or interfaces, from which (s) we want to remove a copy of the traffic, hang a special filter, which will turn our traffic into the required instance.  That is, this is the classic scheme of policy base routing, or filter base routing in Juniper terms.  We figured out the theory, now let's move on to practice - we need to build such a mirroring scheme: <br><img src="https://habrastorage.org/web/3df/38e/339/3df38e3395a547e38909967270b78a50.png"><br>  First we need to create an instance in the hierarchy [edit forwarding-options port-mirroring], which we will use to mirror the traffic. <br><br><pre><code class="hljs pgsql">[edit forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> instance { SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> { rate <span class="hljs-number"><span class="hljs-number">1</span></span>; run-length <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { output { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } } } }</code> </pre> <br>  The instance configuration consists of two parts.  First, let's deal with the section of input - as it is not difficult to guess, these are the parameters of the incoming traffic, which must be mirrored.  The rate and run-length parameters are important here.  The first parameter is responsible for how often the packets will be mirrored (trigger trigger), the second parameter is responsible for how many packets will still be mirrored after triggering the trigger rate. <br><br>  In our case, the rate is set to 1, that is, each package will be mirrored.  Run-length is set to 0, since at a rate equal to 1 its presence does not play any role. <br><br>  For completeness, we will analyze the meaning of these parameters in a more illustrative example.  The rate parameter sets the frequency of traffic mirroring, suppose the rate is 5, that is, the trigger will be triggered on every 5th packet, which means every 5th packet will be mirrored.  Now suppose the run-length is set to 4. This tells us that another 4 packets will be mirrored after every 5th packet.  That is, the trigger first worked on the 5th packet - this packet will be mirrored, now another 4 packets, following the already mirrored one, will also be mirrored.  As a result, we get that we mirror every 5th packet, plus 4 more packets following it - a total of 100% of the traffic.  Changing these parameters can be mirrored, for example, every 10 packets out of 100 and so on (well, this is more necessary for sampling than mirroring, just the principle of operation is the same). <br><br>  If we go back to our case, then we mirror every packet, so we simply don‚Äôt need the run-length parameter and leave the default value equal to zero. <br><br>  To calculate the percentage of mirrored traffic, you can use the formula <u>% = ((run-length + 1) / rate) * 100)</u> .  It is logical that with the parameters run-length 1 and rate 1, we get the mirroring of 200% of the traffic or, for example, with the rate 1 and run-length 4 - 500% of the traffic.  I will disappoint or please you - more than 100% of traffic is not mirrored - Juniper packets will not multiply, which is more than logical.  Yes, and come up with a script when you need to make two copies of the same traffic, I could not (if anyone knows - write in the comments). <br><br>  And one more important parameter is maximum-packet-length.  This is the maximum packet size that will be mirrored.  If you set it to 128, for example, when you receive a packet that is more than 128 bytes (well, for example, 1514), the first 128 bytes will be cut off from it and sent to the consumer.  The rest of the package will simply be dropped.  This is convenient when you only need to send headers to the server and you do not need payloads.  It is not recommended to install less than 20 for ipv4. <br><br>  We now turn to the output parameters.  Here, in general, we need to specify the interface to which we go to mirror traffic.  In the case when we just have a p2p interface, we don‚Äôt need to specify anything else - everything will fly.  But as we all remember, ethernet is far from p2p (to be precise, this is csma / cd), and in addition to the interface we need to specify the address of the host to which the traffic is intended, both IP and MAC (but before that we will get to it later ).  I chose the address from the range of link-locale addresses to avoid any intersections with existing addresses - you can take any addressing, it absolutely does not change anything in the principle of the technology.  In ethernet, in order to send a packet to a host, the router needs to find out the host‚Äôs MAC address using ARP.  In my case, on the recipient server side, nothing is configured - just a blank interface and it turns out that the router will try in vain to resolve the address of the remote host.  Naturally all the mirroring is over.  How to be in this situation?  All ingenious is simple - a static ARP entry is made: <br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interfaces ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> description Analyzer<span class="hljs-number"><span class="hljs-number">-1</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { address <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">31</span></span> { arp <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> mac <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>; } } }</code> </pre><br>  As a result, we will have the following entry on the interface: <br><br><pre> <code class="hljs kotlin">[edit] <span class="hljs-symbol"><span class="hljs-symbol">bormoglotx@</span></span>RZN-PE-<span class="hljs-number"><span class="hljs-number">1</span></span># run show arp <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/1.0 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MAC</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Address</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Address</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Flags</span></span></span><span class="hljs-class"> 02:</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">00:00:00:00:01 169.254.0.1 169.254.0.1 ge-0/0/1.0 permanent</span></span></span></span></code> </pre><br>  Here I would like to stay in more detail.  Theoretically, you can send traffic to some real address configured on the server, but the simplest and most flexible approach is to create a fictitious IP address and ARP entry in the direction of the traffic consumer - that is, we simply make Juniper think that we have specified IP / MAC address, which ultimately causes the box to bluntly send traffic there without understanding, and whether there really is a specified host or not - the main thing is that the port was up.  The use of static ARP recording in mirroring has a great advantage - static ARP recording does not become outdated, and the router will not send requests to the ARP server (which can fall into the dump of the removed traffic, which is not very good). <br><br>  Now, in order for the traffic to become mirrored, we need to wrap it up in the instance we created.  Filter base forwarding is used for this.  We create a filter and apply it to the interface of interest to us: <br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> firewall <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> MIRROR&gt;&gt;&gt;SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> term MIRROR { <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> port-mirror-instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span>; } [edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interfaces ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span> description <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> MIRROR&gt;&gt;&gt;SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span>; output MIRROR&gt;&gt;&gt;SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span>; } address <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>; } }</code> </pre><br>  Since we need to collect both incoming and outgoing traffic, we hang the filter on in both directions. <br><br>  As practice shows, this filter does not block the passage of traffic between the servers themselves; therefore, it is not necessary to write an accept action, but for security it is often added. <br><br>  Now you can check the status of the mirroring session: <br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring Instance <span class="hljs-type"><span class="hljs-type">Name</span></span>: SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> Instance Id: <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> parameters: Rate : <span class="hljs-number"><span class="hljs-number">1</span></span> Run-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Maximum-packet-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Output parameters: <span class="hljs-keyword"><span class="hljs-keyword">Family</span></span> State Destination Next-hop <span class="hljs-type"><span class="hljs-type">inet</span></span> up ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span></code> </pre><br>  Apparently mirroring in work.  Now let's run 5 packages from Server-1 to Server-2 and see what we can catch on the Analyzer-1 analyzer: <br><br><pre> <code class="hljs sql">bormoglotx@Server-1:~$ sudo hping3 -S -c 5 12.0.0.1 -d 40 -I eth1 HPING 12.0.0.1 (eth1 12.0.0.1): S <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span> headers + <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">34108</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">0</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.4</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">34121</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">1</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.5</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">34229</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">2</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.5</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">34471</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">3</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.5</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">34635</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">4</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.5</span></span> ms <span class="hljs-comment"><span class="hljs-comment">--- 12.0.0.1 hping statistic --- 5 packets transmitted, 5 packets received, 0% packet loss</span></span></code> </pre><br>  Now let's see what we managed to do on the Analyzer-1 server: <br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-1:~$ sudo tcpdump -i eth1 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> ^C <span class="hljs-number"><span class="hljs-number">0</span></span> packets captured <span class="hljs-number"><span class="hljs-number">0</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br>  Everything is not so rosy, it is clear from the conclusion that nothing actually works with us, although Juniper reported to us in the conclusion above that everything is ok.  The fact is that the instance for mirroring can be created by ourselves (which we did) or use the default instance (it is one for the whole box).  If we create the instance ourselves, then we must associate this instance with the FPC, on which we do peacekeeping (if ports on several FPC, it means to associate with several).  Let's return to Juniper and specify the instance we created in the FPC configuration.  Why did I emphasize this?  The fact is that he stumbled upon it a couple of times and could not understand what the trick was - after all, the conclusions say that everything is fine. <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">edit</span></span>] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span><span class="hljs-meta"><span class="hljs-meta"># show | compare [edit] + chassis { + fpc 0 { + port-mirror-instance SPAN-1; + } + }</span></span></code> </pre> <br>  Now check again if the mirror works: <br><br><pre> <code class="hljs sql">bormoglotx@Server-1:~$ sudo hping3 -S -c 5 12.0.0.1 -d 40 -I eth1 HPING 12.0.0.1 (eth1 12.0.0.1): S <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span> headers + <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">43901</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">0</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">4.4</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">44117</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">1</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.4</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">44217</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">2</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.4</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">44412</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">3</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.7</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">44416</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">4</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.5</span></span> ms <span class="hljs-comment"><span class="hljs-comment">--- 12.0.0.1 hping statistic --- 5 packets transmitted, 5 packets received, 0% packet loss round-trip min/avg/max = 3.4/3.7/4.4 ms</span></span></code> </pre> <br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-1:~$ sudo tcpdump -i eth1 -B 4096 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">43.641475</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2237</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1075183755</span></span>:<span class="hljs-number"><span class="hljs-number">1075183795</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">43.642024</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2237</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1075183796</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">44.641981</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2238</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1410214066</span></span>:<span class="hljs-number"><span class="hljs-number">1410214106</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">44.642818</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2238</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1410214107</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">45.642022</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2239</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1858880488</span></span>:<span class="hljs-number"><span class="hljs-number">1858880528</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">45.642873</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2239</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1858880529</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">46.642127</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2240</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1472273281</span></span>:<span class="hljs-number"><span class="hljs-number">1472273321</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">46.642947</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2240</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1472273322</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">47.642017</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2241</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1810623498</span></span>:<span class="hljs-number"><span class="hljs-number">1810623538</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">47.642601</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2241</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1810623539</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ^C <span class="hljs-number"><span class="hljs-number">10</span></span> packets captured <span class="hljs-number"><span class="hljs-number">10</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br>  As a result, all traffic exchanges between Server-1 and Server-2 hit the analyzer, which is what we wanted. <br><br>  Moving on, our scheme has changed and now we have Analyzer-2, which also wants to receive all the traffic between Server-1 and Server-2: <br><img src="https://habrastorage.org/web/da6/d8e/43c/da6d8e43c2c44ffc82ddc937608abb7f.png"><br><br>  <b>Mirroring to two or more users</b> <br><br>  As a result, we have another task - we need to implement a new mirroring scheme, which looks like this: <br><img src="https://habrastorage.org/web/d04/ab9/494/d04ab9494f2147d190c564bbd8048deb.png"><br>  It seems to be nothing complicated - let's create an interface in the direction of Analyzer-2, add it to the instance and it's in the bag. <br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interfaces ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> description Analyzer<span class="hljs-number"><span class="hljs-number">-2</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { address <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">31</span></span> { arp <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> mac <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>; } } } [edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> { rate <span class="hljs-number"><span class="hljs-number">1</span></span>; run-length <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { output { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>; } } }</code> </pre> <br>  But when we try to add another port to the output hierarchy in the peacekeeping instance, we get an error when we commit: <br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> [edit forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> output] Port-mirroring <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> error Port-mirroring <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> multiple nexthops <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> allowed <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> this platform error: <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> failed</code> </pre> <br>  A terrible at first glance phrase - platform restrictions do not allow us to establish two next-hop at once for mirrored traffic.  But this restriction is very easy if we use next-hop groups. <br><br>  I think it‚Äôs clear what the next-hop group is - the name speaks for itself.  Juniper MX supports up to 30 next-hop groups, each of which can have up to 16 next-hop-in.  But besides this, next-hop subgroups can be created in each next-hop group.  In one next-hop group there should be at least two next-hop, otherwise JunOS will not allow to make a commit. <br><br>  Now let's move on to the configuration, create a next-hop group: <br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer-servers <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>; }</code> </pre> <br>  And now we will specify this group as next-hop in ouput: <br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> { rate <span class="hljs-number"><span class="hljs-number">1</span></span>; run-length <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { output { next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer-servers; } }</code> </pre> <br>  The rest of the config does not change. <br>  Let's go to check.  First, check the state of the next-hop group: <br><br><pre> <code class="hljs vhdl">bormoglotx@RZN-PE-<span class="hljs-number"><span class="hljs-number">1</span></span>&gt; show forwarding-options <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> detail <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span>-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: Analyzer-servers <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: inet State: up Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members configured : <span class="hljs-number"><span class="hljs-number">2</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members that are up : <span class="hljs-number"><span class="hljs-number">2</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups configured : <span class="hljs-number"><span class="hljs-number">0</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups that are up : <span class="hljs-number"><span class="hljs-number">0</span></span> Members Interfaces: State ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> up ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span>.<span class="hljs-number"><span class="hljs-number">0.3</span></span> up</code> </pre> <br>  The group is fine - it is in work (the group will be in up if it has at least one interface in up).  Now check the state of the mirroring session: <br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> Instance <span class="hljs-type"><span class="hljs-type">Name</span></span>: SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> Instance Id: <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> parameters: Rate : <span class="hljs-number"><span class="hljs-number">1</span></span> Run-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Maximum-packet-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Output parameters: <span class="hljs-keyword"><span class="hljs-keyword">Family</span></span> State Destination Next-hop <span class="hljs-type"><span class="hljs-type">inet</span></span> up Analyzer-servers</code> </pre><br>  Everything is all right too, but as we have already seen earlier, this does not mean that we did everything right and everything will soar with us.  Therefore, let us check whether traffic will be mirrored to our two servers: <br><br><pre> <code class="hljs sql">bormoglotx@Server-1:~$ sudo hping3 -S -c 5 12.0.0.1 -d 40 -I eth1 HPING 12.0.0.1 (eth1 12.0.0.1): S <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span> headers + <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">64150</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">0</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.4</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">64222</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">1</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.5</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">64457</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">2</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.7</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">64593</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">3</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.5</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">64801</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">4</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.4</span></span> ms <span class="hljs-comment"><span class="hljs-comment">--- 12.0.0.1 hping statistic --- 5 packets transmitted, 5 packets received, 0% packet loss round-trip min/avg/max = 3.4/3.5/3.7 ms</span></span></code> </pre> <br>  Traffic to Analyzer-1: <br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-1:~$ sudo tcpdump -i eth1 -B 4096 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">36.837983</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2304</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1255230673</span></span>:<span class="hljs-number"><span class="hljs-number">1255230713</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">36.839367</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2304</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1255230714</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">37.838115</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2305</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">2135769685</span></span>:<span class="hljs-number"><span class="hljs-number">2135769725</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">37.839054</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2305</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">2135769726</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">38.838528</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2306</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1139555126</span></span>:<span class="hljs-number"><span class="hljs-number">1139555166</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">38.839369</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2306</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1139555167</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39.838328</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2307</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1181209811</span></span>:<span class="hljs-number"><span class="hljs-number">1181209851</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39.838924</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2307</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1181209852</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">40.838335</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2308</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1554756347</span></span>:<span class="hljs-number"><span class="hljs-number">1554756387</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">40.838901</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2308</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1554756388</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ^C <span class="hljs-number"><span class="hljs-number">10</span></span> packets captured <span class="hljs-number"><span class="hljs-number">10</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br>  And a similar copy of traffic on Analyzer-2: <br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-2:~$ sudo tcpdump -i eth1 -B 4096 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">35.125093</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2304</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1255230673</span></span>:<span class="hljs-number"><span class="hljs-number">1255230713</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">35.126394</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2304</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1255230714</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">36.125044</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2305</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">2135769685</span></span>:<span class="hljs-number"><span class="hljs-number">2135769725</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">36.126107</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2305</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">2135769726</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">37.125552</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2306</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1139555126</span></span>:<span class="hljs-number"><span class="hljs-number">1139555166</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">37.126418</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2306</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1139555167</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">38.125374</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2307</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1181209811</span></span>:<span class="hljs-number"><span class="hljs-number">1181209851</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">38.125930</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2307</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1181209852</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39.125320</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2308</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1554756347</span></span>:<span class="hljs-number"><span class="hljs-number">1554756387</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39.125844</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2308</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1554756388</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ^C <span class="hljs-number"><span class="hljs-number">10</span></span> packets captured <span class="hljs-number"><span class="hljs-number">10</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br>  Excellent - the task is completed, traffic flows to the right place - both consumers receive the requested copy of traffic. <br><br>  But the network is developing at a frantic pace, and our company doesn‚Äôt regret the money for scaling and SORM.  Now we have another server - Analyzer-3, which also wants to receive a copy of the traffic.  But the difficulty is that this server is not connected locally to our RZN-PE-1, but in RZN-PE-2: <br><img src="https://habrastorage.org/web/777/f5b/622/777f5b6222404f83a463137ec1e34ff6.png"><br>  <b>Mirroring to a remote host</b> <br><br>  In the light of all that has been said, we need to redo the mirroring scheme again, now it will look like this: <br><img src="https://habrastorage.org/web/e3e/36e/cf4/e3e36ecf4a4a41d891a1b2cf11bc90c7.png"><br>  Since the Analyzer-3 server is located behind RZN-PE-2, the methods we used to solve this problem earlier will not work.  Our main problem is not how to mirror traffic, but how this already mirrored traffic is dragged to the Analyzer-3 server, which lives behind RZN-PE-2, and to do this transparently for the network, otherwise we will get problems (which see later).  To do this, on the Juniper equipment it is common to use the gre tunnel.  The idea is that we make a tunnel to a remote host and pack all the mirrored traffic into this tunnel and send it either directly to the server or to the router that terminates the traffic receiving server.  You have two options for using the gre tunnel. <br><br>  <b>Option 1</b> .  On the router that performs the mirroring, a gre tunnel is configured, and the destination itself is the address of the traffic receiving server.  Naturally, the network in which this server is located (in our case it is Analyzer-3) must be known via any routing protocol (BGP or IGP is not important), otherwise gre tunnel simply does not take off.  The problem is that in such a scenario, traffic to the server flows along with the gre headers.  For modern traffic analysis and monitoring systems, this should not be a problem - gre is not IPSec and traffic is not encrypted.  That is, on one side of the scale simplicity of implementation, on the second - an extra title.  Perhaps in some scenarios, the presence of an extra header will not be acceptable, then you will have to use option 2. <br><br>  <b>Option 2</b> .  Between the router that does the mirroring and the router that terminates the traffic receiving server, the tunnel goes gre (usually this is done on loopbacks).  On the side of the router, which performs the mirroring from the source, everything is the same as it was in option 1, but on the recipient side, you need to set up an instance on the router that will mirror the traffic received from the gre tunnel in the direction of the analyzer.  That is, for one mirror, we have to use one mirroring instance at the source and the second at the traffic recipient, which greatly complicates the scheme.  But on the other hand, in this scenario, pure traffic flows to the server, without any extra gre headers.  In addition, when implementing this scheme, there is a rule that must be strictly observed - the router that terminates the end point of the tunnel's gre should not have a route to the host, which will be specified as the recipient in the mirrored traffic (that is, the receiver of the original mirrored packet).  If this condition is not met, then you will receive duplicate packets - the traffic will fly out of the gre tunnel and, in addition to being mirrored to the port you specified, will still be routed like a normal ip packet.  And if the router knows the route to the destination host, then the traffic will be sent to it.  To avoid this, the gre interface must be loaded into a separate instance with the type virtual-router, although there are other methods described below.  If anyone is interested, then the configuration, the essence of the problem and how to win it under the spoiler: <br><br><div class="spoiler">  <b class="spoiler_title">Mirroring via gre problem</b> <div class="spoiler_text">  Configuration of the gre server side tunnel: <br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interfaces gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> description RSPAN; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { tunnel { source <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; destination <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { address <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">31</span></span>; } }</code> </pre> <br>  Only the destination address of the tunnel has changed - it has become a RZN-PE-2 loopback. <br>  On the RZN-PE-2, you must first create a gre tunnel to RZN-PE-1: <br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> interfaces gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> description SPAN; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { tunnel { source <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; destination <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> MIRROR-RSPAN-GE0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>; } } }</code> </pre> <br>  In order to send traffic from this interface to the Mirroring instance now, we need to hang a filter on it that looks like this: <br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> firewall <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> MIRROR-RSPAN-GE0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> term MIRROR { <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> port-mirror-instance RSAPN; }</code> </pre> <br>  Well, the final touch is creating the instance itself, linking it to fpc and creating an interface to which traffic will be sent: <br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance RSAPN <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> { rate <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { output { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } } } bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> chassis fpc <span class="hljs-number"><span class="hljs-number">0</span></span> { pic <span class="hljs-number"><span class="hljs-number">0</span></span> { tunnel-services { bandwidth <span class="hljs-number"><span class="hljs-number">10</span></span>g; } } port-mirror-instance RSAPN; } bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> interfaces ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> description Analyzer<span class="hljs-number"><span class="hljs-number">-3</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { address <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">31</span></span> { arp <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> mac <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">68</span></span>; } } }</code> </pre> <br>  Now we‚Äôll run the ping between Server-1 and Server-2 and verify that we mirrored: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">bormoglotx</span></span>@<span class="hljs-type"><span class="hljs-type">Server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>:~$ ping <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> -<span class="hljs-type"><span class="hljs-type">I</span></span> eth1 <span class="hljs-type"><span class="hljs-type">PING</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> (<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>) from <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> eth1: <span class="hljs-number"><span class="hljs-number">56</span></span>(<span class="hljs-number"><span class="hljs-number">84</span></span>) bytes <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">. 64 bytes from 12.0.0.1: icmp_seq=1 ttl=63 time=1.44 ms 64 bytes from 12.0.0.1: icmp_seq=1 ttl=60 time=3.24 ms (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DUP</span></span></span><span class="hljs-class">!) ‚Ä¶ ... 64 bytes from 12.0.0.1: icmp_seq=1 ttl=3 time=34.7 ms (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DUP</span></span></span><span class="hljs-class">!) ^</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">--- 12.0.0.1 ping statistics --- 1 packets transmitted, 1 received, +41 duplicates, 0% packet loss, time 0ms rtt min/avg/max/mdev = 1.444/17.916/34.712/9.126 ms</span></span></span></span></code> </pre> <br>  I deleted some of the duplicates from the output, but their number can be seen - one valid packet and 41 doubles.  On the traffic analyzer, you naturally see the same picture: <br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-3:~$ sudo tcpdump -i eth1 -B 9192 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">13.275451</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1601</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">13.275462</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1601</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">13.276703</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1601</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> ‚Ä¶ ‚Ä¶</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to mirroring, the router also forwards the packet received from the gre tunnel, because it knows the route to the destination address. </font><font style="vertical-align: inherit;">To fix this, we create an instance with the type of virtual router and add a gre interface and an interface to which we mirror traffic:</font></font><br><br><pre> <code class="hljs scala">[edit] bormoglotx<span class="hljs-meta"><span class="hljs-meta">@RZN</span></span>-<span class="hljs-type"><span class="hljs-type">PE</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span># show routing-instances <span class="hljs-type"><span class="hljs-type">RSPAN</span></span>-<span class="hljs-type"><span class="hljs-type">VR</span></span> description <span class="hljs-string"><span class="hljs-string">"for RSPAN use only"</span></span>; instance-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">virtual-router</span></span></span></span>; interface gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run the ping again and check the performance of the circuit. </font><font style="vertical-align: inherit;">Now on the server duplicates are not visible:</font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>:~$ ping <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> -I eth1 PING <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> (<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> eth1: <span class="hljs-number"><span class="hljs-number">56</span></span>(<span class="hljs-number"><span class="hljs-number">84</span></span>) bytes <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> data. <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">2.56</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">2</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">8.13</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">3</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">1.33</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">4</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">2.09</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">5</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">2.30</span></span> ms ^C <span class="hljs-comment"><span class="hljs-comment">--- 12.0.0.1 ping statistics --- 5 packets transmitted, 5 received, 0% packet loss, time 4006ms rtt min/avg/max/mdev = 1.332/3.288/8.137/2.459 ms</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well, the lack of duplicates proves a dump on the Analyzer-3 analyzer: </font></font><br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-3:~$ sudo tcpdump -i eth1 -B 9192 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">12.605205</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1602</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">12.605350</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1602</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">13.611070</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1602</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">13.612356</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1602</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">14.606350</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1602</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">14.606739</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1602</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">15.612423</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1602</span></span>, seq <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">15.612488</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1602</span></span>, seq <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">16.614228</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1602</span></span>, seq <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">16.614588</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1602</span></span>, seq <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> ^C <span class="hljs-number"><span class="hljs-number">10</span></span> packets captured <span class="hljs-number"><span class="hljs-number">10</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br>      RZN-PE-2,     .             . <br><br>    ,         discard ( discard,     reject,  Juniper    icmp   ,   ) <br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> firewall <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> MIRROR-RSPAN-GE0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> term MIRROR { <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> { port-mirror-instance RSAPN; <span class="hljs-keyword"><span class="hljs-keyword">discard</span></span>; } }</code> </pre> <br>   ,      : <br><br><pre> <code class="hljs pgsql">bormoglotx@<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>:~$ ping <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> -I eth1 PING <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> (<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> eth1: <span class="hljs-number"><span class="hljs-number">56</span></span>(<span class="hljs-number"><span class="hljs-number">84</span></span>) bytes <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> data. <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">2.68</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">2</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">1.22</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">3</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">1.96</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">4</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">2.30</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">5</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">1.96</span></span> ms ^C <span class="hljs-comment"><span class="hljs-comment">--- 12.0.0.1 ping statistics --- 5 packets transmitted, 5 received, 0% packet loss, time 4005ms rtt min/avg/max/mdev = 1.220/2.028/2.685/0.487 ms</span></span></code> </pre> <br>    : <br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-3:~$ sudo tcpdump -i eth1 -B 9192 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">11.934805</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1604</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">11.934834</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1604</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">12.982685</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1604</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">12.982716</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1604</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">13.935027</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1604</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">13.935607</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1604</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">14.936859</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1604</span></span>, seq <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">14.937654</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1604</span></span>, seq <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">15.937650</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1604</span></span>, seq <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">15.938375</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1604</span></span>, seq <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> ^C <span class="hljs-number"><span class="hljs-number">10</span></span> packets captured <span class="hljs-number"><span class="hljs-number">10</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br>              RZN-PE-2.    next-hop  (     ,   ,      ,  JunOS   ),   gre   ,    next-hop      : <br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> interfaces gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> description SPAN; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { tunnel { source <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; destination <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> MIRROR-RSPAN-GE0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>; } } } bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> firewall <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> MIRROR-RSPAN-GE0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> term MIRROR { <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer<span class="hljs-number"><span class="hljs-number">-3</span></span>; }</code> </pre> <br> Next-hop  : <br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer<span class="hljs-number"><span class="hljs-number">-3</span></span> detail Next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: Analyzer<span class="hljs-number"><span class="hljs-number">-3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: <span class="hljs-type"><span class="hljs-type">inet</span></span> State: up Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members configured : <span class="hljs-number"><span class="hljs-number">2</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members that are up : <span class="hljs-number"><span class="hljs-number">1</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups configured : <span class="hljs-number"><span class="hljs-number">0</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups that are up : <span class="hljs-number"><span class="hljs-number">0</span></span> Members Interfaces: State ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> up ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">100.0</span></span> down</code> </pre> <br>            : <br><br><pre> <code class="hljs pgsql">bormoglotx@<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>:~$ ping <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> -I eth1 -c <span class="hljs-number"><span class="hljs-number">5</span></span> PING <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> (<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> eth1: <span class="hljs-number"><span class="hljs-number">56</span></span>(<span class="hljs-number"><span class="hljs-number">84</span></span>) bytes <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> data. <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">3.38</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">2</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">2.17</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">3</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">2.14</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">4</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">2.06</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">5</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">1.89</span></span> ms <span class="hljs-comment"><span class="hljs-comment">--- 12.0.0.1 ping statistics --- 5 packets transmitted, 5 received, 0% packet loss, time 4006ms rtt min/avg/max/mdev = 1.891/2.332/3.387/0.538 ms</span></span></code> </pre> <br>  ,  ,      : <br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-3:~$ sudo tcpdump -i eth1 -B 9192 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">28.306816</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1609</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">28.306840</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1609</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">29.306887</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1609</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">29.307273</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1609</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">30.308323</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1609</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">30.308455</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1609</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">31.309897</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1609</span></span>, seq <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">31.310117</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1609</span></span>, seq <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">32.313234</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1609</span></span>, seq <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">32.313271</span></span> IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1609</span></span>, seq <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> ^C <span class="hljs-number"><span class="hljs-number">10</span></span> packets captured <span class="hljs-number"><span class="hljs-number">10</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br>    ‚Äî    .       ‚Äî  . </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will use the first option. First we need to enable tunnel services so that we have a gre interface (gr-X / X / X):</font></font><br><br><pre> <code class="hljs perl">bormoglotx@RZN-PE-<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-comment"><span class="hljs-comment"># show chassis fpc 0 pic 0 { tunnel-services { bandwidth 10g; } } port-mirror-instance SPAN-1;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here it is worth going back a little to theory and talk about tunnel interfaces and resource reservations. In this configuration, I allocate 10G for tunnel services on a zero PIC of zero FPC. This does not mean that 10G of pfe bandwidth is cut off - this means that tunnel services can use no more than 10G of pfe bandwidth, and the part of resources not occupied by them can be used for forwarding traffic of physical ports - that is, 10G per pfe is flipped between tunnel services and real interfaces. But it is on MPC cards. If you are a ‚Äúhappy‚Äù DPC card holder (for example, you have a 4-dozen card), then with the above config you will lose one port (that is, the xe-port will simply disappear from the system and be unavailable from cli, and a light will come on near the port telling us that the port is in tunnel mode). Unfortunately,on these cards, as you understand, resources are reserved strictly, but these cards have long been outdated and gradually go out of fashion, although they are still in bulk.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Secondly, I would like to say about port numbering - if you reserve 1G, then the port number will be gr-0/0/10, if you reserve 10G or more, then the port number will be gr-0/0/0 (exactly this option). </font></font><br><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[edit]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bormoglotx</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">RZN</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">PE</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">1</span></span># run show interfaces terse | match <span class="hljs-string"><span class="hljs-string">"^(gr|lt|vt)-"</span></span> gr-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> up up lt-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> up up vt-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> up up</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> On line cards with a TRIO chipset, the maximum possible bandwidth reserved for tunnel services is 60G. </font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: I would like to add that lt and vt are different interfaces. </font><font style="vertical-align: inherit;">lt - logical tunnel - a logical tunnel, which is intended, as a rule, for linking logical systems or routing of instances among themselves - it allows you to drive traffic between them, as if these instances or logical systems are connected by a direct patchcord. </font><font style="vertical-align: inherit;">But vt is a virtual tunnel - a virtual loopback, which is not intended to bind any virtual entities, but to turn traffic on pfe for a repeated lookup (for example, in vpls).</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After we created the tunnel interfaces, we had the opportunity to configure gr-0/0/0. </font><font style="vertical-align: inherit;">Since we have torn out the option in which the remote PE router does not terminate the gre tunnel but simply sends traffic to the server, then as a sourse tunnel address on the RZN-PE-1, we specify our own loopback, and here is the destination address of the receiving server of the mirrored traffic and this address must be available. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a matter of fact, the server may or may not have an address. </font><font style="vertical-align: inherit;">You can select it yourself and make a static ARP entry, as shown below:</font></font><br><br><pre> <code class="hljs kotlin">[edit] <span class="hljs-symbol"><span class="hljs-symbol">bormoglotx@</span></span>RZN-PE-<span class="hljs-number"><span class="hljs-number">2</span></span># show | compare [edit interfaces] + ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> { + description Analyzer-<span class="hljs-number"><span class="hljs-number">3</span></span>; + unit <span class="hljs-number"><span class="hljs-number">0</span></span> { + family inet { + address <span class="hljs-number"><span class="hljs-number">192.168</span></span>.0.0/<span class="hljs-number"><span class="hljs-number">31</span></span> { + arp <span class="hljs-number"><span class="hljs-number">192.168</span></span>.0.1 mac <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">68</span></span>; + } + } + } + } [edit protocols ospf area <span class="hljs-number"><span class="hljs-number">0.0</span></span>.0.0] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/0.0 </span></span>{ ... } + <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/1.0 </span></span>{ + passive; + }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Moreover, as can be seen from the presented configuration, the interface is added as passive to ospf, so that RZN-PE-1 knows the route to this network: </font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># run <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> route <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span> destinations, <span class="hljs-number"><span class="hljs-number">20</span></span> routes (<span class="hljs-number"><span class="hljs-number">20</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = <span class="hljs-keyword"><span class="hljs-keyword">Both</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">31</span></span> *[OSPF/<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>, metric <span class="hljs-number"><span class="hljs-number">3</span></span> &gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we will create gre tunnel on RZN-PE-1 and add it to the next-hop group: </font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interfaces gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> description RSPAN; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { tunnel { source <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; destination <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { address <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">31</span></span>; } } [edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer-servers <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span>; interface gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unlike ge interfaces, the gre interface is p2p and therefore there is no point for the next-hop address for it - the traffic will still fly from the other end, although you can specify it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, then everything is as usual - check the state of the session mirroring:</font></font><br><br><pre> <code class="hljs vhdl">[edit] bormoglotx@RZN-PE-<span class="hljs-number"><span class="hljs-number">1</span></span># run show forwarding-options <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> detail <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span>-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: Analyzer-servers <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: inet State: up Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members configured : <span class="hljs-number"><span class="hljs-number">3</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members that are up : <span class="hljs-number"><span class="hljs-number">3</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups configured : <span class="hljs-number"><span class="hljs-number">0</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups that are up : <span class="hljs-number"><span class="hljs-number">0</span></span> Members Interfaces: State gr-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> up ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> up ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span>.<span class="hljs-number"><span class="hljs-number">0.3</span></span> up</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well, now let's check that the traffic on the remote server is obtained: </font></font><br><br><pre> <code class="hljs sql">bormoglotx@Server-1:~$ sudo hping3 -S -c 5 12.0.0.1 -d 40 -I eth1 HPING 12.0.0.1 (eth1 12.0.0.1): S <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span> headers + <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">53439</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">0</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">8.2</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">53515</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">1</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.5</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">53610</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">2</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.4</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">53734</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">3</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.8</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>=<span class="hljs-number"><span class="hljs-number">40</span></span> ip=<span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">63</span></span> DF <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">53897</span></span> sport=<span class="hljs-number"><span class="hljs-number">0</span></span> flags=RA seq=<span class="hljs-number"><span class="hljs-number">4</span></span> win=<span class="hljs-number"><span class="hljs-number">0</span></span> rtt=<span class="hljs-number"><span class="hljs-number">3.3</span></span> ms <span class="hljs-comment"><span class="hljs-comment">--- 12.0.0.1 hping statistic --- 5 packets transmitted, 5 packets received, 0% packet loss round-trip min/avg/max = 3.3/4.4/8.2 ms</span></span></code> </pre> <br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-3:~$ sudo tcpdump -i eth1 -B 4096 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">34.923370</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2894</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1149405522</span></span>:<span class="hljs-number"><span class="hljs-number">1149405562</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">34.926586</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span>: IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2894</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1149405563</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">35.923022</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2895</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1598018315</span></span>:<span class="hljs-number"><span class="hljs-number">1598018355</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">35.923855</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span>: IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2895</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1598018356</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">36.922903</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2896</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">592229199</span></span>:<span class="hljs-number"><span class="hljs-number">592229239</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">36.924048</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span>: IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2896</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">592229240</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">37.923278</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2897</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">694611591</span></span>:<span class="hljs-number"><span class="hljs-number">694611631</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">37.924765</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span>: IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2897</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">694611632</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">38.924275</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2898</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1423363395</span></span>:<span class="hljs-number"><span class="hljs-number">1423363435</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">38.924291</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span>: IP <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2898</span></span>: Flags [R.], seq <span class="hljs-number"><span class="hljs-number">0</span></span>, ack <span class="hljs-number"><span class="hljs-number">1423363436</span></span>, win <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ^C <span class="hljs-number"><span class="hljs-number">10</span></span> packets captured <span class="hljs-number"><span class="hljs-number">10</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But, as I said, the gre traffic is the header, and if this is not a problem for your server, then this approach is the easiest and most flexible. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But as it turned out, now the owners of the recipient servers of mirrored traffic do not want to receive all the traffic, because it has become too much. The Analyzer-1 server needs only TCP traffic, the Analyzer-2 server only needs UDP traffic, but the Analyzer-3 server needs all traffic, not limited to TCP / UDP. That is, now we need to implement such a scheme: </font></font><br><img src="https://habrastorage.org/web/fb6/1d4/e84/fb61d4e8426146699a3ff62f39323117.png"><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selective mirroring for two or more consumers</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we need a vt-0/0/0 tunnel interface (virtual loopback) or you can use lt-0/0/0 (virtual tunnel), but the first one is more preferable. </font><font style="vertical-align: inherit;">So, the concept of selective mirroring is as follows: first, the traffic from the port is mirrored to the virtual loopback vt-port, and then scattered from this port using a filter to different next-hop groups based on the parameters you have selected - protocols, ports, etc. For Better understanding of what is happening, let's now collect this scheme. </font><font style="vertical-align: inherit;">First, change the mirroring instance so that the traffic is mirrored into a virtual loopback:</font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> { rate <span class="hljs-number"><span class="hljs-number">1</span></span>; run-length <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { output { interface vt<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span>; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The no-filter-check parameter is very important - this command allows us to attach a filter to the interface to which traffic is mirrored. </font><font style="vertical-align: inherit;">By default, filtering on these interfaces is prohibited. </font><font style="vertical-align: inherit;">Now create the vt-interface itself:</font></font><br><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[edit]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bormoglotx</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">RZN</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">PE</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">1</span></span># show interfaces vt-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SPAN-USE</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">family</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You cannot attach any addresses to this interface, and the family of addresses that can be allowed on it is limited. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we have the following picture - all traffic from the interface ge-0/0/3 is sent to the port vt-0/0 / 0.0. Now we need to mirror this traffic in the direction of different consumers. To do this, you first need to create next-hop groups, which include the necessary consumers:</font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer-TCP <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span>; interface gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } [edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer-UDP <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span>; interface gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>; } [edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span>; interface gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">100.0</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The gr-0/0/0 interface, which is designed to mirror traffic to the Analyzer-3, has been added to all three groups. </font><font style="vertical-align: inherit;">This is done because this server wants to receive both TCP and UDP traffic, and you cannot make a separate group for it and then apply it in the filter. </font><font style="vertical-align: inherit;">Using the same next-hop in different groups is not prohibited. </font><font style="vertical-align: inherit;">In the Analyzer-default group there is also a port ge-0/0 / 100.0 - this is a fake port added to the group in order to be able to commit the configuration - since there must be at least two interfaces in the group. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we need to create a filter that will match traffic according to the criteria we need and scatter to next-hop groups:</font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> firewall <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> MIRROR-SORTED term MIRROR-TCP { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { protocol tcp; } <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer-TCP; } term MIRROR-UDP { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { protocol udp; } <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer-UDP; } term MIRROR-DEFAUL { <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> next-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> Analyzer-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And attach it to the vt interface: </font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interfaces vt<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> unit <span class="hljs-number"><span class="hljs-number">0</span></span> { description SPAN-USE; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> MIRROR-SORTED; } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We check our design. </font><font style="vertical-align: inherit;">Mirroring in vt interface in up state:</font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> Instance <span class="hljs-type"><span class="hljs-type">Name</span></span>: SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> Instance Id: <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> parameters: Rate : <span class="hljs-number"><span class="hljs-number">1</span></span> Run-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Maximum-packet-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Output parameters: <span class="hljs-keyword"><span class="hljs-keyword">Family</span></span> State Destination Next-hop <span class="hljs-type"><span class="hljs-type">inet</span></span> up vt<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span></code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> All groups are in operation (remember that at least one port must be in up in order for the group to become up): </font></font><br><br><pre> <code class="hljs vhdl">bormoglotx@RZN-PE-<span class="hljs-number"><span class="hljs-number">1</span></span>&gt; show forwarding-options <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> detail <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span>-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: Analyzer-TCP <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: inet State: up Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members configured : <span class="hljs-number"><span class="hljs-number">2</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members that are up : <span class="hljs-number"><span class="hljs-number">2</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups configured : <span class="hljs-number"><span class="hljs-number">0</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups that are up : <span class="hljs-number"><span class="hljs-number">0</span></span> Members Interfaces: State gr-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> up ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> up <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span>-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: Analyzer-UDP <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: inet State: up Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members configured : <span class="hljs-number"><span class="hljs-number">2</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members that are up : <span class="hljs-number"><span class="hljs-number">2</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups configured : <span class="hljs-number"><span class="hljs-number">0</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups that are up : <span class="hljs-number"><span class="hljs-number">0</span></span> Members Interfaces: State gr-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> up ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span>.<span class="hljs-number"><span class="hljs-number">0.3</span></span> up <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span>-hop-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: Analyzer-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: inet State: up Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members configured : <span class="hljs-number"><span class="hljs-number">2</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> members that are up : <span class="hljs-number"><span class="hljs-number">1</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups configured : <span class="hljs-number"><span class="hljs-number">0</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> subgroups that are up : <span class="hljs-number"><span class="hljs-number">0</span></span> Members Interfaces: State gr-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> up ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">100.0</span></span> down</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, now let's generate 5 icmp, tcp and udp packages and see what server it goes to. </font><font style="vertical-align: inherit;">On all client servers we will enable tcpdump at the same time. </font><font style="vertical-align: inherit;">I used hping3 with the --rand-source switch, so we will not see reverse traffic, since only traffic on the port is removed towards Server-1. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we look at what we caught on the Analyzer-1, there should be only TCP:</font></font><br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-1:~$ sudo tcpdump -i eth1 -B 9192 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">25.457641</span></span> IP <span class="hljs-number"><span class="hljs-number">108.215</span></span><span class="hljs-number"><span class="hljs-number">.126</span></span><span class="hljs-number"><span class="hljs-number">.169</span></span><span class="hljs-number"><span class="hljs-number">.1668</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1842749676</span></span>:<span class="hljs-number"><span class="hljs-number">1842749716</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">26.458098</span></span> IP <span class="hljs-number"><span class="hljs-number">230.181</span></span><span class="hljs-number"><span class="hljs-number">.170</span></span><span class="hljs-number"><span class="hljs-number">.188</span></span><span class="hljs-number"><span class="hljs-number">.1669</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1810452177</span></span>:<span class="hljs-number"><span class="hljs-number">1810452217</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">27.459245</span></span> IP <span class="hljs-number"><span class="hljs-number">112.6</span></span><span class="hljs-number"><span class="hljs-number">.155</span></span><span class="hljs-number"><span class="hljs-number">.46</span></span><span class="hljs-number"><span class="hljs-number">.1670</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1524555644</span></span>:<span class="hljs-number"><span class="hljs-number">1524555684</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">28.459006</span></span> IP <span class="hljs-number"><span class="hljs-number">50.45</span></span><span class="hljs-number"><span class="hljs-number">.169</span></span><span class="hljs-number"><span class="hljs-number">.23</span></span><span class="hljs-number"><span class="hljs-number">.1671</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1362080290</span></span>:<span class="hljs-number"><span class="hljs-number">1362080330</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">29.459294</span></span> IP <span class="hljs-number"><span class="hljs-number">135.146</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span><span class="hljs-number"><span class="hljs-number">.177</span></span><span class="hljs-number"><span class="hljs-number">.1672</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">2122009219</span></span>:<span class="hljs-number"><span class="hljs-number">2122009259</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> ^C <span class="hljs-number"><span class="hljs-number">5</span></span> packets captured <span class="hljs-number"><span class="hljs-number">5</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now let's check what we've got on Analyzer-2 (there should be only UDP traffic here): </font></font><br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-2:~$ sudo tcpdump -i eth1 -B 9192 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">09.340702</span></span> IP <span class="hljs-number"><span class="hljs-number">132.43</span></span><span class="hljs-number"><span class="hljs-number">.66</span></span><span class="hljs-number"><span class="hljs-number">.243</span></span><span class="hljs-number"><span class="hljs-number">.1121</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: UDP, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">10.341308</span></span> IP <span class="hljs-number"><span class="hljs-number">205.172</span></span><span class="hljs-number"><span class="hljs-number">.124</span></span><span class="hljs-number"><span class="hljs-number">.143</span></span><span class="hljs-number"><span class="hljs-number">.1122</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: UDP, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">11.341239</span></span> IP <span class="hljs-number"><span class="hljs-number">253.127</span></span><span class="hljs-number"><span class="hljs-number">.33</span></span><span class="hljs-number"><span class="hljs-number">.120</span></span><span class="hljs-number"><span class="hljs-number">.1123</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: UDP, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">12.341204</span></span> IP <span class="hljs-number"><span class="hljs-number">246.68</span></span><span class="hljs-number"><span class="hljs-number">.75</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.1124</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: UDP, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">13.341819</span></span> IP <span class="hljs-number"><span class="hljs-number">95.89</span></span><span class="hljs-number"><span class="hljs-number">.126</span></span><span class="hljs-number"><span class="hljs-number">.64</span></span><span class="hljs-number"><span class="hljs-number">.1125</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: UDP, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> ^C <span class="hljs-number"><span class="hljs-number">5</span></span> packets captured <span class="hljs-number"><span class="hljs-number">5</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well, I stayed on Analyzer-3, there we catch everything, the total number of packets should be 15 (5 UDP / 5 TCP / 5 ICMP): </font></font><br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-3:~$ sudo tcpdump -i eth1 -B 9192 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">11.782669</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span>: IP <span class="hljs-number"><span class="hljs-number">132.43</span></span><span class="hljs-number"><span class="hljs-number">.66</span></span><span class="hljs-number"><span class="hljs-number">.243</span></span><span class="hljs-number"><span class="hljs-number">.1121</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: UDP, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">12.783508</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span>: IP <span class="hljs-number"><span class="hljs-number">205.172</span></span><span class="hljs-number"><span class="hljs-number">.124</span></span><span class="hljs-number"><span class="hljs-number">.143</span></span><span class="hljs-number"><span class="hljs-number">.1122</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: UDP, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">13.783166</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span>: IP <span class="hljs-number"><span class="hljs-number">253.127</span></span><span class="hljs-number"><span class="hljs-number">.33</span></span><span class="hljs-number"><span class="hljs-number">.120</span></span><span class="hljs-number"><span class="hljs-number">.1123</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: UDP, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">14.782758</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span>: IP <span class="hljs-number"><span class="hljs-number">246.68</span></span><span class="hljs-number"><span class="hljs-number">.75</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.1124</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: UDP, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">15.783594</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span>: IP <span class="hljs-number"><span class="hljs-number">95.89</span></span><span class="hljs-number"><span class="hljs-number">.126</span></span><span class="hljs-number"><span class="hljs-number">.64</span></span><span class="hljs-number"><span class="hljs-number">.1125</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: UDP, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">18.310249</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>: IP <span class="hljs-number"><span class="hljs-number">65.173</span></span><span class="hljs-number"><span class="hljs-number">.140</span></span><span class="hljs-number"><span class="hljs-number">.215</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP net <span class="hljs-number"><span class="hljs-number">5.6</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span> unreachable, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">19.311045</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>: IP <span class="hljs-number"><span class="hljs-number">171.91</span></span><span class="hljs-number"><span class="hljs-number">.95</span></span><span class="hljs-number"><span class="hljs-number">.222</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP net <span class="hljs-number"><span class="hljs-number">5.6</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span> unreachable, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">20.312496</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>: IP <span class="hljs-number"><span class="hljs-number">228.215</span></span><span class="hljs-number"><span class="hljs-number">.127</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP net <span class="hljs-number"><span class="hljs-number">5.6</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span> unreachable, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">21.311067</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>: IP <span class="hljs-number"><span class="hljs-number">214.149</span></span><span class="hljs-number"><span class="hljs-number">.191</span></span><span class="hljs-number"><span class="hljs-number">.71</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP net <span class="hljs-number"><span class="hljs-number">5.6</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span> unreachable, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">22.311398</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>: IP <span class="hljs-number"><span class="hljs-number">119.130</span></span><span class="hljs-number"><span class="hljs-number">.166</span></span><span class="hljs-number"><span class="hljs-number">.53</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP net <span class="hljs-number"><span class="hljs-number">5.6</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span> unreachable, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">26.186528</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: IP <span class="hljs-number"><span class="hljs-number">108.215</span></span><span class="hljs-number"><span class="hljs-number">.126</span></span><span class="hljs-number"><span class="hljs-number">.169</span></span><span class="hljs-number"><span class="hljs-number">.1668</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1842749676</span></span>:<span class="hljs-number"><span class="hljs-number">1842749716</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">27.187385</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: IP <span class="hljs-number"><span class="hljs-number">230.181</span></span><span class="hljs-number"><span class="hljs-number">.170</span></span><span class="hljs-number"><span class="hljs-number">.188</span></span><span class="hljs-number"><span class="hljs-number">.1669</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1810452177</span></span>:<span class="hljs-number"><span class="hljs-number">1810452217</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">28.188726</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: IP <span class="hljs-number"><span class="hljs-number">112.6</span></span><span class="hljs-number"><span class="hljs-number">.155</span></span><span class="hljs-number"><span class="hljs-number">.46</span></span><span class="hljs-number"><span class="hljs-number">.1670</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1524555644</span></span>:<span class="hljs-number"><span class="hljs-number">1524555684</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">29.188846</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: IP <span class="hljs-number"><span class="hljs-number">50.45</span></span><span class="hljs-number"><span class="hljs-number">.169</span></span><span class="hljs-number"><span class="hljs-number">.23</span></span><span class="hljs-number"><span class="hljs-number">.1671</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">1362080290</span></span>:<span class="hljs-number"><span class="hljs-number">1362080330</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">30.188499</span></span> IP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: GREv0, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: IP <span class="hljs-number"><span class="hljs-number">135.146</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span><span class="hljs-number"><span class="hljs-number">.177</span></span><span class="hljs-number"><span class="hljs-number">.1672</span></span> &gt; <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>: Flags [S], seq <span class="hljs-number"><span class="hljs-number">2122009219</span></span>:<span class="hljs-number"><span class="hljs-number">2122009259</span></span>, win <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> ^C <span class="hljs-number"><span class="hljs-number">15</span></span> packets captured <span class="hljs-number"><span class="hljs-number">15</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, all that had to be implemented - done - traffic is mirrored and scattered across consumers, as was intended. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Above, we mirrored L3 traffic, but Juniper MX-series routers are very flexible devices and they allow not only IP traffic to be mirrored (inet / inet6 family), but also L2 traffic, for example, vpls or l2ckt (xconnect in Cisco terms). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Local mirroring of L2 traffic</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Consider the simplest case when you need to spy on what is being transmitted in L2CKT (this is certainly not good, because the client whose traffic you are going to the analyzer does not even know about, and you should do such things only with the consent of customer). The scheme is simple - some L2CKT is stretched between RZN-PE-1 and RZN-PE-2: </font></font><br><img src="https://habrastorage.org/web/e72/67c/ccf/e7267cccfd864c81875792a221b50f3b.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, we need to implement such a mirroring scheme:</font></font><br><img src="https://habrastorage.org/web/bbe/165/c41/bbe165c41e364f79ad470e1eb05f2f1e.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Between the RZN-PE-1 and the RZN-PE-2 there is a tensioned L2CKT, which we want to listen to: </font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> protocols l2circuit neighbor <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">6.100</span></span> { virtual-circuit-id <span class="hljs-number"><span class="hljs-number">100</span></span>; } } bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> interfaces ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">6.100</span></span> encapsulation vlan-ccc; vlan-id <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> ccc { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> MIRROR-L2CKT-SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span>; output MIRROR-L2CKT-SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span>; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is logical that the ccc family is enabled on the interface - this is L2CKT as it does. </font><font style="vertical-align: inherit;">In the configuration on the interface we need, the filter is already hung in both directions - since we want to receive all the traffic that will pass through our L2CKT. </font><font style="vertical-align: inherit;">The filter is essentially the same as it was before, only the address family is not inet, but ccc:</font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> firewall <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> ccc <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> MIRROR-L2CKT-SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> term MIRROR { <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> port-mirror-instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, set up a mirroring instance that we want to use for mirroring. </font><font style="vertical-align: inherit;">There are no changes in the input section - everything is as before, but in the output section there are significant differences:</font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> { rate <span class="hljs-number"><span class="hljs-number">1</span></span>; run-length <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> ccc { output { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have changed the address family - now it's ccc. </font><font style="vertical-align: inherit;">It pulls inevitable changes in the configuration of the interface to which we want to send traffic. </font><font style="vertical-align: inherit;">If we try to set some next-hop address, as was done earlier on a non-p2p interface, then we will fail:</font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> ccc output interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> ? Possible completions: &lt;[Enter]&gt; <span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span> this command + apply-<span class="hljs-keyword"><span class="hljs-keyword">groups</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Groups</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> which <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inherit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> data + apply-<span class="hljs-keyword"><span class="hljs-keyword">groups</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Don<span class="hljs-string"><span class="hljs-string">'t inherit configuration data from these groups no-filter-check Do not check for filters on port-mirroring interface | Pipe through a command</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We simply do not have such an opportunity. </font><font style="vertical-align: inherit;">Therefore, on the interface to which we need to send traffic, we need to include the bridge or ccc family:</font></font><br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">edit</span></span>] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span><span class="hljs-meta"><span class="hljs-meta"># show interfaces ge-0/0/1 description Analyzer-1; encapsulation ethernet-ccc; unit 0 { family ccc; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ccc family is naturally simpler to use, but if you need to use a bridge, do not forget about an important nuance - the interface with encapsulation of the bridge should be placed in the bridge domain (the vlan number in the domain can be used zero (none), so you will not select real vlan numbers for mirroring other services). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything is ready, check the status of the mirroring session:</font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring Instance <span class="hljs-type"><span class="hljs-type">Name</span></span>: SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> Instance Id: <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> parameters: Rate : <span class="hljs-number"><span class="hljs-number">1</span></span> Run-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Maximum-packet-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Output parameters: <span class="hljs-keyword"><span class="hljs-keyword">Family</span></span> State Destination Next-hop ccc up ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything is fine - session up. </font><font style="vertical-align: inherit;">Now we‚Äôll run a ping between our hosts and check what we can build on the analyzer:</font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@TEST<span class="hljs-number"><span class="hljs-number">-1</span></span>&gt; ping routing-instance VR<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> count <span class="hljs-number"><span class="hljs-number">5</span></span> PING <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">0</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">10.159</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">11.136</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">2</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">9.723</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">3</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">7.754</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">4</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">10.619</span></span> ms <span class="hljs-comment"><span class="hljs-comment">--- 10.0.0.2 ping statistics --- 5 packets transmitted, 5 packets received, 0% packet loss round-trip min/avg/max/stddev = 7.754/9.878/11.136/1.162 ms</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here is what happened to collect: </font></font><br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-1:~$ sudo tcpdump -i eth1 -B 9192 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">31.948237</span></span> IP <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">17420</span></span>, seq <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">31.954408</span></span> IP <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &gt; <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">17420</span></span>, seq <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">32.955149</span></span> IP <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">17420</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">32.964115</span></span> IP <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &gt; <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">17420</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">33.967789</span></span> IP <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">17420</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">33.973388</span></span> IP <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &gt; <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">17420</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">34.975442</span></span> IP <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">17420</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">34.980370</span></span> IP <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &gt; <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">17420</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">35.986900</span></span> IP <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">17420</span></span>, seq <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">35.992213</span></span> IP <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &gt; <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">17420</span></span>, seq <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> ^C <span class="hljs-number"><span class="hljs-number">10</span></span> packets captured <span class="hljs-number"><span class="hljs-number">10</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actually all the packages got to the analyzer, which is what we wanted. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now let's look at a more complicated scheme - we need to configure mirroring for interfaces located in the bridge domain or in a virtual switch, the method of sending a copy is not to some local port, as we did above, but to send this traffic to the remote box. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mirroring L2 traffic to a remote server</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first thought is simple, you can use the gre tunnel. But, unfortunately, gre does not support ccc / tcc / vpls / bridge encapsulation. But in Junos there are a lot of different tools that allow you to solve the same task using different methods, and sometimes it seems that doing something is not realistic, but in the end, through the N-th amount of time and the N-th number of smoked manuals, everything takes off. Here as well. Now we will collect such a complex scheme:</font></font><br><img src="https://habrastorage.org/web/c23/950/66a/c2395066a6f64492a74e5694f37a9a1b.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will explain what and why. So, we mirror the traffic from the virtual switch (L2CKT or bridge domain) to the peacekeeping instance, and the traffic is not mirrored to any physical interface, but to the virtual tunnel interface lt-0/0/0. This interface is alone on the box and its units are created in pairs called peer-units ‚Äî one unit is the input end of the tunnel, the second unit is the output one. As a result, all that falls into one unit will fly out of the second unit associated with it and vice versa. On this interface, we will enable ccc encapsulation and build L2CKT from it to a remote router that terminates the traffic receiving server ‚Äî that is, we simply give L2 traffic through L2CKT straight to the remote server. For a remote marshurtizer, this will be a simple L2CKT.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We now turn to configuration. </font><font style="vertical-align: inherit;">Interfaces in the direction of servers in access, and are located in a virtual switch:</font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># wildcard range <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interfaces ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/[<span class="hljs-number"><span class="hljs-number">3</span></span><span class="hljs-number"><span class="hljs-number">-4</span></span>] description <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>; encapsulation ethernet-bridge; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> bridge { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> MIRROR-BRIDGE-vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span>; } interface-mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>; vlan-id <span class="hljs-number"><span class="hljs-number">100</span></span>; } } description <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>; encapsulation ethernet-bridge; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> bridge { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> MIRROR-BRIDGE-vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span>; } interface-mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>; vlan-id <span class="hljs-number"><span class="hljs-number">100</span></span>; } } [edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> routing-instances vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> instance-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> virtual-switch; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">4.0</span></span>; bridge-domains { BD100 { vlan-id <span class="hljs-number"><span class="hljs-number">100</span></span>; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filters are hung on the interfaces to mirror incoming traffic to the SPAN-1 instance. </font><font style="vertical-align: inherit;">The filter is no different from the previously used ones, except for the family ‚Äî in this scenario, the bridge is used:</font></font><br><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[edit]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bormoglotx</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">RZN</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">PE</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">1</span></span># show firewall family bridge filter MIRROR-BRIDGE-vSwitch-<span class="hljs-number"><span class="hljs-number">1</span></span> term MIRROR { <span class="hljs-selector-tag"><span class="hljs-selector-tag">then</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">port-mirror-instance</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SPAN-1</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now create the instance SPAN-1: </font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> { rate <span class="hljs-number"><span class="hljs-number">1</span></span>; run-length <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> vpls { output { interface lt<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>; } }</code> </pre> <br>  There is a little nuance.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The address family is not specified as a bridge - you will not even find such a family in the instance configuration, but vpls. </font><font style="vertical-align: inherit;">This family (VPLS) is used to mirror traffic from vpls / bridge domains. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, create a tunnel interface to which we want to send traffic:</font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interfaces lt<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> unit <span class="hljs-number"><span class="hljs-number">0</span></span> { description RSPAN-<span class="hljs-keyword"><span class="hljs-keyword">IN</span></span>; encapsulation ethernet-ccc; peer-unit <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> ccc; } unit <span class="hljs-number"><span class="hljs-number">1</span></span> { description RSPAN-<span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span>; encapsulation ethernet-ccc; peer-unit <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> ccc; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As I wrote earlier, the lt interface consists of two units - in our case, units 0 and 1. Everything that flies into unit 0 will fly out through unit 1. Generally, on the one hand, a unit can be like L3, for example inet, and on the other, like L2, for example ccc - and it will work. </font><font style="vertical-align: inherit;">We have ccc at both ends, on the zero unit this is due to the fact that traffic must be mirrored to the instance with the ccc / bridge / vpls family, and the use of ccc on the first unit is due to the fact that L2CKT is being built from this unit. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, create a L2CKT between RZN-PE-1 and RZN-PE-2. </font><font style="vertical-align: inherit;">From RZN-PE-1:</font></font><br><br><pre> <code class="hljs scala">[edit] bormoglotx<span class="hljs-meta"><span class="hljs-meta">@RZN</span></span>-<span class="hljs-type"><span class="hljs-type">PE</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span># show protocols l2circuit neighbor <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> { interface lt<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.1</span></span> { virtual-circuit-id <span class="hljs-number"><span class="hljs-number">1</span></span>; encapsulation-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ethernet</span></span></span></span>; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> From RZN-PE-2: </font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> protocols l2circuit neighbor <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { virtual-circuit-id <span class="hljs-number"><span class="hljs-number">1</span></span>; encapsulation-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> ethernet; } } bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-2</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> interfaces ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> description Analyzer<span class="hljs-number"><span class="hljs-number">-3</span></span>; encapsulation ethernet-ccc; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> ccc; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now you can check whether our "Frankenstein". </font><font style="vertical-align: inherit;">First, look at the L2CKT state:</font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># run <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> l2circuit connections | find ^Nei Neighbor: <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> Interface <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> St <span class="hljs-type"><span class="hljs-type">Time</span></span> last up # Up trans lt<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.1</span></span>(vc <span class="hljs-number"><span class="hljs-number">1</span></span>) rmt Up Sep <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">28</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, Negotiated control-word: Yes (<span class="hljs-keyword"><span class="hljs-keyword">Null</span></span>) Incoming label: <span class="hljs-number"><span class="hljs-number">299840</span></span>, Outgoing label: <span class="hljs-number"><span class="hljs-number">299872</span></span> Negotiated PW status TLV: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> interface: lt<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.1</span></span>, Status: Up, Encapsulation: ETHERNET Flow Label Transmit: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span>, Flow Label Receive: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Great, L2CKT at work. </font><font style="vertical-align: inherit;">Next, check the status of the mirroring session:</font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># run <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> Instance <span class="hljs-type"><span class="hljs-type">Name</span></span>: SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> Instance Id: <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> parameters: Rate : <span class="hljs-number"><span class="hljs-number">1</span></span> Run-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Maximum-packet-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Output parameters: <span class="hljs-keyword"><span class="hljs-keyword">Family</span></span> State Destination Next-hop vpls up lt<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Everything is fine, now let's start ping between the Server-1 and Server-2 servers and see what happens to the traffic analyzer: </font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>:~$ ping <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> -I <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> -c <span class="hljs-number"><span class="hljs-number">5</span></span> -i <span class="hljs-number"><span class="hljs-number">0.2</span></span> PING <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> : <span class="hljs-number"><span class="hljs-number">56</span></span>(<span class="hljs-number"><span class="hljs-number">84</span></span>) bytes <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> data. <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">3.86</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">2</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">2.34</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">3</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">2.30</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">4</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">9.56</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">5</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">1.43</span></span> ms <span class="hljs-comment"><span class="hljs-comment">--- 11.0.0.2 ping statistics --- 5 packets transmitted, 5 received, 0% packet loss, time 803ms rtt min/avg/max/mdev = 1.436/3.903/9.565/2.937 ms</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now go to Analyzer-3 and see what got into tcpdump: </font></font><br><br><pre> <code class="hljs sql">bormoglotx@Analyzer-3:~$ sudo tcpdump -i eth1 -B 9192 tcpdump: verbose output suppressed, <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> eth1, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">46.296920</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">46.297969</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">46.496380</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">46.497647</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">46.700540</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">46.700547</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">46.897518</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>, seq <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">46.907024</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>, seq <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">47.098414</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>: ICMP echo request, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>, seq <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">47.098799</span></span> IP <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &gt; <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>: ICMP echo reply, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>, seq <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">51.307134</span></span> ARP, Request who-has <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tell <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>:<span class="hljs-number"><span class="hljs-number">51.307542</span></span> ARP, Reply <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">at</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> (oui <span class="hljs-literal"><span class="hljs-literal">Unknown</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">46</span></span> ^C <span class="hljs-number"><span class="hljs-number">12</span></span> packets captured <span class="hljs-number"><span class="hljs-number">12</span></span> packets received <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> filter <span class="hljs-number"><span class="hljs-number">0</span></span> packets dropped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> kernel</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, besides our pings, the arp request-response also got into the dump, which proves that all traffic is mirrored, which is what we need. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, in conclusion, I remember that I wrote that you can bind a maximum of two mirroring instances on the same fpc. But what if you need to use three instances? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, you can use two user-defined instances and a default instance (which is only one), but firstly, this is not the best solution, but secondly, what to do if the default instance is already taken? Naturally JunOS allows you to bypass this limitation. In principle, there is nothing supernatural here - the principle of operation is the same, the changes concern only the configuration of the instances. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using more than two mirroring instances on one FPC</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, the main point in creating a bundle between several mirroring instances: the parent instance and the child instances that refer to it are made. </font><font style="vertical-align: inherit;">In the parent instance, we specify the input parameters - that is, the speed of mirroring / sampling, the maximum packet size. </font><font style="vertical-align: inherit;">In the child instances, the output parameters are specified - interfaces or the next-hop group, but the input parameters are inherited from the parent instance specified in the configuration. </font><font style="vertical-align: inherit;">Without configs, this is clearly incomprehensible, so let's put together a mirroring scheme: </font></font><br><img src="https://habrastorage.org/web/ed6/3a0/351/ed63a03513654fa485ca91abb564ab72.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, create a parent instance, I just called it SPAN.</font></font><br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">bormoglotx</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">RZN</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">PE</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">1</span></span># show forwarding-options port-mirroring instance SPAN input { <span class="hljs-selector-tag"><span class="hljs-selector-tag">rate</span></span> 1; <span class="hljs-selector-tag"><span class="hljs-selector-tag">run-length</span></span> 0; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instance shows only incoming parameters of mirroring. </font><font style="vertical-align: inherit;">Nothing more to specify here. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now create three child instances:</font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>-parameters-instance SPAN; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { output { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } } } [edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance SPAN<span class="hljs-number"><span class="hljs-number">-2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>-parameters-instance SPAN; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { output { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> { next-hop <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>; } } } [edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring instance SPAN<span class="hljs-number"><span class="hljs-number">-3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>-parameters-instance SPAN; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { output { interface gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> { } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we already indicate the outgoing parameters of mirroring. </font><font style="vertical-align: inherit;">The connection between the parent and child instances occurs using the following command:</font></font><br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">input</span></span>-parameters-instance SPAN;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result, all three SPAN-1/2/3 instances created by me will inherit the input parameters from the SPAN instance. </font><font style="vertical-align: inherit;">As you remember, now we need to bind the instances to some kind of (or some sort, if the incoming ports on different cards) are FPC. </font><font style="vertical-align: inherit;">As I said earlier, only the parent instance must be bound to the FPC:</font></font><br><br><pre> <code class="hljs perl">bormoglotx@RZN-PE-<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-comment"><span class="hljs-comment"># show chassis fpc 0 pic 0 { tunnel-services { bandwidth 10g; } } port-mirror-instance SPAN;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well, then everything is the same - we create filters and hang them on the incoming ports: </font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># wildcard range <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interfaces ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/[<span class="hljs-number"><span class="hljs-number">3</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span>] description <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> MIRROR&gt;&gt;&gt;SPAN<span class="hljs-number"><span class="hljs-number">-3</span></span>; output MIRROR&gt;&gt;&gt;SPAN<span class="hljs-number"><span class="hljs-number">-3</span></span>; } address <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>; } } description <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> MIRROR&gt;&gt;&gt;SPAN<span class="hljs-number"><span class="hljs-number">-2</span></span>; output MIRROR&gt;&gt;&gt;SPAN<span class="hljs-number"><span class="hljs-number">-2</span></span>; } address <span class="hljs-number"><span class="hljs-number">12.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>; } } description <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> MIRROR&gt;&gt;&gt;SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span>; output MIRROR&gt;&gt;&gt;SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span>; } address <span class="hljs-number"><span class="hljs-number">13.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I pay attention that in filters not parent instance, but child instances are specified: </font></font><br><br><pre> <code class="hljs pgsql">[edit] bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># wildcard range <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> firewall <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> MIRROR&gt;&gt;&gt;SPAN-[<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>] term MIRROR { <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> port-mirror-instance SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span>; } term MIRROR { <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> port-mirror-instance SPAN<span class="hljs-number"><span class="hljs-number">-2</span></span>; } term MIRROR { <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> port-mirror-instance SPAN<span class="hljs-number"><span class="hljs-number">-3</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now check the state of the mirroring sessions: </font></font><br><br><pre> <code class="hljs pgsql">bormoglotx@RZN-PE<span class="hljs-number"><span class="hljs-number">-1</span></span># run <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> port-mirroring Instance <span class="hljs-type"><span class="hljs-type">Name</span></span>: SPAN<span class="hljs-number"><span class="hljs-number">-1</span></span> Instance Id: <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> parameters: Rate : <span class="hljs-number"><span class="hljs-number">1</span></span> Run-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Maximum-packet-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Output parameters: <span class="hljs-keyword"><span class="hljs-keyword">Family</span></span> State Destination Next-hop <span class="hljs-type"><span class="hljs-type">inet</span></span> up gr<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span> Instance <span class="hljs-type"><span class="hljs-type">Name</span></span>: SPAN<span class="hljs-number"><span class="hljs-number">-2</span></span> Instance Id: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> parameters: Rate : <span class="hljs-number"><span class="hljs-number">1</span></span> Run-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Maximum-packet-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Output parameters: <span class="hljs-keyword"><span class="hljs-keyword">Family</span></span> State Destination Next-hop <span class="hljs-type"><span class="hljs-type">inet</span></span> up ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Instance <span class="hljs-type"><span class="hljs-type">Name</span></span>: SPAN<span class="hljs-number"><span class="hljs-number">-3</span></span> Instance Id: <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> parameters: Rate : <span class="hljs-number"><span class="hljs-number">1</span></span> Run-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Maximum-packet-length : <span class="hljs-number"><span class="hljs-number">0</span></span> Output parameters: <span class="hljs-keyword"><span class="hljs-keyword">Family</span></span> State Destination Next-hop <span class="hljs-type"><span class="hljs-type">inet</span></span> up ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">169.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the output, it is clear that traffic mirroring sessions are in operation, and the parameters for processing incoming traffic are inherited from the parent instance. </font><font style="vertical-align: inherit;">Actually I will not show the conclusions of the work directly in order to shorten the article - I think that after reading this article you will be able to assemble such a scheme yourself and test its performance. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It seems that everything I wanted to write - wrote. </font><font style="vertical-align: inherit;">If there are comments or additions - write.</font></font><br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/336978/">https://habr.com/ru/post/336978/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336966/index.html">We configure the Internet gateway with transparent bypass of blocking (and we will block advertising)</a></li>
<li><a href="../336968/index.html">We pump USB Mass Storage Device on STM32F103 using FreeRTOS and DMA</a></li>
<li><a href="../336970/index.html">RxSwift: a bit about share (), replay (), shareReplayLatestWhileConnected () and other cool operators</a></li>
<li><a href="../336972/index.html">Optimization of the process of searching for violators of land legislation</a></li>
<li><a href="../336976/index.html">‚ÄúBy whom do you see yourself in 5 years?‚Äù: Wall Street top manager's advice on the answers to the cunning questions of recruiters</a></li>
<li><a href="../336980/index.html">Creating a programming language using LLVM. Part 9: Add Debugging Information</a></li>
<li><a href="../336982/index.html">EWD: Substitution Processes</a></li>
<li><a href="../336984/index.html">Position selection procedure</a></li>
<li><a href="../336988/index.html">Programming Contest: JSDash (Results)</a></li>
<li><a href="../336992/index.html">Mobile Applications Testing Cheat Sheet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>