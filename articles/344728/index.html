<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expansion of models in Eloquent ORM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have come a long way since the days when we manually wrote SQL queries in our web applications. Tools such as Laravel Eloquent ORM allow us to work...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expansion of models in Eloquent ORM</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/fc/hn/_v/fchn_v6aqfi1iqi1mph6nz1vcxy.png"><br>  We have come a long way since the days when we manually wrote SQL queries in our web applications.  Tools such as Laravel <a href="https://laravel.com/docs/master/eloquent">Eloquent ORM</a> allow us to work with a database at a higher level, free us from details of a lower level - such as query syntax and security. </p><a name="habracut"></a><br><p> When you start working with Eloquent, you will inevitably come to such operators as <code>where</code> and <code>join</code> .  For the more advanced ones, there are query stubs (scopes), readers (accessors), mutators (mutators) - offering more expressive alternatives to the old way of constructing queries. </p><br><p>  Let's look at other alternatives that can be used as a replacement for the frequently repeated <code>where</code> clause and scopes.  This technology is to create a new model of Eloquent that will be inherited from another model.  Such a model will inherit all the functionality of the parent model, while retaining the ability to add your own methods, query stubs (scopes), listeners (listeners), etc.  Usually this is called Single Table Inheritance, but I prefer to call it Model Inheritance. </p><br><h2 id="primer">  Example </h2><br><p>  Most web applications have the concept of "administrator."  The administrator is a regular user with elevated rights and access to the service parts of the application.  In order to distinguish regular users from administrators, we write something like this: </p><br><pre> <code class="hljs php">$admins = User::where(<span class="hljs-string"><span class="hljs-string">'is_admin'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)-&gt;get();</code> </pre> <br><p>  When the <code>where</code> expression is often repeated in your application, it is useful to replace it with a local query content ( <a href="https://laravel.com/docs/master/eloquent">local scope</a> ).  By <code>isAdmin</code> query <code>isAdmin</code> into the <code>User</code> model, we can write more expressive and reusable code: </p><br><pre> <code class="hljs bash"><span class="hljs-variable"><span class="hljs-variable">$admins</span></span> = User::isAdmin()-&gt;get(); // : class User extends Model { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> scopeIsAdmin(<span class="hljs-variable"><span class="hljs-variable">$query</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$query</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span>(<span class="hljs-string"><span class="hljs-string">'is_admin'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } }</code> </pre> <br><p>  Let's go ahead and use model inheritance.  Inheriting from the <code>User</code> model and adding a global query preparation, we achieve a more accurate result than we received before, but now with a completely new object.  This object ( <code>Admin</code> ) can have its own methods, query stubs, and other functionality. </p><br><pre> <code class="hljs lua">$admins = Admin::all(); // : class Admin extends User { protected $<span class="hljs-built_in"><span class="hljs-built_in">table</span></span> = <span class="hljs-string"><span class="hljs-string">'users'</span></span>; public static <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">boot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { parent::boot(); static::addGlobalScope(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($query)</span></span></span></span> { $query-&gt;where(<span class="hljs-string"><span class="hljs-string">'is_admin'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); }); } }</code> </pre> <br><blockquote>  Note: the variable <code>protected $table = 'users'</code> necessary for the proper operation of requests.  Eloquent uses the model class name to determine the table name.  Therefore, Eloquent assumes that the name of the table is ‚Äúadmins‚Äù instead of ‚Äúusers‚Äù, which will lead to the error <code>Base table or view not found</code> . </blockquote><p>  Now that you have the <code>Admin</code> model, it will be easier for you to share the functionality with the <code>User</code> model.  For example: </p><br><h4 id="notifikacii">  Notifications </h4><br><p>  Simple operations, such as sending notifications to all administrators, have become easier with the new <code>Admin</code> model. </p><br><pre> <code class="hljs pgsql">Notification::send(<span class="hljs-keyword"><span class="hljs-keyword">Admin</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>(), NewSignUp($<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>));</code> </pre> <br><h4 id="proverka">  Check </h4><br><p>  Always when operations with the <code>User</code> model are limited to the administrator, we need to check that the user impersonates the administrator. </p><br><pre> <code class="hljs bash">//  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$admin</span></span> = User::find(<span class="hljs-variable"><span class="hljs-variable">$id</span></span>)-&gt;is_admin !== <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { throw new Exception; } <span class="hljs-variable"><span class="hljs-variable">$admin</span></span>-&gt;impersonate(<span class="hljs-variable"><span class="hljs-variable">$user</span></span>);</code> </pre> <br><p>  Since the <code>Admin</code> global query stub restricts us to only administrators, the <code>impersonate</code> method can be called immediately for the <code>Admin</code> class. </p><br><pre> <code class="hljs php">Admin::findOrFail($id)-&gt;impersonate($user);</code> </pre> <br><h4 id="fabriki-modeley">  Model Factories </h4><br><p>  During testing, you may need to create a <code>User</code> model with administrator privileges using <a href="https://laravel.com/docs/master/database-testing">the model factory</a> as in the example below. </p><br><pre> <code class="hljs lua">$admin = factory(User::class)-&gt;<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>([<span class="hljs-string"><span class="hljs-string">'is_admin'</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>]); // //    $factory-&gt;define(User::class, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ ... <span class="hljs-string"><span class="hljs-string">'is_admin'</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>, ]; });</code> </pre> <br><p>  We can improve this code by adding <a href="https://laravel.com/docs/master/database-testing">state to the factory by</a> encapsulating something that the user is an administrator. </p><br><pre> <code class="hljs lua">$admin = factory(User::class)-&gt;states(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>)-&gt;<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(); //    $factory-&gt;state(User::class, <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'is_admin'</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>]; });</code> </pre> <br><p>  It was definitely better, but we still get an instance of the <code>User</code> model.  Having defined a new factory for the <code>Admin</code> model, we will also get a user with administrator rights, but now the factory will return an instance of the <code>Admin</code> model. </p><br><pre> <code class="hljs lua">$admin = factory(Admin::class)-&gt;<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(); //    $factory-&gt;define(Admin::class, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'is_admin'</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>] + factory(User::class)-&gt;raw(); });</code> </pre> <br><h2 id="otnosheniya-ne-rabotayut">  Relationships don't work. </h2><br><p>  In the same way that Eloquent defines table names, model class names are used to define foreign keys and intermediate tables.  Consequently, access to the relationships from the <code>Admin</code> model is problematic. </p><br><pre> <code class="hljs lua">Admin::first()-&gt;posts; //  : Unknown column <span class="hljs-string"><span class="hljs-string">'posts.admin_id'</span></span> //   : class Admin extends User { // } class User extends Model { public <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">posts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $this-&gt;hasMany(Post::class); } }</code> </pre> <br><p>  Eloquent cannot access the relation as it assumes that each instance of the <code>Post</code> model has the <code>admin_id</code> field instead of the <code>user_id</code> field.  We can fix this by passing the <code>user_id</code> foreign key in the <code>User</code> model: </p><br><pre> <code class="hljs lua">//  : class Admin extends User { // } class User extends Model { public <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">posts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $this-&gt;hasMany(Post::class, <span class="hljs-string"><span class="hljs-string">'user_id'</span></span>); } }</code> </pre> <br><p>  The same problem exists in the attitude of many to many.  Eloquent assumes that the name of the intermediate table corresponds to the name of the current class of the model: </p><br><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">Admin</span></span>::first()-&gt;tags; //  : <span class="hljs-type"><span class="hljs-type">Table</span></span> 'admin_tag' doesn't exist //   : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">Admin</span></span> extends <span class="hljs-type"><span class="hljs-type">User</span></span> { // } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">User</span></span> extends <span class="hljs-type"><span class="hljs-type">Model</span></span> { public function tags() { return $this-&gt;belongsToMany(<span class="hljs-type"><span class="hljs-type">Tag</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); } ...</code> </pre> <br><p>  We can also solve this problem by explicitly specifying the name of the pivot table and the name of the remote key: </p><br><pre> <code class="hljs lua">//  : class Admin extends User { // } class User extends Model { public <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tags</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $this-&gt;belongsToMany(Tag::class, <span class="hljs-string"><span class="hljs-string">'user_tag'</span></span>, <span class="hljs-string"><span class="hljs-string">'user_id'</span></span>); } ...</code> </pre> <br><p>  Although the explicit definition of remote keys and summary tables allows the <code>Admin</code> model to access the <code>User</code> model relationships, this solution is far from ideal.  The existence of these seemingly unnecessary definitions does not improve our code. </p><br><p>  However, you can create a HasParentModel <code>HasParentModel</code> that will automatically solve this problem.  This trait will replace the model class name with the class name of the parent model.  <a href="https://gist.github.com/calebporzio/a63b165b500d491a0c250eb5853e5d94">GitHub</a> trait code. </p><br><blockquote>  You can go further and make Laravel work better with one-table inheritance.  We have created a package that will simplify the creation of models in your Laravel application, and are ready to release it from day to day.  Follow our <a href="http://twitter.com/tightenco/">tweeter</a> to not miss the announcement! </blockquote><p>  Let's look at the new model <code>Admin</code> that uses this treit: </p><br><pre> <code class="hljs scala">use <span class="hljs-type"><span class="hljs-type">App</span></span>\<span class="hljs-type"><span class="hljs-type">Abilities</span></span>\<span class="hljs-type"><span class="hljs-type">HasParentModel</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Admin</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ use <span class="hljs-type"><span class="hljs-type">HasParentModel</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    : protected $table = 'users' public static function boot() { parent::boot(); static::addGlobalScope(function ($query) { $query-&gt;where('is_admin', true); }); } }</span></span></code> </pre> <br><p>  Now, our <code>User</code> model relationships can return to the state when they relied on default values. </p><br><pre> <code class="hljs lua">//  : class User extends Model { public <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">posts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $this-&gt;hasMany(Post::class); } public <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tags</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $this-&gt;belongsToMany(Tag::class); } }</code> </pre> <br><p>  Trace <code>HasParentModel</code> clears our model and lets the developer understand that something special is happening inside it. </p><br><h2 id="nasledovanie-modeley">  Model inheritance </h2><br><p>  We identified the general characteristics of the Eloquent model and made them cleaner using their inheritance.  This technology allows us to create better object names and encapsulate them in our application.  Remember that inheritance is available for all Eloquent models, not just for <code>Users</code> and <code>Admins</code> .  The possibilities are endless! </p><br><p>  Be creative, have fun and share your knowledge.  Share with me how you use this pattern in your projects!  (Tweeter <a href="https://twitter.com/calebporzio">@calebporzio</a> and <a href="https://twitter.com/tightenco">@tightenco</a> ) </p><br><p>  Good luck! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/344728/">https://habr.com/ru/post/344728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344714/index.html">th</a></li>
<li><a href="../344718/index.html">Developer-detective: entertaining puzzles from real life</a></li>
<li><a href="../344720/index.html">Big Data in Hadoop Subscription in the SAP Cloud</a></li>
<li><a href="../344724/index.html">Analysis summary hh.ru: a lot of graphs and some sexism and discrimination</a></li>
<li><a href="../344726/index.html">A quick overview of symfony. Relevance. Should I try?</a></li>
<li><a href="../344730/index.html">The story of Ilona Mask - Infographics</a></li>
<li><a href="../344734/index.html">PVS-Studio 2018: CWE, Java, RPG, macOS, Keil, IAR, MISRA</a></li>
<li><a href="../344736/index.html">Unlucky Notes on Azure Cloud Hosting</a></li>
<li><a href="../344738/index.html">Projection modeling</a></li>
<li><a href="../344740/index.html">Information security of bank non-cash payments. Part 1 - Economic Foundations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>