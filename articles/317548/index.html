<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Wi-Fi on Linux will be faster</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- let it be better small, but Feuerbach ... 
 Victor Pelevin "Generation Pi" 

 The recent release of the Linux kernel 4.9 is an excellent opportunity...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Wi-Fi on Linux will be faster</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  - <em>let it be better small, but Feuerbach ...</em> <br>  Victor Pelevin "Generation Pi" </blockquote><p>  The recent <a href="https://habrahabr.ru/company/kingservers/blog/317364/">release of the Linux kernel 4.9 is</a> an excellent opportunity to talk about the upcoming WiFi overclocking.  Immediately make a reservation - the post is not about <a href="https://habrahabr.ru/company/remo/blog/310612/">how to increase the coverage area</a> or <a href="https://habrahabr.ru/post/317220/">change regulatory domains</a> .  You do not need to do anything of this; it is enough to update the kernel after the patches of the Dave T√§ht buffer-supporter are in a stable branch. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7a8/4da/9ba/7a84da9ba91b46008371bec6a4c53d6a.png"></div><br><p> Significant increase in speed achieved by reducing the delay <a name="cite_note-1"></a>  <a href="https://habr.com/ru/post/317548/"><sup>[1]</sup></a> and excessive buffering <a name="cite_note-2"></a>  <a href="https://habr.com/ru/post/317548/"><sup>[2]</sup></a> in the network.  Developers had to shovel <code>mac80211</code> for this, remove something from above, add below, and after that network latency was reduced by an order of magnitude.  Price issue?  Patch in 200 lines.  Details under the cut. </p><a name="habracut"></a><br><h2>  That Bufferbloat </h2><br><p>  <a href="https://www.bufferbloat.net/projects/">Bufferbloat</a> is excessive buffering in the network equipment of the provider, which leads to undesired data transfer delays.  With a sufficiently loaded channel, each connection eats away milliseconds, which then turn into seconds and sometimes minutes of waiting.  If the network delay is 1 second, then <a href="https://slashdot.org/">slashdot.org</a> will load as long as 4 minutes! </p><br><pre> <code class="hljs dos"># flent -l <span class="hljs-number"><span class="hljs-number">300</span></span> -H server ‚Äìstreams=<span class="hljs-number"><span class="hljs-number">12</span></span> tcp_ndown &amp; # wget -E -H -k -K -p https://www.slashdot.org ... FINISHED --<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>-- Total wall clock <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-number"><span class="hljs-number">232</span></span>.<span class="hljs-number"><span class="hljs-number">8</span></span>s Downloaded: <span class="hljs-number"><span class="hljs-number">62</span></span> files, <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">8</span></span>M <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">9</span></span>s (<span class="hljs-number"><span class="hljs-number">77</span></span>KB/s)</code> </pre> <br><p>  The first team uses a python wrapper for <code>netperf</code> , it is a <a href="https://flent.org/">powerful tool</a> for making control measurements. <a name="cite_note-3"></a>  <a href="https://habr.com/ru/post/317548/"><sup>[3]</sup></a> network connections. </p><br><pre> <code class="hljs pgsql">-l <span class="hljs-number"><span class="hljs-number">300</span></span> #  <span class="hljs-number"><span class="hljs-number">5</span></span>  -H <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> #   <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> -streams=<span class="hljs-number"><span class="hljs-number">12</span></span> tcp_ndown #<span class="hljs-number"><span class="hljs-number">12</span></span>  tcp download</code> </pre> <br><p>  <code>Flent</code> loads the channel so that the connection is established with a second delay.  The connection setup took <strong>99.6% of the</strong> execution <strong>time</strong> , as a result the real speed dropped to a measly 77 KB / s.  With zero delay, the same page loads in 8 seconds.  <em>Thus, the time of a circular path</em> <em><a name="cite_note-4"></a></em>  <em><a href="https://habr.com/ru/post/317548/"><sup>[4]</sup></a> and latency are more important than throughput</em> . </p><br><p>  On the side of the IS provider, it <a href="http://www.dslreports.com/speedtest/results/bufferbloat%3Fup%3D1">has the character of an epidemic</a> , but it also suffices on the user equipment.  For quite a while, each network driver was designed with the expectation of unrealistically high data buffering needs, as the developers optimized the packet scheduler for the highest speeds.  However, their IRLs are rarely used during a WiFi connection.  That's why the seals load slowly, and the video calls turn into torture.  <a href="http://dslreports.com/speedtest">Check your IB</a> without SMS and registration. </p><br><p>  The trouble is that the main <em>bufferbloat</em> on the side of the provider, correcting the situation there, you get an increase in connection speed for free.  Speedtest <a href="http://www.dslreports.com/speedtest/5408767">ISP Xfinity</a> and <a href="http://www.dslreports.com/speedtest/5448121">Google Fiber</a> . </p><br><p>  Not to say that the case was limited to only whining.  Since Linux 3.3, a whole series of fixes and optimizations aimed at eliminating information security has been released. </p><br><ul><li>  Linux 3.3: Byte Queue Limits </li><li>  Linux 3.4 RED bug fixes &amp; IW10 added &amp; SFQRED </li><li>  Linux 3.5 Fair / Flow Queuing packet scheduling (fq_codel, codel) </li><li>  Linux 3.7 TCP small queues (TSQ) </li><li>  Linux 3.12 TSO / GSO improvements </li><li>  Linux 3.13 Host FQ + Pacing (sch_fq) </li><li>  Linux 3.15 Change to microseconds from milliseconds throughout networking kernel </li><li>  Linux 3.17 Network Batching API </li><li>  Linux 4.9 BBR (Bottleneck Bandwidth and RTT) </li></ul><br><p>  The latest BBR algorithm in this series of fixes.  <a href="http://www.opennet.ru/opennews/art.shtml%3Fnum%3D45662">News from opennet.ru</a> . </p><br><blockquote>  <em>The kernel includes the implementation of the congestion control (BBR (Bottleneck Bandwidth and RTT)) algorithm proposed by Google and successfully used to increase throughput and reduce data transmission delays for traffic from google.com and YouTube.</em>  <em>BBR requires changes only on the side of the sender, the software of the network infrastructure and the receiving side remain unchanged.</em>  <em>Instead of using packet loss as an overload indicator, BBR uses a simulation of a communication channel that predicts the available throughput through sequential checks and an estimate of the time-of-arrival (RTT), but not leading to packet loss or transmission delays.</em>  <em>At the initial stage of connection, BBR evaluates the channel bandwidth ceiling, then reduces the send rate for unloading the queue and goes into adjustment mode, then increasing, then reducing the send rate, balancing between the maximum bandwidth and the incomplete packet queue;</em> </blockquote><p><br>  These changes affected almost all network protocols, but bypassed WiFi and LTE.  It could not go on for a long time and took WiFi seriously.  The Make WiFi Fast project brought together hundreds of participants led by a team of nuclear networkers. </p><br><h2>  Terminology </h2><br><ul><li>  <code>QDisc</code> or Queuing Discipline is a regular FIFO scheduler, it is located between the IP stack and the driver. </li></ul><br><img src="https://habrastorage.org/files/a93/be2/d12/a93be2d12af64d7a863bc7e0819ef9dd.png"><br><p><br></p><br><ul><li>  The <code>fq_codel</code> not that simple.  About him already <a href="https://habrahabr.ru/post/194274/">wrote on Habr√©</a> , therefore I will not repeat. </li></ul><br><blockquote>  <code>fq_codel</code> is <em>one of the most efficient and advanced algorithms using AQM</em> . </blockquote><br><ul><li>  TXOP - transmit opportunity, attempt to send. </li></ul><br><h2>  How patched up WiFi </h2><br><p>  Dave T√§ht, who has already saved the Internet for the past six years, attacked the problem with the help of new and better benchmarks, which he himself had to develop.  <code>Iperf3</code> , quite popular in the scientific community and beyond, <a href="http://burntchrome.blogspot.com/2016/09/iperf3-and-microbursts.html">turned out to be</a> <code>Iperf3</code> in general, since by default it assumes unrealistic 100 ms information security. </p><br><pre> <code class="hljs lisp">while( <span class="hljs-name"><span class="hljs-name">testing</span></span>) sleep <span class="hljs-number"><span class="hljs-number">100</span></span>ms while( <span class="hljs-name"><span class="hljs-name">total_bytes_sent</span></span> / total_elapsed_time &lt; target_rate) transmit buffer of data</code> </pre> <br><p>  So it was before the patch.  Notice the huge latency at&gt; 10 on the top and bottom levels of the WiFi stack. </p><br><img src="https://habrastorage.org/files/c9e/56a/729/c9e56a729f2c4e59a07fd2aa4e6fb32a.png"><br><p><br></p><br><ul><li>  QDisc removed completely.  The queue is now formed by stations and advancing in a circular cycle, aka Round Robin Fair Queuing. </li><li>  Buffering has moved to the MAC80211 <em>intermediate scheduler</em> level, which is controlled by <code>fq_codel</code> .  it has a minimum size of no more than 2 TXOPs. </li><li>  Driver buffering minimum, at most 2 TXOP pools (1.2-10ms): 1 ready aggregated frame for retry and another 1 in response. </li></ul><br><img src="https://habrastorage.org/files/ffa/ea1/278/ffaea1278cdf4454b2be16360d80514d.png"><br><p>  The MAC80211 no longer stores the packets at the lower level of the driver, but sends them to the <em>intermediate scheduler</em> , reports this to the driver, and he takes them as they arrive.  Because of this, the MAC80211 has more information about when data transfer occurs.  Due to this delay from buffering amounted to only 2-12 ms. </p><br><h2>  What has been achieved </h2><br><p>  IB managed to exceed so much that delays decreased from peak values ‚Äã‚Äãof 1-2 seconds to 40 msec.  The most graphic illustration will be a picture that shows WiFi sessions on 100 workstations before and after the patch. </p><br><p>  <em>Before the patch, only 5 stations started successfully.</em>  <em>Monstrous&gt; 15 seconds brakes.</em>  <em>Clickable</em> </p><br><p> <a href=""><img src="https://habrastorage.org/files/13e/871/f21/13e871f21ee64aac8a5a101596160c3f.png"><br><br></a> </p><br><p>  <em>After the patch, all stations started successfully.</em>  <em>Delays are acceptable 150-300 msec.</em>  <em>Clickable</em> </p><br><p> <a href=""><img src="https://habrastorage.org/files/d06/4ee/003/d064ee003e014a1e8c1dc511bdf76f2b.png"></a> </p><br><p>  Now a fly in the ointment.  So far only <a href="https://lede-project.org/">ath9k drivers</a> fully support all these innovations, <code>ath10k</code> is almost ready.  The rest will have to wait for now, but I'm sure the rest of the drivers will also be actively updated after the patches fall into a stable branch. </p><br><h3>  Used materials and useful links </h3><br><ul><li>  <a href="https://lwn.net/Articles/705884/">Making WiFI Fast</a> </li><li>  <a href="http://www.linuxplumbersconf.com/2016/ocw//system/presentations/3963/original/linuxplumbers_wifi_latency-3Nov.pdf">Linux wifi latencies</a> </li><li>  <a href="http://fqcodel.bufferbloat.net/~d/fcc_saner_software_practices.pdf">Petition to the FCC</a> </li><li>  <a href="https://docs.google.com/document/d/1Se36svYE1Uzpppe1HWnEyat_sAGghB3kE285LElJBW4">Project Make WiFi Fast.</a> </li><li>  <a href="https://www.coverfire.com/articles/queueing-in-the-linux-network-stack/">Queuing in the linux network stack</a> </li></ul><br><hr><br><ol><li><a name="cite_ref-1"></a>  <a href="https://habr.com/ru/post/317548/">‚Üë</a> Latency <br></li><li><a name="cite_ref-2"></a>  <a href="https://habr.com/ru/post/317548/">‚Üë</a> Bufferbloat <br></li><li><a name="cite_ref-3"></a>  <a href="https://habr.com/ru/post/317548/">‚Üë</a> Benchmark <br></li><li><a name="cite_ref-4"></a>  <a href="https://habr.com/ru/post/317548/">‚Üë</a> Round Trip Time <br></li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/317548/">https://habr.com/ru/post/317548/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317534/index.html">Console to the masses. Go to the bright side. Part one</a></li>
<li><a href="../317536/index.html">Analysis of the report of Ruslan Cheryomin with JPoint 2016</a></li>
<li><a href="../317538/index.html">How to accidentally enter the top 15 IT projects for business</a></li>
<li><a href="../317544/index.html">How well to submit the results of qualitative research: the method of thematic networks (+ analysis of ATS as an example)</a></li>
<li><a href="../317546/index.html">Check-list for the preparation of high-quality presentation</a></li>
<li><a href="../317550/index.html">Creating a blog engine with Phoenix and Elixir / Part 6. Markdown support</a></li>
<li><a href="../317552/index.html">Friday post: opensource CRM of the outgoing year</a></li>
<li><a href="../317554/index.html">IBM and Nvidia increased the speed of deep learning neural networks</a></li>
<li><a href="../317556/index.html">Immigration to Russia</a></li>
<li><a href="../317558/index.html">Selected places from the popular textbook of microelectronics in Russian, which is finally published on paper</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>