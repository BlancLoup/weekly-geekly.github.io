<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LFS: The dark side of power. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 So, it's time to put the last dots on ‚Äúi‚Äù and tell you how to finally get Linux from the heap of executable files and libraries that we her...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LFS: The dark side of power. Part 3</h1><div class="post__text post__text-html js-mediator-article"><h1>  Foreword </h1><br>  So, it's time to put the last dots on ‚Äúi‚Äù and tell you how to finally get Linux from the heap of executable files and libraries that we heroically collected and set up <a href="http://habrahabr.ru/post/257941/">in the last article</a> . <br><br><h1>  1. Unix System V Initialization Subsystem </h1><br>  This initialization subsystem has been used for a long time in Linux and has been the de facto standard.  However, time passes, and one cannot, in general, call this approach obsolete.  It is much more accurate to note that this initialization subsystem, in the trend of development of the GNU / Linux family of systems, has given way to systemd, born in the depths of Red Hat Corporation.  There are distributions that still use initialization scripts.  However, all the popular Linuxes almost every time came to the use of systemd, with the latter finally giving in to the conservative Debian with its daughter Ubuntu. <br><br>  Actually, I regret that I didn‚Äôt immediately begin to build an LFS version using systemd.  Simply, after the first unsuccessful attempt at assembly, I didn‚Äôt want to deviate from a stable path.  Maybe I will come back to this issue, maybe just as I will not return.  Time will tell.  In the meantime, consider the basic principles of the System V initialization scripts. <br><a name="habracut"></a><br>  When booting the system, the boot loader reads the Linux kernel from the root partition of the bootable media.  After the kernel is initialized, control is transferred to the init process, which receives the PID = 1 (physically located in the / sbin / init file).  This process works according to the settings specified in the / etc / inittab file. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The default is seven levels of system initialization. <br><br><ul><li>  0 - system stop <br></li><li>  1 - system boot in single user mode <br></li><li>  2 - system boot in multiuser mode without network support <br></li><li>  3 - system boot in multiuser mode with network support <br></li><li>  4 - not used <br></li><li>  5 - system boot in multi-user mode with network support and graphical login <br></li><li>  6 - system reboot <br></li></ul><br><br>  Each startup level corresponds to initialization scripts, in the case of LFS located in the /etc/rc.d/init.d/ directory.  You don‚Äôt have to write them yourself - the LFS authors took care of this by including everything you need to configure in the LFS-Bootscripts package, which lies along the $ LFS / source path.  We just have to install this package and make some minimum settings. <br><br><h1>  2. Installing LFS-Bootscripts, network configuration, / etc / inittab </h1><br>  Suppose the assembly of packages at the previous stage, you tired, and there were other things and you turned off the machine.  Now you need to get into the collected system again.  This requires chroot <br><br>  Mount the partition with the system and VFS: <br><br><pre><code class="hljs mel">$ su - root # export LFS=/mnt/lfs # mount /dev/sda6 $LFS # mount -v --bind /dev $LFS/dev # mount -vt devpts devpts $LFS/dev/pts -o gid=<span class="hljs-number"><span class="hljs-number">5</span></span>,mode=<span class="hljs-number"><span class="hljs-number">620</span></span> # mount -vt <span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> $LFS/<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> # mount -vt sysfs sysfs $LFS/sys # mount -vt tmpfs tmpfs $LFS/run</code> </pre> <br>  Perform root change: <br><br><pre> <code class="hljs tex"># chroot "<span class="hljs-formula"><span class="hljs-formula">$LFS" /usr/bin/env -i </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; HOME=/root TERM="$</span></span>TERM" PS1='[<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span>]<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">$</span></span></span></span> ' <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&gt; PATH=/bin:/usr/bin:/sbin:/usr/sbin <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&gt; /bin/bash --login</code> </pre><br>  Go to the source directory and install the necessary package. <br><br><pre> <code class="hljs dos"># <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /source # tar -pxf lfs-bootscripts-<span class="hljs-number"><span class="hljs-number">20150222</span></span>.tar.bz2 # <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> lfs-bootscripts-<span class="hljs-number"><span class="hljs-number">20150222</span></span> # make install</code> </pre><br>  Nothing particularly tricky and was not supposed - the scripts will simply be installed along the right paths. <br><br>  And now proceed to configure.  Generate Udev rules: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># bash /lib/udev/init-net-rules.sh</span></span></code> </pre><br>  Further, the manual offers us to check and edit the rule for naming network interfaces, located in /etc/udev/rules.d/70-persistent-net.rules.  And here I was waiting for a bummer - the generation script gave an error - I can not generate this file. <br><br>  The answer is in the same manual: <br><blockquote>  In some cases, such as when it comes to the network rules, it‚Äôs not.  In these cases, this method cannot be used. </blockquote><br><br>  Yes, but the case with ‚ÄúQemu or Xen‚Äù is just mine - I collected it under a virtual machine (VirtualBox, as is known, using the Qemu code).  Well, let's write the rule for naming a network card manually.  And now we don‚Äôt need to use the cat command to create the file - because we have collected and configured the whole Vim!  And Vim is power <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># vim /etc/udev/rules.d/70-persistent-net.rules</span></span></code> </pre><br>  We type the text of the rule: <br><br><pre> <code class="hljs pgsql"># net device e1000 SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="08:00:27:f8:4c:26", ATTR{dev_id}="0x0", ATTR{<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>}="1", KERNEL=="eth*", <span class="hljs-type"><span class="hljs-type">NAME</span></span>=="eth0"</code> </pre><br>  This rule, when the kernel detects a network device, with the MAC address specified by us as an attribute, assigns it the name eth0.  The MAC address of your network card can be learned by giving the following command in the terminal: <br><br><pre> <code class="hljs pgsql"># ip link <span class="hljs-number"><span class="hljs-number">1</span></span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="hljs-number"><span class="hljs-number">65536</span></span> qdisc noqueue state <span class="hljs-type"><span class="hljs-type">UNKNOWN</span></span> mode <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> link/loopback <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> brd <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number"><span class="hljs-number">1500</span></span> qdisc fq_codel state UP mode <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> qlen <span class="hljs-number"><span class="hljs-number">1000</span></span> link/ether <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:f8:<span class="hljs-number"><span class="hljs-number">4</span></span>c:<span class="hljs-number"><span class="hljs-number">26</span></span> brd ff:ff:ff:ff:ff:ff</code> </pre><br>  The link / ether parameter of the enp03s device is the required poppy.  The device is named the host system (and we remember that we only changed the root and meaning of some environment variables by running the ‚Äúcombat‚Äù bash, but we remained in the host system and all devices are available to us). <br><br>  Now you can set up access to the network.  In my case, when building on a VM, it goes to the network through virtual NAT, so a DHCP client is required.  We specifically downloaded the dhcpcd package, now we will build it and install it on the system: <br><br><pre> <code class="hljs go"># tar -pxf dhcpcd<span class="hljs-number"><span class="hljs-number">-6.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>.tar.bz2 # cd dhcpcd<span class="hljs-number"><span class="hljs-number">-6.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> # ./configure --libexecdir=/lib/dhcpcd --dbdir=/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/tmp # <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> # <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> install # cd .. # rm -rf dhcpcd<span class="hljs-number"><span class="hljs-number">-6.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/</code> </pre><br>  In addition, install the scripts necessary for dhcpcd to work: <br><br><pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">tar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-pxf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">blfs-bootscripts-20150304</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tar</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bz2</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">cd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">blfs-bootscripts-20150304</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">make</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">install-service-dhcpcd</span></span></code> </pre><br>  And finally, let's create a config: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># vim /etc/sysconfig/ifconfig.eth0</span></span></code> </pre><br><br>  With contents: <br><br><pre> <code class="hljs objectivec">ONBOOT=<span class="hljs-string"><span class="hljs-string">"yes"</span></span> IFACE=<span class="hljs-string"><span class="hljs-string">"eth0"</span></span> SERVICE=<span class="hljs-string"><span class="hljs-string">"dhcpcd"</span></span> DHCP_START=<span class="hljs-string"><span class="hljs-string">""</span></span> DHCP_STOP=<span class="hljs-string"><span class="hljs-string">"-k"</span></span></code> </pre><br>  The meaning of the parameters is as follows: <br><br><ul><li>  ONBOOT = "yes" - start the daemon when the system boots <br></li><li>  IFACE = "eth0" - getting ip from the server on the eth0 interface <br></li><li>  SERVICE = "dhcpcd" - starting service <br></li><li>  DHCP_START = "" - startup options <br></li><li>  DHCP_STOP = "- k" - stop parameters (kill) <br></li></ul><br><br>  Create a file / etc / hostname, in which we write the host name: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">echo</span></span> <span class="hljs-string"><span class="hljs-string">"lfs"</span></span> &gt; /etc/hostname</code> </pre><br>  After these operations, you can count on the fact that after a reboot, we will have a network. <br><br>  Now let's set up init. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># vim /etc/inittab</span></span></code> </pre><br>  The manual offers the following script: <br><br><pre> <code class="hljs vhdl"># <span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> /etc/inittab #      - <span class="hljs-number"><span class="hljs-number">3</span></span> id:<span class="hljs-number"><span class="hljs-number">3</span></span>:initdefault: #   (   ) si::sysinit:/etc/rc.d/init.d/rc S #    #     l0:<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">wait</span></span>:/etc/rc.d/init.d/rc <span class="hljs-number"><span class="hljs-number">0</span></span> l1:S1:<span class="hljs-keyword"><span class="hljs-keyword">wait</span></span>:/etc/rc.d/init.d/rc <span class="hljs-number"><span class="hljs-number">1</span></span> l2:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">wait</span></span>:/etc/rc.d/init.d/rc <span class="hljs-number"><span class="hljs-number">2</span></span> l3:<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">wait</span></span>:/etc/rc.d/init.d/rc <span class="hljs-number"><span class="hljs-number">3</span></span> l4:<span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">wait</span></span>:/etc/rc.d/init.d/rc <span class="hljs-number"><span class="hljs-number">4</span></span> l5:<span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">wait</span></span>:/etc/rc.d/init.d/rc <span class="hljs-number"><span class="hljs-number">5</span></span> l6:<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">wait</span></span>:/etc/rc.d/init.d/rc <span class="hljs-number"><span class="hljs-number">6</span></span> #    Ctrl + Alt + Del -  ca:<span class="hljs-number"><span class="hljs-number">12345</span></span>:ctrlaltdel:/sbin/shutdown -t1 -a -r now #      su:S016:once:/sbin/sulogin #    <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">2345</span></span>:respawn:/sbin/agetty <span class="hljs-comment"><span class="hljs-comment">--noclear tty1 9600 2:2345:respawn:/sbin/agetty tty2 9600 3:2345:respawn:/sbin/agetty tty3 9600 4:2345:respawn:/sbin/agetty tty4 9600 5:2345:respawn:/sbin/agetty tty5 9600 6:2345:respawn:/sbin/agetty tty6 9600 # End /etc/inittab</span></span></code> </pre><br>  The lines of this file consist of four fields separated by colons: <br><br><pre> <code class="hljs ruby">&lt;id&gt;<span class="hljs-symbol"><span class="hljs-symbol">:&lt;runlevels&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:&lt;action&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:&lt;process&gt;</span></span></code> </pre><br><br><ul><li>  id - string identifier - an arbitrary combination containing from 1 to 4 characters.  Two strings with the same identifier are allowed. <br></li><li>  runlevels - the run levels at which this line is involved.  Levels are listed in numbers without any separators, for example, 235 (work at 2, 3 and 5 levels) <br></li><li>  process - a process that should be launched at specified levels (the name of the program called at specified execution levels) <br></li><li>  action is an action that defines additional conditions for executing a command.  Possible values <br><br><ul><li>  respawn - restart the process when it is completed <br></li><li>  once - execute the process only once when moving to the specified level <br></li><li>  wait - process start and init initiation to start its mode <br></li><li>  sysinit - actions performed by init at the very beginning, before moving to any level of execution.  Processes marked in this way are started before processes marked as boot and bootwait <br></li><li>  boot - the process will be started at the system boot stage, regardless of the level of execution <br></li><li>  The bootwait is the same as boot, but with init being put on hold. <br></li><li>  powerwait - actions performed when a power failure.  Requires UPS <br></li><li>  ctrlaltdel - action is performed by pressing the "three magic buttons" <br></li><li>  off - ignore this element <br></li></ul><br></li></ul><br>  To implement actions at various execution levels, LFS provides the /etc/rc.d/init.d/rc script, which accepts a launch level as a parameter. <br><br>  To perform a single-user login in case of a boot failure, the / sbin / sulogin command is called, this single-user login and executes. <br><br>  The / sbin / shutdown process starts when the system is stopped / rebooted <br><br>  / sbin / agetty - creates and initializes a virtual terminal. <br><br>  You can change the execution level during system operation by issuing a command from root <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># init </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;runlevel&gt;</span></span></span></span></code> </pre><br>  specifying the trigger level as a parameter.  The halt command known to most is the alias to init 0, and the reboot command is the alias to init 6. <br><br>  You can find out the current launch level by issuing the command: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># runlevel</span></span></code> </pre><br>  or: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># who -r</span></span></code> </pre><br><h1>  3. Clocks, localization and other pleasant things </h1><br>  For correct operation of the system clock, create a config. <br><br>  <b>/ etc / sysconfig / clock</b> <br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> /etc/sysconfig/clock UTC=<span class="hljs-number"><span class="hljs-number">1</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">options</span></span> you might need <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> give <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> hwclock, # such <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> machine hardware clock <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Alphas. CLOCKPARAMS= # <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> /etc/sysconfig/clock</code> </pre><br><br>  Here it is indicated that the hardware clock will go according to universal universal time, and we have already made an amendment to the time zone when setting up the GLibc package. <br><br>  Now you need to correctly configure the console font.  We set all the locales we needed with GLibc.  We are interested in Cyrillic, so we create a console configuration file in this form <br><br>  <b>/ etc / sysconfig / console</b> <br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> /etc/sysconfig/console UNICODE="1" KEYMAP="us" FONT="UniCyr_8x16" # <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> /etc/sysconfig/console</code> </pre><br><br><ul><li>  UNICODE = "1" - we indicate that we will use the locale in UTF-8 <br></li><li>  KEYMAP = "us" - console layout <br></li><li>  FONT = "UniCyr_8x16 - set the Cyrillic console font <br></li></ul><br><br>  Set the locale by setting the default bash profile <br><br>  <b>/ etc / profile</b> <br><pre> <code class="hljs delphi"># <span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> /etc/profile <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> LANG=ru_RU.UTF-<span class="hljs-number"><span class="hljs-number">8</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> /etc/profile</code> </pre><br><br>  For order, you should also ‚Äúbind‚Äù some keyboard settings used by the shell and the readline library, which is responsible for keyboard input. <br><br>  <b>/ etc / inputrc</b> <br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> /etc/inputrc #       <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> horizontal-scroll-mode <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> #  <span class="hljs-number"><span class="hljs-number">8</span></span>-   <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> meta-flag <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>-meta <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> #   <span class="hljs-number"><span class="hljs-number">8</span></span>-  <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> convert-meta <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> #  <span class="hljs-number"><span class="hljs-number">8</span></span>-    <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> output-meta <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> # ,    <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> bell-style <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> #   -   <span class="hljs-keyword"><span class="hljs-keyword">escape</span></span>- , #    ,    # readline "\eOd": backward-word "\eOc": forward-word # <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> linux console "\e[1~": beginning-<span class="hljs-keyword"><span class="hljs-keyword">of</span></span>-<span class="hljs-type"><span class="hljs-type">line</span></span> "\e[4~": <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">of</span></span>-<span class="hljs-type"><span class="hljs-type">line</span></span> "\e[5~": beginning-<span class="hljs-keyword"><span class="hljs-keyword">of</span></span>-history "\e[6~": <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">of</span></span>-history "\e[3~": <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>-<span class="hljs-type"><span class="hljs-type">char</span></span> "\e[2~": quoted-<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> xterm "\eOH": beginning-<span class="hljs-keyword"><span class="hljs-keyword">of</span></span>-<span class="hljs-type"><span class="hljs-type">line</span></span> "\eOF": <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">of</span></span>-<span class="hljs-type"><span class="hljs-type">line</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Konsole "\e[H": beginning-<span class="hljs-keyword"><span class="hljs-keyword">of</span></span>-<span class="hljs-type"><span class="hljs-type">line</span></span> "\e[F": <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">of</span></span>-<span class="hljs-type"><span class="hljs-type">line</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> /etc/inputrc</code> </pre><br><br>  I don‚Äôt want to give particular attention to this configuration, so we‚Äôll leave a detailed analysis of it as homework. <br><br>  The following config defines the names of the shells, the use of which is allowed in the system <br><br>  <b>/ etc / shells</b> <br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> /etc/shells /bin/sh /bin/bash # <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> /etc/shells</code> </pre><br><br>  This is where the initial system setup is over, only a few finishing touches remain. <br><br><h1>  4. Building the kernel </h1><br>  The irony is that the kernel build is a smaller part of the whole work.  Go to the / sources directory and unpack (once again) the source code: <br><br><pre> <code class="hljs dos"># <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /sources # tar -pxf linux-<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>.tar.bz2 # <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> linux-<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span></code> </pre><br>  Prepare the kernel for compilation by checking the source tree: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># make mrproper</span></span></code> </pre><br>  It is necessary to generate the kernel build config: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># make menuconfig</span></span></code> </pre><br>  This will launch a configurator familiar to many not by hearsay. <br><br>  What can be said about the required configuration.  First, the LFS assembly manual recommends checking the installation of the following option: <br><br><img src="https://habrastorage.org/files/3c2/679/35f/3c267935f63c4ec692cecc5698f05196.png"><br><br>  Support for mounting the devtmpfs virtual file system in / dev - dynamically creating device files in memory and mounting / dev at an early stage of kernel boot. <br><br>  Everything else depends on your hardware configuration and the features that you would like to include in the kernel.  For example, I added only full support for NTFS, the rest left by default. <br><br>  Save the config as .config, exit the configurator and build the kernel <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># make</span></span></code> </pre><br>  Install kernel modules: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># make modules_install</span></span></code> </pre><br>  Copy the compiled kernel into the / boot directory, renaming it: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># cp -v arch/x86_64/boot/bzImage /boot/vmlinuz-3.19-lfs-7.7</span></span></code> </pre><br>  Save the map file and the config of the assembled kernel: <br><br><pre> <code class="hljs swift"># cp -v <span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> /boot/<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>-<span class="hljs-number"><span class="hljs-number">3.19</span></span> # cp -v .config /boot/config-<span class="hljs-number"><span class="hljs-number">3.19</span></span></code> </pre><br>  We are installing the documentation: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># install -d /usr/share/doc/linux-3.19 # cp -r Documentation/* /usr/share/doc/linux-3.19</span></span></code> </pre><br>  Create configs for optional module loading, for example, for USB support: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># install -v -m755 -d /etc/modprobe.d # vim /etc/modprobe.d/usb.conf</span></span></code> </pre><br>  <b>/etc/modprobe.d/usb.conf</b> <br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> /etc/modprobe.d/usb.conf install ohci_hcd /sbin/modprobe ehci_hcd ; /sbin/modprobe -i ohci_hcd ; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> install uhci_hcd /sbin/modprobe ehci_hcd ; /sbin/modprobe -i uhci_hcd ; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> /etc/modprobe.d/usb.conf</code> </pre><br>  We clean up after ourselves: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># cd .. # rm -rf linux-3.19/</span></span></code> </pre><br><br><h1>  5. Mounting File Systems and Bootloader Configuration </h1><br>  Create a mount config / etc / fstab.  I looked like this: <br><br>  <b>/ etc / fstab</b> <br><pre> <code class="hljs mel">/dev/sda6 / ext4 defaults <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> /dev/sda2 swap swap pri=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> nosuid,noexec,nodev <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> sysfs /sys sysfs nosuid,noexec,nodev <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> devpts /dev/pts devpts gid=<span class="hljs-number"><span class="hljs-number">5</span></span>,mode=<span class="hljs-number"><span class="hljs-number">620</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> tmpfs /run tmpfs defaults <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> devtmpfs /dev devtmpfs mode=<span class="hljs-number"><span class="hljs-number">0755</span></span>,nosuid <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br>  / dev / sda2 and / dev / sda6 are the swap and the root partition of the LFS system, respectively. <br><br>  Since I collected LFS from a system already installed on the HDD (Arch Linux), then for its first boot I preferred to use the Grub2 boot loader already installed on the hard disk.  To configure, I used the config to create a custom boot menu item. <br><br>  We leave from the collected system: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># loguot</span></span></code> </pre><br>  And in the host system, edit the file: <br><br>  <b>/etc/grub.d/40_custom</b> <br><pre> <code class="hljs pgsql">#!/bin/sh exec tail -n +<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-meta"><span class="hljs-meta">$0</span></span> # This file provides an easy way <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> custom menu entries. Simply <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> the # menu entries you want <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>. Be careful <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> change # the <span class="hljs-string"><span class="hljs-string">'exec tail'</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> above. menuentry "GNU/Linux, Linux 3.19-lfs-7.7" { insmod=ext2 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> root=(hd0,<span class="hljs-number"><span class="hljs-number">6</span></span>) linux /boot/vmlinuz<span class="hljs-number"><span class="hljs-number">-3.19</span></span>-lfs<span class="hljs-number"><span class="hljs-number">-7.7</span></span> root=/dev/sda6 ro }</code> </pre><br>  Then we regenerate the bootloader config: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># grub-mkconfig -o /boot/grub/grub.cfg</span></span></code> </pre><br>  And ... reboot: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># systemctl reboot</span></span></code> </pre><br>  If everything is in order and we were not mistaken, the OS selection menu will appear: <br><br><img src="https://habrastorage.org/files/85c/86f/907/85c86f90745a4785b84260e04d351445.png"><br><br>  Choose the last item of our LFS system ... <br><br><img src="https://habrastorage.org/files/14e/ce2/769/14ece2769e8b4ed886d9478d51df33d9.png"><br><br>  Yes!  The download started, you can see how the network interface rises, waiting for when we get the ip and ... login screen: <br><br><img src="https://habrastorage.org/files/96d/1ce/9c5/96d1ce9c555747bab693933e6433b62f.png"><br><br>  Login as root: <br><br><img src="https://habrastorage.org/files/e81/873/c8f/e81873c8fc4e4d659c85876245973008.png"><br><br>  And we run something that will show us the correct locale setting: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># vim</span></span></code> </pre><br><img src="https://habrastorage.org/files/3dd/5c9/f09/3dd5c9f0938345b1a09f2ae384f7b340.png"><br><br>  Russian language is where it should be.  Check the network: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># ping ya.ru</span></span></code> </pre><br>  And watch the ping go: <br><br><img src="https://habrastorage.org/files/5db/173/b85/5db173b85e2d4f61a20ef55229890880.png"><br><br>  Well then <br><br><h1>  Now that the goal has been achieved .... Instead of concluding </h1><br>  We tried our hand at building Linux from scratch (from scratch).  And we succeeded.  We have a minimal working system with which you can continue to do anything - transfer to real hardware, try to turn it into a home system.  You can admire and forget, because maintaining a home system without a package manager is pretty hard. <br><br>  I did it just for fun, got some new knowledge, and in general I was satisfied, which I wish my readers. <br><br>  <b>PS: the</b> system collected by me <a href="https%253A%252F%252Fyadi.sk%252Fd%252FwHAsTczFgifan">can be downloaded here</a> .  Under the link - a disk image for VirtualBox.  The input parameters are as follows. <br><br>  login: root <br>  passwd: 123456 <br><br>  login: maisvendoo <br>  passwd: maisvendoo </div><p>Source: <a href="https://habr.com/ru/post/258227/">https://habr.com/ru/post/258227/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258213/index.html">Count the life of the site, or visualize the connection between pages</a></li>
<li><a href="../258217/index.html">Course young fighter. Practical course on Cisco Packet Tracer. Conclusion</a></li>
<li><a href="../258219/index.html">AI, Big Data and Disinformation Technologies</a></li>
<li><a href="../258223/index.html">All-weather meetings, hackathons, lectures and even internships for the IT community</a></li>
<li><a href="../258225/index.html">Callback - a great overview of callback services</a></li>
<li><a href="../258229/index.html">Comparison of prices for European and Russian "clouds" with SSD-drives</a></li>
<li><a href="../258231/index.html">Video observation and broadcast at the polling station</a></li>
<li><a href="../258233/index.html">Google Word Witchcraft</a></li>
<li><a href="../258235/index.html">PCs and servers based on the Elbrus-4C processors are on sale</a></li>
<li><a href="../258237/index.html">Moore's Law for Google Compute Engine: more power for the same money</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>