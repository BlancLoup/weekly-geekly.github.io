<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ElasticSearch 1.0 - new analytics features</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many have heard about the high-level search server ElasticSearch , but not everyone knows that many people use it for quite different purposes. This i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ElasticSearch 1.0 - new analytics features</h1><div class="post__text post__text-html js-mediator-article">  Many have heard about the high-level search server <a href="http://www.elasticsearch.org/">ElasticSearch</a> , but not everyone knows that many people use it for quite different purposes.  This is a real-time analytics of various structured and not very data. <br><br>  This article is also overdue due to the fact that many large Internet-based projects of Runet in 2014 received letters from Google Analytics with an offer to pay $ 150,000 for the opportunity to use their product.  I personally think that there is nothing wrong with paying for the work of programmers and administrators.  But at the same time, these are quite serious investments, and, maybe, investments in our own infrastructure and specialists will give greater flexibility in the future. <br><br>  Analytics in ElasticSearch is based on full-text search and facets.  Facets in the search - this is some kind of aggregation on a certain basis.  You have often come across facet filters in online stores: in the left or right column there are specifying ticks.  Below is an example of a test facet search on our home page <a href="http://indexisto.com/">http://indexisto.com/</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href="http://indexisto.com/"><img src="https://habrastorage.org/getpro/habr/post_images/e95/f48/d53/e95f48d53635000ac1d6833127c9b1d1.png"></a> <br><br>  Just a week ago, a stable version of the search server ElasticSearch 1.0 was released, in which the developers worked so hard on the facets that they even called them Aggregation. <br><br>  Since the topic has not yet been covered in Habr√©, I want to tell you what aggregations in ElasticSearch are, what opportunities open up and whether there is life without Hadoop. <br><a name="habracut"></a><br>  First, I would like to give statistics from <a href="http://www.google.ru/trends/explore">Google Trends</a> , which clearly shows how great interest in ElasticSearch is: <br><img src="https://habrastorage.org/getpro/habr/post_images/c92/869/860/c928698606244e2272249251fc88b65a.png"><br><br>  The point here, of course, is not that it is a search server with morphology and other goodies.  The main thing is easy scalability on large amounts of data.  The data itself is dispersed by shards (logical index splitting), and shards by nodes (servers).  Then shards are also replicated to other nodes in order to survive the server crash and for query performance.  It is necessary to think, mainly, during the elaboration of the index scheme. <br><br><h4>  Distributed computing </h4><br>  The query is executed on the cluster in parallel, on those shards in which the index of interest lies.  Shards are, in fact, good old Lucene indices.  All that ElasticSearch does is accept the request, determine the nodes where the shards of the index to which the request came are, send the request to these shards, the shards count and send the results to the initiator node.  The initiating node already does the convolution and sends it to the client.  On data streams, this is similar to a reduce map, when Lucene indices are mappers, and the initiating node is a reducer. <br><br>  Some requests can be executed in one pass, some in several.  For example, to calculate the standard text relevance tf / idf, based on the frequency of the term in the document (tf) and in the collection of documents (idf), obviously, you must first get idf with all shards (the first request to shards), and then make the main request (second).  Although for speed idf can be counted locally on the shard. <br><br>  Let's make a faceted query ‚ÄúHow many errors were in the logs by year‚Äù.  This query searches for ERROR in log documents, and makes facets by year. <br>  This is how data flows look like: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b73/aee/800/b73aee80093a29fe749eedd050558d1e.png"><br><br>  The node to which the request came, executed it itself (since it has one of the shards of the required index) and sent it to other nodes that contain other index shards.  Each shard performs approximately the following sequence in the index: <br><ul><li>  define the maximum and minimum value in the date field.  Lucene does not store within the date or number - all in the text view. </li><li>  prepare the necessary date ranges in accordance with the partition the user needs.  We have it for 1 year.  If there are logs for 2 years, then we get 2 requests </li><li>  go through the inverted index and count all documents (log entries) that contain ERROR and fall into the current range.  Make such a request for all ranges. <br></li></ul><br>  A quick reference to Lucene.  Range queries on "numbers" in textual representation are very effective. <a href="http://lucene.apache.org/core/3_0_3/api/core/org/apache/lucene/search/NumericRangeQuery.html">NumericRangeQuery</a> : <br><pre><code class="bash hljs">Comparisons of the different types of RangeQueries on an index with about 500,000 docs showed that TermRangeQuery <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> boolean rewrite mode (with raised BooleanQuery clause count) took about 30-40 secs to complete, TermRangeQuery <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> constant score filter rewrite mode took 5 secs and executing this class took &lt;100ms to complete</code> </pre> <br><br><h4>  We proceed to practice.  Prepare the data </h4><br>  Since now we‚Äôll just see what can be aggregated into ElasticSearch, we will not chase after volumes, but we‚Äôll add habr index and add 20 posts to it. <br>  Posts will be like this structure: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"andrey"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Android  1"</span></span>, <span class="hljs-string"><span class="hljs-string">"body"</span></span>: <span class="hljs-string"><span class="hljs-string">"Android  1"</span></span>, <span class="hljs-string"><span class="hljs-string">"postDate"</span></span>: <span class="hljs-string"><span class="hljs-string">"2011-02-15T11:12:12"</span></span>, <span class="hljs-string"><span class="hljs-string">"tags"</span></span>: [<span class="hljs-string"><span class="hljs-string">""</span></span>], <span class="hljs-string"><span class="hljs-string">"rank"</span></span>: <span class="hljs-number"><span class="hljs-number">67</span></span>, <span class="hljs-string"><span class="hljs-string">"comments"</span></span>: <span class="hljs-number"><span class="hljs-number">21</span></span> }</code> </pre><br><br>  I created 10 posts about Android and 10 posts about iPhone. <br>  Posts can have one or more tags from the set <br><ul><li>  explosion </li><li>  update </li><li>  attachment </li><li>  bug </li></ul><br>  Years of posts from <b>2011</b> to <b>2014</b> .  Rating from <b>0</b> to <b>100</b> .  Number of comments is similar. <br><br>  Here is what we have in the index as a result: <br><br><img src="http://habrastorage.org/getpro/habr/post_images/c6c/c50/7d6/c6cc507d6607e1843d752314295937d5.png"><br><br><h4>  Old-school-analysis (up to version ES 1.0) </h4><br>  <b>Tag allocation in posts about Android</b> <br>  Immediately in practice, we will show what can be analyzed by combining full-text search and facets.  Make a <b>android</b> search query to the <i>Title</i> field and a faceted query on the <i>tags</i> field: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"wildcard"</span></span>: { <span class="hljs-string"><span class="hljs-string">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Android*"</span></span> } }, <span class="hljs-string"><span class="hljs-string">"facets"</span></span>: { <span class="hljs-string"><span class="hljs-string">"tags"</span></span>: { <span class="hljs-string"><span class="hljs-string">"terms"</span></span>: { <span class="hljs-string"><span class="hljs-string">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"tags"</span></span> } } } }</code> </pre><br><br>  In response, we get: <br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"facets"</span></span>: { <span class="hljs-string"><span class="hljs-string">"tags"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"terms"</span></span>, <span class="hljs-string"><span class="hljs-string">"missing"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"total"</span></span>: <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-string"><span class="hljs-string">"other"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"terms"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"term"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> }, { <span class="hljs-string"><span class="hljs-string">"term"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> }, { <span class="hljs-string"><span class="hljs-string">"term"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> }, { <span class="hljs-string"><span class="hljs-string">"term"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> } ] } }</code> </pre><br><br>  Well, for comparison, the same thing, but if we are looking for posts about the <b>iPhone</b> : <br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"facets"</span></span>: { <span class="hljs-string"><span class="hljs-string">"tags"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"terms"</span></span>, <span class="hljs-string"><span class="hljs-string">"missing"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"total"</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-string"><span class="hljs-string">"other"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"terms"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"term"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> }, { <span class="hljs-string"><span class="hljs-string">"term"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> }, { <span class="hljs-string"><span class="hljs-string">"term"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> }, { <span class="hljs-string"><span class="hljs-string">"term"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> } ] } }</code> </pre><br><br>  As can be seen from analysts, iPhones more often explode, and androids are updated. <br><br>  <b>Histogram of the distribution of posts about the iPhone by year</b> <br>  Another example in which we consider how the interest in iPhones has changed over time.  <i>IPhone</i> request, <i>postDate facets</i> : <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"wildcard"</span></span>: { <span class="hljs-string"><span class="hljs-string">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"iPhone"</span></span> } }, <span class="hljs-string"><span class="hljs-string">"facets"</span></span>: { <span class="hljs-string"><span class="hljs-string">"articles_over_time"</span></span>: { <span class="hljs-string"><span class="hljs-string">"date_histogram"</span></span>: { <span class="hljs-string"><span class="hljs-string">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"postDate"</span></span>, <span class="hljs-string"><span class="hljs-string">"interval"</span></span>: <span class="hljs-string"><span class="hljs-string">"year"</span></span> } } } }</code> </pre><br><br>  Answer: <br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"facets"</span></span>: { <span class="hljs-string"><span class="hljs-string">"articles_over_time"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"date_histogram"</span></span>, <span class="hljs-string"><span class="hljs-string">"entries"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"time"</span></span>: <span class="hljs-number"><span class="hljs-number">1293840000000</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }, { <span class="hljs-string"><span class="hljs-string">"time"</span></span>: <span class="hljs-number"><span class="hljs-number">1325376000000</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> }, { <span class="hljs-string"><span class="hljs-string">"time"</span></span>: <span class="hljs-number"><span class="hljs-number">1356998400000</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }, { <span class="hljs-string"><span class="hljs-string">"time"</span></span>: <span class="hljs-number"><span class="hljs-number">1388534400000</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> } ] } }</code> </pre><br><br>  As you can see, a surge of interest occurred in 2012 (in response to the timestamps). <br><br>  It‚Äôs pretty clear how this works.  Main types of <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-facets.html">facets in ElasticSearch</a> <br><ul><li>  <b>term</b> is convenient in the fields of the tags type.  Not very recommended to build a term-facet in terms of "War and Peace" </li><li>  <b>range</b> ‚Äî facets by range of numeric fields and date.  You can make a facet: <i>count me all the products with a price from 0 to 100 and from 100 to 200</i> </li><li>  <b>histogram</b> is the same range-requests, only ranges are set automatically, the split step is indicated.  Works on numeric fields and date.  Do not make a histogram in increments of 1 millisecond for 100 years </li></ul><br>  Combining facets and full-text queries, you can get many different samples. <br><br><h4>  Analytics in ES 1.0 - new school! </h4><br>  As you noticed, facets in ES to version 1.0 just returned the number of documents.  Requests were rather flat (no nesting).  But what if we want to get posts about the iPhone over the years, and then calculate the average rating of these posts? <br>  In ES 1.0, this became possible thanks to the Aggregation framework. <br><br>  There are two types of aggergation: <br>  <b>Bucket</b> - which count the number of documents found, as well as add the id of the found documents into the ‚Äúbasket‚Äù.  For example, the above facet requests like term, range, histogram are Bucket-aggregates.  Now they do not just count the number of documents, for example, by terms in the tag field, but also give out lists of these documents: 7 documents with the ‚Äúbug‚Äù tag, these documents id 2,5,6,10,17,19,20 <br>  <b>Calc</b> - which count only a number.  For example, the average value of a numerical field, minima, maxima, sums. <br><br>  Bucket-units knowingly return the id of the found documents.  The fact is that now you can build a chain of aggregates.  For example, the first unit we break all the documents by year, then we find the distribution of tags by year. <br><br>  In order not to beat around the bush, back to our test data.  Let's find the most boring tag posts about iPhone broken down by year.  In other words, we‚Äôll find all the articles about Iphone, split the sample by years, and see which tags are in the articles with the lowest rating.  Then we forbid authors to write articles on this topic.  Request such: <br><ul><li>  We limit the selection of posts that contain the iPhone in the title </li><li>  we make histogram-bucklet-facets by year </li><li>  using the received ‚Äúbaskets‚Äù, we make term-bucklet-facets by tags. </li><li>  on the received "baskets" (with tags) we do Average-aggregation by rating </li><li>  Since we need only the most boring tags, we will sort them by the value obtained in the nested aggregation (average rating). </li></ul><br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"wildcard"</span></span>: { <span class="hljs-string"><span class="hljs-string">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"iphone"</span></span> } }, <span class="hljs-string"><span class="hljs-string">"aggs"</span></span>: { <span class="hljs-string"><span class="hljs-string">"post_over_time_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"date_histogram"</span></span>: { <span class="hljs-string"><span class="hljs-string">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"postDate"</span></span>, <span class="hljs-string"><span class="hljs-string">"interval"</span></span>: <span class="hljs-string"><span class="hljs-string">"year"</span></span> }, <span class="hljs-string"><span class="hljs-string">"aggs"</span></span>: { <span class="hljs-string"><span class="hljs-string">"tags_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"terms"</span></span>: { <span class="hljs-string"><span class="hljs-string">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"tags"</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"order"</span></span>: { <span class="hljs-string"><span class="hljs-string">"avg_rating_agg"</span></span>: <span class="hljs-string"><span class="hljs-string">"asc"</span></span> } }, <span class="hljs-string"><span class="hljs-string">"aggs"</span></span>: { <span class="hljs-string"><span class="hljs-string">"avg_rating_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"avg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"rank"</span></span> } } } } } } } }</code> </pre><br><br>  Answer: <br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"aggregations"</span></span>: { <span class="hljs-string"><span class="hljs-string">"post_over_time_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"buckets"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"key"</span></span>: <span class="hljs-number"><span class="hljs-number">1293840000000</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_count"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"tags_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"buckets"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_count"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"avg_rating_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">14.0</span></span> } } ] } }, { <span class="hljs-string"><span class="hljs-string">"key"</span></span>: <span class="hljs-number"><span class="hljs-number">1325376000000</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_count"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"tags_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"buckets"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_count"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"avg_rating_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">34.0</span></span> } } ] } }, { <span class="hljs-string"><span class="hljs-string">"key"</span></span>: <span class="hljs-number"><span class="hljs-number">1356998400000</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_count"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"tags_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"buckets"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_count"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"avg_rating_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">41.0</span></span> } } ] } }, { <span class="hljs-string"><span class="hljs-string">"key"</span></span>: <span class="hljs-number"><span class="hljs-number">1388534400000</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_count"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"tags_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"buckets"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_count"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"avg_rating_agg"</span></span>: { <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">23.0</span></span> } } ] } } ] } }</code> </pre><br><br>  As you can see, in 2011 and 2012, people got posts about iPhone explosions, in 2013 about new applications, and in 2014 about bugs. <br><br><h4>  To real problems </h4><br>  The standard task of an online store is to calculate the effectiveness of an advertising campaign or analyze the behavior of a group of users.  Imagine that you push all the logs of your http-server in ElasticSearch, while adding to the document some more of your data that you have stored, for example, in Bitrix <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://myshop.com/purchase/confirmed"</span></span>, <span class="hljs-string"><span class="hljs-string">"date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2014-02-15T11:12:12"</span></span>, <span class="hljs-string"><span class="hljs-string">"agent"</span></span>: <span class="hljs-string"><span class="hljs-string">"Chrome/32.0.1667.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"geo"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"utm_source"</span></span>: <span class="hljs-string"><span class="hljs-string">"super_banner"</span></span>, <span class="hljs-string"><span class="hljs-string">"userRegisterDate"</span></span>: <span class="hljs-string"><span class="hljs-string">"2011-02-15T11:12:12"</span></span>, <span class="hljs-string"><span class="hljs-string">"orderPrice"</span></span>: <span class="hljs-number"><span class="hljs-number">4000</span></span>, <span class="hljs-string"><span class="hljs-string">"orderCategory"</span></span>: [<span class="hljs-string"><span class="hljs-string">" "</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>] }</code> </pre><br>  At the same time the scheme of the document is not fixed.  There is an order on this page - they added an <i>orderPrice</i> , no - they did not. <br>  With just such logs, you can already have a lot of things that Google Anallytics can do. <br><br>  <b>Example 1:</b> To make a cohort analysis, for example, split users by registration date and see how many orders were made by them 2 months after registration, calculate the average amount of the order.  Here is how a logical query to ElasticSearch looks like: <br><ul><li>  make a text request by url of the word "purchase / confirmed" </li><li>  we make date_histogram-facets by the date of user registration </li><li>  we make the date_range-facet with the initial value of the range ‚Äúuser registration date‚Äù (it can be accessed in the request) and end + 2 months </li><li>  we do count and average across the field orderPrice in the received bucklet </li></ul><br><br>  <b>Example 2:</b> Track goals and conversions by channel by date.  For example, the goal is to visit the URL <i>/ purchase / confirmed</i> <br>  Request: <br><ul><li>  make a text request by url of the word "purchase / confirmed" </li><li>  we make the date_histogram facet by the date of the urla visit, broken down into 1 day </li><li>  make term-facet by utm_source </li><li>  do count aggregation </li></ul><br><br><h4>  findings </h4><br>  The combination of full-text search and chains of aggregations (facets), flexible document layout, automatic scalability and ease of setup and launch make ElasticSearch a serious player in the market for analytical systems. <br><br>  I also add that the threshold of entry is very low.  Installation in 5 minutes, then you can play even with curl, even though a plugin for Chrome that can generate http requests.  We have <a href="http://indexisto.com/">http://indexisto.com/</a> now a cluster of 7 cars shows itself surprisingly stable. <br><br>  All possibilities of aggregation are described here <a href="https://github.com/elasticsearch/elasticsearch/issues/3300">https://github.com/elasticsearch/elasticsearch/issues/3300</a> </div><p>Source: <a href="https://habr.com/ru/post/213849/">https://habr.com/ru/post/213849/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213831/index.html">Google has released a map of the world's forests: Global Forest Watch</a></li>
<li><a href="../213837/index.html">Yota Devices introduced the second generation smartphone with two screens YotaPhone</a></li>
<li><a href="../213841/index.html">Teaching children to type programming vimtutor</a></li>
<li><a href="../213845/index.html">GSM on the table</a></li>
<li><a href="../213847/index.html">Knockout-popover: A Simple Binding of Twitter Bootstrap Popover for KnockoutJS</a></li>
<li><a href="../213851/index.html">Stephen Elop to head Microsoft gaming division</a></li>
<li><a href="../213859/index.html">Management tools: A set of furniture keys or how to come up with constructive arguments</a></li>
<li><a href="../213861/index.html">Review of the first tablet Nokia Lumia 2520</a></li>
<li><a href="../213863/index.html">C ++ 11 standard implementation implementation bugs in Visual Studio 2012 that were fixed in Visual Studio 2013</a></li>
<li><a href="../213865/index.html">The new version of the mobile application Payoneer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>