<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Database Migrations - Library Overview and Usage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you could already read , a new version of CodeIgniter was recently released, one of the innovations of which is the Migration library. Phil Sturgeo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Database Migrations - Library Overview and Usage</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage1/f210e578/ec8ab284/6e045f57/d99800cd.png">  As you could already <a href="http://habrahabr.ru/blogs/codeigniter/133125/">read</a> , a new version of CodeIgniter was recently released, one of the innovations of which is the <a href="http://codeigniter.com/user_guide/libraries/migration.html">Migration</a> library.  <a href="http://philsturgeon.co.uk/">Phil Sturgeon</a> , one of its main developers, was so inspired by the convenience of database version management <a href="http://guides.rubyonrails.org/migrations.html">for Rails</a> that he decided to create an analogue of such a method for CodeIgniter, and finally you can see this library in the official distribution. <br>  From this article you will get a general idea of ‚Äã‚Äãmigrations, as well as learn how to create them.  <a href="http://habrahabr.ru/blogs/codeigniter/133395/">In the second part</a> , we will see how easily they can be integrated into your application. <br>  <i>This article will be useful for novice users of CodeIgniter, but I hope that more advanced colleagues will learn about this wonderful library and learn something new for themselves.</i> <br><br>  Among other things, this library is not difficult at all, and it will not be difficult to implement it if you wish for any other platform! <br><br><a name="habracut"></a><br><h4>  Library Overview </h4><br>  The <b><a href="http://codeigniter.com/user_guide/libraries/migration.html">Migration</a></b> library allows us to store all changes to the database in the application, and roll them in or out if necessary.  It can be convenient for developing in a team - it is not necessary to explain to your colleague what needs to be changed in the database in order for your code to work, and when uploading new versions of the site to the combat server.  Well, or at worst, you can always quickly roll back to the old version, if you screwed up somewhere. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To understand in general how the library works, <b>consider the following primitive scenario:</b> <br>  <b>0.</b> Suppose we have a <i>version 0 of the application</i> with a <i>starting base (also version 0)</i> . <br>  <b>1.</b> In the course of development, we understand that in order to implement a new functional (for example, a newsletter subscription system), we will need to make changes not only in the application code, but also in the database structure. <br>  <b>2.</b> <i>To do this, we will specify in the config that the database version for this version of the code will be 1 and together with the new code we will create the migration 001</i> , specifying actions for it to upgrade and for the database downgrade (in case you need to roll back the version of the application ). <br>  <b>3.</b> Then we implement some kind of update roll-in mechanism - it could be a page in the admin panel, a solution using the CLI, or even a fully automatic update when unloading from the version control system. <br>  <b>4.</b> Upload the new project code to the site, start the migration to the required version, and voila! <br><br>  Now imagine that you need to update the application through 3 versions in advance, or on the test server to see how the version made a couple of months ago was implemented?  Easily, just by changing the code, migrate to the desired version of the database (migration will happen gradually, say from the 4th to the 1st, first the 3rd and 2nd will roll, and then the 1st version)! <br><br>  Are you inspired by this opportunity like me and want to try?  Nothing is easier! <br><br><h4>  Practical use </h4><br>  As a matter of fact, the library is completely easy to use, and to introduce it into a project you need to add / correct quite a few lines of code. <br>  The whole process of creating migrations will not take ten minutes of time, but will save you and your colleagues working on the same project decently. <br><br><h5>  Create class MY_Migration </h5><br>  So, for a start, we will need to <s>finish the</s> <i>Migration</i> class a little <s>with a file</s> . <br>  What for?  Everything is very simple, by default this class cannot report which versions of the database and code are current, and it is not entirely correct to implement these checks on the entire code, it is better to do it in one place. <br>  To do this, we will use the standard class extension technique used in CodeIgniter - we will create the <i>% site_path% / application / libraries / MY_Migration.php file</i> with a couple dozen lines of code inside. <br>  This class will add 2 more public methods to the implementation of the ancestor: <br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Wrapper function for the protected _get_version. * Get's the database current version * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@access</span></span></span><span class="hljs-comment"> public * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> integer Current DB Migration version */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_db_version</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::_get_version(); } <span class="hljs-comment"><span class="hljs-comment">/** * Retrieves current file system version * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@access</span></span></span><span class="hljs-comment"> public * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> integer Current file system Migration version */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_fs_version</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_migration_version; }</code> </pre> <br>  <i>Note: hereinafter abbreviated code listings can be given, a link to all the files used in the tutorial <a href="https://habr.com/ru/post/133312/">at the end of the article.</a></i> <br><br>  As you can see, the functions are only wrappers for the <i>protected</i> method to get the database version and, again, the <i>protected</i> properties of <b>$ _migration_version</b> , and quite clearly demonstrate the use of <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D0%25BA%25D0%25B0%25D0%25BF%25D1%2581%25D1%2583%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D1%258F_%2528%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5%2529">encapsulation</a> . <br>  <b>I also advise you to pay attention to an important point:</b> in the original <i>Migration</i> class there is a restriction, due to which <i>its constructor is executed only when the parent class is initialized.</i> <br>  Therefore, in order for the application to work correctly, automatically initializing <i>MY_Migration</i> instead of the original, you need to duplicate the parent class constructor by changing the condition on it to 41 lines: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($config = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment"># Only run this constructor on main library load if (get_parent_class($this) !== FALSE) { return; } ### Other code here... }</span></span></code> </pre><br>  on <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($config = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment"># Only run this constructor on main library load if (get_parent_class($this) !== FALSE &amp;&amp; get_class($this)!='MY_Migration') { return; } ### Other code here... }</span></span></code> </pre><br><br><h5>  Create a migration </h5><br>  Expanding the base class, the case remains small.  In order for the library to roll or roll back changes to the database, you need to create a migration file that contains the descendant class <i>Migration</i> (in our case <i>MY_Migration</i> ). <br>  Since this is our first migration, we will create the following file: <i>% site_path% / application / migrations / 001_add_messages.php</i> , containing up and down functions: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> defined(<span class="hljs-string"><span class="hljs-string">'BASEPATH'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-string"><span class="hljs-string">'No direct script access allowed'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migration_Add_messages</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MY_Migration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db-&gt;query(<span class="hljs-string"><span class="hljs-string">" CREATE TABLE IF NOT EXISTS `email_list` ( `list_id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT, `email` VARCHAR(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL ) ENGINE=MyISAM;"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db-&gt;query(<span class="hljs-string"><span class="hljs-string">"DROP TABLE IF EXISTS `email_list`"</span></span>); } }</code> </pre><br>  Please note that the files with migrations contain at the beginning of the 3-digit numeric sequence number of the version to which they transfer the database, and the class contained in them is called as the file name, where instead of the version number is <i>Migration_</i> . <br><br><h5>  Rule config </h5><br>  Finally, to work with migrations, you need to tweak the config in the <i>% site_path% / application / config / migration.php</i> file and enable them, see if the path and version of the database required for our code to work correctly (standard comments are cut out of listing): <br><pre> <code class="php hljs"> $config[<span class="hljs-string"><span class="hljs-string">'migration_enabled'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>; $config[<span class="hljs-string"><span class="hljs-string">'migration_version'</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; $config[<span class="hljs-string"><span class="hljs-string">'migration_path'</span></span>] = APPPATH . <span class="hljs-string"><span class="hljs-string">'migrations/'</span></span>;</code> </pre><br>  Please note that I indicated the 1st version, which implies that we have already done the mailing list functionality. <br><br><a name="ending"></a><br><h4>  Total </h4><br>  Thus, we have slightly increased the usability of the library, expanding its functionality, bypassed the pitfall associated with checking in the constructor for the inheritance of the original class, and also learned how to create migrations. <br>  As you can see, there is nothing difficult in creating migrations, and, again, they can save you a significant amount of time.  Moreover, their implementation in the current project should not cause any difficulties.  By the way, just my introduction will be devoted to my second article, which will appear in the very near future. <br><br>  <a href="">Download full source archive</a> <br><br>  <a href="http://habrahabr.ru/blogs/codeigniter/133395/">The second part: Database migration - integration with your application</a> <br><br>  <b>PS:</b> <s>There is not enough karma to publish to the CodeIgniter blog, so for now I‚Äôm publishing a general php blog</s> <br>  <b>UPD:</b> Kind anonymous poured a little karma, transferred to the blog CodeIgniter </div><p>Source: <a href="https://habr.com/ru/post/133312/">https://habr.com/ru/post/133312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133306/index.html">Another open source analogue of Github</a></li>
<li><a href="../133307/index.html">Styling applications part one</a></li>
<li><a href="../133308/index.html">Small devices with big problems</a></li>
<li><a href="../133309/index.html">Habrarebest in Kiev</a></li>
<li><a href="../133311/index.html">Planning poker in their own colors</a></li>
<li><a href="../133314/index.html">Thoughts after visiting a venture fair</a></li>
<li><a href="../133315/index.html">Automatic start of unit tests for C</a></li>
<li><a href="../133316/index.html">Training course. Creating the Entity Framework data model for an ASP.NET MVC application</a></li>
<li><a href="../133317/index.html">Conscience is the best controller</a></li>
<li><a href="../133318/index.html">Market packaging startups on their own experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>