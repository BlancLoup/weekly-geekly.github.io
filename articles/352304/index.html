<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Do-it-yourself Property Injection (Xamarin / .Net)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will look at how Property Injection differs from Constructor Injection and will implement the first one in addition to the last on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Do-it-yourself Property Injection (Xamarin / .Net)</h1><div class="post__text post__text-html js-mediator-article">  In this article we will look at how Property Injection differs from Constructor Injection and will implement the first one in addition to the last on the basis of a small DI container in the source code. <br><br>  This is an entry level tutorial.  It will be useful to those who are not familiar with DI-containers or are interested in how it is arranged from the inside. <br><a name="habracut"></a><br><h2>  What is it and where is it used </h2><br>  Dependency injection (Injection) - a common design pattern used to create programs with weak connectivity components.  Newbies usually meet him on projects where unit tests are applied. <br><br>  A classic example of a rigidly connected system is when the hotel is tightly connected to the hairdryer with the power supply (the owners are worried about the safety of the device).  The length of the wire is generally sufficient, but with this approach it is impossible to modify the hair dryer separately from the wall, and the wall separately from the hair dryer.  The introduction of loose coupling in the form of a socket and a plug solves this problem. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Another example is the rigid binding of employees to the workplace, and also the need to go to work every day.  This rigid connectedness in modern companies is increasingly weakened both by the opportunity to work from home and by the introduction of the practice of the absence of a permanent workplace: if you want to come to the office - do not forget to forget the place.  From the point of view of the employer, the work will be done regardless of the location of the employee.  There are, of course, additional risks, but such is the price of greater flexibility. <br><br>  The idea of ‚Äã‚Äãintroducing dependencies in the narrow sense is that the class-consumer of a certain functionality refers to the provider class not directly, by creating its instance, but indirectly, by reference to a certain interface type.  The provider class is only required to comply with the specified interface. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a19/acc/ec1/a19accec1767fbd7bb221f0860f8c37a.png" alt="image"><br><br>  Unlike the service locator, here the classes not only know nothing about each other, but also do not contain an appeal to the intermediary class (service locator). <br><br>  In order to associate an interface with a specific class (or class instance), a so-called DI container is often used, in which the interface and implementation relationships are registered in advance.  For languages ‚Äã‚Äãthat do not support reflections, that is, they do not allow to operate with type properties, you can limit yourself to such a template as composition root (consideration of this template is beyond the scope of this article). <br><br>  This approach provides flexibility: you can always use another one, depending on the circumstances, instead of one interface implementation. <br><br>  The natural way to pass references to a class-consumer is to specify them in the parameters of its constructor.  As a rule, when requesting the desired interface, the DI-container automatically runs through the list of parameters and recursively satisfies all dependencies. <br><br>  Another way is to pass references through properties, which is called Property Injection.  To satisfy the links, the DI-container goes over the list of properties and assigns the necessary links to those that match certain criteria. <br><br>  There is a more rare way - Method Injection, where links are passed through a special method (for example, Init () with a list of dependencies as parameters).  This approach is similar to constructor injection, but it works after the creation of an object instance.  This term also means something completely different, namely, the simple transfer of dependencies as parameters to an arbitrary method. <br><br><h2>  Is this a regular bike </h2><br>  There are many DI containers (for example, Unity, NInject, Autofac, Spring, Castle Windsor, TinyIoc, MvvmCross).  Most of them support Property Injection. <br><br>  But sometimes there are situations when, for one reason or another, a third-party DI container does not suit you, and you have to write your own. <br><br>  For example, corporate policies prohibit the use of third-party libraries.  Or the libraries you need do not exist in nature.  Or these libraries do not satisfy project requirements. <br><br>  In this case, it is not difficult to make your own container - unless, of course, it is technically possible within the framework of the applied development technology, as is possible in .Net. <br><br><h2>  Why not satisfied with constructor injection </h2><br>  The introduction of dependencies through the parameters of the constructor requires the creation of service variables in the user class in which the references from the constructor parameters are saved.  This is a routine operation that, in an amicable way, could somehow be automated.  But as long as there is no such automation, the programmer has to do this work.  Each new dependency is added first to the constructor parameters, then to the service variables, then a line of assignment of one to another is added to the constructor. <br><br>  It is often possible to observe how any of the added parameters are pulled through the code, from the top-level class to the end user down the inheritance hierarchy.  The chain of calls stretches like a bunch of sausages, from the constructor to the constructor.  Not only that the serial transmission of these parameters by itself clutters the code.  So also the addition of the next parameter to the end of this chain of calls requires its modification throughout.  Which is quite uncomfortable.  As a result, a class can solidly "swell up" only because of all this machinery, even before it starts doing anything. <br><br>  Why not save the programmer from this routine work and not delegate the creation of entities to a DI container? <br><br>  It can also be noted that when passing parameters to the constructor, they are usually passed without specifying the parameter name.  That is, the class user is forced to rely either on the sequence number of the parameter, or explicitly indicate the name of the parameter, which will clutter the code even more. <br><br>  There is a good rule that if it becomes inconvenient for you to add another dependency to the parameters of the designer, it means that there are really too many of them, and you should reconsider the design.  Usually it is 5 pieces - the natural limit of objects that a person without training can hold in the area of ‚Äã‚Äãhis attention. <br><br>  We, however, believe that the key word in this rule is inconvenient.  I would like to avoid it. <br><br><h2>  Own DI container </h2><br>  The implementation of the simplest DI container is not difficult to find in the source code.  The author once used a small example from Xamarin University (see <a href="">here</a> ). <br><br>  There is a lot lacking in comparison with industrial DI-containers (singletones, domains, etc.), but this is beyond the scope of this article. <br><br>  The container allows you to register the relationship between the interface and the implementation (the Register method in different versions, which simply adds an element to the Dictionary), to then, in the Resolve method, create an instance of the class that corresponds to the requested interface and do the same parameters of its constructor. <br><br>  This container is based on Reflections and the Activator.CreateInstance () method.  The latter method is used to create an instance of a class by its type, and reflections allow you to read type properties. <br><br>  To implement property injection, we add a special attribute that will mark the properties that the container should treat as dependencies. <br><br>  Name the attribute ‚ÄúResolveAttribute‚Äù.  To do this, you must create a descendant class of System.Attribute (see Appendix A). <br><br>  Add attribute processing in the container's Resolve method. <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Resolve</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; ... <span class="hljs-comment"><span class="hljs-comment">//Inject [Resolve] marked properties var props = targetType.GetRuntimeProperties() .Where(x =&gt; x.CanWrite &amp;&amp; x.IsDefined(typeof(ResolveAttribute))); foreach (var item in props) { item.SetValue(result, Resolve(item.PropertyType)); } return result; }</span></span></code> </pre> <br>  This is all that needs to be done in the source container in order for dependencies to be implemented through properties (see Appendix B for the source code). <br><br><h2>  Usage example </h2><br>  Suppose there is a class in which dependency injection is used through a constructor (of course, dependencies must be registered in advance - see Appendix C).  Note that the parameters and the body of the constructor are a purely serving code: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MediaRecorder</span></span> : <span class="hljs-title"><span class="hljs-title">IMediaRecorder</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IMediaPlayer player; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IRestServiceClient restClient; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ILog log; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IFileService fileService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ISettingsProvider settingsProvider; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MediaRecorder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IMediaPlayer player, IRestServiceClient restClient, ILog log, IFileService fileService, ISettingsProvider settingsProvider</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.player = player; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.restClient = restClient; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.log = log; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileService = fileService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.settingsProvider = settingsProvider; } }</code> </pre> <br>  We modify the class using property injection: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MediaRecorder</span></span> : <span class="hljs-title"><span class="hljs-title">IMediaRecorder</span></span> { [Resolve] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IMediaPlayer Player { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Resolve] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IRestServiceClient RestClient { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Resolve] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ILog Log { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Resolve] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IFileService FileService { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Resolve] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ISettingsProvider SettingsProvider { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MediaRecorder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } }</code> </pre><br>  As you can see, the amount of service code has decreased, and the code itself has become more readable. <br><br>  The downside of success is a reduction in the ability to control the integrity of the program from the compiler.  However, this is a common consequence for all types of IoC implementations. <br><br>  It should also be borne in mind that it is considered normal practice to use constructor injection for mandatory dependencies, and property injection for optional.  That is why the properties in our example have the access modifier ‚Äúpublic‚Äù. <br><br>  Public access to dependencies makes it possible to substitute their values ‚Äã‚Äãfrom the outside, which, on the one hand, serves as a tool for implementing dependencies manually, and on the other, it allows inadvertently damage the work of the whole class if it is not written reliably. <br><br>  The code in our implementation does not check the access level of the property, that is, you can use both ‚Äúpublic‚Äù and ‚Äúprivate‚Äù.  The latter is recommended for those properties, the arbitrary modification of which is undesirable.  This will protect the class from unintended misuse and, at the same time, allow the use of property injection. <br><br><h2>  Performance </h2><br>  As you can see from our implementation, to support Property Injection, you need to run through all the properties of the class using reflections.  It may turn out that there are quite a few properties - in practice, there are more than a thousand, which slows down the work of the program. <br><br>  For this reason, this approach is not very suitable for classes with a large number of properties.  Here optimization is possible both from the side of the user code, and from the side of the container itself. <br><br>  For example, it would be possible to reduce the list of properties by placing in the service class those of them that are not labeled ‚ÄúResolveAttribute‚Äù (in our implementation), to think about deferred reading (lazy loading).  And the container could cache the list of properties for implementation.  But we will talk about this some other time. <br><br>  At the same time, Moore's law is still working, and the computing power of computers is growing.  This allows us to use more and more complex algorithms. <br><br>  In conclusion, we note that different DI containers have different performance, and this difference may be significant (see a <a href="http://xamarinhelp.com/ioc-container-performance/">small study</a> ). <br><br><div class="spoiler">  <b class="spoiler_title">Appendix A</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Bricks</span></span> { [AttributeUsage(AttributeTargets.All)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ResolveAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Appendix B</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Bricks</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> This is a very simple example of a DI/IoC container. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public sealed class DependencyContainer : IDependencyContainer { readonly Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, Func&lt;object&gt;</span></span></span><span class="hljs-comment">&gt; registeredCreators = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, Func&lt;object&gt;</span></span></span><span class="hljs-comment">&gt;(); readonly Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, Func&lt;object&gt;</span></span></span><span class="hljs-comment">&gt; registeredSingletonCreators = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, Func&lt;object&gt;</span></span></span><span class="hljs-comment">&gt;(); readonly Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, object&gt;</span></span></span><span class="hljs-comment"> registeredSingletons = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, object&gt;</span></span></span><span class="hljs-comment">(); object locker = new object(); </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Register a type with the container. This is only necessary if the </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> type has a non-default constructor or needs to be customized in some fashion. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TAbstraction"&gt;</span></span></span><span class="hljs-comment">Abstraction type</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TImpl"&gt;</span></span></span><span class="hljs-comment">Type to create</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public void Register</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TAbstraction, TImpl&gt;</span></span></span><span class="hljs-comment">() where TImpl : new() { registeredCreators.Add(typeof(TAbstraction), () =&gt; new TImpl()); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Register a type with the container. This is only necessary if the </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> type has a non-default constructor or needs to be customized in some fashion. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="creator"&gt;</span></span></span><span class="hljs-comment">Function to create the given type.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-comment">Type to create</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public void Register</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(Func</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment"> creator) { registeredCreators.Add(typeof(T), creator); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Register a type with the container. This is only necessary if the </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> type has a non-default constructor or needs to be customized in some fashion. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TAbstraction"&gt;</span></span></span><span class="hljs-comment">Abstraction type</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam&gt;</span></span></span><span class="hljs-comment"> public void RegisterInstance</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TAbstraction&gt;</span></span></span><span class="hljs-comment">(object instance) { registeredCreators.Add(typeof(TAbstraction), () =&gt; instance); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Creates a factory for a type so it may be created through </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> the container without taking a dependency on the container directly. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">Creator function</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-comment">The 1st type parameter.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public Func</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> FactoryFor</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">() { return () =&gt; Resolve</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Creates the given type, either through a registered function </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> or through the default constructor. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-comment">Type to create</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public T Resolve</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">() { return (T)Resolve(typeof(T)); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Creates the given type, either through a registered function </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> or through the default constructor. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="type"&gt;</span></span></span><span class="hljs-comment">Type to create</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public object Resolve(Type type) { object result = null; var targetType = type; TypeInfo typeInfo = type.GetTypeInfo(); if (registeredSingletonCreators.TryGetValue(type, out Func</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment"> creator)) { lock (locker) { if (registeredSingletons.ContainsKey(type)) { result = registeredSingletons[type]; } else { result = registeredSingletonCreators[type](); registeredSingletons.Add(type, result); } } if (result != null) { targetType = result.GetType(); } } else if (registeredCreators.TryGetValue(type, out creator)) { result = registeredCreators[type](); if (result != null) { targetType = result.GetType(); } } else { var ctors = typeInfo.DeclaredConstructors.Where(c =&gt; c.IsPublic).ToArray(); var ctor = ctors.FirstOrDefault(c =&gt; c.GetParameters().Length == 0); if (ctor != null || ctors.Count() == 0) { result = Activator.CreateInstance(type); } else { // Pick the first constructor found and create any parameters. ctor = ctors[0]; var parameters = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment">(); foreach (var p in ctor.GetParameters()) { parameters.Add(Resolve(p.ParameterType)); } result = Activator.CreateInstance(type, parameters.ToArray()); } } //Create [Resolve] marked property var props = targetType.GetRuntimeProperties() .Where(x =&gt; x.CanWrite &amp;&amp; x.IsDefined(typeof(ResolveAttribute))); foreach (var item in props) { item.SetValue(result, Resolve(item.PropertyType)); } return result; } public void Clear() { registeredCreators.Clear(); registeredSingletonCreators.Clear(); registeredSingletons.Clear(); } public void RegisterSingleton(Type tInterface, object service) { RegisterSingleton(tInterface, () =&gt; service); } public void RegisterSingleton</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TAbstraction&gt;</span></span></span><span class="hljs-comment">(TAbstraction service) where TAbstraction : class { registeredSingletonCreators.Add(typeof(TAbstraction), () =&gt; service); } public void RegisterSingleton</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TAbstraction, TImpl&gt;</span></span></span><span class="hljs-comment">() where TAbstraction : class where TImpl : new() { registeredSingletonCreators.Add(typeof(TAbstraction), () =&gt; new TImpl()); } public void RegisterSingleton(Type tInterface, Func</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment"> serviceConstructor) { registeredSingletonCreators.Add(tInterface, serviceConstructor); } public void RegisterSingleton</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TAbstraction&gt;</span></span></span><span class="hljs-comment">(Func</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TAbstraction&gt;</span></span></span><span class="hljs-comment"> serviceConstructor) where TAbstraction : class { registeredSingletonCreators.Add(typeof(TAbstraction), serviceConstructor); } } }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Appendix C</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Bootstrap</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IDependencyContainer Container = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DependencyContainer(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Container.Clear(); Container.RegisterSingleton&lt;ILog, LogWriter&gt;(); Container.RegisterSingleton&lt;ISettingsProvider&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SettingsProvider()); Container.RegisterSingleton&lt;IFileService&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileService()); Container.RegisterSingleton&lt;IMessagesProvider&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessagesProvider()); Container.Register&lt;IMediaPlayer, MediaPlayerService&gt;(); Container.Register&lt;IRestServiceClient, RestServiceClient&gt;(); Container.Register&lt;IMediaRecorder, MediaRecorder&gt;(); ... } }</code> </pre> </div></div></div><p>Source: <a href="https://habr.com/ru/post/352304/">https://habr.com/ru/post/352304/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352294/index.html">How to create an ideal product roadmap and what is needed for this?</a></li>
<li><a href="../352296/index.html">A simple asynchronous task manager for Unity3D</a></li>
<li><a href="../352298/index.html">From idea to AppStore</a></li>
<li><a href="../352300/index.html">Resolve IP addresses in Linux: a clear and detailed description</a></li>
<li><a href="../352302/index.html">Zuckerberg called. Facebook programmer about his experience of interviewing in the US and the workflow on Facebook</a></li>
<li><a href="../352306/index.html">Four facts about memcached amplification</a></li>
<li><a href="../352308/index.html">Lecture by Andrei Bezrukov on the digital economy, global challenges and what it is like to be a spy</a></li>
<li><a href="../352310/index.html">Development of elevator movement algorithm</a></li>
<li><a href="../352312/index.html">You don't need autotest developers.</a></li>
<li><a href="../352314/index.html">Went out for bread - bought a house: augmented reality as the future of banking</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>