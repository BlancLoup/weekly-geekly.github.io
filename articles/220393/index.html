<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerate PHP (with ReactPHP)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post, I would like to share an unusual, for the PHP world, the way of building an application, if you like, architecture. This approach allows...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerate PHP (with ReactPHP)</h1><div class="post__text post__text-html js-mediator-article">  In this post, I would like to share an unusual, for the PHP world, the way of building an application, if you like, architecture.  This approach allows PHP tools to increase the number of requests processed at times.  I will also share my experience in this direction.  Of course, this approach is not free, in terms of code requirements, but let's do everything in order. <br><a name="habracut"></a><br><br><img src="https://habrastorage.org/getpro/habr/post_images/79e/f94/e24/79ef94e2465e2fde0102b29f03c44f78.png"><br><br>  Yes, in the end we will get a performance increase of 30 times compared to regular PHP and 6 times compared to PHP + OPcache.  But from the beginning, I would like to talk about existing, popular solutions to improve the performance of PHP applications. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  OPcache </h5><br>  Most modern istacats use APC / OPcache and this is considered standard and maximum for PHP.  This approach has the least number of disadvantages, since  This is the native (native) solution offered to us by the PHP command.  All is good, but the speed is not enough. <br><br><h5>  HHVM </h5><br>  HHVM is really good, for popular Linux distros there are already repositories and it remains only to install and configure that, in general, this is not a tricky thing.  But this is a development from the facebook team and at the moment, HHVM severely restricts the choice of extensions, and if you suddenly have your patches for PHP extensions, it completely puts a ‚Äúcross‚Äù on a painless transition from PHP to HHVM.  You can also forget about PHP 5.5.  It is worth noting the excellent work of the facebook team to increase the compatibility of HHVM with the main tools and frameworks, but this figure is still around 97%. <br><br>  Of the options that come to my mind are still raw HippyVM and the framework PhalconPHP.  A lot of reviews have been written about Phalcon and I think it makes no sense to repeat them.  HippyVM is under development, by the way, this is an alternative to HHVM from the facebook team itself, written in python, which in my opinion makes this project even more vague. <br><br>  Other options offer in the comments. <br><br>  The classic PHP installation includes the installation of one of the Nginx, Apache or Lighttpd web servers that process incoming HTTP requests and redirect the dynamic to PHP.  There are several options for connecting PHP to a web server: <br><ul><li>  mod_php (apache) </li><li>  f (ast) cgi </li><li>  php-fpm </li></ul><br>  All PHP acceleration solutions are generally aimed at speeding up a slow PHP interpreter at the time of redirecting a request from a web server to a script, which, as seen in the performance tests, gives its result.  But there is a disadvantage in this solution, whatever one may say, but for every PHP request, the application has to declare classes, create instances, connect to databases, read the cache ‚Äî initialize its environment.  And no matter how we speed up the PHP interpreter, a lot of resources are spent on all initialization and this approach is clearly far from the desired, especially for high-loaded solutions.  Why it happens?  PHP was originally designed as a language of templates and a set of tools, and was not conceived as a standalone web server.  In addition, in PHP there is no parallel execution or even asynchronous as in node.js, and all written extensions are blocking. <br><br>  But PHP does not stand still.  We have our own ecosystem with thousands of tools that can be easily installed thanks to Composer.  PHP borrowed a lot of patterns from languages ‚Äã‚Äãlike Java, JS and others, hello to the symfony team.  There are tools that allow PHP to work asynchronously.  On this topic there is already an <a href="http://habrahabr.ru/post/218751/">article on Habr√©</a> , for this I will not repeat in the description of this approach.  I can only say that the asynchronous approach allows us to create not only a chat on the websocket, but also run a full HTTP server, which means that we will not have to initialize PHP for each request.  Thus, as it is not difficult to guess, such an approach will negate the time spent on launching various frameworks and ultimately improve the response time. <br><br>  This solution, as is clear from the title, is built on ReactPHP.  React itself is more of a creation tool than a turnkey solution.  Although it already has tools for processing incoming Http connections, as well as there are various tools, for example for working with websockets or async redis, but there are no patterns, routing, etc. that are usual for modern MVC frameworks.  For this purpose, we will connect ReactPHP to an existing Symfony2 application. <br><br>  ReactPHP is based on eventloop and to implement this architecture it offers the choice of installing one of the ext-libevent, ext-libev, ext-event.  In case of failure, React works through <a href="http://www.php.net/manual/en/function.stream-select.php">stream_select</a> and the asynchronous capabilities are minimized, since  in fact, everything will be performed in turn without the ability to interrupt the process.  Of course, you can omit this, because  essentially asynchronous, this is a series of tasks within one process.  But if the function will use non-blocking calls, for example to async-redis, then the eventloop based on stream_select will have to wait for the execution of this function, since  There is no possibility to interrupt the php function for the duration of the non-blocking call.  Of course, this can be bypassed by splitting the functional, but I hope the essence of the problem is clear. <br><br>  I am a supporter of native solutions, and the installation of pecl extensions is not very much included there.  In addition, the installation of pecl will be required on the entire server park and there will be problems on the hosting.  But PHP has the ability to implement Corutin using PHP 5.5.  Thanks to the wonderful <a href="http://nikic.github.io/2012/12/22/Cooperative-multitasking-using-coroutines-in-PHP.html">article from nikic</a> ( <a href="http://habrahabr.ru/post/164173/">translation to Habr√©</a> ), I decided to implement my eventloop implementation based on the described nikic task scheduler.  Yes, it doesn‚Äôt sound easy, and if you‚Äôre unaccustomed to it, it really requires a thorough change in the presentation of building applications in PHP.  But in my opinion the future of PHP is behind such solutions. <br><br>  By the way, symfony was not chosen by chance.  Implementing the stack of processing incoming requests Symfony, allows us to easily work without killing PHP after each request.  In the meantime, I finished this post, <a href="https://github.com/symfony/symfony/issues/10810">proposals with a similar implementation are</a> already coming on the Symfony channel.  And the developers themselves do not hide the fact that such a solution has faded in their minds since the start of the launch of version 2. <br><br>  But let's move from words to deeds.  First we need your favorite Linux distribution with installed and configured nginx, php-cli 5.5.x, composer and your symfony application.  If you do not have a Symfony application at hand, you can take a bare installation from the Symfony site, which will be an example.  If you and the composer is not familiar, then in short can be found in <a href="http://habrahabr.ru/post/197666/">my article to Satis</a> . <br><br>  Create a new folder, if the project already exists, then go to it: <br><pre><code class="bash hljs">mkdir fastapp &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> fastapp</code> </pre> <br>  Install the composer: <br><pre> <code class="bash hljs">curl -sS https://getcomposer.org/installer | php</code> </pre><br>  We put symfony2.4.4: <br><pre> <code class="bash hljs">php composer.phar create-project symfony/framework-standard-edition symfdir/ 2.4.4 &amp;&amp; mv symfdir/* ./ &amp;&amp; rm -fr symfdir</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Get</b> <div class="spoiler_text"><pre> <code class="bash hljs">ls -l drwxrwxr-x 6 user user 4.0K Apr 30 11:25 app/ drwxrwxr-x 2 user user 4.0K Apr 30 11:25 bin/ drwxrwxr-x 3 user user 4.0K Mar 14 09:37 src/ drwxrwxr-x 13 user user 4.0K Apr 30 11:25 vendor/ drwxrwxr-x 3 user user 4.0K Apr 30 11:25 web/ -rw-rw-r-- 1 user user 2.0K Mar 14 09:37 composer.json -rw-rw-r-- 1 user user 56K Apr 30 11:25 composer.lock -rwxr-xr-x 1 user user 990K Apr 30 11:23 composer.phar* -rw-rw-r-- 1 user user 1.1K Mar 14 09:37 LICENSE -rw-rw-r-- 1 user user 5.7K Mar 14 09:37 README.md -rw-rw-r-- 1 user user 1.3K Mar 14 09:37 UPGRADE-2.2.md -rw-rw-r-- 1 user user 2.0K Mar 14 09:37 UPGRADE-2.3.md -rw-rw-r-- 1 user user 356 Mar 14 09:37 UPGRADE-2.4.md -rw-rw-r-- 1 user user 8.3K Mar 14 09:37 UPGRADE.md</code> </pre><br></div></div><br>  Add these lines to your composer.json: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"repositories"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"vcs"</span></span>, <span class="hljs-string"><span class="hljs-string">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://github.com/Imunhatep/rephp"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"vcs"</span></span>, <span class="hljs-string"><span class="hljs-string">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://github.com/Imunhatep/php-pm"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"minimum-stability"</span></span>: <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, <span class="hljs-string"><span class="hljs-string">"prefer-stable"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"require"</span></span>: { <span class="hljs-string"><span class="hljs-string">"imunhatep/php-pm"</span></span>: <span class="hljs-string"><span class="hljs-string">"@dev"</span></span> } }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">To look like this</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"symfony/framework-standard-edition"</span></span>, <span class="hljs-string"><span class="hljs-string">"license"</span></span>: <span class="hljs-string"><span class="hljs-string">"MIT"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"project"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"The \"Symfony Standard Edition\" distribution"</span></span>, <span class="hljs-string"><span class="hljs-string">"autoload"</span></span>: { <span class="hljs-string"><span class="hljs-string">"psr-0"</span></span>: { <span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-string"><span class="hljs-string">"src/"</span></span> } }, <span class="hljs-string"><span class="hljs-string">"repositories"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"vcs"</span></span>, <span class="hljs-string"><span class="hljs-string">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://github.com/Imunhatep/rephp"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"vcs"</span></span>, <span class="hljs-string"><span class="hljs-string">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://github.com/Imunhatep/php-pm"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"minimum-stability"</span></span>: <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, <span class="hljs-string"><span class="hljs-string">"prefer-stable"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"require"</span></span>: { <span class="hljs-string"><span class="hljs-string">"php"</span></span>: <span class="hljs-string"><span class="hljs-string">"&gt;=5.5.3"</span></span>, <span class="hljs-string"><span class="hljs-string">"symfony/symfony"</span></span>: <span class="hljs-string"><span class="hljs-string">"~2.4"</span></span>, <span class="hljs-string"><span class="hljs-string">"doctrine/orm"</span></span>: <span class="hljs-string"><span class="hljs-string">"~2.2,&gt;=2.2.3"</span></span>, <span class="hljs-string"><span class="hljs-string">"doctrine/doctrine-bundle"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.2"</span></span>, <span class="hljs-string"><span class="hljs-string">"twig/extensions"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"symfony/assetic-bundle"</span></span>: <span class="hljs-string"><span class="hljs-string">"~2.3"</span></span>, <span class="hljs-string"><span class="hljs-string">"symfony/swiftmailer-bundle"</span></span>: <span class="hljs-string"><span class="hljs-string">"~2.3"</span></span>, <span class="hljs-string"><span class="hljs-string">"symfony/monolog-bundle"</span></span>: <span class="hljs-string"><span class="hljs-string">"~2.4"</span></span>, <span class="hljs-string"><span class="hljs-string">"sensio/distribution-bundle"</span></span>: <span class="hljs-string"><span class="hljs-string">"~2.3"</span></span>, <span class="hljs-string"><span class="hljs-string">"sensio/framework-extra-bundle"</span></span>: <span class="hljs-string"><span class="hljs-string">"~3.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"sensio/generator-bundle"</span></span>: <span class="hljs-string"><span class="hljs-string">"~2.3"</span></span>, <span class="hljs-string"><span class="hljs-string">"incenteev/composer-parameter-handler"</span></span>: <span class="hljs-string"><span class="hljs-string">"~2.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"imunhatep/php-pm"</span></span>: <span class="hljs-string"><span class="hljs-string">"@dev"</span></span> }, <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: { <span class="hljs-string"><span class="hljs-string">"post-install-cmd"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"Incenteev\\ParameterHandler\\ScriptHandler::buildParameters"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sensio\\Bundle\\DistributionBundle\\Composer\\ScriptHandler::buildBootstrap"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sensio\\Bundle\\DistributionBundle\\Composer\\ScriptHandler::clearCache"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sensio\\Bundle\\DistributionBundle\\Composer\\ScriptHandler::installAssets"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sensio\\Bundle\\DistributionBundle\\Composer\\ScriptHandler::installRequirementsFile"</span></span> ], <span class="hljs-string"><span class="hljs-string">"post-update-cmd"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"Incenteev\\ParameterHandler\\ScriptHandler::buildParameters"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sensio\\Bundle\\DistributionBundle\\Composer\\ScriptHandler::buildBootstrap"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sensio\\Bundle\\DistributionBundle\\Composer\\ScriptHandler::clearCache"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sensio\\Bundle\\DistributionBundle\\Composer\\ScriptHandler::installAssets"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sensio\\Bundle\\DistributionBundle\\Composer\\ScriptHandler::installRequirementsFile"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"config"</span></span>: { <span class="hljs-string"><span class="hljs-string">"bin-dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"bin"</span></span> }, <span class="hljs-string"><span class="hljs-string">"extra"</span></span>: { <span class="hljs-string"><span class="hljs-string">"symfony-app-dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"app"</span></span>, <span class="hljs-string"><span class="hljs-string">"symfony-web-dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"web"</span></span>, <span class="hljs-string"><span class="hljs-string">"incenteev-parameters"</span></span>: { <span class="hljs-string"><span class="hljs-string">"file"</span></span>: <span class="hljs-string"><span class="hljs-string">"app/config/parameters.yml"</span></span> }, <span class="hljs-string"><span class="hljs-string">"branch-alias"</span></span>: { <span class="hljs-string"><span class="hljs-string">"dev-master"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.4-dev"</span></span> } } }</code> </pre><br></div></div><br>  We start updating packages: <br><pre> <code class="bash hljs">php composer.phar update</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Get</b> <div class="spoiler_text"><pre> <code class="bash hljs">Loading composer repositories with package information Updating dependencies (including require-dev) - Installing stack/builder (v1.0.1) Loading from cache - Installing react/promise (v2.0.0) Loading from cache - Installing guzzle/parser (v3.9.0) Loading from cache - Installing evenement/evenement (v2.0.0) Loading from cache - Installing react/react (v0.4.1) Loading from cache - Installing imunhatep/rephp (dev-master 13adf26) Cloning 13adf2697681a5954978ac56fe2c8fdf6a21dc4a - Installing imunhatep/php-pm (dev-master 02f44ec) Cloning 02f44ecb41ca5b4c81d4bb6087da7a0ed4964656 react/react suggests installing ext-libevent (Allows <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> use of a more performant event-loop implementation.) react/react suggests installing ext-libev (Allows <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> use of a more performant event-loop implementation.) react/react suggests installing ext-event (Allows <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> use of a more performant event-loop implementation.) Writing lock file Generating <span class="hljs-built_in"><span class="hljs-built_in">autoload</span></span> files Updating the <span class="hljs-string"><span class="hljs-string">"app/config/parameters.yml"</span></span> file Clearing the cache <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the dev environment with debug <span class="hljs-literal"><span class="hljs-literal">true</span></span> Installing assets using the hard copy option Installing assets <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Symfony\Bundle\FrameworkBundle into web/bundles/framework Installing assets <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Acme\DemoBundle into web/bundles/acmedemo Installing assets <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Sensio\Bundle\DistributionBundle into web/bundles/sensiodistribution</code> </pre><br></div></div><br>  Prepare symfony cache: <br><pre> <code class="bash hljs">php app/console cache:warmup --env=dev</code> </pre><br>  And we are launching a web server, while using only PHP and in one instance, test one, so to speak.  The port can be selected to taste: <br><pre> <code class="bash hljs">php bin/ppm start --workers 1 --port 8080</code> </pre><br>  We check that everything works by opening localhost: 8080 in your favorite browser.  A welcome page from symfony should open, though the pictures will not appear and css will not be loaded.  In this way, we received a PHP web server that processes and accepts HTTP requests and is not dying.  But we have only 1 process, there is no processing of statics and there is no balancer.  As many have guessed, for this we need nginx. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5f0/0e4/27d/5f00e427db83543699b005e21b692514.jpg"><br>  We configure nginx for proxying dynamic requests to our PHP server, simultaneously acting as a balancer, and giving statics without PHP participation: <br><pre> <code class="bash hljs">upstream backend { server 127.0.0.1:5501; server 127.0.0.1:5502; server 127.0.0.1:5503; server 127.0.0.1:5504; server 127.0.0.1:5505; server 127.0.0.1:5506; server 127.0.0.1:5507; server 127.0.0.1:5508; } server { root /path/to/symfony/web/; server_name fastapp.com; location / { <span class="hljs-comment"><span class="hljs-comment"># try to serve file directly, fallback to rewrite try_files $uri @rewriteapp; } location @rewriteapp { if (!-f $request_filename) { proxy_pass http://backend; break; } } }</span></span></code> </pre><br>  At the same time server_name (fastapp.com) must be entered into / etc / hosts: <br><pre> <code class="bash hljs">127.0.0.1 fastapp.com</code> </pre><br>  Now so that we don‚Äôt have to suffer with the manual launch of the n-number of processes in our PHP application (represented by nginx conf. Configured for n = 8), go to the folder of our project and execute: <br><pre> <code class="bash hljs">cp vendor/imunhatep/rephp/ppm.json ./</code> </pre><br>  We correct the ./ppm.json file: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"bootstrap"</span></span>: <span class="hljs-string"><span class="hljs-string">"\\PHPPM\\Bootstraps\\Symfony"</span></span>, <span class="hljs-string"><span class="hljs-string">"bridge"</span></span>: <span class="hljs-string"><span class="hljs-string">"HttpKernel"</span></span>, <span class="hljs-string"><span class="hljs-string">"appenv"</span></span>: <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, <span class="hljs-string"><span class="hljs-string">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">5501</span></span> }</code> </pre><br>  Sometimes after the changes it is required to update the cache, perhaps this is only in my case, since  when writing the article made changes in the code: <br><pre> <code class="bash hljs">app/console cache:warmup --env=dev</code> </pre><br>  Restart our PHP Process Manager: <br><pre> <code class="bash hljs">php bin/ppm start</code> </pre><br>  We get in response: <br><pre> <code class="bash hljs">8 slaves (5501, 5502, 5503, 5504, 5505, 5506, 5507, 5508) up and ready.</code> </pre><br>  First, we check the link localhost: 5501 in the browser, if everything is open then we try to open fastapp.com.  Everything should open, with pictures and css. <br><br>  Now you can burn using siege or ab tools to choose from: <br><pre> <code class="bash hljs">siege -qb -t 30S -c 128 http://fastapp.com/</code> </pre><br>  Here are some test results of my (not helloworld) Symfony application, on a developer machine with AMD 8core, 8RAM and Fedora20. <br><h5>  Php 5.5.10, via nginx + php-fpm: </h5><br><pre> <code class="bash hljs">siege -qb -t 30S -c 128 http://login.dev/signup Lifting the server siege... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. Transactions: 983 hits Availability: 100.00 % Elapsed time: 29.03 secs Data transferred: 4.57 MB Response time: 0.91 secs Transaction rate: 34.26 trans/sec Throughput: 0.16 MB/sec Concurrency: 124.23 Successful transactions: 983 Failed transactions: 0 Longest transaction: 1.81 Shortest transaction: 0.42</code> </pre><br><h5>  Php 5.5.10 with OPcache enabled, via nginx + php-fpm: </h5><br><pre> <code class="bash hljs">siege -qb -t 30S -c 128 http://login.dev/signup Lifting the server siege... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. Transactions: 5298 hits Availability: 100.00 % Elapsed time: 29.54 secs Data transferred: 24.15 MB Response time: 0.70 secs Transaction rate: 179.35 trans/sec Throughput: 0.82 MB/sec Concurrency: 126.43 Successful transactions: 5298 Failed transactions: 0 Longest transaction: 1.68 Shortest transaction: 0.07</code> </pre><br><h5>  Php 5.5.10 with OPcache enabled, via nginx + ReactPHP + Coroutine eventloop: </h5><br><pre> <code class="bash hljs">siege -qb -t 30S -c 128 http://fastlogin.dev/signup Lifting the server siege... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. Transactions: 30553 hits Availability: 100.00 % Elapsed time: 29.85 secs Data transferred: 157.63 MB Response time: 0.12 secs Transaction rate: 1023.55 trans/sec Throughput: 5.28 MB/sec Concurrency: 127.43 Successful transactions: 30553 Failed transactions: 0 Longest transaction: 0.76 Shortest transaction: 0.00</code> </pre><br>  We increase the number of parallel requests to 256. <br><h5>  Php 5.5.10 with OPcache enabled, via nginx + php-fpm </h5><br><pre> <code class="bash hljs">siege -qb -t 30S -c 256 http://login.dev/signup siege aborted due to excessive socket failure; Transactions: 134 hits Availability: 10.48 % Elapsed time: 1.58 secs Data transferred: 0.78 MB Response time: 1.21 secs Transaction rate: 84.81 trans/sec Throughput: 0.49 MB/sec Concurrency: 102.93 Successful transactions: 134 Failed transactions: 1145 Longest transaction: 1.56 Shortest transaction: 0.00</code> </pre><br>  Unfortunately, php-fpm has collapsed and refused to work with a limit of 32 processes against 256 parallel requests. <br><h5>  We try Php5.5.10 + ReactPHP + Coroutine eventloop </h5><br><pre> <code class="bash hljs">siege -qb -t 30S -c 256 http://fastlogin.dev/signup Lifting the server siege... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. Transactions: 29154 hits Availability: 100.00 % Elapsed time: 29.16 secs Data transferred: 150.40 MB Response time: 0.25 secs Transaction rate: 999.79 trans/sec Throughput: 5.16 MB/sec Concurrency: 252.70 Successful transactions: 29154 Failed transactions: 0 Longest transaction: 3.66 Shortest transaction: 0.00</code> </pre><br><h4>  Conclusion </h4><br>  The idea of ‚Äã‚Äãrunning a symfony application through ReactPHP is not mine, borrowed from <a href="http://marcjschmidt.de/blog/2014/02/08/php-high-performance.html">Marc from his article</a> , for which he thanks a lot.  By the way, he made his measurements and even compared with HHVM.  Below is a graph from his article: <br><img src="https://habrastorage.org/getpro/habr/post_images/201/65a/9e8/20165a9e8635357c2cf2faab1c3b5bd6.png"><br>  My contribution is to create an eventloop based on the work of nikic and finishing the process manager to, in general, performance, as well as the nuances of launching ReactPHP with a new eventloop.  Perhaps with pecl event lib, it will all work faster, did not check.  Unfortunately, my current projects do not meet the required quality of the code, so the operating time is gathering dust on the shelves of the ‚Äúlaboratory‚Äù, since  This approach requires code without errors.  That is, PHP, in fact, has no right to fall, and the omnivorous nature and dynamics of PHP does not contribute to this.  This can be corrected by adding PHP PM to restart the fallen processes, as well as you can add tracking of changes in the code and also restart the processes.  But not yet claimed.  Also on this base, you can run websocket server.  What was in the plans, but so it remained there. <br><br>  I left such a server for the whole weekend under load, there were no memory leaks.  There is one problem that so far there is neither the time nor need to look for: for some reason, after the load, 1-2 connections remain unclosed.  At low loads, it is not possible to identify the cause, but for large loads it is necessary to spend time to figure out how to identify the cause.  So far, added a timer, which every 10 seconds checks current connections for validity (resource, not resource) and kills dead ones. <br><br>  It is also worth noting that the application, ideally, should take into account the new possibilities of asynchrony and interrupt (yield), and not be executed monolithically.  It would also be good to use non-blocking functionality. </div><p>Source: <a href="https://habr.com/ru/post/220393/">https://habr.com/ru/post/220393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220379/index.html">Zabbix + Pushbullet: a simple way to push alerts</a></li>
<li><a href="../220381/index.html">Handling touch input in Windows 8 applications</a></li>
<li><a href="../220387/index.html">Self-Documented JAX-WS with XSD Restrictions Support</a></li>
<li><a href="../220389/index.html">Deploy the application to Heroku using Gradle</a></li>
<li><a href="../220391/index.html">New monitors Samsung SD390 and SD590 already in Russia</a></li>
<li><a href="../220395/index.html">Calvin Klein was unable to select an abusive domain</a></li>
<li><a href="../220397/index.html">Overview of Startup Founder Conferences</a></li>
<li><a href="../220399/index.html">‚ÄúFlappy Bird‚Äù up to 1KB</a></li>
<li><a href="../220403/index.html">The official mobile application Habrahabra</a></li>
<li><a href="../220411/index.html">Update for backdoor in Linksys and Netgear routers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>