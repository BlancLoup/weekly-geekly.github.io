<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>xbmcswift2 - micro-framework for writing plug-ins to Kodi (XBMC)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 This, so to speak, is a ‚Äúbonus‚Äù article in my series of articles about plug-ins for the Kodi Media Center (XBMC). First of all, it shou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>xbmcswift2 - micro-framework for writing plug-ins to Kodi (XBMC)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  This, so to speak, is a ‚Äúbonus‚Äù article in my series of articles about plug-ins for the Kodi Media Center (XBMC).  First of all, it should be noted that, starting with version 14.0, the popular media center changes its name from XBMC to Kodi.  The reasons for changing the name can be read on the official website and forum, and for our article they are not fundamental.  However, later in the article will be used a new name - Kodi. <a name="habracut"></a><br><br><h5>  Previous articles </h5><br>  <a href="http://habrahabr.ru/post/193374/">Detailed anatomy of a simple XBMC plugin</a> <br>  <a href="http://habrahabr.ru/post/193704/">Writing a plugin for XBMC with its own interface: Part I - the theory and the simplest example</a> <br>  <a href="http://habrahabr.ru/post/194124/">Writing a plugin for XBMC with its own interface: Part II - Dialogues and Decorations</a> <br>  <a href="http://habrahabr.ru/post/194380/">Writing a plug-in for XBMC with its own interface: Part III - API and micro-framework</a> <br><br><h4>  xbmcswift2 </h4><br>  In the first article, <a href="http://habrahabr.ru/post/193374/">‚ÄúDetailed Anatomy of a Simple XBMC Plug-in‚Äù</a> , the basic principles of plug-in content sources, i.e., plug-ins that allow you to watch videos and listen to music from various online resources, were discussed.  There are two basic principles: <br><ol><li>  Each item in a virtual directory (a link to a subsection or file to play) is an object of class <b>xbmcgui.listItem</b> containing all the information about an item in a virtual directory.  When creating a list of items, we sequentially create <b>xbmcgui.listItem</b> objects, set their properties (thumbnail, fanart, link, additional information) and feed these elements to the <b>xbmcplugin.addDirectoryItem</b> function. </li><li>  To create multi-level directories, the plugin recursively calls itself, passing parameters in the form of a URL-encoded string via the sys.argv [2] list item.  In this case, we need to decode these parameters and call the appropriate part of the code, for example, to form a directory of the lower level (subsection) or play the video by reference.  That is, we need to organize the routing of such recursive calls. </li></ol><br>  As a result, the plugin developer is charged with extra work that is not directly related to receiving information, organizing content and playing it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When creating xbmcswift2, the developer was obviously inspired by the popular Python micro-frameworks for web development - Flask and Bottle.  The recursive call routing mechanism is clearly borrowed from these frameworks - call paths and parameter passing are implemented through function decorators. <br>  In addition, in xbmcswift2 the structure of virtual directory elements is unified.  Now a separate element is a Python dictionary with all the necessary properties in the form of key-value pairs.  These elements are combined into a list, and to display a list of elements in the Kodi interface, the function ‚Äúdecorated‚Äù with the route decorator should return this list.  Further processing of the list and decoding of dictionaries describing the elements of this list takes on xbmcswift2. <br>  In addition to simplifying the creation of content lists and routing recursive calls, xbmcswift2 offers such nice features as caching objects returned by functions and methods, as well as permanent storage for storing the state of objects between recursive calls.  xbmcswift2 also allows you to debug plug-in code in the console, without using Kodi. <br><br>  To illustrate the use of xbmcswift2, I will take the plugin from the article <a href="http://habrahabr.ru/post/193374/">‚ÄúDetailed anatomy of a simple XBMC plugin‚Äù</a> and rewrite it under this framework.  For simplicity, the new plugin will not display any messages on the screen, so there are no language files in it. <br><br><div class="spoiler">  <b class="spoiler_title">Plug code</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- # Name: plugin.video.cnet # Author: Roman VM # Created: 02.02.2014 # Licence: GPL v.3: http://www.gnu.org/copyleft/gpl.html #    import sys import os import urllib2 import xml.dom.minidom #  xbmcswift2 from xbmcswift2 import Plugin #   plugin plugin = Plugin() #     addon_path = plugin.addon.getAddonInfo('path').decode('utf-8') #     thumbpath = os.path.join(addon_path, 'resources', 'thumbnails') #     fanart = os.path.join(addon_path, 'fanart.jpg') #    sys.path.append(os.path.join(addon_path, 'resources', 'lib')) from feeds import FEEDS #  ,   (),  30 . @plugin.cached(30) def rss_parser(url): listing = [] try: HEADER = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; rv:18.0) Gecko/20100101 Firefox/20.0'} request = urllib2.Request(url, None, HEADER) rss = xml.dom.minidom.parse(urllib2.urlopen(request, None, 3)) except urllib2.URLError: pass else: titles = rss.getElementsByTagName('title') links = rss.getElementsByTagName('link') for title, link in zip(titles[2:], links[2:]): title = title.toxml().replace('&lt;title&gt;&lt;![CDATA[', '').replace(']]&gt;&lt;/title&gt;', '') link = link.toxml().replace('&lt;link&gt;', '').replace('&lt;/link&gt;', '') listing.append((title, link)) return listing #   @plugin.route('/') def feed_index(): feed_list = [] for i in range(len(FEEDS)): #    . #  : feed = {'label': FEEDS[i]['label'], # : 'thumbnail': os.path.join(thumbpath, FEEDS[i]['thumb']), #    (): 'properties': {'fanart_image': fanart}, #    . 'path': plugin.url_for('podcast_index', feed=str(i))} feed_list.append(feed) #       : #       (""   Confluence). return plugin.finish(feed_list, sort_methods=['label'], view_mode=500) #     @plugin.route('/feeds/&lt;feed&gt;') def podcast_index(feed): feedNo = int(feed) quality = plugin.addon.getSetting('quality') #      . podcasts = rss_parser(url=FEEDS[feedNo][quality]) thumb = os.path.join(thumbpath, FEEDS[feedNo]['thumb']) podcast_list = [] for podcast in podcasts: item = {'label': podcast[0], 'thumbnail': thumb, 'properties': {'fanart_image': fanart}, 'path': plugin.url_for('play_podcast', url=podcast[1]), # ,        (  ). 'is_playable': True} podcast_list.append(item) #       return podcast_list @plugin.route('/play/&lt;url&gt;') def play_podcast(url): #   Kodi    . plugin.set_resolved_url(url) if __name__ == '__main__': #  . plugin.run()</span></span></code> </pre> <br></div></div><br><br>  Now, as always, line by line analysis.  To display line numbers, use a text editor with the appropriate function, such as Notepad ++.  Obvious things and what is clear from the comments, I skip. <br><br>  30: The <i>@ plugin.cached ()</i> decorator is used to cache objects returned by functions or methods.  This decorator is recommended to "decorate" the functions that receive content from websites, so as not to create an excessive load on these sites.  The caching time in minutes is set as a parameter to the decorator. <br>  49: The <i>@ plugin.route ()</i> decorator is used to route plug-in calls.  A plugin must necessarily contain at least the root route ('/'). <br>  55-61: The properties of a list item are set in the form of a fairly simple and clear dictionary. <br>  61: The <i>url_for ()</i> method generates the correct path for the recursive plugin call, so that this path can be decoded xbmcswift2.  The first parameter is the name of the function being called as a string, and additional information is passed through named parameters.  Only simple strings can be used as parameters.  Accordingly, all other data types should be cast to strings.  Non-ASCII characters can be transmitted as URL-encoded sequences (for example, ‚ÄúVasya‚Äù&gt; ‚Äú% D0% 92% D0% B0% D1% 81% D1% 8F‚Äù or in base64 encoding. <br>  65: The <i>finish ()</i> method is used to pass additional parameters for displaying the content list (besides the list itself).  If you do not need to return any additional parameters, you can return the list itself without using the <i>finish ()</i> method. <br>  69.70: Call the function that creates the list of podcasts.  As a parameter, we pass the section number in the list (more precisely, the tuple) FEEDS. <br>  83: Indicate that this element does not contain nested elements (in this case, the list element is a file for playback).  By default, this parameter is False, so it is omitted in the previous function. <br>  89‚Äî90: here, a special function <i>play_podcast () is</i> used to send the file to the main Kodi code for playback, which, in turn, calls the <i>set_resolved_url ()</i> method.  This method is a "wrapper" of xbmcswift2 around the standard Kodi Python API <i>function xbmcplugin.setResolvedUrl ()</i> .  The use of <i>xbmcplugin.setResolvedUrl () is</i> poorly documented, but this is the preferred method to start playing multimedia files.  Of course, you can use direct links to these files (and in the example from the article <a href="http://habrahabr.ru/post/193374/">‚ÄúDetailed Anatomy of a Simple XBMC Plugin‚Äù</a> , a simple version with direct links was used), but there are undesirable side effects when using direct links.  For example, when generating a list of files, Kodi tries to read the metadata of these files, which, with a large number of list items and a slow connection, leads to the fact that the list is formed for a very long time.  In addition, when using direct links, auto-bookmarks and browsing marks are not supported.  The reason for the latter is not clear (most likely, a bug.) However, if xbmcplugin.setResolvedUrl () and its counterpart from xbmcswift2 are <i>used</i> - <i>set_resolved_url ()</i> - these side effects are not observed. <br><br><h4>  Conclusion </h4><br>  The xbmcswift2 microframe is available in the official Kodi repository, and when creating a plug-in based on it, the micro-framework must be specified as a dependency in the Kodi plug-in metadata file - addon.xml.  For more on this, see previous articles and the official Wiki. <br>  You can download the finished demo plugin based on xbmcswift2 <a href="">from here</a> . <br><br>  I hope the information from these articles will help you in writing useful plug-ins for Kodi.  As practice shows, the most difficult task when writing a plug-in is to pull links to videos or music from one site or another, and organizing information and links in a plug-in is much easier. <br><br><h4>  Information sources </h4><br>  <a href="https://xbmcswift2.readthedocs.org/en/latest/">Official documentation xbmcswift2</a> . </div><p>Source: <a href="https://habr.com/ru/post/243249/">https://habr.com/ru/post/243249/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243237/index.html">Localization of the button "Build"</a></li>
<li><a href="../243241/index.html">From the life of the usability lab Mail.Ru Group</a></li>
<li><a href="../243243/index.html">What to read at your leisure: the gaming industry news digest for October</a></li>
<li><a href="../243245/index.html">Transactional hell</a></li>
<li><a href="../243247/index.html">9 basic principles of responsive web design</a></li>
<li><a href="../243253/index.html">16 fun projects for your new Raspberry Pi</a></li>
<li><a href="../243255/index.html">Russian App Day - November 21 - Technopolis "Moscow"</a></li>
<li><a href="../243257/index.html">Google: recommendations for apps on Google Play</a></li>
<li><a href="../243263/index.html">Running Lean. Retelling one of the best books about startups</a></li>
<li><a href="../243271/index.html">Simple one-sided universal connector for Chrome</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>