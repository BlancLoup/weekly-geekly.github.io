<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shared Folders in OpenVZ 7.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The new OpenVZ 7.0 is a hybrid of the good old OpenVZ and commercial Virtuozzo. I would like to think that he took the best from both parents, but it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shared Folders in OpenVZ 7.0</h1><div class="post__text post__text-html js-mediator-article">  The new OpenVZ 7.0 is a hybrid of the good old OpenVZ and commercial Virtuozzo.  I would like to think that he took the best from both parents, but it is not.  In this case, the Shared Folders functionality was under the knife. <br><br><img src="https://habrastorage.org/files/55c/978/3b8/55c9783b8817410ebeb1f1b517685348.jpg"><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Earlier in OpenVZ, this problem was solved by .mount-files (more details <a href="https://wiki.openvz.org/Bind_mounts">here</a> ).  But now the containers are called something like ‚Äú600adc12-0e39-41b3-bf05-c59b7d26dd73‚Äù and creating the file 600adc12-0e39-41b3-bf05-c59b7d26dd73.mount does not solve the problem, it is simply ignored at startup.  Of course, the presence of the folder / vz / private / 600adc12-0e39-41b3-bf05-c59b7d26dd73 / scripts hints that some scripts can be run, but it was not possible to find documentation about this. <br><br>  <b>UPDATE</b> <br>  Thank you <a href="https://habrahabr.ru/users/romchi/" class="user_link">romchi</a> found a working method.  But it acts on ALL containers at once.  For individual mounts, you will have to insert additional if then blocks. <br><div class="spoiler">  <b class="spoiler_title">romchi method</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'#!/bin/bash . ${VE_CONFFILE} mount -n -o bind /opt/ /vservers/root/${VEID}/opt '</span></span> &gt; /etc/vz/conf/vps.mount chmod +x /etc/vz/conf/vps.mount</code> </pre> <br></div></div><br><br>  You can use the <a href="https://wiki.openvz.org/Bind_mounts">official script Bind_mounts</a> using this method <a href="https://wiki.openvz.org/Bind_mounts">.</a> <br><div class="spoiler">  <b class="spoiler_title">romchi method + official Bind_mounts</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'#!/bin/bash . /etc/vz/vz.conf . ${VE_CONFFILE} SRC=/mnt/disk DST=/mnt/disk if [ ! -e ${VE_ROOT}${DST} ]; then mkdir -p ${VE_ROOT}${DST}; fi mount -n -t simfs ${SRC} ${VE_ROOT}${DST} -o ${SRC} '</span></span> &gt; /etc/vz/conf/vps.mount chmod +x /etc/vz/conf/vps.mount</code> </pre><br></div></div><br><br>  As a result, you can return everything as it was <br><div class="spoiler">  <b class="spoiler_title">return .mount files</b> <div class="spoiler_text"><pre> <code class="bash hljs">cat &lt;&lt;<span class="hljs-string"><span class="hljs-string">'EOF'</span></span> &gt; /etc/vz/conf/vps.mount <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash . ${VE_CONFFILE} VE_MOUNT=$(echo ${VE_CONFFILE} | sed 's/\.conf$/.mount/') [ -x ${VE_MOUNT} ] &amp;&amp; . ${VE_MOUNT} exit 0 EOF chmod +x /etc/vz/conf/vps.mount</span></span></code> </pre><br></div></div><br>  <b>/ UPDATE</b> <br><br>  In Virtuozzo Shared Folders were implemented via prlctl set, but this functionality was not ported to OpenVZ.  Do not believe - check under the spoiler. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  You can verify this by typing: <br><br><pre> <code class="bash hljs">prlctl <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Tname --shared prlctl <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Tname --shared-profile prlctl <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Tname --sharedfolder-add prlctl <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Tname --shf-host-add</code> </pre> <br>  None of these commands work. <br></div></div><br><br>  What to do? <br><br><ol><li>  Raise the NFS server on the physical server and the NFS client inside the container.  As I understand it, this is the officially recommended option.  But NFS will give additional delays and additional load on the system. <br><br></li><li>  Using prlctl --device-add, connect the disk device directly to the container.  Unfortunately, only one and at the same time it will have to be disconnected from the physical server, so you will not connect one folder either. <br><br></li><li>  Using prlctl --device-add, connect a disk device (reformatting it to some kind of cluster file system, for example, GFS or OCFS2) directly to the container.  You can connect to multiple containers and a physical server.  But the folder can not be connected either. <br><br></li><li>  Return the old (not loading system) Bind mounts functionality manually. <br></li></ol><br>  The first three methods are described in the official documentation and there is a lot of information on the Internet.  But about the fourth method and tell this article. <br><br>  In short, we will run a script on the physical server from the container via ssh, doing bind mount. <br><br>  And now more. <br><br>  For example, let's take a physical server with ip 192.168.0.11 and a container 192.168.0.22 UUID 600adc12-0e39-41b3-bf05-c59b7d26dd73 with samba server and systemd installed <br><br><ol><li>  Let's get on the physical server of the user of mount for ssh of connection <br><br><pre> <code class="bash hljs">HN<span class="hljs-comment"><span class="hljs-comment"># useradd mount</span></span></code> </pre> <br></li><li>  Generate rsa keys for the root user in a container <br><br><pre> <code class="bash hljs">CT<span class="hljs-comment"><span class="hljs-comment"># ssh-keygen ‚Äìt rsa</span></span></code> </pre> <br></li><li>  Copy the contents of the file /root/.ssh/id_rsa.pub in a container in /home/mount/.ssh/authorized_keys on a physical server.  You should get something like: <br><br><pre> <code class="bash hljs">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDXPMfZ+9Og1uY+Eq2QE85AxO+0DM0wfejNuIEZfRUi9FZj8/3BLM9u1GrmOKSMRTGIXA3yfyfep+hAm0/phuaqqG8wU2YAai/8aF4PXokeYVPzQqsbK8fK1wLYWgTO3RCtojfpoHPvdQMt28+GFRj4CTRuktUSx63XswNjzPWlqfUjiEnLZRdwbaB6ZKeepdGUmzgYq7dhMxdl3VvtAWahGnkGnn7eXT49Z9SekvFPUL77BsHwQXgspuSosg31YE09+spyA6khzwJKEqPXHRniv4H5DUzdZiQXx3tkGheGCO6JTDmcSElZyWwC9h+H7ZEEJ4IO3RRnDcsxgkW+ixij root@container</code> </pre><br></li><li>  Make sure not to mess up with the rights to the physical server: <br><br><pre> <code class="bash hljs">HN<span class="hljs-comment"><span class="hljs-comment"># ls -al /home/mount/.ssh/ total 12 drwx------ 2 mount users 4096 Sep 10 18:54 . drwx------ 5 mount users 4096 Sep 10 18:04 .. -rw------- 1 mount users 485 Sep 10 18:54 authorized_keys</span></span></code> </pre> <br></li><li>  Let's verify that we can, without a password, connect with the key to the physical server from the container: <br><br><pre> <code class="bash hljs">CT<span class="hljs-comment"><span class="hljs-comment"># ssh mount@192.168.0.11</span></span></code> </pre> <br></li><li>  Create a mount point in the container: <br><br><pre> <code class="bash hljs">CT<span class="hljs-comment"><span class="hljs-comment"># mkdir /data</span></span></code> </pre> <br></li><li>  Create a /vz/samba.mount script on the physical server. Mount: <br><br><pre> <code class="bash hljs">HN<span class="hljs-comment"><span class="hljs-comment"># cat &lt;&lt;EOF &gt; /vz/samba.mount #!/bin/bash mount -n --bind /data /vz/root/600adc12-0e39-41b3-bf05-c59b7d26dd73/data EOF chmod +x /vz/samba.mount</span></span></code> </pre> <br></li><li>  On the physical server, add it to sudoers for the mount user: <br><br><pre> <code class="bash hljs">HN<span class="hljs-comment"><span class="hljs-comment"># echo "mount ALL=NOPASSWD: /vz/*.mount" &gt; /etc/sudoers.d/mount</span></span></code> </pre> <br></li><li>  On the physical server to disable the ssh script, disable requiretty in sudoers <br><br><pre> <code class="bash hljs">HN<span class="hljs-comment"><span class="hljs-comment"># sed -i 's/^Defaults\s\+requiretty/#Defaults requiretty/' sudoers</span></span></code> </pre> <br></li><li>  Forbid on the physical server the mount user to run anything other than / bin / sudo /vz/samba.mount.  Writing in /home/mount/.ssh/authorized_keys text command = "/ bin / sudo /vz/samba.mount",no-port-forwarding,no-X11-forwarding,no-agent-forwarding <br><br><pre> <code class="bash hljs">HN<span class="hljs-comment"><span class="hljs-comment"># echo "command=\"/bin/sudo /vz/samba.mount\",no-port-forwarding,no-X11-forwarding,no-agent-forwarding $(cat /home/mount/.ssh/authorized_keys)" &gt; /home/mount/.ssh/authorized_keys</span></span></code> </pre> <br></li><li>  In the container, create a unit for automounting.  Please note that it starts BEFORE running the samba server. <br><br><pre> <code class="bash hljs">CT<span class="hljs-comment"><span class="hljs-comment"># cat &lt;&lt;EOF &gt; /etc/systemd/system/mount.service [Unit] Description=Mount from Hardware node After=network.target Before=smbd.service [Service] Type=oneshot ExecStart=/usr/bin/ssh mount@192.168.0.11 [Install] WantedBy=multi-user.target EOF</span></span></code> </pre> <br></li><li>  Let's enable the automount service created: <br><br><pre> <code class="bash hljs">CT<span class="hljs-comment"><span class="hljs-comment"># systemctl enable mount.service</span></span></code> </pre> </li></ol><br>  Everything.  Now you can reload the container and enjoy mounting the / data folder. </div><p>Source: <a href="https://habr.com/ru/post/309758/">https://habr.com/ru/post/309758/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309748/index.html">A cool online business idea. How to make money on someone else's name, someone else's site, and even without a product</a></li>
<li><a href="../309750/index.html">Open platform for developers of open source projects</a></li>
<li><a href="../309752/index.html">Refactoring sequential checks in Mockito using fluent interfaces</a></li>
<li><a href="../309754/index.html">Email Marketing: Recipe for Correct Plain-Text Letters</a></li>
<li><a href="../309756/index.html">Modest - development of an open-source HTML rendering engine on the ‚Äúbare‚Äù C</a></li>
<li><a href="../309760/index.html">How does the Center for the operational management of the MTS mobile network. Answers to your questions</a></li>
<li><a href="../309762/index.html">Home word splitting algorithm (with pictures)</a></li>
<li><a href="../309764/index.html">Susan Wojitsky: From CS50 Student to CEO Youtube</a></li>
<li><a href="../309768/index.html">Terabytes and tebibytes, traffic rating, the consequences of not understanding the difference and how to save on a video online project</a></li>
<li><a href="../309772/index.html">Sorry, we are updating the protocol</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>