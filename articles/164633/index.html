<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using IronPython from Transact SQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Transact SQL is an excellent language whose functionality is more than enough to solve most common problems. However, sometimes there are problems tha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using IronPython from Transact SQL</h1><div class="post__text post__text-html js-mediator-article">  Transact SQL is an excellent language whose functionality is more than enough to solve most common problems.  However, sometimes there are problems that can be solved with its help for a long time and / or inconveniently.  Perhaps the most striking example is advanced line parsing, in which you have to use regular expressions or just a tricky and twisted algorithm.  Starting with SQL Server 2005, this problem is solved by creating a stored procedure / CLR function.  But this approach requires recompilation and deployment of the assembly when making changes.  And so you want, without leaving Management Studio, to change the behavior of their procedures. <br>  Naturally, there is a desire to build in T-SQL support for a scripting language in order to execute code on the fly.  Thanks to the DLR (Dynamic Language Runtime) in .Net Framework 4, we have the opportunity.  Exceptionally due to the author‚Äôs personal predilections, IronPython was chosen as such a language. <br>  Under the cat step by step instructions and demonstration of the result. <br><a name="habracut"></a><br><br><h4>  What should be the result </h4><br>  I want to get a view function <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [dbo].[pyExecute]( <span class="hljs-string"><span class="hljs-string">' import re re.findall("\d+","   2013 !")[0] '</span></span> )</code> </pre> <br>  It would be nice to have the same aggregating function and a stored procedure using python code. <br><br><h4>  What we need </h4><br>  To implement our plans, we will use SQL Server 2008 R2, Visual Studio 2010 and IronPython 2.6.2.  IronPython will have to be assembled from <a href="http://ironpython.codeplex.com/releases/view/41236">source by</a> fixing just one line of code (more on that later). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Server Tuning </h4><br>  To begin with, we will create a separate base for experiments.  In the following examples, I use a database called CLR. <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--         ALTER DATABASE CLR SET TRUSTWORTHY ON GO sp_configure 'show advanced options', 1; GO RECONFIGURE; GO --     sp_configure 'clr enabled', 1; GO RECONFIGURE; GO</span></span></code> </pre><br><br><h4>  Building IronPython from Source </h4><br>  Initializing the python engine in the context of the Sql Server will cause an error that can be corrected by slightly correcting the source code.  To do this, download the source code for IronPython 2.6.2 and open the project.  In the IronPython project, we find the Modules \ sys.cs file and in the GetPrefix function we repeat the code used for building under Silverlight.  Thus, the GetPrefix function will always return an empty string. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPrefix</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> prefix; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SILVERLIGHT prefix = String.Empty; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> // prefix      prefix = String.Empty; /* try { prefix = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location); } catch (SecurityException) { prefix = String.Empty; } */ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> return prefix; }</span></span></code> </pre><br>  We build the project and get the assembly IronPython.dll, IronPython.Modules.dll, Microsoft.Dynamic.dll, Microsoft.Scripting.dll, Microsoft.Scripting.Core.dll, Microsoft.Scripting.Debugging.dll, Microsoft.Scripting.ExtensionAttribute.dll .  I advise you to copy them into a separate folder, as we still need them in the future. <br><br><h4>  Creating our builds </h4><br>  Now we can safely open Visual Studio and create our assemblies.  We need a solution with two projects.  The first pyCore project is a class library that directly executes IronPython code.  The second pySQL project is a database project for the CLR that uses the pyCore assembly and contains the code for our functions and stored procedures. <br><br><h5>  pyCore </h5><br>  Target framework choose .net 3.5.  Add to the project links to assemblies IronPython.dll, IronPython.Modules.dll, Microsoft.Scripting.dll, Microsoft.Scripting.Core.dll.  Let me remind you that we get these libraries after building IronPython from sources.  Our project will contain only one static class pyCore, responsible for creating and initializing the IronPython engine, managing the context (scope) and executing the transferred script. <br><div class="spoiler">  <b class="spoiler_title">PyCore library code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Scripting.Hosting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IronPython.Hosting; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">pyCore</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      ,  . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public static class pyCore { static ScriptEngine engine; static ScriptRuntime runtime; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  ,         </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> static pyCore() { engine = Python.CreateEngine(); runtime = engine.Runtime; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="scope"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="name"&gt;</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="value"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public static void py_setvar (ScriptScope scope,string name, object value) { scope.SetVariable(name,value); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="cmd"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="scope"&gt;</span></span></span><span class="hljs-comment"> .  null    .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="args"&gt;</span></span></span><span class="hljs-comment">    .     args</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public static object py_exec(string cmd, ScriptScope scope = null, params object [] args) { //     -   var CurrentScope = (scope ?? runtime.CreateScope()); //   ,     if (args != null) { CurrentScope.SetVariable("args",args); } //     var source = engine.CreateScriptSourceFromString(cmd, Microsoft.Scripting.SourceCodeKind.AutoDetect); //     return source.Execute(CurrentScope); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public static ScriptScope CreateScope() { return engine.CreateScope(); } } }</span></span></code> </pre><br></div></div><br>  The main interest is the function py_exec, which accepts script text, execution context and arguments that must be passed to the script. <br>  Now you need to create the pyCore assembly in the CLR database.  To do this, run the following script: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> PYCORE <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> N<span class="hljs-string"><span class="hljs-string">'&lt;   ‚Ä¶&gt;\pyCore.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span></code> </pre><br>  Most likely, you will receive an error of the following form: <br>  <i>Assembly 'pyCore' references assembly 'system.runtime.remoting, version = 2.0.0.0, culture = neutral, public keytoken = b77a5c561934e089.',</i> <br>  In other words, not all the libraries necessary for pyCore to work are present in the database.  In order not to bore the reader, I will cite immediately a script that loads everything you need.  After the keyword FROM, you must specify the full path to the assembly.  Most of the builds are obtained by building IronPython from source.  The System.Runtime.Remoting.dll assembly can be found in C: \ Windows \ Microsoft.NET \ Framework \ v2.0.50727 \ <br><div class="spoiler">  <b class="spoiler_title">The script to create all the necessary assemblies</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> ExtensionAttribute <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> N<span class="hljs-string"><span class="hljs-string">'&lt;   ‚Ä¶&gt;\Microsoft.Scripting.ExtensionAttribute.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> ScriptingCore <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> N<span class="hljs-string"><span class="hljs-string">'&lt;   ‚Ä¶&gt;\Microsoft.Scripting.Core.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> Scripting <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> N<span class="hljs-string"><span class="hljs-string">'&lt;   ‚Ä¶&gt;\Microsoft.Scripting.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> SystemRuntimeRemoting <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> N<span class="hljs-string"><span class="hljs-string">'C:\Windows\Microsoft.NET\Framework\v2.0.50727\System.Runtime.Remoting.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> MicrosoftDynamic <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> N<span class="hljs-string"><span class="hljs-string">'&lt;   ‚Ä¶&gt;\Microsoft.Dynamic.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> ScriptingDebugging <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> N<span class="hljs-string"><span class="hljs-string">'&lt;   ‚Ä¶&gt;\Microsoft.Scripting.Debugging.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> IronPythonModules <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> N<span class="hljs-string"><span class="hljs-string">'&lt;   ‚Ä¶&gt;\IronPython.Modules.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> PYCORE <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> N<span class="hljs-string"><span class="hljs-string">'&lt;   ‚Ä¶&gt;\pyCore.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span></code> </pre><br></div></div><br><h5>  pySQL </h5><br>  The black work is done, and it's time to start implementing the procedures and functions available from SQL Server.  Create a CLR database project and specify our database for tests in the connection string.  Now you need to add a link to the pyCore assembly.  If you correctly entered the database connection string in the project, then when you add a new link, you will see all the assemblies that exist in the database.  Among them, choose pyCore, Scripting and ScriptingCore. <br><br><h6>  CLR function </h6><br>  Add a new element to the project - a custom function. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserDefinedFunctions</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      IronPython </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="cmd"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> [Microsoft.SqlServer.Server.SqlFunction] public static object pyFunc(string cmd) { return pyCore.pyCore.py_exec(cmd); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      1  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="cmd"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="arg1"&gt;</span></span></span><span class="hljs-comment"> 1.     args[0]</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> [Microsoft.SqlServer.Server.SqlFunction] public static object pyFunc1(string cmd, object arg1) { return pyCore.pyCore.py_exec(cmd,null,arg1); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      2  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="cmd"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="arg1"&gt;</span></span></span><span class="hljs-comment"> 1.     args[0]</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="arg2"&gt;</span></span></span><span class="hljs-comment"> 2.     args[1]</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> [Microsoft.SqlServer.Server.SqlFunction] public static object pyFunc2(string cmd, object arg1, object arg2) { return pyCore.pyCore.py_exec(cmd,null,arg1,arg2); } // pyFunc3, 4, ... , N };</span></span></code> </pre><br>  There is nothing interesting happening in functions - a direct call to py_exec and the redirection of arguments.  There are two use cases here: passing parameters to the script when generating the script text and explicitly passing parameters through the args array.  The second method, in my opinion, is more readable and safe. <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--      select dbo.pyFunc('"'+name+'".upper()') from sys.all_objects --    select dbo.pyFunc1('str(args[0]).upper()',name) from sys.all_objects</span></span></code> </pre><br>  When declaring a CLR function in SQL Server, a signature comparison occurs that does not understand or for some other reason does not take into account the params keyword.  As a result, you have to declare several functions with a different number of parameters.  In reality, the need to create functions with more than three or four parameters is rarely encountered, so this is not a very significant limitation. <br><br><h6>  CLR procedure </h6><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StoredProcedures</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   CLR </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="cmd"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">  Int,</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> [Microsoft.SqlServer.Server.SqlProcedure] public static int pyProc(string cmd) { var scope = pyCore.pyCore.CreateScope(); //     SqlPipe scope.SetVariable("Pipe", SqlContext.Pipe); return (int)pyCore.pyCore.py_exec(cmd,scope); } };</span></span></code> </pre><br>  The internal structure of the procedure is slightly different from the function.  Additionally, we pass to the script a link to an instance of the SqlPipe object, so that we can return the table result and display messages. <br><br><h6>  Aggregate function </h6><br>  Aggregation function cannot be created using Transact SQL.  The only option is to use CLR builds.  Why this becomes so clear when you first look at the structure of the aggregating function of the CLR. <br><div class="spoiler">  <b class="spoiler_title">Aggregation Function Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [Serializable] [SqlUserDefinedAggregate( Format.UserDefined, //    ,  IBinarySerialize IsInvariantToNulls = false, IsInvariantToDuplicates = false, IsInvariantToOrder = false, MaxByteSize = 8000) ] public class pyAggregate : IBinarySerialize { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public ScriptScope scope; string init; string merge; string terminate; string accumulate; string save; string restore; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public void Init() { //    scope = pyCore.pyCore.CreateScope(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  (    ) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="value"&gt;</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="init"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="accumulate"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="merge"&gt;</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="terminate"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="save"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="restore"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void Accumulate(object value, string init, string accumulate, string merge, string terminate, string save, string restore) { //   ,     scope.SetVariable("value", value); //      -           if (this.init == null) { this.init = init; this.merge = merge; this.terminate = terminate; this.accumulate = accumulate; this.save = save; this.restore = restore; pyCore.pyCore.py_exec(this.init, scope); } //    pyCore.pyCore.py_exec(this.accumulate, scope); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="other"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void Merge(pyAggregate other) { pyCore.pyCore.py_setvar(scope, "otherdata", other); pyCore.pyCore.py_exec(this.merge, scope); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public object Terminate() { return pyCore.pyCore.py_exec(this.terminate, scope); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> .   IBinarySerialize </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="r"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void Read(BinaryReader r) { //    this.init = r.ReadString(); this.merge = r.ReadString(); this.accumulate = r.ReadString(); this.terminate = r.ReadString(); this.save = r.ReadString(); this.restore = r.ReadString(); //    scope = pyCore.pyCore.CreateScope(); //      BinaryReader, //       pyCore.pyCore.py_setvar(scope, "reader", r); pyCore.pyCore.py_exec(this.restore, scope); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> .   IBinarySerialize </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="w"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void Write(BinaryWriter w) { //    w.Write(this.init); w.Write(this.merge); w.Write(this.accumulate); w.Write(this.terminate); w.Write(this.save); w.Write(this.restore); //      BinaryWriter, //       pyCore.pyCore.py_setvar(scope, "writer", w); pyCore.pyCore.py_exec(this.save, scope); } }</span></span></code> </pre><br></div></div><br>  We implement the IBinarySerialize interface to provide the script with the ability to save its state and the intermediate result of calculations.  Since the Init function takes no arguments, the initialization script has to be executed when the Accumulate function is first run.  Our aggregation function accepts script texts to handle each event.  The scripts texts themselves are stored in the internal fields of the object and serialized. <br><br><h6>  Creating a pySQL assembly in the database and declaring functions </h6><br>  Now that the build is ready, it needs to be deployed in the CLR database. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> PYSQL <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> N<span class="hljs-string"><span class="hljs-string">'&lt;   ‚Ä¶&gt;\pySQL.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span></code> </pre><br>  Now we will declare our functions and procedures. <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   ,      CREATE FUNCTION [dbo].[pyFunc] (@cmd nvarchar(MAX)) RETURNS sql_variant AS EXTERNAL NAME PYSQL.[UserDefinedFunctions].[pyFunc]; GO --      CREATE FUNCTION [dbo].[pyFunc1] (@cmd nvarchar(MAX), @arg1 sql_variant) RETURNS sql_variant AS EXTERNAL NAME PYSQL.[UserDefinedFunctions].[pyFunc1]; GO --      CREATE FUNCTION [dbo].[pyFunc2] (@cmd nvarchar(MAX), @arg1 sql_variant, @arg2 sql_variant) RETURNS sql_variant AS EXTERNAL NAME PYSQL.[UserDefinedFunctions].[pyFunc2]; GO --   CREATE PROCEDURE pyProc (@code nvarchar(MAX)) AS EXTERNAL NAME PYSQL.StoredProcedures.pyProc GO --   CREATE AGGREGATE [dbo].[pyAggregate] ( @value sql_variant, @init nvarchar(MAX), @accumulate nvarchar(MAX), @merge nvarchar(MAX), @terminate nvarchar(MAX), @save nvarchar(MAX), @restore nvarchar(MAX) ) RETURNS sql_variant EXTERNAL NAME PYSQL.[pyAggregate]; GO</span></span></code> </pre><br><br><h4>  results </h4><br>  If you have read this far, then you are entitled to reward yourself by seeing the results of your work. <br><br><h5>  Function </h5><br>  First of all, let's solve the problem with regular expressions - we will find email addresses in the line.  The string itself will be inserted directly into the script during its formation. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [dbo].[pyFunc]( <span class="hljs-string"><span class="hljs-string">' import re mails = re.findall("[.\\-_a-z0-9]+@(?:[a-z0-9][\\-a-z0-9]+\\.)+[az]{2,6}","'</span></span>+doc+<span class="hljs-string"><span class="hljs-string">'") result = ": " for mail in mails: result += mail + "," result[:-1] '</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'     somebody@gmail.com'</span></span> doc <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'     person1@mail.ru  person2@list.ru'</span></span> doc ) SAMPLE_DATA</code> </pre><br>  Result: <br>  <i>Found: somebody@gmail.com</i> <i><br></i>  <i>Found: person1 @ mail.ru, person2 @ list.ru</i> <br><br>  The same, but using parameters.  In my opinion, a more beautiful way, but requiring a function declaration with the required number of arguments. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [dbo].[pyFunc1]( <span class="hljs-string"><span class="hljs-string">' import re mails = re.findall("[.\\-_a-z0-9]+@(?:[a-z0-9][\\-a-z0-9]+\\.)+[az]{2,6}",str(args[0])) result = ": " for mail in mails: result += mail + "," result[:-1] '</span></span>, SAMPLE_DATA.doc ) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'     somebody@gmail.com'</span></span> doc <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'     person1@mail.ru  person2@list.ru'</span></span> doc ) SAMPLE_DATA</code> </pre><br>  The result is naturally the same. <br><br>  This function can also be used to calculate complex math functions not built into SQL Server and to dynamically evaluate expressions (this can be achieved with sp_execute). <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @InputFromula <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @InputFromula = <span class="hljs-string"><span class="hljs-string">'math.log(math.cosh(int(args[0]))/math.e,int(args[1]))'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [dbo].[pyFunc2] ( <span class="hljs-string"><span class="hljs-string">'import math '</span></span>+@InputFromula, <span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span> )</code> </pre><br><br><h5>  Stored procedure </h5><br>  I will give a complete example at once.  Here we write a text message using the SqlPipe object, carefully passed to our script, then we form a table, fill it with data and return it as a result. <br><pre> <code class="sql hljs">exec pyProc ' import clr clr.AddReference("System.Data") from Microsoft.SqlServer.Server import * from System.Data import * from System import DateTime Pipe.Send(" : !") metadata = ( SqlMetaData(" ", SqlDbType.NVarChar, 12), SqlMetaData("  ", SqlDbType.Int), SqlMetaData("  ", SqlDbType.DateTime) ) record = SqlDataRecord(metadata) record.SetString(0, "bocharovf"); record.SetInt32(1, 1000000); record.SetDateTime(2, DateTime.Now); <span class="hljs-comment"><span class="hljs-comment">#   Pipe.Send(record) 1 '</span></span></code> </pre><br>  Result of performance: <br>  <i>We write the message: let's go!</i> <i><br></i> <table><tbody><tr><td>  <i>Employee name</i> </td><td>  <i>Expected salary</i> </td><td>  <i>Expected date of increase</i> </td></tr><tr><td>  <i>bocharovf</i> </td><td>  <i>1,000,000</i> </td><td>  <i>2012-12-31 02: 39: 51.293</i> </td></tr></tbody></table> <i><br></i>  <i>(1 row (s) affected)</i> <br><br><h5>  Aggregate function </h5><br>  We list the languages ‚Äã‚Äãused in the article, separated by commas, using our aggregating function.  In the serialization and deserialization scripts we use references to instances of the BinaryReader and BinaryWriter classes passed to our script.  The result is accumulated in the variable data. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dbo.pyAggregate ( <span class="hljs-comment"><span class="hljs-comment">--   SAMPLE_DATA.[language], --  'data = ""', --  'data += str(value) + ", "', '# nop', --   'data[:-2]', --  'writer.Write(str(data))', --  'data = reader.ReadString()' ) as Languages ,SAMPLE_DATA.IsUsed from ( select 'C#' [language], '  ' IsUsed union select 'T-SQL', '  ' union select 'IronPython', '  ' union select 'Cobol', '   ' union select 'Ada', '   ' union select 'Lisp', '   ' union select 'Fortran', '   ' ) SAMPLE_DATA group by SAMPLE_DATA.IsUsed</span></span></code> </pre><br>  Result: <br><table><tbody><tr><td>  <i>Languages</i> </td><td>  <i>IsUsed</i> </td></tr><tr><td>  <i>C #, IronPython, T-SQL</i> </td><td>  <i>Used in article</i> </td></tr><tr><td>  <i>Ada, Cobol, Fortran, Lisp</i> </td><td>  <i>Not used in the article</i> </td></tr></tbody></table> <i><br></i>  <i>(2 row (s) affected)</i> <br><br><h5>  Performance </h5><br>  As expected, the performance is low.  For example, the right-to-left output rate of the standard T-SQL REVERSE function and using the cut operation in python is almost 80 times different. <br><br><h5>  Security </h5><br><pre> <code class="sql hljs">exec pyProc ' from System.Net import WebClient content = WebClient().DownloadString("http://habrahabr.ru/") Pipe.Send(content[:4000]) 1 '</code> </pre><br>  Since our capabilities are not limited by anything, we can execute any code, including access to a resource on the Internet or delete a file from the disk.  Therefore, it is necessary to distribute the rights with care and use mainly the transfer of parameters to the function instead of creating a script in parts. <br><br><h4>  Instead of conclusion </h4><br>  Each tool should only be used where it really makes sense.  You should not try to rewrite all your stored procedures and functions using IronPython.  Rather, functions on IronPython are suitable for implementing complex algorithms that use functionality that is missing in Transact SQL or processing data from external sources (file system, Internet).  In addition to IronPython, anyone can embed IronRuby support or, for example, Javascript .NET. </div><p>Source: <a href="https://habr.com/ru/post/164633/">https://habr.com/ru/post/164633/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164609/index.html">Simulation of the movement and drift of the machine in the game on JavaScript</a></li>
<li><a href="../164611/index.html">Unconventional use of Microsoft Reporting Services</a></li>
<li><a href="../164617/index.html">OS X - my experience</a></li>
<li><a href="../164623/index.html">Procrastination Symbolic reward system. Part 1</a></li>
<li><a href="../164625/index.html">Ways of moving computer characters (part 3)</a></li>
<li><a href="../164635/index.html">Minicomputer from a router with OpenWRT: we write the framebuffer driver</a></li>
<li><a href="../164639/index.html">What do they want in different countries? Google Interactive</a></li>
<li><a href="../164641/index.html">State e-mail launched in Russia</a></li>
<li><a href="../164647/index.html">What to do when IDDQD does not work?</a></li>
<li><a href="../164649/index.html">AWS Insight: Spot Instances</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>