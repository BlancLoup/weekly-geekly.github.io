<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Improving the performance of Ruby on rails applications using ActiveMQ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my post I want to talk about the possibility of using ActiveMQ in a project written in the Ruby on rails framework. 

 What is a Message Queue? 
 M...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Improving the performance of Ruby on rails applications using ActiveMQ</h1><div class="post__text post__text-html js-mediator-article">  In my post I want to talk about the possibility of using <a href="http://activemq.apache.org/">ActiveMQ</a> in a project written in the Ruby on rails framework. <br><br><h4>  What is a Message Queue? </h4><br>  MQ is the messaging architecture between application components in asynchronous mode.  That is, the sender and receiver can interact at different times.  Such systems consist of a producer'a (sender) and a consumer'a (recipient) that interact with each other through a broker. <br><br>  Using such systems, you can significantly increase application performance by executing code in asynchronous mode.  Suppose you have a code that slows down the execution of some part on your site so that the user does not wait for the completion of such code, it is better to execute it in asynchronous mode.  A few simple examples: <br>  - thumbnails generation; <br>  - collection of statistics; <br>  - distribution of letters / messages; <br>  - deletion of data from the tables; <br>  - data indexing; <br>  - import data into the database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are a lot of such examples, I think everyone can find part of the code in their project that can be submitted for execution in asynchronous mode. <br><a name="habracut"></a><br><h4>  What is ActiveMQ? </h4><br>  ActiveMQ is an open source implementation of the message broker system.  The advantage of this system is high performance, openness and the ability to implement customers in any languages.  ActiveMQ currently supports the following protocols: <br>  - OpenWire (own binary protocol); <br>  - Stomp; <br>  - REST; <br>  - WS Notification; <br>  - XMPP. <br><br><h4>  Install ActiveMQ </h4><br>  The description will go for Linux, although I think there should be no problems installing on Windows.  We execute the following commands: <br><br> <code><a href=""></a> wget apache.multihomed.net/activemq/apache-activemq/5.2.0/apache-activemq-5.2.0-bin.tar.gz <br> tar xvf apache-activemq-5.2.0-bin.tar.gz <br> sudo cp -R ./apache-activemq-5.2.0 /usr/local/apache-activemq</code> <br> <br>  Installation completed.  Run ActiveMQ: <br><br> <code>sudo /usr/local/apache-activemq/bin/activemq &amp;</code> <br> <br>  Everything is ready to go. <br><br><h4>  Working with ActiveMQ on Ruby on rails </h4><br>  To understand how convenient it is to execute code in asynchronous mode, let's first create a code that will be executed for a long time. <br><br> <code>rails test <br> cd test <br> script/generate controller test <br> script/server</code> <br> <br>  Convert the Test controller code to the following form: <br><br> <code>class TestController &lt; ApplicationController <br> def index <br> self.class.benchmark('Write to file') do <br> path = File.join(RAILS_ROOT, 'tmp', 'test') <br> file_test = File.new(path, 'w') <br> <br> 10000000.times do <br> file_test.write("Some test message\n") <br> end <br> end <br> <br> render :text =&gt; 'Data saved' <br> end <br> end</code> <br> <br>  We open <a href="http://0.0.0.0:3000/test/index">http://0.0.0.0ŸÑ000</a> / <a href="http://0.0.0.0:3000/test/index">test</a> / <a href="http://0.0.0.0:3000/test/index">index</a> and see that it takes some time to wait for the completion of the code.  My benchmark showed that this code runs for 10 seconds, a lot, not every user is willing to wait for such a time. <br><br>  To interact with ActiveMQ, I suggest using the ActiveMessaging plugin, I want to note that it is possible to use the Stomp client directly.  But in this case we will lose the ability to easily and easily switch to another MQ system. <br><br>  <a href="http://code.google.com/p/activemessaging/">ActiveMessaging</a> is a plugin for Ruby on rails which is very easy to use in a project for executing code in asynchronous mode.  It supports a large number of protocols, including Stomp, i.e.  we can use it to work with ActiveMQ. <br><br>  Install it into the project: <br><br> <code><a href="http://activemessaging.googlecode.com/svn/trunk/plugins/activemessaging"></a> script/plugin install activemessaging.googlecode.com/svn/trunk/plugins/activemessaging</code> <br> <br>  we also need to install a client to work with the stomp protocol: <br><br> <code>gem install stomp</code> <br> <br>  Installation completed. <br><br>  ActiveMessaging has two configuration files: <br>  - config / broker.yml - contains settings for connection; <br>  - config / messaging.rb - contains queue settings. <br><br>  Executable code in asynchronous mode is written in the so called processor.  To generate our first processor, execute the following command: <br><br> <code>script/generate processor Test</code> <br> <br>  Open our processor (/app/processors/test_proccesor.rb) and transfer the test code here: <br><br> <code>class TestProcessor &lt; ApplicationProcessor <br> subscribes_to :test <br> <br> def on_message(message) <br> path = File.join(RAILS_ROOT, 'tmp', 'test') <br> file_test = File.new(path, 'w') <br> <br> 10000000.times do <br> file_test.write("#{message}\n") <br> end <br> <br> logger.debug 'Data saved' <br> end <br> end</code> <br> <br>  We convert the index action code to the following: <br><br> <code>def index <br> publish :test, 'Some test message' <br> render :text =&gt; 'Message sent' <br> end</code> <br> <br>  Here we simply pass the message 'Some test message' to the destination under the name test, i.e., we perform the function of the producer.  If you open the configuration file config / messaging.rb then you will see the queue / queue / Test as the destination destination test queue, to which our message will be sent. <br><br>  We start the demon that is our consumer, i.e.  it will read all messages from the queue / queue / Test and transfer them to the TestProcessor processor. <br><br> <code>script/poller start</code> <br> <br>  For the purity of the test, delete our file in which we wrote the data: <br><br> <code>rm /tmp/test</code> <br> <br>  We update the page <a href="http://0.0.0.0:3000/test/index">http://0.0.0.0ŸÑ000</a> /test/ <a href="http://0.0.0.0:3000/test/index">index</a> and immediately see that the code runs almost instantly, but now we go to tmp and see the newly created test file with the given one.  You can also go to the log and see the message 'Data saved' there. <br><br>  In most cases, we need to execute the code with some parameters.  We can translate the hash with parameters into XML, JSON or Yaml and pass as a message.  I prefer JSON. <br><br>  Let's try to transfer the number of written lines and the message itself, which is written to the file.  Change the index action a bit: <br><br> <code>def index <br> publish :test, {:count =&gt; 200000, :message =&gt; 'Some new test message'}.to_json <br> render :text =&gt; 'Message sent' <br> end</code> <br> <br>  Change the on_message method: <br><br> <code>def on_message(message) <br> options = JSON.parse(message).symbolize_keys <br> path = File.join(RAILS_ROOT, 'tmp', 'test') <br> file_test = File.new(path, 'w') <br> <br> options[:count].times do <br> file_test.write("#{options[:message]}\n") <br> end <br> <br> logger.debug 'Data saved' <br> end</code> <br> <br>  Since ruby ‚Äã‚Äãdoes not have standard functions for working with JSON, you need to install gem: <br><br> <code>sudo gem install json</code> <br> <br>  and connect it to TestProcessor: <br><br> <code>require 'json'</code> <br> <br>  Now we interrupt the work of our demon and restart it: <br><br> <code>script/poller stop <br> script/poller start</code> <br> <br>  Again we are updating the page <a href="http://0.0.0.0:3000/test/index">http://0.0.0.0ŸÑ000/test/index</a> .  Opening the tmp / test file, we will see the overwritten file already in the lines 'Some new test message'. <br><br>  In the processor it is very easy to use models, just like in ordinary action games.  A small example for clarity: <br><br> <code>def on_message(message) <br> options = JSON.parse(message).symbolize_keys <br> <br> Product.find(:all).each do |product| <br> product.price = options[:price] <br> product.save <br> end <br> end</code> <br> <br>  In ActiveMQ there is a utility in which you can view statistics of sent messages, a list of queues, and even send a message, it is very convenient to use for debugging.  It is located at <a href="http://0.0.0.0:8161/admin/">http://0.0.0.0:8161/admin/</a> . <br><br>  I hope this post has demonstrated the simplicity and advantage of using ActiveMQ in a project.  Just a little refactoring in your project and the application will breathe differently. </div><p>Source: <a href="https://habr.com/ru/post/70443/">https://habr.com/ru/post/70443/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70434/index.html">Neoline, Life :) and paid calls</a></li>
<li><a href="../70435/index.html">MySQL Profiler: a simple and convenient query profiling tool</a></li>
<li><a href="../70436/index.html">Ancient Domains of Mystery</a></li>
<li><a href="../70438/index.html">Twitter Broadcast Russian TechTour 2009</a></li>
<li><a href="../70441/index.html">Mini review or purchase experience - Acer Revo R3600 (dual-core Atom 330)</a></li>
<li><a href="../70446/index.html">Multi-agent systems - what is it?</a></li>
<li><a href="../70451/index.html">New Google Toolbar</a></li>
<li><a href="../70453/index.html">Google Sidewiki</a></li>
<li><a href="../70454/index.html">The concept of data-driven processor</a></li>
<li><a href="../70455/index.html">SharePoint 2007 - Link library - open a link in a new window</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>