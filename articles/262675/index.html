<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk: Auto-informing the callee before connecting to the operator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 I decided to share my own experience in some of the features of the work of Dialplan. 

 This article does not pretend to scientific discover...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk: Auto-informing the callee before connecting to the operator</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  I decided to share my own experience in some of the features of the work of Dialplan. <br><br>  This article does not pretend to scientific discoveries, but as a short reference list it may be useful to someone. <br><br>  Initial data: <br>  Server with Asterisk 1.8, without a web interface, configured as a phone gateway router. <br>  The configuration is set by editing the configuration files in the / etc / asterisk / directory <br>  It is necessary to reproduce the message to the called subscriber, and then notify the caller of his readiness to listen. <br>  Who cares, welcome under cat. <br><a name="habracut"></a><br>  When an incoming call, the caller listens for a greeting and IVR message (this is configured on a large Call Center with a web interface similar to the standard FreePBX), including that the ‚Äúmessage is recorded‚Äù.  There was a need to reproduce the same message when calling from call center operators to subscribers.  There is no possibility to add such a function in the web interface, I had to improvise. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the moment, the server with voice gateway functions and plays the message to the called subscribers, if the calling numbers satisfy the specified condition, as well as notifies the caller that you can talk. <br><br>  A piece of dialplan responsible for the message: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="hljs php">[call-centr-context] etxen =&gt; _X.,n,Macro(SayAllCallsRec) [macro-SayAllCallsRec] exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(${CALLERID(num}) exten =&gt; s,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${CALLERID(num)}"</span></span> = <span class="hljs-string"><span class="hljs-string">"123456789"</span></span>]?say) ; Other numbers here. NO FULL <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-then-<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>! exten =&gt; s,n(notsay),NoOp() exten =&gt; s,n,Dial(SIP/${MACRO_EXTEN}@TrunkOut,<span class="hljs-number"><span class="hljs-number">50</span></span>) exten =&gt; s,n,<span class="hljs-keyword"><span class="hljs-keyword">GoTo</span></span>(end) exten =&gt; s,n(say),NoOp() exten =&gt; s,n,Set(LIMIT_PLAYAUDIO_CALLER=yes) exten =&gt; s,n,Set(LIMIT_PLAYAUDIO_CALLEE=no) exten =&gt; s,n,Set(LIMIT_CONNECT_FILE=/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/asterisk/sounds/beep) exten =&gt; s,n,Dial(SIP/${MACRO_EXTEN}@TrunkOut,<span class="hljs-number"><span class="hljs-number">50</span></span>,L(<span class="hljs-number"><span class="hljs-number">9999999</span></span>)A(/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/asterisk/sounds/AllCallsRec)) exten =&gt; s,n,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(end) exten =&gt; s,n(end),NoOp() exten =&gt; s,n,HangUp()</code> </pre> </div></div><br>  This section of the dialplan is working and tested.  You can safely delete all the lines containing NoOp, since  they perform only the functions of writing to the console log. <br><br>  Now go through some areas. <br>  In the context that the Call-center trunk belongs to, the general extension ‚ÄúFor any number‚Äù (_X.) Sends a call to the macro, where it happens: <br>  - Check on the "white list". <br>  - raising the tube, <br>  - Reproduction KPV, <br>  - Message to the callee <br>  - Message to the caller. <br>  Unfortunately, the bug (or feature) ( <a href="http://forums.asterisk.org/viewtopic.php%3Fp%3D44600">proof</a> ) described back in 2007 with a non-simultaneous message of the file ‚ÄúLIMIT_CONNECT_FILE‚Äù still exists in version 1.8, and there is no possibility to update the server. <br>  Thus, if you try to notify both participants in a call using the LIMIT_PLAYAUDIO_CALLER = yes, LIMIT_PLAYAUDIO_CALLEE = yes flags, the message will be played sequentially.  First - to subscriber B, then - to subscriber A, and the other subscriber will have silence at this moment. <br><br>  Now let's look at the dialplan.  Let's start with the call command, as the longest. <br>  Dial (SIP / $ {MACRO_EXTEN} @TrunkOut - The call will be sent with the number sent to the macro on the trunk "TrunkOut" <br>  , 50 - We will wait for a response up to 50 seconds <br>  , L (9999999) - connection time limit in milliseconds (not required, but there is no other way to tell the caller that the callee heard the ‚Äúgreeting‚Äù. <br>  A (path-to-file) - message to the callee <br><br>  exten =&gt; s, n, Set (LIMIT_PLAYAUDIO_CALLER = yes) - Play caller <br>  exten =&gt; s, n, Set (LIMIT_PLAYAUDIO_CALLEE = no) - Play callable <br>  exten =&gt; s, n, Set (LIMIT_CONNECT_FILE = / var / lib / asterisk / sounds / beep) - Path to the file to be played. <br><br>  The variables set just above determine to whom the beep sound will be played.  In our case, the one who calls FROM Call-center. <br><br>  And, actually, what the call itself looks like in steps: <br>  Call Center subscriber dials the number.  The call comes to the Asterisk gateway.  The call falls into the macro.  Number A is compared with the list.  In case of a mismatch, the call goes without additional keys.  In case of a match, the keys are added to the call. <br>  Subscriber B picks up the phone, listens to the message (Key A ()).  At this point, subscriber A will have silence (after long beeps).  When the message is finished, subscriber A will hear a sound from the beep.gsm file (must be in the / var / lib / asterisk / sounds / directory).  For what reason in the gsm format it is not clear.  And only after that, the channels will be connected. <br><br>  Also, you can replace the silence for subscriber A with dial tone.  To do this, change the lines: <br><pre> <code class="hljs php">exten =&gt; s,n(say),NoOp() exten =&gt; s,n,Answer() exten =&gt; s,n,Playtones(<span class="hljs-number"><span class="hljs-number">420</span></span>) exten =&gt; s,n,Set(LIMIT_PLAYAUDIO_CALLER=yes) exten =&gt; s,n,Set(LIMIT_PLAYAUDIO_CALLEE=no) exten =&gt; s,n,Set(LIMIT_CONNECT_FILE=/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/asterisk/sounds/beep) exten =&gt; s,n,Dial(SIP/${MACRO_EXTEN}@TrunkOut,<span class="hljs-number"><span class="hljs-number">50</span></span>,L(<span class="hljs-number"><span class="hljs-number">9999999</span></span>)A(/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/asterisk/sounds/AllCallsRec))</code> </pre><br>  Added Answer () - the channel is collected, and Playtones () - the CPV is played.  In this case, the caller will receive the signals generated by the Asterisk-gateway. <br>  Unfortunately, in this case, the RTP messages before the connection from the upstream servers will be replaced with beeps.  For example, a message without an answer ‚ÄúSubscriber cannot be called‚Äù from cellular and the like, which actually do not lead to the creation of a channel (answer 200 - OK) will be ignored, and the caller will receive a sound of the form (long beeps, long beeps, short beeps. ..), but there will be no silence. <br><br>  Also, you can add the key r to the Dial () - the generation of the system keywave, but it will be selected from the system sounds and will (most often) be very different from the classic ring back tone. <br><br>  That's all.  I hope the note will help someone else save a day or two, trying to get the gateway to perform the necessary sequence of actions. </div><p>Source: <a href="https://habr.com/ru/post/262675/">https://habr.com/ru/post/262675/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262665/index.html">Guide for porting Marmalade-based applications to the Windows 10 platform</a></li>
<li><a href="../262667/index.html">We generate the version number and build on the iOS application icon</a></li>
<li><a href="../262669/index.html">Voice of Reason: effectively combine Internet and telephony in the office</a></li>
<li><a href="../262671/index.html">Announcement of JavaScript library databoom</a></li>
<li><a href="../262673/index.html">Archives and history spiral</a></li>
<li><a href="../262679/index.html">"Y" you do not "and" short! The Importance of Unicode Normalization</a></li>
<li><a href="../262681/index.html">It's not about the number of lines of code. From serial developer modules</a></li>
<li><a href="../262683/index.html">Pros and Cons: Tier Assessment System</a></li>
<li><a href="../262685/index.html">Fault detection on the example of determining the surface of an autonomous machine</a></li>
<li><a href="../262687/index.html">Beeline automatically adds a toolbar and changes the design of sites.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>