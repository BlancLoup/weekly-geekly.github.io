<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microsoft ActiveDirectory - update user passwords in external repositories</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article is more focused on those who administer or create a hybrid system environment, where the foundation is the Windows domain and you want to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microsoft ActiveDirectory - update user passwords in external repositories</h1><div class="post__text post__text-html js-mediator-article">  The article is more focused on those who administer or create a hybrid system environment, where the foundation is the Windows domain and you want to be able to authorize users on other platforms and systems with a centralized system for storing credentials.  In most cases, you will have no problems, but if you need to implement authorization, for example, using CRAM-MD5 or another authorization scheme (which is not in AD), and generally not supporting LDAP (or not understanding LDAP in understanding Microsoft ), then this article is for you. <br><a name="habracut"></a><br><h4>  Introduction: </h4><br>  In general, Microsoft has such a service: Password Change Notification Service (PCNS).  Its purpose is to trigger an event before changing the user's password and after, respectively.  With these events, a password can be transmitted in clear text (naturally via secure channels), this is what we need. <br>  To work with PCNS there are a number of paid products with rich functionality, etc., but we will try to make your bike out of free and available materials, for which we take: <br><br><ul><li>  <a href="http://sourceforge.net/projects/passwdhk/">PasswdHk (Password Filter DLL)</a> is part of the <a href="http://sourceforge.net/projects/acctsync/">LDAP Account Sync</a> project; </li><li>  And a little scripting magic. </li></ul><br>  Everything below was done for Windows Server 2008R2.  So let's go! <br><br><h4>  Passwdhk </h4><br>  First, you need to install our PasswdHk library on all domain controllers, it will process the user password change event (the event is generated on the controller with write rights selected by the user automatically, and after changing the password, the hash is distributed to other controllers). <br>  Download the installer (for x64), and install the library regularly.  Then you need to copy C: \ Windows \ System32 \ passwdhk.dll to C: \ Windows \ SysWOW64 \. <br>  Together with the DLL, there is also a graphical configuration utility, an example configuration file (reg file) and a performance test (bat file).  All settings are made in the registry and are applied at system startup (when changing, the system must be restarted). <br><div class="spoiler">  <b class="spoiler_title">Shortcomings in the utility !!!</b> <div class="spoiler_text">  Please note!  Each click of the Apply button will add another line in the registry parameter "SYSTEM \ CurrentControlSet \ Control \ Lsa \ Notification Packages", which will have to be adjusted with pens. </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will give the settings for our laboratory system: <br><br><img src="https://habrastorage.org/files/a80/f51/f8e/a80f51f8eb784816a00d185fbee0702c.png"><br><br><div class="spoiler">  <b class="spoiler_title">Settings in the text</b> <div class="spoiler_text">  The Pre and Post Change sections define actions, respectively, before the password is changed (you can implement your own password complexity filter) and after the change. <br><ul><li>  Program: C: \ Windows \ system32 \ cmd.exe (Program started to handle the event); </li><li>  Arguments: / c start C: \ Windows \ system32 \ WindowsPowerShell \ v1.0 \ powershell.exe -File d: \ control \ check-user.ps1 (Command line arguments passed to the program above); </li><li>  Password Escaping sets the password character escaping, but unfortunately only it.  Escaping the username does not occur, on top of that, the dll is clearly not up to date with UTF-8 type encodings, so the login in Cyrillic will look very sad (can anyone manage to decode the result in the normal form?) </li></ul><br><br>  The option described above with the launch via the start command is not accidental, it allows you to bypass a specific problem when the program started to process the password is executed more than the specified Wait Timeout.  Since I ran all of this on a heavily loaded host with virtual machines, in a machine with extremely modest resources, launching the PowerShell shell and loading the module into a cold one (after a long wait), it was easy to cross in 40 seconds (at this time, the user indicated a password change sits and waits), and with immodest timeouts in 30 seconds the call to the handler was interrupted forcibly. <br></div></div><br>  So, the work of PasswdHk is over here, now let's deal with getting a password on our side.  PasswdHk passes the login and password in the last two arguments of the command line. <br><br><h4>  PowerShell Processing </h4><br>  For our laboratory work, I chose PowerShell (as a trendy phenomenon, you can do processing on anything). <br><pre><code class="ruby hljs">Import-Module ActiveDirectory $csv_file = <span class="hljs-string"><span class="hljs-string">"d:\passwd.csv"</span></span> $domain=(Get-ADDomain -Server localhost).DNSRoot $user=$args[<span class="hljs-number"><span class="hljs-number">0</span></span>] $passwd=$args[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Get-ADUser -Filter {sAMAccountName -eq $user } -SearchScope <span class="hljs-number"><span class="hljs-number">2</span></span> -Server localhost){ $csv = @() $csv_new = New-Object System.Object $csv_new <span class="hljs-params"><span class="hljs-params">| Add-Member -MemberType NoteProperty -Name "DOMAIN" -Value $domain $csv_new |</span></span> Add-Member -MemberType NoteProperty -Name <span class="hljs-string"><span class="hljs-string">"USER"</span></span> -Value $user $csv_new <span class="hljs-params"><span class="hljs-params">| Add-Member -MemberType NoteProperty -Name "PASSWD" -Value $passwd $csv += $csv_new </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">if</span></span></span><span class="hljs-params"> (Test-Path $csv_file){ $csv |</span></span> ConvertTo-Csv -NoTypeInformation -delimiter <span class="hljs-string"><span class="hljs-string">"`t"</span></span> <span class="hljs-string"><span class="hljs-string">` | select -Skip 1 `</span></span> <span class="hljs-params"><span class="hljs-params">| Out-File -Encoding UTF8 -Append $csv_file } </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">else</span></span></span><span class="hljs-params">{ $csv |</span></span> ConvertTo-Csv -NoTypeInformation -delimiter <span class="hljs-string"><span class="hljs-string">"`t"</span></span> <span class="hljs-string"><span class="hljs-string">` | Out-File -Encoding UTF8 -Append $csv_file } };</span></span></code> </pre> <br>  Here we retrieve a couple of login and password from the command line variables, we put the DNS name of the domain in which the password change occurred in $ domain, and put all this into a CSV with three columns (DOMAIN, USER, PASSWD), if the search for the user returned is not empty result (excludes cases with names not in Latin, you can still filter objects corresponding only to users, otherwise the machines regularly updating their passwords will also be found in this file). <br><br><h4>  Conclusion </h4><br>  By slightly changing this example, you can send these passwords to any environment you use, I used this method to generate CRAM-MD5 hashes for the mail system on Dovecot. </div><p>Source: <a href="https://habr.com/ru/post/239359/">https://habr.com/ru/post/239359/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../239343/index.html">Mobile version for Django project</a></li>
<li><a href="../239347/index.html">VR helmet programming</a></li>
<li><a href="../239351/index.html">The charm of the bad guys or why girls do not like "nerds"</a></li>
<li><a href="../239355/index.html">Creating a home audio system</a></li>
<li><a href="../239357/index.html">Reviewing resumes of female techies is more profitable than men</a></li>
<li><a href="../239361/index.html">DSL Application Development and Code Generation</a></li>
<li><a href="../239365/index.html">Spherical screens for UAV operators and remotely controlled vehicles</a></li>
<li><a href="../239367/index.html">Wal Commander - Far Manager replacement for OS X and Linux</a></li>
<li><a href="../239369/index.html">Dummy about Dummies and one exciting journey into the depths of Excel. Long-awaited RegExp in tables</a></li>
<li><a href="../239373/index.html">Pitfalls of responsive web design</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>