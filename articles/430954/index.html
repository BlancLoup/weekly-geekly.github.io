<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Qt Everywhere: WebAssembly and WebGL streaming</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qt Everywhere - this is how Qt source archives are named. In 5.12.0, WebAssembly and WebGL streaming are delivered and everywhere sounds different. So...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Qt Everywhere: WebAssembly and WebGL streaming</h1><div class="post__text post__text-html js-mediator-article"><p>  Qt Everywhere - this is how Qt source archives are named.  In 5.12.0, WebAssembly and WebGL streaming are delivered and everywhere sounds different.  So I asked for something to prototype.  A prototype <a href="https://github.com/RPG-18/qt-wasm-chat-example/tree/master/frontend">chat</a> on web sockets was quickly thrown in to test network support.  Under the cut there will be an instruction for building and running a project on WebAssembly, an example of invoking JavaScript from C ++. </p><a name="habracut"></a><br><h4 id="sborka-qt-s-webassembly">  Building Qt with WebAsse Assembly </h4><br><p> First you need to put the toolchain <a href="https://kripken.github.io/emscripten-site/docs/getting_started/downloads.html">emscripten</a> , which will collect Qt.  Do not forget to write the environment variables that qmake would find emcc.  The <code>configure</code> script was run with the following parameters: </p><br><pre> <code class="plaintext hljs">./configure \ -prefix /home/dmitry/Qt/5.12.0/wasm \ -xplatform wasm-emscripten \ -confirm-license -opensource \ -nomake tests \ -c++std c++1z \ -nomake examples \ -release \ -no-dbus \ -skip qtxmlpatterns \ -skip qttools</code> </pre> <br><p>  Further, as elsewhere: </p><br><pre> <code class="plaintext hljs">$ make $ make install</code> </pre> <br><p>  Build and run the project </p><br><pre> <code class="plaintext hljs">$ ~/Qt/5.12.0/wasm/bin/qmake $ make $ emrun chat.html</code> </pre> <br><h4 id="platformenno-zavisimyy-kod">  Platform specific code </h4><br><p>  Sewing the url on which the backend is hanging is not very good, because  want to run on an arbitrary port.  In case of work from the browser, you need to take <code>location.hostname</code> and <code>location.port</code> to determine where the backend is running.  To do this, have a little pee on JavaScript. </p><br><p>  For lovers of defines, there is <code>Q_OS_WASM</code> , but I prefer to move the code into pimpl and separate files.  Pimpl is superfluous here, but I‚Äôll break the code into different files </p><br><p>  Let's get some config </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//config.h #pragma once #include &lt;QtCore/QUrl&gt; class Config { public: static QUrl wsUrl(); };</span></span></code> </pre> <br><p>  and two implementations </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//config.cpp #include &lt;QtCore/QCoreApplication&gt; #include &lt;QtCore/QCommandLineParser&gt; #include "config.h" QUrl Config::wsUrl() { QCommandLineParser parser; QCommandLineOption wsOption(QStringList() &lt;&lt; "u" &lt;&lt; "url" , "WebSocket url" , "url" , "ws://localhost:1234"); parser.addOption(wsOption); parser.process(*QCoreApplication::instance()); return QUrl(parser.value(wsOption)); }</span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//config_wasm.cpp #include &lt;QtCore/QByteArray&gt; #include &lt;emscripten/emscripten.h&gt; #include &lt;emscripten/html5.h&gt; #include "config.h" QUrl Config::wsUrl() { QByteArray buff(1024, 0); EM_ASM_({ var url = "ws://"+ window.location.hostname + ":" + window.location.port + "/ws"; stringToUTF8(url, $0, $1); }, buff.data(), buff.size()); return QUrl(QString::fromUtf8(buff)); }</span></span></code> </pre> <br><p>  It remains to register in the pro file </p><br><pre> <code class="plaintext hljs">wasm { SOURCES += config_wasm.cpp } else { SOURCES += config.cpp }</code> </pre> <br><p>  <code>EM_ASM_</code> is the magic of emscripten that allows you to call JavaScript code from C ++.  Although it could be done without JavaScript </p><br><pre> <code class="cpp hljs">emscripten::val location = emscripten::val::global(<span class="hljs-string"><span class="hljs-string">"location"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> host = QString::fromStdString(location[<span class="hljs-string"><span class="hljs-string">"host"</span></span>].as&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> protocol = QString::fromStdString(location[<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>].as&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;());</code> </pre> <br><h4 id="podderzhka-v-brauzerah">  Browser support </h4><br><p>  Desktop browsers: runs and works in hrome, Firefox, Safari, Edge (here it was necessary to enable the experimental functions of JavaScript).  Depending on the hardware, there may be significant delays in compiling the WebAssembly. </p><br><p>  In Chrome, Andorid can take minutes to compile WebAssembly.  Immediately noticed the lack of support for mobile browsers, namely, there is no calling the system keyboard, when trying to enter text. </p><br><p>  Safari on iOS 12 here the application crashes at the WebAssembly compilation stage and I did not debug.  Theoretically, you can go to asm.js, but this requires a separate study. </p><br><h4 id="qt-quick-webgl">  Qt Quick WebGL </h4><br><p>  The blog positioned as VNC on web sockets with rendering on WebGL.  From Qt WebSockets and Qt <a href="https://doc-snapshots.qt.io/qt5-5.12/webgl.html">dependencies</a> compiled with OpenGL ES 2 support i.  drive on hardware without a GPU will be painful.  To support it, just put <em>Qt WebGL Streaming Plugin</em> in an online installer and run the application with the <code>-platform webgl</code> or <code>-platform webgl:port=80</code> parameter if you need to specify a port. </p><br><p>  But this technology has its limitations: </p><br><ul><li>  delays or notorious input lag; </li><li>  there is no application support on Qt Widgets; </li><li>  lack of sound transmission; </li><li>  one user connection per process i.  In the second tab, no longer go, the preloader will spin. </li></ul><br><p>  I also noticed a drop in fps during StackView animation on transitions between screens.  The dignity of WebGL streaming: </p><br><ul><li>  built-in server; </li><li>  minimum of effort.  I did not have to build Qt from source and rebuild an existing application separately. </li></ul><br><h4 id="sposoby-primeneniya-webassembly-i-webgl-streaming">  Ways to use WebAssembly and WebGL Streaming </h4><br><p>  Alternative to <a href="https://www.webtoolkit.eu/">Wt</a> when there is a ready application in C ++ and you need to fasten a web interface to it.  For example web-interface to torrent rocking. </p><br><p>  Web interface for some smart home.  Not for nothing, in Qt, they delivered MQTT, and on <a href="https://github.com/msorvig/qt-webassembly-examples/">msorvig / qt-webassembly-examples</a> an example of <a href="https://github.com/msorvig/qt-webassembly-examples/tree/master/mqtt_simpleclient">mqtt_simpleclient</a> .  You can have a common UI code that works on the tablet and in the browser. </p><br><p>  The code is available on <a href="https://github.com/RPG-18/qt-wasm-chat-example/tree/master/frontend">GitHub</a> , prepared binaries <a href="https://github.com/RPG-18/qt-wasm-chat-example/releases">in the same place</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/430954/">https://habr.com/ru/post/430954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430942/index.html">Julia. Scripts and parsing command line arguments</a></li>
<li><a href="../430944/index.html">NASA has decided on the participants for its mini-lunar competition.</a></li>
<li><a href="../430948/index.html">Ministry of Communications proposes to tighten control over personal data</a></li>
<li><a href="../430950/index.html">Make Modern Build</a></li>
<li><a href="../430952/index.html">Electric cars and hybrid cars will have to make additional sounds: why is it necessary?</a></li>
<li><a href="../430956/index.html">We learn a pig on monoids to believe in yourself and fly</a></li>
<li><a href="../430958/index.html">We start the container with unit tests in Azure DevOps (VSTS)</a></li>
<li><a href="../430960/index.html">Pro gamedev from the desktop exhibition</a></li>
<li><a href="../430962/index.html">Razor support in Visual Studio Code</a></li>
<li><a href="../430964/index.html">Declarative thinking</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>