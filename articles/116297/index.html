<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create a Wi-Fi hotspot for Linux from a USB modem</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started when I replaced the motherboard in my home computer. The old motherboard had a built-in USB Wi-Fi adapter on a regular Realtek 8187, wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create a Wi-Fi hotspot for Linux from a USB modem</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/cc629e10/5cd88412/ea683a40/ae5fc9d3.jpg" alt="image"><br><br>  It all started when I replaced the motherboard in my home computer.  The old motherboard had a built-in USB Wi-Fi adapter on a regular Realtek 8187, which for two years worked properly as an access point under Windows.  The new Wi-Fi board didn‚Äôt have a module, but I had a whole server on the wonderful Intel Atom 525 with one small drawback - it had very few PCI slots. <br><br>  After a bit of thinking, I decided to do an innocent thing, as I first thought it was to launch a software Wi-Fi access point on a regular USB adapter.  If I had been warned that I was waiting, I would have abandoned the idea from the very beginning!  I got an inexpensive adapter and, only in the process of messing with it, I became aware that using the ‚Äúwrong‚Äù USB on the ‚Äúwrong‚Äù chipset is real violence for Linux!  Linux gurus refused help! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Nevertheless, I managed to make friends Debian 6.0 with the <b>Ralink 2870/3070</b> and <b>Atheros 9170</b> chipsets, and I am ready to reveal this terrible secret to the whole world! <br><a name="habracut"></a><br><br><h4>  Foreword </h4><br>  In recent years, the Wi-Fi system in the Linux kernel has undergone a major refinement.  The idea was very simple - to break the subsystem into modules, put the repeating MAC level procedures into separate kernel modules and separate daemons, and rewrite the drivers of physical devices.  So there was a pack of components, about which you can read on the website of developers: <a href="http://wireless.kernel.org/en/users/Documentation">wireless.kernel.org/en/users/Documentation</a> <br><br>  As it often happens, beautiful theories were exposed to the harsh prose of life.  In our case, it looks like this: for each Ralink 2870/3070 and Atheros 9170 chipset, two versions of the drivers are included in the kernel - ‚Äúold school‚Äù, which work out of the box, but cannot be run in Master mode (mode to start the Access Point) and New "net-link style" that everyone can but do not work out of the box.  By default, mutually exclusive drivers try to run at the same time as the sad result.  But rather complaints, rather for the cause! <br><br><h4>  Run the driver.  Wi-Fi, just Wi-Fi </h4><br>  If you are a regular user and just want to connect to existing Wi-Fi networks, then on Debian 6 (and other similar ubuntarians) you need to do the following: <br><br>  For the RT2870 / 3070 chipset, the popular Dlink DWA-140, TL-WN727N are recommended to leave the old-style rt2870sta driver, to which we don‚Äôt forget to download the firmware. <br><br> <code>apt-get install firmware-ralink wireless-tools</code> <br> <br>  Next, go to /etc/modprobe.d/blacklist.conf and block the launch of new style drivers: <br><br><pre> <code class="bash hljs">blacklist rt2x00usb blacklist rt2x00lib blacklist rt2800usb</code> </pre><br><br>  Then you can connect a USB whistle and carefully look at the dmesg.  If they write about driver conflicts in it, then you are mistaken or have not banned all conflicting drivers.  If it is written about the lack of firmware, then you have no firmware (damn unexpected?).  Type <code>ls -l /lib/firmare</code> should be something like this: <br> <code>-rw-r--r-- 1 root root 8192  6 22:34 rt2561.bin <br> -rw-r--r-- 1 root root 8192  6 22:34 rt2561s.bin <br> -rw-r--r-- 1 root root 8192  6 22:34 rt2661.bin <br> -rw-r--r-- 1 root root 8192  6 22:34 rt2860.bin <br> -rw-r--r-- 1 root root 8192  19 11:46 rt2870.bin <br> -rw-r--r-- 1 root root 4096  4 05:40 rt2870.bin.old <br> -rw-r--r-- 1 root root 8192  28 2009 rt2870.bin.ralink <br> -rw-r--r-- 1 root root 4096  6 22:34 rt3070.bin <br> -rw-r--r-- 1 root root 4096  6 22:34 rt3071.bin <br> -rw-r--r-- 1 root root 8192  6 22:34 rt3090.bin <br> -rw-r--r-- 1 root root 2048  6 22:34 rt73.bin <br></code> <br>  An inquisitive reader probably noticed a trick, we still think about it. <br><br>  For Ar9170 similar procedure.  It contains Dlink DWA-130, 160 as well as TL-WN821N v2, which is very popular in narrow circles.  Netgear WNA1000 got into my hands. <br><br> <code>apt-get install firmware-atheros wireless-tools</code> <br> <br>  Blacklist carl9170 and go! <br><br>  Then we go to / etc / network / interfaces and write something like this: <br><br><pre> <code class="bash hljs">iface wlan0 inet static address 192.168.1.1 netmask 255.255.255.0 network 192.168.1.0 broadcast 192.168.1.255</code> </pre><br><br>  Run <code>ifup wlan0</code> .  Then some kind of graphical utility can connect to the network.  For final configuration, for example, ‚ÄúNetwork manager‚Äù is suitable. <br><br>  If yours, dear habrayuzer already blinked Wi-Fi and nothing more is required, then boldly close the topic. <br><br><h4>  Run the driver.  Strong-willed </h4><br>  So, persistent habrayuzer, despite the skepticism of recognized gurus, we still want to run USB Wi-Fi in the access point mode. <br><br>  First, two simple tips for choosing an adapter: <br><ul><li>  Anything but Realtek! </li><li>  The rest of the chipsets / drivers look in the directory: <a href="http://wireless.kernel.org/en/users/Devices/USB">wireless.kernel.org/en/users/Devices/USB</a> </li></ul><br>  Now cross out all the recommendations from the section "just Wi-Fi"!  90% of blogs on the Internet are filled with this nonsense.  We will disable old-style drivers and run new ones that don‚Äôt work out of the box even in the newest kernel versions, which means it‚Äôs time to compile.  While you are reading this habrastiyu, the developers probably fixed 1-2 bug fixes in the drivers and added a new one, which means downloading the latest version of compat-wireless: <a href="http://www.orbit-lab.org/kernel/compat-wireless-2.6/">www.orbit-lab.org/kernel/compat-wireless-2.6</a> <br><br>  It is compatible with drivers starting from 2.6.14. <br>  Then follow the instructions: <a href="http://wireless.kernel.org/en/users/Download/stable/">wireless.kernel.org/en/users/Download/stable</a> <br>  Everything is compiled for a very long time ignoring the multithreading flag: <br> <code>declare -x CONCURRENCY_LEVEL="4"</code> <br> <br>  After compilation and installation, do not forget to disable the old style in /etc/modprobe.d/blacklist.conf <br><pre> <code class="bash hljs">blacklist rt2870sta blacklist ar9170usb</code> </pre><br><br>  And of course, do not forget to unload previously loaded drivers: <br><pre> <code class="bash hljs">rmmod rt2870sta rmmod ar9170usb</code> </pre><br><br>  New style drivers can be properly unloaded (useful for debugging): <br><pre> <code class="bash hljs">rmmod rt2800usb rmmod rt2800lib rmmod rt2x00usb rmmod rt2x00lib rmmod mac80211 rmmod cfg80211</code> </pre><br><br>  or so: <br><pre> <code class="bash hljs">rmmod carl9170 rmmod ath rmmod mac80211 rmmod cfg80211</code> </pre><br><br><h4>  A terrible secret firmware! </h4><br>  It seems everything.  We are <code>modprobe</code> ... and a complete disappointment!  In the logs again swears on the firmware.  The fact is that the new drivers have other firmware.  For Ralinka, go here: <a href="http://www.ralinktech.com/support.php%3Fs%3D2">www.ralinktech.com/support.php?s=2</a> and download something like RT2870_Firmware_V22. <br>  Unpacking and writing to / lib / firmware, wondering how this file with the same name can be exactly twice as large in size!  The attentive reader has already noted this fact before.  The fact is that a few months ago, the developers merged the drivers for the <b>rt2870</b> and <b>rt3070 chipsets</b> into one.  Without further ado, they called the driver and the firmware on behalf of 2870. Have you seen on the Ralinka page of the firmware 3070?  And I did not see, but it is there!  The DWA-140 adapter is made on the 3070 chipset and is recognized by the rt2800usb drivers. <br><br>  With Ateros a little easier, go to the developers page and download the latest version: <a href="http://wireless.kernel.org/en/users/Drivers/carl9170">wireless.kernel.org/en/users/Drivers/carl9170#Firmware</a> <br><br>  To accurately understand the firmware, we look at what the driver module wants, for example: <br> <code>modinfo carl9170 | grep firm</code> <br> <br>  And then we check that the necessary firmware is: <br> <code>ls /lib/firmware/</code> <br> <br>  Further, already familiar manipulations with rmmod, modprobe and lsmod and hurray!  We raised the right drivers, so it's time to dial the coveted team <br> <code>iwconfig wlan0 mode Master</code> <br> <br>  Bah!  Mistake! <code>SET failed on device wlan0 ; Invalid argument.</code>  Was it all done in vain?  Of course not.  It‚Äôs just that the new subsystem has its own way, and as it often happens with the new and the good, it categorically denies the old and the good.  The forums discuss this issue like this: <br>  - Why? <br>  - RTFM! <br>  - You RTFW!  The sky, the sky did not see such a kyu! <br><br>  The manual tells us that from now on, all settings for the access point are made through the hostapd program: <a href="http://wireless.kernel.org/en/users/Documentation/hostapd">wireless.kernel.org/en/users/Documentation/hostapd</a> <br><br>  We connect the sid repository to Debian (in all the rest hopelessly old versions) and install new utilities for working with fw radio and the hostapd demon <br> <code>apt-getinstall iw hostapd</code> <br> <br>  Then we write <code>iw list</code> and see the cherished Supported interface modes: AP, and along with the list of frequencies. <br><br><h4>  Dancing with a tambourine.  Hostapd </h4><br>  Before you begin configuring the config, you need to know three important things. <br>  1. Inside this demon sits a small and harmful bastard who unpredictably changes the state of the interface during startup / restart.  Sometimes wlan0 disappears, sometimes its IP disappears, sometimes ifdown ifup helps, sometimes it doesn't help.  Ralink in such conditions is very bad, Ateros is a bit more stable.  Therefore, before any launch of hostapd, we check that the radio interface is up and its IP address is alive.  If you can‚Äôt raise the interface, then we use violence - we rebuild Linux!  (Yes, yes, this is not a joke!) <br><br>  2. All settings are first checked without encryption!  And do not forget to check dhcpd, who also likes to die when restarting interfaces.  That's why Linux + USB = hate!  It is better to set up hostapd without dhcp, with a fixed IP address on the client, and only at the end go to setting up dhcpd. <br><br>  3. To check, always first run <code>hostapd -d /etc/hostapd/hostapd.conf</code> with diagnostics in the console. <br><br>  Now the config hostapd with explanation.  (Update: corrected comments, # does not work at the end of the line) <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   interface=wlan0 #    driver=nl80211 #      nl80211,     #     ssid=MyNet #       country_code=RU #     12-14,  JP (      Wi-Fi),      . #   wi-fi. Hostapd  7+    N hw_mode=g #  , 1   ,   11  channel=9 #  ! auth_algs=1 logger_syslog=-1 logger_syslog_level=3 logger_stdout=-1 logger_stdout_level=2 ignore_broadcast_ssid=0 #  WPA2, : wpa=2 wpa_key_mgmt=WPA-PSK wpa_passphrase=VeryLongPassword rsn_pairwise=CCMP #  WPA, wpa=1 wpa_pairwise=TKIP #   8 </span></span></code> </pre><br>  After launch, first of all, type in <code>ifconfig</code> and see that a special interface has appeared. <br> <code>mon.wlan0 Link encap:UNSPEC HWaddr 30-46-9A-00-6D-04-00-00-00-00-00-00-00-00-00-00 <br> UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 <br> RX packets:42603 errors:0 dropped:0 overruns:0 frame:0 <br> TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 <br> collisions:0 txqueuelen:1000 <br> RX bytes:3887500 (3.7 MiB) TX bytes:0 (0.0 B) <br></code> <br>  Now in the console (if you run hostapd -d), we see what happens during the authentication process.  If WPA is configured and the connection does not go beyond phase 2/4, the password is mistakenly typed.  There you can still see a lot of incomprehensible messages. <br><br><h4>  Lyrical digression </h4><br>  It so happened that while picking on hostapd I lost all hope of launching my <b>Dlink DWA-140</b> on the <b>Ralink 3070</b> chipset.  I definitely managed to launch it without encryption, but when encryption was turned on, either I made a mistake, or indeed this module badly interacts with nuclear encryption modules (I saw the problem description on the forums and one of the versions of the solution pointed to the ecb and arc4 encryption modules . <br><br>  I already implemented the final chord with encryption enabled on the <b>Netgear WNA1000</b> on the <b>Atheros 9170</b> chipset, which really works better and correctly loads all the encryption modules. <br><br>  Now I think that it was possible to launch Ralink with encryption and urge to put a bold end to the question of the happy owners of DWA-140.  Write about your successes or problems in the comments, try to understand together. <br><br><h4>  Instead of epilogue </h4><br>  Now we have a small server with a USB Wi-Fi adapter buzzing quietly in the closet or on the closet, you can enjoy the work done.  But it was not there!  In a modern high-rise building with access points packed with access points from all sides, there are noises.  To select a channel, I advise you to explore the broadcast program <a href="http://www.metageek.net/products/inssider/">InSSIDer</a> <br><br>  This is what the channel selection looked like in my evening at the window: <br><br><img src="https://habrastorage.org/storage/8922597a/13b372d2/ca9dfddb/f80d3742.png" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/116297/">https://habr.com/ru/post/116297/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116288/index.html">Rails 3 and SproutCore</a></li>
<li><a href="../116290/index.html">How to build an open source community</a></li>
<li><a href="../116291/index.html">10 facts about lemmings, which you did not even know</a></li>
<li><a href="../116293/index.html">Kimball University: 10 basic rules for multidimensional modeling</a></li>
<li><a href="../116294/index.html">Tracking memory leaks in Android applications</a></li>
<li><a href="../116298/index.html">We organize view models in ASP.NET MVC</a></li>
<li><a href="../116299/index.html">Google Launches AdWords Video Player</a></li>
<li><a href="../116300/index.html">Where do NaNs come from?</a></li>
<li><a href="../116301/index.html">Interpreter from gateways</a></li>
<li><a href="../116305/index.html">As I watched Formula 1 on the BBC live via the Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>