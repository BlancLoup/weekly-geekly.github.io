<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transition to PHP 5.5 and unit tests</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="4 years have passed since the transition from PHP 4.4 to PHP 5.3 to Badoo, it‚Äôs time to update PHP, this time right away to PHP 5.5. In addition to ne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transition to PHP 5.5 and unit tests</h1><div class="post__text post__text-html js-mediator-article">  4 years have passed since the transition from PHP 4.4 to PHP 5.3 to Badoo, it‚Äôs time to update PHP, this time right away to PHP 5.5.  In addition to new features, the new version of PHP once again brought us a significant increase in performance, so we had many reasons for the upgrade.  In this article, we will talk about how we switched to PHP 5.5, what ‚Äúrakes‚Äù we collected, and why we once again rewrote our system to run unit tests based on PHPUnit. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/acb/906/de3/acb906de3aa914ea7d207b60e62c7d75.png"></div><br>  <i>Figure 1. General Architecture</i> <br><br><h3>  "Rakes" in the transition from PHP 5.3 to PHP 5.5 </h3><br>  Last time, we switched from the fourth version of PHP to the fifth, and our version of PHP 5.3 contained patches to <code>$a = &amp;new ClassName();</code> ‚Äúold‚Äù PHP syntax, for example, <code>$a = &amp;new ClassName();</code>  , and so that our codebase can work on PHP4 and PHP5 at the same time.  This time we did not have such restrictions, so during the transition we simply found and replaced all outdated constructions with more relevant ones, and the rewriting of the code was completed with this. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main problems that we have: <br><ul><li>  part of the deprecated-language feature has been removed; </li><li>  the <i>mysql</i> extension has become <i>deprecated</i> ; </li><li>  poor performance of the runkit extension, which we use when writing unit tests. </li></ul><br><br>  After switching to PHP 5.5, our unit tests began to take place much longer (several times), so we decided to once again refine our ‚Äúlaunch-board‚Äù to solve this problem. <br><br><a name="habracut"></a><br><h3>  Runkit and PHP 5.4+ </h3><br>  With the help of the xhprof extension, we quickly found out that our tests are ‚Äúslowing down‚Äù due to the fact that the performance of the runkit extension has dropped significantly, so we began to look for the cause.  As a result, it turned out that the problem seems to be <a href="https://github.com/zenovich/runkit/commit/1a3af5e09ff6a867b7778d2c9652c1297eeb2ddb">in adding a ‚Äúmystical‚Äù runtime cache</a> for PHP 5.4, which needs to be reset every time after calling the ‚Äúrunkit _ * _ redefine‚Äù function. <br><br>  Each runkit extension traverses all registered classes, methods, and functions and flushes this cache.  We naively tried to disable it, but after that PHP began to fall, so we had to find another solution. <br><br><h3>  The concept of "microsites" (microsuite) </h3><br>  Before switching to PHP 5.5, we already had unit test launches as an add-on for phpunit, which divided one large suite of unit tests into several smaller ones: at that time we used test launches in 11 streams (Ilya Kudinov already talked about this on conferences, including at Badoo LoveQA: <a href="http://www.youtube.com/watch%3Fv%3DgAisPsfbLkg">www.youtube.com/watch?v=gAisPsfbLkg</a> ). <br><br>  We spent a few simple benchmarks and found out that tests pass several times faster if we divide our suite not into 11 parts, as it was before, but 128 or more (with a fixed number of processor cores).  In each suite, there were only about 10-15 files, so we called this concept "microgroups".  We have about 150 such microwells, and each of them was suspiciously well suited to be a ‚Äútask‚Äù for some kind of script (the task consists of a list of files for the corresponding suite, and it, in turn, runs phpunit with the appropriate parameters ). <br><br><h3>  Tests "in the cloud" </h3><br>  It so happened that the author of this article has no relation to QA, but was one of the main developers of the ‚Äúnew scripting framework‚Äù, which, in fact, is a ‚Äúcloud‚Äù for scripts and supports the concept of tasks (about our cloud, we also told at conferences and be sure to tell you more about it in Habr√©).  And since we have tasks in the form of file lists for each phpunit suite, it means that they can also be ‚Äúthrust into the cloud‚Äù, which we decided to do.  The idea is very simple: since we have many small tasks, they can be run on several servers independently of each other, which should further speed up the passing of tests. <br><br><h4>  Common architecture </h4><br>  We run tests from several different sources: <br><ol><li>  automatic test runs with <a href="http://habrahabr.ru/company/badoo/blog/169417/">AIDA</a> : <br>  - on the branch (git branch) of the task; <br>  - by "build" - the code that will go to production; <br>  - on the master branch; </li><li>  ‚ÄúManual‚Äù test runs initiated by developers or testers from a dev server. </li></ol><br><br>  All these types of test runs combine what you need to first ‚Äúfetch‚Äù (fetch) a branch from some source, and then start running the tests on this branch. <br>  This fact determined the architecture of our new "cloud" test (Fig. 1, at the beginning of the article): <br><br>  First, one task is created for the master process, which: <br><ul><li>  selects the available directory in the database (Fig. 2); </li><li>  downloads the git branch from the right place (shared repository or dev server); </li><li>  (optional) performs git merge master; </li><li>  (optional) creates a new commit with all local changes. </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5e3/863/a66/5e3863a666435db4d619c097e889a27f.png"></div><br>  <i>Figure 2. Available directories in MySQL</i> <br><br>  After that, the master process analyzes the original phpunit suite to run the tests and divides it into the required number of parts (no more than 10 files per microsuite).  The resulting tasks (thread-processes) are added as tasks to the cloud and begin execution on servers available for execution. <br><br>  The first task, which gets to the new server, prepares the selected directory for the test run, taking the desired commit from the server on which the master process is running.  In order for all other tasks that fell on the corresponding server not to do the same at the same time as the first task, file locks are used (Fig. 3). <br><br>  At the same time, there can be several runs of tests for more complete utilization of the resources of our cluster: tests pass quickly, and the preparation of source texts takes up much of the time rather than directly executing code. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/618/147/a7f/618147a7fbfca4f7f49704cb456f2b43.png"></div><br>  <i>Fig.</i>  <i>3. Locks during directory preparation</i> <br><br>  Some tests can go much longer than the others, and we have statistics on the passing times for each test, so we use this information to run the ‚Äúlong‚Äù tests first.  This strategy allows you to achieve a more even load on the servers during the execution of tests, as well as to reduce the overall time for their execution (Fig. 4). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ccd/b98/39e/ccdb9839e041f4a410ad13c80a150204.png"></div><br>  <i>Figure 4. Accounting test execution time</i> <br><br>  ‚ÄúIn good weather, our entire suite of 28,000 unit tests passes in 1 minute, so tests that last longer become a bottleneck, and our system posts the authors of the corresponding tests to the board of shame, which is shown at each test run.  In addition, if there are few tests left, a list of those who stayed is shown (Fig. 5). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9be/46e/2b1/9be46e2b18bde9d6f2dafc414cee826c.png"></div><br>  <i>Figure 5. Board of shame: a list of tests that are performed for more than a minute</i> <br><br>  In itself, the launch of unit tests was the first script that was transferred to the cloud.  It helped eliminate a lot of bugs and flaws in the cloud, at the same time significantly speeding up the passage of unit tests. <br><br><h4>  results </h4><br>  After switching to PHP 5.5, we were able to use new language features, significantly reduced CPU consumption on our servers (on average by 25%), and also transferred our unit tests to the cloud.  The latter allowed us to reduce the total time for passing the tests from 5-6 minutes (for PHP 5.5 - tens of minutes) to one minute, at the same time moving the load from the common dev-server to the cloud. <br><br>  <i>Yuri <a href="https://habrahabr.ru/users/yourock/" class="user_link">youROCK</a> , developer of badoo</i> </div><p>Source: <a href="https://habr.com/ru/post/220211/">https://habr.com/ru/post/220211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220199/index.html">C ++ User Group, meeting in Nizhny Novgorod</a></li>
<li><a href="../220201/index.html">Dell Venue 11 Pro: a powerful tablet with room for growth</a></li>
<li><a href="../220203/index.html">(Self) processor identification. Part one. Architecture Comparison</a></li>
<li><a href="../220205/index.html">The second reading adopted a bill tightening the requirements for the transfer of electronic money</a></li>
<li><a href="../220207/index.html">How we do Convead: from concept to implementation - part 1</a></li>
<li><a href="../220213/index.html">Welcome to Skyforge closed beta.</a></li>
<li><a href="../220215/index.html">We disassemble Sony Xperia Z2, the new flagship with an unusual cooling system</a></li>
<li><a href="../220219/index.html">We distribute 500K to the organization of circles of robotics</a></li>
<li><a href="../220225/index.html">HackDay City: from idea to prototype project for a city in 48 hours!</a></li>
<li><a href="../220227/index.html">What gets into deny ip any any?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>