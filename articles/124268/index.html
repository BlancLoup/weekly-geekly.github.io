<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart switches based on the 8051 core, controlled by Ethernet, Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear habrovchane! 
 The developed device repeats something IRemo: Tap , as well as some other analogues, which was already written on habrah...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart switches based on the 8051 core, controlled by Ethernet, Part 1</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear habrovchane! <br>  The developed device repeats something <a href="http://habrahabr.ru/blogs/gadgets/118437/">IRemo: Tap</a> , as well as some other analogues, which was already written on habrahabr.  My version will be simpler and cheaper.  For communications, I chose the usual twisted pair, and to control the device will have its own web page. <br>  This article describes the first stage - the creation of "brains" for the future project. <br><a name="habracut"></a><br><br><h4>  So stage number zero </h4><br>  It is always easier to break the development of complex things into simple "bricks".  This is called the scientific principle of modularity.  So for a start we will think, and we will break our idea into blocks.  Globally, in the entire instrument, I identified 3 main modules: a control unit, a switching unit, and a power supply unit. <br><br>  This article focuses on the control unit, which will work as a web server, as well as receive and process web forms with requests.  And now we sit down and draw a block diagram of the developed module over a cup of cola: <br><img src="https://habrastorage.org/storage1/35862ebe/79a416bf/81005eac/4604dd7a.jpg"><br>  Decoding notation is as follows: <br><ul><li>  Power supply unit, </li><li>  Control unit, </li><li>  Kn n-th switching node (our device realizes only switching off and inclusion of light). </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  The first brick. </h4><br><h5>  First stage. </h5><br>  Development of the first brick we begin with the choice of the element base.  After familiarizing myself with the microcircuits available on the territory of Ukraine, I chose the C8051F340-GQR microcontroller (64kb flash, 4kb RAM, 10-bit ADC, a crossbar allowing to configure the UART, ADC and SPI to any processor ports, USB, 48 MHz clock frequency from the built-in source, temperature sensor) as a ‚Äúbrain‚Äù of the project and the CP2200-GQR chip as an ezernet controller, which will provide us with a speed of up to 10 Mbps (which is enough for us with our head).  Both ICs exist in TQFP-48 packages for surface mounting.  More detailed specifications in datasheets <a href="http://www.silabs.com/Support%2520Documents/TechnicalDocs/C8051F340_short.pdf">C8051F340</a> and <a href="http://www.silabs.com/Support%2520Documents/TechnicalDocs/CP2200.pdf">CP2200</a> . <br><br>  Of the remaining components, in the first stage, we need an Ethernet connector with a 1: 1 transformer, preferably integrated into the connector itself.  I chose HR911105A. <br><br><h5>  Second phase. </h5><br>  Excellent microcircuits are mined (the controller had to run for an ezernet, there is an analogue of the CP2201 but it is in the QFN-28 package, and it is a bit difficult to solder it).  At this stage we will create a schematic diagram. <br>  Here is what I got (clickable image): <br> <a href=""><img src="https://habrastorage.org/storage1/463a7a77/e089d417/76007750/a3009a89.jpg"></a> <br><br>  Now some explanations: <br><ol><li>  Let's start with connections mk and CP2200.  The situation is greatly simplified due to the presence of an EMIF (External Memory Interface) interface on board for both microcircuits, because in fact the CP2200 is a heaped memory.  Byte P3 transmits the address, byte P4-data, also bits P1.7 \ not WR when set to 0, the microchip understands what we write to it at the specified address, and when setting the bit P1.6 \ not RD reads accordingly.  The connection is taken from the datasheet; also the R1-8 resistors are small enough and have a nominal value of 1 KŒ©, and pull up the pins to the value of a logical unit.  Their presence is not required. <br>  Other pins: <br><ul><li>  P0.2 \ INT-clocking signal, after setting to 1 IC will begin processing our request </li><li>  P0.0 \ RES reset signal </li><li>  P0.1 \ CS-chip selection, as it turned out later, could also not be diluted. </li></ul></li><li>  Also pay attention to the quartz resonator Q2; it has a nominal value of 20.000 MHz, its presence is obligatory (Q1 can be omitted). </li><li>  With the connection of the ethernet connector, too, there are no difficulties, the entire connection is also taken from the datasheet.  R14, R14, C16, C17 low pass filter (face values ‚Äã‚Äãare listed at the bottom of the article). </li><li>  I also did not forget about yusb.  By closing X1.1 and X1.2 you can get power from your own using the internal voltage regulator mic, but alas, you will not provide power to the CP2200 chip (the output current is up to 100mA, the requirements of CP2200 are up to 122mA during transmission). </li><li>  A LED is connected to X6, which simply glows and signals the presence of power, a transistor switch based on the BC847 transistor, a control pin P2.7 is connected to X8, you can connect an LED here.  It helped a lot when debugging firmware. </li><li>  At X4, 3.3V is supplied.  On X2, you can also apply 5V for powering different flash drives and other devices in the mode when the master mode.  X3 ports programmer C2.  The remaining pins are connected to connector X5. </li></ol><br><h5>  The third stage. </h5><br>  Created a schematic diagram divorced.  There should be no problems.  Since I printed the boards at the factory ( <a href="http://www.elektronmash.kiev.ua/">DNVP Elektronmash</a> ), I chose the scheme from 2 sides (the upper right corner remained empty, so I drilled holes there, it turned out a sort of piece of the breadboard). <br> <a href=""><img src="https://habrastorage.org/storage1/6b577594/fcb5c0c7/60c81f1c/49ad751d.jpg"></a> <br>  Well, and then we export everything to the Gerber format (the drawing of the board, each side is in its own file), the holes are saved in the NC drill format. <br>  <s>If you do not have a license altium, do not forget to remove all references to software from gerber files, otherwise you will be divorced for a fine (there were precedents).</s>  If possible, use the licensed software. <br>  Get paid, collect: <br>  Top: <br> <a href=""><img src="https://habrastorage.org/storage1/41201c87/00e50200/ae947f84/f644a494.jpg"></a> <br>  Bottom: <br> <a href=""><img src="https://habrastorage.org/storage1/261707f5/397d37a7/24dd0728/846f45f4.jpg"></a> <br>  The abundance of wires is due to the fact that I did not know what programmer would be used, it was supposed to initially supply power and data from the programmer, but alas, I made a couple of errors when setting up the programmer and it did not work.  Therefore, it was brought to the connector used (at the same time, the model part was useful). <br><br><h5>  Fourth stage. </h5><br>  Without a description of all the parts, I‚Äôll not give the firmware code yet, but we‚Äôll flash there a standard example from Silabs.  There is only one problem; all the examples are sharpened for the Silbov debugging module, with the prefix CP2200DK.  The differences here are only in the control pins, so open the file main.c <br>  We are looking for the function void PORT_Init (void) change its code to: <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PORT_Init</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ IT01CF = <span class="hljs-number"><span class="hljs-number">0x02</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Enable Interrupt 0 on P0.3 TCON &amp;= ~0x01; // Make /INT0 level triggered XBR1 = 0x40; // Enable crossbar and enable // weak pull-ups P0MDOUT |= 0x10 | 0x1F; // enable UTX as push-pull output P1MDOUT |= 0xD8 | 0xFF; // /WR and /RD are push-pull P2MDOUT |= 0xFF; P3MDOUT |= 0xFF; P4MDOUT |= 0xFF; }</span></span></code> </pre> <br>  Find the function void ether_reset_low () change to: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ether_reset_low</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ P0 &amp;= ~<span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Pull reset low }</span></span></code> </pre><br>  We do the same with void ether_reset_high (): <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ether_reset_high</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ P0 |= <span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Allow /RST to rise while(!(P0 &amp; 0x01)); // Wait for /RST to go high }</span></span></code> </pre><br>  Open mn_userconst.h <br>  install ip address: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> IP_SRC_ADDR { 192, 168, 0, 6 }</span></span></code> </pre><br>  in void main () <br>  after port_init (); <br>  add <br><pre> <code class="cpp hljs">P0 &amp;= ~<span class="hljs-number"><span class="hljs-number">0x02</span></span>;<span class="hljs-comment"><span class="hljs-comment">//Cs=0</span></span></code> </pre><br>  Next, go to VFILE_DIR <br>  rule index.html <br>  We execute update.bat. <br>  Thus, a standard array of hex values ‚Äã‚Äãwill be made from index.html. <br>  Compile, collect into a hex file, assign a computer an ip address on the same network and flash it. <br>  Pinging: <br><img src="https://habrastorage.org/storage1/f3111ca1/ed3aaa5a/749786b5/36c3e3e7.jpg"><br>  Well, go look at the result: <br><img src="https://habrastorage.org/storage1/2a98adba/0e907c9b/981591a9/6540e4cf.jpg"><br>  If we do not ping, we check the cable, the program code, and if it‚Äôs really bad, we go to our friends, we take an oscillograph and debass. <br><br><h5>  References: </h5><br><ol><li>  A reworked example, as well as drawings of the board of altium format (10th version) and a list of elements in pdf format: <br><ul><li>  <a href="http://depositfiles.com/files/b67s7tqng">Materials</a> </li></ul></li><li>  Datasheets (technical documentation): <br><ul><li>  <a href="http://www.silabs.com/Support%2520Documents/TechnicalDocs/C8051F34x.pdf">C8051F34x full description</a> </li><li>  <a href="http://www.silabs.com/Support%2520Documents/TechnicalDocs/CP2200.pdf">CP2200</a> </li><li>  <a href="http://www.smd.ru/files/upload/1253/ru/bc846_bc847_bc848_4.pdf">Npn bc847 transistor</a> </li><li>  <a href="http://www.electrosnab.ru/silabs/pdf/RUS/An237rus.pdf">Description of the library with a closed source code that implements the TCP / IP stack from SiLabs</a> </li></ul></li></ol><br>  Continued in the following articles. <br><br>  I thank my friends for the help in creating the device and the article. </div><p>Source: <a href="https://habr.com/ru/post/124268/">https://habr.com/ru/post/124268/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124263/index.html">Automatic installation of FreeBSD 8.2-RELEASE on ZFS</a></li>
<li><a href="../124264/index.html">Mail-en agent in Linux</a></li>
<li><a href="../124265/index.html">Microsoft opened its social service?</a></li>
<li><a href="../124266/index.html">Using Zend GData in a symfony2 project</a></li>
<li><a href="../124267/index.html">XSS vulnerability in Skype</a></li>
<li><a href="../124269/index.html">In the information systems of the Presidential Administration of the Russian Federation do not accept odf</a></li>
<li><a href="../124270/index.html">Haskell in the present project</a></li>
<li><a href="../124271/index.html">Parallel generation of plt files for Dialyzer (with depes and buns)</a></li>
<li><a href="../124272/index.html">Do business incubators in Russia need and what are they eating with ?!</a></li>
<li><a href="../124273/index.html">Ur internet personalization or my personal internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>