<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Relap.io is organized - a service that issues 30 billion recommendations per month</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have not written anything for a long time in our blog and come back with a story about our new project: Relap.io (relevant pages). 

 We launched t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Relap.io is organized - a service that issues 30 billion recommendations per month</h1><div class="post__text post__text-html js-mediator-article"><br>  We have not written anything for a long time in our blog and come back with a story about our new project: <a href="https://relap.io/">Relap.io</a> (relevant pages). <br><br>  We launched the <a href="https://relap.io/">Relap.io</a> B2B B2B service a year and a half ago.  It makes life easier for editors and media readers.  On weekdays, <a href="https://relap.io/">Relap.io</a> serves 15 million <a href="https://relap.io/">unique users</a> and issues 30 billion recommendations per month. <br><br>  Now <a href="https://relap.io/">Relap.io is the</a> largest recommendation platform in Europe and Asia. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/f7c/4c3/85a/f7c4c385a4b524e20ee1b83d9dfc6e1b.png" alt="image"><br><a name="habracut"></a><br><br><h4>  <b>Why do <a href="https://relap.io/">you</a> need <a href="https://relap.io/">Relap.io</a></b> <b><br></b> </h4><br>  Depending on the user's behavior, we select articles that will be of interest to him.  It looks like the ‚ÄúRead also‚Äù block or ‚ÄúIt will be interesting for you‚Äù: <br><br>  Now <a href="http://ria.ru/">RIA Novosti</a> , <a href="http://www.adme.ru/">AdMe</a> , <a href="http://coub.com/">COUB</a> , <a href="https://tjournal.ru/">TJournal</a> , <a href="http://lifehacker.ru/">Layfhaker</a> and other media use the service.  <a href="https://relap.io/">Relap.io</a> widgets <a href="https://relap.io/">are</a> installed on more than 1000 sites.  50 of them are millionaires (1 million or more unique visitors per day). <br><br>  <a href="https://relap.io/">Relap.io</a> started with a simple beta.  We took Surfingbird recommender algorithms and adapted them for third-party sites. <br><br><h4>  <b>What is <a href="https://relap.io/">Relap.io</a> made of</b> <b><br></b> </h4><br><br><img src="https://habrastorage.org/getpro/habr/post_images/2bc/35c/4dd/2bc35c4dd1e0ce54012d776696e8874c.jpg" alt="image"><br><br>  Every second, 15,000 http requests are <a href="https://relap.io/">sent</a> to the <a href="https://relap.io/">Relap.io</a> servers from users.  Of them: <br><ul><li>  10K static: images for widgets, styles, static js. </li><li>  5K dynamics: the collection of signals that form the training set and the formation of blocks of recommendations. </li></ul><br><br><br>  <b>When we created the architecture, we had 2 requirements:</b> <br><ul><li>  it must withstand high loads; </li><li>  to scale. </li></ul><br><br>  Backends are two servers with a large amount of memory and bulk SSDs in RAID1.  They are PostgreSQL fresh version, on one server - the master, on the second - the slave. <br><br>  Workhorses - server more modest.  They accept requests from the outside world.  Two of them are Nginx-s, which are balanced with each other just by DNS.  They scatter requests.  They are caught by pearl barley FCGI workers. <br><br>  The FCGI application is designed in such a way that the failure of PostgreSQL does not lead to an instantaneous failure of the entire service, we have about 10 minutes to fix fatal problems.  Even if the automatic switch to the replica did not save the situation. <br><br>  The same servers also perform other roles - most of the queues running on them that execute offline everything that can be done offline;  memcached and redis instances, cron scripts. <br><br>  Stand alone are the servers that form recommendations.  For all but the team of mathematicians, this is more or less a black box.  There, the FCGI and the queues throw data, and in response they insert into PostgreSQL fresh recommendations, calculated using different algorithms, for each active link in the database.  Keywords - Hadoop, Spark, Elasticsearch as a stack, a thick layer of Java. <br><br>  It only remains for the code to pick up the finished one, apply some filtering.  We try to make it minimal and filter it at the generation and sorting stage. <br><br>  All that can be hung with caches.  PostgreSQL cache in memory, disk cache, memory card or redis, where it is more convenient, several types of caching right inside the process. <br><br><h4>  <b>Why is that so?</b> </h4><br>  PostgreSQL is the most comprehensive open-source database.  Predictable, stable, popular.  Nginx - much better withstand load scaling than Apache. <br><br>  MySQL or Apache is more popular, but it seems to us that you can choose them for new projects only on shared hosting, where there is nothing else.  Or if you know how to prepare and scale them very well. <br><br>  You can choose shared hosting for a new project only if you know in advance that growth does not threaten it.  Then the technology should be chosen according to the principle ‚Äúand with what knowledge I will find the cheapest and fastest people‚Äù - most likely, people with knowledge of PHP, MySQL and Apache.  A closed world of projects on shared-hosting. <br><br>  Hadoop was taken because the team had no particular experience with any of these solutions.  And this is a standard in the processing of big data.  Here we just followed everyone. <br><br>  We also needed a separate data storage for Hadoop, but PostgreSQL didn't work.  For this we have chosen, oddly enough, Elasticsearch, at the same time having received full-text search and the ability to build algorithms using it.  However, this was the wrong decision.  It can quickly index everything and find, but not give away large amounts of data. <br><br>  In the next series we will tell how we solved this problem. <br><br><h4>  <b>Where is <a href="https://relap.io/">Relap.io</a> hosted</b> </h4><br>  With the growth of the load, we faced the problem of choosing a reliable hosting provider.  Now we are hosted on Servers.com.  They are powerful enough to withstand a load of 900,000 requests per minute.  This is not a peak load, but a normal state on weekdays. <br><br>  Last year we changed data center several times.  First was DC Slavic.  Surfingbird.ru is still hosted there. <br><br>  Then in March 2015 moved to Hetzner.  Then we issued 2K recommendations per second.  The last move to Servers.com was 6K per second.  Now 15K. <br><br><h4>  <b><a href="https://relap.io/">Relap.io</a> integration to the site:</b> </h4><br>  <b>As widget</b> <br>  Boxed solution.  The user puts our code in the head of the page on which the widget should be.  Selects the type of widget and collects the design in the built-in constructor.  The formation of recommendations and the frontend is completely on our side.  So most sites are connected to <a href="https://relap.io/">Relap.io</a> .  For example, Layfhaker. <br><br>  <b>Via jsonp api</b> <br>  The site receives a description of our api.  We give a large package of recommendations, and the site filters them already on its side and inserts them into the design.  Integration via JSONP API allows you to use custom elements: a historical number of views, likes, and any other information about the link.  In this way, for example, AdMe or COUB are connected to Relap.io. <br><br>  In subsequent articles, we will talk in detail about technologies, machine learning algorithms and service infrastructure.  Ask questions in the comments - be sure to answer them in the following publications. </div><p>Source: <a href="https://habr.com/ru/post/277559/">https://habr.com/ru/post/277559/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277537/index.html">Vision-based SLAM: monocular SLAM</a></li>
<li><a href="../277539/index.html">Yelp, Wunderlist and GIPHY introduced new type applications</a></li>
<li><a href="../277541/index.html">Another approximation by polynomial of a function of several variables</a></li>
<li><a href="../277543/index.html">Clean code architecture and development through testing in PHP</a></li>
<li><a href="../277545/index.html">Game design f2p games or how not to make mistakes</a></li>
<li><a href="../277563/index.html">Word2Vec: classification of text documents</a></li>
<li><a href="../277565/index.html">Framer Animation for Beginners</a></li>
<li><a href="../277567/index.html">Windows 10 application with data in the cloud using Azure Mobile Apps</a></li>
<li><a href="../277569/index.html">Battle for sound speed on Android x86</a></li>
<li><a href="../277571/index.html">Security Week 07: Apple vs. FBI, global glibc vulnerability, crypto-fiber and medicine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>