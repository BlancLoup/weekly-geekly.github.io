<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Data migration from MySQL to PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you work with databases, get acquainted with their pros and cons, there is a moment when a decision is made to migrate from one DBMS to another. In...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Data migration from MySQL to PostgreSQL</h1><div class="post__text post__text-html js-mediator-article">  As you work with databases, get acquainted with their pros and cons, there is a moment when a decision is made to migrate from one DBMS to another.  In this case, the problem arose of migrating services from MySQL to PostgreSQL.  Here is a small list of goodies that are waiting for the transition to PostgreSQL, version 9.2 (a more detailed list of features can be found <a href="http://www.postgresql.org/about/featurematrix/">here</a> ): <br><ul><li>  <a href="http://www.postgresql.org/docs/9.2/static/ddl-inherit.html">table inheritance</a> (there are restrictions that promise to fix in the future) </li><li>  <a href="http://www.postgresql.org/docs/9.2/static/rangetypes.html">ranges</a> : int4range, numrange, daterange </li><li>  support out of the box several languages ‚Äã‚Äãfor stored functions (PL / pgSQL, PL / Tcl, PL / Perl, PL / Python and bare C) </li><li>  <a href="http://www.postgresql.org/docs/9.2/static/queries-with.html">WITH</a> clause allowing recursive queries </li><li>  <i>(planned)</i> materialized views (in part they are available now - as IUD rules for the presentation) </li><li>  <i>(planned)</i> trigger on DDL operation </li></ul><br>  As a rule, existing solutions rely on working with a ready-made SQL dump, which is converted in accordance with the syntax of the target database.  But in some cases (an actively used web application with a large amount of information), this option incurs certain time costs for creating a SQL dump from a DBMS, converting it, and loading the resulting dump back into the DBMS.  Therefore, the online option (straight from the DBMS to the DBMS) of the converter will be more optimal, which can significantly reduce downtime services. <br><a name="habracut"></a><br>  C ++ was chosen as the language for implementation (with some capabilities from C ++ 11x), libraries for connecting with MySQL and PostgreSQL were used native, Qt Creator was used as the IDE. <br><br>  The migration algorithm is as follows.  It is understood that the table structure has already been created in the recipient database, corresponding to the structure in the source database.  A list of tables for data transfer is formed, which is then distributed in the thread pool.  Each stream has a connection to the source database and the recipient database.  Those.  parallel transferred several tables.  Profit! <br><br>  Traditionally, any application has a framework - a set of system components that rely on other components - working with a configuration file, a log, an error handler, a memory manager, and so on.  In our case, only the most necessary to solve the problem is used.  First, some fundamental and composite types were redefined (for convenience only) (yes, I know, it was possible to <b>use Alias ‚Äã‚Äãtemplates</b> , but it turned out like this): <br><div class="spoiler">  <b class="spoiler_title">simple types</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> t_bool; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> t_char; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> t_uchar; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> t_schar; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t_int; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t_uint; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> t_float; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> t_double;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">map</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> U&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CMap</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>&lt;T, U&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: CMap(); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~CMap(); }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> U&gt; CMap&lt;T, U&gt;::CMap() { } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> U&gt; CMap&lt;T, U&gt;::~CMap() { }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">vector</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CVector</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: CVector(); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~CVector(); }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; CVector&lt;T&gt;::CVector() { } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; CVector&lt;T&gt;::~CVector() { }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">fstream</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CFileStream</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::fstream { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: CFileStream(); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~CFileStream(); };</code> </pre></div></div><br>  From explicit patterns, only singleton was used: <br><div class="spoiler">  <b class="spoiler_title">classic singleton mayers</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CSingleton</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> T* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">free</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: CSingleton(); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~CSingleton(); }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; T* CSingleton&lt;T&gt;::instance() { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> T *instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> T(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CSingleton&lt;T&gt;::<span class="hljs-built_in"><span class="hljs-built_in">free</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; CSingleton&lt;T&gt;::CSingleton() { } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; CSingleton&lt;T&gt;::~CSingleton() { }</code> </pre></div></div><br>  The base classes for the task (performed in a separate thread) and the system (starts the task execution): <br><div class="spoiler">  <b class="spoiler_title">task.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CTask</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: CTask(); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~CTask(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">t_uint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">taskID</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">t_bool </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isExecuted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: t_uint m_task_id; t_bool m_executed; };</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">task.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs">CTask::CTask() : m_executed(<span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> t_uint task_id = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_task_id = task_id++; } CTask::~CTask() { } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CTask::execute() { executeEvent(); m_executed = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } t_uint CTask::taskID() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_task_id; } t_bool CTask::isExecuted() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_executed; }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">system.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CSystem</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: CSystem(); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~CSystem() = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CTask *task)</span></span></span></span>; };</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">system.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs">CSystem::CSystem() { } CSystem::~CSystem() { } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CSystem::executeTask(CTask *task) { CTask&amp; task_ref = *task; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">thread </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">thread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([&amp;]() { task_ref.execute(); })</span></span></span></span>; thread.detach(); }</code> </pre></div></div><br>  At the end of the consideration of the basic types, you need to mention the class of the string that you had to write from scratch, so that for some operations (substring replacement and concatenation) you could work with the transferred buffer (about it just below) without additional memory allocations and some things (converting the string to and numbers in strings) make members of the class (only the class declaration is given) <br><div class="spoiler">  <b class="spoiler_title">string.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CString</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: CString(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> t_char *data = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); CString(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s); ~CString(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> t_char* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ptr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setPtr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t_char *p)</span></span></span></span>; CString&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>= (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s); CString <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>+ (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> t_char *p) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; CString <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>+ (t_char c) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; CString <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>+ (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> CString <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>+ (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> t_char *p, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s); CString&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>+= (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> t_char *p); CString&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>+= (t_char c); CString&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>+= (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s); t_bool <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>== (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; t_bool <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>!= (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; t_bool <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&lt; (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; t_bool <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&gt; (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; t_bool <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&lt;= (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; t_bool <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&gt;= (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-function"><span class="hljs-function">t_char&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t_uint index)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">t_char </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t_uint index)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">t_uint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">t_bool </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isEmpty</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">t_int </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">search</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; s, t_uint from = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">CString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">substr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t_uint from, t_int count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">CString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replace</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; before, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; after)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t_uint value)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> t_uint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toUnsignedInt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; s, t_bool *good = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">nullptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; CVector&lt;CString&gt; split(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; splitter) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-function"><span class="hljs-function">t_bool </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">match</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; pattern)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> t_uint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replacePtr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *before, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *after, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buffer)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> t_uint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lengthPtr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *src)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> t_uint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concatenatePtr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buffer)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: t_char *m_data; <span class="hljs-function"><span class="hljs-function">t_uint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *src)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">t_char* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *src)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">t_char* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concatenate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *src0, t_char c)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">t_char* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concatenate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *src0, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *src1)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">t_int </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *src0, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t_char *src1)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; }; CString <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>+ (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> t_char *p, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; s);</code> </pre></div></div><br>  As an inevitability, for an application, a little more than ‚ÄúHello, world‚Äù, this is a log and a configuration file.  In the method of writing a message to the log, a mutex was involved, since each task as it processes the table writes about it to the log.  Small granular locks and lockfree algorithms were not considered due to the fact that writing to the log is far from a bottleneck in the operation of the application: <br><div class="spoiler">  <b class="spoiler_title">log.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CLog</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CSingleton&lt;CLog&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> MessageType { Information, Warning, Error }; CLog(); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~CLog(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">information</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; message)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">warning</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; message)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; message)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::mutex m_mutex; CFileStream m_stream; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeTimestamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeHeader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeFooter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MessageType type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; message)</span></span></span></span>; };</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">log.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs">CLog::CLog() { m_stream.open(<span class="hljs-string"><span class="hljs-string">"log.txt"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ios_base::out); writeHeader(); } CLog::~CLog() { writeFooter(); m_stream.flush(); m_stream.close(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CLog::information(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; message) { writeMessage(Information, message); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CLog::warning(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; message) { writeMessage(Warning, message); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CLog::error(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; message) { writeMessage(Error, message); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CLog::writeTimestamp() { <span class="hljs-keyword"><span class="hljs-keyword">time_t</span></span> rawtime; tm *timeinfo; t_char buffer[<span class="hljs-number"><span class="hljs-number">32</span></span>]; time(&amp;rawtime); timeinfo = localtime(&amp;rawtime); strftime(buffer, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-string"><span class="hljs-string">"%Y/%m/%d %H:%M:%S"</span></span>, timeinfo); m_stream &lt;&lt; buffer &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CLog::writeHeader() { writeMessage(Information, <span class="hljs-string"><span class="hljs-string">"Log started"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CLog::writeFooter() { writeMessage(Information, <span class="hljs-string"><span class="hljs-string">"Log ended"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CLog::writeMessage(MessageType type, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; message) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::lock_guard&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::mutex&gt; guard(m_mutex); writeTimestamp(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Information: { m_stream &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Information "</span></span> &lt;&lt; message.ptr(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Warning: { m_stream &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Warning "</span></span> &lt;&lt; message.ptr(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Error: { m_stream &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Error "</span></span> &lt;&lt; message.ptr(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } m_stream &lt;&lt; <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; m_stream.flush(); }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">config.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CConfig</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CSingleton&lt;CConfig&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: CConfig(); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~CConfig(); <span class="hljs-function"><span class="hljs-function">CString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; defvalue = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: CFileStream m_stream; CMap&lt;CString, CString&gt; m_values; };</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">config.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs">CConfig::CConfig() { m_stream.open(<span class="hljs-string"><span class="hljs-string">"mysql2psql.conf"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ios_base::in); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_stream.is_open()) { CString line; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> t_uint buffer_size = <span class="hljs-number"><span class="hljs-number">256</span></span>; t_char buffer[buffer_size]; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (m_stream.getline(buffer, buffer_size)) { line = buffer; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!line.isEmpty() &amp;&amp; line.at(<span class="hljs-number"><span class="hljs-number">0</span></span>) != <span class="hljs-string"><span class="hljs-string">'#'</span></span>) { t_int pos = line.search(<span class="hljs-string"><span class="hljs-string">"="</span></span>); CString name = line.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, pos); CString value = line.substr(pos + <span class="hljs-number"><span class="hljs-number">1</span></span>); m_values.insert(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;CString, CString&gt;(name, value)); } } m_stream.close(); CLog::instance()-&gt;information(<span class="hljs-string"><span class="hljs-string">"Config loaded"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CLog::instance()-&gt;warning(<span class="hljs-string"><span class="hljs-string">"Can't load config"</span></span>); } } CConfig::~CConfig() { } CString CConfig::value(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; name, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CString&amp; defvalue) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { CMap&lt;CString, CString&gt;::const_iterator iter = m_values.find(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iter != m_values.end()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> iter-&gt;second; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defvalue; }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">mysql2psql.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># MySQL connection mysql_host=localhost mysql_port=3306 mysql_database=mysqldb mysql_username=root mysql_password=rootpwd mysql_encoding=UTF8 # PostgreSQL connection psql_host=localhost psql_port=5432 psql_database=psqldb psql_username=postgres psql_password=postgrespwd psql_encoding=UTF8 # Migration # (!) Note: source_schema == mysql_database source_schema=mysqldb destination_schema=public tables=* use_insert=0 # Other settings threads=16</span></span></code> </pre></div></div><br>  Now, what about adding data to PostgreSQL.  There are two options - to use INSERT requests, which on a large data array didn‚Äôt show themselves very well in terms of performance (features of the transaction mechanism), or via the <a href="http://www.postgresql.org/docs/9.2/static/libpq-copy.html">COPY command</a> , which allows you to continuously send chunks of data by sending a special marker (terminator symbol) at the end of the transfer.  Another nuance is related to the type definition (fields in the table) in PostgreSQL.  The documentation does not indicate (perhaps there was no reading between the lines of documentation), how can a human-readable type identifier be returned, so a match was made for oid ( <i>almost</i> unique identifier of each object in the database) and type: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>: <span class="hljs-comment"><span class="hljs-comment">// int8 case 21: // int2 case 23: // int4 case 1005: // int2 case 1007: // int4 case 1016: // int8 case 700: // float4 case 701: // float8 case 1021: // float4 case 1022: // float8 case 1700: // numeric case 18: // char case 25: // text case 1002: // char case 1009: // text case 1015: // varchar case 1082: // date case 1182: // date case 1083: // time case 1114: // timestamp case 1115: // timestamp case 1183: // time case 1185: // timestamptz case 16: // bool case 1000: // bool</span></span></code> </pre><br><br>  Preparation and execution of tasks is as follows: <br><ul><li>  create a list of tables </li><li>  connections are created (by the number of tasks) to the source database and receiver database </li><li>  ranges are distributed from the list of tables to tasks </li><li>  Tasks are launched for execution (with the transferred range of tables and connections to the database) </li><li>  expected to complete tasks (main thread + threads created) </li></ul><br>  In each task, there are three static buffers of 50 MB each, in which data is prepared for the COPY command (screening special characters and concatenating field values): <br><div class="spoiler">  <b class="spoiler_title">code snippet with task preparation</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// create connection pool t_uint threads = CString::toUnsignedInt(CConfig::instance()-&gt;value("threads", "1")); CLog::instance()-&gt;information("Count of working threads: " + CString::fromNumber(threads)); if (!createConnectionPool(threads - 1)) { return false; } // create tasks CString destination_schema = CConfig::instance()-&gt;value("destination_schema"); t_uint range_begin = 0; t_uint range_end = 0; t_uint range = m_tables.size() / threads; for (t_uint i = 0, j = 0; i &lt; m_tables.size() - range; i += range + 1, ++j) { range_begin = i; range_end = i + range; std::unique_ptr&lt;CTask&gt; task = std::unique_ptr&lt;CTask&gt;(new CMigrationTask(m_source_pool.at(j), m_destination_pool.at(j), destination_schema, m_tables, range_begin, range_end)); m_migration_tasks.push_back(std::move(task)); } range_begin = range_end + 1; range_end = m_tables.size() - 1; std::unique_ptr&lt;CTask&gt; task = std::unique_ptr&lt;CTask&gt;(new CMigrationTask(std::move(m_source), std::move(m_destination), destination_schema, m_tables, range_begin, range_end)); // executing tasks for (t_uint i = 0; i &lt; m_migration_tasks.size(); ++i) { executeTask(m_migration_tasks.at(i).get()); } task-&gt;execute(); // wait for completion for (t_uint i = 0; i &lt; m_migration_tasks.size(); ++i) { while (!m_migration_tasks.at(i)-&gt;isExecuted()) { } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">snippet with preparation in the data task for COPY</b> <div class="spoiler_text"><pre> <code class="cpp hljs">t_uint count = <span class="hljs-number"><span class="hljs-number">0</span></span>; t_char *value; CString copy_query = <span class="hljs-string"><span class="hljs-string">"COPY "</span></span> + m_destination_schema + <span class="hljs-string"><span class="hljs-string">"."</span></span> + table + <span class="hljs-string"><span class="hljs-string">" ( "</span></span>; m_buffer[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; m_buffer_temp0[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; m_buffer_temp1[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result-&gt;nextRecord()) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (t_uint i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; result-&gt;columnCount(); ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i != <span class="hljs-number"><span class="hljs-number">0</span></span>) { copy_query += <span class="hljs-string"><span class="hljs-string">", "</span></span>; CString::concatenatePtr(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>, m_buffer); } copy_query += result-&gt;columnName(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!result-&gt;isColumnNull(i)) { value = result-&gt;columnValuePtr(i); CString::replacePtr(value, <span class="hljs-string"><span class="hljs-string">"\\"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\\\"</span></span>, m_buffer_temp0); CString::replacePtr(m_buffer_temp0, <span class="hljs-string"><span class="hljs-string">"\b"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\b"</span></span>, m_buffer_temp1); CString::replacePtr(m_buffer_temp1, <span class="hljs-string"><span class="hljs-string">"\f"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\f"</span></span>, m_buffer_temp0); CString::replacePtr(m_buffer_temp0, <span class="hljs-string"><span class="hljs-string">"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\n"</span></span>, m_buffer_temp1); CString::replacePtr(m_buffer_temp1, <span class="hljs-string"><span class="hljs-string">"\r"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\r"</span></span>, m_buffer_temp0); CString::replacePtr(m_buffer_temp0, <span class="hljs-string"><span class="hljs-string">"\t"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\t"</span></span>, m_buffer_temp1); CString::replacePtr(m_buffer_temp1, <span class="hljs-string"><span class="hljs-string">"\v"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\v"</span></span>, m_buffer_temp0); CString::concatenatePtr(m_buffer_temp0, m_buffer); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CString::concatenatePtr(<span class="hljs-string"><span class="hljs-string">"\\N"</span></span>, m_buffer); } } copy_query += <span class="hljs-string"><span class="hljs-string">" ) FROM STDIN"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_destination_connection-&gt;copyOpen(copy_query)) { CLog::instance()-&gt;error(<span class="hljs-string"><span class="hljs-string">"Can't execute query '"</span></span> + copy_query + <span class="hljs-string"><span class="hljs-string">"', error: "</span></span> + m_destination_connection-&gt;lastError()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } CString::concatenatePtr(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, m_buffer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_destination_connection-&gt;copyDataPtr(m_buffer)) { CLog::instance()-&gt;error(<span class="hljs-string"><span class="hljs-string">"Can't copy data, error: "</span></span> + m_destination_connection-&gt;lastError()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ++count; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (result-&gt;nextRecord()) { m_buffer[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (t_uint i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; result-&gt;columnCount(); ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i != <span class="hljs-number"><span class="hljs-number">0</span></span>) { CString::concatenatePtr(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>, m_buffer); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!result-&gt;isColumnNull(i)) { value = result-&gt;columnValuePtr(i); CString::replacePtr(value, <span class="hljs-string"><span class="hljs-string">"\\"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\\\"</span></span>, m_buffer_temp0); CString::replacePtr(m_buffer_temp0, <span class="hljs-string"><span class="hljs-string">"\b"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\b"</span></span>, m_buffer_temp1); CString::replacePtr(m_buffer_temp1, <span class="hljs-string"><span class="hljs-string">"\f"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\f"</span></span>, m_buffer_temp0); CString::replacePtr(m_buffer_temp0, <span class="hljs-string"><span class="hljs-string">"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\n"</span></span>, m_buffer_temp1); CString::replacePtr(m_buffer_temp1, <span class="hljs-string"><span class="hljs-string">"\r"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\r"</span></span>, m_buffer_temp0); CString::replacePtr(m_buffer_temp0, <span class="hljs-string"><span class="hljs-string">"\t"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\t"</span></span>, m_buffer_temp1); CString::replacePtr(m_buffer_temp1, <span class="hljs-string"><span class="hljs-string">"\v"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\v"</span></span>, m_buffer_temp0); CString::concatenatePtr(m_buffer_temp0, m_buffer); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CString::concatenatePtr(<span class="hljs-string"><span class="hljs-string">"\\N"</span></span>, m_buffer); } } CString::concatenatePtr(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, m_buffer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_destination_connection-&gt;copyDataPtr(m_buffer)) { CLog::instance()-&gt;error(<span class="hljs-string"><span class="hljs-string">"Can't copy data, error: "</span></span> + m_destination_connection-&gt;lastError()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ++count; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count % <span class="hljs-number"><span class="hljs-number">250000</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) { CLog::instance()-&gt;information(<span class="hljs-string"><span class="hljs-string">"Working task #"</span></span> + CString::fromNumber(taskID()) + <span class="hljs-string"><span class="hljs-string">":\t\ttable "</span></span> + table + <span class="hljs-string"><span class="hljs-string">" processing, record count: "</span></span> + CString::fromNumber(count)); } } }</code> </pre><br></div></div><br><br><h5>  results </h5><br>  To transfer 2 GB of data to PostgreSQL, with WAL archiving enabled, it took about 10 minutes (16 streams were created). <br><br><h5>  What is worth thinking about </h5><br><ul><li>  Determining the number of tasks / flows at the stage of execution - based on the amount of data and available hardware capabilities </li><li>  Determining the amount of required memory for the buffer in which data is prepared for COPY </li><li>  Distribution of tables between tasks not by range, but by necessity - tasks take a table from the threadsafe stack </li></ul><br><h5>  Source </h5><br>  Source code is available on <a href="https://github.com/blackmaster/mysql2psql">github</a> . </div><p>Source: <a href="https://habr.com/ru/post/175459/">https://habr.com/ru/post/175459/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175447/index.html">The largest Bitcoin exchange Mt. Gox under DDoS attack - owners suspect that attackers want to provoke panic</a></li>
<li><a href="../175449/index.html">How to tie a BitTorrent tracker to a Python site: integration with XBT Tracker</a></li>
<li><a href="../175451/index.html">GPS monitoring auto or homework for the evening</a></li>
<li><a href="../175453/index.html">Using design patterns in javaScript: Spawning patterns</a></li>
<li><a href="../175457/index.html">Admin in 10 minutes</a></li>
<li><a href="../175461/index.html">How it works: CAPTCHA</a></li>
<li><a href="../175465/index.html">M in MVC: why models are misunderstood and undervalued (translation)</a></li>
<li><a href="../175467/index.html">Intel plans for the release of new processors in 2013</a></li>
<li><a href="../175469/index.html">Firefox: private tabs, various APIs and extensions that do not require restarting</a></li>
<li><a href="../175475/index.html">ActionScript - Yes / No Future?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>