<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ChakraCore: JavaScript engine validation for Microsoft Edge</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In December 2015, at the JSConf US conference, the developers announced that they were planning to open the source code of the key components of the C...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ChakraCore: JavaScript engine validation for Microsoft Edge</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/4bf/919/24d/4bf91924dae0c9a42ba65ac3ffca2ca2.png" align="left">  In December 2015, at the JSConf US conference, the developers announced that they were planning to open the source code of the key components of the Chakra JavaScript engine running in Microsoft Edge.  Recently, the source code of ChackraCore under the MIT license was published in the corresponding repository on GitHub.  In the article I will tell you what you managed to find interesting in the project with the help of the PVS-Studio static analyzer. <br><br><h2>  Introduction </h2><br>  <a href="https://github.com/Microsoft/ChakraCore">ChakraCore</a> is the basic component of Chakra, a high-performance JavaScript engine that runs Microsoft Edge and Windows applications written in HTML / CSS / JS.  ChakraCore supports JavaScript jit compilation for x86 / x64 / ARM, garbage collection and a wide range of the latest JavaScript features. <br><br>  <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> is a static analyzer for detecting errors in the source code of programs written in C, C ++ and C # languages.  The PVS-Studio tool is designed for developers of modern applications and integrates into Visual Studio 2010-2015 environments. <br><a name="habracut"></a><br>  In preparing the article about checking the next <a href="http://www.viva64.com/ru/a/0084/">open project</a> , we provide in it information far from all warnings issued by the static analyzer.  Therefore, we recommend that the authors of the project independently perform an analysis and study all the messages issued by the analyzer.  We provide a key to open project developers for a time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Mistakes </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/caa/7a3/b95/caa7a3b952150160f890939d894aec3d.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions 'this-&gt; propId == Js :: PropertyIds :: _ superReferenceSymbol' to the left |  operator.  diagobjectmodel.cpp 123 <br><br><pre><code class="cpp hljs">IDiagObjectModelDisplay * ResolvedObject::CreateDisplay() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;isConst || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;propId == Js::PropertyIds::_superReferenceSymbol || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;propId == Js::PropertyIds::_superReferenceSymbol) { pOMDisplay-&gt;SetDefaultTypeAttribute(....); } .... }</code> </pre> <br>  In the condition there are two identical checks.  Perhaps, when writing code, the same constant was randomly chosen in the IntelliSense menu, for example, instead of ‚ÄúJs :: PropertyIds :: _superCtorReferenceSymbol‚Äù. <br><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions 'GetVarSymID (srcIndexOpnd-&gt; GetStackSym ()) to ==' operator.  globopt.cpp 20795 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> GlobOpt::EmitMemop(....) { .... IR::RegOpnd *srcBaseOpnd = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; IR::RegOpnd *srcIndexOpnd = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; IRType srcType; GetMemOpSrcInfo(...., srcBaseOpnd, srcIndexOpnd, srcType); Assert(GetVarSymID(srcIndexOpnd-&gt;GetStackSym()) == <span class="hljs-comment"><span class="hljs-comment">// &lt;= GetVarSymID(srcIndexOpnd-&gt;GetStackSym())); // &lt;= .... }</span></span></code> </pre> <br>  Two more identical comparisons.  Most likely, we wanted to compare "srcIndexOpnd-&gt; GetStackSym ()" with "srcBaseOpnd -&gt; GetStackSym ()". <br><br>  <a href="http://www.viva64.com/ru/d/0090/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 3220, 3231. lower.cpp 3220 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Lowerer::GenerateFastBrSrEq(...., IR::RegOpnd * srcReg1, IR::RegOpnd * srcReg2, ....) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (srcReg2 &amp;&amp; IsConstRegOpnd(srcReg2)) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (srcReg1 &amp;&amp; IsConstRegOpnd(srcReg1)) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (srcReg2 &amp;&amp; (srcReg2-&gt;m_sym-&gt;m_isStrConst)) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (srcReg1 &amp;&amp; (srcReg1-&gt;m_sym-&gt;m_isStrConst)) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { .... } else if (srcReg2 &amp;&amp; (srcReg2-&gt;m_sym-&gt;m_isStrEmpty)) { .... } else if (srcReg1 &amp;&amp; (srcReg1-&gt;m_sym-&gt;m_isStrConst)) // &lt;= { .... } return false; }</span></span></code> </pre> <br>  Two identical checks were found in the cascade of conditional statements, so that the code block in the last condition never gets control.  The full code of the presented example is very large and it is difficult to notice a typo.  This is a good example that shows how a static analyzer can be useful when working with the same type of code, from which the programmer quickly gets tired and loses attention. <br><br>  Most likely, the last two conditions would be written like this: <br><br><pre> <code class="cpp hljs">.... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (srcReg2 &amp;&amp; (srcReg2-&gt;m_sym-&gt;m_isStrEmpty)) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (srcReg1 &amp;&amp; (srcReg1-&gt;m_sym-&gt; m_isStrEmpty)) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { .... }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0354/">V713</a> The pointer to the scriptContext was used in the same logical expression.  diaghelpermethodwrapper.cpp 214 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> doCheckParentInterpreterFrame&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleHelperOrLibraryMethodWrapperException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!exceptionObject-&gt;IsDebuggerSkip() || exceptionObject == scriptContext-&gt;GetThreadContext()-&gt;.... || exceptionObject == scriptContext-&gt;GetThreadContext()-&gt;.... || !scriptContext) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { throw exceptionObject-&gt;CloneIfStaticExceptionObject(....); } .... }</span></span></code> </pre> <br>  The dereferencing of the ‚ÄúscriptContext‚Äù pointer takes place before its correctness is checked.  Due to luck, such a mistake has not yet manifested itself and has not been noticed.  Such errors can live very long in the code, and manifest themselves in rare atypical situations. <br><br>  <a href="http://www.viva64.com/ru/d/0168/">V570</a> The 'this-&gt; isInlined' variable is assigned to itself.  functioncodegenjittimedata.h 625 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetupRecursiveInlineeChain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Recycler *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> recycler, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ProfileId profiledCallSiteId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!inlinees) { inlinees = RecyclerNewArrayZ(....); } inlinees[profiledCallSiteId] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; inlineeCount++; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;isInlined = isInlined; <span class="hljs-comment"><span class="hljs-comment">// &lt;= }</span></span></code> </pre> <br>  It is very suspicious that the same value is put in the boolean variable 'isInlined'.  Most likely they wanted to write something else. <br><br>  Another place to assign a variable to itself: <br><br><ul><li>  V570 The 'sym-&gt; m_isTaggableIntConst' variable is assigned to itself.  linearscan.cpp 3170 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0194/">V590</a> Consider inspecting the 'sub [i]! =' - '&amp;&amp; sub [i] ==' / '' expression.  The expression is misprint.  rl.cpp 1388 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stristr</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * str, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * sub )</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">tolower</span></span>(str[i]) != <span class="hljs-built_in"><span class="hljs-built_in">tolower</span></span>(sub[i])) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((str[i] != <span class="hljs-string"><span class="hljs-string">'/'</span></span> &amp;&amp; str[i] != <span class="hljs-string"><span class="hljs-string">'-'</span></span>) || (sub[i] != <span class="hljs-string"><span class="hljs-string">'-'</span></span> &amp;&amp; sub[i] == <span class="hljs-string"><span class="hljs-string">'/'</span></span>)) { / &lt;= <span class="hljs-comment"><span class="hljs-comment">// if the mismatch is not between '/' and '-' break; } } } .... }</span></span></code> </pre> <br>  The analyzer found that the part of the conditional expression (sub [i]! = '-') does not affect the result of the test.  To verify this, we construct a truth table.  Most likely there is a typo, but what should be the correct code, I find it difficult to answer. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a37/d96/4d7/a37d964d7980b780ae437c3439fac866.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0215/">V603</a> The object was not used.  If you wish to call the constructor, 'this-&gt; StringCopyInfo :: StringCopyInfo (....)' should be used.  stringcopyinfo.cpp 64 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> StringCopyInfo::InstantiateForceInlinedMembers() { AnalysisAssert(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); StringCopyInfo copyInfo; JavascriptString *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buffer = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; (StringCopyInfo()); <span class="hljs-comment"><span class="hljs-comment">// &lt;= (StringCopyInfo(string, buffer)); // &lt;= copyInfo.SourceString(); copyInfo.DestinationBuffer(); }</span></span></code> </pre> <br>  Programmers often <a href="http://www.viva64.com/ru/b/0127/">make mistakes</a> when trying to explicitly call a constructor to initialize an object.  In this example, new, unnamed objects of type ‚ÄúStringCopyInfo‚Äù are created and immediately destroyed.  As a result, the class fields remain uninitialized. <br><br>  The correct option would be to create an initialization function and call it from constructors and in this place. <br><br>  <a href="http://www.viva64.com/ru/d/0225/">V610</a> Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '-1' is negative.  constants.h 39 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constants</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: .... <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Int31MinValue = <span class="hljs-number"><span class="hljs-number">-1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">30</span></span>; .... };</code> </pre> <br>  According to the modern standard of the C ++ language, a shift in a negative number leads to undefined behavior. <br><br>  <a href="http://www.viva64.com/ru/d/0148/">V557</a> Array overrun is possible.  The value of 'i' index could reach 8. rl.cpp 2375 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TestInfoKind::_TIK_COUNT = <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TestInfoEnvLstFmt[] = { <span class="hljs-string"><span class="hljs-string">" TESTFILE=\"%s\""</span></span>, <span class="hljs-string"><span class="hljs-string">" BASELINE=\"%s\""</span></span>, <span class="hljs-string"><span class="hljs-string">" CFLAGS=\"%s\""</span></span>, <span class="hljs-string"><span class="hljs-string">" LFLAGS=\"%s\""</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= TestInfoEnvLstFmt[7] }; void WriteEnvLst ( Test * pDir, TestList * pTestList ) { .... // print the other TIK_* for(int i=0;i &lt; _TIK_COUNT; i++) { if (variants-&gt;testInfo.data[i] &amp;&amp; TestInfoEnvLstFmt[i]){// &lt;= LstFilesOut-&gt;Add(TestInfoEnvLstFmt[i], // &lt;= variants-&gt;testInfo.data[i]); } .... } .... }</span></span></code> </pre> <br>  The analyzer detected an index out of array.  The fact is that the for () loop performs 9 iterations, and in the array ‚ÄúTestInfoEnvLstFmt []‚Äù there are only 8 elements. <br><br>  Most likely you forgot to add another NULL at the end: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TestInfoEnvLstFmt[] = { <span class="hljs-string"><span class="hljs-string">" TESTFILE=\"%s\""</span></span>, <span class="hljs-string"><span class="hljs-string">" BASELINE=\"%s\""</span></span>, <span class="hljs-string"><span class="hljs-string">" CFLAGS=\"%s\""</span></span>, <span class="hljs-string"><span class="hljs-string">" LFLAGS=\"%s\""</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= TestInfoEnvLstFmt[7] NULL // &lt;= TestInfoEnvLstFmt[8] };</span></span></code> </pre> <br>  But maybe they missed some line in the middle of the array! <br><br><h2>  Dangerous Signs </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d51/e4e/e81/d51e4ee815b5000e237195b3f98d7e3a.png"></div><br><br>  Diagnostics V595 finds code points where pointer dereferencing is performed before it is checked for zero.  Usually in the checked projects there is always a certain number of such warnings.  In our database of errors, it ranks first in the number of defects found (see <a href="http://www.viva64.com/ru/examples/V595/">examples</a> ).  But the fact is that the V595 diagnostics are somewhat boring in order to write many examples from some project.  Also, checking and dereferencing a pointer can be quite far in the function code: tens or even hundreds of lines from each other, which complicates the description of the error in the article. <br><br>  Next, I will describe just a few of the shortest and most illustrative examples of code that most likely contain an error when working with pointers. <br><br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The 'instrLd' pointer was used before it was verified against nullptr.  Check lines: 1823, 1831. flowgraph.cpp 1823 <br><br><pre> <code class="cpp hljs">IR::Instr * FlowGraph::PeepTypedCm(IR::Instr *instr) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (instrLd &amp;&amp; !instrLd-&gt;GetSrc1()-&gt;IsEqual(instr-&gt;GetDst())) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(instrLd2 &amp;&amp; !instrLd2-&gt;GetSrc1()-&gt;IsEqual(instrLd-&gt;GetDst())) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; } .... }</code> </pre> <br>  Notice the pointer named "instrLd".  In the first condition, the dereference of this pointer is performed together with the check for zero, but in the second condition it is forgotten to do so, a situation may arise when the dereferencing of the null pointer occurs. <br><br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The 'src2Val' pointer was used before it was verified against nullptr.  Check lines: 9717, 9725. globopt.cpp 9717 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> GlobOpt::TypeSpecializeIntBinary(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isIntConstMissingItem = src2Val-&gt;GetValueInfo()-&gt;.... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(isIntConstMissingItem) { isIntConstMissingItem = Js::SparseArraySegment&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;::.... } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!src2Val || !(src2Val-&gt;GetValueInfo()-&gt;IsLikelyInt()) || isIntConstMissingItem) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } .... }</code> </pre> <br>  The ‚Äúsrc2Val‚Äù pointer is used at the beginning of the function, but then the developers actively began to check whether the pointer is zero. <br><br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The m_lastInstr 'pointer was used before it was verified against nullptr.  Check lines: 214, 228. irbuilderasmjs.cpp 214 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IRBuilderAsmJs::AddInstr(IR::Instr * instr, uint32 offset) { m_lastInstr-&gt;InsertAfter(instr); <span class="hljs-comment"><span class="hljs-comment">// &lt;= if (offset != Js::Constants::NoByteCodeOffset) { .... } else if (m_lastInstr) // &lt;= { instr-&gt;SetByteCodeOffset(m_lastInstr-&gt;GetByteCodeOffset()); } m_lastInstr = instr; .... }</span></span></code> </pre> <br>  Another example of careless use of a pointer, which could potentially be null. <br><br>  List of similar places: <br><br><ul><li>  V595 The 'arrayData' pointer was used before it was verified against nullptr.  Check lines: 868, 870. immutablelist.h 868 </li><li>  V595 The 'pMembersList' pointer was used before it was verified against nullptr.  Check lines: 2012, 2015. diagobjectmodel.cpp 2012 </li><li>  V595 The 'walkerRef' pointer was used before it was verified against nullptr.  Check lines: 3191, 3193. diagobjectmodel.cpp 3191 </li><li>  V595 The 'block-&gt; loop' pointer was used before it was verified against nullptr.  Check lines: 981, 1002. globopt.cpp 981 </li><li>  V595 The 'src2Val' pointer was used before it was verified against nullptr.  Check lines: 12528, 12536. globopt.cpp 12528 </li><li>  V595 The 'symDst' pointer was used before it was verified against nullptr.  Check lines: 1966, 1967. irbuilderasmjs.cpp 1966 </li><li>  V595 The 'symDst' pointer was used before it was verified against nullptr.  Check lines: 2010, 2011. irbuilderasmjs.cpp 2010 </li><li>  V595 The 'symDst' pointer was used before it was verified against nullptr.  Check lines: 2076, 2077. irbuilderasmjs.cpp 2076 </li><li>  V595 The 'symDst' pointer was used before it was verified against nullptr.  Check lines: 3591, 3592. irbuilderasmjs.cpp 3591 </li><li>  V595 The 'symDst' pointer was used before it was verified against nullptr.  Check lines: 4113, 4114. irbuilderasmjs.cpp 4113 </li><li>  V595 The 'symDst' pointer was used before it was verified against nullptr.  Check lines: 4510, 4511. irbuilderasmjs.cpp 4510 </li><li>  V595 The m_lastInstr 'pointer was used before it was verified against nullptr.  Check lines: 1102, 1116. irbuilder.cpp 1102 </li></ul><br>  The list contains the most simple and clear examples.  To explore all these places, developers should study the analyzer‚Äôs report themselves. <br><br>  <a href="http://www.viva64.com/ru/d/0111/">V522</a> Dereferencing of the null pointer 'tempNumberTracker' might take place.  backwardpass.cpp 578 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> BackwardPass::MergeSuccBlocksInfo(BasicBlock * block) { TempNumberTracker * tempNumberTracker = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= line 346 .... if (!block-&gt;isDead) { .... if(!IsCollectionPass()) { .... if (this-&gt;DoMarkTempNumbers()) { tempNumberTracker = JitAnew(....); // &lt;= line 413 } .... .... if (blockSucc-&gt;tempNumberTracker != nullptr) { .... tempNumberTracker-&gt;MergeData(....); // &lt;= line 578 if (deleteData) { blockSucc-&gt;tempNumberTracker = nullptr; } } .... }</span></span></code> </pre> <br>  An example of another diagnostic, but also about pointers.  Here is a fragment of the function MergeSuccBlocksInfo (), it is quite long - 707 lines.  But with the help of static analysis, it was possible to find the pointer ‚ÄútempNumberTracker‚Äù, the initialization of which could potentially fail due to a number of conditions.  As a result, in case of an unsuccessful set of circumstances, a null pointer will be dereferenced. <br><br><h2>  Stop it!  Check out the Assert! </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d3/a17/38e/2d3a1738e1b487f8b4eb7d71d37d156a.png"></div><br><br>  Assert, placed in a program, indicates that the developer assumes that some expression is true for a program that works correctly.  But is it possible to trust such ‚Äúsuccessful‚Äù checks? <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'srcIndex - src-&gt; left&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. sparsearraysegment.inl 355 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SparseArraySegmentBase</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uint32 MaxLength; .... uint32 size; .... } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; SparseArraySegment&lt;T&gt;* SparseArraySegment&lt;T&gt;::CopySegment(...., uint32 srcIndex, ....) { .... AssertMsg(srcIndex - src-&gt;left &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">// &lt;= "src-&gt;left &gt; srcIndex resulting in \ negative indexing of src-&gt;elements"); js_memcpy_s(dst-&gt;elements + dstIndex - dst-&gt;left, sizeof(T) * inputLen, src-&gt;elements + srcIndex - src-&gt;left, sizeof(T) * inputLen); return dst; }</span></span></code> </pre> <br>  Pay attention to the comparison "srcIndex - src-&gt; left&gt; = 0".  The difference of two unsigned numbers will always be greater than or equal to zero.  Further, this formula is used in functions for working with memory.  The result may not be the same as the programmer expected. <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  bytecodegenerator.cpp 805 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ByteCodeGenerator::AssignRegister(Symbol *sym) { AssertMsg(sym-&gt;GetDecl() == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span> || sym-&gt;GetDecl()-&gt;nop != knopConstDecl || <span class="hljs-comment"><span class="hljs-comment">// &lt;= sym-&gt;GetDecl()-&gt;nop != knopLetDecl, "...."); // &lt;= if (sym-&gt;GetLocation() == Js::Constants::NoRegister) { sym-&gt;SetLocation(NextVarRegister()); } }</span></span></code> </pre> <br>  In this Assert, some values ‚Äã‚Äãare partially tested.  If the assumption "sym-&gt; GetDecl () == nullptr" is false, then the following conditions are always true.  You can verify this by building a truth table: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c33/d33/215/c33d3321591662b04168f599d3d83522.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'callSiteId&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. inline.cpp 1181 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> uint16 ProfileId; Func * Inline::BuildInlinee(Js::FunctionBody* funcBody, ....) { .... Js::ProfileId callSiteId = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;Js::ProfileId&gt;(....); Assert(callSiteId &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>); .... }</code> </pre> <br>  In this and two other places, the analyzer detected an incorrect comparison of an unsigned number with zero: <br><br><ul><li>  V547 Expression 'callSiteId&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. inline.cpp 2627 </li><li>  V547 Expression 'callSiteId&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. inline.cpp 3657 </li></ul><br><h2>  Conclusion </h2><br>  Microsoft has noticed a positive trend to open its projects under free licenses.  For us, this is additional testing of the analyzer on new projects, as well as the opportunity to demonstrate the usefulness and effectiveness of static analysis on projects of such a large and well-known software manufacturer. <br><br>  You may be interested in a list of all <a href="http://www.viva64.com/ru/a/0084/">verified projects</a> , including other projects from Microsoft, such as .NET CoreCLR, .NET CoreFX and Microsoft Code Contracts. <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0370/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov.  <a href="http://www.viva64.com/en/b/0370/">ChakraCore: analysis of JavaScript-engines for Microsoft Edge</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/275701/">https://habr.com/ru/post/275701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275687/index.html">FT Clustering - everRun by Stratus Technologies</a></li>
<li><a href="../275691/index.html">How to block my app on Google Play</a></li>
<li><a href="../275693/index.html">Security Week 03 or patch week: Linux, OpenSSH, Cisco, Yahoo Mail, Apple</a></li>
<li><a href="../275695/index.html">Skype began to hide the default IP addresses</a></li>
<li><a href="../275699/index.html">Digest of the game industry: December</a></li>
<li><a href="../275703/index.html">"Pixel gallop - part three" - Animation</a></li>
<li><a href="../275705/index.html">Data Driven Realtime Rule Engine in Wargaming: data analysis. Part 2</a></li>
<li><a href="../275707/index.html">Are you three-dimensional? Microtask spatial thinking</a></li>
<li><a href="../275709/index.html">C calls in Go: principle of operation and performance</a></li>
<li><a href="../275711/index.html">New call reporting for 3CX v14</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>