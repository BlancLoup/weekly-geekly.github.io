<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ServiceStack.OrmLite Review - micro-ORM for .NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="OrmLite is a friendly micro-ORM open source and commercial license ( free for small projects with a limit of 10 tables). Included in the famous Servic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ServiceStack.OrmLite Review - micro-ORM for .NET</h1><div class="post__text post__text-html js-mediator-article">  OrmLite is a friendly micro-ORM <a href="https://github.com/ServiceStack/ServiceStack.OrmLite">open</a> source and commercial license ( <a href="https://servicestack.net/download">free</a> for small projects with a limit of 10 tables).  Included in the famous <a href="https://servicestack.net/">ServiceStack</a> framework (and has high performance - take a look at the <a href="https://github.com/StackExchange/dapper-dot-net">benchmark</a> from the developers of Dapper).  In this article we will cover the basics of working with OrmLite in conjunction with SQL Server.  If you compare OrmLite and the Entity Framework, then immediately striking the lack of context and change tracking (change tracking).  And these are not the only differences. <br><br>  Article layout: <br><ul><li>  <a href="https://habr.com/ru/post/256791/">Preparation for work.</a>  <a href="https://habr.com/ru/post/256791/">Code-first and database-first approaches</a> </li><li>  <a href="https://habr.com/ru/post/256791/">Queries to the database</a> </li><li>  <a href="https://habr.com/ru/post/256791/">JOIN and navigation properties</a> </li><li>  <a href="https://habr.com/ru/post/256791/">Lazy and async</a> </li><li>  <a href="https://habr.com/ru/post/256791/">Transactions</a> </li><li>  <a href="https://habr.com/ru/post/256791/">OrmLite and Entity Framework Performance Comparison</a> </li><li>  <a href="https://habr.com/ru/post/256791/">Conclusion</a> </li></ul><br>  Interested I invite under kat. <br><a name="habracut"></a><br><a name="P1"></a><h3>  Preparation for work.  Code-first and database-first approaches </h3><br>  Install OrmLite in our project: <br><blockquote>  Install-Package ServiceStack.OrmLite.SqlServer <br></blockquote><br>  OrmLite - first of all, code-first ORM.  However, it is possible to generate POCO classes based on the existing database.  We will start with this generation by installing additional T4 templates: <br><blockquote>  Install-Package ServiceStack.OrmLite.T4 <br></blockquote><br>  If everything went well, 3 files will be added to the project: <br><blockquote>  OrmLite.Core.ttinclude <br>  OrmLite.Poco.tt <br>  OrmLite.SP.tt <br></blockquote><br>  Add a connection string to app / web.config, fill in the ConnectionStringName in the OrmLite.Poco.tt file (optional for a single string in app.config), click on the Run Custom Tool file and get the generated POCO classes, for example: <br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Alias(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Order"</span></span></span><span class="hljs-meta">)</span></span>] [Schema(<span class="hljs-string"><span class="hljs-string">"dbo"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> : <span class="hljs-title"><span class="hljs-title">IHasId</span></span>&lt;<span class="hljs-title"><span class="hljs-title">int</span></span>&gt; { [AutoIncrement] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Number { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? CustomerId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br>  OK, the model is ready.  Let's make a test query to the database.  The OrmLite functionality is accessed via an instance of the OrmLiteConnection class that implements IDbConnection: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrmLiteConnectionFactory(ConnectionString, SqlServerDialect.Provider); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (IDbConnection db = dbFactory.Open()) { <span class="hljs-comment"><span class="hljs-comment">//db.AnyMethod... }</span></span></code> </pre><br>  Let's remember this pattern, then it is implied when referring to the db object. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Select all records from the Order table with a Number value greater than 50: <br><pre> <code class="cs hljs"> List&lt;Order&gt; orders = db.Select&lt;Order&gt;(order =&gt; order.Number &gt; <span class="hljs-number"><span class="hljs-number">50</span></span>);</code> </pre><br>  Simply! <br><br><div class="spoiler">  <b class="spoiler_title">And what's inside the OrmLiteConnection?</b> <div class="spoiler_text">  Common <a href="https://msdn.microsoft.com/ru-ru/library/System.Data.SqlClient.SqlConnection(v%3Dvs.110).aspx">SqlConnection</a> : <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> IDbConnection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString, Dictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; options</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isFullConnectionString = connectionString.Contains(<span class="hljs-string"><span class="hljs-string">";"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isFullConnectionString) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filePath = connectionString; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filePathWithExt = filePath.ToLower().EndsWith(<span class="hljs-string"><span class="hljs-string">".mdf"</span></span>) ? filePath : filePath + <span class="hljs-string"><span class="hljs-string">".mdf"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileName = Path.GetFileName(filePathWithExt); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbName = fileName.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, fileName.Length - <span class="hljs-string"><span class="hljs-string">".mdf"</span></span>.Length); connectionString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format( <span class="hljs-string"><span class="hljs-string">@"Data Source=.\SQLEXPRESS;AttachDbFilename={0};Initial Catalog={1};Integrated Security=True;User Instance=True;"</span></span>, filePathWithExt, dbName); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (options != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> option <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> options) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (option.Key.ToLower() == <span class="hljs-string"><span class="hljs-string">"read only"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (option.Value.ToLower() == <span class="hljs-string"><span class="hljs-string">"true"</span></span>) { connectionString += <span class="hljs-string"><span class="hljs-string">"Mode = Read Only;"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } connectionString += option.Key + <span class="hljs-string"><span class="hljs-string">"="</span></span> + option.Value + <span class="hljs-string"><span class="hljs-string">";"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnection(connectionString); }</code> </pre><br></div></div><br>  Let's move on to the code-first approach.  Consistently execute DROP and CREATE for our table like this: <br><pre> <code class="cs hljs"> db.DropAndCreateTable&lt;Order&gt;();</code> </pre><br>  It should be noted that the classes previously generated using T4 POCO have lost some of the information about the database tables (the length of the string data, foreign keys, etc.).  OrmLite provides everything you need to add such information to our POCO (code-first oriented is the same!).  The following example creates a nonclustered index, specifies the type nvarchar (20), and creates a foreign key for the Number, Text, and CustomerId fields, respectively: <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Schema(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"dbo"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> : <span class="hljs-title"><span class="hljs-title">IHasId</span></span>&lt;<span class="hljs-title"><span class="hljs-title">int</span></span>&gt; { [AutoIncrement] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Index(NonClustered = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Number { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [CustomField(<span class="hljs-string"><span class="hljs-string">"NVARCHAR(20)"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [ForeignKey(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Customer))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? CustomerId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  As a result, when db.CreateTable is called, the following SQL query will be executed: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"dbo"</span></span>.<span class="hljs-string"><span class="hljs-string">"Order"</span></span> ( <span class="hljs-string"><span class="hljs-string">"Id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">"Number"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"Text"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"CustomerId"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">"FK_dbo_Order_dbo_Customer_CustomerId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">"CustomerId"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">"dbo"</span></span>.<span class="hljs-string"><span class="hljs-string">"Customer"</span></span> (<span class="hljs-string"><span class="hljs-string">"Id"</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> idx_order_number <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"dbo"</span></span>.<span class="hljs-string"><span class="hljs-string">"Order"</span></span> (<span class="hljs-string"><span class="hljs-string">"Number"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>);</code> </pre><br><a name="P2"></a><h3>  Queries to the database </h3><br>  In OrmLite, there are 2 main ways to build queries to the database: lambda expressions and parameterized SQL.  The following code demonstrates how to get all the records from the Order table with the specified CustomerId in various ways: <br><br>  1) lambda expressions and SqlExpression: <br><pre> <code class="cs hljs"> List&lt;Order&gt; orders = db.Select&lt;Order&gt;(order =&gt; order.CustomerId == customerId);</code> </pre><br><pre> <code class="cs hljs"> List&lt;Order&gt; orders = db.Select(db.From&lt;Order&gt;().Where(order =&gt; order.CustomerId == customerId));</code> </pre><br>  2) parameterized SQL: <br><pre> <code class="cs hljs"> List&lt;Order&gt; orders = db.SelectFmt&lt;Order&gt;(<span class="hljs-string"><span class="hljs-string">"CustomerId = {0}"</span></span>, customerId);</code> </pre><br><pre> <code class="cs hljs"> List&lt;Order&gt; orders = db.SelectFmt&lt;Order&gt;(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM [Order] WHERE CustomerId = {0}"</span></span>, customerId);</code> </pre><br>  Building simple insert / update / delete queries should also not cause difficulties.  Under the spoiler a few examples from the official documentation. <br><div class="spoiler">  <b class="spoiler_title">Simple CRUD</b> <div class="spoiler_text"><pre> <code class="cs hljs"> db.Update(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Person { Id = <span class="hljs-number"><span class="hljs-number">1</span></span>, FirstName = <span class="hljs-string"><span class="hljs-string">"Jimi"</span></span>, LastName = <span class="hljs-string"><span class="hljs-string">"Hendrix"</span></span>, Age = <span class="hljs-number"><span class="hljs-number">27</span></span>});</code> </pre><br>  SQL: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-string"><span class="hljs-string">"Person"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-string"><span class="hljs-string">"FirstName"</span></span> = <span class="hljs-string"><span class="hljs-string">'Jimi'</span></span>,<span class="hljs-string"><span class="hljs-string">"LastName"</span></span> = <span class="hljs-string"><span class="hljs-string">'Hendrix'</span></span>,<span class="hljs-string"><span class="hljs-string">"Age"</span></span> = <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">"Id"</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><br><pre> <code class="cs hljs"> db.Insert(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Person { Id = <span class="hljs-number"><span class="hljs-number">1</span></span>, FirstName = <span class="hljs-string"><span class="hljs-string">"Jimi"</span></span>, LastName = <span class="hljs-string"><span class="hljs-string">"Hendrix"</span></span>, Age = <span class="hljs-number"><span class="hljs-number">27</span></span> });</code> </pre><br>  SQL: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">"Person"</span></span> (<span class="hljs-string"><span class="hljs-string">"Id"</span></span>,<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>,<span class="hljs-string"><span class="hljs-string">"LastName"</span></span>,<span class="hljs-string"><span class="hljs-string">"Age"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'Jimi'</span></span>,<span class="hljs-string"><span class="hljs-string">'Hendrix'</span></span>,<span class="hljs-number"><span class="hljs-number">27</span></span>)</code> </pre><br><br><pre> <code class="cs hljs"> db.Delete&lt;Person&gt;(p =&gt; p.Age == <span class="hljs-number"><span class="hljs-number">27</span></span>);</code> </pre><br>  SQL: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"Person"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (<span class="hljs-string"><span class="hljs-string">"Age"</span></span> = <span class="hljs-number"><span class="hljs-number">27</span></span>)</code> </pre><br></div></div><br>  In more detail we will consider more interesting cases. <br><br><a name="P3"></a><h3>  JOIN and navigation properties </h3><br>  Add the Customer table to the already known Order table: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Customer</span></span> { [AutoIncrement] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  For their internal connection (INNER JOIN) it is enough to execute the code: <br><pre> <code class="cs hljs"> List&lt;Order&gt; orders = db.Select&lt;Order&gt;(q =&gt; q.Join&lt;Customer&gt;());</code> </pre><br>  SQL: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"Order"</span></span>.<span class="hljs-string"><span class="hljs-string">"Id"</span></span>, <span class="hljs-string"><span class="hljs-string">"Order"</span></span>.<span class="hljs-string"><span class="hljs-string">"Details"</span></span>, <span class="hljs-string"><span class="hljs-string">"Order"</span></span>.<span class="hljs-string"><span class="hljs-string">"CustomerId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"Order"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">"Customer"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">"Customer"</span></span>.<span class="hljs-string"><span class="hljs-string">"Id"</span></span> = <span class="hljs-string"><span class="hljs-string">"Order"</span></span>.<span class="hljs-string"><span class="hljs-string">"CustomerId"</span></span>)</code> </pre><br>  Accordingly, for the LEFT JOIN, the q.LeftJoin method is used, etc.  To retrieve data from several tables at the same time, method # 1 is to perform the mapping of the resulting sample to the following class OrderInfo: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrderInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OrderId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> OrderDetails { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? CustomerId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CustomerName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><pre> <code class="cs hljs"> List&lt;OrderInfo&gt; info = db.Select&lt;OrderInfo&gt;(db.From&lt;Order&gt;().Join&lt;Customer&gt;());</code> </pre><br>  SQL: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"Order"</span></span>.<span class="hljs-string"><span class="hljs-string">"Id"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"OrderId"</span></span>, <span class="hljs-string"><span class="hljs-string">"Order"</span></span>.<span class="hljs-string"><span class="hljs-string">"Details"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"OrderDetails"</span></span>, <span class="hljs-string"><span class="hljs-string">"Order"</span></span>.<span class="hljs-string"><span class="hljs-string">"CustomerId"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer"</span></span>.<span class="hljs-string"><span class="hljs-string">"Name"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"CustomerName"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"Order"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">"Customer"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">"Customer"</span></span>.<span class="hljs-string"><span class="hljs-string">"Id"</span></span> = <span class="hljs-string"><span class="hljs-string">"Order"</span></span>.<span class="hljs-string"><span class="hljs-string">"CustomerId"</span></span>)</code> </pre><br>  The only prerequisite for the OrderInfo class is that its properties should be named by the pattern {TableName} {FieldName}. <br>  Method number 2 in the style of EF - use the navigation properties (in the terminology of OrmLite, they are referred to as "references"). <br>  To do this, add the following property to the Order class: <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Reference</span></span>] Customer Customer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre><br>  This property will be ignored in any requests of the form db.Select, which is very convenient.  To load related entities, use the db.LoadSelect method: <br><pre> <code class="cs hljs"> List&lt;Order&gt; orders = db.LoadSelect&lt;Order&gt;(); Assert.True(orders.All(order =&gt; order.Customer != <span class="hljs-literal"><span class="hljs-literal">null</span></span>));</code> </pre><br>  SQL: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"Id"</span></span>, <span class="hljs-string"><span class="hljs-string">"Details"</span></span>, <span class="hljs-string"><span class="hljs-string">"CustomerId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"Order"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"Id"</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"Customer"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">"Id"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"CustomerId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"Order"</span></span>)</code> </pre><br>  In a similar way, we can initialize the customer.Orders set. <br><br>  Note: in the examples given, the names of foreign keys in the related tables followed the {Parent} Id pattern, which allowed OrmLite to automatically select the columns to be connected by, thereby simplifying the code.  Alternatively, mark foreign keys with the attribute: <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">References(typeof(Parent))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? CustomerId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre><br>  and explicitly set the table columns for the connection: <br><pre> <code class="cs hljs"> SqlExpression&lt;Order&gt; expression = db .From&lt;Order&gt;() .Join&lt;Order, Customer&gt;((order, customer) =&gt; order.CustomerId == customer.Id); List&lt;Order&gt; orders = db.Select(expression);</code> </pre><br><a name="P4"></a><h3>  Lazy and async </h3><br>  Deferred SELECT queries are implemented via IEnumerable.  For * Lazy methods, concise queries using lambda expressions are not supported.  So SelectLazy is supposed ONLY to use parameterized SQL: <br><pre> <code class="cs hljs"> IEnumerable&lt;Product&gt; lazyQuery = db.SelectLazy&lt;Product&gt;(<span class="hljs-string"><span class="hljs-string">"UnitPrice &gt; @UnitPrice"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { UnitPrice = <span class="hljs-number"><span class="hljs-number">10</span></span> });</code> </pre><br>  that bypassing the enumeration is similar to the following call: <br><pre> <code class="cs hljs"> db.Select&lt;Product&gt;(q =&gt; q.UnitPrice &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>);</code> </pre><br>  For ColumnLazy (returns a list of values ‚Äã‚Äãin a table column) is additionally supported by SqlExpression: <br><pre> <code class="cs hljs"> IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; lazyQuery = db.ColumnLazy&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(db.From&lt;Product&gt;().Where(x =&gt; x.UnitPrice &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>));</code> </pre><br>  Unlike lazy queries, most of the OrmLite API has async versions: <br><pre> <code class="cs hljs"> List&lt;Employee&gt; employees = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.SelectAsync&lt;Employee&gt;(employee =&gt; employee.City == <span class="hljs-string"><span class="hljs-string">"London"</span></span>);</code> </pre><br><a name="P5"></a><h3>  Transactions </h3><br>  Supported: <br><pre> <code class="cs hljs"> db.DropAndCreateTable&lt;Employee&gt;(); Assert.IsTrue(db.Count&lt;Employee&gt;() == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (IDbTransaction transaction = db.OpenTransaction()) { db.Insert(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Employee {Name = <span class="hljs-string"><span class="hljs-string">"First"</span></span>}); transaction.Commit(); } Assert.IsTrue(db.Count&lt;Employee&gt;() == <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (IDbTransaction transaction = db.OpenTransaction()) { db.Insert(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Employee { Name = <span class="hljs-string"><span class="hljs-string">"Second"</span></span> }); Assert.IsTrue(db.Count&lt;Employee&gt;() == <span class="hljs-number"><span class="hljs-number">2</span></span>); transaction.Rollback(); } Assert.IsTrue(db.Count&lt;Employee&gt;() == <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br>  Under the hood of db.OpenTransaction is a call to <a href="https://msdn.microsoft.com/ru-ru/library/86773566(v%3Dvs.110).aspx">SqlConnection.BeginTransaction</a> , so we will not dwell on the topic of transactions. <br><br><a name="P6"></a><h3>  Row group operations  OrmLite and Entity Framework Performance Comparison </h3><br>  In addition to the different variations of the execution of SELECT queries, the OrmLite API offers 3 methods for modifying a group of rows in a database: <br><blockquote>  InsertAll (IEnumerable) <br>  UpdateAll (IEnumerable) <br>  DeleteAll (IEnumerable) <br></blockquote><br>  The behavior of OrmLite in this case is no different from the behavior of "adult" ORM, first of all the Entity Framework - we get one INSERT / UPDATE instruction per line in the database.  Although it would be interesting to look at the solution for INSERT using the <a href="https://msdn.microsoft.com/en-us/library/dd776382(v%3DSQL.100).aspx">Row Constructor</a> , but not fate.  Obviously, the difference in execution speed is formed mainly due to the architectural features of the frameworks themselves.  Is there such a big difference? <br>  Below are the measurements of the run-time sampling, insertion and modification of 10 <sup>3</sup> rows from the Order table using the Entity Framework and OrmLite.  The iteration is repeated 10 <sup>3</sup> times, and the table shows the <b>total</b> execution time (in seconds).  At each iteration, a new set of random data is generated and the table is cleared.  The code is available on <a href="https://github.com/aidforwork/PaperSource.EF.SqlBulkCopy">github</a> . <br><div class="spoiler">  <b class="spoiler_title">Test environment</b> <div class="spoiler_text">  .NET 4.5 <br>  MS SQL Server 2012 <br>  Entity Framework 6.1.3 (Code First) <br>  OrmLite 4.0.38 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text">  Entity Framework: <br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">//select context.Orders.AsNoTracking().ToList(); //insert context.Orders.AddRange(orders); context.SaveChanges(); //update context.SaveChanges();</span></span></code> </pre><br><br>  OrmLite: <br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">//select db.Select&lt;Order&gt;(); //insert db.InsertAll(orders); //update db.UpdateAll(orders);</span></span></code> </pre><br></div></div><br>  Runtime in seconds: <br><table><tbody><tr><td></td><td>  <b>Select</b> </td><td>  <b>Insert</b> </td><td>  <b>Update</b> </td></tr><tr><td>  EF </td><td>  4.0 </td><td>  282 </td><td>  220 </td></tr><tr><td>  Ormlite </td><td>  7.3 </td><td>  94 </td><td>  88 </td></tr></tbody></table><br>  OrmLite, are you serious?  Select slower than EF?  After these results, it was decided to write an additional test that measures the speed of reading 1 line by Id. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text">  Entity Framework: <br><pre> <code class="cs hljs"> context.Orders.AsNoTracking().FirstOrDefault(order =&gt; order.Id == id);</code> </pre><br>  OrmLite: <br><pre> <code class="cs hljs"> db.SingleById&lt;Order&gt;(id);</code> </pre><br></div></div><br>  Runtime in seconds: <br><table><tbody><tr><td></td><td>  <b>Select single by id</b> </td></tr><tr><td>  EF </td><td>  1.9 </td></tr><tr><td>  Ormlite </td><td>  1.0 </td></tr></tbody></table><br>  At this time, OrmLite almost double the odds, and that's not bad.  I don‚Äôt dare to talk about the reasons for the drop in performance when unloading a large number of rows from the database.  In most scenarios, OrmLite is still faster than EF, as has been shown, by a factor of 2-3. <br><br><div class="spoiler">  <b class="spoiler_title">About measurements and systematic error</b> <div class="spoiler_text">  Since the total execution time of the code on the client was measured, the execution time of the SQL instruction on the server introduces a systematic error in the measurements.  When using a high-loaded ‚Äúcombat‚Äù instance of SQL Server, we would get ‚Äúabout the same‚Äù execution times for both ORMs.  Obviously, the server should be as productive as possible and not loaded to get more accurate results. <br></div></div><br><a name="P7"></a><h3>  Conclusion </h3><br>  At the end of the article I would like to tell about my (certainly, subjective) impressions of working with OrmLite, summarize the advantages and disadvantages of this micro-ORM. <br><br>  Pros: <br><ul><li>  lightweight, easy to configure and deploy; </li><li>  simple CRUD requests are really easy to write; </li></ul><br>  Minuses: <br><ul><li>  the variability of query building (either lambda, or parameterized SQL, or SqlExpression) for different methods.  There is no uniform universal syntax supported by any method from the API; </li><li>  poor documentation: there are no XML comments to methods, official documentation is poorly structured and is located on a single web page; </li><li>  unclear API.  Try to guess right away what is the difference between db.Select, db.LoadSelect, db.Where calls?  Or db.Insert and db.Save?  Will navigation properties come from the database when db.Join is called? </li></ul><br>  These items increase the threshold of entry into the technology.  In part, this deprives OrmLite of one of the main advantages of the micro-ORM - simplicity and ease of use compared with the ‚Äúolder‚Äù ORM.  In general, I had a neutral impression.  OrmLite is certainly usable, but more was expected from a commercial product. </div><p>Source: <a href="https://habr.com/ru/post/256791/">https://habr.com/ru/post/256791/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256779/index.html">1 year in ABBYY: Part 2 - Base Complaints, Slippers and ABBYY Road</a></li>
<li><a href="../256783/index.html">Frontend Dev Conf'15 was held on April 18 in Minsk</a></li>
<li><a href="../256785/index.html">Visualizing OpenStreetMap data in 3D on the fly using Unity3D</a></li>
<li><a href="../256787/index.html">Not very big data and text toning</a></li>
<li><a href="../256789/index.html">Developing a simple plugin for JIRA to work with a database</a></li>
<li><a href="../256793/index.html">Why are you still hacked</a></li>
<li><a href="../256795/index.html">What kind of beast is HL7 Interoperability?</a></li>
<li><a href="../256797/index.html">New MSP432 Microcontroller Family</a></li>
<li><a href="../256799/index.html">Application KolibriOS. Part 1: Review</a></li>
<li><a href="../256801/index.html">How to save on the purchase of heavy iron</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>