<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A car dial tachometer for a beginner or some fixed-point shamanism on the AVR</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I would like to share with the community my own history of the modernization of the TX-193 tachometer 


 A week ago, I was approached by one p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A car dial tachometer for a beginner or some fixed-point shamanism on the AVR</h1><div class="post__text post__text-html js-mediator-article"> Hello!  I would like to share with the community my own history of the modernization of the TX-193 tachometer <br><img src="https://habrastorage.org/getpro/habr/post_images/279/5d6/640/2795d66405ee1136f8be2a5743f0abad.jpg" alt="image"><br><br>  A week ago, I was approached by one person with a rather non-standard task - it was necessary to ensure the operation of the ancient tachometer TX-193 (VAZ 2106) with a <s>modern</s> VAZ21126 (Priora) engine, which has an ignition system with individual coils for each cylinder, and therefore simply connect the TX-193 to the ignition coil will not work.  In addition, the customer wanted to improve the performance of the device, leaving untouched by its appearance and design.  In general, the matter ended with the fact that I undertook to gut the electronic filling of the device and develop my own, <s>with blackjack and whores</s> .  Information about the frequency of rotation of the crankshaft tachometer will now receive from the computer January 7.2, for which the latter has a special conclusion. <br><br>  Under the cut photo, video, scheme, source, and a lot of text, telling about logarithms and how to properly scale the data and get rid of the comma. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Hard</b> <br>  Let's start with the <a href="http://www.motolodka.ru/tx-193.htm">device TX-193</a> .  The mechanical part of the device is a milliammeter of a classical construction, with a permanent magnet and a moving coil, setting the arrow in motion. <br><br>  For the development of the circuit, in essence, it was enough to know about the milliammeter only that, at a current of the order of 10 mA, the arrow deviates to the limit, and the winding resistance is approximately 180 Ohm.  The ATtiny2313A controller from the renowned Atmel company, clocked from an external quartz crystal at 16 MHz, was chosen as the brain.  The device is powered from the vehicle‚Äôs on-board network, which means according to GOST it must withstand a ‚Äúbeard‚Äù up to 100V and work stably in the range from 9-15V.  Due to low consumption (several tens of milliamperes), it was decided to use a 7805 linear stabilizer with an inductive filter and a suppressor to protect against impulse noise.  The device was going from what was at hand, so the powerful version 7805 is used in the finished product, although 78L05 per 100mA would be enough. <br>  Milliammeter controller controls, of course, using PWM.  For which the 16-bit timer was used in the Phase and Frequency Correct PWM mode. <br>  Information about the frequency of rotation of the crankshaft is transmitted from the computer in the form of pulses from 0 - 12V.  The active level is low.  2 pulses per crankshaft revolution.  To capture these pulses, an external interrupt INT0 and the corresponding string from the RC filter, suspenders and protective diodes are used.  In general, the circuitry of the device is quite typical and I was surprised to find that I had just written so much about it.  But do not judge strictly, the first article after all. <br><img src="https://habrastorage.org/getpro/habr/post_images/50d/091/fcd/50d091fcda0ddd135202b8f088b1b19d.jpg"><br>  The assembled device without a dial now looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/c6b/788/f25/c6b788f25a64086f8fcb25d9272d1eb5.jpg"><br><br>  <b>Soft</b> <br>  In fact, even before drawing the scheme, I quickly assembled the whole thing on a breadboard, taking the controller in the DIP package and immediately started waving the arrow)) <br>  In general, the software was a little more interesting than hard. <br><br>  Let's start with the general architecture: <br>  Timer 0 ticks with a frequency of 250 kHz, which means the period of the tick = 4 Œºs overflow interrupt occurs with a frequency of 250 kHz / 256 = 0.976 kHz <br>  so an interrupt occurs once every 1024¬µs.  It was possible to be confused and adjust this matter closer to one millisecond by updating the timer counter in the interrupt, but in this task there is nothing.  Those.  we can measure time with an accuracy of 4 Œºs, which is quite enough for a given accuracy of the device. <br>  Timer 0 in our country not only counts time, but also sets checkboxes to run certain tasks at regular intervals. <br>  We have two tasks.  Giving INT0 interrupt to measure the period of the pulses at the input and change the position of the arrow. <br><br>  Timer 1 ticks at 16 MHz, but since  it is 16-bit and uses Phase and Frequency Correct PWM mode - the total PWM frequency is very small and is about 122 Hz.  This is because the timer ticks up first and then down.  But we have a true 16bit PWM and can very accurately steer the arrow!  There are all the details in the datasheet. <br>  The mechanics, by the way, turned out to be of disgusting quality, it was not realistic to move the needle smoothly due to the increased friction in the mechanism, which had to be started at least with lubricating gear oil.  But these are details. <br>  A table of the device readings correspondence with the corresponding value of the timer register in the PWM parrots was compiled. <br>  In the source, this case is called GAUGE_TABLE and is rendered out of habit into a separate file. <br><br>  It was further discovered that if you simply change the current in the ammeter circuit in one stroke in order, for example, to move the arrow 1000 forward, then it will make two or three or four oscillations in the area of ‚Äã‚Äãthe target mark, which was completely unacceptable and the customer paid special Attention.  The fact is that these tachometers initially have such a problem and several times gazanuv to the beat of the oscillations can cause the arrow to swing with a significant amplitude (more than half of the scale!). <br>  It was necessary to do something with it.  My idea was to bring the arrow to the mark with a series of smaller steps, gradually approaching the goal.  As a matter of fact, this part is the most interesting and useful for beginners, since  requires some skill.  After all, in dealing with a microcontroller, a call to log2 () in a cycle is, to put it mildly, not the most successful idea.  By the same 8-bit architecture imposes even more restrictions.  Well, about the "floating point" (floating point) and does need to forget.  But all these difficulties, as always, lead only to a deeper understanding of the processes and calculations made by the processor. <br><br>  For some reason, the text turns out to be more and more, but I just can‚Äôt stop at this point in more detail! <br>  So, it is clear that we need a logarithmic progression.  The step of changing the current in the milliammeter circuit should decrease as it approaches the target elevation.  Resources worth their weight in gold, which means only the tabular method.  Points, too, if possible at least. <br>  Let's start with building a logarithmic table. <br>  Everything is very simple: we run excel and with a few strokes of the mouse we get 50 values ‚Äã‚Äãof the logarithm of base 2 for a sequence from 1 to 50. For clarity, we build a beautiful graph. <img src="https://habrastorage.org/getpro/habr/post_images/15d/e54/6f8/15de546f87f23070e5653e1bf4ed1922.png"><br>  Perfectly!  Exactly what is needed!  But firstly - the points are as many as 50, and secondly all the floating point numbers.  It does not suit us! <br>  Therefore, we select 5 points from the existing array with a step of 10. We get something like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/c5f/35b/ccf/c5f35bccf1506423b46799d6b8c43d0e.png"><br><br>  Already better.  A consistent approach to the goal is still preserved, but the points are 10 times smaller. <br>  Next you need to normalize the resulting set.  Those.  make it so that all values ‚Äã‚Äãare in the range from 0 to 1. To do this, simply divide each element by 5.64385618977472 (the maximum value of our array). <br><img src="https://habrastorage.org/getpro/habr/post_images/3b3/524/2c9/3b35242c9892e0fbf708d165bfeff0e0.png"><br>  Thus, we get all the same logarithmic dependence, but already in a much more convenient form for further calculations.  Such a table can already be applied quite easily, if not a point after zero.  But with this, we are also pretty easy to understand. <br>  Now I want us to take a beautiful value of 1024 per unit and again recalculate our table.  Get <br><img src="https://habrastorage.org/getpro/habr/post_images/d30/9bc/e2b/d309bce2bac3ba5c5d657e26234e8040.png"><br><br>  As you can see, the form of the graph has not changed, but the numbers now fit into the 16-bit range and there are no fractions. <br>  In the source, the resulting array is called logtable [] <br><br>  The scaling factor (if you can call it that) 1024 appeared here not by chance and you need to understand very well why exactly 1024. <br>  First, it is a power of two and it is chosen because expensive division and multiplication operations by power of two can be replaced with a cheap left / right shift and it would be foolish not to use this opportunity. <br>  Secondly, the coefficient should be chosen based on the scale of the data to which it will be applied.  In our case, these are the register values ‚Äã‚Äãof the 16-bit timer, which controls the filling of the PWM.  Experimentally it was revealed that the unsatisfactory oscillations of the arrow are detected even with its sharp displacement at 200 rpm.  Those.  if you need to move the arrow to more than ~ 200 rpm - smoothing is required.  From the table GAUGE_TABLE it can be seen that neighboring cells differ on average by 4000 PWM parrots, which corresponds to approximately 500 rpm on the scale of the device.  It is not difficult to estimate that in numbers the offset of the arrow by 200ob will be 4000 / 2.5 = 1600 PWM parrots. <br>  Therefore, the scaling factor must be chosen so that firstly it is as large as possible, because otherwise we lose bits and accuracy, and secondly, as little as possible so as not to force us to switch from 16-bit variables to 32-bit variables and not to spend resources in vain.  As a result, we choose the smallest degree of two, which is less than 1600 and provides sufficient accuracy.  This will be 1024. <br>  This moment is very important.  I myself still sometimes have difficulty choosing the right coefficients and sizes of variables. <br><br>  Well, then it really went.  We find in the code the implementation of display_rpm () and see that the table GAUGE_TABLE [] is used to determine the specific value in the PWM parrots and the assumption that the scale between the adjacent marks is linear.  To organize the current change according to the logarithmic law, an array of 5 points pwm_cuve [] is entered which contains a set of values, which must be sequentially subtracted or added (depending on the direction of arrow movement) from pwm_ocr1a_cur_val to make the arrow move smoothly and clearly. <br>  each step is formed by multiplying the pwm_delta value by a factor from our logtable [] table; <br>  Before multiplication, the value is pre-scaled by dividing by 1024. <br>  The final target destination of the target_pwm arrow is written to pwm_cuve [] as it is, because due to problems with rounding and because the dimension of the variables is limited to 16 bits, the exact value as a result of the calculations will be formed there quite infrequently, so you have to ensure that the arrow will end its way at the given point. <br>  In general, all of the above is essentially a single line. <br> <code>pwm_cuve[ table_i ] = pwm_ocr1a_cur_val + (pwm_delta / LOG_TABLE_MAX * logtable[ table_i ]);</code> <br> <br>  Then, the main loop for the signal from the timer0 times in PWM_UPD_PERIOD raises the values ‚Äã‚Äãfrom pwm_cuve and assigns them to the variable pwm_ocr1a_cur_val, the value of which in the interrupt will be assigned to the OCR1A register, which will immediately lead to a change in the PWM filling and change the current in the milliammeter circuit. <br><br>  Here, in fact, almost all the tricks, except for the translation of the period presented in ticks of the timer in the rotational speed of the crankshaft, which is measured in revolutions per minute. <br>  All this has been reduced to <code>engine_rpm = (uint16_t)(15000000UL / (uint32_t)rot_time);</code> <br>  We can talk about how this figure turned out or not talk next time, because even without that text it turned out quite a few and obviously not many read it even to this point. <br><br>  Honestly speaking, several more ‚Äútricks‚Äù have been applied to the code in the code, which may seem to newbies not quite obvious.  If someone wants to find out more about it - velkam in kamenty and HP. <br><br>  <b>A bit of video, as promised</b> <br>  Do not pay attention to the accuracy of the readings, the hand is not normally dressed + the dial is not twisted. <br>  The movement of the arrow in increments of 1000 rpm in one jump. <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/kdxOLvQ8ing%3Ffeature%3Doembed&amp;xid=25657,15700022,15700186,15700190,15700253,15700256&amp;usg=ALkJrhhUZ2xXcjbmOkPdMd_vttJCj6GUAg" frameborder="0" allowfullscreen=""></iframe><br>  Smooth current change <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Tp6fVhyrCkw%3Ffeature%3Doembed&amp;xid=25657,15700022,15700186,15700190,15700253,15700256&amp;usg=ALkJrhgiWtGtOv5m5izVsb09x0Hq5FmeTQ" frameborder="0" allowfullscreen=""></iframe><br><br>  The point is clear that in reality there will be no jumps at 1000 rpm and those minor shooters, which, nevertheless, can be seen on the video will not become a problem.  Just if you eliminate them, then you can lose great in the speed of the device and its readings will lag behind reality. <br><br>  PS Not to say that the archive is completely govnokod, but yes, in some places it could be made more beautiful.  Yes, I know that magic numbers are bad and yes, I could have been better.  On the other hand, getting lost in the 200-line source is quite difficult, so in some places I allowed myself to do a bit of tinkering. <br>  I just wanted to check in on the Habr√© for a long time, and writing any detailed article after a while after the project implementation becomes more and more difficult, so I decided that today they would ‚Äúcarry on from the fields‚Äù. <br>  So the real code from a real device, assembled over a real period of 7 evenings, which tomorrow will be installed on a glorious VAZ 2108 car with a 21126 engine and I hope it will be a long time to please the owner, who agreed to pay 100 evergreens for my works. <br>  But we all know that I did this whole journey not only and not so much for the sake of money.  It's so nice when you created something and it even works! <br><br>  In the <s>archive</s> project Atmel studio and circuit + board in Altium designer.  The board was made by the LUT method. <br>  <b>UPD: The</b> archive was uploaded to a free file sharing service and therefore died suddenly.  To store the archive on habrastorage, I embedded it in the photo of the tachometer without a dial (it is at the top of the article).  In general, jpg need to save yourself and open winrar.  You can even simply change the extension to zip. <br>  <b>UPD2:</b> The scheme and the board are reworked, the pictures are updated, the archive is still in the picture. <br>  <b>UPD3</b> Archive is no longer inserted into pictures.  Write in the LAN here or find me <a href="http://vk.com/trotskyi">vk.com/trotskyi</a> <br><br>  See you again! <br><br>  Vehicle check <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/SuY1BF9hMgg%3Ffeature%3Doembed&amp;xid=25657,15700022,15700186,15700190,15700253,15700256&amp;usg=ALkJrhjp8QdSc01boT_gF2kq8mXqLEfmyA" frameborder="0" allowfullscreen=""></iframe><br>  The customer is very satisfied! <br>  And when I saw this article and all the sources, including some photos of the board manufacturing process itself - said that his brain was blown up! </div><p>Source: <a href="https://habr.com/ru/post/193892/">https://habr.com/ru/post/193892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193880/index.html">A passion for programming. Chapter 4. Be the worst</a></li>
<li><a href="../193882/index.html">Infection on the site - history by example</a></li>
<li><a href="../193886/index.html">The birth of magic from the spirit of the torrent protocol (scheme of the organization of a free uncensored indestructible information network)</a></li>
<li><a href="../193888/index.html">Writing a platformer in Python using pygame</a></li>
<li><a href="../193890/index.html">Python memory usage</a></li>
<li><a href="../193894/index.html">Review of modern heuristic optimization methods</a></li>
<li><a href="../193898/index.html">Cut off the finger does not help unlock the iPhone 5S</a></li>
<li><a href="../193900/index.html">Making your flying robot</a></li>
<li><a href="../193902/index.html">QA Test Assignment</a></li>
<li><a href="../193904/index.html">In Belarus, problems with access to Dropbox and DigitalOcean</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>