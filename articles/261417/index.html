<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Subtleties of ES6: Collections (Part 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: this is the second part of the translation of the article about the collection in EcmaScript 6. The first part can be read here ....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The Subtleties of ES6: Collections (Part 2)</h1><div class="post__text post__text-html js-mediator-article">  <i>From the translator:</i> this is the second part of the translation of the article about the collection in EcmaScript 6. The first part can be read <a href="http://habrahabr.ru/post/261187/">here</a> .  For various reasons, the translation of the second part was delayed for quite a long time. <br><br><h2>  Map </h2><br>  <code>Map</code> (associative array) is a collection of key-value pairs.  This is what the <code>Map</code> can do: <br><ul><li>  <code>new Map</code> returns a new empty associative array. </li><li>  <code>new Map(pairs)</code> creates a new associative array and fills it with data from an existing collection of <code>[key, value]</code> pairs.  This collection can be another Map object, an array of two-element arrays, a generator that returns two-element arrays, etc. </li><li>  <code>map.size</code> returns the number of elements in the associative array. </li><li>  <code>map.has(key)</code> checks if the key exists in the associative array. </li><li>  <code>map.get(key)</code> returns the value associated with the key, or undefined if there is no such key.  (similar to <code>obj[key]</code> ) </li><li>  <code>map.set(key, value)</code> adds an entry to the array associating key with value.  Overwrites the existing association, if any (similar to <code>obj[key]</code> ) </li><li>  <code>map.delete(key)</code> deletes the entry (similar to <code>delete obj[key]</code> ) </li><li>  <code>map.clear()</code> removes all entries in the associative array. </li><li>  <code>map[Symbol.iterator]()</code> iterates over the records in the associative array.  The iterator represents each record as an array of <code>[key, value]</code> . </li><li>  <code>map.forEach(f)</code> works like this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [key, value] <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> map) f(value, key, map);</code> </pre><br>  The strange order of the arguments is made by analogy with <code>Array.prototype.forEach()</code> <br></li><li>  <code>map.keys()</code> returns an iterator over the keys in an associative array. </li><li>  <code>map.values()</code> returns an iterator over the values ‚Äã‚Äãin an associative array. </li><li>  <code>map.entries()</code> returns an iterator over the records in the associative array, similar to <code>map[Symbol.iterator]()</code> .  In fact, in both cases the same method is called. </li></ul><br><br>  What is there to complain about?  Here are some features that are <b>not</b> in the ES6 collections, and which, I think, would be useful: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Fixture for defaults like <a href="https://docs.python.org/3/library/collections.html">collections.defaultdict</a> in Python. </li><li>  The <code>Map.fromObject(obj)</code> function, <code>Map.fromObject(obj)</code> , to make it easier to write associative arrays using the <i>object-literal syntax syntax</i> ( <i>Note: For</i> example, the object-literal syntax in ES is <code>{ "test" : 1 }</code> ) </li></ul><br><br>  Again, these features are easy to add. <br><br>  OK.  Remember how I started this article by thinking about how the care of JS execution in a browser affects the design of a language and its features?  Now we will start talking about it.  I have three examples.  Here are the first two. <br><br><h2>  JS differences, part 1: hash tables without hash codes? </h2><br>  There is one useful feature that, as far as I know, collection classes in ES6 do not support at all. <br><br>  Suppose we have a <code>Set</code> of URL objects. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> urls = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>; urls.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(location.href)); <span class="hljs-comment"><span class="hljs-comment">//  URL- urls.add(new URL(location.href)); //   ? alert(urls.size); // 2</span></span></code> </pre><br>  These two URLs must be interpreted as identical.  All fields have the same.  But in Javascript these are two different objects, and it‚Äôs impossible to overload the notion of language about the equality of objects. <br><br>  Other languages ‚Äã‚Äãsupport this.  In Java, Python, Ruby, individual classes can overload equality.  In many Scheme implementations, individual hash tables can be created using different concepts of equality.  C ++ supports both options. <br><br>  However, all these mechanisms require users to implement custom hash functions, and all of them expose the system hash function by default.  The committee decided not to put on hash codes in Javascript - at least for now - because of open questions about interoperability and security, which is not a reason for such concern in other languages. <br><br><h2>  JS Differences, Part 2: Surprise!  Predictable! </h2><br>  You probably think that deterministic behavior on the part of the computer is not a reason for surprise.  But people are often surprised when I tell them that the iteration over the elements in <code>Map</code> and <code>Set</code> occurs in the order they are added to the collection.  She is determined. <br><br>  We are used to the arbitrariness of certain aspects of hash tables.  We learned to accept it.  But there are damn good reasons to try to avoid accidents.  As I wrote in 2012: <br><ul><li>  There is evidence that some programmers find the arbitrary iteration order surprising and at first incomprehensible.  <a href="http://stackoverflow.com/questions/2453624/unsort-hashtable">[1]</a> <a href="http://stackoverflow.com/questions/1872329/storing-python-dictionary-entries-in-the-order-they-are-pushed">[2]</a> <a href="https://groups.google.com/forum/">[3]</a> <a href="http://bytes.com/topic/c-sharp/answers/439203-hashtable-items-order">[4]</a> <a href="http://stackoverflow.com/questions/1419708/how-to-keep-the-order-of-elements-in-hashtable">[5]</a> <a href="http://stackoverflow.com/questions/7105540/hashtable-values-reordered">[6]</a> </li><li>  The order of enumeration of properties is not specified in ECMAScript, however all large implementations are forced to converge on a specific insertion order, for compatibility.  Therefore, it is believed that if TC39 does not begin to specify a deterministic iteration order, "the web will do it for us."  <a href="https://mail.mozilla.org/pipermail/es-discuss/2012-February/020576.html">[7]</a> </li><li>  The iteration order of the hash table may reveal portions of the object hash codes.  This places a huge responsibility for security on the hash function implementer.  For example, the address of the object should not be recovered from the disclosed parts of its hash code (the disclosure of the address of the object to the untrusted ECMAScript code, although it cannot be exploited by the intruders by itself, would be a big security hole). </li></ul><br>  When it was discussed in February 2012, I <a href="https://mail.mozilla.org/pipermail/es-discuss/2012-February/020541.html">was in an arbitrary order of iteration</a> .  I conducted an experiment to prove that tracking the order of insertion would make the hash tables too slow.  I wrote a couple of benchmarks in C ++.  <a href="https://wiki.mozilla.org/User:Jorend/Deterministic_hash_tables">The result struck me.</a> <br><br>  This is how we ended up with hash tables that monitor the order of insertion in JS! <br><br><h2>  Good reasons to use weak collections </h2><br>  <a href="https://hacks.mozilla.org/2015/06/es6-in-depth-symbols/">In early June 2015,</a> we discussed an example that includes an animation library on JS.  We wanted to store a boolean flag for each DOM object, like this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (element.isMoving) { smoothAnimations(element); } element.isMoving = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre><br>  Unfortunately, setting expandable properties in a DOM object in this way is a bad idea, as discussed in the article.  In that article, we solved the problem using symbols.  But can we do the same using <code>Set</code> ?  It might look like this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (movingSet.has(element)) { smoothAnimations(element); } movingSet.add(element);</code> </pre><br>  There is only one drawback: <code>Map</code> and <code>Set</code> have a <i>strong reference</i> to each key and each value.  This means that if the DOM element has been removed from the document, the garbage collector cannot free memory until the element is removed from the <code>movingSet</code> .  Libraries usually cope with clearing the memory after themselves.  This can lead to memory leaks. <br><br>  ES6 offers an amazing solution for this.  Make <code>movingSet</code> <code>WeakSet</code> instead of <code>Set</code> .  The leak problem is solved! <br><br>  So, you can solve this problem with weak collections or symbols.  What's better?  The discussion about the advantages and disadvantages of each method will make this post too long.  If you can use one character throughout the life of a web page, then this is probably normal.  If you want to use a lot of short-lived characters, this is an alarming sign: consider using <code>WeakSet</code> instead to prevent memory leaks. <br><br><h2>  WeakMap and WeakSet </h2><br>  <code>WeakMap</code> and <code>WeakSet</code> specified to behave in the same way as <code>Map</code> and <code>Set</code> , but with the following restrictions: <br><ul><li>  <code>WeakMap</code> supports only <code>new, .has(), .get(), .set(), .delete()</code> . </li><li>  <code>WeakSet</code> supports only <code>new, .has(), .add(), .delete()</code> . </li><li>  The values ‚Äã‚Äãin <code>WeakSet</code> and the keys in <code>WeakMap</code> must be objects. </li></ul><br>  Notice that none of the weak collections are iterable.  You can not get records from the collection except by the corresponding key. <br><br>  These restrictions allow the garbage collector to collect dead objects from living weak collections.  A similar effect can be achieved with weak references or <i>weak-keyed dictionaries</i> , but weak collections in ES6 have all the advantages of memory management without disclosing the fact that garbage collection has occurred in the scripts. <br><br><h2>  JS differences, part 3: hiding undetected garbage collector </h2><br>  Under the hood, weak collections are implemented as <i>ephemeron tables</i> . <br><br>  In short, <code>WeakSet</code> does not keep strong references to objects within itself.  When an object in <code>WeakSet</code> is collected by the garbage collector, it is simply deleted from <code>WeakSet</code> .  Same for <code>WeakMap</code> .  It does not have strong references to any key.  If the key is alive, alive and meaningful. <br><br>  Why all these restrictions?  Why not just add weak links in JS? <br><br>  Again, the committee does not want to disclose non-deterministic behavior to scripts.  Weak cross-browser compatibility - the curse of web development.  Weak references reveal the details of the implementation of the garbage collector - the very definition of platform-specific arbitrary behavior.  Of course, applications should not depend on the details of a specific platform, but weak links make it difficult to understand how you depend on the behavior of the garbage collector in the current browser in which you run your application.  It's hard to deal with them. <br><br>  In contrast, weak collections in ES6 have a more limited, but strong set of features.  The fact that a key or a value has been assembled by the garbage collector is not observed, so that applications can in no way depend on it, even by accident. <br><br>  This is a specific case of how web-specific problems led to an amazing design solution that improved JS as a language. <br><br><h2>  Where can I use collections? </h2><br>  All four collection classes are supported in Firefox, Chrome, MS Edge and Safari.  To support older browsers, use a <a href="https://en.wikipedia.org/wiki/Polyfill">polyfill</a> type <a href="https://github.com/WebReflection/es6-collections">es6-collections</a> . <br><br>  <code>WeakMap</code> was first implemented in Firefox by Andreas Galom, a former Mozilla CTO.  Tom Schuster implemented <code>WeakSet</code> .  I implemented <code>Map</code> and <code>Set</code> .  Thanks to Tooru Fujisawa for the patches. <br><br>  Next week, the ‚ÄúSubtleties of ES6‚Äù take a two-week break.  This series of articles has told a lot, but some of the most powerful features of ES6 will be described.  Join us when we come back with new content on July 9th. </div><p>Source: <a href="https://habr.com/ru/post/261417/">https://habr.com/ru/post/261417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261403/index.html">How to treat a malfunctioning cloud provider</a></li>
<li><a href="../261405/index.html">Consolidation of offices in 3CX (Part 1. We use trunks)</a></li>
<li><a href="../261409/index.html">Import substitution, as was said</a></li>
<li><a href="../261413/index.html">Skin Detection in Wolfram Language (Mathematica)</a></li>
<li><a href="../261415/index.html">Your cloud hosting in 5 minutes. Part 1: Ansible, Docker, Docker Swarm</a></li>
<li><a href="../261419/index.html">CIFS in Android, or how I got files from a broken phone</a></li>
<li><a href="../261421/index.html">The magic of tensor algebra: Part 1 - what is a tensor and what is it for?</a></li>
<li><a href="../261425/index.html">Combining Qt and AdMob</a></li>
<li><a href="../261431/index.html">Remote work or freelancing in the outback. Aspects of communication. Part 2. There is a connection</a></li>
<li><a href="../261433/index.html">Good design, bad design ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>