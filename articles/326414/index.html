<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Operators for Kubernetes: how to run stateful applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The problem of stateful applications in Kubernetes 
 Configuration, launch and further scaling of applications and services are carried out simply whe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Operators for Kubernetes: how to run stateful applications</h1><div class="post__text post__text-html js-mediator-article"><h2>  The problem of stateful applications in Kubernetes </h2><br>  Configuration, launch and further scaling of applications and services are carried out simply when it comes to cases classified as stateless, i.e.  without saving the data.  It is convenient to launch such services in Kubernetes, using its standard API, because everything happens out of the box: according to standard configurations, without invoking any specificity and magic. <br><br>  Simply put, to launch five more copies of the PHP / Ruby / Python backend in a cluster, you only need to raise a new server 5 times and copy the sources.  Since both the source code and the init script lie in the image, scaling the stateless application becomes quite elementary.  As well known to lovers of containers and microservice architecture, difficulties begin for <b>stateful applications</b> , i.e.  with data storage such as databases and caches (MySQL, PostgreSQL, Redis, ElasticSearch, Cassandra ...).  This applies both to software that independently implements a quorum cluster (for example, Percona XtraDB and Cassandra), and software that requires separate control utilities (such as Redis, MySQL, PostgreSQL ...). <br><br>  Difficulties arise because the source code and the launch of the service becomes not enough - you need to perform some more actions.  At a minimum, copy the data and / or join the cluster.  More specifically, these services require an understanding of how to properly scale, update and reconfigure them without losing data and their temporary unavailability.  Accounting for these needs is called ‚Äúoperational knowledge‚Äù. <br><a name="habracut"></a><br><h2>  CoreOS operators </h2><br>  In order to ‚Äúprogram‚Äù operational knowledge, at the end of last year, the CoreOS project <a href="https://coreos.com/blog/introducing-operators.html">introduced a</a> ‚Äúnew software class‚Äù for the Kubernetes platform ‚Äî Operators (Operators, from the English word ‚Äúoperation‚Äù, ie, ‚Äúoperation‚Äù). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Operators, using and extending the basic capabilities of Kubernetes (including <i>StatefulSets</i> , for the difference with which see below), allow DevOps specialists to add operational knowledge to the application code. <br><br>  <b>The goal of the Operator</b> is to provide the user with an API that allows him to manage the many entities of a stateful application in the Kubernetes cluster, not thinking about what is under his hood (what data and what to do with it, what commands need to be executed to maintain the cluster).  In fact, the Operator is designed to maximally simplify work with the application within the cluster, automating the performance of operational tasks that previously had to be solved manually. <br><br><h2>  How Operators Work </h2><br>  <i>ReplicaSets</i> in Kubernetes allow you to specify the desired number of running hearths, and controllers ensure that their number is maintained (creating and deleting hearths).  The Operator works in a similar way, which adds to the standard resource and the Kubernetes controller a set of operational knowledge that allows you to perform additional actions to maintain the required number of application entities. <br><br>  How is this different from <i>StatefulSets</i> intended for applications requiring the cluster to provide them with stateful resources such as data storage or static IP?  For such applications, Operators can use <i>StatefulSets</i> (instead of <i>ReplicaSets</i> ) as a basis, offering <b>additional automation</b> : perform necessary actions in case of crashes, make backups, update configuration, etc. <br><br>  So <b>how does all this work?</b>  The operator is a daemon controller that: <br><br><ol><li>  Subscribes to the event API in Kubernetes </li><li>  obtains data about the system from it (about its <i>ReplicaSets</i> , <i>Pods</i> , <i>Services</i> , etc.); </li><li>  obtains data about the <i>Third Party Resources</i> (see examples below); </li><li>  reacts to the appearance / change of the <i>Third Party Resources</i> (for example, to change the size, change the version, and so on); </li><li>  responds to changes in the state of the system (about its <i>ReplicaSets</i> , <i>Pods</i> , <i>Services</i> , etc.); </li><li>  the most important thing: <br><br><ol><li>  calls the Kubernetes API to create everything you need (again, your <i>ReplicaSets</i> , <i>Pods</i> , <i>Services</i> ...), </li><li>  performs some magic (it is possible, for simplicity, to think that the Operator comes into the platforms themselves and calls commands, for example, to join a cluster or to upgrade the data format when updating a version). </li></ol></li></ol><br><img src="https://habrastorage.org/files/6f0/d33/6fb/6f0d336fbeb3497eb9bd9a9388974073.png"><br>  In fact, as can be seen from the image, a separate application is simply added to Kubernetes (normal <i>Deployment</i> with <i>ReplicaSet</i> ), which is called the Operator.  It lives in the usual pod (usually one and only) and, as a rule, is responsible only for its <i>Namespace</i> .  This operator application implements its API - though not directly, but through the <i>Third Party Resources</i> at Kubernetes. <br><br>  Thus, after we have created an Operator in <i>Namespace</i> , we can add <i>Third Party Resources to it</i> . <br><br>  Example for etcd <i>(see below</i> for <i>details)</i> : <br><br><pre><code class="plaintext hljs">apiVersion: etcd.coreos.com/v1beta1 kind: Cluster metadata: name: example-etcd-cluster spec: size: 3 version: 3.1.0</code> </pre> <br>  Example for Elasticsearch: <br><br><pre> <code class="plaintext hljs">apiVersion: enterprises.upmc.com/v1 kind: ElasticsearchCluster metadata: name: example-es-cluster spec: client-node-replicas: 3 master-node-replicas: 2 data-node-replicas: 3 zones: - us-east-1c - us-east-1d - us-east-1e data-volume-size: 10Gi java-options: "-Xms1024m -Xmx1024m" snapshot: scheduler-enabled: true bucket-name: elasticsnapshots99 cron-schedule: "@every 2m" storage: type: gp2 storage-class-provisioner: kubernetes.io/aws-ebs</code> </pre><br><h2>  Requirements for Operators </h2><br>  In CoreOS, they formulated the main patterns obtained by engineers during the work on the Operators.  Despite the fact that all Operators are individual (created for a specific application with their own features and needs), their creation should be based on a kind of framework that makes the following requirements: <br><br><ol><li>  Installation should be done through a single <i>Deployment</i> : <i>kubectl create -f SOME_OPERATOR_URL / deployment.yaml</i> - and do not require additional actions. </li><li>  When installing the Operator in Kubernetes, a new third-party type <i>(ThirdPartyResource)</i> should be created.  For launching application instances (cluster instances) and further managing them (updating versions, resizing, etc.) the user will use this type. </li><li>  Whenever possible, you need to use the primitives built into Kubernetes, such as <i>Services</i> and <i>ReplicaSets</i> , in order to use well-tested and understandable code. </li><li>  It requires backward compatibility of Operators and support for old versions of resources created by the user. </li><li>  When removing the Operator, the application itself should continue to function without changes. </li><li>  Users should be able to determine the desired version of the application and perform orchestration of the application version updates.  The lack of software updates is a frequent source of operational and security problems, therefore Operators should assist users in this matter. </li><li>  Operators should be tested with a tool like Chaos Monkey, which identifies potential failures in subframes, configurations and networks. </li></ol><br><h2>  etcd Operator </h2><br>  <b>An example of the implementation of the Operator</b> - etcd Operator, <a href="https://coreos.com/blog/introducing-the-etcd-operator.html">prepared</a> for the day of the announcement of this concept.  Cluster configuration etcd can be complicated due to the need to maintain a quorum, the need to reconfigure cluster membership, create backups, etc.  For example, scaling a cluster etcd means manually creating a DNS name for a new cluster member, starting a new etcd entity, notifying the cluster about a new member ( <i>etcdctl member add</i> ).  In the case of the Operator, it will be enough for the user to change the cluster size - everything else will happen automatically. <br><br>  And since etcd was also created in CoreOS, it was quite logical to see the appearance of its Operator first.  How does he work?  <b>The etcd operator logic is</b> defined by three components: <br><br><ol><li>  Observation (Observe).  The operator monitors the cluster status by the Kubernetes API. </li><li>  Analyze  Finds the difference between the current status and the desired one (defined by the user configuration). </li><li>  Action (Act).  Eliminates differences using the etcd and / or Kubernetes API. </li></ol><br><img src="https://habrastorage.org/files/fb9/f71/6dd/fb9f716dd19b4c549edee65f97353b53.png"><br><br>  To implement this logic, the Operator has prepared the functions <b>Create / Destroy</b> (creating and deleting cluster members etcd) and <b>Resize</b> (changing the number of cluster members).  Checking the correctness of its performance was checked using a utility created in the likeness of Chaos Monkey from Netflix, i.e.  killing pods etcd randomly. <br><br>  For full operation, etcd, the Operator provides additional features: <b>Backup</b> (automatic and invisible for users to create backup copies - it‚Äôs enough to determine in the config file how often to do them and how many to keep, and then restore data from them) and <b>Upgrade</b> (updating etcd installations without just me). <br><br>  How does the work with the operator look like? <br><br><pre> <code class="bash hljs">$ kubectl create -f https://coreos.com/operators/etcd/latest/deployment.yaml $ kubectl create -f https://coreos.com/operators/etcd/latest/example-etcd-cluster.yaml $ kubectl get pods NAME READY STATUS RESTARTS AGE etcd-cluster-0000 1/1 Running 0 23s etcd-cluster-0001 1/1 Running 0 16s etcd-cluster-0002 1/1 Running 0 8s etcd-cluster-backup-tool-rhygq 1/1 Running 0 18s</code> </pre><br>  The current status of etcd Operator is a beta version that requires Kubernetes 1.5.3+ and etcd 3.0+ to work.  Source code and documentation (including instructions for use) are available on <a href="https://github.com/coreos/etcd-operator">GitHub</a> . <br><br>  Another implementation example from CoreOS, <a href="https://github.com/coreos/prometheus-operator">Prometheus Operator</a> , has been created, but it is still in alpha version (not all planned functions are implemented). <br><br><h2>  Status and prospects </h2><br>  5 months have passed since the announcement of the Kubernetes Operators.  In the official CoreOS repository, only two implementations are still available (for etcd and Prometheus).  Both have not yet reached their stable versions, but commits are observed daily in them. <br><br>  The developers expect ‚Äúa future in which users install Postgres Operators, Cassandra Operators or Redis Operators in their Kubernetes clusters and work with scalable entities of these applications as easily as today happens with the replica of stateless web applications‚Äù.  First <b>Operators from third-party developers</b> really began to appear: <br><br><ul><li>  <a href="https://github.com/upmc-enterprises/elasticsearch-operator">Elasticsearch Operator</a> from UPMC Enterprises; </li><li>  <a href="http://info.crunchydata.com/blog/postgres-operator-for-kubernetes">PostgreSQL Operator</a> from Crunchy Data (announced at the end of March 2017.); </li><li>  <a href="">Rook Operator</a> from the authors of Ceph based distributed storage system (Rook is in alpha status); </li><li>  <a href="https://github.com/sapcc/kubernetes-operators">Openstack Operators</a> from SAP CCloud. </li></ul><br>  At the largest European free software conference FOSDEM, which was held in February 2017 in Brussels, Josh Wood from CoreOS announced the Operators in the <a href="https://fosdem.org/2017/schedule/event/kubeoperators/">report</a> (video available on the link!), Which should contribute to the growing popularity of this concept in the wider Open Source community. <br><br>  <i><b>PS</b> Thank you for your interest in the article!</i>  <i><b>Subscribe to our hub</b> , not to miss new materials and recipes on DevOps and GNU / Linux system administration - we will publish them regularly!</i> </div><p>Source: <a href="https://habr.com/ru/post/326414/">https://habr.com/ru/post/326414/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326404/index.html">Why do some startups win</a></li>
<li><a href="../326406/index.html">Visualization of simple geometry in WPF</a></li>
<li><a href="../326408/index.html">Ubuntu 17.04: what's new</a></li>
<li><a href="../326410/index.html">Courier client interaction and scaling service</a></li>
<li><a href="../326412/index.html">20 interesting observations that I brought from the States and the Valley</a></li>
<li><a href="../326416/index.html">Replacing sim-cards. Chapter III. Fighting with bureaucracy</a></li>
<li><a href="../326418/index.html">Open machine learning course. Topic 8. Gigabyte training with Vowpal Wabbit</a></li>
<li><a href="../326420/index.html">Overview of the Citrix XenServer 7.1 Hypervisor Innovations</a></li>
<li><a href="../326424/index.html">Playstation VR games that can already be played</a></li>
<li><a href="../326428/index.html">node.js beats binary data when working on http because of the default encoding - we treat and hate</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>