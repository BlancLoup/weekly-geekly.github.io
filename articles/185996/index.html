<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Interesting sort behavior in .NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with the fact that at work with colleagues began to fall tests. And only her one. I won't go into details, but the point is that there ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Interesting sort behavior in .NET</h1><div class="post__text post__text-html js-mediator-article">  It all started with the fact that at work with colleagues began to fall tests.  And only her one.  I won't go into details, but the point is that there were two List objects in the test.  The first was the reference, and the second was returned by the test method.  Then the sheets were compared element by element. <br>  Very quickly, the reason for the drop in the test was clarified: with a colleague, the order of the elements in the resulting array was the reverse of the order in the reference array.  In the code of the tested method, the standard List.Sort with our comparator was used, which is exactly on this test that always returns 0. But for the whole team the elements were returned in the same order, and for one employee - strictly in reverse.  It was quickly found out that her colleague had not had updates for a long time and her version of mscorlib.dll was very different from the one that others had.  It would be possible to calm down on this, but it became interesting to me, I decided to dig further and this is what I found out. <a name="habracut"></a><br>  The contents of the sheet after sorting and up to with the same elements may differ, because  according to <a href="http://msdn.microsoft.com/en-us/library/b0zbh7b6">msdn</a> in list.sort, QuickSort is used, which, as we all know, is unstable.  However, there is one interesting feature.  About her further. <br><br>  Take this code: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">fkComparer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Smth { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> X; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Y; } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SmthComparer</span></span> : <span class="hljs-title"><span class="hljs-title">IComparer</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Smth</span></span>&gt; { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> Implementation of IComparer&lt;in smth&gt; public int Compare(Smth x, Smth y) { Result.Count++; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(xY &lt; yY) return -1; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(xY &gt; yY) return 1; return 0; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> } internal static class Result { public static int Count; } internal class Program { static void Main() { List&lt;Smth&gt; list = new List&lt;Smth&gt; {new Smth {X = 4, Y = 4}, new Smth {X = 5, Y = 4}, new Smth {X = 6, Y = 4}}; SmthComparer comparrer = new SmthComparer(); for (int i = 0; i &lt; aaa.Count; i++) { Console.WriteLine(list[i].X); } Console.WriteLine("***************"); aaa.Sort(comparrer); Console.WriteLine(Result.Count); Console.WriteLine("***************"); for(int i = 0; i &lt; aaa.Count; i++) { Console.WriteLine(list[i].X); } Console.ReadLine(); } } }</span></span></code> </pre> </div></div><br><br>  In principle, nothing special.  There is a Smth structure in which there are two fields.  There is a comparer to this structure.  We saturate the sheet with three structures identical for the comparator, display the contents of the sheet before sorting, then sort, then display the number of comparisons that were made, then display the contents of the sheet after sorting. <br>  Now let's see what they give out three different versions of the .NET Framework. <br><div class="spoiler">  <b class="spoiler_title">.NET Framework 4.0 Version mscorlib.dll 4.0.30319.17929</b> <div class="spoiler_text">  four <br>  five <br>  6 <br>  *************** <br>  3 <br>  *************** <br>  four <br>  five <br>  6 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">.NET Framework 4.0 Version mscorlib.dll 4.0.30319.18047</b> <div class="spoiler_text">  four <br>  five <br>  6 <br>  *************** <br>  7 <br>  *************** <br>  6 <br>  five <br>  four <br></div></div><br><div class="spoiler">  <b class="spoiler_title">.NET Framework 4.5</b> <div class="spoiler_text">  four <br>  five <br>  6 <br>  *************** <br>  3 <br>  *************** <br>  four <br>  five <br>  6 <br></div></div><br>  As you can see, in the older version of .NET, the sorting is stable and only three comparisons are performed.  In the latest version of .NET 4.0, the sorting is unstable and seven (!) Comparisons are performed.  In .NET 4.5, sorting is again stable and 3 comparisons are performed again. <br>  Those.  The new version of .NET 4.0 processes the same elements more slowly.  To confirm this, I increased the number of identical elements to 100 and received 813 comparisons in the latest version of .NET 4.0, and in .NET 4.0 of the old version and in .NET 4.5, 390. <br>  Thus, it turns out that Microsoft did everything right, then wrong, then right again.  Besides, this problem can haunt me like an olympiadnik somewhere. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ZY: I wrote my own most simple quick sorting with counting the number of comparisons: <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sort</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> right</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> l = left; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> r = right; Smth m = list[left + (right - left) / <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { Result.Count++; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(list[l].Y &lt; mY) { l++; Result.Count++; } Result.Count++; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(list[r].Y &gt; mY) { r--; Result.Count++; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(l &lt; r) { Smth t = list[l]; list[l] = list[r]; list[r] = t; l++; r--; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(l &gt;= r) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(left &lt; r) Sort(left, r); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(right &gt; l) Sort(l, right); }</code> </pre><br></div></div><br>  And even she gave out that comparisons were only 744. That is,  fewer calls than comparers in the latest version of .NET 4.0 </div><p>Source: <a href="https://habr.com/ru/post/185996/">https://habr.com/ru/post/185996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185984/index.html">Bitcoin mining as a sport</a></li>
<li><a href="../185986/index.html">Overview of the Grandstream GXW 4216 gateway + test at maximum load</a></li>
<li><a href="../185988/index.html">Smartphone with three interchangeable panels. The first in Russia. Highscreen Omega Prime XL</a></li>
<li><a href="../18599/index.html">Piracy!?</a></li>
<li><a href="../185990/index.html">Nikon wants to change the concept of the camera to compete with smartphones</a></li>
<li><a href="../185998/index.html">Heroku and Russia</a></li>
<li><a href="../186/index.html">Accoona on Euronews</a></li>
<li><a href="../1860/index.html">Schmidt predicts politics with an eye on the Internet</a></li>
<li><a href="../18600/index.html">Honest revenue sharing network</a></li>
<li><a href="../186000/index.html">BitMessage Protocol Description</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>