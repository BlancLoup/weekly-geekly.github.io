<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing messaging between browser tabs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the first article in our corporate blog. This time I will talk about our solution to the problem of messaging between browser tabs. 

 For exa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing messaging between browser tabs</h1><div class="post__text post__text-html js-mediator-article">  This is the first article in our corporate blog.  This time I will talk about our solution to the problem of messaging between browser tabs. <br><br>  For example, I needed to solve this problem when implementing the JavaScript API to the <a href="http://comet-server.ru/">Comet service</a> .  This task is encountered quite often and it has already been considered in Habr√© earlier <a href="http://habrahabr.ru/post/247739/">here</a> and <a href="http://habrahabr.ru/post/220297/">here</a> , but I decided to write my own solution for the problem based on the following code requirements: <br><br><ul><li>  Cross-browser compatibility </li><li>  No dependencies </li><li>  Minimum code size </li><li>  Simplicity and convenience </li></ul><br><a name="habracut"></a><br>  I implemented my <a href="">mini library</a> in the style of <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B">signals and slots</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is a very convenient model and it seems to me that in this example is the best fit.  The advantage of this approach is the weak connectivity of interacting components.  In short, the model of signals and slots gives us the following possibilities: <br><ul><li>  The code that emits a signal may not know anything about the code that processes this signal.  He does not even know if this code is there or if it is broadcasting into the void; </li><li>  The code receiving the signal does not know nothing about the sender; </li><li>  The only thing that is common is the message format. </li></ul><br>  Here, for example, we need to notify all the subscribing functions of an event. <br>  To do this, perform: <br><br><pre><code class="javascript hljs">tabSignal().emitAll(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-comment"><span class="hljs-comment">//      tabSignal().emit( '', "" ) //      </span></span></code> </pre>  All the code worked and if someone was subscribed to this event, he will receive the data. <br><br>  To subscribe to an event, you must pass the name of the event to which you subscribe and callBack to call in case the event occurs. <br><br><pre> <code class="javascript hljs">tabSignal().connect(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">param, signal_name</span></span></span><span class="hljs-function">)</span></span>{ });</code> </pre><br>  You can also transfer the name of the slot, it may be needed if you suddenly decide to unsubscribe from event notifications. <br><br><pre> <code class="javascript hljs">tabSignal().connect(<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">param, signal_name</span></span></span><span class="hljs-function">)</span></span>{} );</code> </pre><br>  Here param will contain the message itself.  And signal_name is the name of the signal, it is useful in case you signed one callBack for several different signals <br><br>  Here is the code in case you need to unsubscribe from the event. <br><br><pre> <code class="javascript hljs">tabSignal().disconnect(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>);</code> </pre><br>  To transfer data to another contribution, the library simply writes them to the local storage browser.  In order to receive data, the library subscribes to the onstorage event, it occurs in all tabs, when someone writes something in local storage. <br><br>  I did not burden the library itself with the function of selecting the master tab, so I will bring it here.  At the same time we will analyze the algorithm of its work.  But to begin with, I‚Äôll tell you what it took to find the master tab.  As already said, I was developing the JavaScript API for the comet service. <br><br>  <a href="http://comet-server.ru/">Technology Comet</a> allows you to send messages to the browser on the initiative of the server.  This has many uses, the most obvious is to <a href="https://comet-server.ru/%25D1%2580%25D0%25B0%25D0%25B7%25D0%25B4%25D0%25B5%25D0%25BB/15/subject/12">create a chat</a> between users or a user and technical support.  Or, for example, the dynamic loading of new tweets on Twitter as they appear. <br><br>  To send push notifications to the browser, you must have a constantly open connection between the browser and the comets server.  But many people open the site in more than one tab and it would be useful if only one of the open tabs kept the actual connection to the comets server, and all the open tabs used this connection.  This approach not only saves server resources, but also solves a very important problem - a limit on the number of simultaneous open connections. <br><br>  For example, chrome opens no more than 6 requests to a single domain and no more than 255 requests in the amount of all open tabs - no matter which of the domains.  Accordingly, if you maintain a separate connection from the comets server on each tab, you can open no more than 6 tabs, and then everything. <br><br>  Accordingly, based on this task, I decided that the master tab will be the first of the open tabs, and if it is closed, then the master will be the random of the remaining ones.  To do this, the master tab sends a message to all tabs every 150 milliseconds that it exists. <br><br>  When you open a tab, we subscribe to receive notifications from the master tab. <br><br>  Then we set the timer at least for 300ms, and if during this time we do not receive notifications from the master, then we believe that there is no master, and we are for it.  In such cases, we start sending notifications that we have a master tab every 50ms, and if we receive a notification from the master tab, we cancel the set timer and immediately put it back - and so on until the master tab has time to remind of its existence less than 300ms. <br><br><div class="spoiler">  <b class="spoiler_title">Implementation in code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryStartMasterTab</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">masterCallback, slaveCallback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> time_id = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> start_timer = <span class="hljs-number"><span class="hljs-number">2000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.InTryStartMasterTab !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">" "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> InTryStartMasterTab; } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">" tryStartMasterTab"</span></span>); InTryStartMasterTab = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> setAsMaster = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//        tabSignal().disconnect("comet_msg_connect", 'comet_msg_master_signal'); //           tabSignal().emitAll('comet_msg_master_signal'); //           setInterval(function() { tabSignal().emitAll('comet_msg_master_signal'); console.log(" !"); $("#consultantHolder").html(" !"); }, start_timer/8); InTryStartMasterTab = 1; if(masterCallback) { masterCallback(); } }; //             , //   start_timer         tabSignal().connect("comet_msg_connect",'comet_msg_master_signal', function() { if(time_id !== false) //          { console.log(" slave!, clearTimeout(time_id="+time_id+")"); $("#consultantHolder").html(" slave!"); clearTimeout( time_id ); time_id = setTimeout(setAsMaster, start_timer ); } if(InTryStartMasterTab === 0) { if(slaveCallback) slaveCallback(); } InTryStartMasterTab = -1; }); //  ,        start_timer       time_id = setTimeout(setAsMaster, start_timer ); }</span></span></code> </pre><br></div></div><br><br>  But as <a href="http://habrahabr.ru/users/beliyadm/" class="user_link">beliyadm</a> noted <a href="http://habrahabr.ru/users/beliyadm/" class="user_link">,</a> this approach sometimes fails with a large number of tabs, and taking advantage of the <a href="http://habrahabr.ru/company/comet-server/blog/250719/">advice</a> from <a href="http://habrahabr.ru/users/marcusaurelius/" class="user_link">Marcus Aurelius,</a> I introduced a system of priorities in the process of selecting the master tab. <br>  The priority is the time of opening a tab with milliseconds + a random number from 0 to 10,000 and the smaller the result, the higher the priority is obtained. <br><br><div class="spoiler">  <b class="spoiler_title">Improved implementation with priority system</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryStartMasterTab</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">masterCallback, slaveCallback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> time_id = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> interval_id = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> start_timer = <span class="hljs-number"><span class="hljs-number">2000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.InTryStartMasterTab !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">" "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> InTryStartMasterTab; } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">" tryStartMasterTab"</span></span>); InTryStartMasterTab = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Today = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> TabId = (Today.getTime() *<span class="hljs-number"><span class="hljs-number">1000</span></span> + Today.getMilliseconds())*<span class="hljs-number"><span class="hljs-number">10000</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor( <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random()*<span class="hljs-number"><span class="hljs-number">10000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> slaveloop = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EventData</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(time_id !== <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-comment"><span class="hljs-comment">//          { console.log(" slave!, clearTimeout(time_id="+time_id+")"); clearTimeout( time_id ); time_id = setTimeout(setAsMaster, start_timer ); } if(InTryStartMasterTab === 0) { if(slaveCallback) slaveCallback(); } InTryStartMasterTab = -1; }; var setAsMaster = function(){ //    ,   TabId tabSignal().emitAll('comet_msg_new_master', TabId); time_id = setTimeout(function() { //        tabSignal().disconnect("comet_msg_connect", 'comet_msg_master_signal'); //           tabSignal().emitAll('comet_msg_master_signal', TabId); //           interval_id = setInterval(function() { tabSignal().emitAll('comet_msg_master_signal', TabId); console.log(" !"); }, start_timer/8); InTryStartMasterTab = 1; if(masterCallback) { masterCallback(); } }, start_timer); }; //        tabSignal().connect('comet_msg_new_master', function(EventTabId) { if(EventTabId == TabId) { //  ventTabId == TabId      . return; } if(EventTabId &gt; TabId) { //   TabId                return; } //    EventTabId &lt; TabId             //          .        . if(time_id !== false) //          { console.log(" slave!, clearTimeout(time_id="+time_id+")"); clearTimeout( time_id ); time_id = setTimeout(setAsMaster, start_timer ); } if(interval_id !== false) //    slave       { clearTimeout( interval_id ); //             , //   start_timer         tabSignal().connect("comet_msg_connect",'comet_msg_master_signal', slaveloop); } slaveCallback(); }); //             , //   start_timer         tabSignal().connect("comet_msg_connect",'comet_msg_master_signal', slaveloop); //  ,        start_timer       time_id = setTimeout(setAsMaster, start_timer ); }</span></span></code> </pre><br></div></div><br><br>  At the end cite <a href="https://comet-server.ru/doc/example/TabSignal.js/index.html">online demo</a> . <br>  Repository <a href="">TabSignal.js</a> . </div><p>Source: <a href="https://habr.com/ru/post/250719/">https://habr.com/ru/post/250719/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250707/index.html">Astra Linux Common Edition 1.10 Review</a></li>
<li><a href="../250709/index.html">Monitoring Methods in DWDM Systems (Part 2)</a></li>
<li><a href="../250711/index.html">Studying the project folder structure in Unity - version control systems</a></li>
<li><a href="../250715/index.html">Wide Search (BFS) in C #</a></li>
<li><a href="../250717/index.html">Last night amazon fell in europe</a></li>
<li><a href="../250721/index.html">HighLoad in the platform for online auto parts stores</a></li>
<li><a href="../250723/index.html">Ara, yes? Or the modular smartphone of the future</a></li>
<li><a href="../250725/index.html">Results of testing algorithms of Russian biometric companies in the world market</a></li>
<li><a href="../250727/index.html">DIY Math Package for Android</a></li>
<li><a href="../250729/index.html">How to simplify the verification of a bank card holder for online payments?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>