<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering rendering "The Witcher 3"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I began to deal with the rendering of The Witcher 3. This game has amazing rendering techniques. In addition, it is great in terms of plot /...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering rendering "The Witcher 3"</h1><div class="post__text post__text-html js-mediator-article">  Recently, I began to deal with the rendering of The Witcher 3.  This game has amazing rendering techniques.  In addition, it is great in terms of plot / music / gameplay. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e5b/54e/95e/e5b54e95e53d14c22be446c3de24f8c3.jpg"></div><br><br>  In this article, I‚Äôll talk about the solutions used to render The Witcher 3. It will not be as comprehensive as the analysis of the graphics of Adrian Correg√©‚Äôs <a href="https://habr.com/company/ua-hosting/blog/271931/">GTA V</a> , at least for now. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will start with the reverse engineering tonal correction. <br><a name="habracut"></a><br><h2>  Part 1: Tone Correction </h2><br>  In most modern AAA games, one of the stages of rendering is the tonal correction. <br><br>  Let me remind you that in real life there is a fairly wide range of brightness, while at computer screens it is very limited (8 bits per pixel, which gives us 0-255).  It is here that tonemapping comes to the rescue, allowing you to fit a wider one in a limited light interval.  Usually there are two data sources in this process: HDR-image with a floating point, the color values ‚Äã‚Äãof which exceed 1.0, and the average illumination of the scene (the latter can be calculated in several ways, even taking into account the adaptation of the eye to simulate the behavior of human eyes, but here it does not matter) <br><br>  The next (and last) stage is to obtain an exposure, calculate the color with an exposure and process it using the tone correction curve.  And here everything becomes quite confusing, because new concepts appear, such as ‚Äúwhite point‚Äù (white point) and ‚Äúmiddle gray‚Äù (middle gray).  There are at least a few popular curves, and some of them are discussed in Matt Pettin√©o <a href="https://mynameismjp.wordpress.com/2010/04/30/a-closer-look-at-tone-mapping/">‚Äôs</a> article <a href="https://mynameismjp.wordpress.com/2010/04/30/a-closer-look-at-tone-mapping/">‚ÄúA Closer Look at Tone Mapping‚Äù</a> . <br><br>  To be honest, I always had problems with the correct implementation of tone mapping in my own code.  There are at least a <a href="https://github.com/walbourn/directx-sdk-samples/tree/master/HDRToneMappingCS11">few</a> <a href="https://software.intel.com/en-us/articles/compute-shader-hdr-and-bloom">different</a> <a href="https://mynameismjp.wordpress.com/2010/04/30/a-closer-look-at-tone-mapping/">examples</a> on the net that have been helpful to me ... to some extent.  Some of them take into account the HDR-brightness / point of white / medium gray, others do not - so they do not really help.  I wanted to find a ‚Äúproven in battles‚Äù implementation. <br><br>  We will work in RenderDoc with the capture of this frame of one of the main quests of Novigrad.  All settings are set to maximum: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/406/c2d/e21/406c2de21d4e934e0f25d0e6331fd272.jpg"></div><br>  With a bit of searching, I found the draw challenge for tone correction!  As I mentioned above, there is a buffer of HDR colors (texture number 0, full resolution) and average scene brightness (texture number 1, 1x1, floating point, computed earlier by the compute shader). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9fe/836/3bd/9fe8363bdeda3b9e7336f0f67fc41dc3.jpg"></div><br>  Let's take a look at the pixel shader assembler code: <br><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 4 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>) 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>) 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ftou</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wxyz</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 21: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 22: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 23: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 24: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 25: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 26: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 27: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 28: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 29: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 30: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 31: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 32: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 33: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 34: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  Here it is worth noting a few points.  First, the loaded brightness does not necessarily have to be used, because it is limited (max / min calls) within the values ‚Äã‚Äãchosen by the artists (from the constant buffer).  This is convenient because it allows you to avoid too slow or slow shutter speeds.  This move seems rather trivial, but I have never done this before.  Secondly, the one who is familiar with the tone correction curves will instantly recognize this value ‚Äú11.2‚Äù, because in fact this is the value of the white point from <a href="http://filmicworlds.com/blog/filmic-tonemapping-operators/">the Uncharted2</a> John Heyble <a href="http://filmicworlds.com/blog/filmic-tonemapping-operators/">tone correction</a> curve. <br><br>  AF parameters are loaded from cbuffer. <br><br>  So, we have three more parameters: cb3_v16.x, cb3_v16.y, cb3_v16.z.  We can explore their meanings: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a52/975/78b/a5297578b0069fdded06bd3e82f2fadf.jpg"></div><br>  My guesses: <br><br>  I believe that ‚Äúx‚Äù is a kind of ‚Äúwhite scale‚Äù or medium gray because it is multiplied by 11.2 (line 4), and then used as a numerator in calculating the shutter speed setting (line 10). <br><br>  ‚ÄúY‚Äù - I called it ‚Äúthe multiplier of the numerator u2‚Äù, and soon you will see why. <br><br>  ‚ÄúZ‚Äù is the ‚Äúexponentiation parameter‚Äù because it is used in the log / mul / exp three (in fact, in exponentiation). <br><br>  But treat these variable names with a bit of skepticism! <br><br>  Also: <br><br>  cb3_v4.yz - min / max values ‚Äã‚Äãof permissible brightness, <br>  cb3_v7.xyz - AC parameters of the curve Uncharted2, <br>  cb3_v8.xyz - parameters of the DF curve Uncharted2. <br><br>  Now let's get down to the complex - we will write the HLSL shader, which will give us exactly the same assembly code. <br><br>  This can be very difficult, and the longer the shader, the more difficult the task.  Fortunately, some time ago I wrote a tool that allows you to quickly view hlsl-&gt; asm. <br><br>  Ladies and gentlemen ... welcome D3DShaderDisassembler! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/394/463/6ec/3944636ec3737e5e1ff5463e7b89d49f.jpg"></div><br>  Having experimented with the code, I received a ready-made HLSL <b><i>tone correction The Witcher 3</i></b> : <br><br><pre> <code class="hljs pgsql"> cbuffer cBuffer : register (b3) { <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v0; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v1; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v2; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v3; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v4; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v5; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v6; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v7; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v8; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v9; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v10; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v11; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v12; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v13; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v14; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v15; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v16, cb3_v17; } Texture2D TexHDRColor : register (t0); Texture2D TexAvgLuminance : register (t1); struct VS_OUTPUT_POSTFX { <span class="hljs-type"><span class="hljs-type">float4</span></span> Position : SV_Position; }; float3 U2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 x ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F)) - E/F; } float3 ToneMapU2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 color, <span class="hljs-type"><span class="hljs-type">float</span></span> numMultiplier ) { float3 numerator = U2Func( A, B, C, D, E, F, color ); numerator = max( numerator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); numerator.rgb *= numMultiplier; float3 denominator = U2Func( A, B, C, D, E, F, <span class="hljs-number"><span class="hljs-number">11.2</span></span> ); denominator = max( denominator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> numerator / denominator; } <span class="hljs-type"><span class="hljs-type">float4</span></span> ToneMappingPS( VS_OUTPUT_POSTFX <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>) : SV_Target0 { <span class="hljs-type"><span class="hljs-type">float</span></span> avgLuminance = TexAvgLuminance.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( int3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ); avgLuminance = clamp( avgLuminance, cb3_v4.y, cb3_v4.z ); avgLuminance = max( avgLuminance, <span class="hljs-number"><span class="hljs-number">1e-4</span></span> ); <span class="hljs-type"><span class="hljs-type">float</span></span> scaledWhitePoint = cb3_v16.x * <span class="hljs-number"><span class="hljs-number">11.2</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> luma = avgLuminance / scaledWhitePoint; luma = pow( luma, cb3_v16.z ); luma = luma * scaledWhitePoint; luma = cb3_v16.x / luma; float3 HDRColor = TexHDRColor.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( uint3(<span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>.Position.xy, <span class="hljs-number"><span class="hljs-number">0</span></span>) ).rgb; float3 color = ToneMapU2Func( cb3_v7.x, cb3_v7.y, cb3_v7.z, cb3_v8.x, cb3_v8.y, cb3_v8.z, luma*HDRColor, cb3_v16.y); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">float4</span></span>(color, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  A screenshot from my utility to confirm this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f9c/1e9/70a/f9c1e970a743cac54c9129261514c3e1.jpg"></div><br>  Voila! <br><br>  I think this is a fairly accurate implementation of the TW3 tone correction, at least in terms of assembly code.  I have already applied it in my framework and it works great! <br><br>  I said ‚Äúenough‚Äù because I <i>have no idea</i> why the denominator in ToneMapU2Func becomes maximum at zero.  When dividing by 0, it should be undefined? <br><br>  This could be finished, but almost by chance I found another version of the TW3 tone correction shader in this frame, used for a beautiful sunset (interestingly, it is used with minimal graphics settings!) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/292/25b/bea/29225bbeae55c97c5a83e3461f7f24a7.jpg"></div><br>  Let's check it out.  First, the assembler shader code: <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[18]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 5 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>) 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ftou</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyz</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 21: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 22: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 23: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyz</span></span> 24: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 25: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 26: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 27: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 28: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 29: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 30: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 31: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 32: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 33: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 34: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 36: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>) 37: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 38: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 39: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 40: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 41: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 42: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 43: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 44: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 45: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 46: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 47: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 48: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 49: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 50: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 51: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 52: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 53: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 54: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 55: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 56: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 57: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 58: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 59: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 60: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 61: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 62: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 63: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 64: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[13]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 65: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 66: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  At first, the code may look frightening, but in fact not everything is so bad.  After a brief analysis, you can see that there are two calls to the Uncharted2 function with different sets of input data (AF, min / max brightness ...).  I have never met such a decision before. <br><br>  And HLSL: <br><br><pre> <code class="hljs pgsql"> cbuffer cBuffer : register (b3) { <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v0; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v1; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v2; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v3; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v4; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v5; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v6; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v7; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v8; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v9; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v10; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v11; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v12; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v13; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v14; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v15; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v16, cb3_v17; } Texture2D TexHDRColor : register (t0); Texture2D TexAvgLuminance : register (t1); float3 U2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 x ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F)) - E/F; } float3 ToneMapU2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 color, <span class="hljs-type"><span class="hljs-type">float</span></span> numMultiplier ) { float3 numerator = U2Func( A, B, C, D, E, F, color ); numerator = max( numerator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); numerator.rgb *= numMultiplier; float3 denominator = U2Func( A, B, C, D, E, F, <span class="hljs-number"><span class="hljs-number">11.2</span></span> ); denominator = max( denominator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> numerator / denominator; } struct VS_OUTPUT_POSTFX { <span class="hljs-type"><span class="hljs-type">float4</span></span> Position : SV_Position; }; <span class="hljs-type"><span class="hljs-type">float</span></span> getExposure(<span class="hljs-type"><span class="hljs-type">float</span></span> avgLuminance, <span class="hljs-type"><span class="hljs-type">float</span></span> minLuminance, <span class="hljs-type"><span class="hljs-type">float</span></span> maxLuminance, <span class="hljs-type"><span class="hljs-type">float</span></span> middleGray, <span class="hljs-type"><span class="hljs-type">float</span></span> powParam) { avgLuminance = clamp( avgLuminance, minLuminance, maxLuminance ); avgLuminance = max( avgLuminance, <span class="hljs-number"><span class="hljs-number">1e-4</span></span> ); <span class="hljs-type"><span class="hljs-type">float</span></span> scaledWhitePoint = middleGray * <span class="hljs-number"><span class="hljs-number">11.2</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> luma = avgLuminance / scaledWhitePoint; luma = pow( luma, powParam); luma = luma * scaledWhitePoint; <span class="hljs-type"><span class="hljs-type">float</span></span> exposure = middleGray / luma; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exposure; } <span class="hljs-type"><span class="hljs-type">float4</span></span> ToneMappingPS( VS_OUTPUT_POSTFX <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>) : SV_Target0 { <span class="hljs-type"><span class="hljs-type">float</span></span> avgLuminance = TexAvgLuminance.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( int3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ); <span class="hljs-type"><span class="hljs-type">float</span></span> exposure1 = getExposure( avgLuminance, cb3_v9.y, cb3_v9.z, cb3_v17.x, cb3_v17.z); <span class="hljs-type"><span class="hljs-type">float</span></span> exposure2 = getExposure( avgLuminance, cb3_v4.y, cb3_v4.z, cb3_v16.x, cb3_v16.z); float3 HDRColor = TexHDRColor.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( uint3(<span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>.Position.xy, <span class="hljs-number"><span class="hljs-number">0</span></span>) ).rgb; float3 color1 = ToneMapU2Func( cb3_v11.x, cb3_v11.y, cb3_v11.z, cb3_v12.x, cb3_v12.y, cb3_v12.z, exposure1*HDRColor, cb3_v17.y); float3 color2 = ToneMapU2Func( cb3_v7.x, cb3_v7.y, cb3_v7.z, cb3_v8.x, cb3_v8.y, cb3_v8.z, exposure2*HDRColor, cb3_v16.y); float3 finalColor = lerp( color2, color1, cb3_v13.x ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">float4</span></span>(finalColor, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  That is, in fact, we have two sets of control parameters, we calculate two colors with tone correction, and at the end we interpolate them.  Smart decision! <br><br><h2>  Part 2: eye adaptation </h2><br>  The second part will be much easier. <br><br>  In the first part, I showed how tone correction is performed in TW3.  Explaining the theoretical foundations, I briefly mentioned the adaptation of the eye.  And you know what?  In this part I will talk about how this adaptation of the eye is realized. <br><br>  But wait, what is eye adaptation and why do we need it?  <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B4%25D0%25B0%25D0%25BF%25D1%2582%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_%25D0%25B3%25D0%25BB%25D0%25B0%25D0%25B7%25D0%25B0">Wikipedia</a> knows everything about it, but I will explain: imagine that you are in a dark room (remember Life is Strange) or in a cave, and go outside, where it is light.  For example, the main source of lighting could be the sun. <br><br>  In the dark, our pupils are dilated, so that more light will fall through them to the retina.  When it becomes light, our pupils shrink and sometimes we close our eyes because it is ‚Äúpainful.‚Äù <br><br>  This change does not happen instantly.  The eye must adapt to changes in brightness.  That is why we adapt the eye when rendering in real time. <br><br>  A good example of when the lack of eye adaptation is noticeable is the <a href="https://github.com/walbourn/directx-sdk-samples/tree/master/HDRToneMappingCS11">HDRToneMappingCS11</a> from the DirectX SDK.  Abrupt changes in average brightness are rather unpleasant and unnatural. <br><br>  Let's get started!  For the sake of consistency, we will analyze the same frame from Novigrad. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/406/c2d/e21/406c2de21d4e934e0f25d0e6331fd272.jpg"></div><br>  Now we delve into the frame capture program RenderDoc.  Eye adaptation is usually performed right before the tone correction, and The Witcher 3 is no exception. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ed/fde/eec/8edfdeeec29fef781801b94948c90e6f.png"></div><br>  Let's look at the state of the pixel shader: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e68/2fd/2f4/e682fd2f410f32eb8661c2476c8a2294.jpg"></div><br>  We have two sources of input data - 2 textures, R32_FLOAT, 1x1 (one pixel).  texture0 contains the average brightness of the scene from the previous frame.  texture1 contains the average brightness of the scene from the current frame (calculated immediately before this compute shader - I marked it in blue). <br><br>  It is expected that there is one output - R32_FLOAT, 1x1.  Let's look at the pixel shader. <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 1 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yxzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ge</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">movc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  Wow, how simple!  Only 7 lines of assembly code.  What's going on here?  I will explain each line: <br><br>  0) Get the average brightness of the current frame. <br>  1) Get the average brightness of the previous frame. <br>  2) Perform a check: is the current brightness less than or equal to the brightness of the previous frame? <br>  If yes, then the brightness decreases, if not, the brightness increases. <br>  3) Calculate the difference: <i>difference = currentLum - previousLum.</i> <br>  4) This conditional transfer (movc) assigns a rate factor from the constant buffer.  Depending on the result of the test from line 2, two different values ‚Äã‚Äãcan be assigned.  This is a smart move, because so you can get different speeds of adaptation and to reduce and increase the brightness.  But in the frame under study, both values ‚Äã‚Äãare the same and vary from 0.11 to 0.3. <br>  5) The final calculation of the adapted brightness: <i>adaptedLuminance = speedFactor * difference + previousLuminance.</i> <br>  6) Shader End <br><br>  This is implemented in HLSL quite simply: <br><br><pre> <code class="hljs pgsql"> // The Witcher <span class="hljs-number"><span class="hljs-number">3</span></span> eye adaptation shader cbuffer cBuffer : register (b3) { <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v0; } struct VS_OUTPUT_POSTFX { <span class="hljs-type"><span class="hljs-type">float4</span></span> Position : SV_Position; }; SamplerState samplerPointClamp : register (s0); SamplerState samplerPointClamp2 : register (s1); Texture2D TexPreviousAvgLuminance : register (t0); Texture2D TexCurrentAvgLuminance : register (t1); <span class="hljs-type"><span class="hljs-type">float4</span></span> TW3_EyeAdaptationPS(VS_OUTPUT_POSTFX <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>) : SV_TARGET { // <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> previous luminance. <span class="hljs-type"><span class="hljs-type">float</span></span> currentAvgLuminance = TexCurrentAvgLuminance.SampleLevel( samplerPointClamp2, float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-type"><span class="hljs-type">float</span></span> previousAvgLuminance = TexPreviousAvgLuminance.SampleLevel( samplerPointClamp, float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span> ); // Difference <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> previous luminance. <span class="hljs-type"><span class="hljs-type">float</span></span> difference = currentAvgLuminance - previousAvgLuminance; // Scale factor. Can be different <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">both</span></span> falling down <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rising up <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> luminance. // It affects speed <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> adaptation. // Small conditional test <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> performed here, so different speed can be <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> differently <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">both</span></span> these cases. <span class="hljs-type"><span class="hljs-type">float</span></span> adaptationSpeedFactor = (currentAvgLuminance &lt;= previousAvgLuminance) ? cb3_v0.x : cb3_v0.y; // Calculate adapted luminance. <span class="hljs-type"><span class="hljs-type">float</span></span> adaptedLuminance = adaptationSpeedFactor * difference + previousAvgLuminance; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adaptedLuminance; }</code> </pre> <br>  These lines give us the same assembly code.  I would just suggest replacing the type of output data from <i>float4</i> to <i>float</i> .  No need for wasteful bandwidth.  This is how the adaptation of the eye is implemented in Witcher 3.  Pretty simple, right? <br><br>  Ps.  Many thanks to Baldur Karlsson (Twitter: <a href="https://twitter.com/baldurk">@baldurk</a> ) for RenderDoc.  The program is just great. <br><br><h2>  Part 3: chromatic aberration </h2><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A5%25D1%2580%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B0%25D1%258F_%25D0%25B0%25D0%25B1%25D0%25B5%25D1%2580%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">Chromatic aberration</a> is an effect mainly found in cheap lenses.  It occurs because the lenses have different refractive index for different lengths of visible light.  As a result, it appears a visible distortion.  However, not everyone likes it.  Fortunately, in Witcher 3, this effect is very subtle, and therefore not annoying during the game process (me, at least).  But if you want, you can turn it off. <br><br>  Let's take a closer look at an example of a scene with and without chromatic aberration: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a5e/078/853/a5e0788530c688f849013ff3ed64134f.png"></div><br>  <i>Chromatic aberration enabled</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d8d/20f/ee7/d8d20fee7a901301b9f2e5f67a2f56be.png"></div><br>  <i>Chromatic aberration disabled</i> <br><br>  Do you notice any differences near the edges?  Me neither.  Let's try another scene: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cff/9a3/b41/cff9a3b41c135e4c43cd3065328dc235.png"></div><br>  <i>Chromatic aberration is enabled.</i>  <i>Notice a slight ‚Äúred‚Äù distortion in the indicated area.</i> <br><br>  Yeah, much better!  Here the contrast between the dark and light areas is stronger, and in the corner we see a slight distortion.  As you can see, this effect is very weak.  However, I was wondering how it is implemented.  Let's move on to the most curious part: the code! <br><br>  <b>Implementation</b> <br><br>  The first thing to do is to find the desired render call with a pixel shader.  In fact, chromatic aberration is part of the ‚Äúfinal post-processing‚Äù large pixel shader, which consists of chromatic aberration, vignetting and gamma correction.  All this is inside a single pixel shader.  Let's take a closer look at the assembler code of the pixel shader: <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[18]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">linear</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 4 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">lt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">if_nz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>) 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">endif</span></span> ...</code> </pre> <br>  And to the cbuffer values: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7d9/e1d/6b6/7d9e1d6b60039074712ea0e60dba2ae0.jpg"></div><br>  So, let's try to understand what is happening here.  Essentially, cb3_v17.xy is the center of chromatic aberration, so the first lines calculate the 2d vector from the coordinates of texels (cb3_v17.zw = the reciprocal of the viewport size) to the ‚Äúcenter of chromatic aberration‚Äù and its length, then performs other calculations, testing and branching .  When applying chromatic aberration, we calculate the displacements using some values ‚Äã‚Äãfrom the buffer of the constants and distort the R and G channels. In general, the closer to the edges of the screen, the stronger the effect.  Line 10 is quite interesting because it causes the pixels to ‚Äúmove closer‚Äù, especially when we exaggerate the aberration.  I am pleased to share with you my realization of the effect.  As usual, take the names of variables with (solid) skepticism.  And note that the effect is applied <i>before</i> gamma correction. <br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">void</span></span> ChromaticAberration( float2 uv, <span class="hljs-keyword"><span class="hljs-keyword">inout</span></span> float3 color ) { // <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-defined params float2 chromaticAberrationCenter = float2(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>); <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationCenterAvoidanceDistance = <span class="hljs-number"><span class="hljs-number">0.2</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> fA = <span class="hljs-number"><span class="hljs-number">1.25</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> fChromaticAbberationIntensity = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> fChromaticAberrationDistortionSize = <span class="hljs-number"><span class="hljs-number">0.75</span></span>; // Calculate vector float2 chromaticAberrationOffset = uv - chromaticAberrationCenter; chromaticAberrationOffset = chromaticAberrationOffset / chromaticAberrationCenter; <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationOffsetLength = length(chromaticAberrationOffset); // <span class="hljs-keyword"><span class="hljs-keyword">To</span></span> avoid applying chromatic aberration <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> center, subtract small <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> // just calculated length. <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationOffsetLengthFixed = chromaticAberrationOffsetLength - chromaticAberrationCenterAvoidanceDistance; <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationTexel = saturate(chromaticAberrationOffsetLengthFixed * fA); <span class="hljs-type"><span class="hljs-type">float</span></span> fApplyChromaticAberration = (<span class="hljs-number"><span class="hljs-number">0.0</span></span> &lt; chromaticAberrationTexel); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fApplyChromaticAberration) { chromaticAberrationTexel *= chromaticAberrationTexel; chromaticAberrationTexel *= fChromaticAberrationDistortionSize; chromaticAberrationOffsetLength = max(chromaticAberrationOffsetLength, <span class="hljs-number"><span class="hljs-number">1e-4</span></span>); <span class="hljs-type"><span class="hljs-type">float</span></span> fMultiplier = chromaticAberrationTexel / chromaticAberrationOffsetLength; chromaticAberrationOffset *= fMultiplier; chromaticAberrationOffset *= g_Viewport.zw; chromaticAberrationOffset *= fChromaticAbberationIntensity; float2 offsetUV = -chromaticAberrationOffset * <span class="hljs-number"><span class="hljs-number">2</span></span> + uv; color.r = TexColorBuffer.SampleLevel(samplerLinearClamp, offsetUV, <span class="hljs-number"><span class="hljs-number">0</span></span>).r; offsetUV = uv - chromaticAberrationOffset; color.g = TexColorBuffer.SampleLevel(samplerLinearClamp, offsetUV, <span class="hljs-number"><span class="hljs-number">0</span></span>).g; } }</code> </pre> <br>  I added ‚ÄúfChromaticAberrationIntensity‚Äù to increase the size of the offset, and hence the effect strength, as the name implies (TW3 = 1.0).  Intensity = 40: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/864/69e/aea/86469eaea28862b558fa90784b8c4585.png"></div><br>  That's all!  Hope you enjoyed this part. <br><br><h2>  Part 4: Vignetting </h2><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B8%25D0%25BD%25D1%258C%25D0%25B5%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">Vignetting</a> is one of the most common post-processing effects used in games.  He is popular in photography.  Slightly shaded corners can create a beautiful effect.  There are several types of vignetting.  For example, the <a href="">Unreal Engine 4</a> uses natural.  But back to The Witcher 3. <a href="https://international.download.nvidia.com/geforce-com/international/comparisons/the-witcher-3-wild-hunt/the-witcher-3-wild-hunt-vignette-interactive-comparison-1-on-vs-off.html">Click here</a> to see an interactive comparison of frames with and without vignetting.  The comparison is taken from <a href="https://www.geforce.com/whats-new/guides/the-witcher-3-wild-hunt-graphics-performance-and-tweaking-guide">The Witcher 3's NVIDIA performance manual</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b27/b52/986/b27b52986e845f39a32710276adc9fa8.png"></div><br>  <i>Screenshot from The Witcher 3 with vignetting turned on.</i> <br><br>  Note that the upper left corner (the sky) is not as obscured as other parts of the image.  We'll come back to this later. <br><br>  <b>Implementation details</b> <br><br>  First, there is a slight difference between the vignetting used in the original version of The Witcher 3 (which was released on May 19, 2015) and in The Witcher 3: Blood and Wine.  In the first, the ‚Äúreverse gradient‚Äù is calculated inside the pixel shader, and in the last, it is calculated in advance in a 256x256 2D texture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/455/0b4/c1d/4550b4c1d1a0ae80923cd75cd63c3e7f.jpg"></div><br>  The texture is 256x256, used as a ‚Äúreverse gradient‚Äù in the ‚ÄúBlood and Wine‚Äù supplement. <br><br>  I will use a shader from Blood and Wine (great game, by the way).  As in most other games, the Witcher 3 vignetting is computed in the final post-processing pixel shader.  Take a look at the assembler code: <br><br><pre> <code class="hljs css"> ... 44: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 45: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.454545</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.454545</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.454545</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 46: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 47: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 48: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s2</span></span> 49: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 50: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 51: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 52: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[6]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 53: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 54: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[6]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 55: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 56: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 57: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> ...</code> </pre> <br>  Interesting!  It seems that both gamma (line 46) and linear spaces (line 51) are used to calculate vignetting.  In line 48, we sample the ‚Äúreverse gradient‚Äù texture.  cb3 [9] .xyz is not associated with vignetting.  In each scanned frame, it is assigned the value float3 (1.0, 1.0, 1.0), that is, it is probably the final filter used in the effects of fade-in / fade-out gradually dimming / lightening the screen.  TW3 has three main parameters for vignetting: <br><br><ul><li>  Opacity (cb3 [6] .w) - affects the power of vignetting.  0 - no vignetting, 1 - maximum vignetting.  According to my observations, in the base The Witcher 3 it is approximately equal to 1.0, and in ‚ÄúBlood and Wine‚Äù it fluctuates around 0.15. </li><li>  Color (cb3 [7] .xyz) - an excellent feature of TW3 vignetting is the ability to change its color.  It does not have to be black, but in practice ... It usually has the values ‚Äã‚Äãfloat3 (3.0 / 255.0, 4.0 / 255.0, 5.0 / 255.0) and so on - in general, these are multiples of 0.00392156 = 1.0 / 255.0 </li><li>  Weights (cb3 [6] .xyz) is a very interesting parameter.  I have always seen ‚Äúflat‚Äù vignettes, such as: </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a25/9e8/7f9/a259e87f9e5bbfc3edf6b4ff30aea90d.png"></div><br>  <i>Typical Vignette Mask</i> <br><br>  But with the help of weights (line 52) you can get very interesting results: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c0/c88/6c0/6c0c886c0175635ba609ef61e61b3ea3.png"></div><br>  <i>TW3 vignetting mask calculated using weights</i> <br><br>  Weights are close to 1.0.  Look at the data buffer constants of one frame from ‚ÄúBlood and Wine‚Äù (of the magical world with a rainbow): that is why vignetting did not affect the bright pixels of the sky mentioned above. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68a/2a9/9e5/68a2a99e54b0c8cf9e71561001315a34.png"></div><br>  <b>Code</b> <br><br>  Here is my implementation of TW3 vignetting on HLSL. <br><br>  GammaToLinear = pow (color, 2.2) <br><br><pre> <code class="hljs pgsql"> <span class="hljs-comment"><span class="hljs-comment">/* // The Witcher 3 vignette. // // Input color is in gamma space // Output color is in gamma space as well. */</span></span> float3 Vignette_TW3( <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float3 gammaColor, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float3 vignetteColor, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float3 vignetteWeights, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> vignetteOpacity, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Texture2D texVignette, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float2 texUV ) { // <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> coloring vignette float3 vignetteColorGammaSpace = -gammaColor + vignetteColor; // Calculate vignette amount based <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> color <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> *LINEAR* color space <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> vignette weights. <span class="hljs-type"><span class="hljs-type">float</span></span> vignetteWeight = dot( GammaToLinear( gammaColor ), vignetteWeights ); // We need <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> keep vignette weight <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>] range vignetteWeight = saturate( <span class="hljs-number"><span class="hljs-number">1.0</span></span> - vignetteWeight ); // Multiply <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> opacity vignetteWeight *= vignetteOpacity; // Obtain vignette mask (here <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> texture; you can <span class="hljs-keyword"><span class="hljs-keyword">also</span></span> calculate your custom mask here) <span class="hljs-type"><span class="hljs-type">float</span></span> sampledVignetteMask = texVignette.Sample( samplerLinearClamp, texUV ).x; // Final (inversed) vignette mask <span class="hljs-type"><span class="hljs-type">float</span></span> finalInvVignetteMask = saturate( vignetteWeight * sampledVignetteMask ); // final composite <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gamma space float3 Color = vignetteColorGammaSpace * finalInvVignetteMask + gammaColor.rgb; // * uncomment <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> vignette mask: // <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span> - finalInvVignetteMask; // <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> final color <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Color; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hope you enjoyed it. </font><font style="vertical-align: inherit;">You can also try my </font></font><a href="http://astralcode.blogspot.com/2018/02/hlslexplorer-is-out.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLSLexplorer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which greatly helped me in understanding the HLSL assembly code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As before, take the names of the variables with a bit of skepticism - TW3 shaders are processed by D3DStripShader, so I don‚Äôt really know anything about them, I just have to guess. </font><font style="vertical-align: inherit;">In addition, I do not bear any responsibility for the damage inflicted on your equipment by this shader;) </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus: calculating the gradient</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In Witcher 3, released in 2015, the inverse gradient was calculated in a pixel shader, and no sampling of a pre-calculated texture was used. </font><font style="vertical-align: inherit;">Take a look at the assembler code:</font></font><br><br><pre> <code class="hljs css"> 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.500000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.500000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 36: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 37: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 38: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.550000</span></span>) 39: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.219512</span></span>) 40: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 41: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span> 42: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.105000</span></span>, 1<span class="hljs-selector-class"><span class="hljs-selector-class">.120000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.090000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 43: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.940000</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fortunately for us, it is quite simple. </font><font style="vertical-align: inherit;">On HLSL, it will look something like this:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">float</span></span> TheWitcher3_2015_Mask( <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float2 uv ) { <span class="hljs-type"><span class="hljs-type">float</span></span> distanceFromCenter = length( uv - float2(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) ); <span class="hljs-type"><span class="hljs-type">float</span></span> x = distanceFromCenter * <span class="hljs-number"><span class="hljs-number">2.0</span></span> - <span class="hljs-number"><span class="hljs-number">0.55</span></span>; x = saturate( x * <span class="hljs-number"><span class="hljs-number">1.219512</span></span> ); // <span class="hljs-number"><span class="hljs-number">1.219512</span></span> = <span class="hljs-number"><span class="hljs-number">100</span></span>/<span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> x2 = x * x; <span class="hljs-type"><span class="hljs-type">float</span></span> x3 = x2 * x; <span class="hljs-type"><span class="hljs-type">float</span></span> x4 = x2 * x2; <span class="hljs-type"><span class="hljs-type">float</span></span> outX = dot( <span class="hljs-type"><span class="hljs-type">float4</span></span>(x4, x3, x2, x), <span class="hljs-type"><span class="hljs-type">float4</span></span>(<span class="hljs-number"><span class="hljs-number">-0.10</span></span>, <span class="hljs-number"><span class="hljs-number">-0.105</span></span>, <span class="hljs-number"><span class="hljs-number">1.12</span></span>, <span class="hljs-number"><span class="hljs-number">0.09</span></span>) ); outX = min( outX, <span class="hljs-number"><span class="hljs-number">0.94</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> outX; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> That is, we simply calculate the distance from the center to the textel, create some magic with it (multiplication, saturate ...), and then ... we calculate the polynomial! </font></font> Awesome <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/25d/79c/e67/25d79ce679f05a53946b475c6c152cc4.png"></div><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Part 5: the effect of intoxication </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's see how the game "The Witcher 3: Wild Hunt" has the effect of intoxication. </font><font style="vertical-align: inherit;">If you have not played it yet, </font></font><strike><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">then drop everything, buy and play,</font></font></strike><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> watch the video: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evening:</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Gy_B2V0QaqA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Night: </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/CXu3e7LWkjE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First we see a double and swirling image, often appearing when you drink in real life. </font><font style="vertical-align: inherit;">The farther a pixel from the center of the image, the stronger the effect of rotation. </font><font style="vertical-align: inherit;">I deliberately laid out the second video with the night, because you can clearly see this rotation on the stars (see 8 separate points?) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second part of the effect of intoxication, perhaps not immediately noticeable, is a slight change in zoom. </font><font style="vertical-align: inherit;">It is noticeable near the center. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is probably obvious that this effect is a typical post-processing (pixel shader). </font><font style="vertical-align: inherit;">However, its location in the rendering pipeline may not be so obvious. </font><font style="vertical-align: inherit;">It turns out that the intoxication effect is applied immediately </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tonal correction and right before the motion blur (the ‚Äúdrunk‚Äù image is the input data for the motion blur).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's start the games with assembly code: </font></font><br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[3]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 8 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(10<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(5<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 21: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 22: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 23: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 24: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 25: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 26: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 27: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 28: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 29: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 30: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 31: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 32: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 33: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 34: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 36: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>) 37: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 38: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 39: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 40: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 41: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 42: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 43: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 44: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 45: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 46: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 47: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 48: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 49: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 50: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 51: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 52: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 53: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 54: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 55: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 56: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 57: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(8<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 58: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 59: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.020000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 60: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span> 61: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 62: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 63: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 64: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 65: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 66: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 67: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 68: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 69: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 70: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 71: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>) 72: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 73: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 74: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Two separate constant buffers are used here. Let's check their values:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d7e/ce2/eb8/d7ece2eb8b0acf421cffd93222dd6821.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/832/ef8/941/832ef8941e9b4b6a38ad24b0c2e84cfa.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are interested in some of them: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb0_v0.x -&gt; elapsed time (in seconds) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb0_v1.xyzw - the size of the viewport and the inverse of the size of the viewport (also </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">known </font><font style="vertical-align: inherit;">as "pixel size") </font><font style="vertical-align: inherit;">cb3_v0.x - rotation around the pixel always has a value of 1.0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb3_v0.y - the magnitude of the effect of intoxication. After its inclusion does not work in full force, but gradually increases from 0.0 to 1.0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cv3_v1.xy - pixel offset (more on this below). This is a pair of sin / cos, so if you want, you can use the sincos (time) shader. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb3_v2.xy is the center of the effect, usually float2 (0.5, 0.5). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we want to focus on understanding what is happening, and not just blindly rewrite the shader. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will start with the first lines:</font></font><br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Line 0 I call the "zoom factor", and soon you will understand why. </font><font style="vertical-align: inherit;">Immediately after it (line 1), we calculate the ‚Äúrotation offset‚Äù. </font><font style="vertical-align: inherit;">This is simply the input sin / cos data pair, multiplied by 0.05. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lines 2-4: First, we calculate the vector from the center of the effect to the UV coordinates of the texture. </font><font style="vertical-align: inherit;">Then we calculate the square of the distance (3) and the simple distance (4) (from the center to the texel)</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Texture coordinates with zoom </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's consider the following assembly code: </font></font><br><br><pre> <code class="hljs css"> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since they are packaged this way, we can analyze only one pair of floats. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To begin with, r0.yz are ‚Äúrotation offsets‚Äù, r1.z is the distance from center to texel, r1.xy is the vector from center to texel, r0.x is ‚Äúzoom factor‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To understand this, let's assume for now that zoomFactor = 1.0, that is, we can write the following:</font></font><br><br><pre> <code class="hljs cs"> <span class="hljs-number"><span class="hljs-number">8</span></span>: mul r2.xyzw, r0.yzyz, r1.zzzz <span class="hljs-number"><span class="hljs-number">9</span></span>: mad r2.xyzw, r1.xyxy, r0.xxxx, -r2.xyzw <span class="hljs-number"><span class="hljs-number">13</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r2.xyzw, r2.xyzw, cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxy r2.xy = (texel - center) * zoomFactor - rotationOffsets * distanceFromCenter + center;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> But zoomFactor = 1.0: </font></font><br><br><pre> <code class="hljs markdown"> r2.xy = texel - center - rotationOffsets <span class="hljs-bullet"><span class="hljs-bullet">* distanceFromCenter + center; r2.xy = texel - rotationOffsets *</span></span> distanceFromCenter;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Similarly for r3.xy: </font></font><br><br><pre> <code class="hljs cs"> <span class="hljs-number"><span class="hljs-number">10</span></span>: mul r3.xy, r0.xxxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">11</span></span>: mad r3.xyzw, r0.yzyz, r1.zzzz, r3.xyxy <span class="hljs-number"><span class="hljs-number">12</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r3.xyzw, r3.xyzw, cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxy r3.xy = rotationOffsets * distanceFromCenter + zoomFactor * (texel - center) + center</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> But zoomFactor = 1.0: </font></font><br><br> <code>r3.xy = rotationOffsets * distanceFromCenter + texel - <strike>center</strike> + <strike>center</strike> r3.xy = texel + rotationOffsets * distanceFromCenter</code> <br> <br>  Fine.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, at the moment we essentially have the current TextureUV (texel) ¬± rotation offset, but what about the zoomFactor? </font><font style="vertical-align: inherit;">Look at line 0. In essence, zoomFactor = 1.0 - 0.1 * drunkAmount. </font><font style="vertical-align: inherit;">For maximum drunkAmount, the zoomFactor value should be equal to 0.9, and texture coordinates with zoom are now calculated as follows:</font></font><br><br><pre> <code class="hljs markdown"> baseTexcoordsA = 0.9 <span class="hljs-bullet"><span class="hljs-bullet">* texel + 0.1 *</span></span> center + rotationOffsets <span class="hljs-bullet"><span class="hljs-bullet">* distanceFromCenter baseTexcoordsB = 0.9 *</span></span> texel + 0.1 <span class="hljs-bullet"><span class="hljs-bullet">* center - rotationOffsets *</span></span> distanceFromCenter</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perhaps the following explanation will be more intuitive: this is just a linear interpolation for some coefficient between the normalized texture coordinates and the center. </font><font style="vertical-align: inherit;">This is an ‚Äúzoom close‚Äù image. </font><font style="vertical-align: inherit;">To understand this, it is best to experiment with the values. </font><font style="vertical-align: inherit;">Here is a </font></font><a href="https://www.shadertoy.com/view/4tyyWz"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to Shadertoy, where you can see the effect in action.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Offset texture coordinates </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The entire fragment on the assembly code: </font></font><br><br><pre> <code class="hljs swift"> <span class="hljs-number"><span class="hljs-number">2</span></span>: mad r1.xy, v1.xyxx, cb0[<span class="hljs-number"><span class="hljs-number">1</span></span>].zwzz, -cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxx <span class="hljs-number"><span class="hljs-number">3</span></span>: dp2 r0.w, r1.xyxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">5</span></span>: mul r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">10.000000</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">min</span></span> r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: mul r0.w, r0.w, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].y <span class="hljs-number"><span class="hljs-number">14</span></span>: mul r0.x, r0.w, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].x <span class="hljs-number"><span class="hljs-number">15</span></span>: mul r0.x, r0.x, l(<span class="hljs-number"><span class="hljs-number">5.000000</span></span>) <span class="hljs-comment"><span class="hljs-comment">// texcoords offset intensity 16: mul r4.xyzw, r0.xxxx, cb3[0].zwzw // texcoords offset</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">creates a certain gradient, let's call it the ‚Äúmask of displacement intensity‚Äù. In fact, it gives two meanings. The first is in r0.w (we use it later) and the second, 5 times stronger, in r0.x (line 15). The latter actually serves as a texel size multiplier, therefore it affects the bias force. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rotational Sampling</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Next is a series of texture sampling. In fact, 2 series of 8 samples are used, one for each ‚Äúside‚Äù. On HLSL, you can write this as follows:</font></font><br><br><pre> <code class="hljs matlab"> static const float2 pointsAroundPixel[<span class="hljs-number"><span class="hljs-number">8</span></span>] = { float2(<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), float2(<span class="hljs-number"><span class="hljs-number">-1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.707</span></span>, <span class="hljs-number"><span class="hljs-number">0.707</span></span>), float2(<span class="hljs-number"><span class="hljs-number">-0.707</span></span>, <span class="hljs-number"><span class="hljs-number">-0.707</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">-1.0</span></span>), float2(<span class="hljs-number"><span class="hljs-number">-0.707</span></span>, <span class="hljs-number"><span class="hljs-number">0.707</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.707</span></span>, <span class="hljs-number"><span class="hljs-number">-0.707</span></span>) }; float4 colorA = <span class="hljs-number"><span class="hljs-number">0</span></span>; float4 colorB = <span class="hljs-number"><span class="hljs-number">0</span></span>; int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; [unroll] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { colorA += TexColorBuffer.Sample( samplerLinearClamp, baseTexcoordsA + texcoordsOffset * pointsAroundPixel[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>] ); } colorA /= <span class="hljs-number"><span class="hljs-number">16.0</span></span>; [unroll] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { colorB += TexColorBuffer.Sample( samplerLinearClamp, baseTexcoordsB + texcoordsOffset * pointsAroundPixel[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>] ); } colorB /= <span class="hljs-number"><span class="hljs-number">16.0</span></span>; float4 rotationPart = colorA + colorB;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The trick is that we add to baseTexcoordsA / B the additional offset that lies on the unit circle, multiplied by the previously mentioned "intensity of the shift of texture coordinates." </font><font style="vertical-align: inherit;">The farther from the center a pixel is, the larger is the radius of the circle around the pixel - we sample it 8 times, which is clearly visible on the stars. </font><font style="vertical-align: inherit;">Values ‚Äã‚ÄãpointsAroundPixel (multiples of 45 degrees):</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0cb/5d0/5b4/0cb5d05b44fd9d2969af0416684d4b77.jpg"></div><br> <a href="https://ru.wikipedia.org/wiki/%25D0%2595%25D0%25B4%25D0%25B8%25D0%25BD%25D0%25B8%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BE%25D0%25BA%25D1%2580%25D1%2583%25D0%25B6%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unit Circle </font></font></a> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zoom Sampling</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The second part of the intoxication effect in The Witcher 3 is zoom with zooming in and out. </font><font style="vertical-align: inherit;">Let's take a look at the assembler code that performs this task:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">56</span></span>: mad r2.xyzw, r3.xyzw, l(<span class="hljs-number"><span class="hljs-number">0.062500</span></span>, <span class="hljs-number"><span class="hljs-number">0.062500</span></span>, <span class="hljs-number"><span class="hljs-number">0.062500</span></span>, <span class="hljs-number"><span class="hljs-number">0.062500</span></span>), r2.xyzw // the rotation part <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> stored <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r2 register <span class="hljs-number"><span class="hljs-number">57</span></span>: mul r0.x, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].y, l(<span class="hljs-number"><span class="hljs-number">8.000000</span></span>) <span class="hljs-number"><span class="hljs-number">58</span></span>: mul r0.xy, r0.xxxx, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].zwzz <span class="hljs-number"><span class="hljs-number">59</span></span>: mad r0.z, cb3[<span class="hljs-number"><span class="hljs-number">1</span></span>].y, l(<span class="hljs-number"><span class="hljs-number">0.020000</span></span>), l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">60</span></span>: mul r1.zw, r0.zzzz, r1.xxxy <span class="hljs-number"><span class="hljs-number">61</span></span>: mad r1.xy, r1.xyxx, r0.zzzz, cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxx <span class="hljs-number"><span class="hljs-number">62</span></span>: mad r3.xy, r1.zwzz, r0.xyxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">63</span></span>: mul r0.xy, r0.xyxx, r1.zwzz <span class="hljs-number"><span class="hljs-number">64</span></span>: mad r0.xy, r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r1.xyxx <span class="hljs-number"><span class="hljs-number">65</span></span>: sample_indexable(texture2d)(<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>) r1.xyzw, r1.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">66</span></span>: sample_indexable(texture2d)(<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>) r4.xyzw, r0.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">67</span></span>: sample_indexable(texture2d)(<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>) r3.xyzw, r3.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">68</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r1.xyzw, r1.xyzw, r3.xyzw <span class="hljs-number"><span class="hljs-number">69</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r1.xyzw, r4.xyzw, r1.xyzw</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We see that there are three separate texture calls, that is, three different texture coordinates. </font><font style="vertical-align: inherit;">Let's analyze how texture coordinates are calculated from them. </font><font style="vertical-align: inherit;">But first, we show the input data for this part:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">float</span></span> zoomInOutScalePixels = drunkEffectAmount * <span class="hljs-number"><span class="hljs-number">8.0</span></span>; // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">57</span></span> float2 zoomInOutScaleNormalizedScreenCoordinates = zoomInOutScalePixels * texelSize.xy; // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">58</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> zoomInOutAmplitude = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + <span class="hljs-number"><span class="hljs-number">0.02</span></span>*cos(<span class="hljs-type"><span class="hljs-type">time</span></span>); // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">59</span></span> float2 zoomInOutfromCenterToTexel = zoomInOutAmplitude * fromCenterToTexel; // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A few words about the input data. </font><font style="vertical-align: inherit;">We calculate the displacement in texels (for example, 8.0 * texel size), which is then added to the base uv coordinates. </font><font style="vertical-align: inherit;">The amplitude simply ranges between 0.98 and 1.02, to give a sense of zoom, like the zoomFactor in the part that performs the rotation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's start with the first pair - r1.xy (line 61)</font></font><br><br><pre> <code class="hljs markdown"> r1.xy = fromCenterToTexel <span class="hljs-bullet"><span class="hljs-bullet">* amplitude + center r1.xy = (TextureUV - Center) *</span></span> amplitude + Center // you can insert here zoomInOutfromCenterToTexel r1.xy = TextureUV <span class="hljs-bullet"><span class="hljs-bullet">* amplitude - Center *</span></span> amplitude + Center r1.xy = TextureUV <span class="hljs-bullet"><span class="hljs-bullet">* amplitude + Center *</span></span> 1.0 - Center <span class="hljs-bullet"><span class="hljs-bullet">* amplitude r1.xy = TextureUV *</span></span> amplitude + Center * (1.0 - amplitude) r1.xy = lerp( TextureUV, Center, amplitude);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I.e: </font></font><br><br><pre> <code class="hljs lisp">float2 zoomInOutBaseTextureUV = lerp(<span class="hljs-name"><span class="hljs-name">TextureUV</span></span>, Center, amplitude)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's check the second pair - r3.xy (line 62) </font></font><br><br><pre> <code class="hljs markdown"> r3.xy = (amplitude <span class="hljs-bullet"><span class="hljs-bullet">* fromCenterToTexel) *</span></span> zoomInOutScaleNormalizedScreenCoordinates + zoomInOutBaseTextureUV</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I.e: </font></font><br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">float2</span></span> zoomInOutAddTextureUV0 = zoomInOutBaseTextureUV + zoomInOutfromCenterToTexel*zoomInOutScaleNormalizedScreenCoordinates;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's check the third pair - r0.xy (lines 63-64) </font></font><br><br><pre> <code class="hljs markdown"> r0.xy = zoomInOutScaleNormalizedScreenCoordinates <span class="hljs-bullet"><span class="hljs-bullet">* (amplitude *</span></span> fromCenterToTexel) * 2.0 + zoomInOutBaseTextureUV</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I.e: </font></font><br><br><pre> <code class="hljs markdown"> float2 zoomInOutAddTextureUV1 = zoomInOutBaseTextureUV + 2.0<span class="hljs-emphasis"><span class="hljs-emphasis">*zoomInOutfromCenterToTexel*</span></span>zoomInOutScaleNormalizedScreenCoordinates</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All three texture requests are added together, and the result is stored in the r1 register. </font><font style="vertical-align: inherit;">It is worth noting that this pixel shader uses a sampler with limited addressing. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We connect everything together.</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> So, at the moment we have the result of rotation in the register r2 and three folded zoom requests in the register r1. </font><font style="vertical-align: inherit;">Let's look at the last lines of the assembly code:</font></font><br><br><pre> <code class="hljs css"> 70: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 71: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>) 72: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 73: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 74: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About additional input data: r0.w is taken from line 7, this is our intensity mask, and cb3 [0] .y is the magnitude of the effect of intoxication. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's see how this works. </font><font style="vertical-align: inherit;">My first approach was brutforce:</font></font><br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">float4</span></span> finalColor = intensityMask * (rotationPart - zoomingPart); <span class="hljs-attribute"><span class="hljs-attribute">finalColor</span></span> = drunkIntensity * finalColor + zoomingPart; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> finalColor;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">what the hell, no one writes shaders</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I took a pencil with paper and wrote this formula:</font></font><br><br><pre> <code class="hljs markdown"> finalColor = effectAmount <span class="hljs-bullet"><span class="hljs-bullet">* [intensityMask *</span></span> (rotationPart - zoomPart)] + zoomPart finalColor = effectAmount <span class="hljs-bullet"><span class="hljs-bullet">* intensityMask *</span></span> rotationPart - effectAmount <span class="hljs-bullet"><span class="hljs-bullet">* intensityMask *</span></span> zoomPart + zooomPart</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where t = effectAmount * intensityMask </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we get:</font></font><br><br><pre> <code class="hljs lisp"> finalColor = <span class="hljs-literal"><span class="hljs-literal">t</span></span> * rotationPart - <span class="hljs-literal"><span class="hljs-literal">t</span></span> * zoomPart + zoomPart finalColor = <span class="hljs-literal"><span class="hljs-literal">t</span></span> * rotationPart + zoomPart - <span class="hljs-literal"><span class="hljs-literal">t</span></span> * zoomPart finalColor = <span class="hljs-literal"><span class="hljs-literal">t</span></span> * rotationPart + (<span class="hljs-number"><span class="hljs-number">1.0</span></span> - <span class="hljs-literal"><span class="hljs-literal">t</span></span>) * zoomPart finalColor = lerp( <span class="hljs-name"><span class="hljs-name">zoomingPart</span></span>, rotationPart, <span class="hljs-literal"><span class="hljs-literal">t</span></span> )</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And we come to the following: </font></font><br><br><pre> <code class="hljs lisp"> finalColor = lerp(<span class="hljs-name"><span class="hljs-name">zoomingPart</span></span>, rotationPart, intensityMask * drunkIntensity);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes, this part of the article turned out to be very detailed, but we finally finished! </font><font style="vertical-align: inherit;">Personally, I learned something in the process of writing, I hope you do too! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are interested, the full source code on HLSL is posted </font></font><a href="https://pastebin.com/9um712sC"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I checked them with my </font></font><a href="http://astralcode.blogspot.com/2018/02/hlslexplorer-is-out.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLSLexplorer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and although there is no one-on-one correspondence with the original shader, the differences are so small (one less line) that I can say with confidence that it works. </font><font style="vertical-align: inherit;">Thanks for reading!</font></font></div><p>Source: <a href="https://habr.com/ru/post/422573/">https://habr.com/ru/post/422573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422555/index.html">Multi-modality in Android in terms of architecture. From A to Z</a></li>
<li><a href="../422561/index.html">How Yandex used computer vision to improve the quality of video broadcasts. DeepHD technology</a></li>
<li><a href="../422565/index.html">Friday's Skillbox webinars: everything for programmers and designers</a></li>
<li><a href="../422569/index.html">Hourly, time tracking app</a></li>
<li><a href="../422571/index.html">Parallelization of tasks with dependencies - example on .NET</a></li>
<li><a href="../422575/index.html">Rare intercom</a></li>
<li><a href="../422577/index.html">Copies and copyrights: how patent and copyright influence the development of 3D printing</a></li>
<li><a href="../422581/index.html">Schr√∂dinger's Quantum Switch</a></li>
<li><a href="../422583/index.html">Strong middling: Snom D735 IP Phone Review</a></li>
<li><a href="../422585/index.html">Practical use of neural networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>