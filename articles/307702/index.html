<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How a variable may not equal its own value.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, my friend showed me an error that manifests itself in a simple function that calculates a polynomial hash from a string with an overflow of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How a variable may not equal its own value.</h1><div class="post__text post__text-html js-mediator-article">  Recently, my friend showed me an error that manifests itself in a simple function that calculates a polynomial hash from a string with an overflow of int'a.  She returned a negative number, although she shouldn‚Äôt.  Here is the function itself: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> MAX_INT = <span class="hljs-number"><span class="hljs-number">2147483647</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hash_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h = <span class="hljs-number"><span class="hljs-number">13</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; i++) { h += h * <span class="hljs-number"><span class="hljs-number">27752</span></span> + x[i]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (h &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) h += MAX_INT; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> h; }</code> </pre> <br>  On some lines, in particular, on the ‚Äúbye‚Äù line, and only on the server (which is interesting, everything was fine on your computer) the function returned a negative number.  But how is this, because if the number is negative, MAX_INT will be added to it and it should become positive. <br><a name="habracut"></a><br>  Here it is worth looking at the differences between the server and the local computer: first, OS X was on the local computer and the clang compiler was used, whereas Gentoo was on the server with the gcc compiler, and secondly, the server compiled with the -O2 flag.  Well, let's compile with the command <br><br><pre> <code class="hljs">g++ -O2 -S -masm=intel a.cpp</code> </pre> <br>  on the server side and see the assembler code of this function. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs pgsql">_Z9hash_codeNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE: .LFB661: .cfi_startproc mov rdx, QWORD PTR [rdi] mov eax, <span class="hljs-number"><span class="hljs-number">13</span></span> lea rsi, [rdx+<span class="hljs-number"><span class="hljs-number">3</span></span>] .L2: # <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">cycle</span></span> movsx ecx, BYTE PTR [rdx] <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rdx, <span class="hljs-number"><span class="hljs-number">1</span></span> imul eax, eax, <span class="hljs-number"><span class="hljs-number">27753</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> eax, ecx cmp rsi, rdx jne .L2 # <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">cycle</span></span> rep ret # <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> right away</code> </pre> <br>  As you can see, there is no comparison in the assembler code after the loop.  It turns out that the compiler decided that a variable storing a non-negative value and which is only incremented cannot become less than zero, and this is correct from the point of view of integer arithmetic, which int implements.  This means that a comparison with zero is not necessary, and you can perform dead code elimination (removal of a dead code).  We were warned that int overflow caused undefined behavior. <br><br>  And what if we derive, is the variable equal to its own value? <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%i\n"</span></span>, h == <span class="hljs-number"><span class="hljs-number">-348700627</span></span>);</code> </pre> <br>  In the output we get 0, and in the assembler code will be: <br><br><pre> <code class="hljs vbscript"> <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> edx, edx mov esi, OFFSET FLAT:.LC0 mov edi, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> eax, eax <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> __printf_chk</code> </pre> <br>  where in the edx register the argument is passed to the output.  It is zero, no checks are performed.  It is generally logical, if the number is not less than zero, why compare it with a negative one.  Thus, it turns out that when overflowing, the function of comparing integers may not work, and the variable may not be equal to its own value!  But then it is undefined behavior. <br><br>  Let's try to compare a variable with a positive number.  Of course, the result will be false, but I wonder if the compiler will do a real check?  Using a binary search, it was found that the compiler does a real check only when comparing with the number 360662 and more.  This number is very close to 27752 * 13. Coincidence or not?  I do not know. <br><br>  It is also worth saying that on OS X with optimization of -O2 such errors were not noticed.  The truth is now used clang, not gcc.  The assembly code performs an honest, albeit a magical check: <br><br><pre> <code class="hljs css">## <span class="hljs-selector-tag"><span class="hljs-selector-tag">BB</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#1</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">shr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 8 <span class="hljs-selector-tag"><span class="hljs-selector-tag">movsx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">al</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movsx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rdi + 2]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdi</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LBB0_3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LBB0_2</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdi</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">qword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rdi + 16]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movsx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rdi]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movsx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rdi + 1]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LBB0_3</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">imul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 27753 <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax + rcx + 1423042525]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movsx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">byte</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rdi + 2]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">imul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 27753 <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 31 # <span class="hljs-selector-tag"><span class="hljs-selector-tag">some</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">magic</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">check</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rip + _MAX_INT]</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">yet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">another</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">magic</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  Thus, even a simple int'a overflow can make the code inoperative and bring a lot of problems. <br><br>  <b>PS</b> Still, polynomial hashes should be written on the basis of a large prime number.  And the comparison will work, and it is much more difficult to find lines that break your function. </div><p>Source: <a href="https://habr.com/ru/post/307702/">https://habr.com/ru/post/307702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307692/index.html">Creating a WebView application based on AWS ApiGateway and AWS Lambda</a></li>
<li><a href="../307694/index.html">Progressive loading of a web application using code sharing</a></li>
<li><a href="../307696/index.html">Juniper Hardware Architecture</a></li>
<li><a href="../307698/index.html">In the wake of "spammer" or Oracle DB + UTL_SMTP + SSL / TLS</a></li>
<li><a href="../307700/index.html">The digest of interesting materials for the mobile # 166 developer (on August 8-14)</a></li>
<li><a href="../307704/index.html">New 3CX Client clients for Mac and iOS, and a tip for setting up a Gmail server for 3CX Phone System</a></li>
<li><a href="../307706/index.html">Puns typing functions in C</a></li>
<li><a href="../307708/index.html">A little introduction to parallel programming on R</a></li>
<li><a href="../307710/index.html">The story ‚ÄúNIICHOSHI. Saday</a></li>
<li><a href="../307712/index.html">Passing infinity: do-it-yourself t-test</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>