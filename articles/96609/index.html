<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development and modification of firmware for Android phones on the example of HTC Hero GSM. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The reasons why people put modified firmware versions are different. Someone wants to surprise a friend with a funny download animation, someone lacks...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development and modification of firmware for Android phones on the example of HTC Hero GSM. Part 1</h1><div class="post__text post__text-html js-mediator-article">  The reasons why people put modified firmware versions are different.  Someone wants to surprise a friend with a funny download animation, someone lacks a certain functionality (for example, vpn), someone wants to squeeze maximum performance out of his phone by overclocking the processor, and someone has been waiting for a new version of the Android operating system for five months your favorite HTC Hero. <br>  At the moment, there is already a great many of the most unimaginable assemblies for a wide variety of Android-based phones.  Sometimes they even appear in <a href="http://habrahabr.ru/blogs/android/95073/">one</a> form or <a href="http://habrahabr.ru/blogs/HTC/94158/">another</a> on Habr√©. <br>  I want to tell you about the process and features of creating <i>custom</i> firmware based on the official one.  This knowledge was obtained in the process of developing one of the few <i>domestic</i> firmware based on Android 2.1 for the HTC Hero GSM.  And more or less successfully tested on themselves and other turned up users of one large Russian forum. <br>  Despite the fact that all of the following was done for the HTC Hero, these rules and features are in full force for all phones, especially those developed by HTC and using the proprietary shell Sense. <br>  For the experiments we need: <br><ul><li>  <a href="http://developer.android.com/sdk/index.html">Android SDK</a> preferably the latest version </li><li>  <a href="http://code.google.com/p/android-apktool/">The apktool utility</a> for <a href="http://code.google.com/p/android-apktool/">reengineering</a> system applications </li><li>  <a href="http://code.google.com/p/smali/">Smali / baksmali utilities</a> for de-optimizing system applications </li><li>  <a href="http://code.google.com/p/unyaffs/">The unyaffs utility</a> for extracting system files from an image </li><li>  <a href="http://zen-droid.googlecode.com/files/split_bootimg.pl">Script split_bootimg.pl</a> to extract the kernel and ramdisk </li><li>  <a href="">The testsign utility</a> for signing the service pack and individual applications </li><li>  installed and configured JRE </li><li>  Android phone </li><li>  superuser rights and a modified recovery routine ( <i>recovery rom</i> ) </li></ul><br>  All of the above is available in versions for both Linux and Windows.  But in my examples, I will focus on using Linux. <br>  Of course, neither <i>root-</i> rights nor <i>recovery</i> are needed for us to start development, but if we want to try out our creation, we will need them.  For HTC Hero, you can use <a href="http://forum.xda-developers.com/showthread.php%3Ft%3D561124">RA-hero-v1.6.2</a> . <br>  Probably, it's time to remind that the use of unofficial firmware deprives us of a guarantee, but where ours did not disappear.  And despite the fact that most operations are safe - you should always clearly understand what is being done and why, so as not to cause irreversible harm to your <i>android</i> <a name="habracut"></a><br><br><h2>  The foundation </h2><br><br>  There are several different approaches to firmware development. <br><ul><li>  Build from <a href="http://source.android.com/">Android Open Source Project</a> sources </li><li>  Build from <a href="http://www.cyanogenmod.com/">CyanogenMod project</a> sources </li><li>  Modification of the firmware provided by the phone manufacturer </li></ul><br>  Despite the fact that the Android platform seems to be open, it seems that real phones use closed components.  These are the drivers distributed in binary form (wifi / gps / fm), and key system components, such as the Market and other Google services.  Also here you need to add the development of companies in the field of interface, such as <a href="http://www.mobile-review.com/articles/2009/htc-project-1-sense.shtml">HTC Sense</a> , Motoblur, <a href="http://habrahabr.ru/company/samsung/blog/94859/">TouchWiz</a> from Sumsung.  This creates in places insurmountable difficulties in developing firmware from source codes. <br>  I propose to dwell on the modification of ready-made firmware provided by phone vendors. <br>  Firmware for HTC phones exist in two forms: <br><ul><li>  <b>RUU.</b>  <b>Rom Update Utility</b> (Firmware <b>Update Utility</b> ).  Utility for Windows OS that updates the phone </li><li>  <b>OTA.</b>  <b>Over the Air</b> (Update by "air").  The package downloaded by the phone itself via the wifi / gprs network, which is installed on the phone without any computer participation </li></ul><br>  Recently, OTA updates consist of binary <i>diffs</i> , which somewhat complicates the use of these <i>diffs</i> as a <b>basis</b> .  Since this requires a specific phone with a specific version of the firmware, which may simply be impracticable if we want to adapt the firmware from one phone to another.  Or it involves a long and painful juggling of the identifier of the phone followed by downloading the update without installing it.  And, perhaps, this procedure will have to be repeated several times. <br>  We will use RUU update. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Removing <i>rom.zip</i> </h2><br><br>  1. Download the appropriate version of RUU for the phone of interest to us.  Find which you can either on the site HTC, or in <a href="http://shipped-roms.com/">other sources</a> .  For HTC Hero we will use the Android 2.1 version released <a href="">for Chunghwa operator (Taiwan)</a> , released in early June <br>  2. RUU utility when updating the phone flashes several areas at once: <br><ul><li>  boot loader (hboot) </li><li>  linux + ramdisk kernel (boot) </li><li>  firmware for radio module (radio) </li><li>  recovery routine </li><li>  system partition (/ system) </li><li>  user section (/ data) </li></ul><br>  However, we cannot allow the RUU utility to overwrite our lovingly installed bootloader and recovery.  In order to continue to be able to install not only official firmware.  To do this, we need to remove the radio / boot / system / data. <br>  In essence, RUU is an InstallShield installer that carries the images we need in rom.zip. <br>  Run it and get into the title screen welcome.  Without going further, open the% TEMP% system folder, in which we see 2 new folders, in one of which we will find the <b>rom.zip</b> file.  We copy in a lonely place and we close RUU cancel installation. <br> <a title="ImageShack - Image And Video Hosting" href="http://img249.imageshack.us/i/habr1.png/"><img src="https://habrastorage.org/getpro/geektimes/post_images/912/517/a61/912517a615ba5644eea756f4eaf74530.png"></a> <br><br><h2>  Unpacking images </h2><br><br>  After unpacking the received archive and deleting images that are not interesting for us, we will see: <ol><li> <code><font color="black">$ <font color="#c20cb9"><b>ls</b></font> <font color="#660033">-1</font> rom boot.img Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img system.img userdata.img</font></code> </li> <li> <code><font color="black">$ <font color="#c20cb9"><b>ls</b></font> <font color="#660033">-1</font> rom boot.img Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img system.img userdata.img</font></code> </li> <li> <code><font color="black">$ <font color="#c20cb9"><b>ls</b></font> <font color="#660033">-1</font> rom boot.img Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img system.img userdata.img</font></code> </li> <li> <code><font color="black">$ <font color="#c20cb9"><b>ls</b></font> <font color="#660033">-1</font> rom boot.img Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img system.img userdata.img</font></code> </li> <li> <code><font color="black">$ <font color="#c20cb9"><b>ls</b></font> <font color="#660033">-1</font> rom boot.img Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img system.img userdata.img</font></code> </li> </ol>  The phone carries 512MB NAND Flash, which are divided into the following logical blocks <ol><li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>cat</b></font> <font color="#000000"><b>/</b></font> proc <font color="#000000"><b>/</b></font> mtd dev: <font color="#c20cb9"><b>size</b></font> erasesize  name mtd0: 00040000 00020000 <font color="#ff0000">"misc"</font> mtd1: 00500000 00020000 <font color="#ff0000">"recovery"</font> mtd2: 00280000 00020000 <font color="#ff0000">"boot"</font> mtd3: 0aa00000 00020000 <font color="#ff0000">"system"</font> mtd4: 08200000 00020000 <font color="#ff0000">"cache"</font> mtd5: 0a5c0000 00020000 <font color="#ff0000">"userdata"</font></font></code> </li> <li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>cat</b></font> <font color="#000000"><b>/</b></font> proc <font color="#000000"><b>/</b></font> mtd dev: <font color="#c20cb9"><b>size</b></font> erasesize  name mtd0: 00040000 00020000 <font color="#ff0000">"misc"</font> mtd1: 00500000 00020000 <font color="#ff0000">"recovery"</font> mtd2: 00280000 00020000 <font color="#ff0000">"boot"</font> mtd3: 0aa00000 00020000 <font color="#ff0000">"system"</font> mtd4: 08200000 00020000 <font color="#ff0000">"cache"</font> mtd5: 0a5c0000 00020000 <font color="#ff0000">"userdata"</font></font></code> </li> <li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>cat</b></font> <font color="#000000"><b>/</b></font> proc <font color="#000000"><b>/</b></font> mtd dev: <font color="#c20cb9"><b>size</b></font> erasesize  name mtd0: 00040000 00020000 <font color="#ff0000">"misc"</font> mtd1: 00500000 00020000 <font color="#ff0000">"recovery"</font> mtd2: 00280000 00020000 <font color="#ff0000">"boot"</font> mtd3: 0aa00000 00020000 <font color="#ff0000">"system"</font> mtd4: 08200000 00020000 <font color="#ff0000">"cache"</font> mtd5: 0a5c0000 00020000 <font color="#ff0000">"userdata"</font></font></code> </li> <li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>cat</b></font> <font color="#000000"><b>/</b></font> proc <font color="#000000"><b>/</b></font> mtd dev: <font color="#c20cb9"><b>size</b></font> erasesize  name mtd0: 00040000 00020000 <font color="#ff0000">"misc"</font> mtd1: 00500000 00020000 <font color="#ff0000">"recovery"</font> mtd2: 00280000 00020000 <font color="#ff0000">"boot"</font> mtd3: 0aa00000 00020000 <font color="#ff0000">"system"</font> mtd4: 08200000 00020000 <font color="#ff0000">"cache"</font> mtd5: 0a5c0000 00020000 <font color="#ff0000">"userdata"</font></font></code> </li> <li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>cat</b></font> <font color="#000000"><b>/</b></font> proc <font color="#000000"><b>/</b></font> mtd dev: <font color="#c20cb9"><b>size</b></font> erasesize  name mtd0: 00040000 00020000 <font color="#ff0000">"misc"</font> mtd1: 00500000 00020000 <font color="#ff0000">"recovery"</font> mtd2: 00280000 00020000 <font color="#ff0000">"boot"</font> mtd3: 0aa00000 00020000 <font color="#ff0000">"system"</font> mtd4: 08200000 00020000 <font color="#ff0000">"cache"</font> mtd5: 0a5c0000 00020000 <font color="#ff0000">"userdata"</font></font></code> </li> <li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>cat</b></font> <font color="#000000"><b>/</b></font> proc <font color="#000000"><b>/</b></font> mtd dev: <font color="#c20cb9"><b>size</b></font> erasesize  name mtd0: 00040000 00020000 <font color="#ff0000">"misc"</font> mtd1: 00500000 00020000 <font color="#ff0000">"recovery"</font> mtd2: 00280000 00020000 <font color="#ff0000">"boot"</font> mtd3: 0aa00000 00020000 <font color="#ff0000">"system"</font> mtd4: 08200000 00020000 <font color="#ff0000">"cache"</font> mtd5: 0a5c0000 00020000 <font color="#ff0000">"userdata"</font></font></code> </li> <li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>cat</b></font> <font color="#000000"><b>/</b></font> proc <font color="#000000"><b>/</b></font> mtd dev: <font color="#c20cb9"><b>size</b></font> erasesize  name mtd0: 00040000 00020000 <font color="#ff0000">"misc"</font> mtd1: 00500000 00020000 <font color="#ff0000">"recovery"</font> mtd2: 00280000 00020000 <font color="#ff0000">"boot"</font> mtd3: 0aa00000 00020000 <font color="#ff0000">"system"</font> mtd4: 08200000 00020000 <font color="#ff0000">"cache"</font> mtd5: 0a5c0000 00020000 <font color="#ff0000">"userdata"</font></font></code> </li> <li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>cat</b></font> <font color="#000000"><b>/</b></font> proc <font color="#000000"><b>/</b></font> mtd dev: <font color="#c20cb9"><b>size</b></font> erasesize  name mtd0: 00040000 00020000 <font color="#ff0000">"misc"</font> mtd1: 00500000 00020000 <font color="#ff0000">"recovery"</font> mtd2: 00280000 00020000 <font color="#ff0000">"boot"</font> mtd3: 0aa00000 00020000 <font color="#ff0000">"system"</font> mtd4: 08200000 00020000 <font color="#ff0000">"cache"</font> mtd5: 0a5c0000 00020000 <font color="#ff0000">"userdata"</font></font></code> </li> </ol>  As we see, these areas of memory are directly related to the images we received.  RUU makes the recording of as-is images, but we want to change the content of the system, so we need to unpack them. <br>  <em>Yaffs2 is</em> used as a file system for NAND in android <ol><li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>mount</b></font> <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>grep</b></font> yaffs <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock3 on <font color="#000000"><b>/</b></font> system <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> ro <font color="#7a0874"><b>)</b></font> <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock5 on <font color="#000000"><b>/</b></font> data <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> rw,nosuid,nodev <font color="#7a0874"><b>)</b></font> <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock4 on <font color="#000000"><b>/</b></font> cache <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> rw,nosuid,nodev <font color="#7a0874"><b>)</b></font></font></code> </li> <li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>mount</b></font> <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>grep</b></font> yaffs <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock3 on <font color="#000000"><b>/</b></font> system <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> ro <font color="#7a0874"><b>)</b></font> <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock5 on <font color="#000000"><b>/</b></font> data <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> rw,nosuid,nodev <font color="#7a0874"><b>)</b></font> <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock4 on <font color="#000000"><b>/</b></font> cache <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> rw,nosuid,nodev <font color="#7a0874"><b>)</b></font></font></code> </li> <li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>mount</b></font> <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>grep</b></font> yaffs <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock3 on <font color="#000000"><b>/</b></font> system <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> ro <font color="#7a0874"><b>)</b></font> <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock5 on <font color="#000000"><b>/</b></font> data <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> rw,nosuid,nodev <font color="#7a0874"><b>)</b></font> <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock4 on <font color="#000000"><b>/</b></font> cache <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> rw,nosuid,nodev <font color="#7a0874"><b>)</b></font></font></code> </li> <li> <code><font color="black">$ adb shell <font color="#c20cb9"><b>mount</b></font> <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>grep</b></font> yaffs <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock3 on <font color="#000000"><b>/</b></font> system <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> ro <font color="#7a0874"><b>)</b></font> <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock5 on <font color="#000000"><b>/</b></font> data <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> rw,nosuid,nodev <font color="#7a0874"><b>)</b></font> <font color="#000000"><b>/</b></font> dev <font color="#000000"><b>/</b></font> block <font color="#000000"><b>/</b></font> mtdblock4 on <font color="#000000"><b>/</b></font> cache <font color="#7a0874"><b>type</b></font> yaffs2 <font color="#7a0874"><b>(</b></font> rw,nosuid,nodev <font color="#7a0874"><b>)</b></font></font></code> </li> </ol>  Unpack the system and data (/ cache remains empty) <ol><li> <code><font color="black">$ <font color="#c20cb9"><b>mkdir</b></font> system <font color="#000000"><b>&amp;&amp;</b></font> <font color="#7a0874"><b>cd</b></font> system <font color="#000000"><b>&amp;&amp;</b></font> unyaffs .. <font color="#000000"><b>/</b></font> .. <font color="#000000"><b>/</b></font> .. <font color="#000000"><b>/</b></font> rom <font color="#000000"><b>/</b></font> system.img $ <font color="#c20cb9"><b>mkdir</b></font> .. <font color="#000000"><b>/</b></font> data <font color="#000000"><b>&amp;&amp;</b></font> <font color="#7a0874"><b>cd</b></font> .. <font color="#000000"><b>/</b></font> data <font color="#000000"><b>&amp;&amp;</b></font> unyaffs .. <font color="#000000"><b>/</b></font> .. <font color="#000000"><b>/</b></font> .. <font color="#000000"><b>/</b></font> rom <font color="#000000"><b>/</b></font> userdata.img</font></code> </li> <li> <code><font color="black">$ <font color="#c20cb9"><b>mkdir</b></font> system <font color="#000000"><b>&amp;&amp;</b></font> <font color="#7a0874"><b>cd</b></font> system <font color="#000000"><b>&amp;&amp;</b></font> unyaffs .. <font color="#000000"><b>/</b></font> .. <font color="#000000"><b>/</b></font> .. <font color="#000000"><b>/</b></font> rom <font color="#000000"><b>/</b></font> system.img $ <font color="#c20cb9"><b>mkdir</b></font> .. <font color="#000000"><b>/</b></font> data <font color="#000000"><b>&amp;&amp;</b></font> <font color="#7a0874"><b>cd</b></font> .. <font color="#000000"><b>/</b></font> data <font color="#000000"><b>&amp;&amp;</b></font> unyaffs .. <font color="#000000"><b>/</b></font> .. <font color="#000000"><b>/</b></font> .. <font color="#000000"><b>/</b></font> rom <font color="#000000"><b>/</b></font> userdata.img</font></code> </li> </ol>  As a result, we obtained a full-fledged root tree, suitable for flashing to a phone, which contains system libraries, framework, system applications, configuration files, etc. <br> <a title="ImageShack - Image And Video Hosting" href="http://img580.imageshack.us/i/habr2.png/"><img src="https://habrastorage.org/getpro/geektimes/post_images/0ed/ac0/67e/0edac067ec984fea6a978148bcb1b02c.png"></a> <br><br>  It should be borne in mind that the unpacked archive contains symbolic links that will be lost on file systems that do not support them (fat / ntfs).  Which we can restore through the update script, which will be discussed in another article. <br><br><h2>  Core </h2><br><br>  We also need a boot partition, which is essentially a linux kernel (for the selected firmware, this is 2.6.29 armv6l) with a ramdisk and <a href="http://android.git.kernel.org/%3Fp%3Dplatform/system/core.git%3Ba%3Dblob%3Bf%3Dmkbootimg/bootimg.h">has the following format</a> : <br><pre>  ** + ----------------- +
 ** |  boot header |  1 page
 ** + ----------------- +
 ** |  kernel |  n pages
 ** + ----------------- +
 ** |  ramdisk |  m pages
 ** + ----------------- +
 ** |  second stage |  o pages
 ** + ----------------- +
 **
 ** n = (kernel_size + page_size - 1) / page_size
 ** m = (ramdisk_size + page_size - 1) / page_size
 ** o = (second_size + page_size - 1) / page_size </pre><br>  If we want to replace the kernel, or modify the initialization scripts, we need to extract them from the <em>boot-</em> image.  To do this, we need a wonderful perl script split_bootimg.pl by <em>William Enck</em> . <ol><li> <code><font color="black">$ split_bootimg.pl .. <font color="#000000"><b>/</b></font> rom <font color="#000000"><b>/</b></font> boot.img $ <font color="#c20cb9"><b>ls</b></font> boot.img-kernel boot.img-ramdisk.gz  data  system</font></code> </li> <li> <code><font color="black">$ split_bootimg.pl .. <font color="#000000"><b>/</b></font> rom <font color="#000000"><b>/</b></font> boot.img $ <font color="#c20cb9"><b>ls</b></font> boot.img-kernel boot.img-ramdisk.gz  data  system</font></code> </li> <li> <code><font color="black">$ split_bootimg.pl .. <font color="#000000"><b>/</b></font> rom <font color="#000000"><b>/</b></font> boot.img $ <font color="#c20cb9"><b>ls</b></font> boot.img-kernel boot.img-ramdisk.gz  data  system</font></code> </li> </ol><br>  With the kernel itself, we can do nothing except how to replace it with another, and the ramdisk can be unpacked for later change and configuration: <ol><li> <code><font color="black">$ <font color="#c20cb9"><b>mkdir</b></font> ramdisk <font color="#000000"><b>&amp;&amp;</b></font> <font color="#7a0874"><b>cd</b></font> ramdisk <font color="#000000"><b>&amp;&amp;</b></font> <font color="#c20cb9"><b>gzip</b></font> <font color="#660033">-dc</font> .. <font color="#000000"><b>/</b></font> boot.img-ramdisk.gz <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>cpio</b></font> <font color="#660033">-i</font> $ <font color="#c20cb9"><b>ls</b></font> data  default.prop  dev  init  init.goldfish.rc  init.hero.rc  init.rc  logo.rle  proc  sbin  sys  system</font></code> </li> <li> <code><font color="black">$ <font color="#c20cb9"><b>mkdir</b></font> ramdisk <font color="#000000"><b>&amp;&amp;</b></font> <font color="#7a0874"><b>cd</b></font> ramdisk <font color="#000000"><b>&amp;&amp;</b></font> <font color="#c20cb9"><b>gzip</b></font> <font color="#660033">-dc</font> .. <font color="#000000"><b>/</b></font> boot.img-ramdisk.gz <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>cpio</b></font> <font color="#660033">-i</font> $ <font color="#c20cb9"><b>ls</b></font> data  default.prop  dev  init  init.goldfish.rc  init.hero.rc  init.rc  logo.rle  proc  sbin  sys  system</font></code> </li> <li> <code><font color="black">$ <font color="#c20cb9"><b>mkdir</b></font> ramdisk <font color="#000000"><b>&amp;&amp;</b></font> <font color="#7a0874"><b>cd</b></font> ramdisk <font color="#000000"><b>&amp;&amp;</b></font> <font color="#c20cb9"><b>gzip</b></font> <font color="#660033">-dc</font> .. <font color="#000000"><b>/</b></font> boot.img-ramdisk.gz <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>cpio</b></font> <font color="#660033">-i</font> $ <font color="#c20cb9"><b>ls</b></font> data  default.prop  dev  init  init.goldfish.rc  init.hero.rc  init.rc  logo.rle  proc  sbin  sys  system</font></code> </li> </ol>  In this article, we don‚Äôt want to do anything with the kernel or with <em>ramdisk</em> , and therefore we will pack everything back (or go back a step and don‚Äôt touch the <em>boot at all</em> ) <ol><li> <code><font color="black"><font color="#c20cb9"><b>find</b></font> . <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>cpio</b></font> <font color="#660033">--quiet</font> <font color="#660033">-o</font> <font color="#660033">-H</font> newc <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>gzip</b></font> <font color="#000000"><b>&gt;</b></font> .. <font color="#000000"><b>/</b></font> new-ramdisk.gz $ <font color="#7a0874"><b>cd</b></font> .. <font color="#000000"><b>&amp;&amp;</b></font> mkbootimg <font color="#660033">--kernel</font> boot.img-kernel <font color="#660033">--ramdisk</font> new-ramdisk.gz <font color="#660033">--cmdline</font> <font color="#ff0000">"no_console_suspend=1 console=null"</font> <font color="#660033">-o</font> newboot <font color="#660033">--base</font> 0x19200000</font></code> </li> <li> <code><font color="black"><font color="#c20cb9"><b>find</b></font> . <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>cpio</b></font> <font color="#660033">--quiet</font> <font color="#660033">-o</font> <font color="#660033">-H</font> newc <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>gzip</b></font> <font color="#000000"><b>&gt;</b></font> .. <font color="#000000"><b>/</b></font> new-ramdisk.gz $ <font color="#7a0874"><b>cd</b></font> .. <font color="#000000"><b>&amp;&amp;</b></font> mkbootimg <font color="#660033">--kernel</font> boot.img-kernel <font color="#660033">--ramdisk</font> new-ramdisk.gz <font color="#660033">--cmdline</font> <font color="#ff0000">"no_console_suspend=1 console=null"</font> <font color="#660033">-o</font> newboot <font color="#660033">--base</font> 0x19200000</font></code> </li> </ol>  For other phones, the base offset settings may vary.  Commandline we get from split_bootimg when unpacking. <br><br><h2>  Update script </h2><br><br>  To update, we will use an update script, which is written in the special script language <strong>edify</strong> , the syntax of which can be found in the <a href="http://android.git.kernel.org/%3Fp%3Dplatform/bootable/recovery.git%3Ba%3Dblob%3Bf%3Dedify/README">android sources</a> .  The script <em>/ META-INF / com / google / android / update-script</em> could be: <ol><li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li></li><li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li></li><li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li></li><li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 format CACHE: format SYSTEM: copy_dir PACKAGE:system SYSTEM: set_perm_recursive 0 0 0755 0644 SYSTEM: set_perm_recursive 0 2000 0755 0755 SYSTEM:bin set_perm 0 3003 02755 SYSTEM:bin/netcfg set_perm 0 3004 02755 SYSTEM:bin/ping set_perm_recursive 1002 1002 0755 0440 SYSTEM:etc/bluez set_perm 0 0 0755 SYSTEM:etc/bluez set_perm 1002 1002 0440 SYSTEM:etc/dbus.conf set_perm 1014 2000 0550 SYSTEM:etc/dhcpcd/dhcpcd-run-hooks set_perm 0 2000 0550 SYSTEM:etc/init.goldfish.sh set_perm_recursive 0 0 0755 0555 SYSTEM:etc/ppp set_perm 0 0 04755 SYSTEM:etc/ppp/ip-up-vpn show_progress 0.1 10 show_progress 0.2 0 copy_dir PACKAGE:data DATA: show_progress 0.2 10 show_progress 0.3 0 format BOOT: write_raw_image PACKAGE:boot.img BOOT: show_progress 0.3 10</font></code> </li> </ol>  While this script is very primitive and the only thing that it does is prepares the appropriate sections. <br><br><h2>  Sign Service Pack </h2><br><br>  In order for us to be able to flash our firmware, we need <em>to sign</em> the update package.  This process is similar to the process of <a href="http://java.sun.com/developer/Books/javaprogramming/JAR/sign/signing.html">signing jar-packages</a> .  Your (or test) certificate is added to the package and checksums for the files inside it are saved. <ol><li> <code><font color="black">$ zip -r habrarom.zip . $ java -classpath ../../bin/testsign.jar testsign habrarom.zip habrarom-signed.zip</font></code> </li> <li> <code><font color="black">$ zip -r habrarom.zip . $ java -classpath ../../bin/testsign.jar testsign habrarom.zip habrarom-signed.zip</font></code> </li> </ol><br><h2>  Radio module firmware </h2><br><br>  This is the easiest part in terms of creating a service pack, but also the most dangerous in terms of the consequences of an unsuccessful update. <br>  The update package is created absolutely identical to the previous one, only it will contain a binary blob from the radio, which we extracted from the RUU and a script to write it to the appropriate section of memory. <br>  A simple script: <ol><li> <code><font color="black">show_progress 0.1 0 write_radio_image PACKAGE:Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img show_progress 0.1 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 write_radio_image PACKAGE:Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img show_progress 0.1 10</font></code> </li> <li> <code><font color="black">show_progress 0.1 0 write_radio_image PACKAGE:Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img show_progress 0.1 10</font></code> </li> </ol>  Not much that will be included in this update package. <ol><li> <code><font color="black">$ ls -1 META-INF Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img</font></code> </li> <li> <code><font color="black">$ ls -1 META-INF Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img</font></code> </li> <li> <code><font color="black">$ ls -1 META-INF Radio_Signed_HERO_63.18.55.06O_6.35.15.01.img</font></code> </li> </ol><br>  All this is packaged and signed as previously. <br><br><h2>  Firmware </h2><br><br>  Despite the fact that we have not added any new functionality to the received firmware yet, we would like to try to flash and boot into it. <br>  For this <ol><li>  Copy to the root of the map our update package </li><li>  Boot into recovery </li><li>  Making nanroid backup </li><li>  We do wipe </li><li>  Stitching </li><li>  Reboot </li></ol><br>  We are glad that our patient survived a difficult operation. <br> <a title="ImageShack - Image And Video Hosting" href="http://img716.imageshack.us/i/habr3.png/"><img src="https://habrastorage.org/getpro/geektimes/post_images/781/b08/2e7/781b082e7fa719c4bf3bf89ae8dd64cb.png"></a> <br><br>  The following important issues that did not directly modify the prepared basic firmware were not included in this review.  Questions faced by any <em>custom</em> creator, and I came across directly when creating the Russian version of firmware 2.1 for HTC Hero GSM <br><ul><li>  Add root, busybox </li><li>  De-optimization ( <em>deodexing</em> ) packages.  Using smali / baksmali.  Resolving odex dependencies </li><li>  remote odex application optimization </li><li>  Modification of system packages.  Signature of packages: when necessary and when it can be neglected.  Packaging applications.  Update application resources without rebuilding </li><li>  Localization of the system, as an example of large-scale modification of the system. </li><li>  Decompiling and assembling system application / bytecode resources.  Correcting system application errors </li><li>  zip-align, png optimization </li><li>  Application signing and <em>circular bailing</em> problem when using <em>shared uid</em> </li><li>  Using initialization scripts on the example of transferring data from one partition to another (dalvik-cache2cache, app2sd) </li></ul><br>  In the meantime, we are looking forward to when the update of the <a href="http://habrahabr.ru/blogs/android/96547/">FOTA client</a> will be followed by an upgrade of the system itself to version 2.1-update1. <br><br>  In previous and future series <br><ol><li>  <a href="http://habrahabr.ru/blogs/android/96609/">Part 1. Creating firmware in update.zip format based on RUU.</a>  <a href="http://habrahabr.ru/blogs/android/96609/">Unpacking / packing boot.</a>  <a href="http://habrahabr.ru/blogs/android/96609/">Update script.</a>  <a href="http://habrahabr.ru/blogs/android/96609/">Sign service pack and applications.</a> </li><li>  <a href="http://habrahabr.ru/blogs/android/97169/">Part 2. Adding busybox.</a>  <a href="http://habrahabr.ru/blogs/android/97169/">Adding root.</a>  <a href="http://habrahabr.ru/blogs/android/97169/">Mount to write.</a>  <a href="http://habrahabr.ru/blogs/android/97169/">Initialization script</a>  <a href="http://habrahabr.ru/blogs/android/97169/">Editing ramdisk.</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/96609/">https://habr.com/ru/post/96609/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../96598/index.html">World Cup 2010 Widget</a></li>
<li><a href="../96601/index.html">ASP.NET - custom authorization forms. Crib</a></li>
<li><a href="../96604/index.html">Phone Security Labels - First Law Enacted</a></li>
<li><a href="../96607/index.html">What are they afraid of in cloud computing?</a></li>
<li><a href="../96608/index.html">Commission 30% for Facebook Credits - is this normal?</a></li>
<li><a href="../96610/index.html">Nagios + SMS using a mobile phone</a></li>
<li><a href="../96611/index.html">MODx Evolution 1.0.4</a></li>
<li><a href="../96613/index.html">On4: Shop with built-in payment acceptance</a></li>
<li><a href="../96614/index.html">Nintendo 3DS revolution</a></li>
<li><a href="../96615/index.html">Statistics of the arbitration system. Open data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>