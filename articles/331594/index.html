<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GUI on Grafana for mgstat - system monitoring utilities on InterSystems Cach√©, Ensemble or HealthShare</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! This article is a continuation of the article " Friends of Prometheus with Cach√© ". We will consider the option of visualization of the resu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GUI on Grafana for mgstat - system monitoring utilities on InterSystems Cach√©, Ensemble or HealthShare</h1><div class="post__text post__text-html js-mediator-article">  Good day!  This article is a continuation of the article " <a href="https://habrahabr.ru/company/intersystems/blog/318940/">Friends of Prometheus with Cach√©</a> ".  We will consider the option of visualization of the results of the work of the <a href="">^ mgstat utility</a> .  This utility provides Cach√© performance statistics, namely, the number of global and routine calls, local and <a href="">ECP</a> , the length of the write daemon queue, the number of blocks written to disk and read from disk, the amount of ECP traffic, and so on.  ^ Mgstat can be launched either separately (interactively or by a <a href="">job</a> ), or when another performance evaluation utility <a href="">^ pButtons is running</a> . <br><br>  The presentation of the material I would like to break into two parts: in the first graphically show the statistics collected ^ mgstat, and in the second - to consider exactly how these statistics are collected.  In short, <a href="">$ zu functions are used</a> .  However, to the majority of parameters collected there is an object interface through the classes of the <a href="">SYS.Stats</a> package.  And not all parameters that can be collected are shown in ^ mgstat.  In the future, we will try to display all of them on the <a href="https://grafana.com/">Grafana</a> boards.  At the same time, we show only what ^ gstat itself provides us.  In addition, try to taste Docker-containers. <br><br><img src="https://habrastorage.org/web/844/815/7f3/8448157f3180402c8249bbb6a2c5c166.jpg" alt="Grafana mgstat dashboard"><br><a name="habracut"></a><br><h3>  We put Docker </h3><br>  The <a href="https://habrahabr.ru/company/intersystems/blog/318940/">first part</a> describes how to install Prometheus and Grafana from tarballs.  We will show how you can start the same monitoring server using <a href="https://docs.docker.com/">Docker</a> features.  Demonstration host machine: <br><blockquote>  # <b>uname -r</b> <br>  4.8.16-200.fc24.x86_64 <br>  # <b>cat / etc / fedora-release</b> <br>  Fedora release 24 (Twenty Four) </blockquote><br>  Two more virtual machines (192.168.42.131 and 192.168.42.132) will be used in the VMWare Workstation Pro 12.0 environment, both with Cach√© on board.  We will monitor them.  Versions: <br><blockquote>  # <b>uname -r</b> <br>  3.10.0-327.el7.x86_64 <br>  # <b>cat / etc / redhat-release</b> <br>  Red Hat Enterprise Linux Server release 7.2 (Maipo) <br>  ... <br>  USER&gt; <b>write $ zversion</b> <br>  Cache for UNIX (Red Hat Enterprise Linux for x86-64) 2016.2 (Build 721U) Wed Aug 17 2016 20:19:48 EDT </blockquote><br>  On the host machine, install Docker and run it: <br><blockquote>  # <b>dnf install -y docker</b> <br>  # <b>systemctl start docker</b> <br>  # <b>systemctl status docker</b> <br>  ‚óè docker.service - Docker Application Container Engine <br>  Loaded: loaded (/usr/lib/systemd/system/docker.service; disabled; vendor preset: disabled) <br>  Active: <b>active (running)</b> since Wed 2017-06-21 15:08:28 EEST;  3 days ago <br>  ... </blockquote><br><h3>  Launch Prometheus in the Docker container </h3><br>  Download the latest Prometheus image: <br><blockquote>  # <b>docker pull docker.io/prom/prometheus</b> </blockquote><br>  If we look at the <a href="https://hub.docker.com/r/prom/prometheus/~/dockerfile/">Docker file</a> , we will see that the image reads the config from its /etc/prometheus/prometheus.yml file, and stores the collected metrics in the / prometheus directory: <br><blockquote>  ... <br>  Cmd ["-config.file = / etc / prometheus / prometheus.yml", \ <br>  "-storage.local.path = / prometheus", \ <br>  ... </blockquote><br>  When launching Prometheus in the Docker container, we specify the configuration file and the database for metrics to be taken from the host machine.  This will allow us to ‚Äúsurvive‚Äù the restart of the container.  Create directories for Prometheus on the host machine: <br><blockquote>  # <b>mkdir -p / opt / prometheus / data / opt / prometheus / etc</b> </blockquote><br>  Create a Prometheus configuration file: <br><blockquote>  # <b>cat /opt/prometheus/etc/prometheus.yml</b> <br>  global: <br>  scrape_interval: 10s 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      scrape_configs: <br>  - job_name: 'isc_cache' <br>  metrics_path: '/ mgstat / 5' # <i>Tail 5 (sec) it's a diff time for ^ mgstat.</i>  <i>Should be less than scrape interval.</i> <br>  static_configs: <br>  - targets: ['192.168.42.131 Low7772''''2'2.168.42.132 -177772'] <br>  basic_auth: <br>  username: 'PromUser' <br>  password: 'Secret' </blockquote><br>  Now you can run the container with Prometheus: <br><blockquote>  # <b>docker run -d --name prometheus \</b> <b><br></b>  <b>--hostname prometheus -p 9090: 9090 \</b> <b><br></b>  <b>-v /opt/prometheus/etc/prometheus.yml:/etc/prometheus/prometheus.yml \</b> <b><br></b>  <b>-v / opt / prometheus / data /: / prometheus \</b> <b><br></b>  <b>docker.io/prom/prometheus</b> </blockquote><br>  Check that it starts up normally: <br><blockquote>  # <b>docker ps --format "{{.ID}}: {{.Command}} {{.Status}} {{.Names}}"</b> <br>  d3a1db5dec1a: "/ bin / prometheus -con" Up 5 minutes prometheus </blockquote><br><h3>  We start Grafana in the Docker-container </h3><br>  First, download the last image: <br><blockquote>  # <b>docker pull docker.io/grafana/grafana</b> </blockquote><br>  Then we run it, indicating that the Grafana database (by default, this is SQLite) will be stored on the host machine.  We also link to the container with Prometheus, so that you can refer to the container with Prometheus from the container with Grafana: <br><blockquote>  # <b>mkdir -p / opt / grafana / db</b> <br>  # <b>docker run -d --name grafana \</b> <b><br></b>  <b>--hostname grafana -p 3000: 3000 \</b> <b><br></b>  <b>--link prometheus \</b> <b><br></b>  <b>-v / opt / grafana / db: / var / lib / grafana \</b> <b><br></b>  <b>docker.io/grafana/grafana</b> <br>  # <b>docker ps --format "{{.ID}}: {{.Command}} {{.Status}} {{.Names}}"</b> <br>  fe6941ce3d15: "/run.sh" Up 3 seconds grafana <br>  d3a1db5dec1a: "/ bin / prometheus -con" Up 14 minutes prometheus </blockquote><br><h3>  We use Docker-compose </h3><br>  Both containers are running one by one.  A more convenient way to launch multiple containers at once seems to be using <a href="https://docs.docker.com/compose/">Docker-compose</a> .  We will install it, stop the current both containers, configure their launch via Docker-compose and launch it again. <br><br><div class="spoiler">  <b class="spoiler_title">The same in cli:</b> <div class="spoiler_text">  # <b>dnf install -y docker-compose</b> <br>  # <b>docker stop $ (docker ps -a -q)</b> <br>  # <b>docker rm $ (docker ps -a -q)</b> <br>  # <b>mkdir / opt / docker-compose</b> <br>  # <b>cat /opt/docker-compose/docker-compose.yml</b> <br>  version: '2' <br>  services: <br>  prometheus: <br>  image: docker.io/prom/prometheus <br>  container_name: prometheus <br>  hostname: prometheus <br>  ports: <br>  - 9090: 9090 <br>  volumes: <br>  - /opt/prometheus/etc/prometheus.yml:/etc/prometheus/prometheus.yml <br>  - / opt / prometheus / data /: / prometheus <br>  grafana: <br>  image: docker.io/grafana/grafana <br>  container_name: grafana <br>  hostname: grafana <br>  ports: <br>  - 3000: 3000 <br>  volumes: <br>  - / opt / grafana / db: / var / lib / grafana <br><br>  # <b>docker-compose -f /opt/docker-compose/docker-compose.yml up -d</b> <br>  # # You can turn off and remove both containers with the command: <br>  # # docker-compose -f /opt/docker-compose/docker-compose.yml down <br><br>  # <b>docker ps --format "{{.ID}}: {{.Command}} {{.Status}} {{.Names}}"</b> <br>  620e3cb4a5c3: "/run.sh" Up 11 seconds grafana <br>  e63416e6c247: "/ bin / prometheus -con" Up 12 seconds prometheus <br></div></div><br><h3>  Post-installation procedures </h3><br>  After launching Grafana for the first time, two things need to be done: change the admin password to the web interface (by default, the login / password is admin / admin) and add Prometheus as a data source.  This can be done either from the web interface, or by directly editing the Grafana SQLite database (it defaults to the file /opt/grafana/db/grafana.db), or by <a href="http_api/">REST requests</a> . <br><div class="spoiler">  <b class="spoiler_title">We show the third option:</b> <div class="spoiler_text">  # <b>curl -XPUT " <a href="http://admin/">admin</a> : admin @ localhost: 3000 / api / user / password" \</b> <b><br></b>  <b>-H "Content-Type: application / json" \</b> <b><br></b>  <b>-d '{"oldPassword": "admin", "newPassword": "TopSecret", "confirmNew": "TopSecret"}'</b> <br><br>  If the password has been changed successfully, the answer will come: <br>  <i>{"message": "User password changed"}</i> <br><br>  Answer type: <br>  <i>curl: (56) Recv failure: Connection reset by peer</i> <br>  means that the Grafana server has not yet fully started and you need to wait a little more, and then repeat the previous command.  You can wait, for example, like this: <br><br>  # <b>until curl -sf <a href="http://admin/">admin</a> : admin @ localhost: 3000&gt; / dev / null;</b>  <b>do sleep 1;</b>  <b>echo "Grafana is not started yet"; done;</b>  <b>echo "Grafana is started"</b> <br><br>  After successfully changing the password, add the Prometheus data source: <br><br>  # <b>curl -XPOST " <a href="http://admin/">admin</a> : TopSecret @ localhost: 3000 / api / datasources" \</b> <b><br></b>  <b>-H "Content-Type: application / json" \</b> <b><br></b>  <b>-d '{"name": "Prometheus", "type": "prometheus", "url": "http: // prometheus: 9090", "access": "proxy"}'</b> <br><br>  If the data source was added successfully, the answer will come: <br>  <i>{"id": 1, "message": "Datasource added", "name": "Prometheus"}</i> <br></div></div><br><h3>  Create an analog ^ mgstat </h3><br>  ^ mgstat writes output to a file and online to a terminal.  We do not need output to the file.  Therefore, with the help of Studio, we will create and compile in the USER area the program ^ mymgstat.int, with a reduced code ^ mgstat. <br><br><div class="spoiler">  <b class="spoiler_title">Program ^ mymgstat:</b> <div class="spoiler_text"><pre><code class="hljs bash">mgstat(dly) /* Edited version of ^mgstat <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Prometheus monitoring Changes: - Variables cnt, reqname and pagesz are deleted as well as all code connected to them; - Output procedure was overwritten; - Unused procedures were deleted. */ ; ; n dly d init d loop q init s prefix=<span class="hljs-string"><span class="hljs-string">"isc_cache_mgstat_"</span></span> s <span class="hljs-variable"><span class="hljs-variable">$zt</span></span>=<span class="hljs-string"><span class="hljs-string">"initerr"</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> class errors mainly??? the vers exist <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 4.1 d GetVersionInfo(.Majver,.Minver,.OS) i Majver&lt;5 w <span class="hljs-string"><span class="hljs-string">"Sorry, this won't work on this version of Cache"</span></span>,! q // not supported on pre-5.0 systems. s (odly,dly)=<span class="hljs-variable"><span class="hljs-variable">$g</span></span>(dly,2) i dly&gt;10 s dly=10 ; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> common memory offsets s jrnbase=<span class="hljs-variable"><span class="hljs-variable">$ZU</span></span>(40,2,94),maxval4=4294967295 s wdwchk=<span class="hljs-variable"><span class="hljs-variable">$ZU</span></span>(40,2,146),wdphaseoff=<span class="hljs-variable"><span class="hljs-variable">$ZU</span></span>(40,2,145) s wdcycle=<span class="hljs-variable"><span class="hljs-variable">$ZU</span></span>(79,1),stilen=<span class="hljs-variable"><span class="hljs-variable">$zu</span></span>(40,0,1),szctrs=1 s (globufs,glostr)=<span class="hljs-variable"><span class="hljs-variable">$v</span></span>(<span class="hljs-variable"><span class="hljs-variable">$ZU</span></span>(40,2,135),-2,stilen)/512 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span>=1:1:5 { s tmp=<span class="hljs-variable"><span class="hljs-variable">$v</span></span>(<span class="hljs-variable"><span class="hljs-variable">$ZU</span></span>(40,2,135)+(i*stilen),-2,stilen)*(2**(1+i))/1024,globufs=globufs+tmp,glostr=glostr_<span class="hljs-string"><span class="hljs-string">"^"</span></span>_tmp } s globufs=globufs_<span class="hljs-string"><span class="hljs-string">"MB:"</span></span>_glostr <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Majver&gt;2008||((Majver=2008)&amp;&amp;(Minver&gt;1)) { s roustr=<span class="hljs-variable"><span class="hljs-variable">$tr</span></span>(<span class="hljs-variable"><span class="hljs-variable">$system</span></span>.Util.RoutineBuffers(),<span class="hljs-string"><span class="hljs-string">","</span></span>,<span class="hljs-string"><span class="hljs-string">"^"</span></span>),roubufs=0 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span>=1:1:<span class="hljs-variable"><span class="hljs-variable">$l</span></span>(roustr,<span class="hljs-string"><span class="hljs-string">"^"</span></span>) { s roubufs=roubufs+<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(roustr,<span class="hljs-string"><span class="hljs-string">"^"</span></span>,i) } s roubufs=roubufs_<span class="hljs-string"><span class="hljs-string">"MB:"</span></span>_roustr } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { i (Majver=5)&amp;&amp;(Minver&lt;1) { s rbufsiz=32,rbstr=<span class="hljs-string"><span class="hljs-string">",routinebuffersize=assumed 32K"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { s rbufsiz=<span class="hljs-variable"><span class="hljs-variable">$v</span></span>(<span class="hljs-variable"><span class="hljs-variable">$zu</span></span>(40,2,164),-2,4)+240\1024,rbstr=<span class="hljs-string"><span class="hljs-string">",routinebuffersize="</span></span>_rbufsiz_<span class="hljs-string"><span class="hljs-string">"K"</span></span> } s roubufs=<span class="hljs-variable"><span class="hljs-variable">$fn</span></span>(<span class="hljs-variable"><span class="hljs-variable">$V</span></span>(<span class="hljs-variable"><span class="hljs-variable">$zu</span></span>(40,2,26),-2,stilen)*rbufsiz/1024,<span class="hljs-string"><span class="hljs-string">""</span></span>,0)_<span class="hljs-string"><span class="hljs-string">"MB"</span></span>_rbstr } s ncpus=<span class="hljs-variable"><span class="hljs-variable">$system</span></span>.Util.NumberOfCPUs() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Majver&gt;2000 { // really &gt; 5.2 s sznames=<span class="hljs-string"><span class="hljs-string">"Global,ObjClass,Per-BDB"</span></span>,sztag=<span class="hljs-string"><span class="hljs-string">"Gbl,Obj,BDB"</span></span>,szstr=$<span class="hljs-variable"><span class="hljs-variable">$GetSzctr</span></span>(sznames) // seize statistics <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Majver&gt;2008 { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Majver&gt;2009 { s szctrs=<span class="hljs-variable"><span class="hljs-variable">$zu</span></span>(69,74) ;0 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> off, 1 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> on - new <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 2010.x - chg <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> API <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 2011 } s <span class="hljs-variable"><span class="hljs-variable">$zt</span></span>=<span class="hljs-string"><span class="hljs-string">"initcpuerr"</span></span> s ncpus=ncpus_<span class="hljs-string"><span class="hljs-string">":"</span></span>_$<span class="hljs-variable"><span class="hljs-variable">$GetArchChipsCores</span></span>() ;Arch^Chips^Cores initcpuerr ; kn s <span class="hljs-variable"><span class="hljs-variable">$zt</span></span>=<span class="hljs-string"><span class="hljs-string">""</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { s szstr=<span class="hljs-string"><span class="hljs-string">"4,2,14"</span></span>,sztag=<span class="hljs-string"><span class="hljs-string">"Gbl,Rou,Obj"</span></span> // 5.2 and lower - glo,rou,obj } i szstr=<span class="hljs-string"><span class="hljs-string">""</span></span> { s nszctrs=0 } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { s nszctrs=szctrs*<span class="hljs-variable"><span class="hljs-variable">$l</span></span>(szstr,<span class="hljs-string"><span class="hljs-string">","</span></span>) } s numsz=nszctrs*3 // Sz, Nsz, Asz <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> each one. ; decide on offsets <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> they move between versions... i (Majver=5)&amp;&amp;(Minver&lt;1) { ;5.0 specific - no zu190!!! - oldstyle gather() and wd info s getwdq=<span class="hljs-string"><span class="hljs-string">"getwdinf50()"</span></span>,maxvalglo=maxval4,glocnt=11,gmethod=0,roubase=<span class="hljs-variable"><span class="hljs-variable">$zu</span></span>(40,2,1) s bdb0off=<span class="hljs-variable"><span class="hljs-variable">$ZU</span></span>(40,2,128),bdbbase=<span class="hljs-variable"><span class="hljs-variable">$V</span></span>(<span class="hljs-variable"><span class="hljs-variable">$ZU</span></span>(40,2,21),-2,<span class="hljs-string"><span class="hljs-string">"P"</span></span>),bdbsiz=<span class="hljs-variable"><span class="hljs-variable">$ZU</span></span>(40,29,0),wdqsizoff=<span class="hljs-variable"><span class="hljs-variable">$ZU</span></span>(40,29,2),off=<span class="hljs-variable"><span class="hljs-variable">$V</span></span>(bdb0off,-2,4),vwlocn=bdbbase+wdqsizoff s ppgstats=0 } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { s getwdq=<span class="hljs-string"><span class="hljs-string">"getwdinfzu()"</span></span>,numbuff=<span class="hljs-variable"><span class="hljs-variable">$zu</span></span>(190,2),ijulock=1,glocnt=<span class="hljs-variable"><span class="hljs-variable">$l</span></span>(<span class="hljs-variable"><span class="hljs-variable">$zu</span></span>(190,6,1),<span class="hljs-string"><span class="hljs-string">","</span></span>),gmethod=1 s ppgstats=glocnt<span class="hljs-string"><span class="hljs-string">'&lt;20 i $zu(40,0,76)=4 { s maxvalglo=maxval4 } else { s maxvalglo=18446744073709551610 } ; wij only appears in &gt;= 5.1... but handled by glocnt ; routine cache misses appears in &gt;= 2007.1 but handled by glocnt i glocnt&gt;14 s glocnt=14 } s ecpconncol=glocnt+numsz+2,alen=ecpconncol+5,maxeccon=$system.ECP.MaxClientConnections() i '</span></span>maxeccon s alen=ecpconncol-1 q initerr ; handle init errs q loop d gather(.oldval,gmethod) h dly d gather(.newval,gmethod) d diffandfix() d output gather(array,usezu) i usezu { s zustats1=<span class="hljs-variable"><span class="hljs-variable">$zu</span></span>(190,6,1) ; glostat For i=1:1:glocnt S array(i)=<span class="hljs-variable"><span class="hljs-variable">$P</span></span>(zustats1,<span class="hljs-string"><span class="hljs-string">","</span></span>,i) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ; old (5.0) glostat, gloref,glorefclient,logrd,phyrd,phywr,gloset,glosetclient,roulines <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=1:1:glocnt s array(i)=<span class="hljs-variable"><span class="hljs-variable">$v</span></span>((i-1)*4+roubase,-2,4) ;;;incomplete!!???10/22 } d @getwdq,getwdp() si=glocnt,array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$v</span></span>(jrnbase,-2,4) ; jrnwrites <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> jsz=1:1:nszctrs { sj=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(szstr,<span class="hljs-string"><span class="hljs-string">","</span></span>,jsz),szstat=<span class="hljs-variable"><span class="hljs-variable">$zu</span></span>(162,3,j),array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(szstat,<span class="hljs-string"><span class="hljs-string">","</span></span>),array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(szstat,<span class="hljs-string"><span class="hljs-string">","</span></span>,2),array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(szstat,<span class="hljs-string"><span class="hljs-string">","</span></span>,3) } i maxeccon s estats=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(<span class="hljs-variable"><span class="hljs-variable">$system</span></span>.ECP.GetProperty(<span class="hljs-string"><span class="hljs-string">"ClientStats"</span></span>),<span class="hljs-string"><span class="hljs-string">","</span></span>,1,21),array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=+<span class="hljs-variable"><span class="hljs-variable">$system</span></span>.ECP.NumClientConnections(),array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(estats,<span class="hljs-string"><span class="hljs-string">","</span></span>,2),array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(estats,<span class="hljs-string"><span class="hljs-string">","</span></span>,6),array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(estats,<span class="hljs-string"><span class="hljs-string">","</span></span>,7),array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(estats,<span class="hljs-string"><span class="hljs-string">","</span></span>,19),array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(estats,<span class="hljs-string"><span class="hljs-string">","</span></span>,20) i ppgstats s array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(zustats1,<span class="hljs-string"><span class="hljs-string">","</span></span>,20),array(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(i))=<span class="hljs-variable"><span class="hljs-variable">$p</span></span>(zustats1,<span class="hljs-string"><span class="hljs-string">","</span></span>,21) q diffandfix() ; note - this does not work <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> someone zeroed the counters manually <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span>=1:1:glocnt { i newval(i)&lt;oldval(i) { s dispval(i)=(maxvalglo-oldval(i)+newval(i))\dly i dispval(i)&gt;1000000000 s dispval(i)=newval(i)\dly } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { s dispval(i)=(newval(i)-oldval(i))\dly } s oldval(i)=newval(i) } s rdratio=<span class="hljs-variable"><span class="hljs-variable">$s</span></span>(dispval(8)=0:0,1:<span class="hljs-variable"><span class="hljs-variable">$num</span></span>(dispval(7)/dispval(8),2)) s grratio=<span class="hljs-variable"><span class="hljs-variable">$s</span></span>(dispval(6)=0:0,1:<span class="hljs-variable"><span class="hljs-variable">$num</span></span>(dispval(5)/dispval(6),2)) i maxeccon s dispval(ecpconncol)=newval(ecpconncol) <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span>=glocnt+1:1:ecpconncol-1,ecpconncol+1:1:alen+<span class="hljs-variable"><span class="hljs-variable">$s</span></span>(ppgstats:2,1:0) { i newval(i)&lt;oldval(i) { s dispval(i)=(maxval4-oldval(i)+newval(i))\dly i dispval(i)&gt;1000000000 s dispval(i)=newval(i)\dly } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { s dispval(i)=(newval(i)-oldval(i))\dly } s oldval(i)=newval(i) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nszctrs&gt;0 { <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span>=glocnt+2:3:glocnt+numsz-1 { i <span class="hljs-string"><span class="hljs-string">'dispval(i) { s (dispval(i+1),dispval(i+2))="0" } else { s dispval(i+1)=$num(dispval(i+1)/dispval(i)*100,2) s dispval(i+2)=$num(dispval(i+2)/dispval(i)*100,2) } } } q output s nl=$c(10) w prefix_"global_refs "_dispval(5)_nl w prefix_"remote_global_refs "_dispval(6)_nl w prefix_"global_remote_ratio "_grratio_nl w prefix_"physical_reads "_dispval(8)_nl w prefix_"read_ratio "_rdratio_nl w prefix_"global_updates "_dispval(10)_nl w prefix_"remote_global_updates "_dispval(11)_nl w prefix_"routine_refs "_dispval(1)_nl w prefix_"remote_routine_refs "_dispval(2)_nl w prefix_"routine_loads_and_saves "_dispval(3)_nl w prefix_"remote_routine_loads_and_saves "_dispval(4)_nl w prefix_"physical_writes "_dispval(9)_nl w prefix_"write_daemon_queue_size "_wdqsz_nl w prefix_"write_daemon_temp_queue "_twdq_nl w prefix_"write_daemon_phase "_wdphase_nl i glocnt&gt;12 w prefix_"wij_writes "_dispval(13)_nl i glocnt&gt;13 w prefix_"routine_cache_misses "_dispval(14)_nl w prefix_"journal_writes "_dispval(glocnt+1)_nl s icnt=1 fi=1:1:numsz { ; global/rou/obj nseize/aseize are nodisp-100+ ; and start at dispval(glocnt+2) and go up... s rsc=$p(sztag,",",i) w prefix_rsc_"seizes "_dispval(i+glocnt+1)_nl s icnt=icnt+1 } s ecpnames=$lb("act_ecp","add_blocks","purge_buffers_local","purge_server_remote","bytes_sent","bytes_received") s icnt=0,ecnt=1 fi=glocnt+numsz+2:1:alen { ; ECP are nodisp 19-24 and start at glocnt+numsz+1 and go up... w prefix_$lg(ecpnames,ecnt)_" "_dispval(i)_nl s icnt=icnt+1 s ecnt=ecnt+1 } i $d(ijulock) { w prefix_"write_daemon_pass "_wdpass_nl w prefix_"iju_count "_ijucnt_nl w prefix_"iju_lock "_ijulock_nl } s ppgnames=$lb("process_private_global_refs","process_private_global_updates") i ppgstats { ; PPG are nodisp 28,29 and start at alen+1 fi=0,1 w prefix_$lg(ppgnames,i+1)_" "_dispval(alen+i+1)_nl } w nl q getwdinfzu() s twdq=0 fb=1:1:numbuff { s twdq=twdq+$p($zu(190,2,b),",",10) } s wdinf=$zu(190,13),wdpass=$p(wdinf,","),wdqsz=$p(wdinf,",",2),twdq=twdq-wdqsz i twdq&lt;0 s twdq=0 s misc=$zu(190,4),ijulock=$p(misc,",",4),ijucnt=$p(misc,",",5) q getwdinf50() s wdqsz=0,last=maxval4 fi=0:1:5 dq:off=maxval4 . s off=$V(bdb0off+(i*4),-2,4) . q:(off=last)!(off=maxval4) . s wdqsz=wdqsz+$V(vwlocn+off,-3,4) . s last=off Q getwdp() s wdphase=0 q:'</span></span><span class="hljs-variable"><span class="hljs-variable">$V</span></span>(wdwchk,-2,4) q:<span class="hljs-string"><span class="hljs-string">'wdphaseoff s wdphase=$V(wdphaseoff,-2,4) Q GetArchChipsCores() private { ;Returns &lt;Arch&gt;^&lt;# Chips&gt;^&lt;# Cores&gt; if $D(^oddDEF("%SYSTEM.CPU")) { sn=##class(%SYSTEM.CPU).%New() s Arch=n.Arch s nChips=n.nChips s nCores=n.nCores } else { ; These are all here in case we want more later Set Arch=$zu(204,1) Set Model=$zu(204,2) Set Vendor=$zu(204,3) Set nThreads=$zu(204,4) Set nCores=$zu(204,5) Set nChips=$zu(204,6) Set nThreadsPerCore=$zu(204,7) Set nCoresPerChip=$zu(204,8) Set MTSupported=$zu(204,9) Set MTEnabled=$zu(204,10) Set MHz=$zu(204,11) } quit Arch_"^"_nChips_"^"_nCores } GetVersionInfo(majver,minver,os) PRIVATE { if $D(^oddDEF("%SYSTEM.CPU")) { s majver=$System.Version.GetMajor() s minver=$System.Version.GetMinor() s os=$System.Version.GetCompBuildOS() } else { s zv=$ZV s majver=$p($p($p(zv,") ",2)," ",1),".",1) s minver=$p($p($p(zv,") ",2)," ",1),".",2) If zv["Windows" { Set os="Windows" } elseif zv["UNIX" { Set os="UNIX" } elseif zv["VMS" { Set os="VMS" } else { Set os="N/A" } } } GetSzctr(Longnames) private { s allsznames=$zu(162,0)_",",zuctr="" fi=1:1:$l(Longnames,",") { s ctr=$p(Longnames,",",i) continue:(ctr="")||(ctr="Unused") s nctr=$l($e(allsznames,1,$find(allsznames,ctr)),",")-1 continue:nctr=0 i zuctr="" { s zuctr=nctr } else { s zuctr=zuctr_","_nctr } } quit zuctr }</span></span></code> </pre> <br></div></div><br>  In order to be able to call the program ^ mymgstat via REST, we are doing a wrapper class for it in the USER area. <br><br><div class="spoiler">  <b class="spoiler_title">Its implementation</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> my.Mgstat Extends %CSP.REST { XData UrlMap [ XMLNamespace = "http://www.intersystems.com/urlmap" ] { &lt;Routes&gt; &lt;Route Url="/:delay" <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span>="GET" <span class="hljs-keyword"><span class="hljs-keyword">Call</span></span>="getMgstat"/&gt; &lt;/Routes&gt; } ClassMethod getMgstat(delay <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-type"><span class="hljs-type">Integer</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status { // <span class="hljs-keyword"><span class="hljs-keyword">By</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, we use <span class="hljs-number"><span class="hljs-number">2</span></span> second <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> averaging <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ^mymgstat(delay) quit $$<span class="perl"><span class="perl">$OK } }</span></span></code> </pre> <br></div></div><br><h3>  Create a resource, user, and web application </h3><br>  Now that we have a class that provides metrics, we can create a RESTfull web application.  As in the first article, we will assign a resource to this web application and create a user who can use this resource and on whose behalf Prometheus will collect metrics.  Let's give the user more rights to certain databases.  Compared to the first article, the right to write to the CACHESYS database has been added (to avoid the error &lt;UNDEFINED&gt; loop + 1 ^ mymgstat * gmethod ") and the ability to use the% Admin_Manage resource has been added (to avoid the &lt;PROTECT&gt; gather + 10 ^ error mymgstat * GetProperty % SYSTEM.ECP ").  We will do these steps on two virtual servers, 192.168.42.131 and 192.168.42.132.  Naturally, we will preload our code, the program ^ mymgstat and the class my.Mgstat into the USER area on that and on another server (the code is on <a href="https://github.com/myardyas/prometheus/tree/master/mgstat/cos">github</a> ). <br><br><div class="spoiler">  <b class="spoiler_title">That is, on each virtual server we will do the following steps:</b> <div class="spoiler_text">  # <b>cd / tmp</b> <br>  # <b>wget <a href="">https://github.com/myardyas/prometheus/raw/master/mgstat/cos/mymgstat.xml</a></b> <br>  # <b>wget <a href="">https://github.com/myardyas/prometheus/raw/master/mgstat/cos/Mgstat.xml</a></b> <br>  # <br>  # # <i>If the servers do not have access to the Internet, copy the program and class locally, and then use <a href="https://ru.wikipedia.org/wiki/SCP">scp</a> .</i> <br>  # <br>  # <b>csession &lt;instance_name&gt; -U user</b> <br>  USER&gt; <b>do $ system.OBJ.Load ("/ tmp / mymgstat.xml * / tmp / Mgstat.xml", "ck")</b> <br>  USER&gt; <b>zn "% sys"</b> <br>  % SYS&gt; <b>write ## class (Security.Resources) .Create ("PromResource", "Resource for Metrics web page", "")</b> <br>  one <br>  % SYS&gt; <b>write ## class (Security.Roles) .Create ("PromRole", "Role for PromResource", "PromResource: U,% Admin_Manage: U,% DB_USER: RW,% DB_CACHESYS: RW")</b> <br>  one <br>  % SYS&gt; <b>write ## class (Security.Users) .Create ("PromUser", "PromRole", "Secret")</b> <br>  one <br>  % SYS&gt; <b>set properties ("NameSpace") = "USER"</b> <br>  % SYS&gt; <b>set properties ("Description") = "RESTfull web-interface for ^ mymgstat"</b> <br>  % SYS&gt; <b>set properties ("AutheEnabled") = 32</b> ;  See <a href="">description</a> <br>  % SYS&gt; <b>set properties ("Resource") = "PromResource"</b> <br>  % SYS&gt; <b>set properties ("DispatchClass") = "my.Mgstat"</b> <br>  % SYS&gt; <b>write ## class (Security.Applications) .Create ("/ mgstat",. Properties)</b> <br>  one <br></div></div><br><h3>  Checking the availability of metrics with curl </h3><br><blockquote>  # <b>curl --user PromUser: Secret -XGET http://192.168.42.131.77772/mgstat/5</b> <br>  isc_cache_mgstat_global_refs 347 <br>  isc_cache_mgstat_remote_global_refs 0 <br>  isc_cache_mgstat_global_remote_ratio 0 <br>  ... <br>  # <b>curl --user PromUser: Secret -XGET http://192.168.42.132Cl7777/mgstat/5</b> <br>  isc_cache_mgstat_global_refs 130 <br>  isc_cache_mgstat_remote_global_refs 0 <br>  isc_cache_mgstat_global_remote_ratio 0 <br>  ... </blockquote><br><h3>  Checking the availability of metrics from Prometheus </h3><br>  Prometheus is listening to port 9090 here. First we check the status of Targets: <br><br><img src="https://habrastorage.org/web/f3b/cd8/13d/f3bcd813da52464fb8476bdceee40b9d.jpg" alt="Prometheus targets"><br><br>  Then we look at any of the metrics: <br><br><img src="https://habrastorage.org/web/00f/760/472/00f760472e654762821c96bda3c93c6f.jpg" alt="Show metrics from Prometheus interface"><br><br><h3>  We display one metric </h3><br>  We now show one metric, for example, isc_cache_mgstat_global_refs, in the form of a graph.  We will need to add a panel and insert a graph into it.  Go to Grafana ( <a href="http://localhost:3000/">http: // localhost: 3000</a> , login / pass - admin / TopSecret) and add the panel: <br><br><img src="https://habrastorage.org/web/bd8/1ce/ec3/bd81ceec3c3a4d11b38f0e28b23319fe.jpg" alt="Add dashboard to grafana"><br><br>  Add a chart: <br><br><img src="https://habrastorage.org/web/7aa/d5c/7f6/7aad5c7f63414f6d94ca8b8d4bf418cf.jpg" alt="Add graph to Grafana"><br><br>  Edit it by clicking ‚ÄúPanel title‚Äù, then ‚ÄúEdit‚Äù: <br><br><img src="https://habrastorage.org/web/218/5d4/5bd/2185d45bd4a24967bd219dc975fa4ffb.jpg" alt="Edit graph in Grafana"><br><br>  Specify Prometheus as the data source and select our isc_cache_mgstat_global_refs metric.  Resolution choose 1/1: <br><br><img src="https://habrastorage.org/web/4a4/678/eec/4a4678eec94d476e9138a2848b39959e.jpg" alt="Set datasource for graph"><br><br>  Give the name of the schedule: <br><br><img src="https://habrastorage.org/web/798/827/369/798827369c88452f8b18f654edfd5242.jpg" alt="Set graph name"><br><br>  Add a legend: <br><br><img src="https://habrastorage.org/web/abd/6b1/b19/abd6b1b191f741c39c166f5ee0ad69cc.jpg" alt="Add legend"><br><br>  Click on the top button ‚ÄúSave‚Äù and give the name of the dashboard: <br><br><img src="https://habrastorage.org/web/b6c/148/759/b6c14875911d4b29bdb5af77aa41c1fa.jpg" alt="Set dashboard name"><br><br>  We get something like this: <br><br><img src="https://habrastorage.org/web/aa3/e5b/ae1/aa3e5bae19c04f4dad27a2e05da1a23f.jpg" alt="Sample graph for global references"><br><br><h3>  Display all metrics </h3><br>  Similarly, let's throw in the rest of the metrics.  Among them will be two text metrics - <a href="http://docs.grafana.org/features/panels/singlestat/">Singlestat</a> .  We will get such a dashboard (upper and lower parts are shown): <br><br><img src="https://habrastorage.org/web/5b1/afe/4a0/5b1afe4a0a2b422cb2ee48b8278806d7.jpg" alt="All mgstat metrics (top)"><br><br><img src="https://habrastorage.org/web/96a/f0d/e3b/96af0de3b5fb42bb8eef7ebde7e5abe2.jpg" alt="All mgstat metrics (bottom)"><br><br>  Immediately interfere with two nuances: <br><br>  - scrolls in the legend (with an increase in the number of servers will have to scroll longer); <br>  - lack of data in Singlestat-panels (which, naturally, assume a single value).  We have two servers, here are two values. <br><br><h3>  We add the use of the template </h3><br>  Let's try to defeat these comments by introducing an instance <a href="http://docs.grafana.org/reference/templating/">template</a> .  To do this, we need to create a variable that stores the value of the instance, and slightly modify the requests to Prometheus, according to the <a href="http://docs.grafana.org/features/datasources/prometheus/">existing rules</a> .  That is, instead of the query <i>"isc_cache_mgstat_global_refs"</i> we should write <i>"isc_cache_mgstat_global_refs {instance =" [[instance]] "}"</i> , after creating the <i>instance</i> variable. <br><br>  Create a variable: <br><br><img src="https://habrastorage.org/web/c53/665/e08/c53665e0846c4d7db023b6d529492e63.jpg" alt="Add templating"><br><br><img src="https://habrastorage.org/web/e49/cdf/707/e49cdf70754a401383a17e254485b93f.jpg" alt="Create new variable"><br><br>  In the request to Prometheus we specify to select the values ‚Äã‚Äãof the instance tags from each metric.  In the lower part, we observe that the values ‚Äã‚Äãof our two instances are defined.  Click the "Add" button: <br><br><img src="https://habrastorage.org/web/3b4/fc7/43f/3b4fc743f3a8477392bf7f3a384bd7ad.jpg" alt="Set new variable"><br><br>  In the upper part of the dashboard, a variable appeared with options for the values: <br><br><img src="https://habrastorage.org/web/1cc/adb/872/1ccadb872392474fa8e832e8e2aa5a57.jpg" alt="Variable on dashboard"><br><br>  Now we add the use of this variable to the queries for each panel on the dashboard, that is, turn requests of the type <i>"isc_cache_mgstat_global_refs"</i> to <i>"isc_cache_mgstat_global_refs {instance =" [[instance]] "}</i> .  We get this dashboard (near the legends, the names of the instances are left on purpose, for verification): <br><br><img src="https://habrastorage.org/web/3ad/427/21e/3ad42721ee5d46178b6461af14905db9.jpg" alt="All metrics (with variable)"><br><br>  Singlestat panels are already running: <br><br><img src="https://habrastorage.org/web/9b7/fef/cdc/9b7fefcdc7794dc78e5dd8726fcd9385.jpg" alt="Singlestat panels"><br><br>  Download this dashboard template at <a href="">github</a> .  The procedure for importing it to Grafana is described in the <a href="https://habrahabr.ru/company/intersystems/blog/318940/">first part</a> . <br><br>  Finally, we will make the server 192.168.42.132 an ECP client for 192.168.42.131 and create globals to generate ECP traffic.  We see that monitoring the ECP client works: <br><br><img src="https://habrastorage.org/web/8d9/aef/fdc/8d9aeffdc72a4bdfbc7675f130458d05.jpg" alt="ECP traffic"><br><br><h3>  Results </h3><br>  We can replace the display of the results of the work of the ^ mgstat utility in Excel with the online display in the form of quite nice graphs.  The downside is that for this you need to use an alternative version ^ mgstat.  In principle, the source utility code may vary, which is not taken into account.  However, we get the convenience of observing what is happening in Cach√©. <br><br>  Thanks for attention! <br><br>  <i>To be continued ...</i> <br><br><h3>  PS </h3><br>  A demo stand (for one instance) is available for viewing <a href="http://37.139.17.101:3000/dashboard/db/mgstat">here</a> .  Login without login / password. </div><p>Source: <a href="https://habr.com/ru/post/331594/">https://habr.com/ru/post/331594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331582/index.html">Teach the bot! - marking of emotions and semantics of the Russian language</a></li>
<li><a href="../331584/index.html">Optimization history of one IoC container</a></li>
<li><a href="../331586/index.html">Design of the city based on data. Lecture in Yandex</a></li>
<li><a href="../331588/index.html">Compressing photos without apparent loss of quality: the Yelp experience</a></li>
<li><a href="../331590/index.html">Using MapXtreme .Net</a></li>
<li><a href="../331596/index.html">Level editor for three in a row</a></li>
<li><a href="../331598/index.html">Phoenix Framework - Webpack instead of Brunch, deploy using Distillery and a little systemd</a></li>
<li><a href="../331600/index.html">Two in one: how to use vim and nano?</a></li>
<li><a href="../331604/index.html">How to create visual effects for games</a></li>
<li><a href="../331606/index.html">The digest of interesting materials for the mobile developer # 209 (June 19 - June 25)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>