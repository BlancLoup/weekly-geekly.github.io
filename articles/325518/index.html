<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authenticating OAuth2 in-app using Google Sign-In. Continuous access to Google APIs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""From April 20, 2017, the sending of authorization requests from embedded browsers will be blocked."  This message from March 1 can be seen in some ap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authenticating OAuth2 in-app using Google Sign-In. Continuous access to Google APIs</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  "From April 20, 2017, the sending of authorization requests from embedded browsers will be blocked." </blockquote>  This message from March 1 can be seen in some applications where authorization is required.  About this, Google wrote in his blog in August 2016, and this means that soon in many applications will have to rewrite the registration process.  Enough is not enough, but there is a way out - use the recommended Google Sign-in authorization method. <br><br>  This method will be discussed in the lesson, as well as how to get the tokens needed to work with the Google API. <br><a name="habracut"></a><br>  In the lesson will be present a partial translation of official documentation.  But first, a little background from my practice and the first work with OAuth2, maybe someone will be in a similar situation. <br><br>  It took me for the app to get a live chat from YouTube.  And then I learned that in order to send requests for broadcasting (and only then chat), OAuth2 user authentication is required.  I started looking.  Information on this topic is very small, it is scattered, not suitable for my case, and of course everything was in English.  Basically, the information was to work with the most popular APIs: Drive, Cloud, Google Plus.  In the official YouTube API documentation there is a ready-made code, take it and use it, but it is not suitable for Android.  Having spent a considerable amount of time, through trial and error, I came to a working solution.  The first thing I wanted to do afterwards was to collect information ‚Äúin a heap‚Äù and put it on the shelves, which encouraged me to write this lesson. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Initially, my solution began with the fact that before the user opened the WebView for authorization (enter email, password).  Further, permission to use the data was requested, and only after permission in the answer came an authentication code (AuthCode), in more detail what will be done with it further.  The url that opened in webview was the following: <br><br><pre><code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/accounts.google.com/o</span></span><span class="hljs-regexp"><span class="hljs-regexp">/oauth2/auth</span></span>? client_id=<span class="hljs-number"><span class="hljs-number">60</span></span>*********<span class="hljs-number"><span class="hljs-number">5</span></span>ad3np.apps.googleusercontent.com &amp;redirect_uri=<span class="hljs-symbol"><span class="hljs-symbol">urn:</span></span><span class="hljs-symbol"><span class="hljs-symbol">ietf:</span></span><span class="hljs-symbol"><span class="hljs-symbol">wg:</span></span><span class="hljs-symbol"><span class="hljs-symbol">oauth:</span></span><span class="hljs-number"><span class="hljs-number">2.0</span></span><span class="hljs-symbol"><span class="hljs-symbol">:oob</span></span> &amp;access_type=offline&amp;response_type=code &amp;scope=<span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/www.googleapis.com/auth</span></span><span class="hljs-regexp"><span class="hljs-regexp">/youtube.readonly</span></span></code> </pre> <br>  This is nothing but a post request, in response to which a page containing authCode arrived, with the code in the page header.  Everything, as per the recommendation to the API, and the actions for hiding this code from the user were left to the developer. <br><br>  Everything worked well, the application was published, but one day I saw the following: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/465/8f5/b5f/4658f5b5f1994b669673dee12cbb154e.jpg"></div><br>  Clicking on the link "Read more" we get into the blog, where it is said that in the name of security, WebView authentication will not work from April 20th.  Well, I think, I just did and will have to be redone through Sign-In.  And initially I tried to make the implementation through this service.  However, with the existing knowledge of "what and why," it came out pretty quickly.  So, let's begin. <br><br>  <b>1. Get credentials</b> <br><br>  In the API Manager, create a new project (or select an existing one): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3d3/4e1/4a6/3d34e14a688e4559a6c7f38ec51dab63.jpg"></div><br>  For authorization, you will need a configuration file, which can be obtained <a href="https:%252F%252Fdevelopers.google.com%252Fidentity%252Fsign-in%252Fandroid%252Fsign-in%253Fconfigured%253Dtrue%26cntlbl%3DContinue%2520Adding%2520Sign-In">in the wizard</a> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7c2/f88/703/7c2f8870335544e99ca6cf1bc35559be.jpg"></div><br>  Fill in the application name and package.  Next, choose which service we are connecting (Google Sign-In), here you need to enter the SHA1 application key, get it simply: in Android Studio, find the Gradle tab, open the Tasks tabs and android-signingReport.  We double-click, and in the logs will appear information about the keys.  Find the key SHA1, copy. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/231/551/1e6/2315511e6671456580b3a55447b0782a.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f65/a43/29a/f65a4329a53b44359410676f3d95a10e.jpg"></div><br>  Click the button ‚ÄúGenerate configuration file‚Äù, and after ‚ÄúDownload google-services.json‚Äù.  This json file is saved in the project folder ‚Äúapp‚Äù. <br><br>  <b>Important!</b>  If you are going to publish the application on Google Play, the SHA1 debug key will need to be replaced with the release key, and the configuration file will be replaced accordingly. <br><br>  We go into the Manager API, we see that the keys and identifiers of OAuth clients have been generated.  We need only the Web client data (client ID and client secret). <br><br><img src="https://habrastorage.org/files/3bc/c80/b26/3bcc80b26c5e481c9e70c6f33c43f82d.jpg"><br>  In the tab ‚ÄúOAuth Access Request Window‚Äù, you can change the email and product name - this is what will be written when permission is requested ‚ÄúApplication **** requests: ...‚Äù <br><br>  <b>2. Configure client sign-in</b> <br><br>  To access the Google Api Client, add the following dependencies to the gradle app file: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">compile</span></span> <span class="hljs-string"><span class="hljs-string">'com.google.android.gms:play-services-auth:10.2.0'</span></span></code> </pre> <br>  And the plugin (at the end of the file): <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">apply</span></span> plugin: <span class="hljs-string"><span class="hljs-string">'com.google.gms.google-services'</span></span></code> </pre> <br>  To the gradle project file depending on: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">classpath</span></span> <span class="hljs-string"><span class="hljs-string">'com.google.gms:google-services:3.0.0'</span></span></code> </pre> <br>  Customize options: <br><br><pre> <code class="java hljs">GoogleSignInOptions gso = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN) .requestServerAuthCode(getString(R.string.server_client_id)) .requestEmail() .requestScopes(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/youtube.readonly"</span></span>)) .build();</code> </pre> <br>  Here the most interesting lines are: <br><br>  <code>requestServerAuthCode(getString(R.string.server_client_id))</code> - we request authCode, passing the parameter client identifier (all), which was received above. <br><br>  <code>requestScopes(new Scope("***"))</code> - we request the area / area of ‚Äã‚Äãaccess required for the API used.  There are some already defined areas in Scopes, but if you don‚Äôt find one there, you can set your own, as in my case.  For the user will be displayed as access to "what" wants to get the application. <br><br>  Customize the client: <br><br><pre> <code class="java hljs">GoogleApiClient mApiClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GoogleApiClient.Builder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .enableAutoManage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .addApi(Auth.GOOGLE_SIGN_IN_API, gso) .build();</code> </pre> <br>  Everything is according to the standard documentation: <br><br>  <code>enableAutoManage(this, this)</code> - activation and connection listener are passed to the parameters (we implement the GoogleApiClient.OnConnectionFailedListener interface). <br><br>  <code>addApi(Auth.GOOGLE_SIGN_IN_API, gso)</code> - we specify that we use Sign In api and the previously created options object. <br><br>  Now, to start the authorization you need a button (or any other element).  You can use the standard Sign In Button.  Markup xml: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">com.google.android.gms.common.SignInButton</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/activity_button_sign_in"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  It looks like this: <br><br><img height="50" src="https://habrastorage.org/files/1e6/509/e38/1e6509e3861f46edaa08510a1ad5a99a.jpg"><br><br>  In the activation button is defined as all other views, we will hang the listener on it and execute the method on click: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (view.getId()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> R.id.activity_button_sign_in: signIn(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br>  The code of the called method is the creation of an intent and the activation call for authorization: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">signIn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Intent signInIntent = Auth.GoogleSignInApi.getSignInIntent(mApiClient); startActivityForResult(signInIntent, RC_AUTH_CODE); }</code> </pre> <br>  We pass the configured mApiClient to the parameter.  RC_AUTH_CODE any number, as always, to track the result of the activation. <br><br>  When you click on the button, you will be prompted to select an account to login, or add a new one.  After selecting, the application will ask for permission: <br><br><div style="text-align:center;"><img height="350" src="https://habrastorage.org/files/806/185/fc1/806185fc18ee4b2b87f07de434fbfece.jpg"></div><br>  <b>3. Getting Auth code</b> <br><br>  After the user gives permission, in onActivityResult we get the data of his account: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onActivityResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestCode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Intent data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestCode == RC_AUTH_CODE) { GoogleSignInResult result = Auth.GoogleSignInApi.getSignInResultFromIntent(data); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.isSuccess()) { GoogleSignInAccount acct = result.getSignInAccount(); String authCode = acct.getServerAuthCode(); getAccessToken(authCode); } } }</code> </pre><br>  As a result, we get the auth code as a regular line, it looks like this: <br><br><pre> <code class="hljs markdown">4/iHhVmqtxccXh0Qs<span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">***</span></span>*oo5XG8OjaNsWu_kEKyw</code> </pre> <br>  Also from the account, you can get the user's email, username and avatar: <br><br>  acct.getEmail () <br>  acct.getDisplayName () <br>  acct.getPhotoUrl () <br><br>  This data may be needed, for example, to paste it into the header of the NavigationView. <br><br>  <b>4. Getting Access Token and Refresh Token</b> <br><br>  Received auth code, now it needs to be changed to the necessary tokens for API requests.  To do this, we form a request at <code>https://www.googleapis.com/oauth2/v4/token.</code>  For example, I will do this using OkHttp. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAccessToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String authCode)</span></span></span><span class="hljs-function"> </span></span>{ OkHttpClient client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OkHttpClient(); RequestBody requestBody = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormEncodingBuilder() .add(<span class="hljs-string"><span class="hljs-string">"grant_type"</span></span>, <span class="hljs-string"><span class="hljs-string">"authorization_code"</span></span>) .add(<span class="hljs-string"><span class="hljs-string">"client_id"</span></span>, getString(R.string.server_client_id)) .add(<span class="hljs-string"><span class="hljs-string">"client_secret"</span></span>, getString(R.string.client_secret)) .add(<span class="hljs-string"><span class="hljs-string">"code"</span></span>, authCode) .build(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Request request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Request.Builder() .url(<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span></span>) .header(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>) .post(requestBody) .build(); client.newCall(request).enqueue(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Callback() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onFailure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request request, IOException e)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Response response)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { JSONObject jsonObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONObject(response.body().string()); mAccessToken = jsonObject.get(<span class="hljs-string"><span class="hljs-string">"access_token"</span></span>).toString(); mTokenType = jsonObject.get(<span class="hljs-string"><span class="hljs-string">"token_type"</span></span>).toString(); mRefreshToken = jsonObject.get(<span class="hljs-string"><span class="hljs-string">"refresh_token"</span></span>).toString(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (JSONException e) { e.printStackTrace(); } } }); }</code> </pre> <br>  Consider more options.  In Request.Builder () We pass the url by which we get tokens: <br><br><pre> <code class="hljs lisp">url(<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span></span>)</code> </pre> <br>  In the header, specify the Content-Type: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("Content-Type", "application/x-www-form-urlencoded")</code> </pre> <br>  Specify that this is the POST method, passing in the body: <br><br><pre> <code class="hljs lisp">post(<span class="hljs-name"><span class="hljs-name">requestBody</span></span>)</code> </pre> <br>  Formed requestBody must contain parameters: <br><br>  <code>"grant_type", "authorization_code"</code> - indicate that we will transmit auth code <br>  <code>"client_id", getString(R.string.server_client_id)</code> - the parameter is the client id obtained in the API Manager <br>  <code>"client_secret", getString(R.string.client_secret)</code> - client secret obtained in API Manager <br>  <code>"code", authCode</code> - actually received code. <br><br>  The request is asynchronous, in the response we get the usual json with all the necessary data for work: <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"access_token"</span></span>:<span class="hljs-string"><span class="hljs-string">"ya29.GlsfBJNMTfGy‚Ä¶"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"token_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"Bearer"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"expires_in"</span></span>:<span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-attr"><span class="hljs-attr">"refresh_token"</span></span>:<span class="hljs-string"><span class="hljs-string">"1\/72OqA7zYuyY__XhGij5oA2nEb7‚Ä¶"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id_token"</span></span>:<span class="hljs-string"><span class="hljs-string">"eyJhbGciOiJSUzI1NiIsImtpZ‚Ä¶"</span></span> }</code> </pre> <br>  <code>"access_token"</code> - the access token for which everything was done <br>  <code>"expires_in"</code> is the access token's lifetime, by default the token lives 1 hour, and 25 tokens can be received on request per day, no more. <br>  <code>"token_type"</code> is a type of token, it must also be remembered, it is also inserted into the request to api in the future. <br>  <code>"refresh_token"</code> is a token to refresh the access token when an hour has passed.  Refresh token unchanged.  Often I saw a problem on the forums that I faced myself: this token did not arrive in the request.  Errors are incorrect credentials, or incorrect requests.  If authorization was done via WebView, and such an important parameter as access_type = offline was not specified in the url, then the refresh token simply did not arrive. <br><br>  <b>5. Update Access Token</b> <br><br>  An hour has passed, the access token is no longer active, a new one is needed.  After that, 401 or 403 errors will sprinkle, the server will say that the user is not authorized or does not have access.  It is not good to request a new permit if we need a continuous session, for example, like me, you need to continuously receive messages from the chat during the broadcast, and this is a few hours.  What to do?  Send a request for a new token. <br><br>  The request is basically the same as in clause 4, except for some parameters: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNewAccessToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ OkHttpClient client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OkHttpClient(); RequestBody requestBody = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormEncodingBuilder() .add(<span class="hljs-string"><span class="hljs-string">"refresh_token"</span></span>, mRefreshToken) .add(<span class="hljs-string"><span class="hljs-string">"client_id"</span></span>, getString(R.string.server_client_id)) .add(<span class="hljs-string"><span class="hljs-string">"client_secret"</span></span>, getString(R.string.client_secret)) .add(<span class="hljs-string"><span class="hljs-string">"grant_type"</span></span>, <span class="hljs-string"><span class="hljs-string">"refresh_token"</span></span>) .build(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Request request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Request.Builder() .url(<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span></span>) .header(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>) .post(requestBody) .build(); client.newCall(request).enqueue(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Callback() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onFailure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request request, IOException e)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Response response)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { JSONObject jsonObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONObject(response.body().string()); mAccessToken = jsonObject.get(<span class="hljs-string"><span class="hljs-string">"access_token"</span></span>).toString(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (JSONException e) { e.printStackTrace(); } } }); }</code> </pre> <br>  Here are the important parameters: <br><br>  <code>"grant_type", "refresh_token"</code> - in the type indicate that we are sending a refresh token <br>  <code>"refresh_token", mRefreshToken</code> - and the token itself <br><br>  The answer will be json, containing the new access token, with which you can again access the API: <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"access_token"</span></span>:<span class="hljs-string"><span class="hljs-string">"ya29.GlsfBM7Y..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"token_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"Bearer"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"expires_in"</span></span>:<span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id_token"</span></span>:<span class="hljs-string"><span class="hljs-string">"eyJhbGciOiJ..."</span></span> }</code> </pre> <br>  This authorization and user authentication is completed. <br><br>  For example, I‚Äôll show you how the request to the API looks like, and how I am updating the token. <br>  To request an API, I use Retrofit2 + RxAndroid.  This is the request for live chat chat: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GET</span></span>(GoogleApiUrls.Youtube.CHAT) <span class="hljs-function"><span class="hljs-function">Observable&lt;ChatResponse&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getChat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Header(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Authorization"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String token, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"liveChatId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String liveChatId, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"part"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String part)</span></span>;</code> </pre> <br>  Here it is important to note that in the header, the type of token and the access token itself must be transmitted via the Authorization key.  That is so: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Authorization</span></span> Bearer ya29.GlsfBJNMTfGy‚Ä¶</code> </pre> <br>  Next, I make a request through RxAndroid, and since all sorts of errors come to the onError callback, the HttpException error with code 401 Unauthorized comes after an hour.  Here I process it, check if it is the same error, then I bring it to the appropriate type, check if this is really code 401 and execute the method of getting a new token, then repeat the request. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Throwable e)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> HttpException) { HttpException exception = (HttpException) e; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exception.code() == <span class="hljs-number"><span class="hljs-number">401</span></span>) { getNewAccessToken(); } } }</code> </pre> <br>  There is also a GET request for checking a token: <br><br><pre> <code class="hljs objectivec">https:<span class="hljs-comment"><span class="hljs-comment">//www.googleapis.com/oauth2/v3/tokeninfo?access_token=ya29.GlsfBJNMTfGy‚Ä¶</span></span></code> </pre> <br>  In response, data will come about the token, if it is still active, or an error, if its lifetime has expired. <br><br>  Again, the implementation of the update token Google leaves on the developer. <br><br>  It is much easier to leave the account and revoke the authorization; it is easy to find it in the official documentation, if necessary. <br><br>  I recommend checking inquiries in a third-party application / extension, for example Postman, to make sure that the parameters are entered correctly and the responses received.  I will be very happy if someone lesson will be useful! <br><br>  Links to the documentation used: <br><br>  <b>1.</b> <a href="https://developers.google.com/identity/sign-in/android/start-integrating">Google Sign-In for Android</a> <br>  <b>2.</b> <a href="https://developers.google.com/youtube/2.0/developers_guide_protocol_oauth2">Youtube API.</a>  <a href="https://developers.google.com/youtube/2.0/developers_guide_protocol_oauth2">OAuth 2.0 flows</a> </div><p>Source: <a href="https://habr.com/ru/post/325518/">https://habr.com/ru/post/325518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325508/index.html">Posting 3CX on Google Compute Engine</a></li>
<li><a href="../325510/index.html">Teach TensorFlow to draw Cyrillic</a></li>
<li><a href="../325512/index.html">Report and presentations with Moscow JS in the Superjob office</a></li>
<li><a href="../325514/index.html">Registration and authorization of the user on the site - one click - through the custom Facebook button. 2017</a></li>
<li><a href="../325516/index.html">Conference DUMP-2017: Section "Testing"</a></li>
<li><a href="../325522/index.html">Bash scripts: start</a></li>
<li><a href="../325524/index.html">Do new GitHub terms of use conflict with copyright?</a></li>
<li><a href="../325526/index.html">Do we need neural networks?</a></li>
<li><a href="../325528/index.html">Kademlia (DHT) - A Practical Guide</a></li>
<li><a href="../325532/index.html">Top 8 new fintech applications of the beginning of 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>