<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rendering drops with transparency and reflections on OpenGL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will look at how to render drops on OpenGL and calculate the normal for reflection and transparency on the fly. As well as Metaball...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rendering drops with transparency and reflections on OpenGL</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article we will look at how to render drops on OpenGL and calculate the normal for reflection and transparency on the fly.  As well as Metaballs, graphics chipset bugs and optimization tricks you can apply for 60 FPS on mobile devices. </p><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/files/a2a/109/4cb/a2a1094cb19244c2b853fef0dc34e7e7.gif"></div><a name="habracut"></a><p></p><br><h1>  <font color="#265b82">Content</font> </h1><br><p>  Part 1. <a href="https://habrahabr.ru/post/282065/">Mobile cross-platform engine</a> <br>  Part 2. <a href="https://habrahabr.ru/post/282191/">Rendering UTF-8 text using an SDF font</a> <br>  Part 3. Rendering drops with transparency and reflections. </p><br><hr><br><h1>  <font color="#265b82">Metaballs</font> </h1><br><p>  At the heart of the drop rendering is the <a href="https://ru.wikipedia.org/wiki/Metaball">Metaballs</a> technique. <br>  The text is difficult to convey the meaning of this technique, so I will show it clearly.  Moreover, this technique is very similar to the one we used with SDF fonts in the <a href="https://habrahabr.ru/post/282191/">previous article</a> . </p><br><p>  So open any graphics editor: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7b9/d72/2e6/7b9d722e6cbb4895a35fd59e5e026fdb.jpg"></div><br><img width="150" align="right" src="https://habrastorage.org/files/e6c/e90/bbb/e6ce90bbb7634311b850e35f91de0c85.jpg"><br><ol><li>  Draw a point with a blurred brush. </li><li>  Add some more such points so that they overlap a little. </li><li>  Twisting levels (Levels) to the desired effect. </li></ol><br><p>  In the simplest form, Metaballs is ready.  As you probably guessed, the fluid consists of many such points, to which it only remains to fasten the physics and add a shader for beauty. <br clear="all"></p><br><p>  In the rendering of a separate drop there is a trick.  If we render a drop with an ordinary radial gradient, we get an ever-round pea, which in dynamics will look very strange.  Therefore, we take into account the speed of each individual drop and slightly shift the center of the gradient towards acceleration.  As a result, even lonely drops will be slightly stretched when moving, which will noticeably revive the picture. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/df9/46c/c8c/df946cc8cbf04f78a9486bf4c51ca36d.jpg"></div><br><h1>  <font color="#265b82">Prepare OpenGL</font> </h1><br><p>  To render drops, we first need to render intermediate stages into texture.  This can be done using <strong>FBO</strong> ( <a href="https://ru.wikipedia.org/wiki/Framebuffer_Object">Framebuffer Object</a> ).  At what you can use a smaller texture 1/2 or even 1/4 of the screen size.  The quality of this is almost not affected. </p><br><pre><code class="hljs ruby">width=  ; height=  ; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> FBO glGenFramebuffers(<span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;framebuffer); glBindFramebuffer(GL_FRAMEBUFFER, framebuffer); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      glGenTextures(<span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;texture); glBindTexture(GL_TEXTURE_2D, texture); glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE); glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE); glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR); glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR); glTexImage2D(GL_TEXTURE_2D, <span class="hljs-number"><span class="hljs-number">0</span></span>, GL_RGBA, width, height, <span class="hljs-number"><span class="hljs-number">0</span></span>, GL_RGBA, GL_UNSIGNED_BYTE, NULL); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   FBO glFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT<span class="hljs-number"><span class="hljs-number">0</span></span>, GL_TEXTURE_2D, texture, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><p>  Next, to switch to rendering into texture, we do: <br>  <em>glBindFramebuffer (GL_FRAMEBUFFER, framebuffer);</em> <em><br></em>  <em>glClear (GL_COLOR_BUFFER_BIT);</em> </p><br><p>  And to render again on the screen: <br>  <em>glBindFramebuffer (GL_FRAMEBUFFER, 0);</em> </p><br><p><img align="left" width="100" src="https://habrastorage.org/files/8c6/27d/12c/8c627d12c0624bed9f83807ae9ab2032.jpg">  It would be logical to use RGB texture without transparency to save resources.  And in most cases, everything will be fine.  But not on Androids with <strong>Adreno</strong> chipsets.  On rare devices, noise or solid black will be displayed in the texture.  Therefore, it is better to use the <strong>GL_RGBA</strong> format. <br clear="all"></p><br><h1>  <font color="#265b82">Render drops</font> </h1><br><p>  With the first pass, we render all the drops into the texture, taking into account their speed and material. <br>  Below is the pseudocode.  In the original code, there are too many references to specific engine functions. </p><br><pre> <code class="hljs ruby">glBindFramebuffer(GL_FRAMEBUFFER, framebuffer); glClear(GL_COLOR_BUFFER_BIT); bindShader(metaBalls); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( -  ){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-string"><span class="hljs-string">""</span></span>  vx =    ; vy =    Y; vLength = length(vx, vy); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(vLength &gt; vMax) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>,            vx *= vMax/vLength; vy *= vMax/vLength; } setUniforms( vx, vy, . ); renderQuadAt( .x, .y ); }</code> </pre> <br><p>  You should get something like this: </p><br><div style="text-align:center;"><img width="300" src="https://habrastorage.org/files/bd9/ecb/9f8/bd9ecb9f89b0438286bb933d9f4663ae.jpg"></div><br><p>  An attentive reader will ask: <br>  <em>"Why is it red? Where did green come from? And what are these curbs?"</em> </p><br><p>  <strong>Material</strong> </p><br><p>  Suppose you want to drop a few materials at once.  And so that they can blend seamlessly.  For this, together with the speed, we also transfer the drop material.  This is a normal float from 0 to 1, which will mean a transition from one material to another.  In the <font color="red"><strong>RED</strong></font> texture channel, we write the gradient itself, and in <font color="green"><strong>GREEN</strong></font> we write the material. </p><br><p>  <strong>Border</strong> </p><br><p>  Look again at the gif-ku from the article header.  You will see that next to the curb the drop spreads out a bit, but it does not climb onto the curb itself.  For such an effect, it is necessary to impose a pre-created mask on top, where information is stored in the R and G channels - what to add and what to take away. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7b7/581/90c/7b758190cb91479389702f84bba67f84.jpg"></div><br><p>  The formula can be written like this: (texture with drops + RED) * BLUE. <br>  Those.  along the blurred edges of the border, we slightly increase the drops, and directly on the border, on the contrary, we remove the drops. </p><br><p><img align="left" width="80" src="https://habrastorage.org/files/557/7fd/68a/5577fd68a6c54106a58226977e77c78b.png"><img align="right" src="https://habrastorage.org/files/687/7a3/575/6877a3575a8b4e1c96e76fcce213d8cb.jpg">  Try painting on top of any contrasting grayscale texture.  For example: <br>  Your drops suddenly begin to flow around the protrusions on the texture. <br>  Of course, this has nothing to do with physics, it is only a visual trick. <br clear="all"></p><br><h1>  <font color="#265b82">Head shader</font> </h1><br><p>  Now we need to display one quad (two triangles / polygons) the size of the entire screen.  In this shader, you need to use the Metaballs technique so that you get a bit blurry edges.  This will give us a 3D effect at the edges of the drop. <br>  Next, read the adjacent gradient texels and calculate the normal for the reflection, from which we take the value from the Matcap texture. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2d2/f8a/132/2d2f8a132f0c426e894e34d51ef68a10.jpg"></div><br><p>  Below is a cleaned shader code for better perception: </p><br><pre> <code class="hljs xml">// OpenGL ES    precision #ifdef DEFPRECISION precision mediump float; #endif varying mediump vec2 outTexCord; //FBO ,      uniform lowp sampler2D tex0; //Matcap  uniform lowp sampler2D tex1; #define limitMin 0.4 #define limitMax 1.6666 #define levels(a,b,c) (ab)*c void main(void){ //         Metaballs float tex = texture2D(tex0, outTexCord).r; float gradient = levels(tex, limitMin, limitMax); //   ,    Adreno #ifndef ADRENO if(gradient<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">=0.0){</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">discard</span></span></span><span class="hljs-tag">; } #</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endif</span></span></span><span class="hljs-tag"> //  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span><span class="hljs-tag">       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vec2</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">step</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">vec2(0.002,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0.002</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vec2</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">outTexCord;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord.x</span></span></span><span class="hljs-tag">+=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">step.x;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">right</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">texture2D(tex0,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.r</span></span></span><span class="hljs-tag">; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord.x-</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">step.x*2.0;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">left</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">texture2D(tex0,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.r</span></span></span><span class="hljs-tag">; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord</span></span></span><span class="hljs-tag">+=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">step;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bottom</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">texture2D(tex0,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.r</span></span></span><span class="hljs-tag">; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord.y-</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">step.y*2.0;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">top</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">texture2D(tex0,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.r</span></span></span><span class="hljs-tag">; //      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vec3</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">normal</span></span></span><span class="hljs-tag">; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">normal.z</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">gradient;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">normal.x</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">(right-left)*(1.0-gradient);</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">normal.y</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">(bottom-top)*(1.0-gradient);</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">normal</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">normalize(normal);</span></span></span><span class="hljs-tag"> //       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vec3</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">vec3(outTexCord-0.5,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0.5</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">normalize(reflect(ref,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">normal</span></span></span><span class="hljs-tag">)); // </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Matcap</span></span></span><span class="hljs-tag">  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">(ref.xy+0.5)*0.5;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vec4</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">matcap</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">texture2D(tex1,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cord</span></span></span><span class="hljs-tag">); //     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">matcap.a</span></span></span><span class="hljs-tag">*=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">min(1.0,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gradient</span></span></span><span class="hljs-tag">*</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">10.0</span></span></span><span class="hljs-tag">); // ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">matcap.a</span></span></span><span class="hljs-tag">*=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">1.0-gradient*0.2;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gl_FragColor</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">matcap;</span></span></span><span class="hljs-tag"> }</span></span></code> </pre> <br><p>  <strong>Adreno</strong> </p><br><p>  Most of the problems were brought by Android devices with <strong>Adreno</strong> chipset. </p><br><ol><li>  On Adreno, you cannot do <strong>discard</strong> before all textures are read.  And it is better to refuse from discard at all. </li><li>  For FBO, you must use only RGBA texture.  On RGB, either noise or black will be displayed. </li></ol><br><p>  Is <strong>discard</strong> necessary then? <br>  Yes I need it.  Especially the increase in FPS is noticeable on tablets, where a large filrate should be fought for every pixel. </p><br><p>  <strong>Transparency</strong> </p><br><p>  For transparency, we use a simple trick: the closer to the edge of the drop, the more the normal deviates, which means that the transparency at the edges decreases.  A sort of the most simplified <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25BE%25D1%2580%25D0%25BC%25D1%2583%25D0%25BB%25D1%258B_%25D0%25A4%25D1%2580%25D0%25B5%25D0%25BD%25D0%25B5%25D0%25BB%25D1%258F">Fresnel Effect</a> . </p><br><h1>  <font color="#265b82">Matcap</font> </h1><br><p>  Only by replacing the Matcap texture, we can get completely different materials - water, silver, gold, lava, milk, coffee, etc. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/19a/94e/281/19a94e281bb8490b91d46f29a449009b.jpg"></div><br><p>  It's good that there is enough free <a href="https://pixologic.com/zbrush/downloadcenter/library/">Matcap textures</a> on the Internet.  The truth is worth considering that in large drops the center of the texture will be very stretched.  Therefore, for a good result, you will have to sort out a lot of Matcap textures. </p><br><h1>  <font color="#265b82">Several materials</font> </h1><br><p>  Remember, when rendering drops in FBO, we also recorded the value of the material? <br>  Add small changes to the shader and get a smooth transition from one material to another. </p><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//   GREEN  vec2 tex = texture2D(tex0, outTexCord).rg; ... //     Matcap    vec4 matcap=mix( texture2D(tex1, cord), texture2D(tex2, cord), tex.g);</span></span></code> </pre> <br><p><img align="right" width="200" src="https://habrastorage.org/files/949/7b6/3c8/9497b63c84ff40a49a8467e7ae828cd3.gif">  And since the value of the material is tied to each individual drop, then changing the material of each drop in turn, we get the effect of flowing or mixing fluids. </p><br><p>  By the way, we are not limited to only two materials.  If you record one more material transfer to the BLUE channel, then you can interpolate four materials at once. <br clear="all"></p><br><h1>  <font color="#265b82">Optimization</font> </h1><br><p><img align="left" width="400" src="https://habrastorage.org/files/0fd/da7/779/0fdda777903f4ee39f180fa48a9762b8.jpg">  In the current form, getting 60 FPS on all devices will fail.  Especially hard was the main shader on iPad2.  Discard did not save, although it worked at 80% of the pixels.  Let's try to get rid of these empty 80%. </p><br><p>  We divide the screen into cells.  For me, the screen cell size was screenWidth / 20.  Smashed quad into cells, made up the index of these small squares.  Then we just have to look at which cells are filled with drops (plus add neighboring cells) and update the index with any grid change: </p><br><p>  <em>glBufferData (GL_ELEMENT_ARRAY_BUFFER, size, data, GL_DYNAMIC_DRAW);</em> </p><br><p>  Only cells really containing drops will be displayed. <br clear="all"></p><br><h1>  <font color="#265b82">Physics</font> </h1><br><p>  I will touch upon physics only occasionally.  This is a very interesting, but extensive topic for a single article. <br>  The basis is the <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D1%2582%25D0%25B5%25D0%25B3%25D1%2580%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%2592%25D0%25B5%25D1%2580%25D0%25BB%25D0%25B5">integration of Verlet</a> with minor modifications.  All that concerns Verla is enclosed in such a block of code: </p><br><pre> <code class="hljs markdown">//fric -  ,    float dt2,tmp; dt2=dt<span class="hljs-emphasis"><span class="hljs-emphasis">*dt; tmp = 2.0f *</span></span> x - prevX + accelX <span class="hljs-bullet"><span class="hljs-bullet">* dt2; prevX += (x - prevX)*</span></span>fric; x = tmp; tmp = 2.0f <span class="hljs-bullet"><span class="hljs-bullet">* y - prevY + accelY *</span></span> dt2; prevY += (y - prevY)*fric; y = tmp;</code> </pre> <br><p>  We can only check the distance between the drops, handle the collisions with the walls and take into account the surface tension so that the drops do not spread. </p><br><p>  With the surface tension had to cheat.  Each frame we look at which drops are in contact with each other, thus dividing them into groups.  Next we get the center of each group and ‚Äúpull‚Äù every drop to the center of the group.  This gave quite acceptable and quick results. </p><br><hr><br><p><img width="150" align="left" src="https://habrastorage.org/files/525/27c/775/52527c775b3e48728e0978a75744b196.jpg">  Bun! <br>  To make a drop fit well into the background, it is worth adding a shadow.  We can also get it in the main shader without a special load on the GPU. </p><br><p>  For the shadow, take the Metaballs a bit larger.  At the edges we darken a drop, beyond the edges we get black color and slightly expand the alpha mask.  Like that: <br clear="all"></p><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">float</span></span> shadow = levels(tex,     ); <span class="hljs-type"><span class="hljs-type">float</span></span> body=min(<span class="hljs-number"><span class="hljs-number">1.0</span></span>, gradient*<span class="hljs-number"><span class="hljs-number">10.0</span></span>); matcap.rgb*=min(<span class="hljs-number"><span class="hljs-number">1.0</span></span>, body*<span class="hljs-number"><span class="hljs-number">5.0</span></span>); matcap.a*=body+shadow;</code> </pre> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/282590/">https://habr.com/ru/post/282590/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282578/index.html">Mobx - managing the status of your application</a></li>
<li><a href="../282580/index.html">Installing CrashPlan in the Docker container on Synology NAS</a></li>
<li><a href="../282584/index.html">Use Webpack instead of Sprockets in Ruby on Rails</a></li>
<li><a href="../282586/index.html">Non-visual methods to protect the site from spam. Part 1. Statistics</a></li>
<li><a href="../282588/index.html">What are they scolding Golang for and how to fight it?</a></li>
<li><a href="../282592/index.html">Perl plugin version 1.5 released for IntelliJ IDEA</a></li>
<li><a href="../282600/index.html">Autonomous ftp-client with resume files</a></li>
<li><a href="../282602/index.html">(Why) Mail.Ru Mail includes strict DMARC</a></li>
<li><a href="../282604/index.html">Blast Wave in Unity3D (displacement shader)</a></li>
<li><a href="../282606/index.html">Spring Go to Badoo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>