<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kodorebus or strategy pattern on .Net 4.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, while working on one project, an interesting code was born. We immediately began to test our colleagues sharply, asking them to explain what...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Kodorebus or strategy pattern on .Net 4.0</h1><div class="post__text post__text-html js-mediator-article">  Recently, while working on one project, an interesting code was born.  We immediately began to test our colleagues sharply, asking them to explain what it is, how it works and what it does.  Even experienced developers, this code drives into a stupor (after a couple of minutes of hysterical laughter).  So, we meet: <br><br><pre><code class="cs hljs">Action&lt;Action&gt; action = (Action action) =&gt; { action(); };</code> </pre> <br>  Before looking under habrakat, try to answer some questions (we will pretend that you did not see title of a post): <br><ul><li>  What language is this piece of code written in? </li><li>  Is it correct syntactically?  Does it compile? </li><li>  Does this code make sense?  What is he doing? </li><li>  Why could such code be written? </li><li>  How can I improve this code?  (How would you write it?) </li><li>  Give real uses for this code. </li><li>  What potential problems may occur with its use? </li></ul><br>  Have you answered?  Then we dive under the cat behind the background and explanations. <br><a name="habracut"></a><br><br>  I‚Äôll say right away that this is a completely working code written in C # under .Net Framework 4.0.  Of course, we deliberately turned it into a cheerful rebus, in the production code it looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action&lt;Action&gt; doWork = work =&gt; { work(); };</code> </pre><br>  Speaking in Russian, we create a delegate that takes another delegate as a parameter.  Now I will tell how he was born, simplifying the existing code as much as possible, for ease of understanding.  We had this code (all names are fictional, and coincidences are random): <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyWorker</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoWorkInternal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>);<span class="hljs-comment"><span class="hljs-comment">//simulate work IsWorkDone = true; } public void DoWork() { DoWorkInternal(); } public bool IsWorkDone { get; private set; } }</span></span></code> </pre><br>  And such a test that checks the result of the work: <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestDoWork</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { MyWorker worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyWorker(); Assert.IsFalse(worker.IsWorkDone); worker.DoWork(); Assert.IsTrue(worker.IsWorkDone); }</code> </pre><br>  Over time, in combat conditions, it turned out that the <code>DoWorkInternal</code> method <code>DoWorkInternal</code> performed for a long time, and the result of its implementation does not affect the further operation of the application (here you can think about what he could do).  Naturally, I wanted to make its execution asynchronous: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoWork</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Task.Factory.StartNew(DoWorkInternal); }</code> </pre><br>  And, as you, probably, already guessed, thus we threw a few dozen tests, which continued to believe that the work will be done synchronously.  We considered it impractical to change the tests, since  they did their job right (they checked the fact of the work and its results).  Plus, there was absolutely no guarantee that in a month this work would not require synchrony and everything would have to be returned to its original form.  After a little analysis of the situation, it can be understood that here we are dealing with two strategies for doing work - synchronous execution and asynchronous.  And a one-way strategy degenerates into a delegate: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyWorker</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action&lt;Action&gt; doWork = work =&gt; { work(); }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoWorkInternal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>);<span class="hljs-comment"><span class="hljs-comment">//simulate work IsWorkDone = true; } public void DoWork() { doWork(DoWorkInternal); } public bool IsWorkDone { get; private set; } }</span></span></code> </pre><br>  Those.  The strategy for the simultaneous execution of the operation is as follows: <br><br><pre> <code class="cs hljs"> (Action work) =&gt; { work(); }</code> </pre><br>  Strategy for asynchronous execution: <br><br><pre> <code class="cs hljs"> (Action work) =&gt; { Task.Factory.StartNew(work); }</code> </pre><br>  Let's add a method to our class that will allow changing the default (synchronous) strategy to another: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetDoWorkStrategy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action&lt;Action&gt; doWork</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doWork = doWork; }</code> </pre><br>  Is done.  Test as evidence: <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestDoWork</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { MyWorker worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyWorker(); Assert.IsFalse(worker.IsWorkDone); worker.DoWork(); Assert.IsTrue(worker.IsWorkDone); MyWorker worker2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyWorker(); Action&lt;Action&gt; asyncWorkStrategy = (Action work) =&gt; { Task.Factory.StartNew(work); }; worker2.SetDoWorkStrategy(asyncWorkStrategy); Assert.IsFalse(worker2.IsWorkDone); worker2.DoWork(); Assert.IsFalse(worker2.IsWorkDone);<span class="hljs-comment"><span class="hljs-comment">//work is in progress }</span></span></code> </pre><br>  When using an asynchronous strategy, one should have a good understanding of the features of inter-thread interaction - access to controls, exception handling, etc.  Otherwise, side effects will be inevitable.  On this finish, I hope someone article may be useful. <br><br>  PS A discussion of the above codebing may be a good topic for a conversation with a candidate for the .Net developer position. </div><p>Source: <a href="https://habr.com/ru/post/132974/">https://habr.com/ru/post/132974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132962/index.html">Oracle Certified Professional Java Programmer Exam Preparation - Part 1</a></li>
<li><a href="../132963/index.html">Hosts Commander - console hosts editor for Windows and Linux</a></li>
<li><a href="../132967/index.html">Applications</a></li>
<li><a href="../132969/index.html">How do pythonists read Haskell</a></li>
<li><a href="../132973/index.html">Testing ICQ Web Clients</a></li>
<li><a href="../132975/index.html">Extend conky functionality: add function to display MPD track date</a></li>
<li><a href="../132976/index.html">Conversion function stdClass to SimpleXml</a></li>
<li><a href="../132977/index.html">DasKeyboard Ultimate S Review (Perhaps the first in several years)</a></li>
<li><a href="../132978/index.html">ExtJS review 4. Porting experience from the old version</a></li>
<li><a href="../132979/index.html">Can we make the software world better?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>