<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Building an automated testing pipeline on Azure DevOps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I encountered a not very popular yet beast in the DevOps world, Azure DevOps pipelines. Immediately I felt the absence of any intelligible i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Building an automated testing pipeline on Azure DevOps</h1><div class="post__text post__text-html js-mediator-article">  Recently, I encountered a not very popular yet beast in the DevOps world, Azure DevOps pipelines.  Immediately I felt the absence of any intelligible instructions or articles on the topic, I don‚Äôt know what it is connected with, but Microsoft clearly has something to work on in terms of popularizing the tool.  Today we will build a pipeline for automated testing inside the Azure cloud. <a name="habracut"></a><br><br>  So, the task: <br>  There is a software that builds using the same Azure DevOps, collected from the project on WIX.  If there is interest, I will write about this tool.  In fact, this is a more automated automation method for building installers, replacing the standard InstallShield.  So, our software is successfully assembled and generates an artifact, a kind of setup.exe, which puts the application in the Windows system.  You need to put this application in a virtual-like virtual machine, copy the automated tests prepared by the testing team, run them, and pick up the results in order to consider the branch good or bad before merjit.  Just like in GitLab, <s>only through ...</s> <br><br>  As a virtualization environment, where we will execute our tests, we obviously use Azure DevTest Labs, an entity in Azure subscriptions, which is designed to twist any test nonsense in it for reasonable money. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  1. Cloud-side integration </h1><br>  First we need to integrate our DevTest Labs with Azure DevOps, for which we need a certain Service Principal, essentially a service account that allows you to go to the cloud and create / delete resources for yourself there. <br><br>  Go to the subscription and find the service Azure Active Directory <br><br><img src="https://habrastorage.org/webt/cf/fn/bq/cffnbqsgvtmscikoypqdftkarpg.jpeg"><br><br>  Find App Registrations and click on New Registration, this will create us our service principal.  I will not analyze in detail what settings to choose when creating it, it may differ from different subscriptions. <br><br><img src="https://habrastorage.org/webt/ns/4a/jq/ns4ajqbtui4oz51gruhl84gejac.jpeg"><br><br>  Now we need to give rights to our service director.  To do this, go to the subscription icon with the key.  Choose our subscription. <br><br><img src="https://habrastorage.org/webt/-p/tj/te/-ptjtehk7ftpdtlf4op0dwlqj9g.jpeg"><br><br>  Next, in Access Control, click Role Assignment and look for this account in the search for the newly created name.  We give the role Contributor, that's enough. <br><br><img src="https://habrastorage.org/webt/pr/nq/s_/prnqs_0culpmj9xrudzptpv4mc0.jpeg"><br><br>  Next, we return to our Service Principal in Azure AD and open its properties.  Later, we will need all the IDs that are there, save them. <br><br>  This completes our portal settings and we are moving to Azure DevOps. <br><br><h1>  2. Integration on the side of Azure DevOps </h1><br>  First of all, we‚Äôll go to the project settings and select Service Connections.  Create a new item of type Azure Resource Manager. <br><br><img src="https://habrastorage.org/webt/ct/hc/7c/cthc7c3qagkfuyxa3_6fyod5k90.jpeg"><br><br>  Now we need all the ID that we recorded.  We click on it.  And we enter all the data that we received from the Service Principal.  We press verify and if everything is fine we save the connection.  Now our pipelines can use it to connect to the cloud. <br><br><img src="https://habrastorage.org/webt/it/7s/as/it7sas1cjqbrwt58uncazzfp4ee.jpeg"><br><br><h1>  3. Create Pipeline </h1><br>  Now we proceed to the most interesting, the construction of the pipeline directly.  Open the Pipelines Builds menu. <br><br><img src="https://habrastorage.org/webt/et/wd/h5/etwdh5romudzssphyz-hmliq2bw.jpeg"><br><br>  We are met by the menu of creating a new build, which by default will try to create for us a YAML file of a suitable configuration.  We politely refuse it and choose the classic version.  It is understandable that Microsoft‚Äôs desire to do everything like that of people and give the opportunity to customize pipelines as much as possible through YAML, but stingy documentation and just the practical inoperability of many modules tells us that it is too early to use this functionality. <br><br><img src="https://habrastorage.org/webt/it/at/gu/itatgu_alr1efjbtvlr6rin5e9i.jpeg"><br><br>  From the variety of templates, we need a simple Empty Pipeline.  After its creation, we are greeted by an empty editing window, in which we will continue to spend quite a lot of time. <br><br><img src="https://habrastorage.org/webt/0t/g0/0h/0tg00hw3ojp3plkvochf9-skdac.jpeg"><br><br>  So, click on + and get into a certain store of modules, where we will need the following components from the list. <br><br><img src="https://habrastorage.org/webt/9q/2l/ud/9q2ludjenipcm_m8oteqerfseoe.jpeg"><br><br>  Before we proceed to the configuration of the taskline pipeline, we need to create and put several files into the project.  These will be the ARM Template of our virtual machine, which we will generate in Azure DevTest Labs, the script for retrieving the IP machine after it has been created, and, if desired, the scripts of our tests or what we want to run on the host. <br><br><h1>  4. Generate ARM Template </h1><br>  To create a virtual machine, we will first need to generate a template for it, a json file, which we put in the project code so that it can read the pipeline from there. <br><br>  Go to our lab and find the Formulas menu (reusable bases), click on create a new one. <br><br><img src="https://habrastorage.org/webt/8w/rc/-l/8wrc-lfvdcettljp5-j7iclsz1u.jpeg"><br><br>  We will be greeted by a long list of imadzhey as a base, the choice of the size of the machine, all the same as when creating a virtual machine.  At this stage we will not stop; we will immediately move on to the last item in the properties of the machine, namely artifacts.  You can use any configuration that is required for your environment.  For example, I add a car to a domain and add a service account to it as an admin so that the pipeline could then go to that car under this account.  This all may vary, but for successful testing of the code we need one artifact, which we will discuss in more detail.  To put the latest version of the software we are testing on our machine, we will use the Download Azure Pipelines Artifact and Run Script artifact.  Remember in the beginning I said that somewhere going to build an installer application?  Right now we need to tell the virtual machine, or rather the template, that it go and pick up this artifact.  And I didn‚Äôt just take it, but I also installed it, for which we fill in special fields indicating the project, the name of the build and the secret key.  The secret key, as in all systems of this kind, is generated in the account, in this case in Azure DevOps and stored in Secrets in your lab.  There is a small disclaimer, in Secrets we will save it, but the template from this is neither cold nor hot, it will be launched from another user within the pipeline, for this we will have to manually enter the secret key again into the template. <br><br>  Another artifact that needs to be included is ‚ÄúConfigure WinRM‚Äù, we will need it for future access to the machine.  There is only one parameter, hostname.  Since we do not know it in advance, we will use the% COMPUTERNAME% variable. <br><br><img src="https://habrastorage.org/webt/ve/46/ps/ve46psila9wlzhoh9hiiwatcvxe.jpeg"><br><br>  So we added all the necessary artifacts, let's go to why we even came here at all.  We get the generated ARM Template in the Advanced tab of the same formula creation window. <br><br><img src="https://habrastorage.org/webt/bj/ly/ae/bjlyaelkb2okdk8cvk3xvtjhrm0.jpeg"><br><br>  Copy the contents of the page in the file VMtemplate.json and put it in the root of the project.  We don‚Äôt need a cloud anymore, we‚Äôll return to the pipeline. <br><br><h1>  5. Pipeline configuration </h1><br>  Let's start with the most important and inefficient creation of the virtual machine, for this we have done all these integrations and templates.  In the Azure RM Subscription section, we select our Service connection, which we configured in paragraph 2. Next, the lab environment available to us should pop up.  Then we select json which we generated and we define some obligatory variables.  The login and password from the car can be set either directly or by variables, but I'm not at all sure that it works, no matter what I wrote there, I couldn‚Äôt go to the car under these credits, the main thing is to set the name of the car so that it will always be possible unique.  For this, I use the build environment variable. <br><br><img src="https://habrastorage.org/webt/cx/nw/gv/cxnwgvb73r6yougop6htozc6g3c.jpeg"><br><br>  Next, we set up another important point.  After the car takes off, we need to somehow know its parameters, and it‚Äôs better not for us but for the pipeline.  To do this, we make a script, for example GetLabVMParams.ps1 and put it there, in the project.  I took the text of the script on the Microsoft website, but slightly corrected it for my environment, because  he took the PublicIP and FQDN machines.  I have neither this nor that, but there is a PrivateIP which is not so easy to get, so I added a piece. <br><br><pre><code class="plaintext hljs">Param( [string] $labVmId) $labVmComputeId = (Get-AzureRmResource -Id $labVmId).Properties.ComputeId # Get lab VM resource group name $labVmRgName = (Get-AzureRmResource -Id $labVmComputeId).ResourceGroupName # Get the lab VM Name $labVmName = (Get-AzureRmResource -Id $labVmId).Name # Get lab VM public IP address # $labVMIpAddress = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName -Name $labVmName).IpAddress # Get lab VM FQDN # $labVMFqdn = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName -Name $labVmName).DnsSettings.Fqdn # Get lab VM private IP address $VmNetworkdetails= (((Get-AzureRmVM -ResourceGroupName $labVmRgName -Name $labVmName).NetworkProfile).NetworkInterfaces).Id $nicname = $VmNetworkdetails.substring($VmNetworkdetails.LastIndexOf("/")+1) $labVMnetwork = (Get-AzureRmNetworkInterface -Name $nicname -ResourceGroupName $labVmRgName)|Select-Object -ExpandProperty IPConfigurations $labVMIpAddress = $labVMnetwork.PrivateIpAddress # Set a variable labVmRgName to store the lab VM resource group name Write-Host "##vso[task.setvariable variable=labVmRgName;]$labVmRgName" # Set a variable labVMIpAddress to store the lab VM Ip address Write-Host "##vso[task.setvariable variable=labVMIpAddress;]$labVMIpAddress" # Set a variable labVMFqdn to store the lab VM FQDN name Write-Host "##vso[task.setvariable variable=labVMFqdn;]$labVMFqdn" Write-Output $labVMIpAddress Set-Item wsman:\localhost\client\trustedhosts * -Force</code> </pre> <br>  From all that the script reads, we need only the variable labVMIpAddress.  Well, this is for me, maybe you will need something else, so I didn‚Äôt delete anything and just commented out the extra. <br><br>  I will also explain the last line of the script, it allows our build machine access to any host via WinRM. <br><br>  The next stage, we run our wonderful script.  It will need the same connection to the cloud, the input variable with the machine ID, which will already be known from the previous step.  How?  Here it is necessary to mention such a wonderful thing as the Output Variables.  Each step may have a list of variables that are passed on to the next steps of the pipeline.  Accordingly, for our super script, this variable will be labVMIpAddress, do not forget to specify this. <br><br><img src="https://habrastorage.org/webt/yu/va/m7/yuvam7x2ikxspc7ucohyp5oivq4.jpeg"><br><br>  Next, I do fairly simple things that, moreover, can vary from case to case.  I execute a remote script with the creation of balls, into which I will then upload my scripts. <br><br><pre> <code class="plaintext hljs">New-Item ‚ÄúC:\test" ‚Äìtype directory New-SMBShare ‚ÄìName ‚Äútest‚Äù ‚ÄìPath ‚ÄúC:\test‚Äù ‚ÄìFullAccess everyone</code> </pre> <br>  From the name of the task, it is clear that further we copy some sample script onto the machine and execute it with one more stage.  As the address of the remote machine, our $ variable (labVMIpAddress) is useful to us.  Next, we use the ‚Äúpick up artifact from the balls‚Äù task and copy the results of the script execution into the build environment, then save these files to the build artifact with the same standard TASK.  After the machine is no longer needed, we kill it with the last step.  The main difficulty, as can be seen from the volume of the article, is to integrate with the cloud and make contact with the virtual machine you created, then you can have fun as much as you need. <br><br>  This is my first article, so do not judge strictly, comments are welcome. </div><p>Source: <a href="https://habr.com/ru/post/460431/">https://habr.com/ru/post/460431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460413/index.html">7 useful sites and applications for learning English</a></li>
<li><a href="../460415/index.html">Apple Watch 4 (44 mm, 2019) vs Pebble Steel Classic (2014)</a></li>
<li><a href="../46042/index.html">And in parrots, I am much longer ...</a></li>
<li><a href="../460423/index.html">PostgreSQL WAL: 3. Checkpoint</a></li>
<li><a href="../46043/index.html">Baseball cap with opener</a></li>
<li><a href="../460433/index.html">Risks and threats in the Internet of things</a></li>
<li><a href="../460437/index.html">How we put out a tech bike</a></li>
<li><a href="../460439/index.html">P4 programming language</a></li>
<li><a href="../46044/index.html">The British company requires you to give Odnoklassniki and income from them.</a></li>
<li><a href="../460441/index.html">Gleb Nitsman: ‚ÄúI found the very end of an era when people had not yet chased the gold contained in radio elements‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>