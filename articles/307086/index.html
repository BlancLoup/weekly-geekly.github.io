<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How do Fault Tolerant servers differ from ‚Äúconsumer‚Äù consumer goods in a specific example?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""Mirror" cluster with synchronous computing processes, front view 

 So far, the entire Internet is screaming about our domestic hard drive for as man...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How do Fault Tolerant servers differ from ‚Äúconsumer‚Äù consumer goods in a specific example?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b12/050/778/b12050778c2743e183c101a1b64e04ba.jpg"><br>  <i>"Mirror" cluster with synchronous computing processes, front view</i> <br><br>  So far, the entire Internet is screaming about our domestic hard drive for as many as 50 megabytes weighing 25 kilograms, not really understanding that this thing can survive two nuclear wars at the bottom of the pool, I will tell you about serious fault-tolerant servers and their differences from the usual iron.  Fortunately, we just received such tests for testing, and there was an opportunity to make fun of them. <br><br>  These solutions are especially interesting for admins.  <b>The fact is that they are protected not physically - by covers, fault-tolerant interfaces or something else, but at the level of the computing architecture.</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We got into the hands of the flagship ftServer 6800 from Stratus.  This is a case with two identical computing nodes united in one cluster, and both its halves work synchronously and make the same ‚Äúmirror‚Äù.  This is a good old "space" architecture, when the computational process goes through two independent hardware paths at once.  If there is a bug somewhere (not related to the curvature of the code), then one of the results will definitely reach the goal.  This is important for critical systems in various areas from banking to medicine, and this is very important where there is ‚Äúsilent data loss‚Äù.  That is, where processors bugs rise up to their full height, due to the fact that the crystals are still unique and there are no two identical machines in nature.  Usually this does not manifest itself, but on responsible tasks it is necessary to protect against the accidental influence of interference and possible more obvious problems.  Therefore, that's how it is done. <a name="habracut"></a><br><br>  <b>The most important:</b> <br><ul><li>  Computational processes are duplicated.  Components look for the OS, as one device.  Failover takes place at the driver level.  There is no CPU synchronization loss, but there is overhead related to HDD replication. </li><li>  Declared availability of 99,999 on Linux, Win and VMware.  From the nines dazzled in his eyes, and therefore we undertook to check this statement (as far as possible). </li></ul><br><br><h4>  How it works </h4><br>  One of the cluster nodes will always be the master (Primary), and the other slave (Secondary).  This approach to building due to the high requirements for resiliency (99,999), the technology is proudly called DMR (Dual Modular Redundancy).  Both nodes of the cluster synchronously perform operations and if one of the nodes is lost, they will instantly failover to the rest of the work. <br>  Each of the nodes is divided into two more modules (Enclosure): <br><ul><li>  CPU Enclosure - a module that includes a CPU and RAM; </li><li>  IO Enclosure is a module dedicated to PCIe, a RAID controller (with disks) and embedded NICs. </li></ul><br>  The Stratus engineers came to the division into two modules because of the different approaches to synchronizing the devices they contain: <br><ul><li>  For CPU Enclosure, Lockstep technology is used (step by step).  It guarantees that the components of these two modules will work synchronously and are in the same condition, which means that failover will always be successful. </li><li>  Lockstep cannot be used for IO Enclosure due to the presence of a large number of heterogeneous devices.  RAID controllers from both halves of the cluster are replicated by combining disks located in the same slots (in pairs).  NICs when using Windows (Intel PROset driver) work in one of the following modes: AFT, ALB, SFT, etc., thus the Primary node of the Secondary node is accessible to the node - a total of 8 pieces.  If Linux or ESXi is deployed, the NICs are assembled in bonding, that is, the ports are paired with the common MAC address (by analogy with the disks).  For third-party HBAs, if the Primary device fails, it will switch to a healthy one.  USB, located on the halves themselves, are not subject to synchronization.  This problem is solved by common ports VGA, USB and COM, soldered on a passive backplane.  They automatically switch to the active half in case of a crash, which means you do not have to switch your usual monitor with the mouse and keyboard to the ports of the new Primary node. </li></ul><br>  To manage the clustering, a separate ASIC is used - Stratus Albireo, named after the binary system of the star (romance).  This controller is located in each of the compute nodes.  He is responsible for synchronizing both nodes through a passive backplane, as well as for detecting faults. <br><br>  The connection between the compute node modules is organized according to the full mesh scheme.  Thus, we get a very flexible and fault-tolerant system: this layout allows the Primary node to see backup devices and in which case, for example, put the node's Secondary into the IO enclosure operation. <br><br><img src="https://habrastorage.org/files/404/3b7/d2b/4043b7d2b1d34c1a987143351045d3f3.png"><br>  <i>The topology of relationships between components of cluster nodes.</i> <br><br>  Stratus Albireo also ensures that the data streams received from both nodes are identical.  If there are discrepancies, the system will identify the cause and try to fix the failure.  If the error has been resolved (the error type is correctable), the MTBF (Mean Time Between Failures) counter will increase by 1, and if not, this element will be disabled (the error type is uncorrectable).  Error counting is carried out for the main components of each of the cluster nodes: CPU, RAM, HDD, IO devices.  Due to the accumulation of statistics, the controller can proactively signal the imminent breakdown of one or another component. <br><ol><li>  To operate the OS on this non-standard solution, Stratus uses special drivers divided into two classes: </li><li>  "Enhanced" drivers, developed in conjunction with the vendor.  They are called ‚Äúenhanced‚Äù because they are subjected to a series of tests for stability and compatibility. </li><li>  An additional virtual driver that forces the OS to see a pair of devices spaced across two compute nodes as one device, which ensures transparent failover. </li></ol><br>  To manage the cluster and initialize the OS, the Stratus Automated Uptime Layer software package is used (it has its own for each OS), and it is directly connected to Stratus Albireo (without it, the cluster will not work correctly).  On the types of this software and its capabilities, we describe below. <br><br><h4>  Specifications </h4><br>  FtServer 6800 is positioned as a solution for databases and high-load applications.  For those who need something simpler, there are two more models: ftServer 2800 and ftServer 4800. <br><br><table><tbody><tr><td><br>  <strong>Characteristic</strong> <br></td><td><br>  <strong>ftServer 2800</strong> <br></td><td><br>  <strong>ftServer 4800</strong> <br></td><td><br>  <strong>ftServer 6800</strong> <br></td></tr><tr><td><br>  Logical processor <br>  (per cluster node) <br></td><td><br>  1 socket <br></td><td><br>  1 socket <br></td><td><br>  2 sockets <br></td></tr><tr><td><br>  Processor type <br></td><td><br>  Intel Xeon processor E5-2630v3, 2.4 GHz <br></td><td><br>  Intel Xeon processor E5-2670v3, 2.3 GHz <br></td><td><br>  Intel Xeon processor E5-2670v3, 2.3 GHz <br></td></tr><tr><td><br>  Supported amount of RAM <br></td><td><br>  From 8 GB to 64 GB DDR4 <br></td><td><br>  16 GB to 256 GB DDR4 <br></td><td><br>  From 32 GB to 512 GB DDR4 <br>  Up to 1 TB for VMware <br></td></tr><tr><td><br>  Type of supported drives <br></td><td><br>  12 Gb / s SAS 2.5 " <br></td><td><br>  12 Gb / s SAS 2.5 " <br></td><td><br>  12 Gb / s SAS 2.5 " <br></td></tr><tr><td><br>  10/100/1000 Ethernet ports <br>  (per cluster node) <br></td><td><br>  2 <br></td><td><br>  2 <br></td><td><br>  2 <br></td></tr><tr><td><br>  10 Gb Ethernet ports <br>  (per cluster node) <br></td><td><br>  Not <br></td><td><br>  2 <br></td><td><br>  2 <br></td></tr><tr><td><br>  Integrated PCIe G3 buses (per cluster node) <br></td><td><br>  2x4 PCIe <br></td><td><br>  2x4 PCIe <br></td><td><br>  2x4 PCIe <br>  2x8 PCIe <br></td></tr><tr><td><br>  Additional PCIe bus <br>  (per cluster node) <br></td><td><br>  Not <br></td><td><br>  2 x 8 PCIe <br></td><td><br>  Not <br></td></tr></tbody></table><br>  In our cluster installed: Intel Xeon processor E5-2670v3, 2.3 GHz (2 pcs.), DDR4 32 GB, 2133 MHz, 512 GB, 400 GB SSD (1 pc.), 300 GB 15k HDD (2 pcs.), 1.2 TB 10k HDD (1 pc.), FC 16 Gb 1 port. <br><br>  The configuration meets the current performance requirements, and a special version is available for VMware, which is distinguished by a doubled RAM size - 1 TB.  Someone will say that now the standard for rack-servers is 2-3 TB of RAM, but you need to understand that the FT cluster is a solution, sharpened primarily under the protection of a certain system, the mechanism of which imposes its limitations. <br><br>  Here is a rear view: <br><br><img src="https://habrastorage.org/files/561/526/a93/561526a9328342f0902a22e494bdd8e7.jpg"><br><br>  Separately, about the display, it is quite simple and understandable even without instructions: <br><br><img src="https://habrastorage.org/files/6e8/8cd/74d/6e88cd74d9a64c449ce4b339f2fee60d.png"><br><br>  On the front panel are the main indicators responsible for the key elements of the nodes. <br><br>  But we should care about all three: <br><ol><li>  ‚ÄúSunny‚Äù - power is connected, this node is working; </li><li>  Primary - indicates which of the given cluster nodes is the leading one; </li><li>  Safe to Pull - if it is flashing, you cannot remove the cluster node, and if it is just burning, you can safely pull it out. </li></ol><br>  The display is fully visible only when the decorative panel is removed.  If it is returned in place, then we receive information only about the general state of the system, as well as whether the cluster nodes are synchronized or not. <br><br>  The chassis is a 4U box, which is divided into two main sections (allocated for cluster nodes) 2U each and one additional vertical section 4U high, in which the management module expander is connected to the QPI bus (clearly visible on the right in Figure 1 ).  With it, we get the usual set: DVD drive, USB port (three more are located at the back), VGA, COM port and even a modem, also it has a button for turning the server on and off under the cap, protecting it from being accidentally pressed. <br><br>  Initially, we were confident that the management module itself was in the expander, but this theory was debunked by an empirical method: despite extracting the expander from the chassis, we were able to successfully access the BMC (Baseboard management controller).  Later, when studying the cluster, it turned out that the BMC modules are located in the cluster nodes themselves. <br><br>  Extract one of the nodes and look at it closer.  To do this just will not work, for this you need to unplug the power cord, which holds the crossbar-lever (the first line of defense from accidental disconnection-extraction) and unscrew the two bolts in front.  It is noteworthy that because of this crossbar, the power supply unit ‚Äúfor hot‚Äù cannot be changed, you need to pull out the cluster node completely. <br><br><img src="https://habrastorage.org/files/680/106/620/6801066208ce4504a72da212d3299555.jpg"><br>  <i>Removing a cluster node.</i>  <i>Step 1.</i> <br><br><img src="https://habrastorage.org/files/061/fd1/9db/061fd19dbab24d7fa891f59679bf56d4.jpg"><br>  <i>Removing a cluster node.</i>  <i>Step 2.</i> <br><br>  After these manipulations, the chassis will allow you to push the cluster node only half, for a complete extraction, we will need to press the lever. <br><br><img src="https://habrastorage.org/files/f8e/890/ec7/f8e890ec74d14b1a94be82ffd7dcaef1.jpg"><br>  <i>Removing a cluster node.</i>  <i>Step 3.</i> <br><br>  After we got hold of the server, let's proceed to inspect what is inside. <br><br><img src="https://habrastorage.org/files/15c/662/130/15c662130105436b9a0fb415214b64f0.jpg"><br>  <i>Cluster node</i> <br><br>  There are no complaints about the assembly of the node itself.  Everything was done qualitatively and without obvious flaws. <br><br>  The placement of elements and cabling of the HDD and two USB 3.0 (hi PC) backplanes are laconic and do not cause any negative.  It is also worth paying attention to the thickness of the metal case: here it is thick, as in those Compaq servers.  The main elements of the body are attracted by screws with a washer-grower, which means that they are unlikely to spin out due to vibration.  Stratus engineers obviously wanted to show that the cluster is designed for high computational and physical loads. <br><br>  We can not fail to note an interesting find, namely, a significant amount of NEC company logos inside a non-NEC server.  And indeed, they are there for a reason.  As we managed to find out, Stratus has a contract with NEC for the production of servers, and NEC buys software (OEM) from Stratus.  Therefore, if you go to the NEC site, you can catch a sickly deja vu.  According to Stratus himself, only with the purchase of server hardware from them do you get the latest software, which is quite logical. <br><br><h4>  Failover Cluster Management </h4><br>  Let us turn to the software, namely, to the management interface of the BMC (for Stratus, it is proudly called the Virtual Technician Module).  It looks rustic: <br><br><img src="https://habrastorage.org/files/d08/011/3f1/d080113f108e40c9aec637e0ef2fee22.png"><br><br><img src="https://habrastorage.org/files/244/0e5/75e/2440e575e5b342b4abf313e4827e2fce.png"><br>  <i>VTM interface</i> <br><br>  On the other hand, all the main functionality is present: we can get access to KVM, and ISO to mount, and even to know the status of main components. <br><br>  The lower part of the management console is interesting, it displays the status of both cluster nodes, BIOS codes (at boot time), the number of users logged into each of the VTMs, the role of nodes in the cluster, as well as the Safe to Pull status. <br><br><img src="https://habrastorage.org/files/2ed/fcb/63d/2edfcb63de334fdfb17ad23aa4a1b86e.png"><br><br>  It's funny that if you go to the Secondary cluster node, then the graphical console disappears from the functional, and you can turn off the cluster, but you can‚Äôt see what's going on on the monitor. <br><br>  It is worth adding that it is not possible to disable one of the cluster nodes separately or to decommission some of its elements using VTM.  To do this, in the case of vSphere, deploy an appliance on the cluster itself (ftSys virtual machine), and install a software package using Windows or Linux.  Moreover, for Windows, a software module is a GUI application (ftSMC), and for Linux it works only in command line mode and almost completely duplicates the appliance functionality for vSphere.  It is important to note that the installation of these software packages (OS module, appliance) is mandatory, since they are also responsible for the initial configuration of the OS or hypervisor to work on the cluster hardware, as well as working out a failover.  That is, if you do not install and configure these modules, at the right time the cluster simply does not work out the emergency switching. <br><br>  We were interested in a bunch of Stratus FT and vSphere, so the discussion below will deal specifically with appliance.  FtSys itself consists of two parts: a web interface from which you can monitor the status of the entire cluster and any of its components, as well as the command line that allows you to manage the cluster. <br><br>  FtSys home page: <br><img src="https://habrastorage.org/files/dc0/063/bc6/dc0063bc666d4912a119c2ac983fc681.png"><br><br>  The ftSys Web Console provides access to view settings and status of remote monitoring (Stratus ActiveService Network, ASN), VTM, virtual switches, disk subsystem status and System Management logs (they contain failover logs and further synchronization). <br><br>  Check the status of the cluster components: <br><br><img src="https://habrastorage.org/files/18e/a63/5e3/18ea635e3d0c4e41b43f5ee7d3cbee29.png"><br><br>  Open CPU Enclosure 0: <br><br><img src="https://habrastorage.org/files/4d0/330/60b/4d033060b10a452ca2508b8198bf0691.png"><br><br>  Cluster components can be in one of the states: <br><ul><li>  ONLINE - the component is synchronized and is in operation (refers to the CPU and RAM). </li><li>  DUPLEX - the component is synchronized and is in fault tolerant mode. </li><li>  SIMPLEX - cluster component is not synchronized, or is being diagnosed. </li><li>  BROKEN - the component is faulty and did not pass the diagnostics.  It is important to note that in the case of network cards BROKEN says that the network cable is not connected. </li><li>  SHOT - node component diagnosed as faulty and electrically isolated by the system. </li></ul><br>  Since we started talking about CPU Enclosure 0, we‚Äôll explain why it‚Äôs 0, and not some other number.  In the Stratus naming system, each component has a path, and for those that are in the first node, there will always be 0 at the beginning of the path, and for those in the second - 1. This is done for the convenience of working with the cluster.  For example, to view information about the component itself through the console: <br><br><img src="https://habrastorage.org/files/0c4/cb1/e52/0c4cb1e5259b4877a603004559829d15.png"><br><br>  To distinguish between CPU and IO Enclosure, the latter has a number 1 added at the beginning, so the IO of the module from the first node will have 10 path, and for the same module from the second node - 11. <br><br>  Connecting via SSH to ftSys allows you to diagnose the server, including collecting logs, viewing detailed reports on components, as well as disabling components and modules as a whole. <br><br><h4>  Support and warranty </h4><br>  Consider cluster support with a description of the replaced components.  Elements are divided into CRU (Customer Replaceable Unit) groups: <br><table><tbody><tr><td colspan="2"><br>  <strong>CRU</strong> <br></td></tr><tr><td><br>  Decorative panel <br></td><td><br>  Expander module management <br></td></tr><tr><td><br>  Compute node <br></td><td><br>  PCIe adapter <br></td></tr><tr><td><br>  Memory <br></td><td><br>  PCIe riser <br></td></tr><tr><td><br>  DVD drive <br></td><td><br>  PDU <br></td></tr><tr><td><br>  HDD <br></td><td><br>  Backplein <br></td></tr></tbody></table><br>  This means that if your CPU or cooling module fails, the cluster node will come to you as an assembly, and you will need to rearrange all the other elements (DIMM, HBA and PCIe riser) from the list above. <br><br>  The cluster itself is covered by one of four support programs (FtService): Total Assurance, System Assurance, Extended Platform Support and Platform Support.  The table with the main indicators: <br><br><table><tbody><tr><td><br>  <strong>Ftservice</strong> <br></td><td><br>  <strong>Total assurance</strong> <br></td><td><br>  <strong>System assurance</strong> <br></td><td><br>  <strong>Extended Platform Support</strong> <br></td><td><br>  <strong>Platform Support</strong> <br></td></tr><tr><td><br>  Sending parts to the customer <br></td><td><br>  NBD (Next Business Day) <br></td><td><br>  NBD (Next Business Day) <br></td><td><br>  NBD (Next Business Day) <br></td><td><br>  NBD (Next Business Day) <br></td></tr><tr><td><br>  Critical response time <br></td><td><br>  &lt;30 minutes <br>  24/7/365 <br></td><td><br>  &lt;60 minutes 24/7/365 <br></td><td><br>  &lt;2 hours 24/7/365 <br></td><td><br>  &lt;2 hours 9/5/365 <br></td></tr><tr><td><br>  First Response Time <br></td><td><br>  24/7/365 <br></td><td><br>  24/7/365 <br></td><td><br>  24/7/365 <br></td><td><br>  24/7/365 <br></td></tr><tr><td><br>  Proactive Monitoring (ASN) <br></td><td><br>  24/7/365 <br></td><td><br>  24/7/365 <br></td><td><br>  24/7/365 <br></td><td><br>  24/7/365 <br></td></tr><tr><td><br>  Access to Accessibility Engineer <br></td><td><br>  24/7/365 <br></td><td><br>  24/7/365 <br></td><td><br>  Not <br></td><td><br>  Not <br></td></tr><tr><td><br>  Search for the cause of the problem at the software level <br></td><td><br>  Yes <br></td><td><br>  Yes <br></td><td><br>  Not <br></td><td><br>  Not <br></td></tr><tr><td><br>  Identifying the root cause of the problem <br></td><td><br>  Yes <br></td><td><br>  Yes <br></td><td><br>  Not <br></td><td><br>  Not <br></td></tr><tr><td><br>  Check out <br></td><td><br>  Yes <br></td><td><br>  Yes <br></td><td><br>  Not <br></td><td><br>  Not <br></td></tr><tr><td><br>  Awarding high priority application <br></td><td><br>  Yes <br></td><td><br>  Yes <br></td><td><br>  Not <br></td><td><br>  Not <br></td></tr><tr><td><br>  Full OS support, including patches and updates <br></td><td><br>  Yes <br></td><td><br>  Not <br></td><td><br>  Not <br></td><td><br>  Not <br></td></tr><tr><td><br>  Collaboration with vendor <br></td><td><br>  Yes <br></td><td><br>  Not <br></td><td><br>  Not <br></td><td><br>  Not <br></td></tr><tr><td><br>  Guaranteed work without downtime <br></td><td><br>  Yes <br></td><td><br>  Not <br></td><td><br>  Not <br></td><td><br>  Not <br></td></tr></tbody></table><br><br>  The standard warranty for the cluster is 1 year Platform Support, which involves only sending parts with analysis of the cause of the problem solely from the logs of the cluster itself.  This means that if the reason lies somewhere in the OS, then they will not help you.  You will have to either increase the level of support, or agree to paid assistance. <br><br>  Certain difficulties may arise and if you want to update or reinstall the software for the cluster, it is not freely available.  You need to ask the vendor or be content with what came along with the hardware itself on the disk. <br><br>  The situation with the documentation is quite different - it is detailed and well written.  It is freely available both in the form of an electronic journal and in the form of a pdf. <br><br>  Although Stratus is not widely known in Russia, it is quite common in certain areas, for example, in oil and gas.  The company has its own spare parts warehouse located in Moscow, where CRUs prepared for shipment are waiting in the wings.  Of course, in the case of our vast country, it will take some time to deliver parts (especially if you live in Vladivostok), but this is still better than if parts came from Europe. <br><br><h4>  Hurray, tests! </h4><br>  Stratus cluster was connected via SAN (FC 8 Gb) to storage system (Hitachi AMS 2300).  After that, on the cluster, we deployed a virtual machine on VMware ESXi 6 Update 1b running under Windows 2012 R2 and installed the Oracle DB 12c database. <br><br><img src="https://habrastorage.org/files/7fc/1c1/252/7fc1c1252b734feb8fc36c5ff68cffd5.png"><br>  <i>Test stand</i> <br><br>  <b>Testing was conducted in two stages:</b> <br><ol><li>  Assessment of failover and failback with high utilization of computing resources.  Characteristics of the used virtual machine: 40 vCPU, 500 GB vRAM. </li><li>  Compare Stratus FT with VMware FT.  Characteristics of the used virtual machine: 4 vCPU, 16 GB vRAM. </li></ol><br>  The differences in the characteristics of the VM for the 1st and 2nd stages are associated with the limitation of VMware FT in 4 vCPU. <br><br>  For testing, we used a set of benchmarks Swingbench.  Sales History was selected from the list of available tests.  This test creates its own database (the selected size is 8 GB) and allows you to generate queries (known to be specified) to it with a certain frequency. <br><br>  Requests are different types of uploads, such as sales reports for a month, week, etc.  Benchmark settings (changes made to the finished model are described): <br><ul><li>  Number of Users: 450 (instead of the standard 16).  The number of users has been increased for a full (close to 95% peak) load on the VM. </li><li>  Test duration: 1.5 hours.  Enough time to check the reliability of the platform as a whole, as well as to reach a normal average value of performance indicators. </li></ul><br>  For the study we have chosen the following method: <br>  1. Run tests.  Evaluation of cluster performance, determination of average values ‚Äã‚Äã(after 15 minutes of operation): <br><ul><li>  Transactions-per-Minute (TPM, number of transactions per minute); </li><li>  Transactions-per-Second (TPS, the number of transactions per second); </li><li>  Response Time (RT, db query processing time). </li></ul><br>  2. Disable Primary Cluster Node; <br>  3. Putting the cluster node into operation (30 minutes after disconnection); <br>  4. Waiting for full synchronization of both nodes and getting the DUPLEX status for all components. <br>  Stage I. Assessment of failover and synchronization with high utilization of computing resources. <br>  1. Average performance: <br><ul><li>  Transactions-per-Minute, TPM: 542; </li><li>  Transactions-per-Second, TPS: 9; </li><li>  Response Time (db query processing time): 29335 ms. </li></ul><br>  2. Disable Primary Cluster Node: <br><br>  06/06-07: 57: 10.101 INF t25 CpuBoard [0] DUPLEX / SECONDARY -&gt; SIMPLEX / PRIMARY <br><br>  This line in ftSys logs is a node extraction marker.  After that, one ICMP Echo Request (Figure 17) was lost to the virtual machine, and then the cluster continued to work in normal mode. <br><br><img src="https://habrastorage.org/files/5ba/2c5/d1e/5ba2c5d1eda1404cbe2d872a9a375f3a.png"><br>  <i>Primary cluster extraction results.</i>  <i>There was no effect on the disk subsystem, the average read latency remained within the reference</i> <br><br><img src="https://habrastorage.org/files/f9f/92e/b98/f9f92eb98b5d41039f02c189fe75a1f1.png"><br><br><img src="https://habrastorage.org/files/a2e/dea/95c/a2edea95cc7148eca045e8197a91c764.png"><br>  <i>Primary Cluster Node Extraction Results</i> <br><br>  3. Putting the cluster node into operation: <br><br>  Excerpt from ftSys logs: <br><blockquote>  06/06-08: 25: 32.061 INF t102 CIM Indication received for: ftmod 16 41 <br>  06/06-08: 25: 32.065 INF t102 Ftmod - indicationArrived.  Index = 125, OSM index = 124 <br>  06/06-08: 25: 32.142 INF t102 Fosil event on bmc [10/120] <br>  06/06-08: 25: 32.145 INF t25 Bmc [10/120] SIMPLEX / PRIMARY -&gt; DUPLEX / PRIMARY </blockquote><br>  Note that the new cluster node (for replacement) comes without firmware, and during initialization, microcodes and configuration with the remaining in operation are poured into the chassis. <br><br>  4. Waiting for full synchronization of both nodes and getting the DUPLEX status for all components: <br><br>  Within 20 minutes after the cluster node is put into operation, the equipment is diagnosed and synchronized in the following order (with layering, that is, a number of parallel operations can occur): <br>  i.  BMC (VTM); <br>  ii.  IO Slots (PCIe); <br>  iii.  HDD and SSD; <br>  iv.  RAM and CPU. <br><br>  i.  BMC (VTM).  BMC synchronization in our case was a little faster, since the firmware and configuration were already on the extracted node. <br>  Excerpt from ftSys logs: <br><blockquote>  06/06-08: 25: 32.145 INF t25 Bmc [10/120] SIMPLEX / PRIMARY -&gt; DUPLEX / PRIMARY <br>  06 / 06-08: 26: 44.107 INF t25 Bmc [11/120] EMPTY / NONE -&gt; DUPLEX / SECONDAR <br>  06 / 06-08: 26: 44.259 INF t25 BMC flags, Needed = 00, Changed = 00 <br>  06 / 06-08: 26: 44.259 INF t25 Check if it‚Äôs possible to save for CFG conflict, saveRestoreCompleted: true </blockquote><br>  From the logs, it is clear that first VTM, which after failover, became PRIMARY, and only after a minute did SECONDARY VTM receive the same status in DUPLEX. <br><br>  ii.  IO Slots (PCIe).  During PCIe synchronization, first determine the type of riser (Make) and only then alternately read each of the IO slots. <br>  Excerpt from ftSys logs: <br><blockquote>  06/06-08: 27: 47.119 INF t25 Make Riser for IoBoard [11]: 2x PCI-E2 (x8) <br>  06/06-08: 27: 47.122 INF t25 Make IoSlots for IoBoard [11] <br>  06/06-08: 27: 47.238 INF t25 IoSlot [11/1] UNKNOWN / NONE -&gt; EMPTY / NONE <br>  06/06-08: 27: 47.239 INF t25 IoSlot [11/1] removing PCI, was 0000: 43: 00 <br>  06/06-08: 27: 47.245 INF t25 IoSlot [11/2] UNKNOWN / NONE -&gt; EMPTY / NONE <br>  06/06-08: 27: 47.245 INF t25 IoSlot [11/2] removing PCI, was 0000: 55: 00 <br>  06/06-08: 27: 47.252 INF t25 IoSlot [11/3] UNKNOWN / NONE -&gt; INITIALIZING / NONE <br>  06/06-08: 27: 47.256 INF t25 IoSlot [11/4] UNKNOWN / NONE -&gt; EMPTY / NONE <br>  06/06-08: 27: 47.256 INF t25 IoSlot [11/4] removing PCI, was 0000: c7: 00 <br>  06/06-08: 27: 47.262 INF t25 IoSlot [11/5] UNKNOWN / NONE -&gt; INITIALIZING / NONE </blockquote><br>  And the first NICs are raised and they are added to ESXi: <br><blockquote>  06/06-08: 27: 48.705 INF t191 NetworkIfc (vmnic_110601) UNKNOWN / NONE -&gt; ONLINE / NONE <br>  06/06-08: 27: 48.709 INF t191 NetworkIfc (vmnic_110600) UNKNOWN / NONE -&gt; ONLINE / NONE <br>  06/06-08: 27: 48.712 INF t191 BondedIfc (vSwitch0) connecting slave vmnic_110600 <br>  06/06-08: 27: 48.716 INF t191 BondedIfc (vSwitch0.Management_Network) connecting slave vmnic_110600 </blockquote><br><br>  At this point, the response time for the ICMP Echo request increases slightly: <br><img src="https://habrastorage.org/files/176/920/000/17692000048b4125b290f324134a84b2.png"><br>  <i>Synchronize nodes.</i>  <i>Add NIC.</i> <br><br>  iii.  HDD and SSD.  After the NICs are up, the reading of the data on the disks and their subsequent synchronization begins: <br><blockquote>  06 / 06-08: 28: 31.432 NOT t12 Storage Plugin: INFORMATION - 11/40/1 is now STATE_ONLINE / REASON_NONE <br>  06/06-08: 28: 31.433 INF t12 Auto bringup Disk [11/40/1] based on MTBF <br>  06 / 06-08: 28: 31.963 NOT t12 Storage Plugin: non-blank disk 11/40/1 discovered (safe mode) <br>  06/06-08: 28: 31.964 INF t13 Storage: query superblock: vmhba1: C0: T1: L0 <br>  06 / 06-08: 28: 31.964 NOT t12 Storage Plugin: INFORMATION - 11/40/2 is now STATE_ONLINE / REASON_NONE <br>  06 / 06-08: 28: 31.965 INF t12 Auto bringup Disk [11/40/2] based on MTBF <br>  06 / 06-08: 28: 32.488 NOT t12 Storage Plugin: non-blank disk 11/40/2 discovered (safe mode) <br>  06/06-08: 28: 32.488 NOT t12 Storage Plugin: INFORMATION - 11/40/3 is now STATE_ONLINE / REASON_NONE <br>  06/06-08: 28: 32.489 INF t12 Auto bringup Disk [11/40/3] based on MTBF <br>  06 / 06-08: 28: 32.964 NOT t12 Storage Plugin: non-blank disk 11/40/3 discovered (safe mode) <br>  06/06-08: 28: 32.964 NOT t12 Storage Plugin: INFORMATION - 11/40/4 is now STATE_ONLINE / REASON_NONE <br>  06/06-08: 28: 32.965 INF t12 Auto bringup Disk [11/40/4] based on MTBF </blockquote><br>  Next, ftSys determines the boot disk and proceeds to synchronize it: <br><br><blockquote>  06/06-08: 28: 40.360 INF t102 == 11/40/1 is a boot disk <br>  06/06-08: 28: 40.360 INF t102 CIM Indication received for: FTSYS_Storage <br>  06/06-08: 28: 40.367 NOT t12 Storage Plugin: INFORMATION - 11/40/1 is now STATE_SYNCING / REASON_NONE </blockquote><br><br>  The RAID controller (10/5, 11/5) and FC HBA (10/3, 11/3) for both nodes are raised last: <br><br><blockquote>  06/06-08: 30: 47.421 INF t25 IoSlot [11/3] ONLINE / NONE -&gt; DUPLEX / NONE <br>  06/06-08: 30: 47.426 INF t25 IoSlot [11/5] ONLINE / NONE -&gt; DUPLEX / NONE <br>  06 / 06-08: 30: 56.144 INF t25 IoSlot [10/5] SIMPLEX / NONE -&gt; DUPLEX / NONE <br>  06 / 06-08: 30: 56.151 INF t25 IoSlot [10/3] SIMPLEX / NONE -&gt; DUPLEX / NONE </blockquote><br><br>  iv.  RAM and CPU.  Turning on the CPU Enclosure closes the synchronization of the cluster nodes: <br><br><blockquote>  06/06-08: 28: 46.409 INF t25 CpuBoard [1] REMOVED_FROM_SERVICE / OK_FOR_BRINGUP -&gt; DIAGNOSTICS / NONE </blockquote><br><br>  After 2 minutes, the CPU transition from the DIAGNOSTICS status to the INITIALIZING status occurred and the firmware reading from the failed cluster node began: <br><br><blockquote>  06 / 06-08: 31: 21.105 INF t102 Fosil event on cpu [1] <br>  06/06-08: 31: 21.105 INF t25 CpuBoard [1] DIAGNOSTICS / NONE -&gt; INITIALIZING / NONE <br>  06 / 06-08: 31: 26.105 INF t25 Read IDPROM / board data for CpuBoard [1] <br>  06/06-08: 32: 02.048 INF t102 CIM Indication received for: ftmod <br>  06 / 06-08: 32: 02.053 INF t102 Ftmod - indicationArrived.  Index = 153, OSM index = 152 <br>  06/06-08: 32: 02.112 INF t102 Fosil event on cpu [1] </blockquote><br><br>  During RAM and CPU synchronization, performance dropped to 20% or 125 TPM, and in the period from 8:31:50 to 8:32:15 (25 seconds) TPS was zero. <br><br>  It is also worth paying attention to Response Time, in this period of time its figure reached an absolute maximum of 313686 ms and lasted 3 s. <br><br>  Synchronization ended 08: 37: 29.351, although according to the chart below, the drawdown was completed at 08:33:35. <br><br><blockquote>  06/06-08: 32: 04.280 INF t25 CpuBoard [1] INITIALIZING / NONE -&gt; DUPLEX / SECONDARY <br>  06 / 06-08: 34: 29.351 INF t25 Bringup Complete event, restoring bring up policy. <br>  06 / 06-08: 37: 29.351 INF t25 BringupPolicy: enableCPU bringup </blockquote><br><br>  It can be concluded that the synchronization of cluster nodes after failover does not greatly affect the performance of the cluster until the synchronization of CPU and RAM, the latter squander the main indicators of the cluster.  It is important to note that in this case the processors were utilized by 75% and RAM by 52%. <br><br><img src="https://habrastorage.org/files/d0a/976/43c/d0a97643c55c421ba2e7da22c5b3594b.png"><br>  <i>Initialization of CPU Enclosure.</i>  <i>Performance impact</i> <br><br>  <b>Stage II.</b>  <b>Comparing Stratus FT with VMware FT</b> <br>  To carry out stage II, the virtual machine from stage I was cloned into a HA cluster of four Cisco UCS B200 M3 blade servers (CPU: Intel Xeon E5-2650, 2.0GHz; RAM: 128 GB DDR3) running ESXi 6 Update 2. Servers also were connected via SAN (8 Gb) to storage systems (Hitachi AMS 2300). <br>  The average performance without VMware FT (compare the performance of VMware and Stratus (Stage I) does not make sense because of the limitations on the number of vCPUs and the type of CPUs themselves (differ in family and clock frequency): <br>  - Transactions-per-Minute, TPM: 190; <br>  - Transactions-per-Second, TPS: 3; <br>  - Response Time (db query processing time): 2902 ms. <br>  Before you turn on FT, let's designate its main features: <br>  - A maximum of 4th vCPU and 64 GB Ram per VM are available; <br>  - On a single host, a maximum of 8 vCPUs can be used in FT mode; <br>  - Requires a dedicated 10 GB vNIC to synchronize cluster nodes; <br>  - Requires shared storage; <br>  Synchronization occurs at the level of virtual machines (Primary and Secondary), vCenter is the arbiter. <br>  Average performance with VMware FT: <br>  - Transactions-per-Minute, TPM: 160; <br>  - Transactions-per-Second, TPS: 2; <br>  - Response Time (db query processing time): 3652 ms. <br>  It can be concluded that we are losing 16% of the overall cluster performance, especially FT significantly affects Response Time. <br><br><img src="https://habrastorage.org/files/05e/861/b3f/05e861b3f3224bdfaade6e55d1a18e1f.png"><br>  <i>VMware average performance</i> <br><br><img src="https://habrastorage.org/files/1b1/2ff/3f2/1b12ff3f21ce44fbac92b2274f8e34d4.png"><br>  <i>VMware FT average performance</i> <br><br>  We estimate the impact of failover and recovery of the FT cluster on VM performance in the case of VMware FT and Stratus ftServer. <br><br>  <b>VMware FT</b> <br>  When failover is developed, VM performance increases from 160 to 190 TPM, since at this time the replication mechanism does not work. <br><br>  After the switch is completed, a new Secondary VM is raised by the Storage vMotion forces and a mechanism is enabled that allows the machines to operate synchronously - vLockstep.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that after the return of the FT cluster to its normal state, the TPM indicator sank to 140 and back to the average value of 160 never returned. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The average time for synchronization and the transition from standing ‚Äústarting‚Äù to ‚Äúprotected‚Äù is on average 10 minutes. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stratus ftServer</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The synchronization loss was 42% of the initial performance or 143 TPM with an average of 241 (Figure 26). As in the previous case, at the initial moment of replication of the CPU Enclosure, the TPS indicator dropped to 0. The </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">average time for synchronization and the transition from the SIMPLEX state to DUPLEX for the components of both cluster nodes is on average 2 minutes.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The differences between Stratus and VMware solutions are due to the fact that Stratus ftServer was originally developed as an FT cluster, so we have no significant limitations on CPU, memory or the need for shared storage (using only the internal disk subsystem of nodes). VMware FT is only an additional option that until the 6th version of the vSphere arrived in isolation due to the limitation of one vCPU and was unclaimed on the market. </font></font><br><br><img src="https://habrastorage.org/files/643/89c/11b/64389c11bcfa48b6ad3e7bf500a0d20e.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vmware FT. Performance gains in the failover </font></font></i> <br><br><img src="https://habrastorage.org/files/ce9/b32/1b4/ce9b321b4aba4b01a2ec36a772b7fb55.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vmware FT </font></font></i> <font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">process </font></i><i><font style="vertical-align: inherit;">. Performance drop after restoring FT </font></i></font><br><br><img src="https://habrastorage.org/files/1dd/69c/41a/1dd69c41a31c4652a8ddf3492392cda6.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stratus ftServer. Solution performance with failover and after node synchronization is complete</font></font></i> <br><br><h4>  findings </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ftServer is distinguished by a well-developed architecture that provides a full-mesh connection between the modules of the cluster nodes, which leads to an increase in the already high level of protection from the failure of any component. The solution is not limited to software, supports the latest versions of Windows and Linux, as well as vSphere and Hyper-V virtualization. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The situation is excellent with the documentation - detailed and well written. In addition, it is worth noting the presence of Russian-speaking support and a warehouse in Moscow, which guarantees timely assistance. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is worth noting the small time for synchronization (after replacing the node) of the processor modules (during which there is a significant decrease in performance) and almost imperceptible replication of IO modules.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Given all the above, we note that Stratus has turned out an excellent cluster solution, and the declared availability of 99,999 really has a solid foundation. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where is applied</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In world and Russian practice such systems are used:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For automation of continuous and discrete production processes and in energy accounting systems (APCS / SCADA and AMR). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For MES - control systems and accounting of administrative and economic activities of enterprises. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Naturally, in finance. </font><font style="vertical-align: inherit;">This is Processing / ERP, exchange gateways. </font><font style="vertical-align: inherit;">As a rule, this is bank processing or Oracle.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Like VoIP gateways, softphones, call centers, billing, where a minute of downtime can mean with a thousand lost clients. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Remote computing nodes that are difficult to access for maintenance, usually without personnel, are the very same ‚Äúspace‚Äù. </font></font></li></ul><br><br>  <b>License</b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another important point. </font><font style="vertical-align: inherit;">Management is done as a single server, licensing is also like a single server (this is very important for banking licenses for DBMS).</font></font><br><br><h4>  References: </h4><br><ul><li> <a href="http://stratadoc.stratus.com/vmware/6.0.2.0/desc/pegsyst.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vendor documentation</font></font></a> </li><li>  <a href="http://www.stratus.com/kr/solutions/platforms/ftserver/ftserver-architecture/">Architecture</a> </li><li> <a href="http://www.stratus.com/resources/%3Fresource-type%3Dcase-study"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cases and application</font></font></a> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> My mail: GMogilev@croc.ru </font></font></li></ul></div><p>Source: <a href="https://habr.com/ru/post/307086/">https://habr.com/ru/post/307086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307074/index.html">Yandex.Maps (as well as Google Maps, etc.), when will you start using mesh networks?</a></li>
<li><a href="../307076/index.html">Digest of grocery design, July 2016</a></li>
<li><a href="../307078/index.html">Kaggle - our excursion to the kingdom of overfit</a></li>
<li><a href="../307082/index.html">X86 Economy with new Oracle SPARC S7 servers</a></li>
<li><a href="../307084/index.html">Why, oh why, these #? @! assholes use vi?</a></li>
<li><a href="../307088/index.html">Interception of functions .NET / CLR</a></li>
<li><a href="../307090/index.html">State machines in the SimInTech dynamic simulation environment</a></li>
<li><a href="../307092/index.html">Variant of working with the cache without access to the backend using the example of Yii2</a></li>
<li><a href="../307094/index.html">Another way to load CSS via RequireJS</a></li>
<li><a href="../307096/index.html">Why use RxJava in Android - a brief introduction to RxJava</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>