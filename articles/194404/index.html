<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of IM for the competition of Pavel Durov using Xamarin</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 As many probably know, Pavel Durov is developing a new clone of the What's App and other popular instant messengers based on his own prot...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of IM for the competition of Pavel Durov using Xamarin</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/d93/884/903/d93884903fc7e7df883069ba46dfe283.png" alt="image" align="right"><br>  Good day. <br><br>  As many probably know, Pavel Durov is developing a new clone of the What's App and other popular instant messengers based on his own protocol MTProto. <br><br>  Recently, the American company released an iOS client for this protocol called Telegram.  In parallel with this, a <a href="http://vk.com/androidchallenge">competition</a> is <a href="http://vk.com/androidchallenge">held to develop an Android client</a> . <br>  Recently, the second stage was completed, the people sent their crafts and myself.  I will say right away that I did not pass the second stage. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unlike many participants, for development I used the language C # and Xamarin about what I want to tell more in detail below, since on Xamarin in the runet of information we will say just a little. <br><br><a name="habracut"></a><br><h4>  Instead of entry </h4><br>  I'm a doughter.  I work with dotnet from the second version, when I was still a student, I know well the features and features of this platform.  Not so long ago, I wanted to develop on mobile devices, the query "Android C #" and brought me to Xamarin - MonoDroid.  But so far I have only written with him, it was the first serious project on Android, and I want to tell about it.  Understanding this article requires knowledge of C #, .NET, and at least a primitive understanding of Android. <br><br><h5>  What is it - in a nutshell </h5><br>  Xamarin is a company (as well as a mobile platform) created by Nat Friedman and <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BA%25D0%25B0%25D1%2581%25D0%25B0,_%25D0%259C%25D0%25B8%25D0%25B3%25D0%25B5%25D0%25BB%25D1%258C_%25D0%25B4%25D0%25B5">Miguel de Icaza</a> , the author of GNOME and Mono.  So Xamarin is a logical development for Mono. <br>  <b>Xamarin allows you to write native applications for Anroid and iOS in C #</b> and that's fine.  I personally believe that there is a future for a hybrid cross-platform.  And Mac.  And actively <a href="http://xamarin.uservoice.com/forums/144858-xamarin-suggestions/suggestions/2617326-monoblackberry">vote for MonoBerry</a> , which may sometime be included in the Xamarin. <br><br><h4>  Task </h4><br>  In the tasks of the competition was the implementation of the provided protocol MTProto (first stage) and the creation of a full-fledged application (second stage).  At the third stage, refinement. <br><br>  The protocol as a whole is an RPC implementation with all sorts of buns like advanced encryption and all sorts of different things. <br><br><h4>  Decision </h4><br>  Hereinafter I will tell you how I solved these problems.  So let's get started. <br><br><h5>  Getting Xamarin </h5><br>  Xamarin costs $ 2000.  Yes it is.  If you want to write in your favorite studio, its price is $ 999 per platform.  If you have enough of a good environment MonoDevelop - its cost is $ 299 for the platform.  In correspondence with the authors, I was able to beg for a discount of up to $ 799 for the platform. <br>  How can you get xamarin?  Well, for starters, you can <s>download it from torrents</s> .  Xamarin offers an academic license for $ 99 for a platform that gives all Business opportunities except mail support.  And yes, if your wife is a graduate student this also works. <br><br><h5>  Creating solution structure </h5><br>  As I mentioned, Xamarin creates native code for each mobile OS.  This means that each OS will have its own build, but the code between them should be divided.  The creators of Xamarin offer as many as <a href="http://docs.xamarin.com/guides/cross-platform/application_fundamentals/building_cross_platform_applications/sharing_code_options">three ways</a> to do this, but for Visual Studio the simplest is the excellent Project Linker utility, which is built into the environment itself. <br>  A couple of mouse clicks and a cross-platform solution is ready: <br><br><img src="https://habrastorage.org/storage3/257/a2a/6c6/257a2a6c698d7c9ebb6dd6bcb69da47d.png"><br><br>  All files are connected as links, any changes in the main project will be displayed in all associated projects. <br><br><table><tbody><tr><td><img src="https://habrastorage.org/storage3/1b3/9eb/b84/1b39ebb84af4de67dd0d6ab628b425ce.png"></td><td><img src="https://habrastorage.org/storage3/507/11d/9e7/50711d9e743c94f617f868161c9054f5.png"></td></tr></tbody></table><br><br>  The utility is placed from the "Extension Manager" studio. <br><br><h6>  Solution structure </h6><br>  The main assemblies are <i>MTProto.Core</i> and <i>Talks.Backend</i> .  These are common builds under .net 4.5 and covered with Unit tests. <br>  <i>Mono.Stub</i> is a few specific classes from Mono, in particular, I use BigInteger from there. <br>  Folder <b>Droid</b> - contains Androdov clones of projects, Dataflow is the TPL.Dataflow source code from github.  I actively use in my project asynchronous capabilities C # 5.0. <br>  In the Platfrom folder are specific implementations for each platform.  So far this is only Android. <br><br><h5>  MTProto.Core </h5><br>  This is the implementation of the protocol.  The protocol as a whole is RPC with advanced encryption and some additional features, such as forming a container or sending / receiving files in slices.  Thus, to implement the IM client, we need to learn how to perform an RPC request, receive a response, and also process incoming system messages and status updates. <br><br>  Of the features: async all the way and Dataflow. <br><br><h6>  <b>async all the way</b> </h6><br>  C # 5.0 has introduced a couple of keywords that extremely simplify the development of asynchronous code based on Task Asynchronous Pattern (TAP).  They are very well described in <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh191443.aspx">MSDN</a> . <br>  All IO operations should be asynchronous, it should be as a commandment. <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _cl.LoadSettings().ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _cl.CheckAndGenerateAuth().ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _cl.RunAsync().ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((_cl.Settings.DataCenters == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) || (_cl.Settings.DataCenters.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _cl.GetConfig().ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); } _db = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> TalksDatabase.GetDatabase().ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); _ldm = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LocalDataManager(_db); _cl.ProcessUpdateAsync = ProcessUpdateAsync; }</code> </pre> <br><br>  Stephen Cleary, one of the leading experts in asynchronous programming in C #, wrote several <a href="http://msdn.microsoft.com/ru-ru/magazine/jj991977.aspx">principles for using async-await,</a> which have already become de facto standards for its use.  If you have not read, I advise. <br><br>  The essence of the ‚Äúasync all the way‚Äù approach is that all methods on the call tree are asynchronous from event to directly IO operation (in this case). <br><br>  For example, if you need to asynchronously process a click on a button: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">button_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { _button.Enabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _presenter.SendMessage(); }</code> </pre><br><br>  Then you make asynchronous all methods on the call tree in Presenter: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SendMessageToUser(); }</code> </pre><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMessageToUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _imv.AddMineMessage(msg); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> msgText = _imv.PendingMessage; _imv.PendingMessage = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-comment"><span class="hljs-comment">// messages.sendMessage#4cde0aab peer:InputPeer message:string random_id:long = messages.SentMessage; var result = await _model.PerformRpcCall("messages.sendMessage", InputPeerFactory.CreatePeer(_model, PeerType.inputPeerContact, _imv.ChatId), msgText, LongRandom(r)); if (result.Success) { // messages.sentMessage#d1f4d35c id:int date:int pts:int seq:int = messages.SentMessage; msg.Id = result.Answer.ExtractValue&lt;int&gt;("id"); ... msg.State = BL.Messages.MessageState.Sent; _imv.IvalidateList(); await _model.ProcessSentMessage(result.Answer, _imv.ChatId, msg); return true; } else { msg.State = BL.Messages.MessageState.Failed; _imv.SendSmallMessage("Problem sending message: " + result.Error.ToString()); return false; } } catch (Exception ex) { ... } }</span></span></code> </pre><br><br>  And in the Core: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Task&lt;RpcAnswer&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PerformRpcCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> combinatorName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] pars</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _cl.PerformRpcCall(combinatorName, pars); }</code> </pre><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;RpcAnswer&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PerformRpcCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> combinatorName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] pars</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> confirm = CreateConfirm(); <span class="hljs-comment"><span class="hljs-comment">//    WriteOnceBlock&lt;RpcAnswer&gt; answer = new WriteOnceBlock&lt;RpcAnswer&gt;(e =&gt; e); IOutputCombinator oc; if (confirm != null) { var cntrn = new MsgContainer(); cntrn.Add(rpccall); //   RPC Call    cntrn.Add(confirm); cntrn.Combinator = _tlc.Decompose(0x73f1f8dc); //     oc = new OutputMsgContainer(uniqueId, cntrn); } else //    { oc = new OutputTLCombinatorInstance(uniqueId, rpccall); } var uhoo = await SendRpcCallAsync(oc).ConfigureAwait(false); _inputAnswersBuffer.LinkTo(answer, new DataflowLinkOptions { MaxMessages = 1 }, i =&gt; i.SessionId == _em.SessionId); return await answer.ReceiveAsync(TimeSpan.FromSeconds(60)).ConfigureAwait(false); //       } catch (Exception ex) { ... } }</span></span></code> </pre><br></div></div><br><br>  As you can see, not all methods are marked with keywords async-await.  The general practice is this: if you do not need to do anything <b>after</b> an asynchronous call and if you have <b>one</b> asynchronous call, then it makes sense to simply return it as a Task from the method. <br>  Another practice (also described in the Cleary article) is that asynchronous methods inside libraries should not capture the context and attempt to return to it after execution.  Those.  all asynchronous calls must contain <code>.ConfigureAwait(false)</code> done to prevent deadlocks.  Read more about this in the article above. <br><br><h6>  <b>Dataflow</b> </h6><br>  TPL.Dataflow is a library designed to implement a Data Flow design pattern or processing pipeline.  The source code of the library is available on <a href="">github,</a> which allows using it on mobile devices.  Those wishing to learn more about the capabilities of this library send to <a href="http://msdn.microsoft.com/en-us/library/hh228603.aspx">MSDN</a> . <br><br>  In a nutshell, the library allows you to build a pipeline consisting of blocks for storing or processing data, linking them according to some condition.  Initially, in my project there were two such conveyors: for the input and for the output packages.  After refactoring, I decided to leave only one for incoming packets. <br><br>  It looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aed/b79/e30/aedb79e30cbb1c336adf095678a91889.png" alt="image"><br>  and the creation process looks like this: <br><pre> <code class="cs hljs">BufferBlock&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt; _inputBufferBytes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferBlock&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt;(); BufferBlock&lt;InputTLCombinatorInstance&gt; _inputBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferBlock&lt;InputTLCombinatorInstance&gt;(); ActionBlock&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt; _inputBufferParcer; ActionBlock&lt;TLCombinatorInstance&gt; _inputUpdates; ActionBlock&lt;TLCombinatorInstance&gt; _inputSystemMessages; TransformBlock&lt;InputTLCombinatorInstance, RpcAnswer&gt; _inputAnswers; BufferBlock&lt;RpcAnswer&gt; _inputAnswersBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferBlock&lt;RpcAnswer&gt;(); BufferBlock&lt;RpcAnswer&gt; _inputRejectedBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferBlock&lt;RpcAnswer&gt;(); BufferBlock&lt;InputTLCombinatorInstance&gt; _inputUnsorted = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferBlock&lt;InputTLCombinatorInstance&gt;(); <span class="hljs-comment"><span class="hljs-comment">// -- //   _inputBufferParcer = new ActionBlock&lt;byte[]&gt;(bytes =&gt; ProcessInputBuffer(bytes)); _inputSystemMessages = new ActionBlock&lt;TLCombinatorInstance&gt;(tlci =&gt; ProcessSystemMessage(tlci)); _inputUpdates = new ActionBlock&lt;TLCombinatorInstance&gt;(tlci =&gt; ProcessUpdateAsync(tlci)); _inputAnswers = new TransformBlock&lt;InputTLCombinatorInstance, RpcAnswer&gt;(tlci =&gt; ProcessRpcAnswer(tlci)); // from [_inputBufferBytes] to [_inputBufferTransformer] _inputBufferBytes.LinkTo(_inputBufferParcer); // from [_inputBufferTransformer] to [_inputBuffer] //_inputBufferTransformer.LinkTo(_inputBuffer); // if System then from [_inputBuffer] to [_inputSystemMessages] _inputBuffer.LinkTo(_inputSystemMessages, tlciw =&gt; _systemCalls.Contains(tlciw.Combinator.Name)); // if Updates then from [_inputBuffer] to [_inputUpdates] _inputBuffer.LinkTo(_inputUpdates, tlciw =&gt; tlciw.Combinator.ValueType.Equals("Updates")); // if rpc_result then from [_inputBuffer] to [_inputRpcAnswers] _inputBuffer.LinkTo(_inputAnswers, tlciw =&gt; tlciw.Combinator.Name.Equals("rpc_result")); // if rpc_result then from [_inputBuffer] to [_inputRpcAnswers] //_inputBuffer.LinkTo(_inputUnsorted); // and store it [_inputAnswers] to [_inputAnswersBuffer] to process it _inputAnswers.LinkTo(_inputAnswersBuffer); _inputRejectedBuffer.LinkTo(_inputAnswersBuffer);</span></span></code> </pre><br><br>  As you can see, input byte arrays are sorted out, classified and decomposed into buffers, from where they are sorted out as needed.  In particular, updates and systemMessages are processed immediately upon arrival in <code>ActionBlock</code> , and rpcAnswers is first converted using <code>TransformBlock</code> and then added to <code>BufferBlock</code> .  Classification of the packet type occurs inside the <code>BufferBlock</code> based on the conditions of linking blocks. <br><br>  Immediately after calling the method, we create WriteOnceBlock - a block where you can write only 1 value: <br><br><pre> <code class="cs hljs">WriteOnceBlock&lt;RpcAnswer&gt; answer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WriteOnceBlock&lt;RpcAnswer&gt;(e =&gt; e);</code> </pre><br><br>  And link it to the RPC response buffer: <br><br><pre> <code class="cs hljs">_inputAnswersBuffer.LinkTo(answer, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataflowLinkOptions { MaxMessages = <span class="hljs-number"><span class="hljs-number">1</span></span> }, i =&gt; i.SessionId == _em.SessionId);</code> </pre><br><br>  And then we wait asynchronously until the answer comes: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> answer.ReceiveAsync(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">60</span></span>)).ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      </span></span></code> </pre><br><br>  Separately, I want to note that up to this point I have not written a single line of code for Android.  All development and testing was carried out for the usual build under .net 4.5 <br><br><h5>  Talks.Backend </h5><br>  Client backend  I decided to implement the client according to the MVP design pattern with IoC, and initially I aimed at the Passive View variation, when the view does not contain any logic, but in the end I came to understand that the Supervising Controller would work much better. <br><br>  What problems arose before me when creating the backend?  Access to the notebook, access to the database, access to the file system (for storing photos).  The rest of the backend is an ordinary MVP implementation: a set of Presenters and IView's <br><br><h6>  <b>Access to the notebook</b> </h6><br>  To access the address book, the Xamarin team has already thought of everything for us.  They developed the Xamarin.Mobile library which encapsulates a set of functions on a mobile device - notebook, GPS, camera, in a cross-platform manner.  In addition, with full support for async-await. <br><br>  Thus, access to the address book is extremely simple: <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> __ANDROID__ public async Task GetAddressbook(Android.Content.Context context) { contacts = new AddressBook(context); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> public async Task GetAddressbook() { contacts = new AddressBook(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!await contacts.RequestPermission()) { Trace.WriteLineIf(clientSwitch.TraceInfo, "Permission for contacts denied", "[ContactsPresenter.PopulateAddressbook]"); _view.SendSmallMessage("CONTACTS PERMISSON DENIED"); return; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { _icv.PlainContacts = new ListItemCollection&lt;ListItemValue&gt;( (from c in contacts where (c.Phones.Count() &gt; 0) select new ListItemValue(c)).ToList()); } }</span></span></code> </pre><br><br>  The compilation <code>__ANDROID__</code> introduced because a context is required to get a list of contacts on Android, but not on other OSes. <br><br>  One of the drawbacks of Passive View for a cross-platform solution is visible here.  On the instructions we needed to group contacts by the first letter of the last name.  For Android, this is done through the creation of the ListItemCollection class, which performs grouping, a classic example of this is available on the Internet.  On iOS, a completely different approach to creating such a grouping is that on WinPhone - I do not know.  So it is appropriate to receive and group contacts directly in the View. <br><br>  This is the main problem in hybrid cross-platform development in my opinion.  It should be clearly understood where you need to abstract from the platform, and where you should not.  I think it comes with experience. <br><br><h6>  <b>Database access</b> </h6><br>  Access to the database Xamarin recommends through a simple ORM SQLite.Net.  Once I tried to ignore these recommendations and work with the database directly through the driver, but in the end I realized that it was better to listen to the advice of more experienced developers. <br><br>  I don‚Äôt see much point in describing how to work with SQLite.Net. I‚Äôll just say that in order to test a build with SQlite.Net connected, you need to have sqlite binaries in your project, which are available on the official website <a href="http://www.sqlite.org/download.html">www.sqlite.org/download.html</a> <br><br>  Separately, I note that SQLite.Net fully supports TAP and async-await. <br>  I recommend expanding the SQLite.SQLiteAsyncConnection class with a set of Generic classes to simplify database access: <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> Public Methods public Task&lt;List&lt;T&gt;&gt; GetItemsAsync&lt;T&gt;() where T : IBusinessEntity, new() { return Table&lt;T&gt;().ToListAsync(); } public Task&lt;T&gt; GetItemAsync&lt;T&gt;(int id) where T : IBusinessEntity, new() { return GetAsync&lt;T&gt;(id); } public async Task&lt;bool&gt; CheckRowExistAsync&lt;T&gt;(int id) where T : IBusinessEntity, new() { string tblName = typeof(T).Name; return await ExecuteScalarAsync&lt;int&gt;("select 1 from " + tblName + " where Id = ?", id).ConfigureAwait(false) == 1; } public async Task&lt;int&gt; SaveItemAsync&lt;T&gt;(T item) where T : IBusinessEntity, new() { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (await CheckRowExistAsync&lt;T&gt;(item.Id)) { return await base.UpdateAsync(item).ConfigureAwait(false); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { return await base.InsertAsync(item).ConfigureAwait(false); } } public Task&lt;int&gt; DeleteItemAsync&lt;T&gt;(int id) where T : IBusinessEntity, new() { return DeleteAsync(new T() { Id = id }); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span></span></code> </pre><br><br>  It is also worth remembering that the rules for access to the file system on each OS are different. <br><br>  Therefore, the path to the database can be obtained as follows: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DatabaseFilePath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sqliteFilename = <span class="hljs-string"><span class="hljs-string">"TalksDb.db3"</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SILVERLIGHT // Windows Phone expects a local path, not absolute var path = sqliteFilename; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> __ANDROID__ // Just use whatever directory SpecialFolder.Personal returns string libraryPath = Environment.GetFolderPath(Environment.SpecialFolder.Personal); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> // we need to put in /Library/ on iOS5.1 to meet Apple's iCloud terms // (they don't want non-user-generated data in Documents) string documentsPath= Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments); // Documents folder string libraryPath = Path.Combine(documentsPath, "..", "Library"); // Library folder #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> var path = Path.Combine(libraryPath, sqliteFilename); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> return path; } }</span></span></code> </pre><br><br><h6>  <b>File system access</b> </h6><br>  One of the objectives of the competition was the receipt and storage of images.  To solve this problem, I took and refined the cross-platform disk cache class <a href="http://blog.neteril.org/blog/2012/12/17/memory-efficient-bitmap-caching-with-mono-for-android/">from here</a> .  In general, working with the file system is one of the least portable parts, since the requirements for working with files on all operating systems are different.  Part of the features of file systems are described in the official docks of Xamarin. <br><br><h5>  Talks.Droid </h5><br>  Androyd version of the application.  Ideally, by the time you create a project for a specific platform, you can have a fully working and tested backend.  In my version it did not work out this way, but in the future I will strive for this. <br>  The main difficulties begin here. <br><br>  At the core of the application is the Bound Service to which the App class is binded - a singleton implementing the ‚Äúapplication‚Äù.  This is done in order for any Activity to access the service using <code>App.Current.MainService</code> . <br><br>  Inside the service, a Model creates a separate thread, as well as there is a class with which the Activity retrieves its Presenters, like this: <br><br><pre> <code class="cs hljs">_presenter = App.Current.MainService.CreatePresenter&lt;ChatListPresenter&gt;(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ChatListPresenter), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre><br><br>  It should be remembered that Xamarin forms AndroidManifest on its own and does not directly edit it.  All Activity parameters are recorded as attributes: <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Activity(Label = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Settings"</span></span></span><span class="hljs-meta">, Theme = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"@style/Theme.TalksTheme"</span></span></span><span class="hljs-meta">)</span></span>] [MetaData(<span class="hljs-string"><span class="hljs-string">"android.support.PARENT_ACTIVITY"</span></span>, Value = <span class="hljs-string"><span class="hljs-string">"talks.ChatListActivity"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SettingsActivity</span></span> : <span class="hljs-title"><span class="hljs-title">SherlockActivity</span></span>, <span class="hljs-title"><span class="hljs-title">IView</span></span></code> </pre><br><br>  In general, the Activity code is not much different from the java version, CamelCase, and some getters / setters are wrapped in properties. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCreate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bundle bundle</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnCreate(bundle); <span class="hljs-comment"><span class="hljs-comment">// Set our view from the "main" layout resource SetContentView(Resource.Layout.MessagesScreen); AndroidUtils.SetRobotoFont(this, (ViewGroup)Window.DecorView); _presenter = App.Current.MainService.CreatePresenter&lt;MessagePresenter&gt;(typeof(MessagePresenter), this); _presenter.PlatformSpecificImageResize = AndroidResizeImage; this.ChatId = Intent.GetIntExtra("userid", 0); userName = Intent.GetStringExtra("username"); _button = FindViewById&lt;ImageButton&gt;(Resource.Id.bSendMessage); _button.Click += button_Click; _button.Enabled = false; _message = FindViewById&lt;EditText&gt;(Resource.Id.etMessageToSend); _message.TextChanged += message_TextChanged; _lv = FindViewById&lt;ListView&gt;(Resource.Id.lvMessages); _lv.Adapter = new Adapters.MessagesScreenAdapter(this, this.Messages); }</span></span></code> </pre><br><br><h6>  <b>Login Activity</b> </h6><br>  Login Activity must contain 3 items - enter the phone, get the code and enter it, register.  For convenience, this is done using fragments. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/175/4e2/286/1754e2286d6f83b62f840b0d82642294.png" alt="image"><br><br>  The easiest way to do this with fragments.  However, the <b>use of fragments and MVP is not at all obvious</b> ! <br><br>  In the end, I came to the fact that I did one presenter, and LoginActivity just wrapped the IView implementations: <br><br><pre> <code class="cs hljs">PhoneFragment _pf = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; CodeFragment _cf = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; SignUpFragment _suf = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PhoneNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_pf != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _pf.Phone; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AuthCode { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _cf.Code; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _suf.FirstName; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Surname { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _suf.Surname; } }</code> </pre><br><br><h6>  <b>Photo / video shooting</b> </h6><br>  An interesting and not obvious point.  One of the tasks was to receive a photo / video from the camera to send it to the interlocutor or to install it as an avatar. <br><br>  This is done through the menu using Xamarin.Mobile. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnMenuItemSelected</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> featureId, Xamarin.ActionbarSherlockBinding.Views.IMenuItem item</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (item.ItemId) { <span class="hljs-comment"><span class="hljs-comment">// Respond to the action bar's Up/Home button case Android.Resource.Id.Home: NavUtils.NavigateUpFromSameTask(this); return true; case Resource.Id.messages_action_takephoto: _presenter.TakePhoto(this); return true; case Resource.Id.messages_action_gallery: _presenter.PickPhoto(this); return true; case Resource.Id.messages_action_video: _presenter.TakeVideo(this); return true; } return base.OnMenuItemSelected(featureId, item); }</span></span></code> </pre><br><br>  However, the event responsible for selecting the menu item returns bool, therefore we cannot apply the async-await construction to it.  This is solved very simply, it should be remembered that async-await is just a syntactic sugar that eventually generates all the same Continuation.  And nothing forbids us to write it as before: <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> __ANDROID__ /// &lt;summary&gt; ///     /// &lt;/summary&gt; /// &lt;param name="context"&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool TakePhoto(Android.Content.Context context) { var picker = new MediaPicker(context); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> public bool TakePhoto() { var picker = new MediaPicker(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (picker.IsCameraAvailable) { picker.TakePhotoAsync(new StoreCameraMediaOptions { Name = String.Format("{0:dd_MM_yyyy_HH_mm}.jpg", DateTime.Now), Directory = "TalksPictures" }) .ContinueWith((prevTask) =&gt; { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (prevTask.IsCanceled) { _imv.SendSmallMessage("User canceled"); return; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (PlatformSpecificImageResize != null) { string path = PlatformSpecificImageResize(prevTask.Result); //   DomainModel.Message msg = new DomainModel.Message(r.Next(Int32.MaxValue), 0, _imv.ChatId, _imv.PendingMessage, "", 0); _imv.AddMineMessage(msg); } }) .ContinueWith((prevTask) =&gt; { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!prevTask.IsCanceled) { Console.WriteLine("User ok"); } }, TaskScheduler.FromCurrentSynchronizationContext()); return true; } return false; }</span></span></code> </pre><br><br>  Xamarin in addition to cross-platform offers the Component Store, where the ports of popular Android and / or iOS libraries and components, both free and paid, are located.  In particular, ActionBar.Scherlok is present there and Android.Support.v7 recently appeared, and you can install components directly from the environment, like in NuGet, which is very convenient <br><br><img src="https://habrastorage.org/getpro/habr/post_images/38b/43a/d55/38b43ad554ae7032ddf989a5e7ee103c.png" alt="image"><br><br>  Thus, in two clicks you can get ActionBar support on devices with Android 2.3 and higher. <br><br><h6>  <b>Publication</b> </h6><br>  The application is published according to the scheme approved by Google. <br><img src="https://habrastorage.org/getpro/habr/post_images/5d9/847/68a/5d984768a3e50e7d6cfc1bdf4c1f08b1.png" alt="image"><br>  This involves quite a lot of action.  But especially for us, the team from Xamarin made a wizard built into VS that allows you to prepare an application for publication in several steps. <br><img src="https://habrastorage.org/getpro/habr/post_images/09d/872/902/09d8729024ea4137374fea995ac775e4.png" alt="image"><br>  and ready <br><img src="https://habrastorage.org/getpro/habr/post_images/d47/7c1/4af/d477c14af24d2b4e0cf28dfd61c66d24.png" alt="image"><br>  True, I could not immediately create a KeyStore using this wizard.  Something with the key lifetime was.  I had to create pens. <br><br><h4>  Testing </h4><br>  A quick note on testing.  Testing on an emulator is awful and impossible.  This should be discarded as soon as possible.  The cheapest androyd now costs 3,000 rubles, a Chinese tablet can be found at a similar price.  With the start of the contest, I immediately bought my wife Fly with Android 4.0.1, since  I only had an old HTC with 2.3. <br><br>  About testing and development for iOS is more difficult.  Of course, the best option is to take the cheapest MacBook, that will be enough. <br>  But buying a pair of iPhone and iPAD for testing ... I do not know, not the best option.  Now I am considering the possibility of <a href="http://www.macincloud.com/">MacInCloud</a> and if everything is fine there, I will describe the whole process in detail. <br><br><h4>  Total </h4><br>  Now it is difficult to sum up.  During the development process, I learned well the features of the Android platform, <br>  developed a good, covered with tests and, most importantly, a cross-platform backend. <br>  They say there will be a contest for WinPhone and iPad ahead.  Well, I can only draw interfaces. <br><br><h4>  Bug work </h4><br>  "Note to self" as they say.  Just comments on the future that I did wrong. <br>  1. Lack of design.  I double-refactored MTProto.Core almost completely.  The reason for this is that I did not sit down with a piece of paper and did not draw completely how this core should look like.  Many decisions were made spontaneously and without calculation for the future. <br>  2. Poor understanding of the Android platform.  For a long time I tried to understand how to organize interaction with the Android service.  Frankly, I still do not know a <i>better</i> way to ensure this interaction.  It is necessary to understand that the guides d.android.com are useless here, the service for the android is specific, and we need to get rid of the platform and do something cross-platform. <br>  3. Stubbornness and greed.  I had the opportunity to attract another programmer and maybe together we would have shown a better result.  But I myself, all by myself. </div><p>Source: <a href="https://habr.com/ru/post/194404/">https://habr.com/ru/post/194404/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194392/index.html">Intelligent motor cooling fan control relay</a></li>
<li><a href="../194394/index.html">Backstage flight reservations</a></li>
<li><a href="../194396/index.html">Nikon CoolPix S01: a small camera for women and not only</a></li>
<li><a href="../194398/index.html">Roskomnadzor entered Facebook in the registry of banned sites</a></li>
<li><a href="../194402/index.html">Home automation</a></li>
<li><a href="../194406/index.html">Fractals in prime numbers</a></li>
<li><a href="../194408/index.html">Budget UHF RFID reader and its development</a></li>
<li><a href="../194410/index.html">Algorithm X or what is common between the wooden puzzle and the dancing Link?</a></li>
<li><a href="../194412/index.html">We protect the system. Or how to configure and use port knocking</a></li>
<li><a href="../194416/index.html">The Little Giant of Big Computing ‚Äî an Overview of the IBM WorkPad z50 PDA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>