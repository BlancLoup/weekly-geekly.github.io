<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bresenham algorithm in real-time applications - part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuation of the post " Brezenham algorithm in real-time applications ." 

 Recall that we are writing an output program for laser scanners. 


 In...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bresenham algorithm in real-time applications - part two</h1><div class="post__text post__text-html js-mediator-article">  Continuation of the post " <a href="http://habrahabr.ru/post/205654/">Brezenham algorithm in real-time applications</a> ." <br><br>  Recall that we are writing an output program for laser scanners. <br><img src="https://habrastorage.org/getpro/habr/post_images/010/04f/65f/01004f65fadc9eae45c81fee23dc39fb.jpg" alt="image"><br><a name="habracut"></a><br>  In my case, the laser scanner is used on the installation of the so-called <a href="http://wiki.laser.ru/index.php/%25D0%259B%25D0%25B0%25D0%25B7%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D1%2582%25D0%25B5%25D1%2580%25D0%25B5%25D0%25BE%25D0%25BB%25D0%25B8%25D1%2582%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%258F">laser stereolithography</a> , where the drawing is a ray of ultraviolet laser on the surface of the liquid photopolymer.  You cannot see ultraviolet with your eyes, but you can see <i>harmonics</i> (radiation of relatively low power in the visible range, which is generated in a laser at a wavelength not important to it), as well as fluorescence from a photopolymer or plain white coated paper. <br><img src="https://habrastorage.org/getpro/habr/post_images/aed/ef2/b75/aedef2b753276850c0524de546ce9098.jpg" alt="image"><br>  Here in the picture - coated paper, slightly soaked with photopolymer, on the cover glass is applied a layer of photopolymer about 1 mm thick, on which is drawn, as you can see, a favorite word on Habr√©.  On the left is the ‚Äúpoint of sludge‚Äù where the beam goes after drawing.  The trace between the drawing and the sludge point is an <i>idle transfer of the</i> beam, which we see only due to the considerable afterglow of the fluorescence of the paper.  In terms of the algorithm discussed earlier, this transfer can be represented as a sequential execution <br><pre><code class="cpp hljs">putXY(x,y, wait); <span class="hljs-comment"><span class="hljs-comment">// , x=32000, y=32000 putXY(x0,y0, wait); // y, x0=100, y0=100 -  </span></span></code> </pre> <br><br>  We will not see any ‚Äúzigzags‚Äù or ‚Äúloops‚Äù in a good scanner.  At least - by the eye. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Although if there is a source of electro-magnetic interference such as a mobile phone nearby, it could be <br><img src="https://habrastorage.org/getpro/habr/post_images/c31/4d6/464/c314d646470cdd38de6c0b8ceda8e25a.jpg" alt="image"><br><br>  Without coated paper, we won't see any idle rolls. <br><img src="https://habrastorage.org/getpro/habr/post_images/9b0/6c2/1e6/9b06c21e6bd2a11894a3542f703887a5.jpg" alt="image"><br><br>  We now return to our algorithm.  In the comments to the first part, no one guessed what we will see as a result of the implementation of the proposed implementation of the Brezenham algorithm. <br>  And we will see just such a thing <br><img src="https://habrastorage.org/getpro/habr/post_images/274/38b/9c6/27438b9c6310c08fe6ded4eaacfbf66a.jpg" alt="image"><br><br>  On the left, what we see (this is photoshop, the conscience did not allow the wrong program to be poured into the controller), on the right, what we expected to see. <br>  Short bright lines indicate that the scanning speed sometimes decreases.  How can it be reduced if we do not have any multitasking in the controller and the operating system in general?  Very simple - we have interruptions!  Even if the controller is not loaded with any other functions, except for issuing to DACs, we still have interruptions related to communication with the control computer.  For example, through a UART (COM port) or Ethernet.  It seems that not so much time is taken by interruptions and it seems that not so often we do a survey.  Dashes can be shorter, turning into points, but it is impossible to get rid of them completely with such a realization of delay <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">putpixel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wait)</span></span></span><span class="hljs-function">) </span></span>{ outPortX(x); <span class="hljs-comment"><span class="hljs-comment">//    X  x outPortY(y); //    Y  y delay(wait); //  wait   }</span></span></code> </pre><br><br>  Often delays in programming microcontrollers are done on a simple counter. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wait)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//  wait  "" { int i; for(i=0;i&lt;wait; i++); }</span></span></span></span></code> </pre><br><br>  Cheap and <s>angry</s> wrong.  In the case of an interruption, such a realization of the delay will never know that the program ‚Äúwent away‚Äù to another place and the required time has passed.  Ideologically more correct latency uses hardware timer timer <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wait)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t0; t0 = /LPC_TIM1-&gt;TC <span class="hljs-comment"><span class="hljs-comment">//LPC_TIM1-&gt;TC -          LPC 17xx while(LPC_TIM1-&gt;TC - t0 &lt; wait); }</span></span></code> </pre><br><br>  In this case, the delay function automatically learns about the interruption that has occurred, although it does not guarantee the absolute accuracy of the processor.  If the program spends most of the time in delays this could be limited, however, for the case of fast movements, the use of a hardware timer should be end-to-end <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* real time Bresenham alg. implementation */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Line</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wait)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x1,y1,dx,dy,sx,sy,d,d1,d2; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t0 = LPC_TIM1-&gt;TC; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i, x,y; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( x2 &gt;= x1) { dx = x2 - x1; sx = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dx = x1 - x2; sx = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( y2 &gt;= y1) { dy = y2 - y1; sy = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dy = y1 - y2; sy = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/****************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(dy &lt;= dx) { d = (dy &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) - dx; d1 = dy &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>; d2 = (dy - dx) &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(x=x1+sx,y=y1,i=<span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt;= dx ; i++,x+=sx) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(d &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { d += d2; y += sy; putXY(x,y,wait,&amp;t0); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { d += d1; putX(x, wait, &amp;t0); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { d = (dx &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) - dy; d1 = dx &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>; d2 = (dx - dy) &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(x=x1,y=y1+sy,i=<span class="hljs-number"><span class="hljs-number">1</span></span>;i &lt;= dy ; i++,y += sy) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(d &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { d += d2; x += sx; putXY(x,y,wait, &amp;t0); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { d += d1; putY(y, wait, &amp;t0); } } } <span class="hljs-comment"><span class="hljs-comment">/* endif(dy &lt;=dx) */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">putXY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wait, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pT0)</span></span></span><span class="hljs-function"> </span></span>{ outPortXY(x,y); <span class="hljs-comment"><span class="hljs-comment">//    X  Y  x  y //    #define outPortXY(x,y) outPortX(x); outPortY(y); /*  wait   */ while(LPC_TIM1-&gt;TC - *pT0 &lt; wait); *pT0 += wait; } void putX(int x, int wait, unsigned int *pT0) { outPortX(x); //    X  x /*  wait   */ while(LPC_TIM1-&gt;TC - *pT0 &lt; wait); *pT0 += wait; } void putY(int y, int wait, unsigned int *pT0) { outPortY(y); //    Y  y /*  wait   */ while(LPC_TIM1-&gt;TC - *pT0 &lt; wait); *pT0 += wait; }</span></span></code> </pre><br><br>  Note that in this variant, both different times for output to a DAC for one channel or two channels are automatically taken into account, as well as the spread of output time, if output is used until it is ready. <br><br>  In this implementation, possible interrupts are taken into account inside the Line () function; outside this function, the effect of interruptions on the execution duration can still manifest itself.  I hope that the reader will not be difficult to guess how to proceed in the general case. <br><br>  And finally - if you find yourself with the program, you can see the most unexpected squiggles instead of the expected test circle and square. <br><img src="http://ic.pics.livejournal.com/evgen2/13024726/124833/124833_600.jpg" alt="image"><br>  In this case, ‚Äúeverything almost worked‚Äù, only incomprehensible teeth appeared.  As it turned out, one line <i>y + = sy;</i>  was replaced by <i>x + = sx;</i>  .  By the way, due to a randomly hit touchpad on a laptop. </div><p>Source: <a href="https://habr.com/ru/post/207740/">https://habr.com/ru/post/207740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207726/index.html">RuTracker.org blocked</a></li>
<li><a href="../207730/index.html">From Backbone.js to Marionette.js</a></li>
<li><a href="../207732/index.html">Linux is everywhere. Planet Open Source</a></li>
<li><a href="../207734/index.html">Algorithm for quick search of words in the game noodle</a></li>
<li><a href="../207736/index.html">Apple patents a computer with wireless charging and a projector instead of a monitor</a></li>
<li><a href="../207742/index.html">First text message transmission using odor</a></li>
<li><a href="../207744/index.html">HD video from a private satellite SkySat</a></li>
<li><a href="../207746/index.html">0day * vulnerability to the New Year: ICQ, Ebay, Forbes, PayPal and AVG</a></li>
<li><a href="../207748/index.html">FaceRig - character animation in real time</a></li>
<li><a href="../207750/index.html">Let's fix NAs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>