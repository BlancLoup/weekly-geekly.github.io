<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pain and animation tables for iOS. Awesome Table Animation Calculator Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine the screen of a regular mobile application with an already filled list of cells. From the server comes another list. It is necessary to calcul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pain and animation tables for iOS. Awesome Table Animation Calculator Framework</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/5d6/89f/092/5d689f09298e4c82ba7f49c3f49cde14.gif" width="250" align="right"><br><p> Imagine the screen of a regular mobile application with an already filled list of cells.  From the server comes another list.  It is necessary to calculate the difference between them (what was added / deleted) and to do a <code>UICollectionView</code> . </p><br><p>  The ‚Äúsimple‚Äù approach is to completely replace the model and then call <code>reloadData</code> .  Unfortunately, animations are lost and other unwanted effects and brakes can occur.  Much more interesting to edit lists neatly, animated.  After trying to do this several times, I made sure that it is incredibly difficult. </p><br><p>  Once the problem has been encountered in several projects, it is necessary to generalize it and work further with a generalized implementation.  An interesting challenge!  A few days of dealing with the documentation, common sense, bugs implementation tables in iOS, and it turned out the code with a fairly simple interface, adapting to a wide range of tasks, about which I want to tell. </p><a name="habracut"></a><br><blockquote>  Of course, the framework first solves my own problems.  If you suddenly need a feature that is not there now, write, ask, I will try to refine. </blockquote><br><h2>  Slightly more formal task description. </h2><br><p>  Imagine that we have a table that consists of sections with cells. </p><br><blockquote>  Tables or lists are <code>UICollectionView</code> or <code>UITableView</code> , I will not distinguish them in the article.  Judging by the same bugs, inside there is the same code, and the interface is similar. </blockquote><br><p>  You need to be able to animate the table in two cases: </p><br><ul><li>  changed the table sorting (for example, sorted by name, now sorted by last name) </li><li>  some piece of data has changed.  Some cells may be added, some may change, some may be removed. </li></ul><br><p>  If something clear has changed (for example, one cell has been added), then everything is simple.  But what if we have a chat in which messages can be edited and deleted in batches?  Or a list of users that is shown from the cache, and then it is obtained from the server and is completely updated? </p><br><blockquote>  For example, try to present the address book, where the sorting was from A to Z, and then it changed the reverse.  The last sections should move up, and within sections the cells should be re-sorted.  What are the indices of displacements?  In what sequence will the system apply animations?  All these questions are very superficially described in the documentation, and you have to understand the method of "spear". </blockquote><br><p>  <code>ATableAnimationCalculator</code> is a data model for a table that monitors the current state of the cells and, if it is told ‚Äúsomething new here, calculate the difference‚Äù, considers counting out the list of cell indexes and sections that need to be changed (deleted, inserted, moved).  After that, the result of the calculation can be applied to the table, bypassing problems in the implementation of iOS animations. </p><br><h2>  Framework data structure </h2><br><blockquote>  In the names, the first letter ‚ÄúA‚Äù is not a framework prefix, as you might think, but an abbreviation of the word ‚ÄúAwesome‚Äù.  ;-) </blockquote><br><p>  The framework consists of: </p><br><ul><li>  Models: <br><ul><li>  <code>ACellModel</code> protocol to be implemented in the cell model. </li><li>  The <code>ASectionModel</code> (and <code>ASectionModelObjC</code> to support Objctive-C), from which you need to inherit the section model.  A class, not a protocol, in order not to repeat the code dedicated to the internal device of the sections. </li><li>  The <code>ACellSectionModel</code> protocol, whose implementation knows how to link cells and sections. </li></ul></li><li>  The basic algorithm <code>ATableAnimationCalculator</code> . </li><li>  The result of the algorithm, the structure <code>ATableDiff</code> (with extensions for UIKit'a that live in a separate file). </li></ul><br><p>  Section class is quite simple.  It is needed to store the start / end indexes, but since these are implementation details, only the initializer and indexes stick out, which can be useful for debugging purposes.  The <code>ASectionModelObjC</code> class <code>ASectionModelObjC</code> exactly the same; it should be used when Objective-C support is required. </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASectionModel</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ASectionModelProtocol { public internal </span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> startIndex:<span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> endIndex:<span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() }</code> </pre> <br><p>  Cell protocol is no more complicated.  It is necessary that the cells are equal, you need to check their contents for identity and to be able to copy them (why in the section on rakes). </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ACellModel</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Equatable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   init(copy:Self) //   ,   ,    func contentIsSameAsIn(another:Self) -&gt; Bool }</span></span></code> </pre> <br><p>  There is also a protocol linking cells and sections together.  It helps to understand whether two cells are in one section and create a section in an arbitrary cell.  Please note that the <code>ASectionModel</code> section type must be inherited from the <code>ASectionModel</code> class and implement the <code>Equatable</code> protocol. </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ACellSectionModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">ACellModelType</span></span>: <span class="hljs-type"><span class="hljs-type">ACellModel</span></span> <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">ASectionModelType</span></span>: <span class="hljs-type"><span class="hljs-type">ASectionModelProtocol</span></span>, <span class="hljs-type"><span class="hljs-type">Equatable</span></span> <span class="hljs-comment"><span class="hljs-comment">// ,   , , //       func cellsHaveSameSection(one one:ACellModelType, another:ACellModelType) -&gt; Bool //     func createSection(forCell cell:ACellModelType) -&gt; ASectionModelType }</span></span></code> </pre> <br><p>  The <code>ATableAnimationCalculator</code> class has a comparator that is used to sort the cells, several methods for use in the <code>.dataSource</code> tables, and methods for starting the calculation of changes.  Also for debugging it may be useful to look at the lists of cells and sections. </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ATableAnimationCalculator&lt;ACellSectionModelType:ACellSectionModel&gt;: NSObject { //   ,   ,    private typealias ACellModelType = ACellSectionModelType.ACellModelType private typealias ASectionModelType = ACellSectionModelType.ASectionModelType //        <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> private(<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) var items:[ACellModelType] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> private(<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) var sections:[ASectionModelType] //   .    //  resortItems      <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> var cellModelComparator:(ACellModelType, ACellModelType) <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> init(cellSectionModel:ACellSectionModelType) } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> ATableAnimationCalculator { //     ( )  //    .dataSource  .delegate func sectionsCount() -&gt; <span class="hljs-type"><span class="hljs-type">Int</span></span> func itemsCount(inSection sectionIndex:<span class="hljs-type"><span class="hljs-type">Int</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Int</span></span> func section(withIndex sectionIndex:<span class="hljs-type"><span class="hljs-type">Int</span></span>) -&gt; ACellModelType.ASectionModelType func item(forIndexPath indexPath:NSIndexPath) -&gt; ACellModelType func item(withIndex <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>:<span class="hljs-type"><span class="hljs-type">Int</span></span>) -&gt; ACellModelType } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> ATableAnimationCalculator { //     diff,   //     (, ,   ) func resortItems() throws -&gt; DataSourceDiff //     ,     . //    reloadData,  . func setItems(newItems:[ACellModelType]) throws -&gt; DataSourceDiff //    ,      . func updateItems(addOrUpdate addedOrUpdatedItems:[ACellModelType], <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>:[ACellModelType]) throws -&gt; DataSourceDiff }</code> </pre> <br><p>  The calculator is specially made as independent as possible so that you can use it anywhere.  For <code>UICollectionView</code> and <code>UITableView</code> , the corresponding extensions are written that allow you to animate the results of the calculations to them: </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ATableDiff</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(collectionView collectionView:UICollectionView)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tableView tableView:UITableView)</span></span></span></span> }</code> </pre> <br><h2>  An example of using the framework </h2><br><p>  Let's look at a simple implementation of a section in which there is only a header. </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASectionModelExample</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASectionModel</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Equatable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> title:<span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(title:<span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.title = title <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> ==</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lhs:ASectionModelExample, rhs:ASectionModelExample)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lhs.title == rhs.title }</code> </pre> <br><p>  There are three fields in the cell: </p><br><ul><li>  ID, which ensures the equality of cells.  It is for this field that we understand that the cell is the same, only the contents have changed. </li><li>  Header  Usually in the cell there is a field (name, surname or date of creation of the object) for which the section is created.  Here this field is the "title". </li><li>  Text, the text that is displayed in the cell and by which we compare the contents. </li></ul><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ACellModelExample: ACellModel { var id:String var <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>:String var <span class="hljs-type"><span class="hljs-type">text</span></span>:String init(<span class="hljs-type"><span class="hljs-type">text</span></span>:String, <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>:String) { id = NSUUID().UUIDString //       self.text = <span class="hljs-type"><span class="hljs-type">text</span></span> self.<span class="hljs-keyword"><span class="hljs-keyword">header</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">header</span></span> } required init(<span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>:ACellModelExample) { id = <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>.id <span class="hljs-type"><span class="hljs-type">text</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>.text <span class="hljs-keyword"><span class="hljs-keyword">header</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">header</span></span> } func contentIsSameAsIn(another:ACellModelExample) -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">text</span></span> == another.text } } func ==(lhs:ACellModelExample, rhs:ACellModelExample) -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lhs.id == rhs.id }</code> </pre> <br><p>  And finally, a class that knows how to link cells and sections together. </p><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ACellSectionModelExample</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ACellSectionModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cellsHaveSameSection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(one one:ACellModelExample, another:ACellModelExample)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> one.header == another.header } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createSection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(forCell cell:ACellModelExample)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ASectionModelExample</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">ASectionModelExample</span></span>(title:cell.header) } }</code> </pre> <br><p>  Now let's see how to screw this all to <code>UITableView</code> .  First, we connect the calculator to the table's <code>.dataSource'</code> methods.  This is easy to do, since the calculator assumes all requests for the number and receipt of items by index. </p><br><blockquote>  The code is intentionally made minimal in size, the real code must be more accurate and, please, without exclamation marks.  :-) </blockquote><br><pre> <code class="hljs pgsql">//      private let calculator = ATableAnimationCalculator(cellSectionModel:ACellSectionModelExample()) func numberOfSectionsInTableView(tableView:UITableView) -&gt; <span class="hljs-type"><span class="hljs-type">Int</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> calculator.sectionsCount() } func tableView(tableView:UITableView, numberOfRowsInSection section:<span class="hljs-type"><span class="hljs-type">Int</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Int</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> calculator.itemsCount(inSection:section) } func tableView(tableView:UITableView, cellForRowAtIndexPath indexPath:NSIndexPath) -&gt; UITableViewCell { var cell = tableView.dequeueReusableCellWithIdentifier("generalCell") cell!.textLabel!.text = calculator.item(forIndexPath:indexPath).text <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell! } func tableView(tableView:UITableView, titleForHeaderInSection section:<span class="hljs-type"><span class="hljs-type">Int</span></span>) -&gt; String? { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> calculator.section(withIndex:section).title }</code> </pre> <br><p>  The first update of the data usually does not need to be animated, so just set the list and call, as usual, <code>reloadData</code> .  The calculator will sort (if a comparator is set) the cells and break them into sections. </p><br><pre> <code class="hljs pgsql">try! calculator.setItems([ ACellModelExample(<span class="hljs-type"><span class="hljs-type">text</span></span>:"5", <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>:"C"), ACellModelExample(<span class="hljs-type"><span class="hljs-type">text</span></span>:"1", <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>:"A"), ACellModelExample(<span class="hljs-type"><span class="hljs-type">text</span></span>:"3", <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>:"B"), ACellModelExample(<span class="hljs-type"><span class="hljs-type">text</span></span>:"2", <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>:"B"), ACellModelExample(<span class="hljs-type"><span class="hljs-type">text</span></span>:"4", <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>:"C") ]) tableView.reloadData()</code> </pre> <br><blockquote>  The update may break if the comparator is not set, and the cells themselves are not sorted in advance.  After all, then it may turn out that the same section at the same time will be scattered in different parts of the list, which is difficult to analyze.  :-) </blockquote><br><p>  Now, for example, add a couple of cells in different sections and apply the calculated animations. </p><br><pre> <code class="hljs pgsql">let addedItems = [ ACellModelExample(<span class="hljs-type"><span class="hljs-type">text</span></span>:"2.5", <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>:"B"), ACellModelExample(<span class="hljs-type"><span class="hljs-type">text</span></span>:"4.5", <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>:"C"), ] let itemsToAnimate = try! calculator.updateItems(addOrUpdate:addedItems, <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>:[]) itemsToAnimate.applyTo(tableView:tableView)</code> </pre> <br><p>  You can also change the comparator, and then animate re-sort the cells. </p><br><pre> <code class="hljs swift">calculator.cellModelComparator = { <span class="hljs-keyword"><span class="hljs-keyword">left</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">right</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">left</span></span>.header &lt; <span class="hljs-keyword"><span class="hljs-keyword">right</span></span>.header ? <span class="hljs-literal"><span class="hljs-literal">true</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">left</span></span>.header &gt; <span class="hljs-keyword"><span class="hljs-keyword">right</span></span>.header ? <span class="hljs-literal"><span class="hljs-literal">false</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">left</span></span>.text &lt; <span class="hljs-keyword"><span class="hljs-keyword">right</span></span>.text } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> itemsToAnimate = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.calculator.resortItems() itemsToAnimate.applyTo(tableView:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.tableView)</code> </pre> <br><p>  Actually, everything. </p><br><h2>  Underwater rake when used </h2><br><p>  Remember the copy constructor in the cell model?  In it, you need to copy the entire cell, and the ID (from the example), and these cells (header, text in the example).  Otherwise, it may happen that when the data in the model changes, they will also change inside the algorithm data.  After that, the algorithm will not be able to determine that the cells have been updated.  There will be implicit bugs with non-updating cells that are hard to understand. </p><br><p>  Another field of the rake hides the algorithm - a complex update of the tables and bugs of the current implementation of iOS.  For example, now in the case of simultaneous movement of sections and cells within these sections, it does not work out the update of cells, it is necessary to ask them to force them.  You need to remember this if you decide not to use the already written methods, but to implement them yourself. </p><br><p>  During testing, I found out that the <code>performBatchUpdates</code> method works, let's say, strange.  In the simulator, he can give, for example, <code>EXC_I386_DIV</code> (exclusion of division by zero).  Sometimes it happens that asserts work (about which nothing is unknown, only the line number in the depths of UIKit).  If suddenly you have cases when everything breaks down and they stably repeat - write, I will try to embed code that will take them into account. </p><br><h2>  Use in Objective-C </h2><br><p>  You can try to use the calculator in code for Objective-C.  This is not very convenient, and I did not set a goal to support Objective-C, but it is possible.  This is done like this: </p><br><ul><li>  It is necessary to implement all the protocols on Swift.  In this case, the cell will be defined, for example, as follows: <br>  <code>@objc class ACellModelExampleObjC: NSObject, ACellModel</code> , <br>  section so: <br>  <code>@objc public class ASectionModelExampleObjC: ASectionModelObjC</code> (the base class is important here). <br>  The model for the cell section does not require ObjC support: <br> <code>class ACellSectionModelExample ObjC: ACellSectionModel</code> </li> <li>  We create a class that will hide all insides and complexities like generics from Objective-C. </li></ul><br><pre> <code class="hljs swift"><span class="hljs-meta"><span class="hljs-meta">@objc</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ATableAnimationCalculatorObjC</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> calculator = <span class="hljs-type"><span class="hljs-type">ATableAnimationCalculator</span></span>(cellSectionModel:<span class="hljs-type"><span class="hljs-type">ACellSectionModelExampleObjC</span></span>()) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCalculator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">AnyObject?</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> calculator } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setItems</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(items:[ACellModelExampleObjC], andApplyToTableView tableView:UITableView)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>! calculator.setItems(items).applyTo(tableView:tableView) } }</code> </pre> <br><p>  Then you can use it in Objective-C. </p><br><pre> <code class="hljs kotlin">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"ATableAnimationCalculator-Swift.h"</span></span> ATableAnimationCalculatorObjC *calculator = [[ATableAnimationCalculatorObjC alloc] <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>]; [calculator setItems:@[ [[ACellModelExampleObjC alloc] initWithText:@<span class="hljs-string"><span class="hljs-string">"1"</span></span> header:@<span class="hljs-string"><span class="hljs-string">"A"</span></span>], [[ACellModelExampleObjC alloc] initWithText:@<span class="hljs-string"><span class="hljs-string">"2"</span></span> header:@<span class="hljs-string"><span class="hljs-string">"B"</span></span>], [[ACellModelExampleObjC alloc] initWithText:@<span class="hljs-string"><span class="hljs-string">"3"</span></span> header:@<span class="hljs-string"><span class="hljs-string">"B"</span></span>], [[ACellModelExampleObjC alloc] initWithText:@<span class="hljs-string"><span class="hljs-string">"4"</span></span> header:@<span class="hljs-string"><span class="hljs-string">"C"</span></span>], [[ACellModelExampleObjC alloc] initWithText:@<span class="hljs-string"><span class="hljs-string">"5"</span></span> header:@<span class="hljs-string"><span class="hljs-string">"C"</span></span>], ] andApplyToTableView:myTableView];</code> </pre> <br><p>  As you can see, in Swift, you will need to render all the work with the <code>ATableDiff</code> structure, and the calculator itself will be output in Objective-C as <code>id</code> ( <code>AnyObject?</code> ). </p><br><h2>  Update 0.9.12 </h2><br><p>  The comments suggested adding methods to support standard UITableView editing.  Added by.  You can use it like this: </p><br><pre> <code class="hljs erlang"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> itemsToAnimate = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>! calculator.removeItem(withIndex:indexPath) //   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> itemsToAnimate = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>! calculator.swapItems(withIndex:sourceIndexPath, toIndex:destinationIndexPath) //  </code> </pre> <br><p>  And the addition is clear.  In this case, you only need to take into account that if you are going to work with moving cells, you need to ‚Äúturn off‚Äù the <code>cellModelComparator</code> , or check that it takes into account the correct position of the cells when moving. </p><br><h2>  Conclusion, comments, source </h2><br><p>  The code is tested on a bunch of artificial / random tests.  As far as I can see, it works quite well.  If you see any shortcomings or unrecorded cases, write. </p><br><p>  Using generics and associated types breaks (judging by the responses to StackOverflow) compatibility with iOS 7, therefore only iOS 8 and 9 are supported. </p><br><p>  Sources live on GitHub, the project is called <a href="https://github.com/bealex/AwesomeTableAnimationCalculator"><code>ATableAnimationCalculator</code></a> .  For integration, you can include source code to yourself (there are only a few files).  If you only need an algorithm, you can connect everything except extensions for UIKit. </p><br><p>  There are under in <a href="http://cocoapods.org/">CocoaPods</a> : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">pod</span></span> <span class="hljs-string"><span class="hljs-string">'AwesomeTableAnimationCalculator'</span></span></code> </pre> <br><p>  Supported by <a href="https://github.com/Carthage/Carthage">Carthage</a> : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">github</span></span> <span class="hljs-string"><span class="hljs-string">"bealex/AwesomeTableAnimationCalculator"</span></span></code> </pre> <br><p>  If you have any questions, ask either here or directly to the email <a href="">alex@jdnevnik.com</a> . </p><br><h2>  Acknowledgments </h2><br><p>  Thanks to <a href="https://eego.pro/">Evgeny Egorov</a> for the improvements in the structure and additional test cases that made it possible to improve the algorithm. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/282509/">https://habr.com/ru/post/282509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../28250/index.html">Ayhuilko</a></li>
<li><a href="../282501/index.html">Russian Code Cup 2016: for the first time in English</a></li>
<li><a href="../282503/index.html">Powerware or PoshCoder? Comparison and decryption</a></li>
<li><a href="../282505/index.html">Qt Quick Controls 2 - have been waiting for the promised three years</a></li>
<li><a href="../282507/index.html">Memo for the office sysadmin</a></li>
<li><a href="../28251/index.html">The idea can only be believed. About rational and irrational in startups</a></li>
<li><a href="../282511/index.html">All that wanted</a></li>
<li><a href="../282513/index.html">Microsoft Research Summer School 2016 in Kazan - Internet of Things</a></li>
<li><a href="../282517/index.html">Perfect HTTP performance</a></li>
<li><a href="../282518/index.html">How to choose a server for a small company: a guide for doubters</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>