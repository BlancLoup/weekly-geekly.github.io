<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AlertDialog setMultiChoiceItems, bug or non-obvious feature</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 Introduction 
 The last couple of months working on a single project for Android. But now it‚Äôs not about him, I‚Äôll try to write about him...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AlertDialog setMultiChoiceItems, bug or non-obvious feature</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br><h4>  Introduction </h4><br>  The last couple of months working on a single project for Android.  But now it‚Äôs not about him, I‚Äôll try to write about him, but everything has its time <br><br>  For all the time of work on the project, a lot of interesting things happened (and happen).  Today I want to tell a little story. <br><a name="habracut"></a><br><h4>  Beginning of the story </h4><br>  One evening, just before the New Year holidays, working in the office and drinking a favorite tea, I wrote another part of the functionality for the project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It took me to create a normal dialogue, with the possibility of multiple selection of elements from the list, with the ability to immediately mark / uncheck all elements, save the selected elements and mark them immediately after the subsequent display of the dialog. <br>  No sooner said than done. <br><br>  Actually the code itself: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ArrayList&lt;String&gt; items; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ArrayList&lt;String&gt; selectedItems; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showMyDialog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = items.size(); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span>[] checkedItems = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span>[count]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; i++) checkedItems[i] = selectedItems.contains(items.get(i)); AlertDialog.Builder builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AlertDialog.Builder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); builder.setMultiChoiceItems(items.toArray(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[items.size()]), checkedItems, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DialogInterface.OnMultiChoiceClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DialogInterface dialog, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> which, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isChecked)</span></span></span><span class="hljs-function"> </span></span>{ ListView list = ((AlertDialog) dialog).getListView(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isChecked) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (which == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; list.getCount(); ++i) list.setItemChecked(i, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); selectedItems.clear(); selectedItems.addAll(items); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> selectedItems.add(items.get(which)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (which == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; list.getCount(); ++i) list.setItemChecked(i, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); selectedItems.clear(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> selectedItems.remove(items.get(which)); } } }); AlertDialog dialog = builder.create(); dialog.requestWindowFeature(Window.FEATURE_NO_TITLE); dialog.show(); }</code> </pre> <br><br>  It would seem that the problem is solved, you can test and go with a clear conscience to rest (well, okay, play WOT =)). <br><br>  The button to mark / unmark all elements worked.  But then I noticed, if I first marked a couple of elements, then with the button to mark all the elements and immediately remove the mark from all, then the couple of elements that I marked myself remain marked. <br>  Having a little experimented, I decided that it was time to go to rest and continue exploring in the morning.  Before leaving, I raised this question on <a href="http://stackoverflow.com/questions/8659858/alertdialog-listview-uncheck">stackoverflow</a> . <br><br>  In the morning, having come to work, having reviewed his topic and not having seen any practical advice, I continued the analysis further. <br>  After not a long analysis of what is happening, it became clear that the problem is reproduced only if <br> <code>setMultiChoiceItems(CharSequence[] items, boolean[] checkedItems, OnMultiChoiceClickListener listener)</code> <br>  pass the array checkedItems, if null was passed instead, the problem did not occur. <br>  I raised the question again on <a href="http://stackoverflow.com/questions/8667670/alertdialog-listview-setmultichoiceitems">stackoverflow</a> , but unfortunately no one advised anything. <br><br>  It was already December 29 in the courtyard, and the project still had many tasks, so by rewriting the code a little bit, without transferring the array, the problem was solved. <br>  Reporting a problem to <a href="http://code.google.com/p/android/issues/detail%3Fid%3D23680">Google‚Äôs bugtracker</a> and continuing to work further, I forgot about this story. <br><br><h4>  Our days </h4><br>  Today, looking through the mail, I saw that someone had responded to my bug report.  After viewing it became clear that a couple more people faced the same problem. <br><br>  Having dealt with things a little, I decided to look at the problem again. <br>  An idea came to mind, although it seemed to me that she had already arrived and I checked it, I checked it again. <br>  The essence of the idea was to make the array checkedItems a field of the class, and in the listener to work with it too. <br>  As a result, the onClick method took the form: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DialogInterface dialog, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> which, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isChecked)</span></span></span><span class="hljs-function"> </span></span>{ ListView list = ((AlertDialog) dialog).getListView(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isChecked) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (which == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; list.getCount(); ++i) { list.setItemChecked(i, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); checkedItems[i]=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } selectedItems.clear(); selectedItems.addAll(items); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> selectedItems.add(items.get(which)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (which == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; list.getCount(); ++i) { list.setItemChecked(i, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); checkedItems[i]=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } selectedItems.clear(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> selectedItems.remove(items.get(which)); } }</code> </pre><br><br>  And yes, that solved the original problem. <br><br><h4>  Total. </h4><br>  It can be concluded, although I do not like it: <br>  If the state of an element in the checkedItems array is indicated as not marked (false), then when checked, it is marked on the screen (but not marked in the array) and when unchecked, the mark is removed. <br>  But if in the checkedItems array the state of the element is indicated as marked (true), then when unchecking the mark, the element still remains marked on the screen, since  it remains marked in the array. <br><br>  This is the story that turned out, I hope it was interesting and you did not waste your time, however, like me. <br>  Thank you for your attention, if you have questions, I will be happy to answer. <br>  In the next article I want to talk about the project itself, it should be interesting. </div><p>Source: <a href="https://habr.com/ru/post/139322/">https://habr.com/ru/post/139322/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139314/index.html">Hacked servers at Linode, stolen about 50K BTC ($ 250K)</a></li>
<li><a href="../139315/index.html">Load balancing between two channels in dynamic EIGRP routing</a></li>
<li><a href="../139316/index.html">Web development with the ChicagoBoss framework</a></li>
<li><a href="../139319/index.html">AutoTranslate via Skype</a></li>
<li><a href="../139320/index.html">We overclock the sysadmin's portfolio with free certificates</a></li>
<li><a href="../139324/index.html">Cross-compiling Qt-4.8.0 under mingw32 (x86) in Gentoo (x86_64)</a></li>
<li><a href="../139325/index.html">Architectural Flame CouchDB</a></li>
<li><a href="../139326/index.html">Morris.js: beautiful graphics tool with jQuery and Rapha√´l</a></li>
<li><a href="../139328/index.html">What do you need from the forms?</a></li>
<li><a href="../139329/index.html">Stopwatch on CSS3 without pictures, scripts and SMS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>