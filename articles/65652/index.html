<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Logging Windows EventLog and Alert System for Administrators</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A certain amount of time (about three years ago), in an attempt to find a way to export Windows EventLog, an opportunity was found to audit various ev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Logging Windows EventLog and Alert System for Administrators</h1><div class="post__text post__text-html js-mediator-article">  A certain amount of time (about three years ago), in an attempt to find a way to export Windows EventLog, an opportunity was found to audit various events occurring on the server in a convenient way. <br><a name="habracut"></a><br>  Microsoft has made Windows practically incompatible with regular event logging systems (syslog) with its ‚Äúgood‚Äù technologies, but left a small loophole that can be used. <br>  The loophole is a combination of SNMP trap and the evntwin system event export program. <br><br>  To use the bundle, you need a configured snmptrapd, as well as an activated SNMP service on a windows server (added via ‚Äúadd / remove components‚Äù). <br><br>  First of all, you need to configure the server to which messages from the Eventlog will be reset. <br><img src="https://habrastorage.org/getpro/habr/post_images/1c1/7c9/ad1/1c17c9ad14770e0f124722ad4f7d16b4.png"><br>  Once the service is configured, run the program evntwin.exe <br>  <a href="http://technet.microsoft.com/en-us/library/cc759390%2528WS.10%2529.aspx">technet.microsoft.com/en-us/library/cc759390%28WS.10%29.aspx</a> <br>  How it looks can be seen in the following screenshot. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/305/41c/f31/30541cf31ac512c304c09597c33b6f2c.png"></a> <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/7e0/9e3/bbe/7e09e3bbe128b6070089d27ed29b00a0.png"></a> <br><br>  The principle of using evntwin is simple.  You select the category and event code that interests you and add them to the list.  When an event occurs, the message will be simultaneously saved in the EventLog, and will also be ‚Äúdumped‚Äù to the monitoring server. <br><br>  On the monitoring server in snmptrapd.conf you need to add a line handler. <br><blockquote><ol><li> <code><font color="black">authCommunity log,execute public format1 <font color="#0000ff">Trap</font> from %B format2 <font color="#0000ff">Trap</font> from %B traphandle default /usr/ <font color="#0000ff">local</font> /etc/trapd.pl</font></code> </li> <li> <code><font color="black">authCommunity log,execute public format1 <font color="#0000ff">Trap</font> from %B format2 <font color="#0000ff">Trap</font> from %B traphandle default /usr/ <font color="#0000ff">local</font> /etc/trapd.pl</font></code> </li> <li> <code><font color="black">authCommunity log,execute public format1 <font color="#0000ff">Trap</font> from %B format2 <font color="#0000ff">Trap</font> from %B traphandle default /usr/ <font color="#0000ff">local</font> /etc/trapd.pl</font></code> </li> <li> <code><font color="black">authCommunity log,execute public format1 <font color="#0000ff">Trap</font> from %B format2 <font color="#0000ff">Trap</font> from %B traphandle default /usr/ <font color="#0000ff">local</font> /etc/trapd.pl</font></code> </li> </ol></blockquote><br><br>  The handler itself is written by me on perl, the code can be taken from the link <a href="http://aborche.com/pics/topics/events/trapd.pl.txt">trapd.pl</a> (It is not recommended to copy-paste the highlighted code from the post, it is better to take the link).  It parses incoming trap messages and forms a letter to administrators. <br><br><blockquote> <code><font color="black"><font color="#696969">#!/usr/bin/perl</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">use</font> vars qw / <font color="#cc6633">$hostname</font> $source <font color="#cc6633">$oid</font> @data <font color="#cc6633">$trap $error</font> /;&lt;br/&gt; &lt;br/&gt;my @indata = (&lt;&gt;);&lt;br/&gt; <font color="#cc6633">$trap</font> -&gt;{hostname} = shift(@indata);&lt;br/&gt; <font color="#cc6633">$trap</font> -&gt;{source} = shift(@indata);&lt;br/&gt; <font color="#cc6633">$trap</font> -&gt;{uptime} = shift(@indata);&lt;br/&gt;(undef, <font color="#cc6633">$trap</font> -&gt;{uptime}) = split (/ /, <font color="#cc6633">$trap</font> -&gt;{uptime}, <font color="#008000">2</font> );&lt;br/&gt; <font color="#cc6633">$trap</font> -&gt;{oid} = shift(@indata);&lt;br/&gt;open OUT, <font color="#008000">"&gt;&gt;/var/log/snmptrapd.log"</font> ;&lt;br/&gt;chomp( <font color="#cc6633">$trap</font> -&gt;{hostname});&lt;br/&gt;chomp( <font color="#cc6633">$trap</font> -&gt;{source});&lt;br/&gt;chomp( <font color="#cc6633">$trap</font> -&gt;{uptime});&lt;br/&gt;chomp( <font color="#cc6633">$trap</font> -&gt;{oid});&lt;br/&gt; <font color="#0000ff">print</font> OUT <font color="#008000">"Hostname: $trap-&gt;{hostname}\n"</font> ;&lt;br/&gt; <font color="#0000ff">print</font> OUT <font color="#008000">"Source: $trap-&gt;{source}\n"</font> ;&lt;br/&gt; <font color="#0000ff">print</font> OUT <font color="#008000">"Uptime: $trap-&gt;{uptime}\n"</font> ;&lt;br/&gt; <font color="#cc6633">$trap</font> -&gt;{oid} =~ s/(.*)\.(\d+)$/ <font color="#cc6633">$2</font> /g;&lt;br/&gt; <font color="#0000ff">print</font> OUT <font color="#008000">"OID: $trap-&gt;{oid}\n"</font> ;&lt;br/&gt;my <font color="#cc6633">$str</font> = join( <font color="#008000">""</font> ,@indata);&lt;br/&gt; <font color="#cc6633">$str</font> =~ s/\t+|\r+|\" <font color="#696969">//g;</font> &lt;br/&gt; <font color="#cc6633">$str</font> =~ s/\n+/\n/g;&lt;br/&gt;my @data = split (/SNMPv2\-SMI\:\:enterprises\. <font color="#008000">311</font> \. <font color="#008000">1</font> \. <font color="#008000">13</font> \. <font color="#008000">1</font> \. <font color="#008000">9999</font> \.\d+\. <font color="#008000">0</font> \s/, <font color="#cc6633">$str</font> );&lt;br/&gt;undef <font color="#cc6633">$error</font> ;&lt;br/&gt;my <font color="#cc6633">$part</font> = <font color="#cc6633">$data</font> [ <font color="#008000">1</font> ];&lt;br/&gt;my @str = split(/\n/, <font color="#cc6633">$part</font> );&lt;br/&gt; <font color="#cc6633">$trap</font> -&gt;{subject} = <font color="#cc6633">$str</font> [ <font color="#008000">0</font> ];&lt;br/&gt; <font color="#cc6633">$trap</font> -&gt;{subject} =~ s/\:$ <font color="#696969">//;</font> &lt;br/&gt; <font color="#cc6633">$error</font> = <font color="#008000">"Hostname: $trap-&gt;{hostname}\n"</font> ;&lt;br/&gt; <font color="#cc6633">$error</font> .= <font color="#008000">"Source: $trap-&gt;{source}\n\n"</font> ;&lt;br/&gt; <font color="#0000ff">foreach</font> my <font color="#cc6633">$line</font> (@str)&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">if</font> ( <font color="#cc6633">$line</font> =~ /^(.*)\:\-/)&lt;br/&gt;  {&lt;br/&gt;    next;&lt;br/&gt;  }&lt;br/&gt; <font color="#0000ff">else</font> &lt;br/&gt;  {&lt;br/&gt;    push(@arrout, <font color="#cc6633">$line</font> );&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt; <font color="#cc6633">$error</font> .= join ( <font color="#008000">"\n"</font> ,@arrout);&lt;br/&gt; <font color="#0000ff">print</font> OUT @data, <font color="#008000">"\n"</font> ;&lt;br/&gt;&amp;mail_send;&lt;br/&gt; &lt;br/&gt;close OUT;&lt;br/&gt; <font color="#0000ff">exit</font> ( <font color="#008000">0</font> );&lt;br/&gt; &lt;br/&gt;sub mail_send&lt;br/&gt;{&lt;br/&gt; <font color="#696969">#  my @arr = shift;</font> &lt;br/&gt; <font color="#0000ff">use</font> Net::SMTP;&lt;br/&gt; <font color="#cc6633">$smtp</font> = Net::SMTP-&gt; <font color="#0000ff">new</font> ( <font color="#008000">'localhost'</font> );&lt;br/&gt; <font color="#cc6633">$smtp</font> -&gt;mail( <font color="#008000">'security@nagios.mydomain.ru'</font> );&lt;br/&gt; <font color="#cc6633">$smtp</font> -&gt;to( <font color="#008000">'account_admin@mydomain.ru'</font> );&lt;br/&gt; <font color="#cc6633">$smtp</font> -&gt;data();&lt;br/&gt; <font color="#cc6633">$smtp</font> -&gt;datasend( <font color="#008000">"To: account_admin\@mydomain.ru\n"</font> );&lt;br/&gt; <font color="#cc6633">$smtp</font> -&gt;datasend( <font color="#008000">"Subject: $trap-&gt;{subject}\n"</font> );&lt;br/&gt; <font color="#cc6633">$smtp</font> -&gt;datasend( <font color="#008000">"\n"</font> );&lt;br/&gt; <font color="#cc6633">$smtp</font> -&gt;datasend( <font color="#cc6633">$error</font> );&lt;br/&gt; <font color="#cc6633">$smtp</font> -&gt;dataend();&lt;br/&gt; <font color="#cc6633">$smtp</font> -&gt;quit;&lt;br/&gt;}&lt;br/&gt; &lt;br/&gt;</font></code> </blockquote> <br>  As a result, we get these beautiful letters <br><blockquote>  Hostname: bdc.mydoman.ru <br>  Source: UDP: [192.168.0.3]: 1081 <br><br>  Change Password Attempt: <br>  Target Account Name: pupkin_v <br>  Target Domain: MYDOM <br>  Target Account ID:% {S-1-5-21-1191404879-1933194844-817656539-2675} <br>  Caller User Name: pupkin_v <br>  Caller Domain: MYDOM <br>  Caller Logon ID: (0x0,0x39B1BD) <br></blockquote><br><blockquote>  Hostname: sadc.mydomain.ru <br>  Source: UDP: [192.168.0.4]: 1074 <br><br>  User Account Locked Out: <br>  Target Account Name: ivanov_v <br>  Target Account ID:% {S-1-5-21-1191404879-1933194844-817656539-5229} <br>  Caller Machine Name: MX <br>  Caller User Name: SADC $ <br>  Caller Domain: MYDOM <br>  Caller Logon ID: (0x0,0x3E7) <br></blockquote><br><blockquote>  Hostname: sadc.mydomain.ru <br>  Source: UDP: [192.168.0.4]: 1072 <br><br>  Logon Failure: <br>  Reason: Unknown user name or bad password <br>  User Name: Popov_V <br>  Domain: MYDOM <br>  Logon Type: 3 <br>  Logon Process: Advapi <br>  Authentication Package: Negotiate <br>  Workstation Name: SADC <br>  Caller User Name: SADC $ <br>  Caller Domain: MYDOM <br>  Caller Logon ID: (0x0,0x3E7) <br>  Caller Process ID: 580 <br>  Source Network Address: 192.168.0.20 <br>  Source Port: 36018 <br></blockquote><br>  Since we are only subscribed to messages that interest us, we do not see the rest of the system garbage from the EventLog. <br>  This system is very convenient in case of virus outbreaks like Kido, when you cannot immediately understand where everything went from to reproduce or when the system passwords are brute force.  Because Logon Failure is clearly visible and the name of the machine with which the attempt was unsuccessful. <br><br>  Good work for you. <br>  PS: the finished config with the categories shown in the screenshot is <a href="">here</a> <br><br> <code><font>(C) Aborche 2009</font> <br> <img src="http://aborche.com/pics/aborchelogo.jpg"></code> </div><p>Source: <a href="https://habr.com/ru/post/65652/">https://habr.com/ru/post/65652/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../65644/index.html">Extreme Radio</a></li>
<li><a href="../65645/index.html">Compatibility test: HTC Diamond 2</a></li>
<li><a href="../65646/index.html">Idea - software installer</a></li>
<li><a href="../65650/index.html">As we thought out and drew the interface interface</a></li>
<li><a href="../65651/index.html">About sore: Skype and Hitler</a></li>
<li><a href="../65653/index.html">How to build a sector on Google Maps?</a></li>
<li><a href="../65654/index.html">Twitter homepage redesign</a></li>
<li><a href="../65656/index.html">Django 1.1</a></li>
<li><a href="../65657/index.html">Did you share the Internet,% username%?</a></li>
<li><a href="../65658/index.html">Virtual war with their victories and defeats</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>