<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Operating systems from scratch; Level 1 (younger half)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This part is dedicated to improving Rust skills and writing a couple of useful utilities and libraries. Let's write drivers for GPIO, UART and the bui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Operating systems from scratch; Level 1 (younger half)</h1><div class="post__text post__text-html js-mediator-article"><p><img align="left" width="300" title="KPVD" src="https://habrastorage.org/webt/xr/xf/no/xrxfnoi60gac3muzdxwjna1fa2g.gif">  This part is dedicated to improving Rust skills and writing a couple of useful utilities and libraries.  Let's write drivers for GPIO, UART and the built-in timer.  Implement the XMODEM protocol.  Using this all, we will write a simple shell and loader.  Before reading it is <em>strongly recommended to</em> make sure that you read the <a href="https://doc.rust-lang.org/book/second-edition/">Book</a> .  At least from start to finish.  For the lazy, but slightly more experienced, we can recommend <a href="https://learnxinyminutes.com/docs/rust/">this</a> .  In Russian, you can pick <a href="https://github.com/ruRust/rust_book_2ed/tree/ru_version/second-edition/src">it up here</a> . </p><br><p>  Well, of course bypassing the <a href="https://habrahabr.ru/post/349248/">zero level is</a> absolutely not worth it.  Also, about half of this part does not require raspberries. </p><a name="habracut"></a><br><h2 id="poleznye-materialy">  Useful materials </h2><br><ul><li>  <a href="https://doc.rust-lang.org/book/second-edition/">Book v2.0</a> by Rust.  Translation into Russian <a href="https://github.com/ruRust/rust_book_2ed/tree/ru_version/second-edition/src">on the way</a> .  Pull the translation team (and help them).  This booklet is definitely worth reading at least to those who have not read. </li><li>  <a href="https://doc.rust-lang.org/nightly/std/">Documentation</a> for the standard library Rust.  There everything is ready, which is in the standard package. </li><li>  <a href="https://docs.rs/">docs.rs</a> - there you can read documentation on various libraries. </li><li>  <a href="https://linux.die.net/man/">Mana online</a> download for free without registration and SMS.  RTFM! </li><li>  Wiki article on the <a href="https://en.wikipedia.org/wiki/XMODEM">XMODEM</a> protocol.  For general development and those interested in the history of occurrence.  For the implementation will help a little,  almost no way. </li><li>  <a href="https://web.stanford.edu/class/cs140e/assignments/1-shell/data/XMODEM.txt">Another</a> XMODEM <a href="https://web.stanford.edu/class/cs140e/assignments/1-shell/data/XMODEM.txt">document</a> . </li><li>  <a href="https://web.stanford.edu/class/cs140e/docs/BCM2837-ARM-Peripherals.pdf">BCM2837</a> - this is about the pro Malinki.  In the same place as last time. </li></ul><br><h2 id="faza-0-nachalo-raboty">  Phase 0: Getting Started </h2><br><p>  Just in case, be sure to use course-compatible hardware and software: </p><br><ul><li>  Modern 64-bit Unix-like OS: Linux, macOS or BSD </li><li>  Do you have a suitable USB connector (unauthorized can use attachments) </li></ul><br><p> In addition, the following programs should be installed: <code>git</code> , <code>wget</code> , <code>tar</code> , <code>screen</code> , <code>make</code> and all that was required for the <a href="https://habrahabr.ru/post/349248/">zero level</a> .  For this part you will need to install <code>socat</code> . </p><br><p>  If last time you managed to run everything you need under Windows, then this time everything should work.  But if suddenly there is no, then no support.  Neither I, nor the author of the <a href="https://web.stanford.edu/class/cs140e/assignments/1-shell/">original</a> has a Venda at hand or a desire to dig into it. </p><br><h3 id="poluchenie-koda">  Getting the code </h3><br><p>  You can clone the code for this part like this: </p><br><pre> <code class="hljs ruby">git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/web.stanford.edu/class</span></span><span class="hljs-regexp"><span class="hljs-regexp">/cs140e/assignments</span></span><span class="hljs-regexp"><span class="hljs-regexp">/1-shell/skeleton</span></span>.git <span class="hljs-number"><span class="hljs-number">1</span></span>-shell</code> </pre> <br><p>  Feel free to explore the contents of the repository yourself. </p><br><h3 id="voprosy">  Questions </h3><br><p>  There will be <em>questions</em> in this and all following labs.  You can answer them directly in the comments using <em>spoilers</em> .  Here is an example: </p><br><blockquote>  <strong>How do we configure and use other GPIO contacts?</strong>  [assignment0] <br><br>  Last time, we used a 16 pin GPIO in the name of LED blinking.  Using the registers <code>GPFSEL1</code> , <code>GPSET0</code> and <code>GPCLR0</code> .  And if we use pin 27, which registers will be useful to us?  And what is the physical contact of this 27 GPIO pin? </blockquote><p>  The square brackets indicate the file name inside the <code>questions/</code> directories.  This is not particularly important for us, since it is necessary to reply in the comments  Do not read other people's answers until you are sure that you answered them yourself.  Otherwise, not interesting.  But these tags can be used as headlines for spoilers.  But I advise you to first write in these files.  For comfort. </p><br><h2 id="faza-1-ferris-wheel-igra-slov-ne-perevoditsya">  Phase 1: Ferris Wheel (pun is not translated) </h2><br><img align="right" width="300" title="Ferris - The Unofficial Rust Masque" src="https://habrastorage.org/getpro/habr/post_images/2e9/6d7/6f9/2e96d76f9508a67dfbaac4c5a8fdb503.svg"><br><p>  (This part can be completely skipped if you already have enough deep knowledge of Rasta.) </p><br><p>  For the sake of training, we will edit the program on Rust with some selfish goals.  Some should be compiled after editing.  Others <strong>should not</strong> compile.  For the third, tests should complete successfully. </p><br><p>  In the bowels of the catalog <code>ferris-wheel/</code> you can find the following: </p><br><ul><li>  <code>compile-fail</code> - contains code that must be broken so that it does not compile </li><li>  <code>compile-pass</code> - contains code that needs to be fixed exactly before compilability </li><li>  <code>run-pass</code> - contains a code with tests that should be green </li><li>  <code>questions</code> - in theory for questions, but we have already agreed that you can put all this in the comments </li></ul><br><p>  There still is a test.sh <code>test.sh</code> .  It checks the correctness of the assignments.  If you run it, it will quite popularly explain where and what is not quite as expected.  Sort of: </p><br><pre> <code class="hljs vbscript">$ ./test.sh <span class="hljs-keyword"><span class="hljs-keyword">ERROR</span></span>: compile-pass/borrow<span class="hljs-number"><span class="hljs-number">-1.</span></span>rs failed <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> compile! <span class="hljs-keyword"><span class="hljs-keyword">ERROR</span></span>: compile-pass/<span class="hljs-keyword"><span class="hljs-keyword">const</span></span>.rs failed <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> compile! ... <span class="hljs-number"><span class="hljs-number">0</span></span> passes, <span class="hljs-number"><span class="hljs-number">25</span></span> failures</code> </pre> <br><p>  In addition, the script accepts the <code>-v</code> flag.  If this same flag is passed to the script, then errors that the compiler spits out will be shown: </p><br><pre> <code class="hljs mel">$ ./test.sh -v ERROR: compile-pass/borrow<span class="hljs-number"><span class="hljs-number">-1.</span></span>rs failed to compile! ---------------------- stderr -------------------------- <span class="hljs-keyword"><span class="hljs-keyword">warning</span></span>: unused variable: <span class="hljs-string"><span class="hljs-string">`z`</span></span> --&gt; /.../ferris-wheel/compile-pass/borrow<span class="hljs-number"><span class="hljs-number">-1.</span></span>rs:<span class="hljs-number"><span class="hljs-number">9</span></span>:<span class="hljs-number"><span class="hljs-number">9</span></span> | <span class="hljs-number"><span class="hljs-number">9</span></span> | let z = *y; | ^ | = note: #[warn(unused_variables)] on by <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> = note: to avoid this <span class="hljs-keyword"><span class="hljs-keyword">warning</span></span>, consider using <span class="hljs-string"><span class="hljs-string">`_z`</span></span> instead <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>[E0507]: cannot <span class="hljs-keyword"><span class="hljs-keyword">move</span></span> out of borrowed content --&gt; /.../ferris-wheel/compile-pass/borrow<span class="hljs-number"><span class="hljs-number">-1.</span></span>rs:<span class="hljs-number"><span class="hljs-number">9</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span> | <span class="hljs-number"><span class="hljs-number">9</span></span> | let z = *y; | ^^ | | | cannot <span class="hljs-keyword"><span class="hljs-keyword">move</span></span> out of borrowed content | <span class="hljs-keyword"><span class="hljs-keyword">help</span></span>: consider using a <span class="hljs-keyword"><span class="hljs-keyword">reference</span></span> instead: <span class="hljs-string"><span class="hljs-string">`&amp;*y`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>: aborting due to previous <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> ... <span class="hljs-number"><span class="hljs-number">0</span></span> passes, <span class="hljs-number"><span class="hljs-number">25</span></span> failures</code> </pre> <br><p>  This script also accepts a string as a filter.  If present, only those file paths ($ directory / $ filename) that match this filter will be checked.  For example: </p><br><pre> <code class="hljs rust">./test.sh <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ERROR</span></span></span></span>: compile-pass/<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">namespace</span></span></span></span>.rs failed to compile! ERROR: run-pass/<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">impl</span></span></span></span>.rs failed to compile! <span class="hljs-number"><span class="hljs-number">0</span></span> passes, <span class="hljs-number"><span class="hljs-number">2</span></span> failures</code> </pre> <br><p>  Does not interfere with one another and you can combine the filter and the <code>-v</code> key.  Something like this: <code>./test.sh -v filter</code> . </p><br><h3 id="skolko-mozhno-menyat">  How much can I change? </h3><br><p>  Each file contains a comment, which indicates how much you can spoil it (diff budget).  Those.  The maximum number of changes that can be made to fix the program.  Solutions that do not fit into this framework can be considered not passed. </p><br><p>  For example.  In the <code>compile-pass/try.rs</code> there is such a comment: </p><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">FIXME:</span></span></span><span class="hljs-comment"> Make me compile. Diff budget: 12 line additions and 2 characters.</span></span></code> </pre> <br><p>  It says that you can <em>add</em> no more than 12 lines of code (blank lines are also considered).  And <em>change</em> (add / change / delete) 2 characters.  You can use <code>git diff</code> to see the line changes.  And <code>git diff --word-diff-regex=.</code>  for the same, but by character. </p><br><p>  Another example: </p><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">FIXME:</span></span></span><span class="hljs-comment"> Make me compile! Diff budget: 1 line.</span></span></code> </pre> <br><p>  It kakbe tells us that you can <em>change</em> (add / change / delete) only one line of code. </p><br><h3 id="obschie-pravila">  General rules </h3><br><p>  After the changes, the intended functionality of the programs should be preserved.  Suppose that if the body of a certain function needs to be modified in such a way that it compiles, it will not be enough to add <code>unimplemented!()</code> .  If you are in doubt - try the best of what you can.  Well, or ask in the comments. </p><br><p>  In addition, it is absolutely not recommended to do the following dirty methods: </p><br><ul><li>  Change all these <code>assert!</code>  s </li><li>  Modify everything marked as "do not modify" </li><li>  Change comments about how much and what can be changed </li><li>  Move, rename or add any files </li></ul><br><p>  When all tasks are completed <code>test.sh</code> will display <code>25 passes, 0 failures</code> </p><br><blockquote>  Hint: the file name may contain the key to the solution. <br><br>  Hint: in <a href="https://gitter.im/ruRust/general">this cozy chats</a> will answer faster questions about Rust.  Faster than in the comments on this article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <strong>What happened?</strong>  <strong>What was repaired?</strong>  <strong>Why does this work?</strong>  [filename] <br><br>  For each program from this part, you should explain what was wrong with the source code.  Then clarify <del>  on hardcore </del>  what changes have been made and why these corrections do their dirty work.  Good explanations are welcome.  If you think that everything is so obvious to you, then you can not write.  If laziness - you can not write anything at all. </blockquote><br><h2 id="faza-2-oxidation-okislenie">  Phase 2: Oxidation </h2><br><img title="Clean edged weapons after their intended use." src="https://habrastorage.org/webt/6u/gc/mq/6ugcmqmnfcof5h6spkqpl1hjx8w.jpeg"><br><p>  At this stage, we will write a couple of libraries and one command line utility.  We will work in the subdirectories <code>stack-vec</code> , <code>volatile</code> , <code>ttywrite</code> and <code>xmodem</code> .  Here, too, there will be a number of questions that can be answered, if not broke.  Each part is controlled by Cargo.  At least here these commands can be called useful: </p><br><ul><li>  <code>cargo build</code> - build a program or library </li><li>  <code>cargo test</code> - run tests </li><li>  <code>cargo run</code> - application launch </li><li>  <code>cargo run -- $</code> - this way you can transfer flags when launching an application </li></ul><br><p>  About Cargo there is a separate booklet: <a href="https://doc.rust-lang.org/cargo/index.html">Cargo Book</a> .  From there you can learn the necessary info about how it all works in detail. </p><br><h3 id="subfaza-a-stackvec">  Subphase A: StackVec </h3><br><p>  One of the most important features that operating systems deal with is memory management.  When C, Rust, Java, Python, or practically any application in general calls <code>malloc()</code> , then when there is a shortage of memory, a system call is eventually used that requests additional memory from the operating system.  The operating system determines whether there is still any memory unused.  If so, then the OS will dry out a bit of the processor from this memory. </p><br><blockquote>  <strong>Memory allocation - <abbr title="Learn Latin, for in hell no one will speak English!">non penis canis est</abbr></strong> <br><br>  Modern OSes like all sorts of linups contain a lot of tweaks related to memory management.  For example, in the order of optimization crutches, when a certain amount of memory is requested, it is allocated virtually.  In this case, the physical memory is not allocated until the application tries to use this same memory.  On the other hand, the application creates an illusion of simplified distribution.  Operating systems are able to skillfully lie ( <img title="Habr stubbornly cuts emoticons. I had to get a whole cake" height="20" src="https://habrastorage.org/webt/af/4f/vn/af4fvnmtdn1coatqtm0fyz9ubk4.jpeg">  ). </blockquote><p>  Structures like <code>Vec</code> , <code>String</code> and <code>Box</code> inside use <code>malloc()</code> to allocate memory for their own needs.  This means that these structures require support from the operating system.  In particular, they require that OS was able to allocate memory.  We have not even begun this part yet (see in the next series), so we don‚Äôt have any form of memory management.  Accordingly, all these <code>Vec</code> we can not (yet) use. </p><br><p>  This is a concentrated crap for <code>Vec</code> - a good abstraction suitable in all respects!  It allows us to think in terms of <code>.push()</code> and <code>.pop()</code> without having to remember any subtleties.  Can we get something like <code>Vec</code> without a full memory allocator? </p><br><img title="This is clearly shown how NOT to use a stack." align="right" width="300" src="https://habrastorage.org/webt/bj/ee/zo/bjeezoviduiaeojuwfumrqrfvhe.gif"><br><p>  Of course.  The first thing that comes to mind is the preliminary allocation of memory with the subsequent transfer of it into some kind of structure that implements the necessary abstractions on top of this.  We can allocate memory statically directly in a binary file, or somewhere on the stack.  In both cases, such a memory must have a fixed size known in advance. </p><br><p>  In this subphase, we will implement a <code>StackVec</code> structure that provides api, similar to the one provided by <code>Vec</code> from the standard library.  But it uses a previously allocated piece of memory.  This very <code>StackVec</code> will come in handy when implementing the command line (in phase 3).  We will work in the <code>stack-vec</code> subdirectory.  In it you can already find the following items: </p><br><ul><li>  <code>Cargo.toml</code> - configuration file for Cargo </li><li>  <code>src/lib.rs</code> - here we will add the necessary code </li><li>  <code>src/tests.rs</code> - tests that will be run when you run the <code>cargo test</code> </li><li>  <code>questions/</code> - blanks for files with questions (we are not very interested) </li></ul><br><h4 id="interfeys-stackvec">  <code>StackVec</code> interface </h4><br><p>  <code>StackVec&lt;T&gt;</code> is created by calling <code>StackVec::new()</code> .  The argument for the function <code>new</code> is a slice of type <code>T</code>  The <code>StackVec&lt;T&gt;</code> implements many methods that are used in much the same way as those of <code>Vec</code> .  For example, take <code>StackVec&lt;u8&gt;</code> : </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> storage = [<span class="hljs-number"><span class="hljs-number">0u8</span></span>; <span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> vec = StackVec::new(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> storage); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">10</span></span> { vec.push(i * i).expect(<span class="hljs-string"><span class="hljs-string">"can push 1024 times"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i, v) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> vec.iter().enumerate() { <span class="hljs-built_in"><span class="hljs-built_in">assert_eq!</span></span>(*v, (i * i) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> last_element = vec.pop().expect(<span class="hljs-string"><span class="hljs-string">"has elements"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">assert_eq!</span></span>(last_element, <span class="hljs-number"><span class="hljs-number">9</span></span> * <span class="hljs-number"><span class="hljs-number">9</span></span>);</code> </pre> <br><p>  The <code>StackVec</code> type <code>StackVec</code> already declared in this form: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StackVec</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>, T: <span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { storage: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> [T], len: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, }</code> </pre> <br><h4 id="ponimanie-stackvec">  Understanding <code>StackVec</code> </h4><br><p>  There are a couple of questions about the <code>StackVec</code> device: </p><br><blockquote>  <strong>Why does <code>push</code> return a <code>Result</code> ?</strong>  [push fails] <br><br>  The <code>push</code> method from <code>Vec</code> , which is from the standard library, does not have any return value.  However, a <code>push</code> from <code>StackVec</code> has: it returns a result indicating that there may be some kind of error.  Why <code>StackVec::push()</code> fail to complete, unlike <code>Vec</code> ? <br><br>  <strong>Why do we need to limit <code>T</code> lifetime <code>'a</code> ?</strong>  [lifetime] <br><br>  The compiler will reject the <code>StackVec</code> : <br><pre> <code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StackVec</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>, T&gt; { buffer: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> [T], len: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> }</code> </pre> <br><br>  If we add the restriction <code>'a</code> to the type <code>T</code> , then everything will work: <br><pre> <code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StackVec</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>, T: <span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { buffer: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> [T], len: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> }</code> </pre> <br><br>  Why is this restriction required?  What will happen if Rust does not follow this restriction? <br><br>  <strong>Why <code>StackVec</code> require <code>T: Clone</code> for the <code>pop</code> method?</strong>  [clone-for-pop] <br><br>  The <code>pop</code> method from <code>Vec&lt;T&gt;</code> standard library is implemented for any <code>T</code> , however, the <code>pop</code> method for our <code>StackVec</code> is implemented only when <code>T</code> implements the <code>Clone</code> property.  Why should this be so?  What is wrong if this restriction is removed? </blockquote><br><h4 id="realizaciya-stackvec">  <code>StackVec</code> implementation </h4><br><p>  Implement all <code>unimplemented!()</code> Methods from <code>StackVec</code> in <code>stack-vec/src/lib.rs</code>  Each method already has documentation (from it it is clear what is required of you for example).  In addition to this, there are tests in the <code>src/tests.rs</code> file that help ensure the correctness of your implementation.  You can run tests using the <code>cargo test</code> command.  In addition, you need to implement the Deref, <code>DerefMut</code> and <code>IntoIterator</code> for the <code>StackVec</code> class.  And trey <code>IntoIterator</code> for <code>&amp;StackVec</code> .  Without the implementation of these treit tests will not pass.  As soon as you are sure that your implementation is correct and you are able to answer the proposed questions, go to the next subphase. </p><br><blockquote>  <strong>What tests require the implementation of <code>Deref</code> ?</strong>  [deref-in-tests] <br><br>  Read the entire test code from the <code>str/tests.rs</code> .  What tests did not want to compile if there was no implementation of <code>Deref</code> ?  And what about <code>DerefMut</code> ?  Why? <br><br>  <strong>In fact, the tests are not complete</strong> <br><br>  The proposed unit tests cover the basic functionality, but they do not check every sneeze.  Look for such spaces and add more tests to the god of tests in the name of great justice. <br><br>  Hint: solving from the zero phase <code>liftime</code> task can be useful. </blockquote><br><h3 id="subfaza-b-volatile">  Subphase B: <code>volatile</code> </h3><br><img align="left" width="200" src="https://habrastorage.org/webt/k2/ln/09/k2ln09cv4ye0e6dxxcyelvdk0gs.jpeg"><br><p>  In this part we will talk about volatile memory accesses and read the code in the <code>volatile/</code> subdirectory.  We will not write our code, but there are questions for self-testing. </p><br><p>  Like typical operating systems, compilers masterfully crank up very tricky tricks.  In the name of optimization, they are doing something that only looks like what you have planned.  In fact, there will be a very strong witch inside.  A good example of such a witch is the removal of a dead code.  When the compiler can prove that the code does not affect execution, the dead code is quickly and decisively cut out.  Suppose there is such a code: </p><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> y = &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> x; *y = <span class="hljs-number"><span class="hljs-number">10</span></span>; }</code> </pre> <br><p>  The compiler may think a little and reasonably that <code>*y</code> never read after writing.  For this reason, the compiler can simply exclude this part from the resulting binary file.  Continuing to reason in this vein, the compiler finds it suitable to cut the declaration itself <code>y</code> and then <code>x</code> .  In the end, the <code>f()</code> call will go under the knife. </p><br><p>  Optimizations of this type are very useful and valuable.  Thanks to them, programs are accelerated without affecting the results.  True, in some cases, such frauds can have unintended consequences.  For example, <code>y</code> will point to any register that is only writeable.  In this case, writing to <code>*y</code> will have quite visible effects without having to read <code>*y</code> .  If the compiler does not know this, then this part will simply get rid of this part at the optimization stage and our program will not work as expected. </p><br><p>  How do we convince the compiler that reading / writing something like this affects our cozy little world by itself?  That is what is meant by volatile memory accesses.  The compiler is afraid not to optimize access to such sites. </p><br><h4 id="rzhavyy-volatile">  Rusty <code>volatile</code> </h4><br><p>  In Rust, we can use the <code>read_volatile</code> and <code>write_volatile</code> to read and write raw pointers. </p><br><blockquote>  <strong>What kind of raw pointers are these?</strong> <br><br>  Up to now, we have had time to become familiar with the links (which are <code>&amp;T</code> and <code>&amp;mut T</code> ).  Raw (raw) pointers in Rust ( <code>*const T</code> and <code>*mut T</code> ) are the same links without tracking the borrow checker.  Reading / writing using these very raw pointers can lead to the same foot injuries that can often be seen with C and C ++ fans.  Rust considers such operations unsafe.  Accordingly, it is all mandatory to mark <code>unsafe</code> label.  More information about raw indexes is in the <a href="https://doc.rust-lang.org/nightly/std/primitive.pointer.html">documentation</a> . </blockquote><p>  Writing calls to <code>read_volatile</code> and <code>write_volatile</code> is sad enough each time (besides the fact that it can lead to annoying errors on the basis of depression).  Fortunately for us, Rust gives us the opportunity to make our lives easier and safer.  On the one hand, we can simply make a <code>volatile</code> wrapper (almost like the <code>volatile</code> keyword in a ny si) and ensure that every read / write will remain in our code.  As a bonus, we can define a wrapper that is read-only or write-only (there is no such thing in the nursery, the trunk was given and you are spinning as you like). </p><br><h4 id="vvedenie-v-volatile-readvolatile-writevolatile-i-uniquevolatile">  Introduction to <code>Volatile</code> , <code>ReadVolatile</code> , <code>WriteVolatile</code> and <code>UniqueVolatile</code> </h4><br><p>  The <code>volatile</code> in the <code>volatile/</code> directory (who would have thought?) Implements these four types, which do roughly what is evident from their name.  Read more in the documentation.  Call <code>cargo doc --open</code> directly in the <code>volatile/</code> directory to actually read this very documentation in a convenient form. </p><br><blockquote>  <strong>Why is <code>UniqueVolatile</code> ?</strong>  [unique-volatile] <br><br>  Both <code>Volatile</code> and <code>UniqueVolatile</code> allow you to work with volatile memory accesses.  Based on the documentation, what is the difference between these two types? </blockquote><p>  Open the code <code>src/lib.rs</code>  Read the code in the mura of their own skills.  After that (reading the code) answer the following couple of questions.  How to finish - you can go to the next subphase. </p><br><blockquote>  <strong>How are read and write restrictions organized?</strong>  [enforcing] <br><br>  The types <code>ReadVolatile</code> and <code>WriteVolatile</code> make it impossible to read and write the pointer, respectively.  How is this done? <br><br>  <strong>What is the advantage of using traits instead of the usual methods?</strong>  [traits] <br><br>  On closer examination, you can replace that each of the types implements only one of its own <code>new</code> methods.  All other methods somehow relate to the implementations of <code>Readable</code> , <code>Writeable</code> and <code>ReadableWriteable</code> .  What is the profit from all this?  Describe at least two advantages of this approach. <br><br>  <strong>Why are <code>read</code> and <code>write</code> safe, and <code>new</code> unsafe?</strong>  [safety] <br><br>  What should be true about <code>new</code> so that <code>read</code> and <code>write</code> can be considered safe?  Would it be safe instead to mark <code>new</code> as safe, and <code>read</code> and <code>write</code> opposite to unsafe? <br><blockquote>  Hint: read the documentation for all these methods. </blockquote><p>  <strong>Why do we force <code>new</code> use?</strong>  [pub-constructor] </p><br><p>  If the type <code>Volatile</code> was declared as follows: </p><br><pre> <code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Volatile</span></span></span></span>&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> T);</code> </pre> <br><p>  then a value of type <code>Volatile</code> could be created using <code>Volatile(ptr)</code> instead of calling <code>new</code> .  What is the use of creating our wrapper with the static call <code>new</code> ? </p><br><blockquote>  Hint: Consider the implications for security claims for both options. </blockquote><br></blockquote><br><hr><br><blockquote>  <strong>What do macros do?</strong>  [macros] <br><br>  What <code>readable!</code> macros do <code>readable!</code>  <code>writeable!</code>  and <code>readable_writeable!</code>  ? </blockquote><br><h3 id="subfaza-c-xmodem">  Subphase C: <code>xmodem</code> </h3><br><p>  In this subphase we implement the XMODEM file transfer protocol ( <code>xmodem/</code> subdirectory).  The main work goes in the file <code>xmodem/src/lib.rs</code> </p><br><p>  XMODEM is a simple file transfer protocol developed in 1977.  It has checksums of the packets, cancellation of the transmission and the ability to automatically retransmit in case of errors.  It is widely used to transmit information through serial interfaces like the UART.  The main point of the protocol is simplicity.  You can read more in the wiki: <a href="https://en.wikipedia.org/wiki/XMODEM">XMODEM</a> (anyone can translate the article into Russian). </p><br><h4 id="protokol">  Protocol </h4><br><p>  The protocol itself is described in some detail in the text file <a href="https://web.stanford.edu/class/cs140e/assignments/1-shell/data/XMODEM.txt">Understanding The X-Modem File Transfer Protocol</a> .  We will repeat something from the description right here. </p><br><blockquote>  <strong>Do not base your implementation on an explanation from Wikipedia!</strong> <br><br>  Although the explanation from pedevikii will be useful at a high level, many details will differ from what we will implement here.  Use Pedewikia as a protocol review only. </blockquote><p>  XMODEM is quite a binary protocol: raw Baitics are received and sent.  In addition, the protocol is half-duplex: at any time the sender or recipient sends data, but never both at once.  And finally, this is a packet protocol: the data is divided into blocks (packets) of 128 bytes.  The protocol determines which Baitics to send, when to send them, what they will denote and how to read them later. </p><br><p>  To begin with, we define several constants: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SOH: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> = <span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> EOT: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> = <span class="hljs-number"><span class="hljs-number">0x04</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ACK: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> = <span class="hljs-number"><span class="hljs-number">0x06</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NAK: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> = <span class="hljs-number"><span class="hljs-number">0x15</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CAN: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> = <span class="hljs-number"><span class="hljs-number">0x18</span></span>;</code> </pre> <br><p>   , <em></em>   <code>NAK</code> ,     <code>NAK</code>     .  ,     <code>NAK</code> ,     .   <code>NAK</code>    ,       . </p><br><p>  ,   ,     .      1.       (..  255),     0. </p><br><img align="right" width="300" src="https://habrastorage.org/getpro/habr/post_images/6f6/bdd/a8d/6f6bdda8d3fade91a6683dcd00c0f5e9.svg"><br><p>   , : </p><br><ol><li>   <code>SOH</code> </li><li>    </li><li>      ( <code>255 - $_</code> ) </li><li>    </li><li>     <br><ul><li>          256 </li></ul></li><li>      : <br><ul><li>   <code>NAK</code> ,       ( 10 ) </li><li>   <code>ACK</code> ,      </li></ul></li></ol><br><p>      ,    : </p><br><ol><li>     <code>SOH</code>   <code>EOT</code> <br><ul><li>    ,     </li><li>   <code>EOT</code>  ‚Äî   </li></ul></li><li>           <br><ul><li>      ‚Äî   </li></ul></li><li>          <br><ul><li>    ,    </li></ul></li><li>    (128 ) </li><li>      <br><ul><li>  Those.        256 </li></ul></li><li>           <br><ul><li>    ,    <code>NAK</code>     </li><li>    ,    <code>ACK</code>     </li></ul></li></ol><br><p>  ,   ,  ,     <code>CAN</code> .       <code>CAN</code> ‚Äî     . </p><br><p>   , : </p><br><ol><li>   <code>EOT</code> </li><li>   <code>NAK</code> (    ‚Äî  ) </li><li>    <code>EOT</code> </li><li>   <code>ACK</code> (    ‚Äî  ) </li></ol><br><p>   ,  (   <code>EOT</code> ): </p><br><ol><li>   <code>NAK</code> </li><li>    <code>EOT</code> (   ,   ) </li><li>   <code>ACK</code> </li></ol><br><h4 id="realizaciya-xmodem">  XMODEM </h4><br><p>     XMODEM   .    ,     .   <code>expect_byte</code> , <code>expect_byte_or_cancel</code> , <code>read_packet</code>  <code>write_packet</code>   <code>src/lib.rs</code> .        <code>Xmodem</code> : <code>packet</code>  <code>started</code> .       ,    . </p><br><p>      <code>expect_byte</code>  <code>expect_byte_or_cancel</code> .       ( <code>read_byte</code>  <code>write_byte</code> )   <code>read_packet</code>  <code>write_packet</code> .  ,     ,   <code>transmit</code>  <code>receive</code> .  /       .    ,       .       <code>cargo test</code> .  ,       ‚Äî    . </p><br><blockquote> <strong>     std.</strong> <br><br>         <code>std::io</code> .    <code>std</code>      . <br><br> : <br>     <code>{read, write}_packet</code>   33  . <br><br>   <a href="https://doc.rust-lang.org/nightly/std/io/trait.Read.html">io::Read</a>  <a href="https://doc.rust-lang.org/nightly/std/io/trait.Write.html">io::Write</a>     (, ,       ). <br><br>    <code>?</code>  . <br><br>     ,     . </blockquote><br><h3 id="subfaza-d-ttywrite">  D: <code>ttywrite</code> </h3><br><p>          <code>ttywrite</code> .               XMODEM.       <code>xmodem</code>   .     <code>ttywrite/src/main.rs</code> .       <code>test.sh</code> .        -    <code>socat</code> . </p><br><blockquote> <strong>   ?</strong> <br><br>     ,        .   <em>  </em> .      <em>  </em> ,       .      UART,     . <br><br> <strong>  TTY?</strong> <br> TTY ‚Äî   (TeltTYpe writer).    ,      .   (  )            .        <code>/dev/</code> ,       tty. </blockquote><br><h4 id="interfeys-komandnoy-stroki">    </h4><br><p>    <code>ttywrite</code>      -   .     <a href="https://github.com/TeXitoi/structopt">structopt</a> ,     <a href="https://clap.rs/">clap</a> .         ,  ,        <code>Cargo.toml</code> . <a href="https://github.com/TeXitoi/structopt">structopt</a>        .     ,       ,  <a href="https://github.com/TeXitoi/structopt">structopt</a>    . </p><br><p>   ,    ,      <code>--help</code> .    ,      <code>cargo run</code>        <code>--</code>   .   : <code>cargo run -- --help</code> .     .     <code>main.rs</code> .      <code>Opt</code> .         . </p><br><blockquote> <strong> ,     ?</strong> [invalid] <br><br>         .   <code>-f</code>  <code>idk</code> .  <code>structopt</code> ,      ? </blockquote><p>   ,       .       .     ,      . </p><br><h4 id="obschenie-s-posledovatelnym-ustroystvom">     </h4><br><p>  <code>main</code>    <a href="https://docs.rs/serial/0.4.0/serial/fn.open.html">serial::open</a> .   <code>open</code>   <a href="https://docs.rs/serial/">serial</a> ,     .  <code>open</code>  <a href="https://docs.rs/serial-unix/0.4.0/serial_unix/struct.TTYPort.html">TTYPort</a> ,    / /   (  <code>io::Read</code>  <code>io::Write</code> ).          (   <code>SerialDevice</code> ). </p><br><h4 id="napisanie-koda">   </h4><br><p>   <code>ttywrite</code> .         ,    ,    <code>opt</code>  <code>main</code> .       ,     <code>stdin</code> .        .       .    <code>-r</code> ,         .    ,      <code>xmodem</code>   .          (  ). </p><br><p>     XMODEM     <code>Xmodem::transfer</code>  <code>Xmodem::transmit_with_progress</code>    .  <code>transmit_with_progress</code>       .   <del>  </del>        : </p><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">progress_fn</span></span></span></span>(progress: Progress) { <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"Progress: {:?}"</span></span>, progress); } Xmodem::transmit_with_progress(data, to, progress_fn)</code> </pre> <br><p>         <code>test.sh</code>   <code>ttywrite</code> .             : </p><br><pre> <code class="hljs vbscript">Opening PTYs... Running test <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10.</span></span> wrote <span class="hljs-number"><span class="hljs-number">333</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> input ... Running test <span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">10.</span></span> wrote <span class="hljs-number"><span class="hljs-number">232</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> input SUCCESS</code> </pre> <br><blockquote>  Tips <br><br>    <code>stdin</code>    <a href="https://doc.rust-lang.org/nightly/std/io/fn.stdin.html">io::stdin()</a> . <br><br>   <a href="https://doc.rust-lang.org/nightly/std/io/fn.copy.html">io::copy()</a>   . <br><br>  <code>main()</code>         35  . <br><br>   <a href="https://docs.rs/serial-unix/0.4.0/serial_unix/struct.TTYPort.html">TTYPort</a>       . </blockquote><br><hr><br><blockquote> <strong>  <code>test.sh</code>    <code>-r</code> ?</strong> [bad-test] <br><br>         <code>-r</code> .          XMODEM.     ,   ?      XMODEM   ?      ? </blockquote><br><hr><br><p> <strong>UPD</strong> <a href="https://habrahabr.ru/post/351774/"> </a>   .       .    . </p></div><p>Source: <a href="https://habr.com/ru/post/351082/">https://habr.com/ru/post/351082/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351070/index.html">Unexpected earnings difficulties on the Internet</a></li>
<li><a href="../351072/index.html">Password change: 10 steps to good implementation</a></li>
<li><a href="../351074/index.html">How to quickly write and roll out in the production of machine learning algorithm</a></li>
<li><a href="../351078/index.html">Performance and runtime at the JPoint 2018 conference</a></li>
<li><a href="../351080/index.html">Accelerate javascript build using webpack 2-3</a></li>
<li><a href="../351084/index.html">Google leanback - big brother care</a></li>
<li><a href="../351086/index.html">Calculation of the timing and cost of projects: how is this done and is it possible to simplify the process?</a></li>
<li><a href="../351090/index.html">Welcome to the CocoaHeads Special Event March 24</a></li>
<li><a href="../351092/index.html">Count Joseph Flavius: whom to kill first</a></li>
<li><a href="../351094/index.html">How to build a GSM phone based on SDR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>