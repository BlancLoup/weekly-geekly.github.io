<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Eternal photo archive for home</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I do not understand the desire to nostalgic for old photos. But the girls can not be undone, so I had to think about the repository for all, so that t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Eternal photo archive for home</h1><div class="post__text post__text-html js-mediator-article"><p>  I do not understand the desire to nostalgic for old photos.  But the girls can not be undone, so I had to think about the repository for all, so that they no longer pestered to show off karapuz and seals from the company.  I do not want to upload all the pictures in a public cloud. </p><br><p><img src="https://sun9-5.userapi.com/c824503/v824503892/102a5f/mOdkYMGDKhs.jpg" alt="image"></p><br><h4 id="teoriya">  Theory </h4><br><p>  The service life of the SSD drive is theoretically unlimited, if you do not exceed the number of rewriting cycles in the cell. </p><br><h4 id="zadacha">  Task </h4><br><p>  Make a storage and viewing of home photo archive from any device in the house, <br>  and put away for the next 10 or 20 years.  At the same time, it is possible to upload and view photos from any device connected to the internet, I do not use public storage services and without installing additional client software. </p><br><p>  The choice of glands is subjective, but for myself I have formulated a requirement for a small form factor.  In addition, everything that is hidden from the eyes in the apartment, as a rule, lies in a fire-hazardous place, for this we wanted power in USB, and a minimum of wires. </p><a name="habracut"></a><br><p>  As a result, I bought a set of Raspberry Pi 3b (Malinka) - 2000r in a well-known Chinese store, an aluminum box usb-sata 2.5 "- 500r, in an ordinary store SSD 240G 4100r. SD card for 64gb and a tube of ancient KPT-8 were found in a drawer of the table. </p><br><p>  <em>It is not known why, but we have an SSD drive that is packed in a usb-sata box is 80% more expensive than separately.</em> </p><br><h4 id="sborka-minikompyutera-raspberry-pi">  Build a minicomputer Raspberry Pi </h4><br><p>  Fascinating designer, requires attention and a little space on the table.  Mandatory tool only Phillips screwdriver.  I downloaded Ubuntu MATE and Win32 Disk Imager from the Raspberry website, recorded the system image on the SD card.  Nothing exciting, just press the Ok button.  Slightly modified the radiators that came with the raspberry.  I cut a piece of double-sided tape with a scalpel and smeared KPT-8, then carefully removed the protective paper from the remaining double-sided tape with tweezers and glued it into place. </p><br><p>  Connected to the TV, began to put the system and watch what current consumes Raspberry Pi. <br>  Raspberry Pi 3b current consumption is not more than 0.8A. </p><br><p>  Consumption of a usb-sata box with an SSD disk inside at rest 0.1A in operation no more than 0.36A <br>  After installing Ubuntu MATE, I tried to run a video on Raspberry.  I quickly realized that life was not successful.  In general, the system assembly was similar to a street cat, to which some hooligans tied a tin can to the tail. </p><br><p>  He opened SSH on the malinka and carried the entire structure to the mezzanine. </p><br><pre><code class="bash hljs">sudo apt install openssh-server sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> sshd</code> </pre> <br><pre> <code class="bash hljs">sudo ufw allow 22</code> </pre> <br><pre> <code class="bash hljs">ssh -X @ip__ Raspberry_Pi</code> </pre> <br><p>  The SSH port did not immediately open.  Managing the firewall through the gui program did not work, so I used UFW. </p><br><p>  I connected the whole system to the MTS RV6699 router.  USB power, wired data.  Prior to this, measure the current that RV6699 gives to the USB port.  USB to RV6699 quietly gives 1.5A and the whole system started up without problems.  But just in case, turned off the Wifi interface on the raspberry. </p><br><pre> <code class="bash hljs">ifconfig wlan0 down</code> </pre> <br><p>  Connect usb drive.  The system saw the device, but did not mount the file systems.  Proceeding from the desire not to be involved in the process of viewing family photos even in an uncertain future, the disk was formatted in advance in NTFS. </p><br><p>  created a new user named user </p><br><pre> <code class="bash hljs">adduser user</code> </pre> <br><p>  made the Photo folder to connect the drive to the home folder of the new user / home / user / </p><br><pre> <code class="bash hljs">mkdir Photo</code> </pre> <br><p>  I looked at the UUID of the partition on the usb disk. </p><br><pre> <code class="bash hljs">sudo blkid</code> </pre> <br><p>  I mounted the partition in the folder / home / user / Photo /, appending a line at the end of the / etc / fstab file </p><br><pre> <code class="bash hljs">UUID=<span class="hljs-string"><span class="hljs-string">"7C26EDB626ED7216"</span></span> /home/user/Photo/ ntfs rw,nls=utf8,gid=plugdev,<span class="hljs-built_in"><span class="hljs-built_in">umask</span></span>=0000 0 0</code> </pre> <br><p>  On the router from MGTS RV6699 fixed the ip address of the raspberry. </p><br><pre> <code class="bash hljs"> &gt; LAN &gt;  </code> </pre> <br><p>  I rebooted the system, I checked that everything starts as it should. </p><br><h4 id="vybor-interfeysa-dlya-zagruzki-i-prosmotra-faylov-v-arhive">  Selecting the interface for downloading and viewing files in the archive </h4><br><p>  It is clear that access should be through a browser, without additional add-ins and plug-ins.  Desirable fast and trendy.  Fashionable, so that the cubes on which the interface is assembled are no longer rotten.  I also really wanted the ability to view and edit files directly in the browser. </p><br><p>  As a result, I chose Cloud Commander.  Quick, you can watch pictures in the browser, written in node.js. </p><br><h4 id="ustanovka">  Installation </h4><br><p>  Just Node.js is not enough to install, it has its own installer for programs that needs to be installed additionally. <br>  First put Node.js </p><br><pre> <code class="bash hljs">sudo apt-get install nodejs</code> </pre> <br><p>  and the installer for her </p><br><pre> <code class="bash hljs">sudo apt-get install npm</code> </pre> <br><p>  Then we start the installation of the Cloud commander itself using the npm installer.  Installation also asks for root rights. </p><br><pre> <code class="bash hljs">sudo npm i cloudcmd -g</code> </pre> <br><p>  We start Cloud commander </p><br><pre> <code class="bash hljs">cloudcmd</code> </pre> <br><p>  FIG there does not work.  We google where the problem is.  Eventually: </p><br><pre> <code class="bash hljs">sudo ln -s /usr/bin/nodejs /usr/bin/node</code> </pre> <br><p>  and again.. </p><br><pre> <code class="bash hljs">$ cloudcmd url: http://localhost:8000/</code> </pre> <br><p>  Hurray works! </p><br><p>  We rule the Cloud commander config in the /usr/local/lib/node_modules/cloudcmd/json/config.json folder <br>  change the root parameter in order to immediately open a USB drive attached to the folder / home / user / Photo / </p><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"root"</span></span>: <span class="hljs-string"><span class="hljs-string">"/home/user/Photo/"</span></span></code> </pre> <br><p>  It remains to open the port for access and configure autorun. </p><br><p>  Open the port for access. </p><br><pre> <code class="bash hljs">sudo ufw allow 8000</code> </pre> <br><p>  Customize autorun. </p><br><p>  Create a text file cloudcmdstart in / usr / sbin / local to use it to launch Cloud commander. </p><br><pre> <code class="bash hljs"> &gt; cloudcmdstart mcedit cloudcmdstart</code> </pre> <br><p>  Writing text in cloudcmdstart </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh sudo -u user cloudcmd --root /home/user/Photo</span></span></code> </pre> <br><p>  Copy to / usr / sbin </p><br><pre> <code class="bash hljs">sudo cp cloudcmdstart /usr/sbin/</code> </pre> <br><p>  We inform the system that the cloudcmdstart file can be run. </p><br><pre> <code class="bash hljs">sudo chmod +x /usr/sbin/cloudcmdstart</code> </pre> <br><p>  After that we add it to the autorun at startup.  Open the file /etc/rc.local </p><br><pre> <code class="bash hljs">sudo mcedit /etc/rc.local</code> </pre> <br><p>  add the last but one line. </p><br><pre> <code class="bash hljs">/usr/sbin/cloudcmdwin</code> </pre> <br><p>  Save F2, exit F10 editor, reboot. </p><br><pre> <code class="bash hljs">sudo reboot</code> </pre> <br><p>  If everything is ok, after reloading, open on the phone connected to the apartment Wifi address. </p><br><pre> <code class="bash hljs">http://ip__RaspberryPi:8000</code> </pre> <br><p>  I uploaded photos from a computer to check, the speed of copying files is about 4mb (32mbits) per second, the bottleneck is usb-sata box. </p><br><h4 id="vozmozhnye-problemy-v-processe">  Possible problems in the process </h4><br><ol><li>  USB drive is read-only - check the mask in the write disk in the fstab file, there should be all zeros. </li><li>  apt-get install writes errors - update the system from the command line (approximately 1.5 hours) and don‚Äôt forget to write sudo before the command </li><li>  ancient test radios get tired - connect ssh -X user @ raspberry, then call sudo gedit path_to_file. </li><li>  Web interface is not always convenient - <a href="https://winscp.net/">https://winscp.net</a> </li></ol><br><p>  <strong>If access to the archive is needed only from home, then that's it.</strong> </p><br><p>  If you want to use the archive everywhere, then read on - there will be some BDSM. </p><br><p>  In the Cloud commander is not possible to enable access via HTTPS on this start to prepare crutches. </p><br><p>  First of all, we create a self-made certificate and install the Nginx web server. </p><br><p>  Certificates are tricky text files that are needed to encrypt the traffic between you and the device. </p><br><p>  How to make such a file yourself so as not to pay every year with different Thawte and other VeriSign steps are written <a href="http://help.ubuntu.ru/wiki/%25D1%2580%25D1%2583%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B4%25D1%2581%25D1%2582%25D0%25B2%25D0%25BE_%25D0%25BF%25D0%25BE_ubuntu_server/%25D0%25B1%25D0%25B5%25D0%25B7%25D0%25BE%25D0%25BF%25D0%25B0%25D1%2581%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C/certificates">here</a> . </p><br><p>  With a self-made certificate, the browser will swear and blush, but the connection will encrypt. </p><br><p><img src="https://sun9-5.userapi.com/c824503/v824503892/102a69/kPexgJ8sRrU.jpg" alt="image"></p><br><p>  Everything you need to create a self-made certificate in Ubuntu MATE is already installed. </p><br><pre> <code class="bash hljs">sudo apt-get install nginx</code> </pre> <br><p>  Nginx is installed by / etc / nginx, we need to edit its nginx.conf config to enable a password request when accessing Cloud Commander. </p><br><pre> <code class="bash hljs">sudo gedit /etc/nginx/nginx.conf</code> </pre> <br><p>  In the http {} section, add lines to enable password checking and show the path to the htpasswd password file. </p><br><pre> <code class="bash hljs">http { ....................... auth_basic <span class="hljs-string"><span class="hljs-string">"closed site"</span></span>; auth_basic_user_file /home/user/htpasswd; }</code> </pre><br><p>  Create a file with passwords to log in via Nginx </p><br><pre> <code class="bash hljs">&gt; htpasswd</code> </pre> <br><p>  We generate passwords using the form on the site <a href="http://seriyps.ru/crypt/htpasswd/">http://seriyps.ru/crypt/htpasswd/ we</a> copy to the file each account from a new line. </p><br><p>  Create a file with the configuration of our new site for secure access to the Cloud commander and put it in the / etc / nginx / sites-available folder </p><br><pre> <code class="bash hljs">&gt; cloudcmdsite.conf gedit cloudcmdsite.conf sudo cp cloudcmdsite.conf /etc/nginx/sites-enabled</code> </pre> <br><p>  the contents of the cloudcmdsite.conf file </p><br><pre> <code class="bash hljs">server { listen 443; client_max_body_size 712m; ssl on; ssl_certificate /home/user/ssl/server.crt; ssl_certificate_key /home/user/ssl/server.pem; server_name malinka.io; access_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/malinka.access.log; location / { proxy_pass http://127.0.0.1:8000; } }</code> </pre><br><p>  In this config: <br>  ssl_certificate /home/user/ssl/server.crt;  -your public certificate file <br>  ssl_certificate_key /home/user/ssl/server.pem;- your secret key from the certificate </p><br><p>  check that everything turned out. </p><br><pre> <code class="bash hljs">sudo nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> is successful</code> </pre> <br><p>  Now you need to configure the Cloud commander.  It works out of the box as root. </p><br><pre> <code class="bash hljs"> gedit /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/node_modules/cloudcmd/json/config.json</code> </pre> <br><p>  In the file we change the value in the lines: </p><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span> <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"   user   http://md5decrypt.net/en/Sha512/"</span></span> <span class="hljs-string"><span class="hljs-string">"console"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br><p>  save. </p><br><p>  open port 443 on the firewall. </p><br><pre> <code class="bash hljs">sudo ufw allow 443</code> </pre> <br><p>  reboot raspberry </p><br><pre> <code class="bash hljs"> sudo reboot</code> </pre> <br><p>  We forward the port on the router RV6699 </p><br><pre> <code class="bash hljs"> &gt;  &gt; NAT &gt; Port Mapping</code> </pre> <br><p>  then from the phone connected to the Wifi go to <strong>https</strong> : // your_the_ external_ip: port </p><br><p>  The login and password from the htpasswd file should be requested. </p><br><p>  According to the results for a small amount of money, I got the storage for photos that does not gleam, does not take place, and to which you can fasten a million more different features without any special distortions.  Bonus to summary time at home for the next 10 years as you want to think. <br>  Make sure that such a system is suitable only for home use. </p><br><h4 id="pochemu-eto-luchshe-chem-gotovyy-nas">  Why is this better than a ready-made NAS? </h4><br><p>  It's cheaper.  I became confident that the system would work without active cooling, and would not die from overheating when the time of a cheap Chinese fan approached.  The ability to not just upload files from the phone, but to view them immediately in the browser.  Create test files and edit them.  It seems to me that it works faster than a google drive, but this is my subjective opinion. </p><br><p>  What else can you do? </p><br><p>  To fasten authorization on Nginx using certificates, but I haven‚Äôt yet understood why. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/352494/">https://habr.com/ru/post/352494/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352482/index.html">Why go to Mobile World Congress in Barcelona and how to do it right</a></li>
<li><a href="../352484/index.html">Security Week 11: Doubtful Banking News, Miner Killer, Bank Imitation</a></li>
<li><a href="../352486/index.html">Big wad of dirt, part 2</a></li>
<li><a href="../352488/index.html">Conference DEFCON 18. "How I met with your girlfriend, or a new kind of Internet attacks." Sami Kamkar</a></li>
<li><a href="../352492/index.html">Using the Python Control Systems Library for designing automatic control systems</a></li>
<li><a href="../352496/index.html">Google closes goo.gl. Replaced by Firebase Dynamic Links</a></li>
<li><a href="../352498/index.html">Learning is light, or how to organize a master class in 2 days</a></li>
<li><a href="../352500/index.html">For beginners: 5 tips on github</a></li>
<li><a href="../352502/index.html">What's new in Swift 4.1?</a></li>
<li><a href="../352508/index.html">Heading "We read articles for you." December 2017 - January 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>