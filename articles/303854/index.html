<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unicorn that could</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the Microsoft development teams is already using the PVS-Studio analyzer in its work. This is good, but not enough. Therefore, I continue to de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unicorn that could</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/83f/b23/2fd/83fb232fddb56909af2c34f5f4a61400.png" alt="The Little Unicorn That Could" align="left">  One of the Microsoft development teams is already using the PVS-Studio analyzer in its work.  This is good, but not enough.  Therefore, I continue to demonstrate the benefits of static code analysis using Microsoft projects.  Three years ago we checked the project Casablanca and could not find anything in it.  For this project was awarded the medal "bezbazhny code."  Time passed, the project developed and grew.  In turn, the PVS-Studio analyzer has significantly advanced in its code analysis capabilities.  And finally, I can write an article about errors that the analyzer detects in the Casablanca project (C ++ REST SDK).  There are few errors, but the fact that now there are enough of them for writing an article speaks about the effectiveness of PVS-Studio. <br><a name="habracut"></a><br><h2>  Casablanca </h2><br>  As I noted in the annotation, we have already checked the draft Casablanca.  You can read about it in the article " <a href="http://www.viva64.com/ru/b/0189/">A small note about the project Casablanca</a> ". <br><br>  <a href="https://github.com/Microsoft/cpprestsdk">Casablanca (C ++ REST SDK)</a> is a small project written in modern C ++.  Speaking of the modern C ++ language, I mean that the semantics of move (move semantics), lambda-functions, auto and so on are actively used in the code.  New features in C ++ allow you to write shorter and more reliable code.  This is confirmed by the fact that finding errors in this project is not an easy task.  Although usually we <a href="http://www.viva64.com/ru/a/0084/">do</a> it extremely easily. <br><br>  For those interested in what other Microsoft projects we checked, I provide a list of articles devoted to these checks: <a href="http://www.viva64.com/ru/b/0400/">Xamarin.Forms</a> , <a href="http://www.viva64.com/ru/b/0372/">CNTK</a> , <a href="http://www.viva64.com/ru/b/0370/">Microsoft Edge</a> , <a href="http://www.viva64.com/ru/b/0398/">CoreCLR</a> , <a href="http://www.viva64.com/ru/b/0398/">Windows 8 Driver Samples</a> , Visual C ++ <a href="http://www.viva64.com/ru/b/0163/">2012/2013</a> , <a href="http://www.viva64.com/ru/b/0365/">CoreFX</a> , <a href="http://www.viva64.com/ru/b/0363/">Roslyn</a> , <a href="http://www.viva64.com/ru/b/0361/">Microsoft Code Contracts</a> , and An article about WPF Samples verification is coming soon. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, the Casablanca project is a sample of good, high-quality code.  Let's see what can still be found in it with the help of the PVS-Studio static code analyzer. <br><br><h2>  What did you find bad </h2><br>  <b>Fragment N1: typo</b> <br><br>  There is a <i>NumericHandValues</i> structure containing two members: <i>low</i> and <i>high</i> .  Here is the declaration of this structure: <br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NumericHandValues</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> low; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> high; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Best</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (high &lt; <span class="hljs-number"><span class="hljs-number">22</span></span>) ? high : low; } };</code> </pre> <br>  And now let's see how this structure is initialized in one place: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NumericHandValues </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNumericValues</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ NumericHandValues res; res.low = <span class="hljs-number"><span class="hljs-number">0</span></span>; res.low = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... }</code> </pre> <br>  PVS-Studio warning: V519 The 'res.low' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 130, 131. BlackJack_Client140 messagetypes.h 131 <br><br>  As you can see, accidentally two times initialized the member <i>low</i> , but at the same time they forgot to initialize <i>high</i> .  Thoughtful commentary is hard to write here.  Just no one is immune from typos. <br><br>  <b>Fragment N2: Memory Free Error</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> DealerTable::FillShoe(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> decks) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; ss(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[decks * <span class="hljs-number"><span class="hljs-number">52</span></span>]); .... }</code> </pre> <br>  PVS-Studio warning: V554 Incorrect use of shared_ptr.  The memory is allocated with 'new []' will be cleaned using 'delete'.  BlackJack_Server140 table.cpp 471 <br><br>  By default, a smart pointer such as <i>shared_ptr</i> to invoke an object will invoke the <i>delete</i> operator without square brackets <i>[]</i> .  In this case, it is wrong. <br><br>  The correct code should be as follows: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; ss(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[decks * <span class="hljs-number"><span class="hljs-number">52</span></span>], <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::default_delete&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[]&gt;());</code> </pre> <br>  <b>Fragment N3: lost pointer</b> <br><br>  The static member <i>s_server_api</i> is a smart pointer and is defined as follows: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;http_server&gt; http_server_api::s_server_api((http_server*)<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>);</code> </pre> <br>  Suspicion is caused by the following function code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> http_server_api::unregister_server_api() { pplx::extensibility::<span class="hljs-keyword"><span class="hljs-keyword">scoped_critical_section_t</span></span> lock(s_lock); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (http_server_api::has_listener()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> http_exception(_XPLATSTR(<span class="hljs-string"><span class="hljs-string">"Server API ..... attached"</span></span>)); } s_server_api.release(); }</code> </pre> <br>  PVS-Studio warning: V530.  cpprestsdk140 http_server_api.cpp 64 <br><br>  Note the "s_server_api.release ();".  After calling the release function, the smart pointer no longer owns the object.  The pointer to the object is ‚Äúlost‚Äù and the object will exist until the end of the program‚Äôs life. <br><br>  Most likely, we again encountered a typo.  I think they wanted to call the <a href="http://en.cppreference.com/w/cpp/memory/unique_ptr/reset"><i>reset</i></a> function, not the <a href="http://en.cppreference.com/w/cpp/memory/unique_ptr/release"><i>release</i></a> at all. <br><br>  <b>Fragment N4: wrong enum</b> <br><br>  There are two <i>BJHandState</i> and <i>BJHandResult enums in the project</i> , declared as follows: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> BJHandState { HR_Empty, HR_BlackJack, HR_Active, HR_Held, HR_Busted }; <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> BJHandResult { HR_None, HR_PlayerBlackJack, HR_PlayerWin, HR_ComputerWin, HR_Push };</code> </pre> <br>  And now let's look at the code fragment from the <i>PayUp</i> function: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> DealerTable::PayUp(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> idx) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( player.Hand.insurance &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; Players[<span class="hljs-number"><span class="hljs-number">0</span></span>].Hand.state == HR_PlayerBlackJack ) { player.Balance += player.Hand.insurance*<span class="hljs-number"><span class="hljs-number">3</span></span>; } .... }</code> </pre> <br>  PVS-Studio warning: V556 The values ‚Äã‚Äãof different enum types are compared.  Types: BJHandState, BJHandResult.  BlackJack_Server140 table.cpp 336 <br><br>  The <i>state</i> variable is of type <i>BJHandState</i> .  This means that the programmer is confused in the enumerations.  Apparently, the code should look like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( player.Hand.insurance &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; Players[<span class="hljs-number"><span class="hljs-number">0</span></span>].Hand.state == HR_BlackJack )</code> </pre> <br>  The funny thing is that this error actually does not affect the work of the program.  Thanks to a happy coincidence, the <i>HR_BlackJack</i> and <i>HR_PlayerBlackJack</i> constants <i>currently</i> have the same value, equal to 1. The fact is that both of these constants in the enumeration are in the same position in the list.  However, in the development process of the program this may change, and then a strange, incomprehensible mistake will arise. <br><br>  <b>Fragment N5: strange break</b> <br><pre> <code class="cpp hljs">web::json::<span class="hljs-function"><span class="hljs-function">value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AsJSON</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> iter = cards.begin(); iter != cards.end();) { jCards[idx++] = iter-&gt;AsJSON(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } .... }</code> </pre> <br>  PVS-Studio warning: V612 An unconditional 'break' within a loop.  BlackJack_Client140 messagetypes.h 213 <br><br>  The <i>break</i> statement in this code looks extremely suspicious.  A loop can perform a maximum of one iteration.  It's hard for me to say how this code should behave, but, most likely, something is wrong with it now. <br><br><h2>  Other stuff </h2><br>  In addition to the code snippets discussed above and claiming to be errors, the analyzer also found some inaccurate places.  For example, use postincrement for iterators. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> web::json::<span class="hljs-function"><span class="hljs-function">value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TablesAsJSON</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;BJTable&gt;&gt; &amp;tables)</span></span></span><span class="hljs-function"> </span></span>{ web::json::value result = web::json::value::<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> idx = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> tbl = tables.begin(); tbl != tables.end(); tbl++) { result[idx++] = tbl-&gt;second-&gt;AsJSON(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  PVS-Studio warning: V803 Decreased performance.  In case of a tbl is an iterator  Replace iterator ++ with ++ iterator.  BlackJack_Client140 messagetypes.h 356 <br><br>  This, of course, is not a mistake.  However, pre-increment is considered a good style: <i>++ tbl</i> .  For those who doubt that this makes sense, I refer to the following two articles: <ol><li>  Is it practical to use the prefix increment operator ++ it for iterators instead of postfix increment it ++.  <a href="http://www.viva64.com/ru/b/0093/">http://www.viva64.com/ru/b/0093/</a> </li><li>  Pre vs.  post increment operator - benchmark.  <a href="http://silviuardelean.ro/2011/04/20/pre-vs-post-increment-operator/">http://silviuardelean.ro/2011/04/20/pre-vs-post-increment-operator/</a> </li></ol><br>  In the library code there are 10 more places where iterator postincrement is used in cycles, but I do not see the point in citing them in the article. <br><br>  Consider another example when the analyzer points to an inaccurate code: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">acquire_protector</span></span></span><span class="hljs-class"> {</span></span> _acquire_protector(....); ~_acquire_protector(); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_size; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: _acquire_protector&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> _acquire_protector&amp;); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>* m_ptr; concurrency::streams::streambuf&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>&gt;&amp; m_buffer; };</code> </pre> <br>  PVS-Studio warning: V690 The '=' operator will still be generated by the compiler.  It is dangerous to use such a class.  cpprestsdk140.uwp.staticlib fileio_winrt.cpp 825 <br><br>  As you can see, the programmer has banned the use of the copy operator.  However, the object can still be copied using the copy constructor created by the default compiler. <br><br><h2>  Conclusion </h2><br>  Finally, the PVS-Studio analyzer was able to find fault with something.  There were few errors, but still they are.  And this means that if you use static analysis not once, as I have done now, but regularly, then you can prevent a lot of errors at an early stage.  It is better to correct the errors immediately after writing the code, rather than in the process of testing, debugging, and even more so after one of the users reports a defect. <br><br><h2>  Additional links </h2><br><ol><li>  The title of the article is a reference to the fairy tale "The <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B0%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B7%25D0%25B8%25D0%25BA,_%25D0%25BA%25D0%25BE%25D1%2582%25D0%25BE%25D1%2580%25D1%258B%25D0%25B9_%25D1%2581%25D0%25BC%25D0%25BE%25D0%25B3">Engine that Smog</a> ". </li><li>  Link where you can download the PVS-Studio analyzer and try to check one of your projects in C, C ++ or C #: <a href="http://www.viva64.com/ru/pvs-studio-download/">http://www.viva64.com/en/pvs-studio-download/</a> </li></ol><br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0406/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="http://www.viva64.com/en/b/0406/">The Little Unicorn That Could</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/303854/">https://habr.com/ru/post/303854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303840/index.html">Java library for the efficient transfer of CSS and JavaScript</a></li>
<li><a href="../303842/index.html">Neural network as a predictor for PNG image coding</a></li>
<li><a href="../303844/index.html">NetApp ONTAP & ESXi 6.x tuning</a></li>
<li><a href="../303850/index.html">Roskomnadzor blocked web services Amazon S3</a></li>
<li><a href="../303852/index.html">ALM Advisor - an online ALM-tool for assessing a planned or existing working environment.</a></li>
<li><a href="../303856/index.html">Welcome to YAPC :: Russia 2016</a></li>
<li><a href="../303858/index.html">What are the next steps?</a></li>
<li><a href="../303860/index.html">What should be the structure of the IT system of a small company / view from the director of the company /</a></li>
<li><a href="../303862/index.html">Internet advertising market 10 years ago and now</a></li>
<li><a href="../303866/index.html">We work with Azure IoT devices from UWP applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>