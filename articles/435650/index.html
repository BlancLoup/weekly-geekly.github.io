<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to embed C-library in Swift-framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In 2014, Swift was introduced, a new language for developing Apple's ecosystem applications. The novelty brought not only new features and functions, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to embed C-library in Swift-framework</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/gg/tp/h0/ggtph083gn7erbdli6yhp2kxh_k.jpeg"><br><br>  In 2014, Swift was introduced, a new language for developing Apple's ecosystem applications.  The novelty brought not only new features and functions, but also problems - to those who wanted to use the good old C-libraries.  In this article I will discuss one of them - the C-library banding in a Swift framework.  There are several ways to solve it;  in this case, I will explain how to do this with clang explicit modules. <br><br>  For example, we take the external C library <a href="http://giflib.sourceforge.net/">libgif</a> and embed it in our Swift framework GifSwift.  If you want to see the result immediately, you can see the full project <a href="https://github.com/turbulem/GifSwift">here</a> . <br><a name="habracut"></a><br><h1>  Libgif preparation </h1><br>  Before embedding the libgif library into our project, it should be compiled from sources. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Download the latest version of tarball <a href="https://sourceforge.net/projects/giflib/files/">here</a> . <br></li><li>  Unpack the archive, use the console to go to the folder and run: <br><br><pre><code class="plaintext hljs">./configure &amp;&amp; make check</code> </pre> <br>  <b>Note:</b> for simplicity, we are building a library for the x86-64 platform, and therefore it will only work in an iOS simulator or on macOS.  Building a multi-architecture static library is a separate topic, which I don‚Äôt touch on in this article.  Useful instructions can be found <a href="https://medium.com/%40hassanahmedkhan/a-noobs-guide-to-creating-a-fat-library-for-ios-bafe8452b84b">here</a> . <br></li><li>  If everything goes <code>${lib_gif_source}/lib/.libs</code> , the library files can be found in <code>${lib_gif_source}/lib/.libs</code> .  We are interested in two files: <br><br><pre> <code class="plaintext hljs">lib/.libs/libgif.a #   lib/gif_lib.h # </code> </pre></li></ol><br><h1>  Project Setup </h1><br>  Now we will adjust the project to our needs. <br><br><ol><li>  Create a new project using the template Cocoa Touch Framework, give it the name <i>GifSwift</i> . <br></li><li>  Add the <i>libgif</i> library files we created to a separate group within the project. <br></li><li>  Add a new target for the test application to the project to see the result. <br></li></ol><br>  The final project structure should look like this: <br><br><img src="https://habrastorage.org/webt/jz/7_/fw/jz7_fw3f9ht0opyxv5moxnr8v18.png"><br><br><h1>  Import to Swift </h1><br>  In order to import the C library into Swift, we need to describe it as a <a href="https://clang.llvm.org/docs/Modules.html">module</a> .  The description is a <b>.modulemap</b> file containing a list of header files for import and static libraries for linking.  The resulting module can be imported into Swift or Objective-C code (using <code>@import</code> ). <br><br>  This method of importing the library into the framework will work in most cases (read more about this approach <a href="https://medium.com/swift-and-ios-writing/using-a-c-library-inside-a-swift-framework-d041d7b701d9">here</a> ).  It is great if you are creating an internal framework or simply breaking your application into modules.  But this method also has disadvantages.  For example, it is ineffective if you want to transfer your library to someone using Carthage, Cocoapods or in the sense of a binary artifact.  The reason is that the resulting framework is generally not portable, because when compiled it is tied to a specific location of the header files and libraries from the module map on your computer. <br><br><h1>  Explicit module </h1><br>  To circumvent these limitations, we will use another way - an <b>explicit</b> module for the library.  An explicit-module is a module that is declared a sub-module with the <i>explicit</i> keyword, is placed in the parent module, and is <i>not imported</i> automatically.  It works like <code>*_Private.h</code> for Objective-C frameworks.  If you want to use the APIs declared in it, you need to import the module <b>explicitly.</b> <br><br>  We create an explicit module for the C-library inside the framework.  To do this, we need to perform a redefinition of the generated XCode module.  Also note that we do not specify the libgif.a library for linking (link gif), but instead do it right in the project using the Xcode interface. <br><br>  <i>Note: To learn more about explicit modules, <a href="https://clang.llvm.org/docs/Modules.html">please click here.</a></i> <br><br><ol><li>  Add a file called <i>GifSwift.modulemap</i> to the root folder of the project: <br><br><pre> <code class="plaintext hljs">framework module GifSwift { umbrella header "GifSwift.h" explicit module CLibgif { private header "gif_lib.h" } export * }</code> </pre><br>  This file contains the specification for the explicit <i>CLibgif</i> module and consists of one declared header file (since there is just one such in our library).  The file is loaded into the resulting module for the framework. <br></li><li>  The file with the description of the module does not need to be added to the framework, but it must be specified in the settings of the target: <br><br><pre> <code class="plaintext hljs">Build Settings ‚Äî Packaging ‚Äî Module Map (MODULEMAP_FILE) = $SRCROOT/GifSwift/GifSwift.modulemap</code> </pre> </li><li>  The libgif files must be added to the target framework in the form of a private header ( <i>gif_lib.h</i> ) and a static library ( <i>libgif.a</i> ).  Note that the header file for the C library is added to the target as private.  This is necessary for our explicit module.  Nothing prevents to add this header file as public, but our task is to hide the implementation details with the simplest possible means. <br><br><img src="https://habrastorage.org/webt/7d/jm/vv/7djmvvleep47_kqy7za8yys17f8.png"><br></li><li>  Now you can import an explicit module inside the framework using <code>import GifSwift.CLibgif</code> <br></li></ol><br><h1>  Swift-wrapper </h1><br>  Now you can do the interface of our framework.  There is enough one class, which is a gif with a couple of properties: <br><br><pre> <code class="plaintext hljs">import Foundation import GifSwift.CLibgif public class GifFile { private let path: URL private let fileHandlePtr: UnsafeMutablePointer&lt;GifFileType&gt; private var fileHandle: GifFileType { return self.fileHandlePtr.pointee } deinit { DGifCloseFile(self.fileHandlePtr, nil) } // MARK: - API public init?(path: URL) { self.path = path let errorCode = UnsafeMutablePointer&lt;Int32&gt;.allocate(capacity: 1) if let handle = path.path.withCString({ DGifOpenFileName($0, errorCode) }) { self.fileHandlePtr = handle DGifSlurp(handle) } else { debugPrint("Error opening file \(errorCode.pointee)") return nil } } public var size: CGSize { return CGSize(width: Double(fileHandle.SWidth), height: Double(fileHandle.SHeight)) } public var imagesCount: Int { return Int(fileHandle.ImageCount) } }</code> </pre> <br>  <code>GifFile.swift</code> wraps low-level APIs for file processing and gains access to some properties, mapping them to more convenient Foundation types. <br><br><h1>  Check </h1><br>  In order to test our library, I added the file <i>cat.gif</i> to the project: <br><br><pre> <code class="plaintext hljs">import UIKit import GifSwift class ViewController: UIViewController {   override func viewDidLoad() {       super.viewDidLoad()       if let file = GifFile(path: Bundle.main.url(forResource: "cat", withExtension: "gif")!) {           debugPrint("Image has size: \(file.size) and contains \(file.imagesCount) images")       }   } }</code> </pre> <br>  When running this code in the console, we will see the following: <br><br>  <b>" <i>Image has size: (250.0, 208.0) and contains 44 images"</i></b> <b><br><br></b> <h1>  <b>findings</b> </h1> <b><br></b>  The resulting framework contains everything you need to use, has a Swift interface, and by default hides the C code from clients.  However, this is not entirely true.  As I wrote above, importing <i>GifSwift.CLibgif</i> , you get access to all closed modules, but by default this method of encapsulation is enough to hide the implementation details of the framework. </div><p>Source: <a href="https://habr.com/ru/post/435650/">https://habr.com/ru/post/435650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435640/index.html">The event digest for HR-specialists in the field of IT in January 2019</a></li>
<li><a href="../435642/index.html">Pentax Auto 110: ‚Äúin which cam the camera?‚Äù</a></li>
<li><a href="../435644/index.html">Zoo afl phasers</a></li>
<li><a href="../435646/index.html">NB-IoT, Narrow Band Internet of Things. General information, technology features</a></li>
<li><a href="../435648/index.html">Bot generates textbooks from Wikipedia articles</a></li>
<li><a href="../435652/index.html">How not to continue passwords in Python scripts</a></li>
<li><a href="../435654/index.html">Pitfalls of custom CSS properties</a></li>
<li><a href="../435656/index.html">Rolls-Royce among scooters - Ninebot KickScooter ES4 by Segway</a></li>
<li><a href="../435658/index.html">Chinese internet censoring</a></li>
<li><a href="../435662/index.html">"Reliability and dependability as in Google" - and not only: translation of the article "Calculation of reliability of service"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>