<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>File formats for programs on FASM under Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When you create a program in assembler (for example, FASM will be shown) from under Windows OS, the question arises about which file format to choose....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>File formats for programs on FASM under Windows</h1><div class="post__text post__text-html js-mediator-article">  When you create a program in assembler (for example, FASM will be shown) from under Windows OS, the question arises about which file format to choose. <br>  To determine the format of the executable file being created, the ‚Äúformat‚Äù directive is used with the format identifier following it. <br>  Under the cut there is a brief description of the COM and EXE programs of the MZ and PE formats with a program template (in the form of the traditional ‚ÄúHello World!‚Äù). <br><a name="habracut"></a><br>  The default format is a simple binary file, it can also be selected with the ‚Äúformat binary‚Äù directive, which forms programs like .COM. <br>  ‚ÄúUse16‚Äù and ‚Äúuse32‚Äù instruct the assembler to generate a 16-bit or 32-bit code, ignoring the default setting for the selected output format.  "Use64" includes generating code for the long mode of x86 processors. <br>  The following describes the different output formats with directives specific to them. <br><br><h5>  .COM programs </h5><br>  Programs like .com after loading into memory are an unmodified representation of a program in machine language on a disk.  The .com format is one of the simplest executable file formats on the x86 architecture.  The size of the .com file is limited to 1 segment and is 64 KB, all data must be defined in the same code segment.  When a COM program starts working, all segment registers contain the address of the program segment prefix (PSP), a 256-byte (100h) block, which is reserved by the DOS operating system immediately before the COM or EXE program in memory.  Since the addressing starts at an offset of 100h from the beginning of the PSP, the ORG 100h directive is encoded in the program.  This directive sets the relative address to start the program.  The program loader uses this address for the command index. <br><br>  An example of a simple program in .COM format: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs cs">use16 ; <span class="hljs-number"><span class="hljs-number">16</span></span>-  org <span class="hljs-number"><span class="hljs-number">100</span></span>h ;    <span class="hljs-number"><span class="hljs-number">100</span></span>h mov dx,hello ; DX  . mov ah,<span class="hljs-number"><span class="hljs-number">9</span></span> ;  DOS. <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>h ;   DOS. mov ax,<span class="hljs-number"><span class="hljs-number">4</span></span>C00h ;  AH  <span class="hljs-number"><span class="hljs-number">4</span></span>Ch,  AL ‚Äì <span class="hljs-number"><span class="hljs-number">00</span></span>h. <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>h ;  ;------------------------------------------------------- hello db <span class="hljs-string"><span class="hljs-string">'Hello, world!$'</span></span></code> </pre> <br>  The "use 16" directive indicates the generation of a 16-bit code.  ‚ÄúOrg 100h‚Äù declares the skip 256 bytes (addresses 0000h - 00FFh).  The specified addresses are reserved for service data (PSP). <br>  Next come the commands.  The address of the string hello is placed in the DX register.  Then function number 9 of interrupt 21h is called to display a string on the screen. <br>  The program is terminated by calling function 4C with the same interrupt parameter 21h. <br>  The hello line ends with a '$' character, which in DOS indicates the end of the line. <br><br>  It should be remembered that programs like COM are not supported by 64-bit Windows operating systems.  To run such programs under these operating systems, you should use the DOSBox program, or use the PE format described below. <br><br><h5>  MZ format </h5><br>  MZ is the standard format for 16-bit executable files with the .EXE extension for DOS.  Named so on the signature - ASCII-characters MZ (4D 5A) in the first two bytes. <br><br>  An example of a simple program using the MZ format: <br><br><pre> <code class="hljs cs">format MZ ;  <span class="hljs-function"><span class="hljs-function">DOS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EXE</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MZ EXE</span></span></span><span class="hljs-function">) entry code_seg:start</span></span> ;    stack <span class="hljs-number"><span class="hljs-number">200</span></span>h ;  ;-------------------------------------------------------------------- segment data_seg ;C  hello db <span class="hljs-string"><span class="hljs-string">'Hello, asmworld!$'</span></span> ; ;-------------------------------------------------------------------- segment code_seg ;  start: ;    mov ax,data_seg ;  DS mov ds,ax mov ah,<span class="hljs-number"><span class="hljs-number">09</span></span>h mov dx,hello ;  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>h mov ax,<span class="hljs-number"><span class="hljs-number">4</span></span>C00h <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>h ; </code> </pre><br><br>  To create a need to use the directive "format MZ".  The default code for this format is 16-bit. <br>  A ‚Äúsegment‚Äù defines a new segment, followed by a label, whose value will be the number of the segment being defined.  Optionally, this directive can be followed by ‚Äúuse16‚Äù or ‚Äúuse32‚Äù to indicate the bitness of the code in the segment.  The beginning of the segment is aligned to the paragraph (16 bytes).  All labels defined below will have values ‚Äã‚Äãrelative to the beginning of this segment.  In the example above, 2 segments are declared: ‚Äúdata_seg‚Äù and ‚Äúcode_seg‚Äù. <br>  ‚ÄúEntry‚Äù sets the entry point for the MZ format, followed by the far address (segment name, colon and offset in segment) of the desired entry point.  In our case, the ‚Äústart‚Äù label is declared. <br>  "Stack" sets the stack for MZ.  The directive may be followed by a numeric expression indicating the size of the stack for automatic creation, or the far address of the initial stack frame if you want to set the stack manually.  If the stack is not defined, it will be created with a default size of 4096 bytes. <br>  The ‚Äúheap‚Äù followed by its value determines the maximum amount of additional space in paragraphs (this is the place in addition to the stack and for unspecified data).  Use "heap 0" to always allocate only the memory that the program really needs. <br><br>  The MZ format, similar to COM programs, is not supported by 64-bit Windows operating systems. <br><br><h5>  PE format </h5><br>  PE is short for Portable Executable, i.e.  portable (universal) executable file.  This format appeared in the later times of Windows 3.11, but the present spread was with the flourishing of Windows 95. We can say that now on computers with Windows 9x / 2K / XP / Vista / 7 there are 95% of executables (exe, dll, drivers (sys) a) files - these are PE files. <br><br>  To select the PE format, you need to use the ‚Äúformat PE‚Äù directive, it can be followed by additional format settings: ‚Äúconsole‚Äù, ‚ÄúGUI‚Äù or the ‚Äúnative‚Äù operator to select the target subsystem (the floating point value that follows the version of the subsystem can follow ), ‚ÄúDLL‚Äù marks the output file as a dynamic linking library.  Then the ‚Äúat‚Äù operator and a numeric expression indicating the base of the PE image can be followed, and the ‚Äúon‚Äù operator is optionally followed by a string in quotes containing the name of the file that selects the MZ stub for the PE program (if the specified file is not in the MZ format, then it is treated as a simple binary executable file and converted to MZ format).  The default code for this format is 32-bit. <br><br>  An example of a PE format declaration with all properties: <br>  format PE GUI 4.0 DLL at 7000000h on 'stub.exe' <br>  A ‚Äúsection‚Äù defines a new section, it must be followed by a string in quotes that defines the name of the section, and then one or more section flags may follow.  Possible flags are: ‚Äúcode‚Äù, ‚Äúdata‚Äù, ‚Äúreadable‚Äù, ‚Äúwriteable‚Äù, ‚Äúexecutable‚Äù, ‚Äúshareable‚Äù, ‚Äúdiscardable‚Äù, ‚Äúnotpageable‚Äù.  The beginning of the section is aligned to the page (4096 bytes). <br><br>  Example of declaring a PE section: <br>  section '.text' code readable executable <br>  Together with the flags, one of the special data identifiers PE can also be defined, marking the entire section as special data, possible identifiers: "export", "import", "resource" and "fixups".  If a section is marked to contain address settings, they are generated automatically, and no more data is needed to be determined.  Resource data can also be generated automatically from resource files, this can be achieved by writing the ‚Äúfrom‚Äù operator and the file name in quotes after the ‚Äúresourse‚Äù identifier. <br><br>  Below you can see examples of sections containing some special data: <br>  section '.reloc' data discardable fixups <br>  section '.rsrc' data readable resource from 'my.res' <br>  ‚ÄúEntry‚Äù creates an entry point for PE, followed by the entry point value. <br>  ‚ÄúStack‚Äù sets the stack size for PE, then the value of the reserved stack size must follow, optionally a comma separated value of the beginning of the stack can follow.  If the stack is not defined, it is assigned a default size of 4096 bytes. <br>  "Heap" selects the size of the additional space for PE, then the value for the reserved space for it should follow, optionally, there can also be the value of its beginning, separated by a comma.  If additional space is not defined, it is set to 65,536 bytes by default; if its beginning is not specified, it is set equal to 0. <br>  ‚ÄúData‚Äù begins defining the special data PE, the directive must be followed by one of the data identifiers (export, import, resource or fixups) or the number of the data record in the PE header.  The data should be defined on the following lines and end with the ‚Äúend data‚Äù directive.  If the definition of address settings is selected, they are generated automatically, and no more data needs to be determined.  The same applies to resources, if the ‚Äúresourse‚Äù identifier is followed by the ‚Äúfrom‚Äù operator and the file name in quotes - in this case, the data is taken from this resource file. <br><br>  An example of a simple program using the PE format: <br><br><pre> <code class="hljs sql">format PE console ;  Windows EXE entry <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> ;    include 'win32a.inc' section '.text' code executable <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>: push hello <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> [printf] push <span class="hljs-number"><span class="hljs-number">0</span></span> ccall [getchar] <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> [ExitProcess] <span class="hljs-keyword"><span class="hljs-keyword">section</span></span> <span class="hljs-string"><span class="hljs-string">'.rdata'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> readable hello db <span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">section</span></span> <span class="hljs-string"><span class="hljs-string">'.idata'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> readable <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">library</span></span> kernel32, <span class="hljs-string"><span class="hljs-string">'kernel32.dll'</span></span>, \ msvcrt, <span class="hljs-string"><span class="hljs-string">'msvcrt.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> kernel32, ExitProcess, <span class="hljs-string"><span class="hljs-string">'ExitProcess'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> msvcrt, printf, <span class="hljs-string"><span class="hljs-string">'printf'</span></span>, getchar,<span class="hljs-string"><span class="hljs-string">'_fgetchar'</span></span></code> </pre><br>  In this example, WinAPI functions are used to work with the console. <br><br>  This was a brief (I hope, for someone useful) review of the use of PE and MZ formats.  Overboard this article were ELF and COFF, for which I ask you not to judge much. </div><p>Source: <a href="https://habr.com/ru/post/257551/">https://habr.com/ru/post/257551/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257541/index.html">Uninvited guest. Why are virtual machines not the best solution for tomorrow's applications?</a></li>
<li><a href="../257543/index.html">Demonstration of the EMC ViPR SRM IT Infrastructure Monitoring System</a></li>
<li><a href="../257545/index.html">Tribute to Memory</a></li>
<li><a href="../257547/index.html">My experience with Intel Edison. Part I (preparatory)</a></li>
<li><a href="../257549/index.html">How I went to the clouds</a></li>
<li><a href="../257555/index.html">Frogger HD and numerical modeling of waves in the pond</a></li>
<li><a href="../257557/index.html">Choosing a cloud hosting: where to start?</a></li>
<li><a href="../257561/index.html">A new backup tool in InfoboxCloud: specify the appropriate time and backup schedule</a></li>
<li><a href="../257563/index.html">Street dirt and pedestrian traffic simulation</a></li>
<li><a href="../257565/index.html">Why is the demonstration of video analytics in offices so different from the real work in life?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>