<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Misha ... no, Sergei ... no, Polina! Node-Polina!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When designing the service architecture, you choose the tools that are most suitable for the tasks you solve. But to use them to the maximum, you need...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Misha ... no, Sergei ... no, Polina! Node-Polina!</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/f05/6b8/cfe/f056b8cfebe4181e451868c5950ea12a.png" alt="image"><br><br>  When designing the service architecture, you choose the tools that are most suitable for the tasks you solve.  But to use them to the maximum, you need to find the most reliable and convenient driver.  Of course, if you are programming in Python or, for example, PHP, finding the driver you need is not a problem, because for many years the developers have written all that have been tested for years and work stably.  But if you are programming for node.js, it becomes a problem, drivers squeak, flow away and refuse to work stably. <br>  In this article we will talk about the problems encountered when choosing drivers, and how they were solved. <br><a name="habracut"></a><br>  LiveTex is a service that is used by more than 10 million visitors daily.  As the memory of our application, we use the Redis database, in which more than two million keys are generated per day when processing 34,000 commands per second.  We also use Beanstalkd as a task queue in which more than 10,000 tasks are processed every second.  We want our service to work quickly and stably, we demand the same from the drivers. <br>  Initially, we planned to use already written clients for our tasks, but trying to ‚Äútie‚Äù them to our service, we encountered many problems: <br><ol><li>  The problem of chunks. <br>  The fragmentation of the tcp packet data is not taken into account.  This affects beanstalk_client, fivebeans, as well as node-amqp, a client for RabbitMQ, which we originally planned to use instead of Beanstalkd, and node-thrift for hbase. <br></li><li>  Offset responses to the request. <br>  Under certain loads there was a shift in responses.  At request 2, we received a response to request 1. That is, the system returned incorrect answers. <br></li><li>  Not designed for high loads. <br>  With loads of over a million requests for Redis and more than 100,000 tasks for Beanstalkd with a payload of about 10Kb, many clients simply did not return the result and hung the entire system. <br></li><li>  No fallback <br>  For our service, it was necessary that all tasks and requests queued for execution were not lost during the transfer, even if there was no connection to the network for some time. <br></li></ol><br>  Not finding a ready reliable client for Redis and Beanstalkd, we decided to write our own. <br>  Any client, in general, is a tool for implementing service requests and getting results from it.  It must establish a connection and provide data transfer between your application and the service used.  Using the UML class diagram, this can be represented as follows: <br><br><img src="https://habrastorage.org/storage3/6e9/0cf/1c4/6e90cf1c42d6b34f992552cbc06bccc5.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The model is very simple and clear.  It is under this scheme that our Node-Polina module works.  So far, within this model, we have implemented a client for Redis and Beanstalkd. <br><br><h2>  Node-Polina.  Redis-Client. </h2><br><h3>  About driver features. </h3><br>  At the moment, the driver implements such commands to the Redis database as: <code>set, get, mget, incrby, incr, decr, setex, expire, keys, del, sismember, sadd, srem, smembers</code> .  Due to the fact that we were not tied to a specific implementation of commands, and divided them by type into returning numbers, strings or arrays, it is very easy to add a new command to the driver.  If necessary, you can write to us on gitHub on issues marked as enhancement, and we will add the necessary functionality.  In addition, Node-Polina has support for using <a href="http://en.wikipedia.org/wiki/Connection_pool">connection pooling</a> and <a href="http://en.wikipedia.org/wiki/Shard_(database_architecture)">shard</a> . <br><br><h3>  Using </h3><br><h4>  Simple customer </h4><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     : var polina = require('livetex-polina'); //      Client,      //  : var client = new polina.redis.Client(6397, '127.0.0.1'); //     : client.set('key', 'value', function() { console.log('Complete.'); }, function(error, opt_code) { console.error(error); });</span></span></code> </pre><br><h4>  Connection pooling </h4><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      Bundle,     //   ,    : var client = new polina.redis.Bundle(100, 6397, '127.0.0.1');</span></span></code> </pre><br><h4>  Shard </h4><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  Bucket,   : var bucket = new polina.redis.Bucket(9); //  ,   registerClient,   //    ,   : bucket.registerClient(0, 3, new polina.redis.Bundle(3, 6397), 'alpha'); bucket.registerClient(3, 6, new polina.redis.Bundle(3, 6398), 'beta'); bucket.registerClient(6, 9, new polina.redis.Bundle(3, 6399), 'gamma');</span></span></code> </pre><br><br><h3>  Node-Polina VS Redis VS nodejs-redis </h3><br><h4>  Time comparison </h4><br><img src="https://habrastorage.org/storage3/3c8/f7d/4ad/3c8f7d4ad34e20daae24bd1220e2d9e4.png"><br>  From the graph it can be seen that at high loads Node-Polina copes with its work much better.  These graphics are relevant for node version 0.10.15.  We also tested drivers for version 0.8.24, in which even at high loads Node-Polina continues to give results to requests when the node_redis is no longer able to cope with this. <br><br><img src="https://habrastorage.org/storage3/190/61c/125/19061c125744cdfffc43e39698a17c79.png" alt="image"><br>  When processing data in 10Kbytes at low loads, the difference between Node-Polina and other drivers is almost imperceptible.  With requests of around 300,000 - 450,000, processing requests using Node-Polina takes more time, since the failover mechanism is implemented inside the driver.  With loads of more than 230,000 requests, Node-Polina is again faster. <br><br><h4>  Memory comparison </h4><br><img src="https://habrastorage.org/storage3/f1a/210/108/f1a2101086a7586dab0eac3ad3739958.png" alt="image"><br>  In terms of memory consumed, the Node-Polina is almost comparable to node_redis, but on large loads, again, it requires more to implement failover. <br><br><img src="https://habrastorage.org/storage3/0c9/8bd/03e/0c98bd03ed1354fa14e3afecf91f0e4e.png" alt="image"><br>  When processing data in 10Kb, Node-Polina is obviously better than Hiredis.  Also, it is clear that Polina is more stable than node_redis, her schedule increases evenly, without significant fluctuations. <br><br>  Having written our driver, we solved the problems with the fragmentation of tcp-packages, the offset of responses to requests and the problem of falling with an error during a short-term disconnection.  We wrote Node-Polina so that it could withstand high loads, was easy to use and had the ability to quickly and easily add functionality.  In addition, our driver provides connection pooling and sharding, which is often necessary when working with the Redis database. <br><br>  Sources can be found in our git-repository: <a href="https://github.com/LiveTex/Node-Polina">https://github.com/LiveTex/Node-Polina</a> <br>  Install via npm using the command: <code>npm install livetex-polina</code> </div><p>Source: <a href="https://habr.com/ru/post/196854/">https://habr.com/ru/post/196854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196842/index.html">Edward Jordon speaking at the RCC 2013: "Past, Present and Future"</a></li>
<li><a href="../196844/index.html">Yandex.DNS - secure home internet</a></li>
<li><a href="../196848/index.html">Source codes of RosVyborov are open</a></li>
<li><a href="../196850/index.html">Questions for interviews with the former scener</a></li>
<li><a href="../196852/index.html">Author Blackhole exploit kit arrested</a></li>
<li><a href="../196856/index.html">What is VPS and what it eats with - virtual server infographics</a></li>
<li><a href="../196860/index.html">Upsource: JetBrains New Platform</a></li>
<li><a href="../196862/index.html">Procedural generator of Khrushchev</a></li>
<li><a href="../196864/index.html">Work with the touch screen on Arduino DUE</a></li>
<li><a href="../196866/index.html">Google introduced the 11-inch chromebook from HP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>