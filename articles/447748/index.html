<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux Virtual File Systems: Why Do They Need It and How Do They Work? Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone, we are sharing with you the second part of the publication ‚ÄúVirtual file systems in Linux: why are they needed and how do they work?‚Äù ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux Virtual File Systems: Why Do They Need It and How Do They Work? Part 2</h1><div class="post__text post__text-html js-mediator-article"> Hello everyone, we are sharing with you the second part of the publication ‚ÄúVirtual file systems in Linux: why are they needed and how do they work?‚Äù The first part can be read <a href="https://habr.com/ru/company/otus/blog/446614/">here</a> .  Recall that this series of publications is timed to the launch of the new thread in the course <a href="https://otus.pw/tjnD/">‚ÄúLinux Administrator‚Äù</a> , which starts very soon. <br><br>  <b>How to monitor VFS using eBPF and bcc tools</b> <br><br>  The easiest way to understand how the kernel handles <code>sysfs</code> files is to look at it in practice, and the easiest way to watch ARM64 is to use eBPF.  eBPF (short for Berkeley Packet Filter) consists of a virtual machine running in the <a href="https://events.linuxfoundation.org/sites/events/files/slides/bpf_collabsummit_2015feb20.pdf">kernel</a> , which privileged users can <code>query</code> from the command line.  Kernel sources tell the reader what the kernel can do;  running eBPF tools on a booted system shows what the kernel actually does. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/c-/u4/tn/c-u4tnwytocsnlxzhibuiahj0gm.png"><a name="habracut"></a><br><br>  Fortunately, using eBPF is fairly easy using the <a href="https://github.com/iovisor/bcc">bcc</a> tools, which are available as packages from a common Linux <a href="">distribution</a> and documented in detail by <a href="http://brendangregg.com/ebpf.html">Bernard Gregg</a> .  The <code>bcc</code> tools are Python scripts with small insertions of C code, which means that anyone familiar with both languages ‚Äã‚Äãcan easily modify them.  In <code>bcc/tools</code> there are 80 Python scripts, which means that most likely the developer or system administrator will be able to choose something suitable for solving the problem. <br><br>  To get at least a cursory idea of ‚Äã‚Äãwhat work VFS is doing on a running system, try <code>vfscount</code> or <code>vfsstat</code> .  This will show, say, that dozens of calls to <code>vfs_open()</code> and ‚Äúhis friends‚Äù occur literally every second. <br><br><img src="https://habrastorage.org/webt/in/4-/sc/in4-sc_fua4twm0ryoory_yvxys.png"><br><br><blockquote>  <code>vfsstat.py</code> is a Python script, with C code inserts, that simply counts VFS function calls. </blockquote><br><br>  Let's take a more trivial example and see what happens when we insert a USB flash drive into a computer and the system detects it. <br><br><img src="https://habrastorage.org/webt/hy/xu/ui/hyxuuii2feqk1ovhiwqckjwdy5c.png"><br><br><blockquote>  With eBPF, you can see what happens in <code>/sys</code> when a USB flash drive is inserted.  Here is a simple and complex example. </blockquote><br><br>  In the example above, <code>bcc</code> <a href="https://github.com/iovisor/bcc/blob/master/tools/trace_example.txt">trace.py</a> tool displays a message when the <code>sysfs_create_files()</code> command is <code>sysfs_create_files()</code> .  We see that <code>sysfs_create_files()</code> was launched using the <code>kworker</code> stream in response to the fact that the flash drive was inserted, but what file was created?  The second example shows the power of eBPF.  Here, <code>trace.py</code> displays a kernel <code>trace.py</code> (kernel backtrace) (option -K) and the name of the file that was created by <code>sysfs_create_files()</code> .  Insertion in single statements is C code that includes an easily recognizable format string provided by the Python script that runs the LLVM <i>just-in-time compiler</i> .  This line it compiles and executes in a virtual machine inside the kernel.  The full signature of the <code>sysfs_create_files ()</code> function must be reproduced in the second command so that the format string can refer to one of the parameters.  Errors in this C code fragment lead to recognizable C compiler errors.  For example, if the -l option is omitted, you will see ‚ÄúFailed to compile BPF text.‚Äù Developers who are familiar with C and Python will find <code>bcc</code> tools easy to expand and modify. <br><br>  When a USB drive is inserted, a kernel <code>kworker</code> will show that PID 7711 is the <code>kworker</code> stream that created the <code>¬´events¬ª</code> file in <code>sysfs</code> .  Accordingly, a call with <code>sysfs_remove_files()</code> will show that deleting the drive resulted in deleting the <code>events</code> file, which corresponds to the general concept of reference counting.  At the same time, viewing <code>sysfs_create_link ()</code> from eBPF during insertion of a USB drive will show that at least 48 symbolic links have been created. <br><br>  So what's the point of the events file?  Using <a href="http://northstar-www.dartmouth.edu/doc/solaris-forte/manuals/c/user_guide/cscope.html">cscope</a> to search for <a href="">__device_add_disk ()</a> , indicates that it calls <code>disk_add_events ()</code> , and either <code>"media_change"</code> or <code>"eject_request"</code> can be written to the event file.  Here, the kernel block layer informs userspace about the appearance and extraction of the ‚Äúdisk‚Äù.  Notice how informative this research method is on the example of inserting a USB drive compared to trying to figure out how everything works, exclusively from source. <br><br>  <b>Read-only root file systems make embedded devices possible.</b> <br><br>  Of course, no one turns off the server or your computer, pulling the plug from the outlet.  But why?  And all because mounted file systems on physical storage devices may have deferred entries, and data structures that record their state may not be synchronized with entries in the repository.  When this happens, system owners have to wait for the next boot to run the <code>fsck filesystem-recovery</code> utility and, in the worst case, lose data. <br><br>  However, we all know that many IoT devices, as well as routers, thermostats and cars are now running Linux.  Many of these devices have virtually no user interface, and there is no way to turn them off cleanly.  Imagine starting a car with a low battery when the power of the control device on <a href="https://wiki.automotivelinux.org/_media/eg-rhsa/agl_referencehardwarespec_v0.1.0_20171018.pdf">Linux</a> constantly jumps up and down.  How is it that the system boots without a long <code>fsck</code> , when the engine finally starts working?  And the answer is simple.  Embedded devices rely on a read-only root filesystem (abbreviated as <code>ro-rootfs</code> (read-only root file system)). <br><br>  <code>ro-rootfs</code> offer many benefits that are less obvious than genuine.  One advantage is that malware cannot write to <code>/usr</code> or <code>/lib</code> if no Linux process can write there.  Another is that the largely immutable file system is crucial for field support for remote devices, since support personnel use local systems that are nominally identical to systems in the field.  Perhaps the most important (but also the most insidious) advantage is that ro-rootfs makes developers decide which system objects will be unchanged, even at the system design stage.  Working with ro-rootfs can be inconvenient and painful, as is often the case with const variables in programming languages, but their advantages easily pay for the additional overhead. <br><br>  Creating <code>rootfs</code> only <code>rootfs</code> requires some extra effort for developers of embedded systems, and this is where VFS comes into play.  Linux requires that the files in <code>/var</code> be writable, and, in addition, many popular applications that run embedded systems will try to create configuration <code>dot-files</code> in <code>$HOME</code> .  One solution for configuration files in the home directory is usually their pre-generation and build into <code>rootfs</code> .  For <code>/var</code> one of the possible approaches is to mount it in a separate section that is writable, while it is mounted <code>/</code> read-only.  Another popular alternative is to use bind or overlay mounts. <br><br>  <b>Bound and overlaid mounts, their use by containers</b> <br><br>  Running the <code>man mount</code> command is the best way to learn about mountable and overlayed mountings, which give developers and system administrators the ability to create a file system along one path and then provide it to applications in another.  For embedded systems, this means the ability to store files in <code>/var</code> on a read-only flash drive, but overlaying or linking the mounting of the path from <code>tmpfs</code> to <code>/var</code> when loading will allow applications to write scrawl notes there.  The next time you turn on, changes to <code>/var</code> will be lost.  The overlay mount creates a union between <code>tmpfs</code> and the underlying file system and allows you to make modifications to existing files in <code>ro-tootf</code> while the associated mount can make new empty <code>tmpfs</code> folders visible as available for writing to <code>ro-rootfs</code> paths.  While <code>overlayfs</code> is the proper ( <code>proper</code> ) file system type, the associated mount is implemented in the <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/filesystems/sharedsubtree.txt">VFS namespace</a> . <br><br>  Based on the description of the overlaid and bound mount, no one is surprised that <a href="https://coreos.com/os/docs/latest/kernel-modules.html">Linux containers</a> actively use them.  Let's observe what happens when we use <a href="https://www.freedesktop.org/software/systemd/man/systemd-nspawn.html">systemd-nspawn</a> to launch a container using the <code>bcc</code> <code>mountsnoop</code> tool. <br><br><img src="https://habrastorage.org/webt/wj/43/mq/wj43mq5y2xnd4lesqkatrdw6rgk.png"><br><br>  Calling <code>system-nspawn</code> starts the container while <code>mountsnoop.py</code> . <br><br>  Let's see what happened: <br><br><img src="https://habrastorage.org/webt/3a/rp/v_/3arpv_i_ls4aln8l0mcate3ntvk.png"><br><br>  Running <code>mountsnoop</code> while the container is ‚Äúloading‚Äù indicates that the runtime environment of the container is strongly dependent on the mount being linked (Only the beginning of the long output is displayed). <br><br>  Here, <code>systemd-nspawn</code> provides the selected files in the host's <code>procfs</code> and <code>sysfs</code> container as paths in its <code>rootfs</code> .  In addition to the <code>MS_BIND</code> flag, which establishes a binding mount, some other flags in the mounted system define the relationship between changes in the host and container namespaces.  For example, a bound mount can either skip changes to <code>/proc</code> and <code>/sys</code> to a container, or hide them depending on the call. <br><br>  <b>Conclusion</b> <br><br>  Understanding the internal structure of Linux can seem an impossible task, since the kernel itself contains a huge amount of code, leaving aside Linux user-space applications and system call interfaces in C libraries, such as <code>glibc</code> .  One way to make progress is to read the source code of a single kernel subsystem, with a focus on understanding system calls and headers facing user space, as well as the main internal interfaces of the kernel, for example, the <code>file_operations</code> table.  File operations provide the principle of ‚Äúeverything is a file‚Äù, so their management is especially nice.  The C kernel source files in the <code>fs/</code> top-level directory represent the implementation of virtual file systems, which are a shell layer that provides wide and relatively simple compatibility of popular file systems and storage devices.  Linux binding and overlapping mounts are the magic of VFS, which makes it possible to create containers and root-only file systems for reading.  Combined with source code learning, the eBPF kernel tool and its <code>bcc</code> interface <br>  make kernel research easier than ever. <br><br>  Friends, write whether this article was useful to you?  Perhaps you have any comments or comments?  And those who are interested in the course "Administrator Linux", we invite you to <a href="https://otus.pw/u5Jw/">the open day</a> , which will be held on April 18. <br><br>  <a href="https://habr.com/ru/company/otus/blog/446614/">First part.</a> </div><p>Source: <a href="https://habr.com/ru/post/447748/">https://habr.com/ru/post/447748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447736/index.html">Video from the drone - a new trend of social networks</a></li>
<li><a href="../447738/index.html">Julian Assange arrested by British police</a></li>
<li><a href="../447742/index.html">What is DevOps methodology and who needs it</a></li>
<li><a href="../447744/index.html">Climbing Elbrus - Reconnaissance. Technical Part 2. Interrupts, exceptions, system timer</a></li>
<li><a href="../447746/index.html">Business logic in a database using SchemaKeeper</a></li>
<li><a href="../447750/index.html">New processors for data centers - parse announcements of recent months</a></li>
<li><a href="../447754/index.html">Application in the menu bar for macOS</a></li>
<li><a href="../447756/index.html">New Gartner Application Monitoring Solution (APM) quadrant</a></li>
<li><a href="../447758/index.html">The story of the hacking of the classic game Dendy or Contra for 100 lives</a></li>
<li><a href="../447760/index.html">Broadcasting the moon landing [22: 00MSK 11 Apr 2019]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>