<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>UIImage, EXIF ‚Äã‚Äãand a bit of runtime</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For owners of iOS-devices, there is a huge number of web-services that provide the ability to publish photos on their resources. There is no need to g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>UIImage, EXIF ‚Äã‚Äãand a bit of runtime</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/ed4/e71/b83/ed4e71b8375abc1bc49e191d1fb99e94.jpg" alt="image"><br><br>  For owners of iOS-devices, there is a huge number of web-services that provide the ability to publish photos on their resources.  There is no need to go long for examples.  These are the social networks VKontakte, Facebook - services, if you can put it, of a wide profile, applications of which are installed by almost all users.  So are highly specialized, for example, FourSquare, Path. <br><br>  There are plenty of such services and for many of them there is an open API, with the help of which third-party developers (and this we are with you) can implement applications or their individual parts interacting with the service.  It is quite easy to write code that takes pictures from photo albums or makes a new one.  Consider the first option. <br><a name="habracut"></a><br>  In your controller's .h file: <br><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MYViewController</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIImagePickerControllerDelegate</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UINavigationControllerDelegate</span></span></span><span class="hljs-class">&gt; ... @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In your controller's .m file: <br><pre> <code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MYViewController</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IBAction</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pickupImage</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">UIImagePickerController</span></span> *imagePicker = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImagePickerController</span></span> alloc] init]; imagePicker.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; imagePicker.sourceType = <span class="hljs-built_in"><span class="hljs-built_in">UIImagePickerControllerSourceTypePhotoLibrary</span></span>; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> presentModalViewController:imagePicker animated:<span class="hljs-literal"><span class="hljs-literal">YES</span></span>]; [imagePicker release]; } <span class="hljs-meta"><span class="hljs-meta">#pragma mark - UIImagePickerControllerDelegate - (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary *)info { UIImage *image = [info objectForKey:UIImagePickerControllerOriginalImage]; //   UIImage  // [serviceAPI postWithText:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" !"</span></span></span><span class="hljs-meta"> withImage:image]; [picker dismissModalViewControllerAnimated:YES]; } @end</span></span></code> </pre><br><br>  Something like this.  It's simple, you have already done this or just read about it in books.  Everything works well until one day the web service starts processing the EXIF ‚Äã‚Äãdata of the images.  For example, it starts displaying the coordinates of the shooting location and the type of camera on which the photo was taken, the orientation of the photo under each photo.  And it turns out that you do not send any EXIF ‚Äã‚Äãdata. <br><br>  In the name of the constant <code>UIImagePickerControllerOriginalImage</code> <b>Original is</b> not quite Original.  It is original only from the point of view that the entire image is given to you from point (0,0) to point ( <i>width</i> -1, <i>height</i> -1), since it is possible to cut it before the delegate method is called, which is done by setting the flag <pre> <code class="hljs objectivec">imagePicker.allowsEditing = <span class="hljs-literal"><span class="hljs-literal">YES</span></span></code> </pre> <br>  It will look like this on the device: <br><img src="https://habrastorage.org/getpro/habr/post_images/93b/b31/798/93bb3179844731849fb2cfc937297016.png" alt="image"><br><br>  And so, now we need to change the code so that we can access the source file of the photo, which contains meta information in addition to the pixels.  The <b>UIImagePickerControllerReferenceURL</b> key and the <b>AssetsLibrary</b> framework <b>come to the rescue</b> . <br><br>  Starting with iOS SDK 4.1, the <code>info</code> parameter, which comes to us in the delegate method, contains the value by the key UIImagePickerControllerReferenceURL in the case when we access photos from albums.  The value for this key is a link to <i>an</i> asset, a file that we need. <br><br>  The code of the delegate method will look like this: <br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)imagePickerController:(<span class="hljs-built_in"><span class="hljs-built_in">UIImagePickerController</span></span> *)picker didFinishPickingMediaWithInfo:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)info { <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *image = [info objectForKey:<span class="hljs-built_in"><span class="hljs-built_in">UIImagePickerControllerOriginalImage</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *assetURL = [info objectForKey:<span class="hljs-built_in"><span class="hljs-built_in">UIImagePickerControllerReferenceURL</span></span>]; ALAssetsLibrary *library = [[ALAssetsLibrary alloc] init]; [library assetForURL:assetURL resultBlock:^(ALAsset *asset) { <span class="hljs-built_in"><span class="hljs-built_in">CLLocation</span></span> *location = [asset valueForProperty:ALAssetPropertyLocation]; <span class="hljs-comment"><span class="hljs-comment">// [serviceAPI postWithText:@" !" withImage:image withMetadata:...]; [library autorelease]; } failureBlock:^(NSError *error) { }]; [picker dismissModalViewControllerAnimated:YES]; }</span></span></code> </pre><br><br> <code>CLLocation *location = [asset valueForProperty:ALAssetPropertyLocation];</code>  - here we turn to the geography of the photo.  In the file &lt;AssetsLibrary / ALAsset.h&gt; we can view the other keys available to developers. <br><br>  Hereinafter we consider geo-marks, work with the rest of the data is carried out by analogy. <br><br>  As you understand, ultimately we will make a POST request with a binary representation of the image, which we will get by the <i>UIImageJPEGRepresentation</i> method, this data will need to be supplemented with meta-information.  We are helped by the <b>iphone-exif</b> library, which will take us to a higher level of abstraction when working with exif. <br><br>  The code that adds to the binary representation of the image, geotagging looks like this: <br><br><pre> <code class="hljs lua">#import <span class="hljs-string"><span class="hljs-string">"EXF.h"</span></span> #import <span class="hljs-string"><span class="hljs-string">"EXFUtils.h"</span></span> + (NSData *)populateData:(NSData *)data byLocation:(CLLocation *)location { EXFJpeg *exfJpeg = <span class="hljs-string"><span class="hljs-string">[[[EXFJpeg alloc] init] autorelease]; [exfJpeg scanImageData:data]; //  ,      //     EXFGPSLoc* gpsLocLatitude = [[[EXFGPSLoc alloc] init] autorelease]; [self populateGPS:gpsLocLatitude byValue:[self locationArrayForValue:location.coordinate.latitude]]; [exfJpeg.exifMetaData addTagValue:gpsLocLatitude forKey:[NSNumber numberWithInt:EXIF_GPSLatitude]]</span></span>; //     EXFGPSLoc* gpsLocLongitude = <span class="hljs-string"><span class="hljs-string">[[[EXFGPSLoc alloc] init] autorelease]; [self populateGPS:gpsLocLongitude byValue:[self locationArrayForValue:location.coordinate.longitude]]</span></span>; [exfJpeg.exifMetaData addTagValue:gpsLocLongitude forKey:[NSNumber numberWithInt:EXIF_GPSLongitude]]; //  <span class="hljs-string"><span class="hljs-string">""</span></span>  NSString *refLatitude = (location.coordinate.latitude &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? @<span class="hljs-string"><span class="hljs-string">"S"</span></span> : @<span class="hljs-string"><span class="hljs-string">"N"</span></span>); [exfJpeg.exifMetaData addTagValue:refLatitude forKey:[NSNumber numberWithInt:EXIF_GPSLatitudeRef]]; //  <span class="hljs-string"><span class="hljs-string">""</span></span>  NSString *refLongitude = (location.coordinate.longitude &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? @<span class="hljs-string"><span class="hljs-string">"W"</span></span> : @<span class="hljs-string"><span class="hljs-string">"E"</span></span>); [exfJpeg.exifMetaData addTagValue:refLongitude forKey:[NSNumber numberWithInt:EXIF_GPSLongitudeRef]]; NSMutableData *dataWithExif = [NSMutableData data]; [exfJpeg populateImageData:dataWithExif]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dataWithExif; }</code> </pre><br><br>  It would seem that we are one step away from success.  We add metadata to NSData, and then, doing a wrap operation, we get a UIImage.  And we don‚Äôt even have to change the signatures of methods that accept only a UIImage without any hints on exif. <br><br>  Alas, this will not work.  And that's why. <br><br>  <b>First</b> , unfortunately, methods like <i>[UIImage imageWithData: data]</i> lose all the metadata (geo-location, in our case) that is stored in NSData.  So, it will not be possible to keep the coordinates right ‚Äúinside‚Äù the binary representation of the image at the UIImage level. <br><br>  <b>Secondly</b> , you can do various manipulations with a picture, say, reduce its size.  This is usually done using CoreGraphics functions that do not know exactly about any metadata. <br><br><h5>  Output </h5><br>  So, we will have to accompany the image and its metadata along the entire path from receiving it until we receive an object of the NSData class and form a POST request to the server.  And we'd better do everything so that we don‚Äôt have to change all signatures of methods and functions along the way due to such maintenance (UIImage + NSData-Exif). <br><br>  It would be possible, of course, to create an object of the NSMutableDictionary class, which would store the correspondence between UIImage and NSData.  But this is to nothing, such a link can be added directly to the UIImage. <br><br><h5>  Associated objects </h5><br>  Starting with iOS 4.0, the ability to add object associations was added to the language runtime - a connection that you establish while the program is running.  Read more <a href="http://developer.apple.com/library/ios/">here</a> .  Method declarations can be viewed in &lt;objc / runtime.h&gt; <br>  It works like this: <br><br>  The association can be established by calling the function: <br> <code>void objc_setAssociatedObject(id object, void *key, id value, objc_AssociationPolicy policy)</code> <br> <br>  The values ‚Äã‚Äãof the last argument will be familiar to you by the attributes of the ObjC classes' properties: <br><pre> <code class="hljs cpp"> <span class="hljs-comment"><span class="hljs-comment">/* objc_setAssociatedObject() options */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { OBJC_ASSOCIATION_ASSIGN = <span class="hljs-number"><span class="hljs-number">0</span></span>, OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="hljs-number"><span class="hljs-number">1</span></span>, OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="hljs-number"><span class="hljs-number">3</span></span>, OBJC_ASSOCIATION_RETAIN = <span class="hljs-number"><span class="hljs-number">01401</span></span>, OBJC_ASSOCIATION_COPY = <span class="hljs-number"><span class="hljs-number">01403</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> objc_AssociationPolicy;</code> </pre><br>  A pointer to an object can be obtained by the method: <br> <code>id objc_getAssociatedObject(id object, void *key)</code> <br>  So after getting the UIImage object using ALAssetsLibrary, we will need to do the following: <br><br><pre> <code class="hljs objectivec"> <span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;objc/runtime.h&gt;</span></span></span><span class="hljs-meta"> // -   .      char kUIImageExifKey; ... objc_setAssociatedObject(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;#image#&gt;</span></span></span><span class="hljs-meta">, &amp;kUIImageExifKey, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;#DATA#&gt;</span></span></span><span class="hljs-meta">, OBJC_ASSOCIATION_RETAIN); ...</span></span></code> </pre><br><br><h5>  The path of the UIImage and metadata will be as follows </h5><br>  1) Get a photo and metadata to it; <br>  2) to associate these two objects; <br>  3) With each update of the image, keep the association with the most relevant UIImage object (the image can be reduced, a filter is applied, etc.). <br>  4) Immediately before sending binary data, use the iphone-exif library. <br><br>  It's all. <br><br>  If there are requests, it will be possible to review the work with the photo just taken and place it into a ‚Äúcombat‚Äù code, and put it on github. <br><img src="https://mc.yandex.ru/watch/39622305" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/148837/">https://habr.com/ru/post/148837/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148830/index.html">Training with reinforcements on neural networks. Theory</a></li>
<li><a href="../148831/index.html">We work on the road on the phone</a></li>
<li><a href="../148833/index.html">Dropbox: Base with email addresses was stolen from employee account</a></li>
<li><a href="../148835/index.html">Sony Xperia go review</a></li>
<li><a href="../148836/index.html">Polymer VS bacteria. Who will win?</a></li>
<li><a href="../148838/index.html">I retrain people to java programmers</a></li>
<li><a href="../148839/index.html">Experimental Determination of Cache Memory Characteristics</a></li>
<li><a href="../148840/index.html">Font for registration number plates (license plates)</a></li>
<li><a href="../148841/index.html">Apache Maven - web application</a></li>
<li><a href="../148842/index.html">Simplify your life with Sublime Text 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>