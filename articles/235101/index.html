<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Some subtleties of GetHashCode</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When reading the ‚ÄúFramework Design Guidelines: Conventions, Idioms, and Patterns for Reusable .NET Libraries‚Äù came across this phrase: 

 "Ensure that...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Some subtleties of GetHashCode</h1><div class="post__text post__text-html js-mediator-article">  When reading the ‚ÄúFramework Design Guidelines: Conventions, Idioms, and Patterns for Reusable .NET Libraries‚Äù came across this phrase: <br><br>  "Ensure that getHashcode returns exactly the same value regardless of any changes." <br><br>  Hmm ... I thought, what are they talking about?  A standard implementation that is generated by ReSharper appeared before my eyes, and I realized that the generated value will not be constant throughout the life of the object when it changes. <br><a name="habracut"></a><br>  I decided to sketch a sample in order to realize the scale of the problem, so suppose we have a class reflecting a person, and for unique identification we will use his SNILS number: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Employee</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FirstName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SecondName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Snils { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Employee other</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Equals(Snils, other.Snils); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ReferenceEquals(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, obj)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ReferenceEquals(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, obj)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj.GetType() != <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetType()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Equals((Employee) obj); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHashCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Snils != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? Snils.GetHashCode() : <span class="hljs-number"><span class="hljs-number">0</span></span>); } }</code> </pre> <br>  Overloaded methods generated by ReSharper.  At first glance, everything is fine.  The fields used in the equality test are used to generate the hash.  Equal objects will have equal hash codes.  It seems to be all great. <br>  Add some business logic: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> employees = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;Employee&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> employee = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Employee() { FirstName = <span class="hljs-string"><span class="hljs-string">"Sergei"</span></span>, SecondName = <span class="hljs-string"><span class="hljs-string">"Popov"</span></span>, Snils = <span class="hljs-string"><span class="hljs-string">"123456"</span></span> }; employees.Add(employee); Console.WriteLine(employees.Contains(employee));</code> </pre><br>  And we see the message "True". <br>  What if at some point I decided to change my SNILS <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> employees = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;Employee&gt;() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> employee = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Employee() { FirstName = <span class="hljs-string"><span class="hljs-string">"Sergei"</span></span>, SecondName = <span class="hljs-string"><span class="hljs-string">"Popov"</span></span>, Snils = <span class="hljs-string"><span class="hljs-string">"123456"</span></span> }; employees.Add(employee); <span class="hljs-comment"><span class="hljs-comment">//      employee.Snils = "654321"; Console.WriteLine(employees.Contains(employee));</span></span></code> </pre><br>  And we see the message "False". <br><br>  What happened? <br>  Internally, a HashSet consists of a number of baskets.  Recycle bin for an object is selected based on the value returned by GetHashCode.  As soon as we changed the number of SNILS, the value returned by GetHashCode also changed.  HashSet, in turn, chose another basket for viewing based on the hash code and, naturally, there is no object in this basket (with a very small probability it could have been there).  In other baskets HashSet will not look, because  equal objects must have equal values ‚Äã‚ÄãGetHashCode.  That's it.  The object will not be found. <br><br>  And how did it even work? <br>  If you have not redefined Equals &amp; GetHashCode, then your object will have a constant GetHashCode object throughout the life of the object, regardless of the changes you made in the fields of the object.  But, if you overload these methods, it is necessary to use only immutable fields in the hash generation algorithm, or not to change the fields used in the generation algorithm, or to invent your own crutch (alternatively, you can use the approach implemented in the standard Object class implementation) . <br><br>  Hence the moral: <br>  The value of the hash code must be constant throughout the life of the object, or you must be clearly aware of what you are doing, if in your case it may change. <br><br>  Ps.  I understand that Rocket Science is far from being described here.  Everything written here is obvious and follows from the requirements of Microsoft to these methods.  There is a good description from Lippert <a href="http://ericlippert.com/2011/02/28/guidelines-and-rules-for-gethashcode/">here</a> , however, on the move, I ran and did not believe that HashSet would return False.  I hope that you no longer. </div><p>Source: <a href="https://habr.com/ru/post/235101/">https://habr.com/ru/post/235101/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235077/index.html">The digest of interesting materials for the mobile # 68 developer (on August 25-31)</a></li>
<li><a href="../235081/index.html">POST handling of AngularJs requests in symfony2</a></li>
<li><a href="../235089/index.html">First All-Union Olympiad of Schoolchildren on Programming (Computer Science) 1988</a></li>
<li><a href="../235093/index.html">Instead of building - 3D printing</a></li>
<li><a href="../235095/index.html">Learning How to Learn: Impressions</a></li>
<li><a href="../235105/index.html">We program currency symbols for customer display</a></li>
<li><a href="../235107/index.html">Consulo - IDE where Java and C # live together</a></li>
<li><a href="../235109/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ122 (August 24 - 31, 2014)</a></li>
<li><a href="../235111/index.html">The evolution of remote control</a></li>
<li><a href="../235117/index.html">Placeholders - evil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>