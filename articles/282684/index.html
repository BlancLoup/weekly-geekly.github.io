<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP 7 Checker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Re-checking projects is often quite interesting. It allows you to find out which new errors were made during the development of the application, and w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP 7 Checker</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/359/7e4/982/3597e4982268476c8374936f40a95445.png"></div><br>  Re-checking projects is often quite interesting.  It allows you to find out which new errors were made during the development of the application, and which errors have already been fixed.  Previously, my colleague already wrote about checking PHP.  With the release of the new version (PHP7), I decided to check the interpreter source code again and found something interesting. <br><a name="habracut"></a><br><br><h2>  Checked project </h2><br>  <a href="http://php.net/">PHP</a> is a general purpose scripting language intensively used for developing web applications.  The language and its interpreter are developed in an open source project. <br><br><img src="https://habrastorage.org/files/268/a8f/db9/268a8fdb956340a581528b7679e40c23.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On December 3, 2015, PHP version 7.0.0 was announced.  The new version is based on the experimental PHP branch, which was originally called phpng (Next Generation PHP), and was developed with a focus on increasing performance and reducing memory consumption. <br><br>  The object of verification was the PHP interpreter, the source code of which is available in the repository on <a href="https://github.com/php/php-src">GitHub</a> .  The tested branch is master. <br><br>  The static code analyzer <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio was</a> used as the analysis tool.  For verification, <a href="http://www.viva64.com/ru/d/0323/">a compilation monitoring system was</a> used, allowing the project to be analyzed regardless of which system is used to build this project.  A trial version of the analyzer is available for download at the <a href="http://www.viva64.com/ru/pvs-studio-download/">link</a> . <br><br>  You can get acquainted with the previous verification of the project in the article by Svetoslav Razmyslov " <a href="http://www.viva64.com/ru/b/0277/">Note about PHP verification</a> ". <br><br><h2>  Bugs found </h2><br>  It is worth noting that many of the errors found by the analyzer are in libraries used in PHP.  If all of them are considered in this article, its volume would have grown considerably.  But on the other hand, the mistakes made in the libraries used in the project will also manifest themselves when using the project.  Therefore, some of these errors will still be written out in this article. <br><br>  Separately, I would like to note that during the analysis, the impression was that the code <i>was</i> written <i>entirely</i> in macros.  They are just everywhere.  This greatly complicates the task of analysis, I generally keep quiet about debugging such a code.  Their ubiquitous use, by the way, turned out to be sideways - errors from macros were taken away along the code.  But more on that below. <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">spl_fixedarray_object_write_dimension</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(zval *object, zval *offset, zval *value)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (intern-&gt;fptr_offset_set) { zval tmp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!offset) { ZVAL_NULL(&amp;tmp); offset = &amp;tmp; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { SEPARATE_ARG_IF_REF(offset); } .... spl_fixedarray_object_write_dimension_helper(intern, offset, value) }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0095/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0095/">V506</a> Pointer to local variable 'tmp' is stored outside.  Such a pointer will become invalid.  spl_fixedarray.c 420 <br><br>  If the conditional statement for the <i>if statement</i> given above is true, the <i>offset</i> pointer can be assigned the address of the variable <i>tmp</i> .  At the same time, the lifetime of the variable <i>tmp is</i> limited to its scope, i.e.  body of the <i>if statement</i> .  But below the code, a function is called that takes the <i>offset</i> pointer as one of the parameters, which refers to the variable already destroyed, which can lead to an error when working with this pointer. <br><br>  Another weird code: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MIN(a, b) (((a)</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;(b))?(a):(b)) #define MAX(a, b) (((a)&gt;(b))?(a):(b)) SPL_METHOD(SplFileObject, fwrite) { .... size_t str_len; zend_long length = 0; .... str_len = MAX(0, MIN((size_t)length, str_len)); .... }</span></span></span></span></code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0137/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression is always false.  Unsigned type value is never &lt;0. spl_directory.c 2886 <br><br>  The code logic is simple - first compare 2 values ‚Äã‚Äãand take the smaller one, after which the result obtained is compared with zero and the largest of these values ‚Äã‚Äãis written to the <i>str_len</i> variable.  The problem lies in the fact that <i>size_t</i> is an unsigned type, therefore, its value is always non-negative.  As a result, the use of the second macro <i>MAX</i> simply does not make sense.  What is it - just an extra operation, or some more serious mistake - to judge the developer who wrote the code. <br><br>  This is not the only strange comparison, there are others. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> size_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sapi_cli_ub_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *str, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> str_length)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> ub_wrote; ub_wrote = cli_shell_callbacks.cli_shell_ub_write(str, str_length); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ub_wrote &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ub_wrote; } }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0220/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0220/">V605</a> Consider verifying the expression: ub_wrote&gt; - 1. An unsigned value is compared to the number -1.  php_cli.c 307 <br><br>  The variable <i>ub_wrote</i> is of type unsigned <i>size_t</i> .  However, the following check is performed like <i>ub_wrote&gt; -1.</i>  At first glance it may seem that this expression will always be true, since <i>ub_wrote</i> can store only non-negative values ‚Äã‚Äãin itself.  In fact, everything is more interesting. <br><br>  The literal type -1 ( <i>int</i> ) will be converted to the variable type <i>ub_wrote</i> ( <i>size_t</i> ), that is, the converted value will participate in the comparison of <i>ub_wrote</i> with the variable.  In a 32-bit program, this will be an unsigned value <i>0xFFFFFFFF</i> , and in a 64-bit program it will be <i>0xFFFFFFFFFFFFFFFF</i> .  Thus, the <i>ub_wrote</i> variable will be compared with the maximum value of the <i>unsigned long</i> type.  As a result, the result of this comparison will always be <i>false</i> , and the <i>return statement</i> will never be executed. <br><br>  Similar code met again.  Corresponding message: <a href="http://www.viva64.com/ru/d/0220/">V605</a> Consider verifying the expression: shell_wrote&gt; - 1. An unsigned value is compared to the number -1.  php_cli.c 272 <br><br>  The following code, for which the analyzer issued a warning, is also associated with a macro. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">PHPAPI </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">php_print_info</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flag)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sapi_module.phpinfo_as_text) { php_info_print(<span class="hljs-string"><span class="hljs-string">"&lt;h1&gt;Configuration&lt;/h1&gt;\n"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { SECTION(<span class="hljs-string"><span class="hljs-string">"Configuration"</span></span>); } .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0169/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0169/">V571</a> Recurring check.  The 'if (! Sapi_module.phpinfo_as_text)' condition is already verified in line 975. info.c 978 <br><br>  At first glance it may seem that everything is normal, and there is no error.  But let's take a look at what the <i>SECTION</i> macro is <i>.</i> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SECTION(name) </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!sapi_module.phpinfo_as_text) { \ php_info_print(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"&lt;h2&gt;"</span></span></span><span class="hljs-meta"> name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"&lt;/h2&gt;\n"</span></span></span><span class="hljs-meta">); \ } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { \ php_info_print_table_start(); \ php_info_print_table_header(1, name); \ php_info_print_table_end(); \ } \</span></span></code> </pre> <br>  As a result, after preprocessing, the following code will be contained in the * .i-file: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">PHPAPI </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">php_print_info</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flag)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sapi_module.phpinfo_as_text) { php_info_print(<span class="hljs-string"><span class="hljs-string">"&lt;h1&gt;Configuration&lt;/h1&gt;\n"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sapi_module.phpinfo_as_text) { php_info_print(<span class="hljs-string"><span class="hljs-string">"&lt;h2&gt;Configuration&lt;/h2&gt;\n"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { php_info_print_table_start(); php_info_print_table_header(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Configuration"</span></span>); php_info_print_table_end(); } } .... }</code> </pre> <br>  Now the problem has become much easier to notice.  Some condition is checked <i>(! Sapi_module.phpinfo_as_text</i> ) and, if it is not met, this condition is checked again (which, of course, will never be fulfilled).  Agree, it looks at least strange. <br><br>  A similar situation associated with the use of this macro, met again in the same function: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">PHPAPI </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">php_print_info</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flag)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sapi_module.phpinfo_as_text) { SECTION(<span class="hljs-string"><span class="hljs-string">"PHP License"</span></span>); .... } .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0169/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0169/">V571</a> Recurring check.  The 'if (! Sapi_module.phpinfo_as_text)' condition was already verified in line 1058. info.c 1059 <br><br>  Similar situation.  Same condition, same macro.  We open, we receive a code of the following form: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">PHPAPI </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">php_print_info</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flag)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sapi_module.phpinfo_as_text) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sapi_module.phpinfo_as_text) { php_info_print(<span class="hljs-string"><span class="hljs-string">"&lt;h2&gt;PHP License&lt;/h2&gt;\n"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { php_info_print_table_start(); php_info_print_table_header(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"PHP License"</span></span>); php_info_print_table_end(); } .... } .... }</code> </pre> <br>  Again the same condition is checked twice.  The second will be checked only if the first is true.  Then, if the first condition is true ( <i>! Sapi_module.phpinfo_as_text</i> ), then the second condition will always be true.  In this case, the code located in the <i>else</i> branch of the second <i>if statement</i> will never be executed. <br><br>  Go ahead. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preg_get_backref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **str, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *backref)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *walk = *str; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*walk == <span class="hljs-number"><span class="hljs-number">0</span></span> || *walk != <span class="hljs-string"><span class="hljs-string">'}'</span></span>) .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0194/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0194/">V590</a> Consider inspecting the '* walk == 0 ||  * walk! = '}' 'expression.  The expression is misprint.  php_pcre.c 1033 <br><br>  In this code, the pointer is dereferenced, and its value is compared with some literals.  This code is redundant.  For clarity, we rewrite, simplifying, the expression: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a == <span class="hljs-number"><span class="hljs-number">0</span></span> || a != <span class="hljs-number"><span class="hljs-number">125</span></span>)</code> </pre> <br>  As you can see, the condition can be simplified to <i>a! = 125</i> . <br><br>  This may indicate both the redundancy of the code, and the fact that the programmer made a more serious error. <br><br><img src="https://habrastorage.org/files/031/486/66a/03148666ab5544d0b420298cb78eaed7.png"><br><br>  The source of some problem areas was the Zend framework: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> zend_mm_heap *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zend_mm_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... heap-&gt;limit = (Z_L(<span class="hljs-number"><span class="hljs-number">-1</span></span>) &gt;&gt; Z_L(<span class="hljs-number"><span class="hljs-number">1</span></span>)); .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0225/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0225/">V610</a> Unspecified behavior.  Check the shift operator '&gt;&gt;'.  The left operand '(- 1)' is negative.  zend_alloc.c 1865 <br><br>  This code uses the operation of the right-sided bit shift of a negative value.  This is a case of unspecified behavior.  Although from the point of view of language, such a case is not wrong, in contrast to the indefinite behavior, it is better to avoid such cases, since the behavior of such code may differ depending on the platform and the compiler. <br><br>  Another interesting bug is contained in the PCRE library: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> pcre_uint32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PRIV</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ucp_gbtable[])</span></span></span><span class="hljs-function"> </span></span>= { .... (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;ucp_gbExtend)|(<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;ucp_gbSpacingMark)|(<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;ucp_gbL)| <span class="hljs-comment"><span class="hljs-comment">/* 6 L */</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;ucp_gbL)|(<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;ucp_gbV)|(<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;ucp_gbLV)|(<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;ucp_gbLVT), .... };</code> </pre> <br>  <b>PVS-Studio Warning:</b> <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions '(1 &lt;&lt; ucp_gbL)' to the left |  operator.  pcre_tables.c 161 <br><br>  Errors of this kind can be called classic.  They <a href="http://www.viva64.com/ru/examples/V501/">were</a> and are in C ++ projects, projects written in C # are <a href="http://www.viva64.com/ru/examples/V3001/">not spared from them</a> , and, probably, in other languages ‚Äã‚Äãtoo.  The programmer made a typo and duplicated a subexpression in the expression <i>(1 &lt;&lt; ucp_gbL)</i> .  Most likely (judging by the rest of the source code), the subexpression was implied <i>(1 &lt;&lt; ucp_gbT)</i> .  Such errors are not evident even in a separately written code fragment, and even against the background of the rest - they become generally extremely difficult to detect. <br><br>  By the way, my colleague wrote about this error in a previous article, but it's still there. <br><br>  Another place from the same library: <br><pre> <code class="cpp hljs">.... firstchar = mcbuffer[<span class="hljs-number"><span class="hljs-number">0</span></span>] | req_caseopt; firstchar = mcbuffer[<span class="hljs-number"><span class="hljs-number">0</span></span>]; firstcharflags = req_caseopt; ....</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0108/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'firstchar' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 8163, 8164. pcre_compile.c 8164 <br><br>  Agree, the code looks strange.  Write the result of the operation '|'  in the variable <i>firstchar</i> , and immediately overwrite its value, ignoring the result of the previous operation.  Perhaps, in the second case, instead of <i>firstchar</i> , another variable was implied, but it is certainly difficult to say. <br><br>  Excess conditions have also been met.  For example: <br><pre> <code class="cpp hljs">PHPAPI php_stream *_php_stream_fopen_with_path(.... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *path, ....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!path || (path &amp;&amp; !*path)) { .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0375/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0375/">V728 Alert</a> check can be simplified.  The '||'  operator path by and express expressions '! path' and 'path'.  plain_wrapper.c 1487 <br><br>  This expression is redundant: in the second subexpression you can remove the check of the <i>path</i> pointer for the inequality nullptr.  Then the simplified expression takes the following form: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!path || !*path)) {</code> </pre> <br>  Do not underestimate these mistakes.  Instead of the <i>path</i> variable, something else could have been completely implied, then the expression would not be redundant, but erroneous.  By the way, this is not the only place.  We met a few more: <ul><li>  V728 Anonymous check can be simplified.  The '||'  operator path by and express expressions '! path' and 'path'.  fopen_wrappers.c 643 </li><li>  V728 Anonymous check can be simplified.  The '||'  operator: headers_lc and headers_lc.  sendmail.c 728 </li></ul><br><h2>  About third-party libraries </h2><br>  I wrote about this above, but I want to repeat it again.  PHP uses some third-party libraries that, alas, are not perfect and contain bugs.  Many warnings were issued just on the code of these libraries.  It would be possible to analyze them all, but then, believe me, the article would have been very large. <br><br>  Determining whether the error is in the PHP interpreter code or a third-party library is quite simple - at the beginning of all the source files there is a comment describing the license, project, authors, etc. From these comments it is easy to determine which project file hid the error. <br><br>  On the other hand, some interesting places were worth considering.  In any case, if you use any third-party libraries, the responsibility to users for errors made in these libraries also falls on your shoulders, since the error may manifest itself in the use of your product.  Therefore, it is worth more attentively to what dependencies you are drawing in your project. <br><br><h2>  Conclusion </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c39/587/f86/c39587f861004498b4cc1c926e9a0401.png"></div><br><br>  The test results came out interesting.  In fact, there were a lot of errors; the article considered only a small part of the general warnings of high and medium confidence levels.  Many of these errors are in libraries that are used in PHP, which means, implicitly, wander into its code.  The PHP code itself also showed interesting errors, some of which were written above. <br><br>  Summing up, I would like to say that it is necessary to use various means to improve the productivity of work and the quality of the code.  You should not be limited to tests and code review.  A static analyzer is one of those tools that can help a programmer to write better code, allowing more useful time to be spent on finding errors made due to a typo.  But do not forget that the static analyzer is a tool for regular use.  And if you are not using it yet - I recommend <a href="http://www.viva64.com/ru/pvs-studio-download/">downloading</a> PVS-Studio, check your project and see what interesting things you can find. <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0392/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Sergey Vasiliev.  <a href="http://www.viva64.com/en/b/0392/">Analysis of PHP7</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/282684/">https://habr.com/ru/post/282684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282674/index.html">How does it feel to be a developer when you're forty</a></li>
<li><a href="../282676/index.html">Inheriting tables in Postgresql with Ruby on Rails</a></li>
<li><a href="../282678/index.html">Python: a programming language created by the community</a></li>
<li><a href="../282680/index.html">Color gap</a></li>
<li><a href="../282682/index.html">Test automation: Acronis Kernel ‚Äúdrone‚Äù</a></li>
<li><a href="../282688/index.html">Node.JS v6.0 released</a></li>
<li><a href="../282692/index.html">We are deploying Cisco ISE in a Hyper-V environment and beyond.</a></li>
<li><a href="../282694/index.html">Deploy the MEAN stack (MongoDB, Express, AngularJS, Node.js) in Microsoft Azure</a></li>
<li><a href="../282696/index.html">Xamarin Forms in action. Medchest Assistant</a></li>
<li><a href="../282698/index.html">Proximity detection system based on UWB technology</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>