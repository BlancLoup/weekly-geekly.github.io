<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making the code cleaner: Special vsnprintf () extensions in the Linux kernel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Looking at a bunch of source code that programmers send to the mailing lists of the Linux kernel subsystems sometimes you feel like crying. On the one...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making the code cleaner: Special vsnprintf () extensions in the Linux kernel</h1><div class="post__text post__text-html js-mediator-article"> Looking at a bunch of source code that programmers send to the mailing lists of the Linux kernel subsystems sometimes you feel like crying.  On the one hand, there is a terrible and indecent code, on the other - people may be trying to do something for the kernel for the first time, so they do not know all its features. <br><br>  Book Linux Device Drivers is outdated, and the new version will be released soon.  Therefore, I would like to fill in the gaps in the knowledge of those programmers who write code in the kernel. <br><a name="habracut"></a><br>  In this article I will discuss the special extensions of the print function in the Linux kernel.  Do not be embarrassed that I put out its traditional name in the header in the main C library, <code>printk()</code> and macros are used more often in the kernel. <br><br>  So, I will take the vanilla kernel version <b>4.0-rc2 as a basis</b> .  I will not consider standard specifiers, anyone can read printf (3). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All special extensions fall within the <b>% p</b> specifier.  By default, it prints the memory address referenced by the pointer.  In the core, you often want to do something much more specific.  To do this, we decided to go by adding modifiers to the specifier, so in general the specifier looks like this: <br><pre> <code class="cpp hljs">%[ ]p[   ,    ]</code> </pre><br><br>  Below, I tried to break down all extensions into groups and give brief descriptions and sometimes examples. <br><br><h3>  <font color="blue">Pointers to special addresses</font> </h3><br><br>  <b>% pK</b> <br><br>  Same as <b>% p</b> , but kptr_restrict sysctl is checked, 0'i are printed, if the user does not have enough rights. <br><br>  <b>% pa [pd]</b> <br><br>  Prints a pointer to a physical memory address or DMA (phys_addr_t, dma_addr_t) and inherited types resource_size_t.  It is passed by reference, for example: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">phys_addr_t</span></span> pa; <span class="hljs-keyword"><span class="hljs-keyword">dma_addr_t</span></span> da; pr_debug(<span class="hljs-string"><span class="hljs-string">"Phys: %pa DMA: %pad\n"</span></span>, &amp;pa, &amp;da);</code> </pre><br><br><h3>  <font color="blue">Network addresses</font> </h3><br><br>  <b>% p [Mm] [FR]</b> <br><br>  Prints the MAC address transmitted by the pointer to the buffer.  <b>M</b> - standard MAC address, <b>m</b> - without colons, additional modifier <b>R</b> in reverse format (first the last byte of the address is printed). <br><br><pre> <code class="cpp hljs">u8 mac[ETH_ALEN]; pr_debug(<span class="hljs-string"><span class="hljs-string">"%pMR\n"</span></span>, mac);</code> </pre><br><br>  <b>% p [Ii] 4 [hnbl],% p [Ii] 6 [c],% p [Ii] S [pfschnbl]</b> <br><br>  Prints in various combinations of IPv4 addresses (__be32 addr), IPv6 (__be32 addr [4]), and struct sockaddr (autodetection). <br><br><h3>  <font color="blue">Data buffer dump</font> </h3><br><br>  <b>% * pE [achnops]</b> <br><br>  Prints a string with escapes.  Flags define classes of characters that must be escaped. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buf; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len; pr_debug(<span class="hljs-string"><span class="hljs-string">"Buffer: %*pE Buffer[0-5]: %6pE\n"</span></span>, len, buf, buf);</code> </pre><br><br>  <b>% * ph [CDN]</b> <br><br>  Prints a memory dump (up to 64 bytes) in hexadecimal.  Modifiers define a separator: the default space, <b>C</b> - colon, <b>D</b> - hyphens, <b>N</b> - without separator. <br><br><pre> <code class="cpp hljs">u8 data[<span class="hljs-number"><span class="hljs-number">100</span></span>]; pr_debug(<span class="hljs-string"><span class="hljs-string">"Buf: %*phC\n"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(data), data); <span class="hljs-comment"><span class="hljs-comment">/* only first 64 bytes! */</span></span></code> </pre><br><br>  <b>% pU [Ll] [Bb]</b> <br><br>  Designed to output a UUID (16-byte buffer) in various formats.  Modifiers determine the size of the letters (large or small) and the writing order of the UUID: <b>B</b> or <b>b</b> are high bytes at the beginning, <b>L</b> or <b>l</b> are low bytes at the beginning. <br><br>  <b>% * pb [l]</b> <br><br>  Dumps bitmaps and its heirs (cpumask, nodemask).  The <b>l</b> modifier defines dump output by ranges.  The length field determines how many bits are in one element of the bitmap. <br><br><h3>  <font color="blue">Contents of structures, their fields and special data types</font> </h3><br><br>  <b>% p [Rr]</b> <br><br>  Prints the contents of the struct resource. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">res</span></span></span><span class="hljs-class">;</span></span> pr_debug(<span class="hljs-string"><span class="hljs-string">"%pR\n"</span></span>, &amp;res);</code> </pre><br><br>  <b>% pV</b> <br><br>  Outputting data defined by the va_format and va_list structures.  Essentially a recursive <code>vsnprintf()</code> call from under itself.  Be sure to check the validity of the parameters and arguments in va_format and va_list! <br><br>  <b>% pNF</b> <br><br>  Qualifier for type netdev_features_t. <br><br>  <b>% pd [234],% pD [234]</b> <br><br>  Prints the path and file name (struct dentry, d_name.name field).  <b>2</b> , <b>3</b> or <b>4</b> limits the number of path elements (from the end).  <b>% pD is</b> the same, but for struct file (f_path.dentry). <br><br><h3>  <font color="blue">Print function name at</font> </h3><br><br>  <b>% p [Ff],% p [Ss] [R],% pB</b> <br><br>  The qualifier may be useful for printing the name of the function at the address, for example, to know the calling function. <br><br><h3>  <font color="blue">In a future release</font> </h3><br><br>  Additional extensions are planned for <b>4.1-rc1</b> . <br><br>  <b>% pC [nr]</b> <br><br>  It is intended to display the name and frequency of the oscillator stored in struct clk. <br><br>  <b>% pT</b> <br><br>  Displays the name of the currently running process or task defined in struct task_struct. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">known_task</span></span></span><span class="hljs-class">;</span></span> pr_debug(<span class="hljs-string"><span class="hljs-string">"Current: %pT, given: %pT\n"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, task);</code> </pre><br><br><h3>  <font color="blue">Bonuses</font> </h3><br><br>  The function <code>print_hex_dump()</code> intended to output large buffer dumps in hexadecimal format. <br><br>  To convert ASCII &lt;-&gt; binary data, use a set of such functions: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> hex_to_bin(); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> hex2bin(); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span></code> </pre><br><br>  To convert a MAC address from a text view, use <code>mac_pton()</code> . <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/*  ASCII  */</span></span> hex_asc_lo(); hex_asc_hi(); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> hex_asc_upper_lo(); hex_asc_upper_hi(); <span class="hljs-comment"><span class="hljs-comment">/*  ,    */</span></span> hex_byte_pack(); hex_byte_pack_upper(); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> bin2hex(); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> hex_dump_to_buffer(); <span class="hljs-comment"><span class="hljs-comment">/*     print_hex_dump() */</span></span></code> </pre><br><br>  Happy printing! </div><p>Source: <a href="https://habr.com/ru/post/252453/">https://habr.com/ru/post/252453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252443/index.html">Documentation in Doxygen</a></li>
<li><a href="../252445/index.html">Fragmented video stream compression method</a></li>
<li><a href="../252447/index.html">Overview of the video on Go c FOSDEM 2015</a></li>
<li><a href="../252449/index.html">Freemium vs. Free: why we got rid of the free subscription</a></li>
<li><a href="../252451/index.html">Perl 6 command line interaction from MAIN function</a></li>
<li><a href="../252455/index.html">Go and Protocol Buffers practice (or quick start, for those who are not familiar yet)</a></li>
<li><a href="../252457/index.html">If you can not leave a comment, but really want, you can</a></li>
<li><a href="../252459/index.html">Lectures Technopark. Master class by Vladislav Biryukov "E-education: instructions for use"</a></li>
<li><a href="../252461/index.html">Automate and speed up the process of setting up cloud servers with Ansible. Part 5: local_action, conditions, cycles and roles</a></li>
<li><a href="../252467/index.html">Object class or class objects?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>