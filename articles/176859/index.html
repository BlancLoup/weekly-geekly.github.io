<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chronicles of LinguaLeo: how we did ‚ÄúDialogues in English‚Äù with Node.js and DynamoDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="LinguaLeo users are starting to learn English in the Jungle - a repository of thousands of materials of different levels of complexity, format and sub...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chronicles of LinguaLeo: how we did ‚ÄúDialogues in English‚Äù with Node.js and DynamoDB</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/113/540/089/113540089a6ff7822587234714dc967f.png"><br><br>  LinguaLeo users are starting to learn English in the <a href="http://lingualeo.ru/jungle">Jungle</a> - a repository of thousands of materials of different levels of complexity, format and subject matter;  step by step, learn to hear and understand native speakers and to expand vocabulary.  Who needs grammar - go to <a href="http://lingualeo.ru/course/grammar">Courses</a> .  Vocabulary is replenished not only from the Jungle, with the addition of unfamiliar words to the Personal Dictionary, but also with the help of prepared <a href="http://lingualeo.ru/glossary">Word sets</a> that are available for individual study.  In the Communication section, you can conduct <a href="http://habrahabr.ru/company/lingualeo/blog/164013/">Dialogues in English</a> in order to practice the language with other LinguaLeo users in real-time mode, choosing topics for communication.  Communication is only in English! <br><br>  We used Node.js, DynamoDB (all on AWS) to create Dialogs in English.  Now we will share our experience. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  <font color="fabd00">‚ñà</font> <font color="000000">Why Node.js?</font> </h3><br><img src="https://habrastorage.org/storage2/f2e/32d/3fe/f2e32d3fe7465c41a0239358d0f78e08.png"><br><br>  ‚Äú... To provide our users with all the possibilities for communication, we chose Node.js technology.  Why?  Node.js is adequate for working with streams, where there is a huge number of <a href="https://npmjs.org/">modules</a> .  In addition, a competent JavaScript programmer, working on Node, will be able to implement the entire volume of the task, and not just its server part (unlike, for example, from an Erlang specialist). <br><br>  As a ‚Äútransport hub‚Äù between the server and the client, we used WebSockets as the fastest way to deliver information. <br><br>  To solve the cross-platform problem, we chose the library <a href="https://github.com/sockjs">Sock.JS.</a>  First, because of compliance with W3C standards for WS, and secondly, Sock.JS is great for our needs. <br><br><img src="https://habrastorage.org/storage2/c5c/af4/8da/c5caf48da7a8f592c4f184c2cff8b8fd.jpg"><br><br>  So let's go.  We launched the Node.js daemon on Amazon EC2 cloud-based facilities.  Deployed application via git.  Forever module is responsible for logging and restarting.  By the way, Amazon has a very useful service - <a href="http://aws.amazon.com/cloudwatch/">Amazon Cloudwatch</a> .  Its functionality allows you to monitor the main parameters of the system, and most importantly its dignity - customizable notifications, which allow you to monitor only what is really important.  For detailed information about the state of the application, we use <a href="https://nodetime.com/">nodetime</a> . <br><br><img src="https://habrastorage.org/storage2/da9/f99/565/da9f995653043b3ce6815fccd28b29f1.jpg"><br><br>  As a driver for working with DynamoDB, the <a href="https://github.com/Wantworthy/dynode">dynode</a> module is <a href="https://github.com/Wantworthy/dynode">used</a> .  He proved himself well, but the imperfect technical documentation added tar to the honey barrel.  Amazon‚Äôs official <a href="http://aws.amazon.com/sdkfornodejs/">Node.js SDK</a> came out later and is still in the Developer Preview stage.  In such a <s>natural way</s> , it was decided to use products from Amazon, because they meet all the technical requirements. <br><br><img src="https://habrastorage.org/storage2/ace/a39/cea/acea39cea53d2d5cd8cdb285aa3541fc.jpg"><br><br><h3>  <font color="fabd00">‚ñà</font> <font color="000000">Subtleties of Node.js</font> </h3><br>  We paid special attention to the problem of user authorization on the dialog server.  We are responsible for authorization on the server cookies.  This is a very ‚Äúexpensive‚Äù solution in terms of speed, but it impresses with stability and security, plus an independent service-oriented architecture. <br><br>  How it works?  User cookies are delivered via WebSockets to the dialog server ‚Üí the dialog server checks the validity of the cookie by sending a request with the received cookie to our API, and it already gives the user data back.  If the data is received without errors, the Dialogs server does its work (authorizes) and sends the data to the <a href="https://gist.github.com/mbarinov/5102527">user</a> . <br><br>  We know that many people work at LinguaLeo not only at home, but also at work.  It often happens that corporate firewalls are configured too strictly, which is why all ports, except the standard ones, are inaccessible.  We remember this, and for WebSocket connections we use port 443 (without binding to https).  This solution avoids potential network problems. <br><br><h3>  <font color="fabd00">‚ñà</font> <font color="000000">DynamoDB Features</font> </h3><br>  Just over a year ago, Amazon released a distributed NoSQL database - Amazon <a href="http://aws.amazon.com/dynamodb/">DynamoDB</a> .  At the design stage of the system architecture, we had a choice between two products: MongoDB and DynamoDB.  From the first option, we refused because of the complexity of the administration, and the choice fell on Amazon, as support in the case of its product was not required.  And, of course, it was interesting to ‚Äúroll in‚Äù the technology for further use. <br><br>  It turned out that working with DynamoDB is very different from all that we used to see.  Being a SaaS product, this thing taught us to take into account the time for the http request.  Within the Amazon datacenter, the average request time is about 20 milliseconds, because of which we came to the conclusion: it is highly desirable to do all the samples only via indices (this is faster and cheaper), and use scan queries exclusively for analytics or migrations. <br><br><h3>  <font color="fabd00">‚ñà</font> <font color="000000">Data structure</font> </h3><br>  Dialogs - storage of dialog metadata, caching the last message. <br><br><img src="https://habrastorage.org/storage2/c45/912/34d/c4591234d0c9e49885e56c947eb72aa6.jpg"><br><br>  UserDialogs - a list of user dialogs, caching + unread message counter. <br><br><img src="https://habrastorage.org/storage2/2e1/c56/b3d/2e1c56b3d6797c1254cd8c4b38546e1b.jpg"><br><br>  Messages - all user messages. <br><br><img src="https://habrastorage.org/storage2/2fc/af8/85f/2fcaf885fd29d20a292f47f16c24e1ea.jpg"><br><br>  User2User - members of the dialogue. <br><br><img src="https://habrastorage.org/storage2/9e0/19c/5f3/9e019c5f37bf6dbfe6ce2394e947f48c.jpg"><br><br>  <b>Example 1</b> <br><br>  The process of getting all user conversations for the <a href="http://lingualeo.com/savanna/dialogs">‚ÄúMy Conversations in English‚Äù</a> page is implemented outside the box.  On the page, the user sees all his dialogs, including the total number of unread messages, as well as the last message of each dialogue. <br><br>  Data is selected for two requests.  The first is to select all dialoglds from the UserDialogs table using <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/API_Query.html">Query</a> .  The second is getting conversations through BatchGetItem.  There is a small nuance - <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/API_BatchGetItems.html">BatchGetItem</a> selects a maximum of 100 messages at a time.  Therefore, if the user has 242 pieces, we will need to make 3 requests, which takes about 70-100 milliseconds.  Keeping this in mind and striving for greater performance optimization, we cache the dialog data in <a href="http://aws.amazon.com/elasticache/">ElasticCache</a> , updating it with each new message. <br><br><img src="https://habrastorage.org/storage2/a6b/8c8/16b/a6b8c816b48e8c0ef8d6a586d6ec34c8.png"><br><br>  <b>Example 2</b> <br><br>  Adding a new message to the dialogue also happens nontrivially.  The speed of the database is not very important to us, since we do not wait for the recording in DynamoDB.  We need to conduct a large number of records, and this plays a significant role for the speed of subsequent sampling.  First, we write a new message to the <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/API_PutItem.html">Messages PutItem</a> table, and then we cache it in the <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/API_UpdateItem.html">Dialogs UpdateItem</a> table.  Next we need to set the messageCounter in the UserDialogs table for each user (UpdateItem).  Anything can happen, all of a sudden one of the users decided to delete the dialog and dropped the message counter to us.  In the sum = 4 requests, about 70-100 milliseconds gather in time.  Unfortunately, such transactions are not supported in DynamoDB, which imposes tangible restrictions for processes where data integrity is critical. <br><br>  In general, changing the requirements for the product is a rather frequent phenomenon.  Sometimes this entails a transformation of the data structure.  In relational databases, this is solved using ALTER TABLE, but in DynamoDB this is simply not the case.  Changing the scheme here is very expensive.  We have to re-create the tables or use <a href="http://aws.amazon.com/elasticmapreduce/">Elastic MapReduce</a> .  For both options have to pay.  A lot of data = a lot of money.  In order to cope with this somehow, I had to select all the data with Scan for 1 megabyte, and then write to a new table.  It takes a lot of time, but this is a fee for the lack of DBA. <br><br><h3>  <font color="fabd00">‚ñà</font> <font color="000000">Impressions from DynamoDB</font> </h3><br>  Our experiment on using DynamoDB was a success.  This is an amazing database that is easy to scale.  Work with her and forget about administration.  But remember: in return, it requires careful handling at the architectural design stage.  Otherwise there are all sorts of unexpected turns and unpleasant rakes.  We recommend using DynamoDB if there is a lot of non-critical data, and you need to work with them often.  We use - we like ‚Äù:) <br><br>  *** <br>  Communicate easily and naturally in <a href="http://lingualeo.ru/savanna/dialogs">English Dialogues</a> - practice English in a pleasant company and <a href="https://docs.google.com/a/lingualeo.com/document/d/1jrYc4hHDmHi8YgQ3lclKGg4gt3Buq6WgZpfCkpijWK4/edit">join our team</a> ! <br><br>  Follow the news on <a href="">Facebook</a> , <a href="http://vkontakte.ru/lingualeo_ru">Vkontakte</a> and <a href="https://twitter.com/lingualeo">Twitter</a> , share your impressions and have fun.  Freedom of communication is great! <br><br><img src="http://habr.habrastorage.org/post_images/f7b/bb8/f60/f7bbb8f6061695fe55a540824f4428f3.png">  Team LinguaLeo </div><p>Source: <a href="https://habr.com/ru/post/176859/">https://habr.com/ru/post/176859/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176841/index.html">Fujitsu development allows you to work with a sheet of paper, as with a touch screen</a></li>
<li><a href="../176843/index.html">Video: Samsung ATIV Smart PC XE700T Tablet Review</a></li>
<li><a href="../176851/index.html">Prism Developer Guide - Part 1, Introduction</a></li>
<li><a href="../176853/index.html">Prism Developer Guide - Part 2, Initializing Prism Applications</a></li>
<li><a href="../176857/index.html">Stanford invented a fully passive air conditioner</a></li>
<li><a href="../176861/index.html">Prism Developer Guide - Part 3, managing dependencies between components</a></li>
<li><a href="../176863/index.html">Prism Developer Guide - Part 4, Modular Application Development</a></li>
<li><a href="../176867/index.html">Prism Developer Guide - Part 5, MVVM Pattern Implementation</a></li>
<li><a href="../176869/index.html">Prism Developer Guide - Part 6, Advanced MVVM Scripts</a></li>
<li><a href="../176877/index.html">How we did the Rubens Pipe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>