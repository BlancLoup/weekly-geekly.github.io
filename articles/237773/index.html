<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing a client-server web-based application using OWIN</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 On Habr√©, the topic of OWIN has been touched many times, but so far, questions about the implementation of applications and components ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing a client-server web-based application using OWIN</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  On Habr√©, the <a href="http://habrahabr.ru/search/%3Fq%3Dowin">topic of OWIN</a> has been <a href="http://habrahabr.ru/search/%3Fq%3Dowin">touched</a> many times, but so far, questions about the implementation of applications and components using OWIN still surface.  In this publication, I will start with the standard Visual Studio 2013 template and demonstrate the implementation of the application architecture.  I will also show how to use a single DI container - both for MVC and for WebApi in a single project. <br><a name="habracut"></a><br><h4>  Configuring WebApi </h4><br>  In the standard VS2013 template, the WebApi configuration is performed in global.asax.  Let's transfer it to the Startup class. <br><br>  Now, register the OWIN module of WebApi.  To do this, we need to install the appropriate NuGet package.  Open the Package Manager Console and enter: <br><br><pre><code class="bash hljs">PM&gt; Install-Package Microsoft.AspNet.WebApi.Owin</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After installing the package, we can register OWIN Middleware for WebApi. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiConfig = ConfigureWebApi(); ConfigureDependencyInjection(app, apiConfig); app.UseWebApi(apiConfig);</code> </pre><br><br>  We will talk further about the ‚ÄúConfigureDependencyInjection‚Äù method. <br><br><h4>  Configuring a DI Container </h4><br>  In this example, I use the Autofac DI container, since  it already has the necessary implementations of the DependencyResolver classes for WebApi and MVC, as well as extension methods for integration with OWIN. <br><br>  Install the necessary modules: <br><br><pre> <code class="bash hljs">PM&gt; Install-Package Autofac.Mvc5 PM&gt; Install-Package Autofac.WebApi2.Owin</code> </pre><br><br>  To integrate MVC and Owin, you need to install another package: <br><br><pre> <code class="bash hljs">PM&gt; Install-Package Autofac.Mvc5.Owin</code> </pre><br><br>  As I want to demonstrate using a single container for WebApi and MVC, container initialization will be located in the OWIN configuration class. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureDependencyInjection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IAppBuilder app, HttpConfiguration apiConfig</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContainerBuilder(); Assembly executingAssembly = Assembly.GetExecutingAssembly(); builder.RegisterApiControllers(executingAssembly); builder.RegisterControllers(executingAssembly); RegisterComponents(builder); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> container = builder.Build(); app.UseAutofacMiddleware(container); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiResolver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AutofacWebApiDependencyResolver(container); apiConfig.DependencyResolver = apiResolver; app.UseAutofacWebApi(apiConfig); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mvcResolver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AutofacDependencyResolver(container); DependencyResolver.SetResolver(mvcResolver); app.UseAutofacMvc(); }</code> </pre><br><br>  With this code, everything is very simple.  First we create a ContainerBuilder and register our controllers in it, then register the services.  After that we create a container and set it as a DependencyResolver for WebApi and Mvc. <br><br>  Here it is necessary to pay attention to the app.UseAutofacMvc (); line.  Calling this method allows you to extend LifetimeScope objects so that they are involved in MVC. <br><br><h4>  Implementation of the application security component on the example of AspNet Identity </h4><br><h5>  Registering components </h5><br>  AspNet Identity packages are already installed in the standard application template, but if you started with an empty template, you need to install the following packages: <br><br><pre> <code class="bash hljs">PM&gt; Install-Package Microsoft.AspNet.Identity.Owin PM&gt; Install-Package Microsoft.AspNet.Identity.EntityFramework</code> </pre><br><br>  To implement AspNet Identity security, we need to register four classes: <br><br><ul><li>  UserManager &lt;ApplicationUser&gt; </li><li>  SignInManager &lt;ApplicationUser, string&gt; </li><li>  IUserStore &lt;ApplicationUser&gt; </li><li>  IAuthenticationManager </li></ul><br><br>  There are no problems with registering the SignInManager &lt;ApplicationUser, string&gt; and IUserStore components, the code for their registration is shown below. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterComponents</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ContainerBuilder builder</span></span></span><span class="hljs-function">)</span></span> { builder.RegisterType&lt;ApplicationDbContext&gt;().As&lt;DbContext&gt;().InstancePerRequest(); builder.RegisterType&lt;ApplicationSignInManager&gt;().As&lt;SignInManager&lt;ApplicationUser, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;().InstancePerRequest(); builder.RegisterType&lt;UserStore&lt;ApplicationUser&gt;&gt;().As&lt;IUserStore&lt;ApplicationUser&gt;&gt;().InstancePerRequest(); }</code> </pre><br><br>  It is worth noting that as IUserStore I used the AspNet.Identity.EntityFramework class library, so the ApplicationDbContext class is present in the registration. <br><br>  Next you need to register the IAuthenticationManager.  It should be noted here that the implementation of the IAuthenticationManager interface does not have an open constructor, so we set the factory method. <br><br><pre> <code class="cs hljs">builder.Register&lt;IAuthenticationManager&gt;((c, p) =&gt; c.Resolve&lt;IOwinContext&gt;().Authentication).InstancePerRequest();</code> </pre><br><br>  The IOwinContext.Authentication property is actually a factory method and provides us with a new AuthenticationManager on every call. <br><br>  Now you need to register the class UserManager.  The constructor of this class is of no particular interest, but the factory method ‚ÄúCreate‚Äù, which is responsible for the creation and configuration of this class, is defined later in this class. <br><br>  Transfer the creation and configuration of the class to the factory method autofac to keep the entire configuration together.  In this case, we will face a small problem.  The ‚ÄúCreate‚Äù method takes IdentityFactoryOptions as one of the arguments.  We cannot create IdentityFactoryOptions ourselves.  Fortunately, there is an IAppBuilder.GetDataProtectionProvider () method, located in the Microsoft.Owin.Security.DataProtection namespace. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataProtectionProvider = app.GetDataProtectionProvider(); builder.Register&lt;UserManager&lt;ApplicationUser&gt;&gt;((c, p) =&gt; BuildUserManager(c, p, dataProtectionProvider));</code> </pre><br><br><h5>  Business logic </h5><br>  Now you can use our DI container to implement the application logic.  If we look in AccountController, we will see the following lines there: <br><br><pre> <code class="cs hljs">HttpContext.GetOwinContext().Get&lt;ApplicationSignInManager&gt;(); HttpContext.GetOwinContext().GetUserManager&lt;ApplicationUserManager&gt;(); HttpContext.GetOwinContext().Authentication;</code> </pre><br><br>  Using these lines, objects of the UserManager, SignInManager, and IAuthenticationManager classes are permitted, respectively.  This approach is offered by the AspNet Identity library.  It does not suit us for several reasons, the most obvious of them are: <br><br><ol><li>  Using ServiceLocator does not allow us to control dependencies within a class. </li><li>  The appearance of the second DI container, which directly depends on the AspNet Identity. </li></ol><br><br>  Remove the UserManager, SignInManager, AuthenticationManager properties and add the _userManager and _authenticationManager fields initialization through the constructor.  Also remove the constructor without parameters.  Similarly, fix ManageController.  In the Identity configuration method, we remove the rows that register our classes in OwinContext. <br><br><pre> <code class="cs hljs"> app.CreatePerOwinContext(ApplicationDbContext.Create); app.CreatePerOwinContext&lt;ApplicationUserManager&gt;(ApplicationUserManager.Create); app.CreatePerOwinContext&lt;ApplicationSignInManager&gt;(ApplicationSignInManager.Create);</code> </pre><br><br>  Now you can remove the extra packages responsible for integrating WebApi with IIS. <br><br><pre> <code class="bash hljs">Uninstall-Package Microsoft.AspNet.WebApi Uninstall-Package Microsoft.AspNet.WebApi.WebHost</code> </pre><br><br><h4>  Conclusion </h4><br>  In this publication, we learned how to implement the modular structure of an ASP.Net application with registering components as an OWIN Middleware, register a single Dependency Injection container for ASP.Net MVC and WebApi and implement an application security module with it. <br><br>  The full application code is available via the <a href="https://github.com/Agaspher20/OwinDISample">link on GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/237773/">https://habr.com/ru/post/237773/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../237763/index.html">NASA Solve website and a contest of ideas for turning ballast in descent vehicles into payload</a></li>
<li><a href="../237765/index.html">Overview of decentralized technology. Part 1</a></li>
<li><a href="../237767/index.html">Six steps to prepare data for analytic CRM</a></li>
<li><a href="../237769/index.html">Prospects and difficulties of Mesh-networks in the market of mobile applications</a></li>
<li><a href="../237771/index.html">A little bit about WebKit internals</a></li>
<li><a href="../237775/index.html">The main question of life, the universe and all that, or Time to start</a></li>
<li><a href="../237779/index.html">What to do with a dusty GPU if you are a pentester. Part 1: Legacy ATI / AMD RADEON</a></li>
<li><a href="../237783/index.html">Error teams in the accelerator: how to attract the next round of investment</a></li>
<li><a href="../237785/index.html">Technology categorization: MP3 and iPod</a></li>
<li><a href="../237789/index.html">Agate 9 is the Soviet answer to Apple. Part one</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>