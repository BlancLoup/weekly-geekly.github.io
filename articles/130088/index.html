<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a Redmine Plugin</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably many have heard about the Redmine project management system, and some may even have used it in their work. Redmine is a fairly flexible cross...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a Redmine Plugin</h1><div class="post__text post__text-html js-mediator-article"> Probably many have heard about the <a href="http://www.redmine.org/">Redmine</a> project management system, and some may even have used it in their work.  Redmine is a fairly flexible cross-platform system written in the well-known Ruby on Rails framework.  Like most similar systems, Redmine allows you to extend its functionality through third-party plug-ins.  At the moment there are already more than a thousand of such plug-ins for different taste and color.  I want to talk about one of them and how to write a plug-in to Redmine using his example. <br><a name="habracut"></a><br>  <a href="http://www.redmine.org/plugins/redmine_repository">Repository plugin</a> - a plugin that allows you to download files and folders from the repository (repository) of the project in one zip-archive.  Redmine offers a visual <a href="http://www.redmine.org/projects/redmine/wiki/Plugin_Tutorial">guide</a> to creating plugins. <br>  So, let's start writing the plugin.  Everything that is written below concerns redmine installed on a web server with Linux. <br>  First, we move to the directory where redmine is installed (for example / var / www / redmine): <br><br> <code>$ cd /var/www/redmine</code> <br> <br>  Set the environment variable RAILS_ENV: <br><br> <code>$ export RAILS_ENV="production"</code> <br> <br>  Now we can generate the necessary files for our plugin: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>$ ruby script/generate redmine_plugin repository <br> create vendor/plugins/redmine_repository/app/controllers <br> create vendor/plugins/redmine_repository/app/helpers <br> create vendor/plugins/redmine_repository/app/models <br> create vendor/plugins/redmine_repository/app/views <br> create vendor/plugins/redmine_repository/db/migrate <br> create vendor/plugins/redmine_repository/lib/tasks <br> create vendor/plugins/redmine_repository/assets/images <br> create vendor/plugins/redmine_repository/assets/javascripts <br> create vendor/plugins/redmine_repository/assets/stylesheets <br> create vendor/plugins/redmine_repository/lang <br> create vendor/plugins/redmine_repository/README <br> create vendor/plugins/redmine_repository/init.rb <br> create vendor/plugins/redmine_repository/lang/en.yml <br></code> <br>  Edit the file vendor / plugins / redmine_repository / init.rb, specifying <br>  it contains the name, description of the plugin, the author and the minimum version of redmine for which the plugin is written: <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'redmine'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'dispatcher'</span></span> Redmine::Plugin.register <span class="hljs-symbol"><span class="hljs-symbol">:redmine_repository</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> name <span class="hljs-string"><span class="hljs-string">'Redmine Repository plugin'</span></span> author <span class="hljs-string"><span class="hljs-string">'Sanny'</span></span> description <span class="hljs-string"><span class="hljs-string">'This is a reposirory plugin for Redmine'</span></span> version <span class="hljs-string"><span class="hljs-string">'0.0.2'</span></span> requires_redmine <span class="hljs-symbol"><span class="hljs-symbol">:version_or_higher</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1.1.2'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Our plugin should allow you to choose which files to download from the repository.  Therefore, it is necessary to add checkboxes to the existing storage type <br><img src="https://habrastorage.org/getpro/habr/post_images/246/58b/19b/24658b19b0e934f19395a283c507e7c0.png" alt="image"><br>  Because  It is necessary to change the existing type of storage, the easiest way is to copy the files that are responsible for the appearance of the storage into the appropriate directory of our plugin and then edit these files: <br><br> <code>$ cp app/views/repositories/_dir_lsit.rhtml vendor/plugins/redmine_repository/app/views/repositories <br> $ cp app/views/repositories/_dir_lsit_content.rhtml vendor/plugins/redmine_repository/app/views/repositories <br> $ cp app/views/repositories/show.rhtml vendor/plugins/redmine_repository/app/views/repositories <br></code> <br>  The _dir_lsit.rhtml file is responsible for displaying the storage file system tree.  There we will add a ‚ÄúDownload‚Äù button to download: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">authorize_for</span></span></span><span class="hljs-tag">('</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">repositories</span></span></span><span class="hljs-tag">', '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">entries_operation</span></span></span><span class="hljs-tag">') %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"float: right;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">submit_tag</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">l</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:Download</span></span></span><span class="hljs-tag">), </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:name</span></span></span><span class="hljs-tag"> =&gt;</span></span> "download_entries") %&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span></code> </pre><br>  In order for the button to work, we wrap all the code in form_tag: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">form_tag</span></span></span><span class="hljs-tag">({</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:action</span></span></span><span class="hljs-tag"> =&gt;</span></span> "entries_operation"}, :method =&gt; :post, :id =&gt; "Entries") do %&gt; ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">authorize_for</span></span></span><span class="hljs-tag">('</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">repositories</span></span></span><span class="hljs-tag">', '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">entries_operation</span></span></span><span class="hljs-tag">') %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"float: right;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">submit_tag</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">l</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:Download</span></span></span><span class="hljs-tag">), </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:name</span></span></span><span class="hljs-tag"> =&gt;</span></span> "download_entries") %&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span></code> </pre><br>  Now add a checkbox to each entry in the vault mapping.  To do this, make the following change to the _dir_lsit_content.rhtml file: <br>  instead <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">entry.is_dir</span></span></span><span class="hljs-tag">? %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"expander"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;%= remote_function :url =&gt; {:action =&gt; 'show', :id =&gt; @project, :path =&gt; to_path_param(ent_path), :rev =&gt; @rev, :depth =&gt; (depth + 1), :parent_id =&gt; tr_id}, :method =&gt; :get, :update =&gt; { :success =&gt; tr_id }, :position =&gt; :after, :success =&gt; "</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scmEntryLoaded</span></span></span><span class="hljs-tag">('#{</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tr_id</span></span></span><span class="hljs-tag">}')", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:condition</span></span></span><span class="hljs-tag"> =&gt;</span></span> "scmEntryClick('#{tr_id}')"%&gt;"&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span></code> </pre><br>  write <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">entry.is_dir</span></span></span><span class="hljs-tag">? %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"expander"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;%= remote_function :url =&gt; {:action =&gt; 'show', :id =&gt; @project, :path =&gt; to_path_param(entry.path), :rev =&gt; @rev, :depth =&gt; (depth + 1), :parent_id =&gt; tr_id, :p arent_val =&gt; entry.path}, :method =&gt; :get, :update =&gt; { :success =&gt; tr_id }, :position =&gt; :after, :success =&gt; "</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scmEntryLoaded</span></span></span><span class="hljs-tag">('#{</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tr_id</span></span></span><span class="hljs-tag">}')", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:complete</span></span></span><span class="hljs-tag"> =&gt;</span></span> "checkBranch('#{tr_id}', getParentNodeChecked('#{params[:parent_val]}'))", :condition =&gt; "scmEntryClick('#{tr_id}')"%&gt;"&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">check_box_tag</span></span></span><span class="hljs-tag">("</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">folders</span></span></span><span class="hljs-tag">[]", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">entry.path</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">false</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:id</span></span></span><span class="hljs-tag"> =&gt;</span></span> params[:parent_id], :onclick =&gt; "checkBranch('#{tr_id}', this.checked);" ) if authorize_for('repositories', 'entries_operation') %&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">else</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"padding-left: 8px"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">check_box_tag</span></span></span><span class="hljs-tag">("</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">files</span></span></span><span class="hljs-tag">[]", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">entry.path</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">false</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:id</span></span></span><span class="hljs-tag"> =&gt;</span></span> params[:parent_id]) if authorize_for('repositories', 'entries_operation') %&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span></code> </pre><br>  Here two self-written javascript functions are used: <br>  <code>getParentNodeChecked(parentVal)</code> - determines the state of the checkbox of the parent of this tree node, <br>  <code>checkBranch(parentId, checked)</code> - sets the checkboxes of the descendants of the tree node to the state of the parent (roughly speaking, if a directory is selected, then all the subdirectories and files in this directory are highlighted). <br>  Create them in the new assets / javascripts / repository.js file <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getParentNodeChecked</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">parentVal</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'Entries'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;form.elements.length;i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e = form.elements[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(e.type==<span class="hljs-string"><span class="hljs-string">'checkbox'</span></span> &amp;&amp; e.value == parentVal) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e.checked; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkBranch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">parentId, checked</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> allchecked = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> has_check_tree = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'Entries'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;form.elements.length;i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e = form.elements[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(e.type==<span class="hljs-string"><span class="hljs-string">'checkbox'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(e.id == parentId) { e.checked = !checked; e.click(); } allchecked = allchecked &amp;&amp; e.checked; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(e.name == <span class="hljs-string"><span class="hljs-string">"check_tree"</span></span>) has_check_tree = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(has_check_tree) form.check_tree.checked = allchecked; }</code> </pre><br>  Let's connect our repository.js to our new repository mapping (in the show.rhtml file): <br><pre> <code class="html hljs xml">... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content_for</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:header_tags</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stylesheet_link_tag</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scm</span></span></span><span class="hljs-tag">" %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">javascript_include_tag</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">repository.js</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:plugin</span></span></span><span class="hljs-tag"> =&gt;</span></span> "redmine_repository" %&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span></code> </pre><br>  It remains to add the function of archiving the selected folders and files.  The implementation will be done in ruby.  Additionally, to support zip archives, you need to install the rubyzip package (gem install rubyzip). <br>  Create a RepositoryZip class that will directly archive (app / helpers / repository_zip.rb file): <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'zip/zip'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'zip/zipfilesystem'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepositoryZip</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_count</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">() @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Tempfile</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(["</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository_zip</span></span></span><span class="hljs-class">",".</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip</span></span></span><span class="hljs-class">"]) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip_file</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Zip::ZipOutputStream</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">path</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_count</span></span></span><span class="hljs-class"> = 0 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">finish</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip_file</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">close</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unless</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip_file</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil?</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">path</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unless</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil?</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">close</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip_file</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">close</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unless</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip_file</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil?</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">close</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unless</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil?</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">add_file</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cat</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip_file</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">put_next_entry</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip_file</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">write</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cat</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_count</span></span></span><span class="hljs-class"> += 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">add_folder</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">folder</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zip_file</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">put_next_entry</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">folder</span></span></span><span class="hljs-class"> + "/") </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Now let's ‚Äúpatch‚Äù the class RepositoriesController existing in redmine by adding several methods to it (file lib / repositories_controller_patch.rb).  I will not dwell on the logic of this ‚Äúpatch‚Äù, just give the code: <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'tree'</span></span> require_dependency <span class="hljs-string"><span class="hljs-string">'application_controller'</span></span> require_dependency <span class="hljs-string"><span class="hljs-string">'repositories_controller'</span></span> require_dependency <span class="hljs-string"><span class="hljs-string">'repository_zip'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepositoriesControllerPatch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">included</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">base</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># :nodoc: base.extend(ClassMethods) base.send(:include, InstanceMethods) base.class_eval do unloadable #  unloadable      end end module ClassMethods end module InstanceMethods def entries_operation selected_folders = params[:folders].nil? ? [] : params[:folders] selected_files = params[:files].nil? ? [] : params[:files] if selected_folders.empty? &amp;&amp; selected_files.empty? flash[:warning] = l(:warning_no_entries_selected) redirect_to :action =&gt; "show", :id =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@project</span></span></span></span><span class="hljs-class"><span class="hljs-comment">, :path =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@path</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> return end # make a selected files and folders tree selected_tree = Tree::TreeNode.new(".", "root") selected_files.each do |file| folder = Pathname.new(file).dirname.to_s selected_tree_node = selected_tree if !folder.match(/^\.+$/) folder.split("/").each do if selected_tree_node[folder].nil? selected_tree_node = selected_tree_node.add(Tree::TreeNode.new(folder, "folder")) else selected_tree_node = selected_tree_node[folder] end end selected_tree_node &lt;&lt; Tree::TreeNode.new(file, "file") else selected_tree &lt;&lt; Tree::TreeNode.new(file, "file") end end selected_folders.each do |folder| selected_tree_node = selected_tree folder.split("/").each do if selected_tree_node[folder].nil? selected_tree_node = selected_tree_node.add(Tree::TreeNode.new(folder, "folder")) else selected_tree_node = selected_tree_node[folder] end end selected_tree_node &lt;&lt; Tree::TreeNode.new(file, "file") else selected_tree &lt;&lt; Tree::TreeNode.new(file, "file") end end selected_folders.each do |folder| selected_tree_node = selected_tree folder.split("/").each do if selected_tree_node[folder].nil? selected_tree_node = selected_tree_node.add(Tree::TreeNode.new(folder, "folder")) else selected_tree_node = selected_tree_node[folder] end end end begin if !params[:email_entries].blank? email_entries(selected_tree) else download_entries(selected_tree) end rescue =&gt; e flash[:warning] = l(:error_in_getting_files) + " (" + e.message + ")" redirect_to :action =&gt; "show", :id =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@project</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> end end def download_entries(selected_tree) zip = RepositoryZip.new zip_entries(zip, selected_tree) send_file(zip.finish, :filename =&gt; filename_for_content_disposition(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@project</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.name + "-" + DateTime.now.strftime("%y%m%d%H%M%S") + ".zip"), :type =&gt; "application/zip", :disposition =&gt; "attachment") ensure zip.close unless zip.nil? end def zip_entries(zip, selected_tree) selected_tree.children.each do |node| if node.content == "file" zip.add_file(node.name, </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@repository</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.cat(node.name, </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@rev</span></span></span></span><span class="hljs-class"><span class="hljs-comment">)) else zip.add_folder(node.name) if node.hasChildren? # add selected subfolders zip_entries(zip, node) else # add all subfolders with files entries = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@repository</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.entries(node.name, </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@rev</span></span></span></span><span class="hljs-class"><span class="hljs-comment">) entries.each do |entry| node &lt;&lt; Tree::TreeNode.new(entry.path, entry.is_dir? ? "folder" : "file") end end zip_entries(zip, node) end end zip end end # of InstaceMethods end # of module RepositoriesController.send(:include, RepositoriesControllerPatch)</span></span></span></span></code> </pre><br>  The <code>entries_operation</code> method <code>entries_operation</code> responsible for generating a list of files and folders for archiving. <br>  The <code>download_entries</code> method is responsible for downloading the archive by the user. <br>  The <code>zip_entries</code> method <code>zip_entries</code> responsible for archiving the selected files and folders. <br><br>  That's all for all.  All that remains is to add permissions to download files to users of the redmine system and localize the plugin.  Edit the init.rb file to add permissions: <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'redmine'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'dispatcher'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'repositories_controller_patch'</span></span> Redmine::Plugin.register <span class="hljs-symbol"><span class="hljs-symbol">:redmine_repository</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> name <span class="hljs-string"><span class="hljs-string">'Redmine Repository plugin'</span></span> author <span class="hljs-string"><span class="hljs-string">'Sanny'</span></span> description <span class="hljs-string"><span class="hljs-string">'This is a reposirory plugin for Redmine'</span></span> version <span class="hljs-string"><span class="hljs-string">'0.0.2'</span></span> requires_redmine <span class="hljs-symbol"><span class="hljs-symbol">:version_or_higher</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1.1.2'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> Redmine::AccessControl.map <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|map|</span></span> map.project_module <span class="hljs-symbol"><span class="hljs-symbol">:repository</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|map|</span></span> map.permission <span class="hljs-symbol"><span class="hljs-symbol">:operations</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:repositories</span></span> =&gt; [<span class="hljs-symbol"><span class="hljs-symbol">:entries_operation</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Localization files are located in the config / locales directory.  For the Russian language create a file ru.yml: <br><pre> <code class="hljs objectivec">ru: Download: <span class="hljs-string"><span class="hljs-string">"Download"</span></span> warning_no_entries_selected: <span class="hljs-string"><span class="hljs-string">"  "</span></span> error_in_getting_files: <span class="hljs-string"><span class="hljs-string">"    "</span></span> permission_operations: <span class="hljs-string"><span class="hljs-string">"    "</span></span></code> </pre><br>  Restart redmine, set permissions for downloading files with one archive for different users of the system and use. <br></div><p>Source: <a href="https://habr.com/ru/post/130088/">https://habr.com/ru/post/130088/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130082/index.html">Creating a simple module for CMS Datalife Engine (DLE)</a></li>
<li><a href="../130084/index.html">Excel Add-in Guide for Beginners</a></li>
<li><a href="../130085/index.html">Encryption / decryption of data on the client in web-based systems</a></li>
<li><a href="../130086/index.html">PHP sample development case using TDD</a></li>
<li><a href="../130087/index.html">My experience of writing a program for Android</a></li>
<li><a href="../130089/index.html">Imitation of named variables in LESS (with an example in jsFiddle)</a></li>
<li><a href="../130090/index.html">Firewalls - a bit of theory for beginners or what you need to know before you buy</a></li>
<li><a href="../130091/index.html">Free software at school or three days spent with benefit</a></li>
<li><a href="../130092/index.html">CPIO under the microscope</a></li>
<li><a href="../130093/index.html">Understanding WinAPI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>