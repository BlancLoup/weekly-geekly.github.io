<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We deployed our own in the cloud. Install CoreOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have always been interested in cloud technologies. Including the most trending of them - this is decentralization, clustering, optimization and dist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We deployed our own in the cloud. Install CoreOS</h1><div class="post__text post__text-html js-mediator-article">  I have always been interested in cloud technologies.  Including the most trending of them - this is decentralization, clustering, optimization and distribution of everything: computing resources, data, <s>donuts and power</s> .  Therefore, I could not pass by CoreOS, about which there is a lot of talk in the IT community now, and which became for me the starting point for experiments. <br><br>  To combine business with pleasure, I began to look for a suitable application on which, on the one hand, it would be interesting to apply cloud technologies, and on the other, it could be useful in the future.  Therefore, I decided to deploy an installation of OwnCloud based on CoreOS. <br>  Now I will tell you what this has led to, and in the course of the action I will provide links so that the person interested can deepen their knowledge in the subject field.  But if you have questions - feel free to ask them in the comments. <br><a name="habracut"></a><br>  So, I set myself tasks: <br><ol><li>  Install CoreOS on bare-metal server </li><li>  Configure Distributed Data Warehouse </li><li>  Write your Dockerfile and run the application in a cluster </li><li>  Configure automatic update and registration of containers </li><li>  Consider unused technologies and come up with an application for them (*) </li></ol><br>  In this article I will talk about installing CoreOS.  About setting up and further experiments - in the future. <br><br><h2>  Install CoreOS on bare-metal server </h2><br>  To install OwnCloud on the server, you need to get a server. <br>  Installation on virtual servers "for money" or the same virtual servers on a local machine is not as interesting as installing on "live" hardware.  But with the current dollar rate, renting a server is expensive.  Therefore, a raid was made on Google to find a provider offering a cheap and ‚Äúmetallic‚Äù solution. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Google offered me two companies, both French: <a href="http://www.kimsufi.com/ru/">Kimsufi</a> and <a href="http://online.net/">Online</a> . <br>  Kimsufi is a daughter of OVH, one of the largest hosting providers. <br>  Online is a subsidiary of iliad, one of the largest telecommunications companies. <br><br>  Both companies offer cheap and powerful solutions.  Although according to reviews from online.net the network is better, my choice fell on Kimsufi for two subjective reasons: 1) the server on the VIA Nano U2250 is too slow, and for the next one in the line, they are asking for 16 euros - the toad is choking;  2) availability of a verified account with OVH / Kimsufi. <br><br><h3>  check in </h3><br>  About registration, confirmation and removal of VAT from the provider Kimsufi had a lot to say ( <a href="http://habrahabr.ru/post/167117/">Habr</a> ).  The only thing worth warning about is the waiting time.  It seems that the support for Kimsufi works on the residual principle - the problems of customers are solved only when there are no tasks from the ‚Äúbig brother‚Äù (OVH).  It is worth bearing in mind if you want to place production there. <br><br><h3>  We buy servers </h3><br>  I ordered three servers.  Why three?  Because only three servers can guarantee fault tolerance and the absence of a split-brain. <br><div class="spoiler">  <b class="spoiler_title">Brief explanation</b> <div class="spoiler_text">  In the products tested further, the formula for the calculation of fault tolerance is (n-1) / 2, from which it can be seen that the minimum value of the number <b>n</b> is three.  In our case, proofs can be found in the dock, <a href="">etcd</a> and <a href="http://www.percona.com/doc/percona-xtradb-cluster/5.5/limitation.html">Percona XtraDB Cluster</a> , to discuss - in the comments. <br></div></div><br>  Since there are a lot of people who want to buy servers for such a price, it is quite difficult to become the happy owner of your piece of iron in an ‚Äúhonest‚Äù way.  Personally, I used <a href="https://github.com/MA3STR0/kimsufi-crawler/">this script</a> to catch them. <br><div class="spoiler">  <b class="spoiler_title">Difference of KS-2 line servers</b> <div class="spoiler_text">  KS-2a - percent N2800, 2TB HDD disk <s>(or I'm lucky ^ _ ^)</s> <br>  KS-2b - percent D425, 1TB HDD disk <br>  KS-2c - percent N2800, 40GB SSD disk <br></div></div><br><br><h3>  Install CoreOS </h3><br>  Once the servers have been paid for and have been pre-tested, you will receive a server certificate by mail.  Immediately after this server will be available through the web admin area. <br><div class="spoiler">  <b class="spoiler_title">How to get rid of the annoying popup in the admin panel and the nuances of the refund policy</b> <div class="spoiler_text">  After the appearance of the server in the Kimsufi admin area, we will be offered to install the OS until we install at least something through the web interface.  After that, you <a href="http://www.kimsufi.com/en/faq/">can not</a> get your money back for the server. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">DC owners can appreciate some features</b> <div class="spoiler_text">  <a href="https://coreos.com/docs/sdk-distributors/distributors/notes-for-distributors/">Many</a> <a href="https://coreos.com/docs/running-coreos/bare-metal/booting-with-pxe/">different</a> ( <a href="https://github.com/coreos/bootengine/pull/43">undocumented</a> ) interesting. <br></div></div><br>  First we need to get into the recovery, and then the installation follows the official <a href="https://coreos.com/docs/running-coreos/bare-metal/installing-to-disk/">installation</a> instructions <a href="https://coreos.com/docs/running-coreos/bare-metal/installing-to-disk/">on the disk</a> . <br>  To boot into Rescue, in the web interface, click on Netboot -&gt; Rescue.  After that, the server must be restarted, the easiest way to do this is to click on the Restart button.  Password to enter will come in the mail. <br>  Once logged in to the server via SSH, download <a href="https://raw.github.com/coreos/init/master/bin/coreos-install">the installation script</a> <br><pre><code class="bash hljs">wget https://raw.github.com/coreos/init/master/bin/coreos-install chmod +x coreos-install ./coreos-install --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span></code> </pre> <br>  We write our <a href="https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/">cloud-init</a> file and the installation process via coreos-install -C stable -c / path / to / cloud-init -d / dev / sda. <br><br>  After the installation is complete, you can make changes manually: add an ssh-key or edit cloud-init.  To do this, mount the ROOT partition - it is number nine.  For example: <br><pre> <code class="bash hljs">mount /dev/sda9 /mnt <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'ssh-rsa AAAAB... user@domain'</span></span> &gt; /mnt/home/core/.ssh/authorized_keys</code> </pre><br>  Or you can put the key through cloud-init: <br><div class="spoiler">  <b class="spoiler_title">cloud-init number one</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cloud-config hostname: core1 coreos: write_files: - path: /home/core/.ssh/authorized_keys permissions: 0600 owner: core content: | ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC+jxun+xn31x4tP7NdM6nMFI5b00bbk+VK4JM5mdyS+30/lIhhArMWnhla7NTw0BINdvutErZRFzhIqf5yaR/+O7/Oqc9J53dWJiEnz0si9hutbVSYA/Peo0Z9nFBm6Aep3816AzJYNzKIZg17JwqTKpEnV/ArXOmbCek9hi50R7yuZvtehWmJMNqTxKhqb5aD1joARd2iTMfS39pFsLsrxn8b2mGfcQH9v0+HwmNEiCGpq+HCMFTpt9Z1SOukeTpKOWOiBEzQPqaeaIeqXTDHHj2zWHv0/elIuRBFpxgC00DvoshlAzmB6CwCttBkigGQP2Mlcnovuo0RyuJRAlw1 user@domain</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">cloud-init number two</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cloud-config hostname: core1 coreos: write_files: - path: /etc/ssh/sshd_config owner: root content: | # Use most defaults for sshd configuration. UsePrivilegeSeparation sandbox Subsystem sftp internal-sftp ClientAliveInterval 180 UseDNS no AuthorizedKeysFile %h/.ssh/authorized_keys.d/coreos-cloudinit ssh_authorized_keys: - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC+jxun+xn31x4tP7NdM6nMFI5b00bbk+VK4JM5mdyS+30/lIhhArMWnhla7NTw0BINdvutErZRFzhIqf5yaR/+O7/Oqc9J53dWJiEnz0si9hutbVSYA/Peo0Z9nFBm6Aep3816AzJYNzKIZg17JwqTKpEnV/ArXOmbCek9hi50R7yuZvtehWmJMNqTxKhqb5aD1joARd2iTMfS39pFsLsrxn8b2mGfcQH9v0+HwmNEiCGpq+HCMFTpt9Z1SOukeTpKOWOiBEzQPqaeaIeqXTDHHj2zWHv0/elIuRBFpxgC00DvoshlAzmB6CwCttBkigGQP2Mlcnovuo0RyuJRAlw1 user@domain</span></span></code> </pre><br></div></div><br><br>  During the first boot of the system, scripts are run that do some magic (repair GPT, resize the root filesystem (/ dev / sda9), etc.). <br><div class="spoiler">  <i><b class="spoiler_title">Note</b></i> <div class="spoiler_text">  <i>Learn more about CoreOS partitioning at the <a href="https://coreos.com/docs/sdk-distributors/sdk/disk-partitions/">dock</a> , <a href="https://groups.google.com/forum/">mail</a> <a href="https://groups.google.com/forum/">list,</a> or on the githaba.</i> <i><br></i> </div></div><br>  To boot into a freshly installed OS, you need to change the boot order through the web interface -&gt; Netboot to boot from the hard disk and send the server to reboot (using the reboot command in the terminal, or using the Restart button in the web admin panel). <br>  If you have not forgotten to put an ssh-key or have specified your user in the cloud-init, then you should be let into the system.  If I can, congratulations!  If not, something went wrong. <br><br><h3>  Repartition disk </h3><br>  Once the system is installed, you can begin to study it.  And a lot of interesting things: etcd, fleet, systemd and related technologies: kubernetes, confd and more! <br>  But before going further, I decided to create two additional partitions: for storing user data (distributed) and for storing containers and system applications (btrfs). <br>  Why was btrfs chosen if it is experimental?  Because the goal of my experiment is to experiment with new technologies.  And despite the fact that btrfs has been working on desktops / laptops for a couple of years now, I haven‚Äôt used it in production. <br><div class="spoiler">  <i><b class="spoiler_title">History reference</b></i> <div class="spoiler_text">  <i>Initially, the btrfs partition was created at the root of CoreOS.</i>  <i>Recently, ext4 with AUFS / OverlayFS has been used for root.</i>  <i>The reason for leaving btrfs is related to two unpleasant bugs that should have been fixed from the kernel version 3.18, in which the developers swear.</i>  <i>Nevertheless, btrfs still may have some problems when working with a large number (several thousand) of layers (snapshots), but a discussion of this is beyond the scope of this article.</i>  <i>Write comments!</i> <i><br></i> </div></div><br>  In order to select something, you need to free at the beginning!  To do this, go back to Rescue. <br><div class="spoiler">  <i><b class="spoiler_title">If you can not boot into Rescue</b></i> <div class="spoiler_text">  <i>I ran into a problem: after a fresh installation of CoreOS, the machine did not want to boot over PXE, including in rescue.</i>  <i>If you have a misfortune, you can use a one-time hack: use iptables to block all ICMP traffic (systemctl show iptables-restore.service) and do Restart via the web interface.</i>  <i>The automation will consider that the server has not booted, and the engineer will manually load it into Rescue.</i>  <i>Correct this can only be done by changing the motherboard and killing the MAC address on the switch by the engineer.</i> <i><br></i> </div></div><br>  I reduced the size of the file system, then reduced the size of the partition and afterwards created new ones. <br>  The root is on the ninth partition: / dev / sda9.  Let's start: <br><pre> <code class="bash hljs">e2fsck -yf /dev/sda9 <span class="hljs-comment"><span class="hljs-comment">#      resize2fs /dev/sda9 100G #      100 gdisk /dev/sda #    resize2fs /dev/sda9 100G #  ,   </span></span></code> </pre><br>  In gdisk, you need to delete the partition and create a new resized one. <br>  If my memory serves me, the keyboard shortcuts will be done: d -&gt; 9 -&gt; n -&gt; 9 -&gt; -&gt; + 100G -&gt; -&gt; c -&gt; 9 -&gt; ROOT -&gt; w -&gt; Y -&gt; <br>  If you‚Äôve done everything right, you can safely boot from the hard disk and see that / dev / sda9 is 100GB or 93GB. <br><pre> <code class="bash hljs">core3 ~ <span class="hljs-comment"><span class="hljs-comment"># df -h /dev/sda9 Filesystem Size Used Avail Use% Mounted on /dev/sda9 97G 128M 93G 1% /</span></span></code> </pre><br>  <i>Despite the fact that I install CoreOS on Kimsufi servers, the instruction is suitable for other providers.</i>  <i>If you are faced with nuances when installing - write, discuss.</i> <i><br></i> <br>  This completes the story about installing CoreOS on bare-metal Kimsufi server. <br><br><h3>  Who's next? </h3><br>  In the next article I will tell you how to create partitions from the free space, how to configure RTM ( <a href="http://help.ovh.com/RealTimeMonitoring">Real Time Monitoring</a> - monitoring script to draw beautiful graphs in the OVH web admin), etcd, fleet and how to deploy a distributed file system. </div><p>Source: <a href="https://habr.com/ru/post/256107/">https://habr.com/ru/post/256107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256095/index.html">jspm - browser package manager</a></li>
<li><a href="../256097/index.html">Run the music player in the emulator</a></li>
<li><a href="../256101/index.html">Homemade NAS from a netbook with a reworked PCI express SATA controller for ExpressCard / 34</a></li>
<li><a href="../256103/index.html">Firmware for electronics 3D scanner</a></li>
<li><a href="../256105/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ156 (April 13 - 19, 2015)</a></li>
<li><a href="../256109/index.html">Ways to organize CSS-code</a></li>
<li><a href="../256111/index.html">Symphony of self-winding</a></li>
<li><a href="../256115/index.html">Development Tools HL7 (HL7v2, HL7v3, CDA)</a></li>
<li><a href="../256117/index.html">Some interesting and useful things for web developer # 42</a></li>
<li><a href="../256123/index.html">The digest of interesting materials from the world of Drupal # 8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>