<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Embedding Apple Music in an iOS application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, our partners - the developers of the company Music Paradise - have prepared a new material for the readers of our blog. This time, the guys wil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Embedding Apple Music in an iOS application</h1><div class="post__text post__text-html js-mediator-article">  Today, <a href="https://habrahabr.ru/company/everydaytools/blog/319290/">our partners</a> - the developers of the company Music Paradise - have prepared a new material for the readers of our blog.  This time, the guys will talk in detail about the integration of Apple Music into their own application.  A similar experience <a href="https://habrahabr.ru/post/301456/">has already been described in Habr√©</a> , but the article by Music Paradise developers is intended not so much to acquaint readers with this process, as to talk in detail about it and about some important, but not obvious points when working with Apple Music. <br><br>  ‚ÄúWith the release of iOS 9.3, Apple Inc. made it possible to use its Apple Music service to play music.  We decided to try this opportunity in the work on our application <a href="http://go.everydaytools.mobi/r8MwKc">Music Paradise Player</a> .  The experience turned out to be quite instructive - some pitfalls and weak points were discovered in the system, which are useful to know in advance.  In this article we will try to briefly outline the main points of working with Apple Music, as well as some features of this system. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/68d/a28/190/68da28190b834445a9526a99d3886e42.jpg"></div><a name="habracut"></a><br><h3>  Apple Music Access Check </h3><br>  Apple Music support for developers is available in the SDK since version 9.3, so if your application was developed for earlier versions of iOS, you should handle this exception. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The next step on the road to figuring out Apple Music playback is an authorization request to SKCloudServiceController: <br><br><pre><code class="objectivec hljs">[<span class="hljs-built_in"><span class="hljs-built_in">SKCloudServiceController</span></span> requestAuthorization:^(<span class="hljs-built_in"><span class="hljs-built_in">SKCloudServiceAuthorizationStatus</span></span> status) { <span class="hljs-comment"><span class="hljs-comment">//   }];</span></span></code> </pre> <br>  Several values ‚Äã‚Äãcan come as a status: <br><br><ul><li>  SKCloudServiceAuthorizationStatusAuthorized - everything is fine.  This is our target status, in any other case, to fully reproduce the music will not work; </li><li>  SKCloudServiceAuthorizationStatusDenied - the user has denied the application access to the device‚Äôs library, we will not be able to move further.  A good solution in this situation would be to invite the user to go to the settings and provide access manually; </li><li>  SKCloudServiceAuthorizationStatusRestricted - the same disappointing result, with the only difference that access is impossible due to circumstances beyond the control of the user. </li></ul><br>  Note that in this case, the status of SKCloudServiceAuthorizationStatusNotDetermined cannot come because the user will have to select a response in the pop-up window in order to continue working.  Accordingly, it does not make sense to process this option. <br><br>  Now, when we figured out access to the user's library, you need to check that he has a subscription to Apple Music: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">SKCloudServiceController</span></span> *controller = [[<span class="hljs-built_in"><span class="hljs-built_in">SKCloudServiceController</span></span> alloc] init]; [controller requestCapabilitiesWithCompletionHandler:^(<span class="hljs-built_in"><span class="hljs-built_in">SKCloudServiceCapability</span></span> capabilities, <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> * _Nullable error) { <span class="hljs-comment"><span class="hljs-comment">//   }];</span></span></code> </pre> <br>  Here, too, there are many options for statuses, but only two will be acceptable to us: <br><br><ul><li>  SKCloudServiceCapabilityMusicCatalogPlayback - the user can play music from Apple Music, the iCloud library is turned off. </li><li>  SKCloudServiceCapabilityAddToCloudMusicLibrary - user can play music from Apple Music, iCloud media library is enabled. </li></ul><br>  If desired, you can also handle the unsuccessful SKCloudServiceCapabilityNone (the user does not have a subscription to Apple Music) - that is, suggest the user to subscribe. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b0d/af2/cb3/b0daf2cb3dc44504aea37f5dfb40ccca.PNG" width="250"></div><br><br><h3>  Request track list </h3><br>  Finding and displaying top tracks is a very ambiguous process for those who have never come across the iTunes Search API.  For clarity, we break it down into several points: <br><br><h4>  Search by keyword </h4><br>  The general view of the request is as follows: <br><br>  <a href="https://itunes.apple.com/search%3Fterm%3D%25%40%26limit%3D%25ld%26s%3D%25%40%26entity%3Dsong%26explicit%3DNo">itunes.apple.com/search?term=%@&amp;limit=%ld&amp;s=%@&amp;entity=song&amp;explicit=No</a> <br><br>  Let us analyze each parameter: <br><br>  <b>Term</b> is our search query.  Keep in mind: if it consists of several words, you need to replace the spaces with a + (perhaps this will be obvious to many, but it‚Äôs worth it). <br><br>  <b>Limit</b> - the maximum number of results.  It's all intuitive.  The default value is 50, but in some cases this may not be enough. <br><br>  <b>S</b> (Apple's good work, everything is immediately clear by name) - this search argument is obligatory, it designates the country of the App Store to which the user account is associated.  The fact is that for different states in Apple Music various compositions are presented.  In addition, the same track may have different identifiers in different countries. <br><br>  To get this identifier for a specific user, use: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">SKCloudServiceController</span></span> *controller = [[<span class="hljs-built_in"><span class="hljs-built_in">SKCloudServiceController</span></span> alloc] init]; [controller requestStorefrontIdentifierWithCompletionHandler:^(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> * _Nullable storefrontIdentifier, <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> * _Nullable error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!error) { storeID = storefrontIdentifier; <span class="hljs-comment"><span class="hljs-comment">// } }];</span></span></code> </pre> <br>  <b>Entity</b> is a necessary entity, in our case it is a song. <br><br>  <b>Explicit</b> - Determines whether to include in the search results content with offensive language.  First of all, it is worthwhile to build on the age restrictions in your application. <br><br>  More information on the use of search can be found <a href="https://affiliate.itunes.apple.com/resources/documentation/itunes-store-web-service-search-api/">here</a> . <br><br><h4>  Getting top charts </h4><br>  To get top charts, you should use the <a href="https://rss.itunes.apple.com/">generator RSS feeds from Apple</a> .  At the output of the generator, we get the url of this type: <br><br>  <a href="https://itunes.apple.com/ru/rss/topsongs/limit%3D100/xml">itunes.apple.com/en/rss/topsongs/limit=100/xml</a> <br><br>  where the top tracks for Russia are displayed in the amount of 100 pieces in xml format.  In my opinion, this result does not suit us for several reasons. <br><br>  First, it is necessary to change the country, since our offer is available on the market and for foreign consumers.  So, we need to substitute the current user's country identifier instead of ru. <br><br>  We used a little trick to get the ID.  Since the application provides for IAP, take any SKProduct and rotate the following: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">SKProduct</span></span> *product = <span class="hljs-comment"><span class="hljs-comment">// IAP   NSLocale* storeLocale = product.priceLocale; NSString *storeCountry = (NSString*)CFLocaleGetValue((CFLocaleRef)storeLocale, kCFLocaleCountryCode);</span></span></code> </pre> <br>  Accordingly, we substitute storeCountry for ru in our URL. <br><br>  And there is one more thing that does not suit us - this is the format of the received data.  But everything is simple: we change xml to json at the end of the line, as a result we get the URL of this type for the correct unloading of top charts: <br><br>  <a href="https://itunes.apple.com/%25%40/rss/topsongs/limit%3D100/json">itunes.apple.com/%@/rss/topsongs/limit=100/json</a> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/232/064/27c/23206427c0b749c591b8d68d6d15e299.PNG" width="250"></div><br><br><h3>  How to get large covers from iTunes search api </h3><br>  Another problem we encountered when adding a search on iTunes to our application was that the API returns us the cover of tracks no larger than 100x100.  However, there are some tricks here.  Although the link to the image in good quality is not represented in the effective json, we can take it using the following algorithm: <br><br><ol><li>  Take the link to the image from json, which is located on the key ¬´artworkUrl100¬ª; </li><li>  Replace the received line 100x100 by 600x600; </li><li>  We get a link to a large image. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/files/63f/44f/942/63f44f94297b476fb059b0a29e99bd4c.png"></div><br><h3>  Playing tracks from Apple Music </h3><br>  However strange it may sound after all the preparations, this step is the easiest in the whole process of adding Apple Music to the application.  All we need is to initialize the player and give it a list of playback tracks.  The list of playback tracks is specified in the format of an array containing strings with track identifiers.  As a code, it looks like this: <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)playQuery:(<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*&gt;*)query { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.player = [<span class="hljs-built_in"><span class="hljs-built_in">MPMusicPlayerController</span></span> applicationQueuePlayer]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.player setQueueWithStoreIDs:query]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.player play]; }</code> </pre> <br>  It is worth reminding once again that the function we are interested in to work with Apple Music: <br>  setQueueWithStoreIDs: appeared in the SDK since iOS 9.3, up to this point we could use MPMusicPlayerController only to play the user's iTunes library. <br><br>  If we talk about the difficulties that we encountered in studying the functional, it comes to mind that after processing json'ov, which came from the search api, in the dictionaries lay digital values, not string values.  You need to follow this. <br><br>  It is also worth mentioning that in the example we use the applicationQueuePlayer.  It appeared only in iOS 10.3, but now it seems to us that it is a better solution compared to applicationMusicPlayer, which greatly fails when working with several tracks and when remotely controlled (for example, on a locked screen or from headphones), and also systemMusicPlayer, which The fact is in no way connected with the application and can continue to play even after the user has logged out of it. ‚Äù </div><p>Source: <a href="https://habr.com/ru/post/326868/">https://habr.com/ru/post/326868/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326854/index.html">TypeScript to Slack</a></li>
<li><a href="../326856/index.html">How to make your C ++ code cross-platform?</a></li>
<li><a href="../326860/index.html">Machine Learning Boot Camp IV. Fourth. Secret. Your</a></li>
<li><a href="../326862/index.html">Banks and money through science fiction</a></li>
<li><a href="../326866/index.html">Breaking can not be pardoned, or what awaits hackers on PHDays VII</a></li>
<li><a href="../326870/index.html">VMware vSAN 6.6 ‚îÄ new release features</a></li>
<li><a href="../326872/index.html">Choosing a game engine for indie project: experience with ClickTeam Fusion 2.5</a></li>
<li><a href="../326874/index.html">Instructions for publishing an Android application on Google Play</a></li>
<li><a href="../326876/index.html">Comparison of contextual advertising automation services</a></li>
<li><a href="../326878/index.html">Exceptions in Windows x64. How it works. Part 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>