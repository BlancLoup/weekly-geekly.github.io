<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Inventing a bike or finding a missing ID value in a MySQL table</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Developers and administrators of systems based on sql data, for sure, faced with the task - to get the missing (missing) value in a number of id recor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Inventing a bike or finding a missing ID value in a MySQL table</h1><div class="post__text post__text-html js-mediator-article">  Developers and administrators of systems based on sql data, for sure, faced with the task - to get the missing (missing) value in a number of id records of the table.  For example, the contract number, the serial number of the document, phone number, ip address, etc.  When working with MySQL, this trivial task is disproportionately resource intensive. <br><a name="habracut"></a><br>  For example, we have a pool of internal company phone numbers from 2001 to 2999 and a table with numbers issued from them for employees: <br><ul><li>  t1.phone </li><li>  2001 </li><li>  2002 </li><li>  2003 </li><li>  2004 </li><li>  2005 </li><li>  2009 </li><li>  2015 </li><li>  2016 </li></ul><br>  We need to find the first free value (in this case, 2006) to allocate the next number to the next employee.  If there are no free values, then you need to select the next one from the range.  Familiar task?  Solutions that the Internet abounds in boil down to two principles: <br><br>  1) Do a brute force loop: for example, in SQL, create a cursor CUR i + 1 from 2001 to 2999 and make queries <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t1.phone <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t1 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> phone = i</code> </pre>  to empty value.  The cycle can be done with any external software, the meaning of the principle does not change. <br><br>  2) The second principle is to use the LEFT (OUTER) JOIN sequence 2001 ... 2009 with the table t1 (WHERE t1.phone IS NULL of course), or the table t1 with itself with a shift to the step: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(t1.phone)+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t1 <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t1 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> diff <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (t1.phone = diff.phone+<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> diff.phone <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span></code> </pre> <br>  Another option using IN <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> phone <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (....)</code> </pre>  I do not consider it at all because of bulkiness. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On small data volumes, both solutions (and even with IN) work fine, and with a large number of records, these solutions are either resource-intensive, or time-consuming, or both. <br>  It depends on the server's capacity and database settings, but in any case, if one goes through a million records or squeezes such a table, even on a powerful server, execution will take considerable time. <br><br>  I wanted to solve the problem quickly, without straining the server, and, preferably, in one request.  In one, not in one, but that's what happened: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>,<span class="hljs-number"><span class="hljs-number">2999</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">num</span></span>,@maxid; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(f.id) <span class="hljs-comment"><span class="hljs-comment">/*     ""  union */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> s.num, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(s.num) <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,    .,      ,   */</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">num</span></span>:=@<span class="hljs-keyword"><span class="hljs-keyword">num</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> r.id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> s.id != s.num <span class="hljs-comment"><span class="hljs-comment">/*       ,         - min */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    ,           null,    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">num</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">num</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;@maxid,@<span class="hljs-keyword"><span class="hljs-keyword">num</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    union */</span></span> f.id <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br><br>  Compared to joins, simple selects are performed hundreds of times faster. <br><br>  It is clear that such a solution is known, but, strangely enough, it was not possible to find it on the Internet, so I want to share these simple ‚Äúbikes‚Äù. <br><br>  UPD. <br>  The perfect decision was suggested in a personal <a href="http://habrahabr.ru/users/stepmex/">stepmex party</a> <br>  Without any additional construction of numbering and comparison of series, he elegantly solved the problem through (SELECT 1 .....) IS NULL <br>  A great find, I believe: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (<span class="hljs-string"><span class="hljs-string">`t1`</span></span>.<span class="hljs-string"><span class="hljs-string">`phone`</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">`empty_phone`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t1`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t1`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">`st`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">`st`</span></span>.<span class="hljs-string"><span class="hljs-string">`phone`</span></span> = (<span class="hljs-string"><span class="hljs-string">`t1`</span></span>.<span class="hljs-string"><span class="hljs-string">`phone`</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`t1`</span></span>.<span class="hljs-string"><span class="hljs-string">`phone`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/228099/">https://habr.com/ru/post/228099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228079/index.html">Function Pointer - forgotten implementation of the Singleton pattern</a></li>
<li><a href="../228083/index.html">LED controller for aircraft model</a></li>
<li><a href="../228085/index.html">How I screwed the speedometer to the tanks</a></li>
<li><a href="../228093/index.html">Beeline TV via Mikrotik in the province</a></li>
<li><a href="../228095/index.html">Zabbix 2.2: Monitoring the temperature of the Windows processor of the machine</a></li>
<li><a href="../228101/index.html">Problems and prospects of ensuring the safety of civil aviation</a></li>
<li><a href="../228103/index.html">Web Application Firewall (ModSecurity) in action</a></li>
<li><a href="../228105/index.html">Upshifting for a programmer in Thailand</a></li>
<li><a href="../228107/index.html">EMC XtremIO and VDI. Effective, but still raw stuff</a></li>
<li><a href="../228109/index.html">Efficient energy management in the data center</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>