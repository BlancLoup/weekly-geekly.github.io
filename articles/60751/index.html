<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience of using spacecraft (FSM) in the web interface in Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Recently, I needed to attach a web interface to one program. 
 More precisely, no web interface was already there, but it worked only i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience of using spacecraft (FSM) in the web interface in Python</h1><div class="post__text post__text-html js-mediator-article"><h5>  Introduction </h5><br>  Recently, I needed to attach a web interface to one program. <a name="habracut"></a><br>  More precisely, no web interface was already there, but it worked only in one direction, it rendered the results of the program core.  And it took to introduce interactivity. <br><br>  The program in its original form translated a block diagram representation recorded in XML files into its graphical representation.  The kernel of the program read XML files, displayed blocks of the block diagram described in these files into objects and then from these objects drew a picture and showed it through the browser. <br><br>  In accordance with the new requirements, it was necessary to add interactive editing.  And that means, it was necessary to add links, forms, handle errors and issue messages about them, check the data entered in the forms, take into account browser buttons that allow you to move through the history and so on.  And most importantly, in all this is not confused. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I have a habit for confusing programs to draw flowcharts.  For a program that operates in a mode when there are pronounced states in which a program may be located, events to which it should react (for example button presses) and transitions from one state to another, the concept of a finite state machine or spacecraft is ideal; FSM or Finit State Machine.  Once, even under DOS, I figured out the menus of a single sophisticated program only when I drew a state diagram of a spacecraft for it. <br><br><h5>  What is KA (state machine) </h5><br>  Those who know what it is, can safely skip this section. <br><br>  KA, this is an approach to describing the operation of automata.  It distinguishes the states depicted on the diagrams in the form of circles with an inscription inside and transitions that are drawn in the form of arrows connecting the circle-states.  Arrows can do the same trick as returning to the same state.  Arrows also usually have symbols. <br><br>  The work of a spacecraft, in fact, consists in transitions from one state to another. <br><br><h5>  What can give the application of the spacecraft approach in this case? </h5><br>  In this case, it is to describe the operation of the web interface. <br><br>  - You can draw a readable diagram of interface states. <br>  - You can write code organized by this diagram. <br>  - It will be easy to move from code to diagram and vice versa. <br>  - Easy to understand / add / delete states and actions. <br>  - It is relatively easy to cover all the transitions of the interface, which makes testing easier. <br>  - You can easily create a state table, which facilitates testing. <br><br><h5>  Wednesday </h5><br>  In developing this software, the following software was used: <br>  Language: Python 2.5.4 <br>  Web server: Cherrypy 3.1.1 <br><br><h5>  Implementation and operation of the code </h5><br><h6>  Organization code spacecraft </h6><br>  The fact that cherrypy was used as a web server dictated some requirements for code organization. <br><br>  The code was organized like this: The entire web interface is implemented in the HomePage class. <br>  Anchor point, both for the web interface and for the spacecraft, the index () method <br><br>  KA is also implemented in the HomePage class.  The SC code can be divided into three parts: <br><br>  1. Code in the index () method.  Receives the 'tostate' parameter from the browser and calls the control methods, implements the control loop of the spacecraft. <br><br>  2. Spacecraft control methods.  fsm_transition (self, to_state), fsm_process_methods (self, fsm_data) <br><br>  3. Dictionary of spacecraft data (self.fsm_trans). <br><br>  4. Interface methods of spacecraft.  These are the methods called upon transitions from one state of the spacecraft to another and performing the specific actions necessary for these transitions. <br><br><h6>  SC data dictionary </h6><br>  The description of the code is best to start with the vocabulary data dictionary.  Here he is: <br><br><pre> self.fsm_trans = {
     # one
     'init_logo': {'type': 'Show', 'methods': [self.fsm_logo_show]},
     # 2
     'logo_logo': {'type': 'Show', 'methods': [self.fsm_logo_show]},
 .......
     # 6
     'pg1_prj_select_page': {'type': 'Show', 'methods': [self.fsm_project_set_dir,
                                                 self.fsm_diag_files_rm,
                                                 self.fsm_project_page_algor_start,
                                                 self.fsm_set_cur_page_algor_first_page,
                                                 self.fsm_set_cur_block_first_block_of_page,
                                                 self.fsm_create_cur_page_diag_files,
                                                 self.fsm_page_show]},
 .....

     # 29
     'f3_pg_block_edit_check_pg_block_edit': {'type': 'Act', 'methods':
                                                [self.fsm_pg_block_edit,
                                                  self.fsm_diag_files_rm,
                                                  self.fsm_create_cur_page_diag_files,
                                                  self.fsm_page_cur_save,
                                                  self.fsm_go_to_page]},
 .....
</pre><br><br>  Dictionary key  This is a string composed of the names of the two states, the source and the next.  The initial state is remembered by our KA in the self.fsm_prev_state variable, the following comes from the browser's request parameter.  For example, for the transition labeled '# 1', the initial state is 'init', the following is 'logo', the key is obtained as 'init' + '_' + 'logo' <br><br>  The key is located again the dictionary.  It has two keys, 'type' and 'methods'. <br><br>  The key 'type' indicates the type of the next state.  There are two types of state, 'Show' and 'Act'.  The 'Show' type indicates that this is the state of the display of the generated HTML page and the waiting for the next request from the browser.  The type 'Act' means that you do not need to stop at this state.  It is necessary to proceed to the next state. <br><br>  The 'methods' key is an array of interface method names for the QA.  This is, strictly speaking, a sequence of useful actions that must be performed when moving from one state to another.  And for the 'Show' type, the last method of the array should return the generated HTML page, and for the 'Act' type, the name of the state to which you want to go. <br><br><h6>  Spacecraft code in the index () method </h6><br><pre> 1 @ cherrypy.expose
 2 def index (self, block = '', tostate = '', page = '', project = '', ** data):
     .......
 3 try:
 4 # FSM go to next state
 5 fsm_data = self.fsm_transition (self.http_param ['tostate'])
 6 # If 'tostate' parameter is not valid for this state
 7 except KeyError, error_detail:
 8 return self.fsm_error_show ('KeyError:' + str (error_detail))
 9 processing_result = self.fsm_process_methods (fsm_data)
 10 while True:
 11 # If type is 'Show' return html page 
 12 if fsm_data ['type'] == 'Show':
 13 return processing_result
 14 # If type is 'Act', FSM to next state
 15 # the name of the state is in processing_result
 16 if fsm_data ['type'] == 'Act':
 17 fsm_data = self.fsm_transition (processing_result)
 18 processing_result = self.fsm_process_methods (fsm_data)
   
</pre><br><br>  The method gets the 'tostate' parameter from the request.  after this, the self.fsm_transition () method in line 5 returns a dictionary from the data dictionary containing the state type (Show | ACt) and an array of methods for execution. <br><br>  In case of a key error, i.e.  it is impossible to go from this state to the desired state, by the exception of the KA goes into the 'error' state.  A key error can happen, for example, if the browser was returned a few steps through the history and clicked on some link.  In this case, <br>  The HTML page displayed by the browser does not correspond to the state of the AC, and the request may require a transition to a state to which there should be no transition from the current state. <br><br>  In line 9, the self.fsm_process_methods (fsm_data) method processes an array of transition methods and returns the value that the last method returned from the array of methods.  In the case of the 'Show' type, this is the HTML page code, the 'index' method returns it, and the server sends it to the browser. <br>  If the type is' Act ', this is the name of the next state, in line 17 we translate the spacecraft to the next state, in line 18 we process transition methods and so on until we reach the type Show'. <br><br><h6>  Spacecraft control methods </h6><br><pre> # FSM methods
 def fsm_transition (self, to_state):
     "" "
     Change state of FSM to state
     Provide decision what to do
     Arguments:
     to_state - State to go to
     Return:
     "" "
     # Remember old state
     self.fsm_prev_state = self.fsm_state
     self.fsm_state = to_state
     # Get return value from dictionary
     key = str (self.fsm_prev_state) + '_' + str (self.fsm_state)
     self.fsm_return = self.fsm_trans [key]
     return self.fsm_return

 def fsm_process_methods (self, fsm_data):
     "" "
     Get fsm_data dictionary, process functions and
     return htmal or next state
     Arguments:
     fsm_data - Dictionary, taken from self.fsm_transition () return value
     It is taken from self.fsm_trans dictionary
     Return:
     html text in case 'type': 'Show'
     name of the next state in case 'type': 'Act'
     "" "
     last_func = len (fsm_data ['methods'])
     i = 0
     for method in fsm_data ['methods']:
         i + = 1
         if i == last_func:
             return method () # For last function return its return value
         method ()
</pre><br><br>  Here, I think, everything is trivial. <br><br><h6>  About the choice of the method of processing interface methods </h6><br>  There are no particular reasons for storing methods in an array.  It would be quite possible for each transition to have its own method, in which nested interface methods would be called. <br><br>  The given method of processing was chosen deliberately in order to have all the calls to the interface functions in one place and at the same nesting level for readability of the code.  In the implemented code, you can simply take the printed spacecraft diagram and look at the code of the data dictionary of the spacecraft to see which chains of actions are performed for transitions from one <br>  states to another. <br><br><h6>  Conclusion </h6><br>  I believe that the use of a spacecraft in the design approach allowed us to write flexible, readable, transparent and easily supported code. <br><br><h6>  Appendix: Example of a QA chart (fragment of a real chart) </h6><br><img src="https://habrastorage.org/getpro/habr/post_images/754/44d/66f/75444d66f61932c051f80a56f3ea4214.png" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/60751/">https://habr.com/ru/post/60751/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../6074/index.html">Internal voice emulator</a></li>
<li><a href="../60742/index.html">Memcached under OpenSolaris faster than under Linux</a></li>
<li><a href="../60743/index.html">Chrome 3.0 dev</a></li>
<li><a href="../60749/index.html">Electronic elections to the European Parliament in the screenshots</a></li>
<li><a href="../60750/index.html">Bing - a new search engine officially announced</a></li>
<li><a href="../60752/index.html">Fear of change</a></li>
<li><a href="../60756/index.html">Unofficial iPhone client for accessing Yandex Traffic</a></li>
<li><a href="../60757/index.html">Data URI [CSS] Sprites 1.1 - Automate the process of assembling css sprites</a></li>
<li><a href="../60759/index.html">GoogleApps + Postfix + Fetchmail (preparation)</a></li>
<li><a href="../6076/index.html">Mom, he counted me, he demographic, sold, bought and sold again (but more expensive)!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>