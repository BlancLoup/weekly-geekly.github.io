<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tips and recipes for novice Android programmers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear habrayuzer. 

 In this article, I want to share my development experience for Android. 
 Requirements for the functionality of th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tips and recipes for novice Android programmers</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear habrayuzer. <br><br>  In this article, I want to share my development experience for Android. <br>  Requirements for the functionality of the product being developed gave rise to various technical tasks, among which were both trivial, chewed in a variety of blogs, and extremely ambiguous, with an unobvious decision.  I ran into a lot of things unfamiliar to me as a .NET developer.  Learned about the existence of tools that greatly simplify life.  I think that every novice Androider goes a similar way.  I could save up to a third of the time spent on developing, searching, and experimenting with such an article. <br><br>  Therefore, in this post, I offer to your attention a collection of recipes and tips that will help you quickly and correctly create your application. <br><a name="habracut"></a><br>  The article is intended for beginners, but experienced developers will be able to find useful points.  It is assumed that you have read the basics of building Android applications, know about the wonderful <a href="http://startandroid.ru/ru/uroki/vse-uroki-spiskom">StartAndroid</a> resource and know how to do HelloWorld.  At the same time, you do not have the experience of creating full-fledged applications, and you have just begun to address this drawback.  For me, this was the first project for Android. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>Start</b> </h4><br>  My partner and I have long thought to create some interesting product for Google Play.  One day, while reading another SMS with a taxi advertisement, the idea arose to create an application that would fight SMS spam.  It seemed to us interesting, having practical application, relatively easy to implement for a small team. <br><br>  Further, a set of specific requirements was developed and a set of tasks was formed that should be solved.  The most interesting of them are: <br><ul><li>  <a href="https://habr.com/ru/post/240045/">Project preparation</a> </li><li>  <a href="https://habr.com/ru/post/240045/">Receiving and parsing CMC</a> </li><li>  <a href="https://habr.com/ru/post/240045/">Autostart application when the phone boots</a> </li><li>  <a href="https://habr.com/ru/post/240045/">Making web requests</a> </li><li>  <a href="https://habr.com/ru/post/240045/">Data storage in a local database</a> </li><li>  <a href="https://habr.com/ru/post/240045/">Storage settings</a> </li><li>  <a href="https://habr.com/ru/post/240045/">Google Token Authorization</a> </li><li>  <a href="https://habr.com/ru/post/240045/">Work with the shopping mechanism</a> </li></ul><br>  The following points will be omitted in the article: <br><ul><li>  Layout and design </li><li>  Everything about pure Java code </li><li>  Application architecture </li></ul><br><a name="Prepare"></a><h4>  <b>Project preparation</b> </h4><br>  HelloWorld, and the template project for the Android application, we can already create.  Now let's see what else we might need.  Knowing the existence of these tools, it is easy to find on the Internet how to use them.  After all, the main problem is not to understand how to use the tool, but to find out what it is. <br><br>  1) <a href="http://actionbarsherlock.com/">ActionBarSherlock is</a> necessary for the implementation of platform-independent ActionBar - the menu at the top of the screen.  We download from the official site and import into Workspace as source.  Just a library (jar file) will not be enough, as there is a known problem with the underloading of some resources by the library. <br><br>  2) Import to the Workspace as source Google play services from the sdk \ extras \ google \ google_play_services \ libproject \ google-play-services_lib \ SDK.  This is needed for billing and authorization. <br><br>  3) Put the libraries in the lib folder of the project (before that we will find them on the Internet) <br>  * acra.jar - for the implementation of the mechanism for sending reports about application <a href="https://github.com/ACRA/acra/wiki/BasicSetup">crash</a> : <a href="https://github.com/ACRA/acra/wiki/BasicSetup">ACRA</a> . <br>  * android-support-v4.jar - to implement compatibility with older versions of Android. <br>  * roboguice-2.0.jar, roboguice-sherlock-1.5.jar - for implementing Dependency Injection, if you like its implementation in roboguice. <br>  * ormlite-core.jar, ormlite-android.jar is the popular lightweight <a href="http://habrahabr.ru/post/143431/">ORM for the sqlite Android database</a> . <br>  * joda-time.jar - library for working with dates. <br>  * jdom.jar, gson.jar - for working with JSON. <br>  * checkout.jar - for billing (I chose this library, <a href="http://habrahabr.ru/post/233265/">Checkout</a> as more convenient than working directly with api). <br><br><a name="Sms"></a><h4>  <b>Receiving and parsing CMC</b> </h4><br>  Below I will provide a way that works on Android with a version lower than 4.4 (KitKat), because in this version of Google radically changed the approach to processing CMC.  The description of working with KitKat will be added later when it will be implemented by me in the application. <br><br>  To work with CMC, we need permission in the manifest: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.RECEIVE_SMS"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.WRITE_SMS"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.READ_SMS"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  Where <br>  RECEIVE_SMS ‚Äî Allow the application to receive the CMC. <br>  READ_SMS - permission to read SMS from the phone‚Äôs memory.  It would seem that we do not need it, but without this permission the recording does not work. <br>  WRITE_SMS - permission to write CMC to the phone memory. <br><br>  Create an event listener "accepted CMC" SmsBroadcastReceiver.  It will be called when the phone receives an SMS and starts the execution of basic processes for processing SMS. <br><br><div class="spoiler">  <b class="spoiler_title">SmsBroadcastReceiver</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//BroadcastReceiver      public class SmsBroadcastReceiver extends BroadcastReceiver { @Override public void onReceive(Context context, Intent intent) { // -    ,    Bundle bundle = intent.getExtras(); //    pdus -      Object[] pdus = (Object[]) bundle.get("pdus"); if (pdus.length == 0) { return; //      } //  CMC Sms sms = SmsFromPdus(pdus, context); // ,   Boolean isClearFromSpam = SuperMegaMethodForResolving Spam(sms, context); if (!isClearFromSpam) { //    -   CMC  abortBroadcast(); return; } } private Sms SmsFromPdus(Object[] pdus, Context context) { Sms sms = new Sms(); for (int i = 0; i &lt; pdus.length; i++) { SmsMessage smsMessage = SmsMessage.createFromPdu((byte[]) pdus[i]); sms.Text += smsMessage.getMessageBody(); //   (CMC   "") } SmsMessage first = SmsMessage.createFromPdu((byte[]) pdus[0]);//    sms.SenderId = first.getOriginatingAddress(); // Date receiveDate = new Date(first.getTimestampMillis()); // sms.RecieveDate = receiveDate; sms.Status = first.getStatus(); // (, , ) return sms; } } public class Sms{ public String SenderId; public String Text; public Date RecieveDate; public int Status; }</span></span></code> </pre><br></div></div><br>  It is very important that onReceive worked in less than 10 seconds.  If the method takes control for a longer period, execution is interrupted and the event is given to other handlers in order of priority. <br>  In my case, SuperMegaMethodForResolving checks for the presence of SMS in the contact list and in the local list of senders, which takes less than a second.  Then control is given to the selected stream, and onReceive calls abortBroadcast, which prevents other handlers from receiving SMS (including the basic application for SMS). <br><br>  After we need to subscribe SmsBroadcastReceiver to the CMC reception event.  To do this, in the application manifest block, we will declare an event listener android.provider.Telephony.SMS_RECEIVED with the name SmsBroadcastReceiver, which listens for the SMS_RECEIVED system event and has priority 2147483631. Priority can be up to 2 ^ 31.  At the same time, Google does not recommend using values ‚Äã‚Äãgreater than 999. But many applications use them, and we want antispam to intercept the CMC before it is read, for example, by the Contacts + application.  This application requests the highest priority I know. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"su.Jalapeno.AntiSpam.SystemService.SmsBroadcastReceiver"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:enabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:priority</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2147483631"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.provider.Telephony.SMS_RECEIVED"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><a name="Autorun"></a><h4>  <b>Autostart application when the phone boots</b> </h4><br>  Starting the application after turning on the device may be necessary for, for example, notifying the user of the existence of still untested suspicious SMS through notification. <br><br>  Autoloading will require permission in the manifest: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.RECEIVE_BOOT_COMPLETED"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Where <br>  RECEIVE_BOOT_COMPLETED - permission to listen to the event "download" <br><br>  Create a listener for the ‚Äúboot‚Äù event of the ServiceBroadcastReceiver. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceBroadcastReceiver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BroadcastReceiver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// - } }</span></span></code> </pre><br>  In it, we will perform the actions we need after turning on the phone. <br><br>  Then you need to subscribe the ServiceBroadcastReceiver to the phone download event.  To do this, in the application manifest block, we will declare an event listener android.intent.action.BOOT_COMPLETED with the name SmsBroadcastReceiver. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"su.Jalapeno.AntiSpam.SystemService.ServiceBroadcastReceiver"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.BOOT_COMPLETED"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><a name="Web"></a><h4>  <b>Making web requests</b> </h4><br>  So, we have a CMC, and we need to contact the server.  Let's add the manifesto as follows: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Where <br>  INTERNET - permission to send a web request. <br>  ACCESS_NETWORK_STATE - permission to read the network status (connected or not 3g or wifi). <br><br>  Execution of requests is trivial, for them we use the basic Android http client: org.apache.http.client.HttpClient. <br><br><a name="Sqlite"></a><h4>  <b>Data storage in a local database</b> </h4><br>  We do everything as described <a href="http://habrahabr.ru/post/143431/">here</a> . <br><br><a name="Preference"></a><h4>  <b>Storage settings</b> </h4><br>  We do not use app.config, * .ini or the application database to store the application settings, since Android provides us with the <a href="http://startandroid.ru/ru/uroki/vse-uroki-spiskom/73-urok-33-hranenie-dannyh-preferences.html">SharedPreferences</a> mechanism. <br><br><a name="Token"></a><h4>  <b>Google Token Authorization</b> </h4><br>  It took me the most time because of the lack of systematization and incomplete information, including Google documentation.  So, our task is to get a signed token from Google through the application with information about the user and secret information about the application.  This will give us reason to believe that the token was not generated by an attacker.  To solve this problem, we use the <a href="https://developers.google.com/accounts/docs/CrossClientAuth">CrossClientAuth</a> mechanism. <br><br>  You must do the following: <br>  1) Get the certificate of the application and sign the application for them.  This is easy to implement in Eclipse using the wizard.  Right-click on the project in the Package Explorer -&gt; Android tools -&gt; Export signed application package.  The wizard prompts you to create a new certificate store, generate a certificate, and place it in the store, protected by the password specified by us.  Do not forget to save the certificate hash, since it will be needed later. <br><br>  2) Create a project in <a href="https://console.developers.google.com/project">the Google console</a> .  Then open the created project and go to the Api &amp; auth -&gt; Credentials tab in the left pane.  Here you need to create a pair of Client Id for the server side and Android client.  Click Create new Client ID, we need Client ID for Android application. <br><br><img src="https://habrastorage.org/files/6ca/c33/000/6cac33000a084df6b98399acdf9bbd46.png"><br><br>  Fill in as indicated on the screenshot, indicating the correct package name and certificate thumbprint.  After the creation is completed, we will receive a label with the information and the generated for us ‚ÄúCLIENT ID‚Äù.  He will need us on the server. <br><br>  Then we create a new Client Id of type Web application.  In my case, the addresses can be specified arbitrarily, since we will not have http interaction with Google‚Äôs web resources.  As a result, we will get a new CLIENT ID, it will already be needed on the client. <br><br>  3) The client code in its full form can be found on the Internet, for example <a href="http://developer.android.com/reference/com/google/android/gms/auth/GoogleAuthUtil.html">GoogleAuthUtil</a> .  I will note only the key points: how to make Scope correctly, and where to get for it Id <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//  @Override protected void onActivityResult(int requestCode, int resultCode, Intent data) { if (requestCode == REQUEST_CODE_PICK_ACCOUNT) { if (resultCode == RESULT_OK) { Email = data.getStringExtra(AccountManager.KEY_ACCOUNT_NAME); getUsername(); } } super.onActivityResult(requestCode, resultCode, data); } private void pickUserAccount() { String[] accountTypes = new String[] { "com.google" }; Intent intent = AccountPicker.newChooseAccountIntent(null, null, accountTypes, false, null, null, null, null); startActivityForResult(intent, REQUEST_CODE_PICK_ACCOUNT); } //   (   Try catch     //WEB_CLIENT_ID  Client ID for web application final private String WEB_CLIENT_ID = "1999999-aaaaaaaaaaaaaaaaaaaaaaaaa.apps.googleusercontent.com"; //""  Client id.       String SCOPE = String.format("audience:server:client_id:%s", WEB_CLIENT_ID); //   String token = GoogleAuthUtil.getToken(_activity, Email, SCOPE);</span></span></code> </pre><br></div></div><br>  It remains to transfer the token to the server. <br><br>  4) Server code to verify the token <br>  Use Microsoft.IdentityModel.Tokens.JWT <a href="https://www.nuget.org/packages/System.IdentityModel.Tokens.Jwt/">Nuget</a> .  The code below allows you to get GoogleId user and his Email. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetUserIdByJwt</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> jwt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userEmail</span></span></span><span class="hljs-function">)</span></span> { userEmail = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> userId = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Client ID   (Client ID for web application) string audience = "111111111111111111-aaaaaaaaaaaaaaaaaaaaa.apps.googleusercontent.com"; // Client ID  (Client ID for Android application) string azp = "1111111111111-aaaaaaaaaaaaaaaaaaaaaaaa.apps.googleusercontent.com"; var tokenHandler = new JWTSecurityTokenHandler(); SecurityToken securityToken = tokenHandler.ReadToken(jwt); var jwtSecurityToken = securityToken as JWTSecurityToken; userEmail = GetClaimValue(jwtSecurityToken, "email"); userId = GetClaimValue(jwtSecurityToken, "id"); var validationParameters = new TokenValidationParameters() { AllowedAudience = audience, ValidIssuer = "accounts.google.com", ValidateExpiration = true, //     . //         Google //   Microsoft.IdentityModel ValidateSignature = false, }; try { // Exception,     ClaimsPrincipal claimsPrincipal = tokenHandler.ValidateToken(jwtSecurityToken, validationParameters); //,   Client Id    bool allGood = ValidateClaim(jwtSecurityToken, "azp", azp) &amp;&amp; ValidateClaim(jwtSecurityToken, "aud", audience); if (!allGood) { userId = null; } } catch { userId = null; } return userId; } //   Claim   private static bool ValidateClaim(JWTSecurityToken securityToken, string type, string value) { string claim = GetClaimValue(securityToken, type); if (claim == null) return false; return claim == value; } //   Claim (  KeyValuePair) private static string GetClaimValue(JWTSecurityToken securityToken, string type) { var claim = securityToken.Claims.SingleOrDefault(x =&gt; x.Type == type); if (claim == null) return null; return claim.Value; }</span></span></code> </pre><br></div></div><br><a name="Billing"></a><h4>  <b>Work with the shopping mechanism</b> </h4><br>  First you need in the developer <a href="https://play.google.com/apps/publish/">console Google</a> at the application project on the CONTENT FOR SALE tab to create the necessary goods.  We will write the client based on <a href="http://habrahabr.ru/post/233265/">Checkout</a> examples.  Here I will give excerpts from my code regarding billing, for a more complete understanding of the Checkout library. <br><br><div class="spoiler">  <b class="spoiler_title">Application Class Changes</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyApplication</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Products products = Products.create().add(IN_APP, asList(<span class="hljs-string"><span class="hljs-string">"     "</span></span>, <span class="hljs-string"><span class="hljs-string">"  2   "</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Billing billing = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Billing(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Billing.Configuration() { <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPublicKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String base64EncodedPublicKey = <span class="hljs-string"><span class="hljs-string">"    ,         API  "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base64EncodedPublicKey; } <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Cache </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Billing.newCache(); } }); <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Checkout checkout = Checkout.forApplication(billing, products); <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MyApplication instance; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyApplication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ instance = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(); billing.connect(); } <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MyApplication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Checkout </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCheckout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> checkout; } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Activate with purchase</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BillingActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoboSherlockActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Sku _skuAccess; <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ActivityCheckout checkout = Checkout.forActivity(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, MyApplication.get().getCheckout()); <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Inventory inventory; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); _skuAccess = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; _activity = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; checkout.start(); checkout.createPurchaseFlow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseListener()); inventory = checkout.loadInventory(); inventory.whenLoaded(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InventoryLoadedListener()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onActivityResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestCode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Intent data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onActivityResult(requestCode, resultCode, data); checkout.onActivityResult(requestCode, resultCode, data); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ checkout.stop(); checkout.destroyPurchaseFlow(); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroy(); } <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActivityCheckout </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCheckout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> checkout; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Buy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ purchase(_skuAccess); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">purchase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Sku sku)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> billingSupported = checkout.isBillingSupported(IN_APP); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!billingSupported) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } checkout.whenReady(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Checkout.ListenerAdapter() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReady</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull BillingRequests requests)</span></span></span><span class="hljs-function"> </span></span>{ requests.purchase(sku, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, checkout.getPurchaseFlow()); } }); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseRequestListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Purchase</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSuccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull Purchase purchase)</span></span></span><span class="hljs-function"> </span></span>{ onPurchased(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPurchased</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -            inventory.load().whenLoaded(new InventoryLoadedListener()); } @Override public void onError(int response, @Nonnull Exception ex) { // it is possible that our data is not synchronized with data on // Google Play =&gt; need to handle some errors if (response == ResponseCodes.ITEM_ALREADY_OWNED) { onPurchased(); } else { super.onError(response, ex); } } } private class InventoryLoadedListener implements Inventory.Listener { private String _purchaseOrderId; @Override public void onLoaded(@Nonnull Inventory.Products products) { final Inventory.Product product = products.get(IN_APP); if (product.isSupported()) { boolean isPurchased = InspectPurchases(product); // - } } private boolean InspectPurchases(Product product) { List&lt;Sku&gt; skus = product.getSkus(); Sku sku = skus.get(0); //   final Purchase purchase = product.getPurchaseInState(sku, Purchase.State.PURCHASED); boolean isPurchased = purchase != null &amp;&amp; !TextUtils.isEmpty(purchase.token); if (isPurchased) { //  ? return true; } else { //  -     _skuAccess = sku; return false; } } } private abstract class BaseRequestListener&lt;Req&gt; implements RequestListener&lt;Req&gt; { @Override public void onError(int response, @Nonnull Exception ex) { } } }</span></span></code> </pre><br></div></div><br><h4>  <b>Conclusion</b> </h4><br>  That's all for now.  If you want to analyze any aspect in more detail - write and I will add the article.  I hope the post will help novice Android programmers to break less rakes, do not step on the wood and save time.  You can try out the finished application <a href="https://play.google.com/store/apps/details%3Fid%3Dsu.Jalapeno.AntiSpam.Filter">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/240045/">https://habr.com/ru/post/240045/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240025/index.html">Ruby on rails: production and deploy for dummies</a></li>
<li><a href="../240029/index.html">Online training: features of the new version of BigBlueButton</a></li>
<li><a href="../240033/index.html">Web application development</a></li>
<li><a href="../240039/index.html">RAR Print - homemade 3D printer from CD roms</a></li>
<li><a href="../240041/index.html">9 reasons to switch to open source</a></li>
<li><a href="../240047/index.html">DSRC-based fare collection systems inside and outside</a></li>
<li><a href="../240049/index.html">How many scientific articles on the Internet?</a></li>
<li><a href="../240051/index.html">Simple implementation of encrypting and decrypting files in Qt</a></li>
<li><a href="../240053/index.html">Decentralized messaging system</a></li>
<li><a href="../240055/index.html">Yesterday, CSS turned 20 years old. Interview with Haakon Wium Lee (Part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>