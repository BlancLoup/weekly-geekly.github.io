<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Visualize and understand Hash Match Join</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is the third part of the series on connection operators (be sure to read part 1 - nested loops joins , and part 2 - merge joins ). The trans...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Visualize and understand Hash Match Join</h1><div class="post__text post__text-html js-mediator-article"><p>  This post is the third part of the series on connection operators (be sure to read <a href="https://bertwagner.com/2018/12/11/visualizing-nested-loops-joins-and-understanding-their-implications/">part 1 - nested loops joins</a> , and <a href="https://bertwagner.com/2018/12/18/visualizing-merge-join-internals-and-understanding-their-implications/">part 2 - merge joins</a> ).  The translation of the article was prepared specifically for students of the <a href="https://otus.pw/IqqQ/">‚ÄúMS SQL Server Developer‚Äù</a> course. </p><br><p><img src="https://habrastorage.org/webt/zb/ut/6t/zbut6thx839xzxe3p-zgtwobgoy.png"></p><br><p>  <strong>Hash Match Joins</strong> are reliable workhorses of physical connection operators. <br>  While Nested Loops Join will fail, if there is too much data to put in memory, and Merge Join will require the input data to be sorted, <strong>Hash Match</strong> will connect any data that you submit to the input (provided that the equality predicate is executed for the connection and so far there is enough free space in your tempdb). </p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/59C8c7p_hII" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  <a href="https://www.youtube.com/watch%3Fv%3D59C8c7p_hII%26feature%3Dyoutu.be">Watch a video on the topic on YouTube</a> <a href="https://www.youtube.com/watch%3Fv%3D59C8c7p_hII%26feature%3Dyoutu.be"><br></a> </p><br><p>  The <strong>hash match</strong> algorithm consists of two stages, which work as follows: </p><br><p><img src="https://habrastorage.org/webt/h7/j2/sr/h7j2srrh-fso79crvhty8z3ezfy.gif"></p><br><p>  During the first ‚ÄúBuild‚Äù phase, SQL Server creates a hash table in memory from one of the input tables (usually the smallest of the two).  The hashes are calculated based on the keys of the input data and then stored together with the string in the hash table in the appropriate block.  In most cases, there is only one row of data in each block, except when: </p><br><ol><li>  There are lines with duplicate keys. </li><li>  The hash function creates a collision, and completely different keys get the same hash (this is rare, but possible). </li></ol><br><p>  After creating the hash table, the ‚ÄúProbe‚Äù stage begins (validation).  In the second stage, SQL Server calculates the hash of the key for each row in the second input table and checks if it exists in the hash table created in the first stage.  If there is a match for this hash, then it is checked whether the keys of the string (s) in the hash table and the rows from the second table match (this check must be performed due to possible collisions). <br>  A common variant of the <strong>hash match</strong> algorithm occurs when the build phase fails to create a hash table that can be fully stored in memory: </p><br><p><img src="https://habrastorage.org/webt/jx/pl/ip/jxplipr_fmggvdhkz3zwzsjmcks.gif"></p><br><p>  This happens when there is more data than can be allocated in memory, or when SQL Server provides insufficient memory for a <strong>hash match</strong> connection. </p><br><p>  When SQL Server does not have enough memory to store the hash table during the build phase, it continues to work, storing some blocks in memory and placing other blocks in tempdb. <br>  During the validation phase, SQL Server connects the data rows from the second table to blocks in the build phase, which are in memory.  If the block to which this string potentially matches is currently not in memory, SQL Server writes this string to tempdb for later comparison. </p><br><p>  When matches for one block are completed, SQL Server clears this data from memory and loads the following blocks into memory.  It then compares the rows of the second table (currently in tempdb) with the new blocks in memory. </p><br><p>  As is the case with each physical connection operator in this series, details about the <strong>hash match</strong> operator can be found in <a href="https://sqlserverfast.com/epr/hash-match/">Hugo Cornelis help (Hugo Kornelis) about hash match</a> . </p><br><h3 id="chto-pokazyvaet-hash-match-join">  What does Hash Match Join show? </h3><br><p>  Knowing the intrinsic features of how the <strong>match join hash</strong> works allows us to determine what the optimizer thinks about our data and higher-level join operators, helping us focus on tuning performance. </p><br><p>  Here are a few scenarios that should be considered the next time you see that the <strong>hash match join is</strong> used in your execution plan: </p><br><ul><li>  While a <strong>hash match join</strong> can aggregate huge data sets, building a hash table from the first input table is a blocking operation that prevents subsequent statements from being executed.  In this regard, I always check if there is an easy way to convert <strong>hash match</strong> to nested loops or merge join.  Sometimes this is not possible (too many lines for nested loops or unsorted data for merge join), but you should always check whether a simple index change or improved estimates from statistics update causes SQL Server to choose a non-blocking <strong>hash match</strong> join operator </li><li>  <strong>Hash match joins are</strong> great for large connections, as they can be sent to tempdb, this allows them to perform connections with large data sets that can cause the connection to fail in memory using nested loops or merge join operators. <br><ul><li>  If you see the <strong>hash match join</strong> operator, this means that SQL Server considers the input data to be too large.  If we know that our input data should not be so big, then it‚Äôs worth checking whether there are problems with statistics or estimates that cause SQL Server to choose the wrong <strong>hash match join</strong> . </li></ul></li><li>  When running in memory, the <strong>hash match join is</strong> quite effective.  Problems arise when the build phase goes into tempdb. <br><ul><li>  If I notice a small yellow triangle indicating that the connection goes into tempdb, I see why it happened: if there is more data than memory available, there is little that can be done, but if the allocated memory seems unreasonably small, it may mean that we probably have another problem with statistics, which leads to too low estimates for the SQL Server optimizer. </li></ul></li></ul><br><p>  Thank you for reading the article.  You might also like <a href="https://twitter.com/bertwagner">my twitter</a> . </p><br><p>  We covered this topic in the previous <a href="https://www.youtube.com/watch%3Fv%3DH9oS-eLSX_8">open lesson</a> .  We are waiting for your comments! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/459314/">https://habr.com/ru/post/459314/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459306/index.html">Serverless serverless rendering</a></li>
<li><a href="../459308/index.html">SEO in 2019 not working?</a></li>
<li><a href="../45931/index.html">40 years old computer mouse</a></li>
<li><a href="../459310/index.html">Test automation tools or mobile tester on steroids</a></li>
<li><a href="../459312/index.html">Dear Agile, I'm tired of pretending</a></li>
<li><a href="../459316/index.html">Hydra 2019: free broadcast of the first hall and a little about what will be at the conference</a></li>
<li><a href="../459318/index.html">TypeScript and short sprints. How we did the frontend interview variability tool</a></li>
<li><a href="../45932/index.html">Summarizing the experience of the three stages</a></li>
<li><a href="../459320/index.html">Kubernetes Operator in Python without frameworks and SDK</a></li>
<li><a href="../459322/index.html">Publisher Peter. Summer Sale</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>