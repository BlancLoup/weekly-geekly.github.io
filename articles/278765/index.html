<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AutoCAD & RTree</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When we program under AutoCAD, we often have the task of fast spatial search along a set of primitives. Best of all, this search is implemented using ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AutoCAD & RTree</h1><div class="post__text post__text-html js-mediator-article">  When we program under AutoCAD, we often have the task of fast spatial search along a set of primitives.  Best of all, this search is implemented using an R-tree. <br><br>  For example, we will parse the ‚Äúpainted‚Äù tables (these are drawn with segments and text) and create ACAD-tables from them (these are created by the _table command) <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Take the ready <a href="https://sourceforge.net/projects/cspatialindexrt/">implementation of the R-tree</a> , its use is very simple, but we will need a class with which it will work.  It will be called MyCell.  Then creating a tree: <br><br><pre><code class="hljs pgsql">Me.wTree = <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> RTree(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> MyCell)()</code> </pre> <br><br>  Adding Primitive <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Me</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wTree</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Add</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">nCell</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.GetRectangle</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">nCell</span></span>)</code> </pre><br><br>  Here Rectangle is <a href="https://en.wikipedia.org/wiki/Minimum_bounding_rectangle">MBR</a> .  When working with a drawing database, we get DBObjects that inherit from the Drawable class, which has the Bounds As Autodesk.AutoCAD.DatabaseServices.Extents3d? we will see there the values ‚Äã‚Äãwith the words "Light" and "Background" - these words have problems with borders.  But if we work with DrawableType.Geometry, we will have borders, although we should take a closer look at XLine and Ray ... <br><br>  After creating and filling in the R-tree, we proceed to search in it - for this there are two methods: <br><br>  Get the list of objects inside the MBR <br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> Intersects(r <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> RTree.Rectangle) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic.List(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> T)</code> </pre><br>  Get the list of objects near the search point. <br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> Nearest(p <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> RTree.Point, furthestDistance <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> Single) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic.List(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> T)</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Class mycell</b> <div class="spoiler_text"><pre> <code class="hljs sql">Imports Autodesk.AutoCAD.DatabaseServices Imports Autodesk.AutoCAD.Geometry Imports RTree Public Class MyCell Public Box As Line '  Public Col As Integer Public Row As Integer Public Value As String Public Sub New() Box = Nothing Col = 0 Row = 0 Value = "" <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Sub <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Sub <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>(nBox <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> Line, wCol <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>, wRow <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>, nValue <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>) Box = nBox <span class="hljs-keyword"><span class="hljs-keyword">Col</span></span> = wCol <span class="hljs-keyword"><span class="hljs-keyword">Row</span></span> = wRow <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> = nValue <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Sub <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> GetH() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> Box.EndPoint.Y - Box.StartPoint.Y <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> GetW() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> Box.EndPoint.X - Box.StartPoint.X <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> GetRectangle() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> Rectangle <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> Rectangle(Box.StartPoint.X, Box.StartPoint.Y, Box.EndPoint.X, Box.EndPoint.Y, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Class mytable</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">Imports MyAcAs = Autodesk.AutoCAD.ApplicationServices Imports Autodesk.AutoCAD.DatabaseServices Imports Autodesk.AutoCAD.EditorInput Imports Autodesk.AutoCAD.Geometry Imports RTree <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> MyTable <span class="hljs-string"><span class="hljs-string">'Public Shared MinColW As Double = 1 '</span></span><span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> Shared MinRowH <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Double</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> Private vert, horz <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> List(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span>) <span class="hljs-string"><span class="hljs-string">'    Public Cells(,) As MyCell '</span></span>  Friend wTree <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> RTree(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> MyCell) <span class="hljs-string"><span class="hljs-string">'    Public Enum Orent Vert '</span></span>  Horz <span class="hljs-string"><span class="hljs-string">'  None '</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Enum <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> Shared <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> isOrto(wL <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> Orent <span class="hljs-string"><span class="hljs-string">'   -    Dim wValue As Double = wL.Angle / Math.PI Dim delta As Double = 0.05 wValue = wValue - Math.Truncate(wValue + delta / 2) If Math.Abs(wValue) &lt;= delta Then Return Orent.Horz ElseIf (Math.Abs(wValue) &lt; 0.5 + delta) And (Math.Abs(wValue) &gt; 0.5 - delta) Then Return Orent.Vert Else Return Orent.None End If End Function Private Shared Function CompareByX(l1 As Line, l2 As Line) As Integer If l1.StartPoint.X &gt; l2.StartPoint.X Then Return 1 ElseIf l1.StartPoint.X = l2.StartPoint.X Then Return 0 Else Return -1 End If End Function Private Shared Function CompareByY(l1 As Line, l2 As Line) As Integer If l1.StartPoint.Y &gt; l2.StartPoint.Y Then Return 1 ElseIf l1.StartPoint.Y = l2.StartPoint.Y Then Return 0 Else Return -1 End If End Function Private Shared Function GetSelect(ed As Editor) As ObjectId() '</span></span>       Dim PSResult <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> PromptSelectionResult Dim wTV() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> TypedValue = {<span class="hljs-built_in"><span class="hljs-built_in">New</span></span> TypedValue(DxfCode.<span class="hljs-keyword"><span class="hljs-keyword">Operator</span></span>, "&lt;or"), _ <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> TypedValue(DxfCode.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>, "LINE"), _ <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> TypedValue(DxfCode.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>, "LWPOLYLINE"), _ <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> TypedValue(DxfCode.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>, "TEXT"), _ <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> TypedValue(DxfCode.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>, "MTEXT"), _ <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> TypedValue(DxfCode.<span class="hljs-keyword"><span class="hljs-keyword">Operator</span></span>, "or&gt;")} Dim wSF <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> SelectionFilter(wTV) PSResult = ed.GetSelection(wSF) <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> PSResult.Status = PromptStatus.OK <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> PSResult.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.GetObjectIds() <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> Private Shared <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> PolyToLine(pl <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> Polyline) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> List(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span>) Dim wList <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> List(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span>) Dim wL <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">To</span></span> pl.NumberOfVertices - <span class="hljs-number"><span class="hljs-number">2</span></span> wL = <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> Line(pl.GetPoint3dAt(i), pl.GetPoint3dAt(i + <span class="hljs-number"><span class="hljs-number">1</span></span>)) wList.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(wL) Next <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> wList <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> Private Sub <span class="hljs-built_in"><span class="hljs-built_in">New</span></span>(nvert <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> List(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span>), nhorz <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> List(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span>)) <span class="hljs-string"><span class="hljs-string">' ""    Me.vert = nvert Me.horz = nhorz Dim CC, RC As Integer CC = Me.GetCols() RC = Me.GetRows() ReDim Me.Cells(CC, RC) Me.wTree = New RTree(Of MyCell)() Dim wLine As Line Dim nCell As MyCell For i = 0 To CC - 1 For j = 0 To RC - 1 wLine = Me.GetCellBox(i, j) nCell = New MyCell(wLine, i, j, "") Me.Cells(i, j) = nCell Me.wTree.Add(nCell.GetRectangle, nCell) Next Next End Sub Public Sub SetValue(wt As DBText) '</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> wt.Bounds IsNot <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> Dim tExtent <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> Extents3d = wt.Bounds Dim X, Y <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Double</span></span> X = (tExtent.MaxPoint.X + tExtent.MinPoint.X) / <span class="hljs-number"><span class="hljs-number">2</span></span> Y = (tExtent.MaxPoint.Y + tExtent.MinPoint.Y) / <span class="hljs-number"><span class="hljs-number">2</span></span> Dim wP <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(X, Y, <span class="hljs-number"><span class="hljs-number">0</span></span>) Dim wList <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> List(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> MyCell) = Me.wTree.Nearest(wP, wt.Height / <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> wList IsNot <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> wList.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> wList(<span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> = wt.TextString <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Sub <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> Sub SetValue(wt <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> MText) <span class="hljs-string"><span class="hljs-string">'  If wt.Bounds IsNot Nothing Then Dim tExtent As Extents3d = wt.Bounds Dim X, Y As Double X = (tExtent.MaxPoint.X + tExtent.MinPoint.X) / 2 Y = (tExtent.MaxPoint.Y + tExtent.MinPoint.Y) / 2 Dim wP As New Point(X, Y, 0) Dim wList As List(Of MyCell) = Me.wTree.Nearest(wP, 1) If wList IsNot Nothing Then If wList.Count &gt; 0 Then wList(0).Value = wt.Text End If End If End Sub Private Shared Function CrTbl(wList As List(Of Line)) As MyTable '</span></span> ""    Dim nvert, nhorz, overt, ohorz <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> List(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span>) nvert = wList.FindAll(<span class="hljs-keyword"><span class="hljs-keyword">Function</span></span>(l) isOrto(l) = Orent.Vert) nvert.Sort(AddressOf CompareByX) nhorz = wList.FindAll(<span class="hljs-keyword"><span class="hljs-keyword">Function</span></span>(l) isOrto(l) = Orent.Horz) nhorz.Sort(AddressOf CompareByY) <span class="hljs-string"><span class="hljs-string">' Dim MinColW, MinRowH As Double MinColW = Math.Abs(nvert(0).StartPoint.X - nvert(nvert.Count - 1).StartPoint.X) * 0.01 MinRowH = Math.Abs(nhorz(0).StartPoint.Y - nhorz(nhorz.Count - 1).StartPoint.Y) * 0.01 '</span></span> Dim ol <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span> overt = <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> List(<span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> l <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> nvert <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> ol <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> ol = l overt.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(l) <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> Math.Abs(l.StartPoint.X - ol.StartPoint.X) &gt; MinColW <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> ol = l overt.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(l) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> Next <span class="hljs-string"><span class="hljs-string">' ohorz = New List(Of Line) For Each l In nhorz If ol Is Nothing Then ol = l ohorz.Add(l) Else If Math.Abs(l.StartPoint.Y - ol.StartPoint.Y) &gt; MinRowH Then ol = l ohorz.Add(l) End If End If Next Return New MyTable(overt, ohorz) End Function Public Shared Function CrTbl(acDoc As MyAcAs.Document) As MyTable '</span></span>  Dim ed <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> Editor = acDoc.Editor Dim objIdArray() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> ObjectId = MyTable.GetSelect(ed) <span class="hljs-string"><span class="hljs-string">'       If objIdArray IsNot Nothing Then Dim dbObj As DBObject Dim wList As New List(Of Line) Dim wTList As New List(Of DBText) Dim wMTList As New List(Of MText) Using tr As Transaction = acDoc.Database.TransactionManager.StartTransaction Try For Each objId As ObjectId In objIdArray dbObj = tr.GetObject(objId, OpenMode.ForRead) '</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Case</span></span> TypeOf dbObj <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span> wList.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(dbObj) <span class="hljs-keyword"><span class="hljs-keyword">Case</span></span> TypeOf dbObj <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> Polyline wList.AddRange(MyTable.PolyToLine(dbObj)) <span class="hljs-keyword"><span class="hljs-keyword">Case</span></span> TypeOf dbObj <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> DBText wTList.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(dbObj) <span class="hljs-keyword"><span class="hljs-keyword">Case</span></span> TypeOf dbObj <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> MText wMTList.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(dbObj) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> Next tr.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>() Catch ex <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ed.WriteMessage(ex.ToString()) tr.<span class="hljs-keyword"><span class="hljs-keyword">Abort</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Try <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> <span class="hljs-string"><span class="hljs-string">' Dim wMTbl As MyTable = MyTable.CrTbl(wList) '</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> wt <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> wTList wMTbl.SetValue(wt) Next <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> wmt <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> wMTList wMTbl.SetValue(wmt) Next <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> wMTbl <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> GetCols() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> vert.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> GetColW(i <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Double</span></span> Dim res <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Double</span></span> = Math.Abs(vert(i + <span class="hljs-number"><span class="hljs-number">1</span></span>).StartPoint.X - vert(i).StartPoint.X) <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> res = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> res = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">'?! Return res End Function Public Function GetRows() As Integer Return horz.Count - 1 End Function Public Function GetRowH(j As Integer) As Double Dim res As Double = Math.Abs(horz(j + 1).StartPoint.Y - horz(j).StartPoint.Y) If res = 0 Then res = 1 '</span></span>?! <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> GetCellBox(i <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Integer</span></span>, j <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-string"><span class="hljs-string">'      () Dim p1, p2 As Point3d p1 = New Point3d(vert(i).StartPoint.X, horz(j).StartPoint.Y, 0) p2 = New Point3d(vert(i + 1).StartPoint.X, horz(j + 1).StartPoint.Y, 0) Return New Line(p1, p2) End Function Public Function CrTbl(ip As Point3d) As Table '</span></span> ACAD- Dim res <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>() Dim Rs, Cs <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Integer</span></span> Rs = Me.GetRows() Cs = Me.GetCols() res.SetSize(Rs, Cs) res.Position = ip <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">To</span></span> Cs - <span class="hljs-number"><span class="hljs-number">1</span></span> res.<span class="hljs-keyword"><span class="hljs-keyword">Columns</span></span>(i).Width = Me.GetColW(i) <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">To</span></span> Rs - <span class="hljs-number"><span class="hljs-number">1</span></span> res.<span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span>(j).Height = Me.GetRowH(j) res.Cells(Rs - j - <span class="hljs-number"><span class="hljs-number">1</span></span>, i).TextString = Me.Cells(i, j).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> Next Next res.GenerateLayout() <span class="hljs-string"><span class="hljs-string">'!? Return res End Function End Class</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Team</b> <div class="spoiler_text"><pre> <code class="hljs vhdl">Imports Autodesk.AutoCAD.Runtime Imports MyAcAs = Autodesk.AutoCAD.ApplicationServices Imports Autodesk.AutoCAD.EditorInput Imports Autodesk.AutoCAD.DatabaseServices Public Class AcadWork &lt;CommandMethod(<span class="hljs-string"><span class="hljs-string">"TblParse"</span></span>)&gt; _ Public Sub TblParse() Dim acDoc As MyAcAs.Document = MyAcAs.Application.DocumentManager.MdiActiveDocument Dim ed As Editor = acDoc.Editor Dim wMTbl As MyTable = MyTable.CrTbl(acDoc) ' Dim PPResult As PromptPointResult PPResult = ed.GetPoint(<span class="hljs-string"><span class="hljs-string">" "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> PPResult.Status = PromptStatus.OK <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> Dim nTbl As Table = wMTbl.CrTbl(PPResult.Value) Using tr As Transaction = acDoc.Database.TransactionManager.StartTransaction Try Dim bt As BlockTable = tr.GetObject(acDoc.Database.BlockTableId, OpenMode.ForRead) Dim btr As BlockTableRecord = tr.GetObject(bt(BlockTableRecord.ModelSpace), OpenMode.ForWrite) btr.AppendEntity(nTbl) tr.AddNewlyCreatedDBObject(nTbl, <span class="hljs-literal"><span class="hljs-literal">True</span></span>) tr.Commit() Catch ex As Exception ed.WriteMessage(ex.ToString()) tr.Abort() <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Try <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Using <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Sub <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Class</code> </pre><br></div></div><br>  <a href="https://github.com/triroakenshield/tblPrs">Github</a> <br><br><h5>  Conclusion </h5><br>  Using the R-tree allows you to quickly search the desired set of primitives, without using the methods of AutoCAD. </div><p>Source: <a href="https://habr.com/ru/post/278765/">https://habr.com/ru/post/278765/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278751/index.html">Work with private repositories and other updates of the FlyElephant platform</a></li>
<li><a href="../278755/index.html">Asynchronous parallel execution in PHP</a></li>
<li><a href="../278757/index.html">Windows-way synchronization settings between systems</a></li>
<li><a href="../278759/index.html">The idea of ‚Äã‚Äãan educational game for schoolchildren</a></li>
<li><a href="../278763/index.html">KTV. New JSON</a></li>
<li><a href="../278767/index.html">Microsoft announced Linux version of SQL Server</a></li>
<li><a href="../278769/index.html">Extensible Android application code with MVP</a></li>
<li><a href="../278771/index.html">Import substitution successes or entertaining statistics based on the Register of Federal State Information Systems</a></li>
<li><a href="../278773/index.html">Grid implementation for working with large tables. Part 1</a></li>
<li><a href="../278775/index.html">We write on D for Raspberry Pi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>