<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We use the old working scanner with benefits</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What will this post tell?  How to use the old scanner with the Debian server to scan at the touch of a button, and even with automatic sorting. 

 Why...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We use the old working scanner with benefits</h1><div class="post__text post__text-html js-mediator-article"><h6>  What will this post tell? </h6>  How to use the old scanner with the Debian server to scan at the touch of a button, and even with automatic sorting. <br><br><h6>  Why do you need it? </h6>  It is suitable for all those who are not satisfied with the heaps of paper in the workplace.  For example: <ul><li>  For schoolchildren and students, for those who have a pressing topic of piles of accumulated handouts at school, college or university. </li><li>  Employees in the office, who accumulate a great many of the same papers and letters </li><li>  Ordinary people - to scan all incoming letters, bills and checks (as you know, checks tend to fade, this is exactly my problem - you will need to scan a large number of checks, but this is not very convenient) </li></ul><br><br><h6>  How do I imagine this? </h6>  Yes, very simple.  I put the paper in the scanner, pressed the button, waited for a sound signal about the end of scanning and processing, took out the paper, if necessary - GOTO 10. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  And what happened to me? </h6>  An uninterrupted system that also allows batch scanning and automatic sorting by folders, logging and other troubles - and you can do that in the script. <br><a name="habracut"></a><br>  They somehow gave me an Epson Perfection 1200U scanner.  A simple USB scanner is quite old, but with a good resolution.  I wanted to connect it to my computer - and then an ambush, it is designed for 110 volts.  Okay, later I got a transformer, I connected it.  It works, but only under Windows XP - under Windows 7 there are no drivers and it is not expected.  On a working Windows 7 x64 computer - and here I am, like a fool, I ran a virtual machine every time I needed to scan something, and there was no other scanner nearby. <br>  <i>* A place for bitter regrets about unscrupulous manufacturers *</i> <br><br>  As time went on, the work computer changed at the behest of a careless mug of tea, the mother of her foot.  I decided to install Debian on a new computer, for it is more familiar.  And here the moment came again when it was necessary to scan something, and urgently.  I connect the scanner - and it works, although some kind of tension with ICM-profiles.  Apparently, someone was greedy to donate them for open source, or else it was enough for me to simply find them and install them ‚Äî I didn‚Äôt understand, I wanted to sleep too much.  Most importantly, it became possible to conveniently scan anything.  Stop, and if you connect to the server without a GUI and run scanimage?  Hmm, it works.  Great! <br><br>  So, and on the scanner case there is a button.  She never managed to use in Windows, zero emotion.  Here, however, too.  A request for Google found two projects - scanbuttond and scanbd.  The first one is old, the last commit is in 2006, but it was immediately found in the repositories.  The second one decided to leave for later, the reason is simple - during the compilation some problems of the most varied sense constantly got out, and although each of them was solved in a couple of lines in the console, there were quite a lot of them, so I scored and I wanted to sleep.  I will use scanbuttond, but if it will be relevant - I think all the scripts are not a problem to finish a bit under scanbd.  The question, of course, is how not a problem ... But for now - scanbuttond. <br><br><h5>  Getting started with scanbuttond </h5><br>  I put scanbuttond from repositories, run scanbuttond, look in /var/log/daemon.log, press a button, sleepbuttond happily notifies that the button is pressed and then released.  Cool <br>  And then what?  Then everything is simple.  First of all, edit / etc / default / scanbuttond and turn on the daemon launch together with the system, and start it with the command service scanbuttond start.  What scripts will be called? <br>  The first is initscanner.sh.example (rename, citizens, do not be shy, remove this .example), it is called whenever a scanner is connected, and basically (as far as I can tell) is the interface for connecting various crutches, well, and sometimes - alerts and logging. <br>  The second script is more interesting, it is already called directly when the button is pressed.  It is called buttonpressed.sh.example, well, the last part of the name is again superfluous here.  This script is called every time a button is clicked.  It is in him and you need to pop all these different scanning commands and stuff. <br>  Well, I made two scripts in order to handle the push of a button.  The first is on BASH.  When a button is pressed, scanbuttond transfers control to this script, indicating the button number and scanner name as $ 1 and $ 2.  There is one scanner, one button - I can ignore the arguments (I still want to sleep), but I remembered for later.  The first script, buttonpressed.sh, calls scanimage with predefined parameters, transfers the finished image to TIFF in a folder in the home directory, converts tiff to jpg and then calls the second script.  The second script in Python selects the image name, based on the names used. <br><div class="spoiler">  <b class="spoiler_title">The first script is buttonpressed.sh</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #    -   #,  , # daemon's name DAEMON=scanbuttond # securely create temporary file to avoid race condition attacks and to get some sleep TMPFILE=`mktemp /tmp/$DAEMON.XXXXXX` # lock file LOCKFILE="/tmp/$DAEMON.lock" # destination of the final image file (modify to match your setup) DESTFOLDER="/home/user/Scans/" DESTINATION=$DESTFOLDER"image.tiff" # remove temporary file on abort trap 'rm -f $TMPFILE' 0 1 15 # function: create lock file with scanbuttond's PID mk_lock() { pidof $DAEMON &gt; $LOCKFILE } # function: remove temporary and lock files clean_up () { test -e $LOCKFILE &amp;&amp; rm -f $LOCKFILE rm -f $TMPFILE } # function: check if lock file exists and print an error message using logger chk_lock() { if [ -e $LOCKFILE ]; then #Another scanning operation in progress logger "scanbuttond: trying to start scanning operation while another is in progress " exit 1 fi } # function: the actual scan command (modify to match your sleep) scan() { #           ,    -  scanimage --format=tiff --resolution 300 --mode Gray --gamma-correction "High contrast printing" &gt; $DESTINATION convert $DESTINATION $DESTFOLDER"image.jpg" logger "Filename: " `python /etc/scanbuttond/convert_scan.py` rm $DESTINATION } chk_lock mk_lock scan clean_up</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">The second script is convert_scan.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os filename = <span class="hljs-string"><span class="hljs-string">'image.jpg'</span></span> directory = <span class="hljs-string"><span class="hljs-string">"/home/user/Scans"</span></span> os.chdir(directory) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: filenames = [f <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.listdir(directory) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> f.endswith(<span class="hljs-string"><span class="hljs-string">'.jpg'</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyError: filenames = [] counter = <span class="hljs-number"><span class="hljs-number">1</span></span> new_filename = <span class="hljs-string"><span class="hljs-string">'scan_000.jpg'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> new_filename <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filenames: new_filename = <span class="hljs-string"><span class="hljs-string">'scan_'</span></span>+str(counter).zfill(<span class="hljs-number"><span class="hljs-number">3</span></span>)+<span class="hljs-string"><span class="hljs-string">'.jpg'</span></span> counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> new_filename os.rename(filename, new_filename)</code> </pre><br></div></div><br>  <b>To use change the variable DESTFOLDER in the first script and directory in the second.</b> <br>  Began to run it all.  Manually running the first script works out with a bang.  But if the button - then figs with oil.  I didn‚Äôt immediately think that the resolution issue was probably the fact that the output of the scripts didn‚Äôt show up anywhere, but I guessed to run scanbuttond in the foreground and see the output only by 5 in the morning.  In short, the problem is that in daemon mode, all scripts are run from the saned user, just like the daemon itself, in general.  What steps need to be taken? <br>  Let us assume that scanbuttond is launched from the user saned, the folder for storing photos is / home / user / Scans, and access to the folder is necessary, besides everything, to have the user user. <br><pre> <code class="bash hljs">usermod -aG saned user <span class="hljs-comment"><span class="hljs-comment"># user     saned chown -R user:saned /home/user/Scans #    saned chmod -R 770 /home/user/Scans#     </span></span></code> </pre><br>  The result - the scanner works on the button, puts all the photos in the home directory, only that which had to be scanned was not scanned.  In short, as always, instead of solving the problem, he wrote an automatic solution.  <i>As always, I want to sleep.</i> <br><br><h5>  But I want something more! </h5><br><br>  Namely: <br>  Automatic sorting of scans by directories.  How do I imagine this? <br><br><pre> <code class="bash hljs">&gt;pybssort list default /home/user/Scans/ &gt;pybssort add math Math &gt;pybssort list default /home/user/Scans/ math /home/user/Scans/Math/ &gt;pybssort <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> math Default scanning directory is now /home/user/Scans/Math/ &gt;pybssort dir /home/user/scans/Math/ &gt;pybssort add phys Physics Default scanning directory is now /home/user/Scans/Physics/ &gt;pybssort <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> phys Default scanning directory is now /home/user/Scans/Physics/ &gt;pybssort dir /home/user/Scans/Physics/ &gt;pybssort list default /home/user/Scans/ math /home/user/Scans/Math/ phys /home/user/Scans/Physics/ &gt;pybssort sleep OK, I allow you to sleep... No, <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span>, finish your article! &gt;pybssort del math OK &gt;pybssort list default /home/user/Scans/ phys /home/user/Scans/Physics/</code> </pre><br><br>  The commands list, add, del, set are designed to change the scan folder.  The dir command is used to output a folder, it is used directly in scripts. <br><h5>  What's the point? </h5><br>  At any time, you can change the folder for scanning with one command in the console.  Moreover, any user can do this - if this is undesirable, you only need to change the permissions on the database folder.  You can create contexts, watch them ‚Äî all in one command. <br><ul><li>  First, the papers were sorted into piles on the floor by topic, we take archives with records on physics. </li><li>  In the console, type pybssort add phys Physics. </li><li>  We put on a leaflet, press the button, wait for the end of the scan, throw out the scanned leaflet and put the next one. </li><li>  All scans are in the / home / user / Scans / Physics folder. </li><li>  We reach the records in mathematics, type pybssort add math Math, scan further - and all subsequent scans in / home / user / Scans / Math. </li><li>  Found another leaf with a record in physics, type pybssort set phys - and again everything flies to / home / user / Scans / Physics. </li></ul><br><br>  Hmm, how do you call these all default, phys, math?  I decided to call them contexts, since the scan of the control work on algebra only makes sense in a folder called Math, articles about healthy sleep are best poured out in the context of the Sleep folder, and so on. <br><br>  What happened in the end? <br><br>  Simple Python program.  The essence is this - all contexts are stored in the SQLite database, and from there, if necessary, the program gets them.  The currently active context is generally stored in a separate file in plain text, which is somehow silly, in my opinion, to create a table with one column and mess around with it.  There is a basic set of functions for working with these contexts, a function to start working from scratch (it creates tables and folders), <s>you can rob korovans ...</s> <s>you can sleep, finally ... I use</s> functions for working with the database from the web.py framework, where I develop my own small projects. <br>  Why not use the built-in module <s>sleeplite3</s> sqlite3?  Why do I take a whole web framework to take from it only web.database?  The answer is simple - it's banal laziness.  I am writing a program, concentrating on the main thing, and I do not want to delve into SQLite queries and write insert into contexts values ‚Äã‚Äã(name, folder);  concatenation, I want db.insert ('contexts', name = name, folder = folder) <s>and sleep.</s>  Yes, that's why my program requires python-webpy, if someone tells you something equally easy to use (I'm talking about working with databases), I will be grateful. <br><br>  Here is a link to the program: <br><br>  <a href="https://gist.github.com/CRImier/7330722">gist.github.com/CRImier/7330722</a> <br><br>  What you need to do to install? <br><pre> <code class="bash hljs">wget https://gist.github.com/CRImier/7330722/raw/pybssort.py <span class="hljs-comment"><span class="hljs-comment">#     nano pybssort.py chmod +x pybssort.py mv pybssort.py /usr/local/bin/pybssort</span></span></code> </pre> <br><br>  I‚Äôll note that for the first time you need to run it from root, since it is necessary to create folders in / var / lib in order to store a database there.  After the first launch, the root is not required.  You can edit the path to the folder at the beginning of the script, but watch out for permissions - poor saned from crying out your inability to access your folder will burst into tears.  You don't want to upset him, right? <br><br>  And how to connect it with existing scripts?  Just in the first script, you need to insert 'pybssort dir' instead of the hard-core DESTINATION, and transfer the same variable to the second script as a command-line argument. <br>  Something like this: <br><br><div class="spoiler">  <b class="spoiler_title">First script</b> <div class="spoiler_text"><pre> <code class="bash hljs">... <span class="hljs-comment"><span class="hljs-comment"># destination of the final image file (modify to match your setup) DESTFOLDER=`pybssort dir` DESTINATION=$DESTFOLDER"image.tiff" ... # function: the actual scan command (modify to match your setup) scan() { scanimage --format=tiff --resolution 300 --mode Gray --gamma-correction "High contrast printing" &gt; $DESTINATION convert $DESTINATION $DESTFOLDER"image.jpg" logger "Filename: " `python /etc/scanbuttond/convert_scan.py $DESTFOLDER` rm $DESTINATION } ...</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Second script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-comment"><span class="hljs-comment">#    ... directory = sys.argv[1]</span></span></code> </pre><br></div></div><br><br>  To debug your own scripts, I advise you to perform the following sequence of commands in your work environment: <pre> <code class="bash hljs">service scanbuttond stop sudo -u saned scanbuttond -f &amp; tail -f /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/messages &amp; tail -f /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/daemon.log &amp;</code> </pre><br>  And use echo, logger and print (for Python) in scripts. <br><br>  Criticism about all three scripts, execution, code beauty, indents, spelling, topic design, bad practices in the code and logic, relevance of the solution, possible additions, the adequacy of the author and other things are welcome. <br><br>  <b>UPD:</b> <br><br>  After some time, this BASH script got me in order ‚Äî I just couldn‚Äôt enter the normal error handling.  Spat, rewrote the script on Python.  It works in the end even better.  From the pros - error handling + normal logs, audio alerts and it looks like a beautiful code =) Available <a href="https://github.com/CRImier/scanbuttond-script">here.</a>  Readme contains installation information.  Everything works smoothly for me ... Well, if something does not work, please report =) </div><p>Source: <a href="https://habr.com/ru/post/201028/">https://habr.com/ru/post/201028/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201012/index.html">R: choir map of Russia with a larger European part</a></li>
<li><a href="../201018/index.html">Humble WB Games Bundle</a></li>
<li><a href="../201020/index.html">Nexus 5: Unboxing</a></li>
<li><a href="../201022/index.html">Published source x86 emulator JavaScript</a></li>
<li><a href="../201026/index.html">Live Mobile in a week in Moscow</a></li>
<li><a href="../201030/index.html">The course "Industrial PHP-development". How to teach a turkey to fly?</a></li>
<li><a href="../201034/index.html">Another mp3 box from mpd and raspberry</a></li>
<li><a href="../201040/index.html">Apple has placed a hidden warning on the official report.</a></li>
<li><a href="../201042/index.html">Mikrotik and OSPF. What had to face and how we overcame it</a></li>
<li><a href="../201046/index.html">New version of Intel SDK for OpenCL applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>