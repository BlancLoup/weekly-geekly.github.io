<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write effective blur on Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will try to deal with the methods of blur (blur) available for Android developers. After reading a certain number of articles and posts on St...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write effective blur on Android</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/abd/079/013/abd079013b740c9d518965afda55cc8f.jpg" alt="image" height="200" width="300" align="left"><br>  Today we will try to deal with the methods of blur (blur) available for Android developers.  After reading a certain number of articles and posts on StackOverflow, we can say that there are quite a lot of opinions and ways to accomplish this task.  I will try to put it all together. <br><br><h3>  And so, why? </h3><br>  Increasingly, you can notice the effect of blur in applications appearing in the open spaces of the Google Play Store.  Get at least the wonderful <a href="http://get.muzei.co/">Muzei</a> app from <a href="https://plus.google.com/%2BRomanNurik/">+ RomanNurik</a> or the same <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.yahoo.mobile.client.android.weather">Yahoo Weather.</a>  Looking at these applications, you can see that with good blurring you can achieve very impressive results. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A series of articles <a href="http://blog.stylingandroid.com/archives/2304">called Blurring Images</a> pushed me to write this article, so the first part of the article will be very similar.  In fact, I will try to dig a little deeper. <br><br>  Here is approximately what we will try to achieve: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a4/fcf/515/7a4fcf5150fdc49adfbf89d5e493c923.png" alt="image"><br><br><h3>  Let's get started </h3><br><br>  First I want to show what we work with.  I created 1 activity, inside which the <code>ViewPager</code> is located.  <code>ViewPager</code> through fragments.  Each fragment is a separate implementation of the blur. <br>  Here is what my <code>main_layout.xml</code> looks like: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.v4.view.ViewPager</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:tools</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/tools"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/pager"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tools:context</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.paveldudka.MainActivity"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br><br>  And this is what the layout of the fragment looks like (fragment_layout.xml): <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FrameLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ImageView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/picture"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@drawable/picture"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:scaleType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"centerCrop"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:gravity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"center_horizontal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"My super text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:textColor</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@android:color/white"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_gravity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"center_vertical"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:textStyle</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bold"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:textSize</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"48sp"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LinearLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/controls"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:background</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#7f000000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vertical"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_gravity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bottom"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FrameLayout</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  As you can see, nothing military - the usual picture in full screen with the text in the middle.  You may also notice an additional LinearLayout - I will use it to display any service information. <br><br>  Our goal is to blur the background of the text, thereby underlining it.  Here is the general principle of how we will do it: <br><ul><li>  From the picture we cut out the area that is directly behind the TextView. </li><li>  Blur </li><li>  The result is set as a background for TextView. </li></ul><br><br><h3>  Renderscript </h3><br>  Probably the most popular answer today to the question ‚Äúhow to quickly blur a picture in Android‚Äù is Renderscript.  This is a very powerful tool for working with images.  Despite its apparent complexity, many of its parts are very easy to use.  Fortunately, blur is one of those parts. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RSBlurFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fragment</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ImageView image; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextView text; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextView statusText; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ View view = inflater.inflate(R.layout.fragment_layout, container, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); image = (ImageView) view.findViewById(R.id.picture); text = (TextView) view.findViewById(R.id.text); statusText = addStatusText((ViewGroup) view.findViewById(R.id.controls)); applyBlur(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> view; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyBlur</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ image.getViewTreeObserver().addOnPreDrawListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewTreeObserver.OnPreDrawListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPreDraw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ image.getViewTreeObserver().removeOnPreDrawListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); image.buildDrawingCache(); Bitmap bmp = image.getDrawingCache(); blur(bmp, text); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }); } <span class="hljs-meta"><span class="hljs-meta">@TargetApi</span></span>(Build.VERSION_CODES.JELLY_BEAN_MR1) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">blur</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bitmap bkg, View view)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startMs = System.currentTimeMillis(); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> radius = <span class="hljs-number"><span class="hljs-number">20</span></span>; Bitmap overlay = Bitmap.createBitmap((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (view.getMeasuredWidth()), (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (view.getMeasuredHeight()), Bitmap.Config.ARGB_8888); Canvas canvas = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Canvas(overlay); canvas.translate(-view.getLeft(), -view.getTop()); canvas.drawBitmap(bkg, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); RenderScript rs = RenderScript.create(getActivity()); Allocation overlayAlloc = Allocation.createFromBitmap( rs, overlay); ScriptIntrinsicBlur blur = ScriptIntrinsicBlur.create( rs, overlayAlloc.getElement()); blur.setInput(overlayAlloc); blur.setRadius(radius); blur.forEach(overlayAlloc); overlayAlloc.copyTo(overlay); view.setBackground(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapDrawable( getResources(), overlay)); rs.destroy(); statusText.setText(System.currentTimeMillis() - startMs + <span class="hljs-string"><span class="hljs-string">"ms"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"RenderScript"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> TextView </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addStatusText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ViewGroup container)</span></span></span><span class="hljs-function"> </span></span>{ TextView result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextView(getActivity()); result.setLayoutParams(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewGroup.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT)); result.setTextColor(<span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>); container.addView(result); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre><br><br>  Let's see what's going on here: <br><ul><li>  When creating a fragment, a layout is created, a TextView is added to my ‚Äúservice panel‚Äù (I will use it to display the speed of the algorithm) and a blur is started. </li><li>  Inside <code>applyBlur()</code> I register <code>onPreDrawListener</code> .  I do this because at the time of calling this function, my UI elements are not ready yet, so there is really nothing to blur.  Therefore, I need to wait for the moment when my layout is measured and ready for rendering.  This callback will be called immediately before the first frame is drawn. </li><li>  Inside <code>onPreDraw()</code> first thing I usually do is change the return value to true.  The fact is that the IDE generates <code>false</code> by default, which means that the drawing of the first frame will be skipped.  In this case, I am interested in the first frame, so we set true. </li><li>  Then we remove our callback - we are no longer interested in onPreDraw events </li><li>  Now I need to get the Bitmap out of my ImageView.  Make her create a drawing cache and pick it up. </li><li>  Well, actually, blur.  Consider this process in more detail. </li></ul><br><br>  At once I want to note that this code has a number of shortcomings, which you should definitely remember: <br><ul><li>  This code does not "remap" when changing the layout.  It is good to register onGlobalLayoutListener and restart the algorithm when receiving this event. </li><li>  Blur is done in the main thread.  Do not try to do it in your applications - such operations should be ‚Äúunloaded‚Äù into a separate thread in order not to block the UI.  AsyncTask or something similar will cope with this task. </li></ul><br><br>  Let's return to <code>blur()</code> : <br><ul><li>  An empty Bitmap is created, corresponding in size to our TextView - here we will copy a piece of our background </li><li>  Create a Canvas so that you can draw in this Bitmap </li><li>  Shift the coordinate system to the position at which the TextView is located </li><li>  Draw a piece of background </li><li>  At this stage, we have a Bitmap, which contains a piece of background that is directly behind the TextView. </li><li>  Create a Renderscript object </li><li>  Copy our Bitmap into the structure with which the Renderscript works </li><li>  Create a script for the blur (ScriptIntrinsicBlur) </li><li>  Set the blur parameters (in my case, the radius is 20) and run the script </li><li>  Copy the result back to our bitmap </li><li>  Great, we have a blurry bitmap - set it as a background for our TextView </li></ul><br><br>  Here's what happened: <br><img src="https://habrastorage.org/getpro/habr/post_images/100/e84/ce4/100e84ce4a5b824f0b03f8e81493ac18.png" alt="image"><br><br>  As you can see, the result is pretty good looking and took us <b>57ms</b> .  Given that one frame should not take more than 16ms (~ 60fps), we can calculate that the frame rate in our case will fall to 17fps for the period while the blur is being performed.  I would say unacceptable.  It is therefore necessary to download the blur to a separate stream. <br><br>  I also want to note that the <code>ScriptIntrinsicBlur</code> is available at API&gt; 16. Of course, you can use the renderscript support library, which will reduce the required API level. <br>  But, as it is not difficult to guess, the renderscript didn‚Äôt converge on the light, therefore let's consider one of the alternatives. <br><br><h3>  Fastblur </h3><br><br>  In fact, blurring is nothing more than the manipulation of pixels, so what prevents us from manipulating with these very pixels themselves?  Fortunately, a fairly large number of implementations of various blurring algorithms are available on the Internet, so our task is to choose the most optimal one. <br>  On the all-knowing StackOverflow ( <a href="http://stackoverflow.com/questions/2067955/fast-bitmap-blur-for-android-sdk">or rather here</a> ), I came across a nice implementation of the blur algorithm. <br><br>  Let's see what came of it.  I will not give all the code, because only the blur () function will be different: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">blur</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bitmap bkg, View view)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startMs = System.currentTimeMillis(); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> radius = <span class="hljs-number"><span class="hljs-number">20</span></span>; Bitmap overlay = Bitmap.createBitmap((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (view.getMeasuredWidth()), (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (view.getMeasuredHeight()), Bitmap.Config.ARGB_8888); Canvas canvas = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Canvas(overlay); canvas.translate(-view.getLeft(), -view.getTop()); canvas.drawBitmap(bkg, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); overlay = FastBlur.doBlur(overlay, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)radius, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); view.setBackground(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapDrawable(getResources(), overlay)); statusText.setText(System.currentTimeMillis() - startMs + <span class="hljs-string"><span class="hljs-string">"ms"</span></span>); }</code> </pre><br><br>  And here is the result: <br><img src="https://habrastorage.org/getpro/habr/post_images/dfa/012/51b/dfa01251b0d93506a3fc2525eb08cf86.png" alt="image"><br><br>  As you can see, the quality is difficult to notice the difference with renderscript.  But the performance leaves much to be desired - <b>147ms</b> !  And this is not the slowest algorithm!  I'm afraid to even try to blur Gauss. <br><br><h3>  We optimize </h3><br><br>  Let's think for a second what the blur is like.  At its core, blurring is very closely related to the ‚Äúloss‚Äù of pixels (here I would like to ask experts in mathematics and graphics not to swear because I describe more based on my understanding of the problem than on specific facts :)).  What else can easily help us ‚Äúlose‚Äù pixels?  Reducing the picture! <br><br>  What if we reduce the image first, blur it, and then zoom it back? <br><br>  Let's try! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/643/1dd/e18/6431dde1879d91470674df7cf349d845.png" alt="image"><br><br>  And so, we have <b>13ms</b> renderscript and <b>2ms</b> FastBlur.  Pretty good, considering that the quality of the blur remains comparable in quality with previous results. <br><br>  Let's take a look at the code.  I will only describe the FastBlur version, since  the code for Renderscript will be similar (a link to the full version of the code is available at the end of the article): <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">blur</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bitmap bkg, View view)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startMs = System.currentTimeMillis(); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> scaleFactor = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> radius = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (downScale.isChecked()) { scaleFactor = <span class="hljs-number"><span class="hljs-number">8</span></span>; radius = <span class="hljs-number"><span class="hljs-number">2</span></span>; } Bitmap overlay = Bitmap.createBitmap((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (view.getMeasuredWidth()/scaleFactor), (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (view.getMeasuredHeight()/scaleFactor), Bitmap.Config.ARGB_8888); Canvas canvas = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Canvas(overlay); canvas.translate(-view.getLeft()/scaleFactor, -view.getTop()/scaleFactor); canvas.scale(<span class="hljs-number"><span class="hljs-number">1</span></span> / scaleFactor, <span class="hljs-number"><span class="hljs-number">1</span></span> / scaleFactor); Paint paint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Paint(); paint.setFlags(Paint.FILTER_BITMAP_FLAG); canvas.drawBitmap(bkg, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, paint); overlay = FastBlur.doBlur(overlay, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)radius, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); view.setBackground(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapDrawable(getResources(), overlay)); statusText.setText(System.currentTimeMillis() - startMs + <span class="hljs-string"><span class="hljs-string">"ms"</span></span>); }</code> </pre><br><br><ul><li>  <code>scaleFactor</code> determines how much we will reduce the image.  In my case, we will reduce by 8 times.  Moreover, given that we will lose the lion's share of pixels when the image is reduced / enlarged, we can safely reduce the blur radius of the main algorithm.  By scientific poking, I reduced to 2x </li><li>  Create a bitmap.  This time it will be less - in this case 8 times. </li><li>  Note that when drawing, I set the flag <code>FILTER_BITMAP_FLAG</code> , which will allow smoothing to be applied when the image is resized </li><li>  As before, we apply blur, but now to a much smaller picture and with a smaller radius, which allows us to speed up the algorithm </li><li>  We put this small picture as a background for TextView - it will automatically be enlarged. </li></ul><br><br>  Interestingly enough, the Renderscript worked slower than the FastBlur.  This happened due to the fact that we saved time on copying Bitmap to Allocation and back. <br><br>  As a result, we got a pretty smart method of blurring images on Android. <br><br>  Useful links: <br>  <a href="https://github.com/paveldudka/blurring">Sources to this article on GitHub</a> <br>  <a href="http://blog.stylingandroid.com/archives/2304">The progenitor of the article</a> <br>  <a href="http://stackoverflow.com/questions/2067955/fast-bitmap-blur-for-android-sdk">Post on SO about blur algorithms</a> </div><p>Source: <a href="https://habr.com/ru/post/215077/">https://habr.com/ru/post/215077/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215055/index.html">Emacs and Hunspell: Normal Spell Checker</a></li>
<li><a href="../215059/index.html">Method chaining</a></li>
<li><a href="../215071/index.html">Determining Local IP Addresses via WebRTC</a></li>
<li><a href="../215073/index.html">US Federal Court allows commercial use of drones</a></li>
<li><a href="../215075/index.html">Smartphone or voice recorder: which is more convenient?</a></li>
<li><a href="../215079/index.html">Cross-platform application on Qt: Icon</a></li>
<li><a href="../215081/index.html">rusEfi car control unit: improved hardware, now we will write software for it</a></li>
<li><a href="../215083/index.html">Web interface for Ajenti coffee maker via HTCPCP</a></li>
<li><a href="../215089/index.html">Smartphone for $ 100</a></li>
<li><a href="../215091/index.html">Hal Finney: Bitcoin and Me</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>