<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We pick up an audio stream from Twilio via SIP and send it to RTMP CDN for further distribution</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, in nature there are CDN networks that are used to deliver streaming video to end users. Take for example the online broadcast of a footba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We pick up an audio stream from Twilio via SIP and send it to RTMP CDN for further distribution</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e3f/344/c63/e3f344c63486cf937b9e4585f4cb4cec.jpg" alt="image"><br><br>  As you know, in nature there are CDN networks that are used to deliver streaming video to end users.  Take for example the online broadcast of a football match.  Historically, Adobe developed the RTMP protocol at a certain time has become very popular for delivering live video content, and there is support for this protocol in every self-respecting Encoder device or program that captures video from the camera and sends it to the server or CDN for later distribution.  This article describes how to make SIP a stream source for a CDN. <br><a name="habracut"></a><br>  Methods of further delivery of video to end users depend on the specific CDN and technologies used, which allow you to display the stream on a variety of devices and platforms: Apple HTTP Live Streaming, RTSP, MPEG-DASH, WebRTC, Websockets, etc. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2df/341/052/2df34105222e15aa5e06091f25338d2a.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Also, historically, the SIP protocol (Session Initiation Protocol) is known mainly as a protocol for audio calls and telephony, and most likely for this reason this protocol did not fall into the area of ‚Äã‚Äãinterest of CDN providers and vendors of server software for CDN networks. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ae/70f/c4f/4ae70fc4f308c9d27eee4b464168d24b.jpg" alt="image"><br><br>  Although many SIPs are associated only with telephony, the SIP protocol was originally planned and developed as a universal connection setup protocol for the subsequent transfer of arbitrary data: audio, video, files, messages, etc.  To date, the protocol is completely obsolete and a large number of software and Internet services support the SIP protocol in one form or another.  This is mainly software and equipment associated with video conferencing, video chats, communications. <br><br>  As a result, at this technological interface: SIP and CDN appeared an integration task of using SIP devices or a telecommunication service as a source of a video stream for a CDN network with the subsequent distribution of this video stream to end users. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8d6/442/582/8d6442582cdb5baefea6bb426598340b.jpg" alt="image"><br><br>  The simplest example is a videoconference or a webinar of educational or public topics, deployed on the basis of software with SIP support and requiring broadcast to the CDN network for a broad presentation of the event. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/11e/cf5/42b/11ecf542b5a1a5bc88c765567fd15f0b.jpg" alt="image"><br><br>  In this article, for simplicity, we restrict ourselves to capturing an audio stream from a SIP conference and further broadcasting this stream via RTMP.  Strictly speaking, such an action is rather a SIP call with further conversion and redirection of traffic rather than video capture. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7cf/11e/a55/7cf11ea5583c5fba112671420a1b4fbb.jpg" alt="image"><br><br>  In the capture and broadcast diagram, you can see the ‚Äúcommand" arrow. In fact, if we have three participants: a SIP device, an integrating server and an RTMP server, then there must be an interface or API through which you can give a command to start the capture of a SIP stream and further translation, i.e., launch the case itself. <br><br>  Another requirement is that calls and broadcasts should be able to be installed in parallel and a lot.  Those.  You can install SIP Call1 - RTMP Stream1, SIP Call2 - RTMP Stream2 pairs, etc.  For example in the case when there are several webinars (rooms) that go at the same time. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/072/f83/9b0/072f839b06afcdb1ce371e28113934f6.png" alt="image"><br><br>  As a server / service SIP conferences, we will use the service Twilio. <br>  As an RTMP server, on the basis of which a CDN can be built, we will use the Wowza Streaming Engine. <br>  The integrating server will be Web Call Server 4 with support for converting and translating SIP to RTMP. <br>  The command to the server for a call to SIP and stream redirection to RTMP will be sent via REST / HTTP - perhaps the most widely used HTTP-based software interaction method on the Internet. <br><br>  This article describes how to organize the broadcast of audio messages or audio calls using a simple REST / HTTP request. <br><br>  This will require: <br><br><ul><li>  Register with Twilio and create a SIP domain </li><li>  Installing and configuring the RTMP server Wowza </li><li>  Installing and configuring a Web Call Server 4 server that broadcasts SIP as RTMP </li><li>  Installing the REST Console extension to perform REST / HTTP requests manually from the Google Chrome browser </li></ul><br><h2>  Twilio </h2><br>  <a href="https://www.twilio.com/">Twilio</a> is a cloud-based telephony platform that provides an API that allows you to integrate telephony services into mobile and web applications. <br>  To use Twilio you need to register.  After registration, you can select a phone number that can be assigned an application URL with Twilio instructions.  An incoming call to this number will be processed in accordance with these instructions.  For example, an audio message may be played or a connection to a telephone conference may be established. <br><br>  In addition to the call to the phone number, you can establish a SIP connection with Twilio.  To do this, you need to create and configure a Twilio <a href="https://www.twilio.com/docs/api/twilio-sip/sending-sip-how-it-works">SIP domain</a> , which can also be assigned the ‚ÄúVoice Url‚Äù application with instructions for Twilio. <br><br>  To create a Twilio SIP domain, you need to add a SIP Endpoint: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1d6/bf9/d16/1d6bf9d16c4ae79af351dd390d824c05.png" alt="image"><br><br>  This is the list of SIP Endpoints: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d1e/a70/95c/d1ea7095ce260ebb6f54c537717eb49f.png" alt="image"><br><br>  You can call Twilio's SIP domain from a SIP device, for example, from a softphone.  This will require: <br><br>  1. Add an external IP device to the IP Access Control List: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/41a/a44/d75/41aa44d75de6efaef1dd8bb8d3099c8d.png" alt="image"><br><br>  * Instead of '192.168.1.5', the external IP of the device should be specified. <br><br>  2. Add a name and password to the Credential List: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3df/11e/10c/3df11e10ce289640b4990e56d496b55c.png" alt="image"><br><br>  3. Create a registration-disabled softphone account, specifying both the Twilio SIP-domain domain and the name and password added to the Twilio SIP-domain account list as the user name and password.  A similar X-Lite softphone account will look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8e0/501/8b9/8e05018b9b19bce34dcdf1c1ebe0f691.png" alt="image"><br><br>  4. To initiate a call to Twilio SIP-domain (for example, if the domain name is mytwiliodomain.sip.twilio.com, you need to call mytwiliodomain.sip.twilio.com): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e7/80d/cc6/7e780dcc6289e21ed859521318ff41e1.png" alt="image"><br><br>  So we called Twilio from a SIP softphone and actually tested the SIP part, taking and losing the audio stream that participates in the call.  Now it remains to make the same call from the WCS4 server and redirect the received audio traffic as RTMP. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4df/936/07d/4df93607d1da45c20e6fa2ef4850b183.jpg" alt="image"><br><br><h2>  Web Call Server 4 </h2><br>  WCS4 will require a server with Linux 64-bit and java installed.  You need the console command to display information about the Java machine: <br><br><pre><code class="hljs pgsql">java ‚Äì<span class="hljs-keyword"><span class="hljs-keyword">version</span></span></code> </pre> <br>  If java is not installed, you can install it with the command: <br><br><pre> <code class="hljs sql">yum <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-keyword"><span class="hljs-keyword">java</span></span></code> </pre><br>  WCS4 server can be downloaded <a href="http://flashphoner.com/wcs4">here</a> , and request a trial license <a href="http://flashphoner.com/get_trial">here</a> . <br>  The only change that will need to be made in the server settings after its installation is an abbreviation of the codec list that is required for a SIP connection to the Twilio SIP domain with audio only. <br><br>  Configuring codecs in the flashphoner.properties configuration file (in the / usr / local / FlashphonerWebCallServer / conf directory) should include only G.711 uLaw: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">codecs</span></span> = ulaw</code> </pre><br>  The file can be edited, for example, using Midnight Commander (mc) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e02/83b/b14/e0283bb1476c4d6b9b9b73b7cab2bedf.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b24/674/185/b246741851f94ee4bff34efde629eaac.png" alt="image"><br><br><h2>  Wowza </h2><br>  Wowza Streaming Engine, available for download from <a href="http://wowza.com/">wowza.com</a> .  It will require a license;  You can request a free <a href="http://www.wowza.com/media-server/developers/license">developer license</a> .  In the server control panel, you must enable publishing RTMP streams in the 'Applications' |  'live' |  'Incoming Security'. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3dd/bda/4a6/3ddbda4a6216522d3c2a0e862efb7f9d.png" alt="image"><br><br><h2>  Forming a REST / HTTP request to start a call </h2><br>  After completing the WCS, Twilio SIP domain and Wowza settings, you can proceed to establish a SIP connection between the WCS server and the Twilio SIP domain.  In this case, to initiate a SIP call, you need to send an HTTP / REST / POST request to the WCS server.  An example of a body of a similar REST request in JSON format. <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"callId"</span></span>:<span class="hljs-string"><span class="hljs-string">"R2fhkll5Sw3lK"</span></span>, <span class="hljs-string"><span class="hljs-string">"callee"</span></span>:<span class="hljs-string"><span class="hljs-string">"mytwiliodomain.sip.twilio.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"rtmpUrl"</span></span>:<span class="hljs-string"><span class="hljs-string">"rtmp://my_wowza_server.com:1935/live"</span></span>, <span class="hljs-string"><span class="hljs-string">"rtmpStream"</span></span>:<span class="hljs-string"><span class="hljs-string">"streamName"</span></span>, <span class="hljs-string"><span class="hljs-string">"hasAudio"</span></span>:<span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-string"><span class="hljs-string">"hasVideo"</span></span>:<span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-string"><span class="hljs-string">"connection"</span></span>:{ <span class="hljs-string"><span class="hljs-string">"sipLogin"</span></span>:<span class="hljs-string"><span class="hljs-string">"myusername"</span></span>, <span class="hljs-string"><span class="hljs-string">"sipPassword"</span></span>:<span class="hljs-string"><span class="hljs-string">"MyPasswordPassword1"</span></span>, <span class="hljs-string"><span class="hljs-string">"sipAuthenticationName"</span></span>:<span class="hljs-string"><span class="hljs-string">"myusername"</span></span>, <span class="hljs-string"><span class="hljs-string">"sipDomain"</span></span>:<span class="hljs-string"><span class="hljs-string">"mytwiliodomain.sip.twilio.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"sipPort"</span></span>:<span class="hljs-string"><span class="hljs-string">"5060"</span></span>, <span class="hljs-string"><span class="hljs-string">"sipRegisterRequired"</span></span>:<span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-string"><span class="hljs-string">"appKey"</span></span>:<span class="hljs-string"><span class="hljs-string">"callApp"</span></span> } }</code> </pre><br>  The values ‚Äã‚Äãof the ‚Äúconnection‚Äù subobject parameters in the request are selected in the same way as in the softphone account: <br><br><ul><li>  "SipRegisterRequired": "false" - i.e.  without SIP registration </li><li>  "SipDomain": "mytwiliodomain.sip.twilio.com" - Twilio SIP domain </li><li>  "SipLogin" and "sipPassword" - the name and password added to the list of Twilio SIP domain accounts </li></ul><br>  Among these parameters, there is also an ‚ÄúappKey‚Äù parameter indicating the name of the standard application on the server side ('callApp'), which receives the status of the SIP call and the associated RTMP stream. <br><br>  Other options: <br><br><ul><li>  "Callee": "mytwiliodomain.sip.twilio.com" - the name of the callee: Twilio SIP-domain </li><li>  "CallId": "R2fhkll5Sw3lK" - SIP Call ID, arbitrary unique identifier for a call </li><li>  "RtmpStream": "streamName" - RTMP URL with the address of the RTMP server to which the audio of the call will be transmitted </li><li>  "RtmpUrl": "rtmp: //my_wowza_server.com: 1935 / live" - ‚Äã‚Äãthe name of the stream that will be published on the RTMP server </li><li>  ‚ÄúHasAudio‚Äù: ‚Äútrue‚Äù - whether it will be indicated in the SDP that WCS will send RTP audio traffic for this call </li><li>  ‚ÄúHasVideo‚Äù: ‚Äútrue‚Äù - will it be indicated in the SDP that WCS will send RTP video traffic for this call </li></ul><br><h2>  ‚ÄúSendrecv‚Äù and ‚Äúrecvonly‚Äù parameters in SIP </h2><br>  The hasAudio and hasVideo parameters are important.  The case assumes that we do not send traffic to a SIP device, but only receive traffic from it.  If hasAudio and hasVideo are set to ‚Äútrue‚Äù, then in SDP it will be marked ‚Äúsendrecv‚Äù (send and receive) for audio and video.  Some SIP devices in this case will wait for traffic and reset the SIP connection on timeout if there is no traffic.  Therefore, in this case, you will have to raise the waiting time on the SIP device itself or set hasAudio and hasVideo to ‚Äúfalse‚Äù to be sent to SDP ‚Äúrecvonly‚Äù.  In this case, the SIP side will know that we are only going to receive the video (receive only) and the timeout should not work. <br><br><h2>  Sending a REST / HTTP request from the REST Console </h2><br>  Request URI for a similar REST call will be <br><br> <code><a href="http://my_wcs_server.flashphoner.com/"></a> my_wcs_server.flashphoner.com:9091/RESTCall/call <br></code> <br><br>  where my_wcs_server.flashphoner.com is the WCS server address. <br><br>  To send a REST call, you need a REST client.  You can use Chrome browser extension, for example, REST Console or Advanced REST client, or SIP as RTMP REST client for WCS server (requires installation of the Allow-Control-Allow-Origin extension: * for Google Chrome browser). <br><br>  An example of a REST Console interface with fields required for a REST request: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/330/d77/58e/330d7758e1e571d693de36bd32888a37.png" alt="image"><br><br>  If the WCS server is running, Twilio accepts SIP calls and all data is entered correctly, press the "POST" button in the REST Console and send a request to the server.  As a result, a SIP connection is established between WCS and Twilio and the audio stream will be sent to the specified RTMP address. <br><br><h2>  Play stream in RTMP-player </h2><br>  To play the published RTMP stream, you can use the Flash RTMP player in the Wowza examples, for example: <code><a href="http://my_wowza_server.com/FlashRTMPPlayer/player.html"></a> my_wowza_server.com/FlashRTMPPlayer/player.html <br></code> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/202/783/b2c/202783b2cacece732929f8330254b602.jpg" alt="image"><br><br>  Before starting playback of a stream, the ‚ÄúrtmpUrl‚Äù and ‚ÄúrtmpStream‚Äù values ‚Äã‚Äãspecified in the REST request must be entered into the ‚ÄúServer‚Äù and ‚ÄúStream‚Äù fields. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e17/ec4/45a/e17ec445a54d9b663b9ab843f81cd919.png" alt="image"><br><br>  When playing an RTMP stream associated with a SIP call, in the RTMP player, you can listen to the audio that the application is accessing via the Voice Url of the Twilio SIP domain. <br><br><h2>  Broadcast video, additional information </h2><br>  You can broadcast not only audio, as is the case with Twilio, but also video with the H.264 codec, if SIP Endpoint supports and answers video calls. <br><br>  Full list of supported codecs: <br><br><ul><li>  Audio: G.711 (alaw or ulaw) or Speex 16 kHz </li><li>  Video: H.264 </li></ul><br>  The diagram below illustrates the transfer of calls and media. <br><br>  1. Challenges (black arrows): <br><br><ul><li>  HTTP / REST / POST request to the WCS server </li><li>  SIP connection between WCS server and SIP terminal (for example, Twilio SIP domain) </li><li>  RTMP connection between WCS server and RTMP server </li></ul><br>  2. Media (red arrows): <br><br><ul><li>  RTP media from SIP terminal to WCS server </li><li>  RTMP stream from WCS server to RTMP server </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/2d7/aa3/402/2d7aa34021b284be9649757c0ff37534.png" alt="image"><br><br>  Videos can be broadcast, for example, when a video call is established with a softphone (for example, Bria).  In this case, the values ‚Äã‚Äãof the parameters of the REST call: <br><br><ul><li>  "SipDomain" and "sipPort" - will be the address and port of the SIP server on which the softphone is registered </li><li>  "SipLogin" / "sipAuthenticationName" and "sipPassword" - the name and password of the account on this SIP server </li><li>  "Callee" - the name of the account used to register the softphone </li></ul><br><h2>  Conclusion </h2><br>  Thus, we managed to integrate the Twilio service and the RTMP server, by redirecting the SIP audio stream to RTMP for further distribution by any technologically accessible means. </div><p>Source: <a href="https://habr.com/ru/post/271233/">https://habr.com/ru/post/271233/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271223/index.html">We connect GNS3 topology to Cisco dCloud</a></li>
<li><a href="../271225/index.html">Your Joomla site incorrectly gives page 404</a></li>
<li><a href="../271227/index.html">PaaS vs Licenses. Four noble truths of IT infrastructure</a></li>
<li><a href="../271229/index.html">HP P2000 MSA G3 Performance Testing</a></li>
<li><a href="../271231/index.html">Downloading tracks from Autotravel.ru</a></li>
<li><a href="../271235/index.html">How we tested the Russian workflow system on the Scala-R convergent platform</a></li>
<li><a href="../271237/index.html">Features of creating a turnkey web project from Startup Makers</a></li>
<li><a href="../271239/index.html">Testing a web service on Go</a></li>
<li><a href="../271241/index.html">Forecasting in the gaming industry. Part 3: Forecasts for the forecast industry</a></li>
<li><a href="../271243/index.html">ActiveRecord-based Ruby REST API for accessing tables in a database</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>