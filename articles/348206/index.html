<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Algorithm of a choice of location in Nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The location selection algorithm is required to know when configuring nginx. However, the official site of nginx (for 2018) does not say a word about ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Algorithm of a choice of location in Nginx</h1><div class="post__text post__text-html js-mediator-article">  The location selection algorithm is required to know when configuring nginx.  However, the official site of nginx (for 2018) does not say a word about the selection algorithm in cases where some locations are embedded into each other, and in the articles on the Internet, <b>incorrect</b> algorithms are given <b>in the root</b> .  The article will also give an example of a vulnerable config. <br><a name="habracut"></a><br><h1>  A special case with one level of nesting </h1><br>  If you are new to nginx, then you should first consider a special case without using nested locations, since the algorithm for a particular case is much simpler: <br><br><ol><li>  First, equality (=) will be sought.  It has the highest priority. </li><li>  Then the maximum length prefix location <nobr>(() or (^ ~))</nobr> will be searched, after which it will be checked if there is a priority modifier (^ ~) on the found location, and if it exists, this location will be returned. </li><li>  Then regular expressions <nobr>((~) and (~ *))</nobr> will be checked from top to bottom.  If it matches, the first location will be returned. </li><li>  Then that prefix location, which we found before, will return. </li></ol><br>  Please note that this algorithm is not applicable if there are nested locations. <br><br><h1>  General case with nested location </h1><br><ol><li>  We start from the top level. </li><li>  If the current level is equal (=), the search stops - this will be the result, since such a location can not have any other nested locations. </li><li>  Otherwise, we search <b>the current</b> level for the largest prefix location <nobr>(() or (^ ~)).</nobr> <ul><li>  If such a prefix location exists, then we make it the current level and proceed to step 2. </li><li>  Otherwise, exit the loop. </li></ul></li><li>  We are out of the loop.  At the moment we have found the ‚Äúlargest‚Äù prefix location, but do not think that this is the largest of all.  Example: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /abc { <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /abcdefghi { ‚Ä¶ } } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /abcdef { ‚Ä¶ }</code> </pre> <br>  In this example, we will go to / abcdef, because at his level he overcame a shorter / abc.  But in fact there are location and more. </li><li>  Now in the found location we are looking for the first valid regexp.  When finding the search completely stops.  <b>Please note:</b> at this point we are in fact looking for a regexp at the lowest level, and not at the top, as many might think.  <nobr>That is, the</nobr> search for regexp comes from the bottom, not from the top (but inside one level comes from the top, not the bottom). <ul><li>  Further, if nothing is found, we go up one level and similarly we are looking for the first regexp, but this time it is only provided that the location in which we were before did not have a label (^ ~).  Repeat this point until there is nowhere to go up. </li><li>  It should be borne in mind: <ul><li>  Even if one of the levels has a label (^ ~), this does not mean that we do not lift.  Lifting is always done, but if the lower level had a label (^ ~), then at the current level the search for regexps is not performed. </li><li>  There is no possibility to disable regexp checking in the lowest level - for this you need to create another nested level.  But it is possible to disable regexp checking at the zero level - for this location of the first level (which is at the zero level) it must have a label (^ ~). </li></ul></li></ul></li><li>  We made a climb on a tree, but never found a single regexp.  Once regexp is not found, we return ‚Äúalmost the biggest‚Äù to the prefix location that was found earlier.  Is done. </li></ol><br>  Also with this: <br><br><ul><li>  In versions 0.7.1‚Äì0.8.41, the prefix location () with an exact match acts as = </li></ul><br><h1>  Example of a vulnerable config </h1><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ \.php$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-comment"><span class="hljs-comment">#      php-fpm } location /posts/ { location ~ (.*)_2x(\.[az]+)$ { try_files $uri $1$2 =404; } }</span></span></code> </pre><br>  In this config, we configured ignoring "_2x" if the file is not found.  For example, nginx will try to find the file /posts/img/a_2x.png both along the specified path and along the path /posts/img/a.png.  But in reality, if we request /posts/authData_2x.php, then we will get the source code of the authData.php script in the bare form.  To avoid such errors, you need to know how location is handled in nginx. <br><br>  Also, additional protection may be the storage of scripts in a separate directory, inaccessible from under the normal location.  In this case, if our location on php for some reason does not work, the user will receive error 404, and not the source text of the script. <br><br><h1>  Location redirection </h1><br><ol><li>  If try_files does not contain the error code as the last parameter, it will be redirected to another location, since the last parameter always redirects.  Please note: the error code in try_files should be written with an equal (=). </li><li>  index and error_page always trigger redirections to another location when triggered.  Also, the redirect makes rewrite if you add the flag last to it. </li></ol><br><h1>  Other </h1><br><ol><li>  When selecting a location, the query string that begins with the "?" Is not taken into account. </li></ol><br><h1>  Denial of responsibility </h1><br>  The algorithm in the article was compiled by me on the basis of my personal observations, and not the fact that it is correct.  Unfortunately, there is no official documentation, but I have not read the source code.  If someone finds errors in the algorithm, please write a personal message or in the comments. </div><p>Source: <a href="https://habr.com/ru/post/348206/">https://habr.com/ru/post/348206/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348196/index.html">Track user actions with CSS</a></li>
<li><a href="../348198/index.html">Understanding lvalue and rvalue in C and C ++</a></li>
<li><a href="../348200/index.html">Sean Pierce: A Real Leader</a></li>
<li><a href="../348202/index.html">Apache Ignite - calculations in grid</a></li>
<li><a href="../348204/index.html">GObject Basics</a></li>
<li><a href="../348208/index.html">Interview. How to create a high-quality knowledge base: choice of technologies, search and further support</a></li>
<li><a href="../348210/index.html">Create CSS keylogger</a></li>
<li><a href="../348212/index.html">Game development for NES in C. Chapters 4-6. Drawing character</a></li>
<li><a href="../348214/index.html">Transcription of geographical names in Open Street Map. Latvia, Lithuania, Poland, Estonia</a></li>
<li><a href="../348218/index.html">New lite text markup language based on pair quotes (pq)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>