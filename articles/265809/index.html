<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make tetris for half a year on cocos2dx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my article I would like to share the technical part of the game, which was made by two people. The main architectural patterns (design patterns) an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make tetris for half a year on cocos2dx</h1><div class="post__text post__text-html js-mediator-article">  In my article I would like to share the technical part of the game, which was made by two people.  The main architectural patterns (design patterns) and techniques, additional libraries, porting features when working with the cocos2dx engine will be considered.  The source code is <a href="https://github.com/darkwind666/BeaverTetris">here</a> . <br><br><img src="https://habrastorage.org/files/93f/e8c/ae3/93fe8cae30334fbe86ccbd13c0a4479a.png"><br><a name="habracut"></a><br>  The game is called Beaver time.  My sister was responsible for the design.  Development was conducted on the cocos2dx engine, in the c ++ language. <br><br><h4>  Gameplay </h4><br>  Based on the mechanics of the game Tetris.  Added destruction of identical squares horizontally and vertically (4 in a row), a variety of spells, abilities of the player, different winning conditions, different unpleasant moments to complicate the game and square-bosses. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Architecture </h2><br>  <i><b>MVC</b></i> <br><br>  The main template used in the game code is MVC ( <a href="https://ru.wikipedia.org/wiki/Model-View-Controller">described in Wikipedia</a> , <a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/DevPedia-CocoaCore/MVC.html">Apple documentation</a> ).  A template consists of three parts: a model, a view, and a controller.  The controller mediates between the model and the view.  Moreover, each of its parts has its own duties.  As an example, you can give the implementation of the game board (game world): <br><br>  1) Model.  The following main game entities were highlighted: a square, a detail from squares.  The game also has a game board ( <a href="">GameBoardViewDataSource</a> ), where coordinates correspond to each cell (for example (1, 1), (32, 48)).  The board is a collection of squares.  However, it is a data model.  The detail is essentially a small board. <br><br>  2) Controller.  The game board controller ( <a href="">GameBoardController</a> ) decides when to draw a model.  He does not know the internal structure of the model (array, linked list).  He knows only the number of cells and how to get information about each cell.  In the context of cocos2dx, this is the heir of the Node class. <br><br>  3) Submission (Sprite).  The representation draws squares (the rendering code) without knowing anything about their data structure.  In the context of cocos2dx, this is the Sprite class.  The controller contains a collection of sprites, which gives data for drawing (textures, positions). <br><br>  When developing the game, passive MVC was mainly used - the controller itself takes data from the model when necessary. <br><br>  The game has a main controller ( <a href="">GameWorldController</a> ), which instructs the game board controller and animation controller to update its states.  In addition, he still updates the state of gaming systems: <br><br>  1) Win-lose system ( <a href="">WinGameSystem</a> ) - decides when the player won, and when he lost. <br><br>  2) The system of game events - decides when you need to run a malicious event (speed up the game, throw off a couple of unnecessary details). <br><br>  3) The system of game logic ( <a href="">TetrisLogicSystem</a> ) - whether the row of squares, 4 identical squares is assembled vertically or horizontally. <br><br>  4) Spell System ( <a href="">SpellRechargeSystem</a> ) - monitors spell states. <br><br>  5) The control system of the current player details ( <a href="">CurrentDetailController</a> ) - control the detail, lowering it down one step, etc. <br><br>  6) The system for tracking the status of bosses. <br><br>  For each element of the gameplay has its own system.  The animation controller consists of separate controllers for each system.  They are based on the Action class and its subclasses.  Usually some kind of event should occur after the animation (increase in points, delete the bottom row, etc.), so the systems send callback functions to the controllers, for example, lambdas in c ++ 11.  This is an example of using active MVC - the model itself calls the controller when necessary. <br><br>  The advantage of such a system is flexibility, because  To add a new gameplay element, you just need to add a new system and possibly an animation controller.  Minus in its complexity and in the amount of code for its implementation.  Sometimes there are implicit dependencies between systems due to their update order. <br><br>  <i><b>Single mother</b></i> <br><br>  In the development of the game is also often used template Singleton ( <a href="">ServiceLocator</a> ).  In the source code, this is not pure Singleton, but simply a global variable hidden by access methods.  In fact, it was a container for models.  For example, when a player selects a level on the map, the loader ( <a href="">GameLogicLoader</a> ) loads the necessary models (data for the current level, system) into this container.  And then the controllers get the necessary models from it.  It would be possible to make models directly in controllers, but this would cause additional dependencies. <br><br>  <i><b>Factory</b></i> <br><br>  The Factory pattern was often used (Factory Method) There are 7 scenes (Screens) in the game and a factory was made for each screen that loads the necessary models and collects a scene graph from the controllers.  For example, the class <a href="">LoadingGameSceneFactory</a> . <br><br>  <i><b>Observer</b></i> <br><br>  The Observer pattern was also used.  In a scene where there are hidden items that are shown on a specific event (pop-up windows), an object is created, and observers (pop-up windows) are signed to it for certain messages.  Then, when an event occurs, a notification is sent to this object, then the object sends a notification to the necessary observers and pop-up windows are shown.  For example, the class <a href="">RegulateSoundPopUp,</a> when initialized, subscribes to messages from GamePopUpsController. <br><br>  <i><b>Strategy</b></i> <br><br>  Also used the Strategy template.  For example, different bosses have different behaviors: some do nothing, others escape from danger.  To implement their behavior was used a set of strategies.  A collection of strategies is created and populated with the necessary ones.  By adding different strategies, we add different behaviors to the boss.  For example, the <a href="">AIMovementStrategy</a> class is one of the strategies that adds the ability to move the boss. <br><br>  <b>Additional libraries.</b> <br><br>  To collect player statistics, it was decided to use google analytics.  There is a google analytics sdk for ios and android, but there was no implementation for windows.  After reading the sdk documentation, it was decided to use the <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/">Google Analytics Measurement Protocol</a> .  An example ( <a href="https://github.com/juanvicfer/GATrackerpp">GATrackerpp</a> ) of using such a protocol was found on the Internet using the curl library.  The result was a cross-platform implementation of sending analytics.  However, to send information you need a unique player identifier according to the standard GUID.  I also found a library for cross-platform generation of GUID-identifiers (crossguid).  But in the end, for android, it was decided to use one GUID for all, as  did not understand with connection with ++ to java. <br><br>  To parse the xml-files with the level settings, it was decided to use the <a href="https://github.com/zeux/pugixml">pugiXML</a> cross-platform parser.  This is a DOM parser, which was chosen because it did not need to parse large files and was advised on the cocos2dx forum. <br><br>  <b>Features of porting.</b> <br><br><img src="https://habrastorage.org/files/092/b08/906/092b089060474258a3cf1eef9c0d0cdd.png"><br><br>  At the beginning, development was carried out for windows, a regular window application.  Then a port for windows store was made - on windowsRT.  Then a version for android was made.  To organize a cross-platform project, a branch system in git was chosen.  For each platform, a separate branch is created.  The main error was that the code base of the branches is slightly different, i.e.  There is no single kernel, as for example in the <a href="https://github.com/cocos2d/cocos2d-x">cocos2dx</a> repository.  Later, I learned that it would be possible to initially use the preprocessor with ++, while encapsulating the preprocessor commands into factory classes (the Factory template).  But the branches were still useful, because  different platforms have different graphics and interface elements positions.  In this case, all the code for android was initially tested and debugged under windows, and then it was built for android. <br><br>  Another important point was finding the path to save files in the file system of different platforms, as well as archiving the apk-file in android. <br><br>  Sound formats did not cause problems - mp3 was used for all platforms. <br><br>  <b>Oddities during development:</b> <br><br>  1) In one class, the post-increment (i ++) was not compiled, it was necessary to do a pre-increment (++ i) - in the version for android. <br>  2) The engine did not support the path with the Cyrillic alphabet.  If the windows username is written in Russian, the game will cause an error and will not start. <br>  3) Once it turned out that the sound does not work, because the implementation of the method is not in the engine.  I had to use another class. <br><br>  <b>Results:</b> <br><br>  In conclusion, I would like to mention the main templates that were used: MVC, Factory, Single, Observer, Strategy.  The main additional libraries were curl and pugiXML.  It took six months to develop the game.  Of them: <br><ul><li>  2-3 weeks thinking through the mechanics and writing technical specifications, </li><li>  a month of thinking through the architecture and writing the model classes, </li><li>  a month for building the engine and writing classes for drawing and animation, </li><li>  month to test and adjust the balance of the game, </li><li>  2-3 weeks for porting for WindowsRT (game in full screen) </li><li>  2-3 weeks for porting to android (setting up the environment for building the project, testing on the simulator). </li></ul><br>  The source code of the entire project can be viewed <a href="https://github.com/darkwind666/BeaverTetris">here</a> , the project on windows with filters (directories for source files) <a href="https://github.com/darkwind666/BeaverTetris/tree/BeaverTetrisWindows7/BeaverTetris/proj.win32">here</a> . <br>  In the end, I released my game and got a lot of experience and pleasure when working on a project. <br><br>  Thank you all for your attention. </div><p>Source: <a href="https://habr.com/ru/post/265809/">https://habr.com/ru/post/265809/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265799/index.html">Perl5 plugin for IntelliJ IDEA</a></li>
<li><a href="../265801/index.html">Webpack for Single Page App</a></li>
<li><a href="../265803/index.html">Samsung SSDs high capacity for servers</a></li>
<li><a href="../265805/index.html">gRPC - framework for remote procedure call from Google</a></li>
<li><a href="../265807/index.html">About duplicating web map tiles</a></li>
<li><a href="../265811/index.html">Say a word about poor XWiki</a></li>
<li><a href="../265813/index.html">Translation of Richard Bartle's book Designing Virtual Worlds. Chapter 1. Basics</a></li>
<li><a href="../265815/index.html">[libGDX] Experience developing a game using Box2D</a></li>
<li><a href="../265817/index.html">1C: Summer School 2015 - how to organize a "smart" vacation for young programmers - part 1. Who and what he studied, daily routine, carrot and carrot</a></li>
<li><a href="../265819/index.html">RAD Studio 10 Seattle Release</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>