<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The history of the fight with the file-encrypting Trojan - a trip to the control center for the key</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 The story began with the fact that at the beginning of the day the bell rang. The agitated voice of the client said that the computer d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The history of the fight with the file-encrypting Trojan - a trip to the control center for the key</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  The story began with the fact that at the beginning of the day the bell rang.  The agitated voice of the client said that the computer does not load, documents do not open, and instead of the usual desktop on the screen there is a threatening inscription with an approximate meaning: ‚Äúpay us money and we will return your desktop and documents to you‚Äù.  The situation is familiar to many: most likely another winlocker on a computer, the work on the extortioner drank will take a maximum of 10 minutes. <br><br>  For the sake of removing a vinloker in 10 minutes, I didn‚Äôt want to go to the other end of the city, so we agreed that they would bring a system officer to me, I would put it in order and return it back. <br><br>  I got a sistemnik included.  Windows XP was loaded.  A desktop appeared - no sign of a winlocker, at first glance everything is fine.  However, trying to open the first document from the desktop, I received in response a ‚Äúterrible‚Äù message: <br><a name="habracut"></a><br><img src="https://habrastorage.org/storage2/5e6/c48/713/5e6c4871384d02c5ee59fd904032a5c7.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Naturally, like any person who is not the first time faced with Trojans, extortionists, I treated this text with a fair amount of skepticism.  Surely, I thought, it‚Äôs all a matter of the usual program, which reconfigured the opening of files with the .doc and .xls extensions in order to scare inexperienced users with text with incomprehensible words.  To make sure of this assumption and catch the hooligan program, I booted the computer from the system recovery image, opened drive C in the file manager and saw a very sad picture: all files on local drives suddenly acquired the M5bFu extension, and their contents became similar to the result of the generator random numbers.  There is not a trace of the previous file contents. <br><br>  So, the message that the files are encrypted turned out to be true.  All files smaller than 2 gigabytes with the extension doc, xls, dbf, avi, jpg, txt, rar, zip turned out to be encrypted - in general, everything that may be of value to the information owner.  Among the encrypted files - 1C base and important documents.  If 1C could still be restored from a fresh backup, then the loss of valuable documents and photographs could seriously damage the client‚Äôs health.  Thus, there was no choice - I had to take up the decryption of data. <br><br><h4>  Stage 1. Search for encryption algorithm </h4><br>  Again, being by nature slightly untrustworthy, I decided, despite the explicit indication of the encryption algorithm in the message, to independently determine how the cryptographic algorithm encrypts the data in the files (all of a sudden it‚Äôs not as bad as it is written).  First, we check the simplest and most common replacement ciphers: Caesar cipher, XOR, etc. <br><br>  For analysis, we take two dbf files: one is encrypted from the infected system, the other is untouched from a fresh backup and compare them with each other.  We can indicate to the primitive replacement cipher areas of the source dbf file filled with consecutive identical bytes, for example with a value of 0. Fortunately, dbf files are not distinguished by high density of stored information and there are plenty of zero bytes in them. <br><br><img src="https://habrastorage.org/storage2/59b/8ab/4d4/59b8ab4d4f203f3c769566e3e1550a05.png"><br><br>  The figure shows fragments of the source file with several zeros in a row and what these zeros turned into in an encrypted file.  Simple inline replacement ciphers, where the plaintext character is converted to the same cryptogram symbol, disappeared immediately.  A deeper analysis has shown that a simple, character-based, XOR plaintext with a keyword also does not hold here.  In the end, we managed to find out that the cipher is block, without feedback and gamming.  Block length is 16 bytes. <br><br>  Thus, we had to accept as a hypothesis the use of the <a href="http://ru.wikipedia.org/wiki/RC6">RC6</a> cipher indicated in the message from the creators of the Trojan.  Subsequently, the hypothesis was confirmed, namely, the encryption performed by the RC6 algorithm with a block length of 16 bytes, and it is used ‚Äúvlob‚Äù, according to the flowchart.  The authors of the implementation did not even bother to encrypt incomplete blocks, less than 16 bytes, leaving them as is, unencrypted. <br><br>  So, the algorithm is known.  It remains the case for small: find the key. <br><br><h4>  Stage 2. Key search </h4><br>  To find the key, we first find the body of the malicious program (or what remains of this body).  In the% SYSTEMROOT% \ System32 directory, we find 2 ‚Äúextra‚Äù exe-files: system.exe and another executable file with a random name (H3w2DWg.exe).  Both files are part of a Trojan that infected the system, but none of the files at the time of detection (April 2012) were identified by antivirus as malicious.  At the moment, some antiviruses recognize the Trojan program as Trojan.Encoder.136 (DrWeb) or as Win32 / Filecoder.AF (ESET-NOD32), but most antiviruses at best think that this is just a slightly suspicious file.  Here is a link to <a href="https://www.virustotal.com/file/e52ac505e971d5dc8daa05b7549d056e71a253666fbb0207fe7a9772246de157/analysis/1353492233/">virustotal</a> . <br><br>  Once a trojan is not recognized by antivirus software, it is necessary to dissect it yourself.  Armed with hiew32, OllyDbg and a virtual machine, proceeded with the autopsy.  An autopsy revealed that the Trojan‚Äôs files are not packed, not encrypted, and written in Borland Delphi.  Inside, links to the encrypted files account.cfg, config.cfg, and lock.cfg were also found, also in% SYSTEMROOT% \ System32.  By debugging the exe-files, a key was also found in the form of a string of characters ‚Äú1kv9yha029v9vi71xioa7h812ga811n9‚Äù with a length of 32. With this key, the Trojan decrypted the file lock.cfg. <br>  It remains to understand how this string is converted to the RC6 key.  The length of the RC6 key is from 128 bits and more.  As a first attempt, we will try to convert each character into an 8-bit representation via an ASCII code.  As a result, we get a key of length 32 * 8 = 256 bits.  We write the program in C ++, we give the program a key and lock.cfg file for the input.  We start the decryption process.  Failure.  The file is not decrypted. <br><br>  What are the options?  The longest and most painstaking is to pull out the key generation algorithm by the debugger from the executable file.  Left this option as a last resort because of its excessive complexity.  Instead, we will think a little and put ourselves in the place of the creators of the malicious program.  It is unlikely that the Trojan authors independently implemented the encryption algorithm.  Most likely, the finished implementation of the algorithm on the Delphi was downloaded from the Internet.  It is also unlikely that ready-made compiled libraries were used, the cryptographic algorithm in them would be implemented much better and certainly would not leave unencrypted blocks of less than 16 bytes.  We conclude that the student‚Äôs curriculum was most likely used in the Trojan, the sources of which the attackers had stolen from the Internet. <br><br>  Zalazim in Google and looking for something on the keywords Delphi RC6.  Find the link <a href="http://www.delphi-club.ru/delphi/rc6_encryption.html">http://www.delphi-club.ru/delphi/rc6_encryption.html</a> .  So it is, a module on Delphi, which encrypts a file with blocks without gamming and leaves the last block with a length of less than 16 bytes unencrypted.  From the implementation we take the key generation features, rewrite them in C ++, compile the decryption program.  We feed the program 32-character key, trying to decrypt the file lock.cfg.  Again, failure. <br><br>  There is an option with OllyDbg and the body of the Trojan.  I will not bore with the details of obtaining a secret algorithm, according to which the key was formed, especially since the procedure itself took not so much time.  The secret was simple.  The string of characters with the key was read from the file resources in ASCII (32 characters = 32 bytes), then (apparently by Delphi itself) converted to UTF-16LE ‚Äî 64 bytes were obtained (in practice, the bytes were simply diluted with zeros).  And this result has already been fed to the algorithm for obtaining the key, which is well-known, thanks to the sources on Delphi.  The key length at the output is 512 bits. <br><br>  The received key file lock.cfg was successfully decrypted.  Inside the file, a key was found for the files config.cfg and account.cfg, as well as a list of domain names for blocking through the hosts file and a list of ‚Äúharmful‚Äù processes (antiviruses, firewalls) in the Trojan‚Äôs opinion ‚Äî probably also for blocking. <br><br>  The account.cfg file contained a couple of additional keys (in the same format of a string of 32 characters), an account number on Dnehny@Mail.ru, someone's e-mail address, information about the infected computer and some other small information.  In the config.cfg file, among other things, was the ip-address of the computer, which, by all indications, was the managing server of the malware. <br><br>  However, sadly, none of the keys found in the files were suitable for decrypting files on the disks of an infected computer.  Another statement by the attackers turned out to be true: the key for decrypting files is not really stored on the computer.  The last hope is to shake the key out of the malicious server‚Äôs managing server.  According to a message from the authors of the Trojan, the key is stored there for 7 days, it is during this period that you need to retrieve it, otherwise it will not work to decrypt the files - selecting a 32-character key from a combination of numbers and uppercase and lowercase Latin letters will take decades, and files with valuable documents are needed urgently. <br><br><h4>  Stage 3. In the control center for the key </h4><br>  Before you go to the control center, you need to find out several features of its work, namely: what transport protocol is used to connect to the server, whether the connection is encrypted or not, how the client and server exchange data between themselves.  To address these issues, the most obvious option was to implement the Trojan on a clean system and observe its network exchange with the management server. <br><br>  A clean operating system was installed on the virtual machine, WireShark was launched on the main machine, and a Trojan was launched on the virtual machine.  It turned out that the connection uses an unencrypted connection via TCP port 80. During the initial infection, the computer‚Äôs data (OS, processor, memory) goes to the server, and additional modules of the Trojan are downloaded from the server, as well as the SSLeay dll files, which are then used to work with the site Dengi@Mail.ru. <br><br>  Most likely, when sending computer data to the server, a computer account is created on the server (this was hinted at in a message from the authors, in the section on reinstalling the operating system).  Along with the account, a unique key is presumably created, which subsequently encrypts the data on the hard disk.  This is the key and need to get. <br><br>  When the Trojan is restarted on the infected computer, it also accesses the management server.  At the same time, the Trojan no longer reports data about the computer, but provides the server with a key, which is stored in the account.cfg file.  It is this key that is the identifier of the infected computer and it is with the help of this key that we will receive the key for decrypting files. <br><br>  The exchange with the managing server is carried out in the format: "client's command - server response".  Having rummaged in the depths of the malicious program, I pulled out a list of valid commands: mail, rekey, key, check_pay, get_masks, ssl, winlock and many others.  From WireShark'a learned the format of client commands and parameters.  It's time to experiment.  Logging on to the server using telnet and presenting himself as an infected computer (client_info command with a parameter in the form of a key), entered the key command, in response to which he received a ready-made key to decrypt files. <br><br>  As a result, I added a program in C ++, which decrypts all files on the disk.  The client received back all their files and the desktop in addition. <br><br><h4>  Conclusion </h4><br>  I do not consider myself to be a virus analyst, and I think that in this case, several obvious misses of the intruders helped me on the way to victory.  First, the authors of the malware themselves revealed a lot of important information in their message to the user: the encryption algorithm and the fact that the key is stored on the server.  Secondly, the exchange with the server was carried out through open channels using a fairly simple text protocol - this greatly accelerated the process of obtaining the key.  Third, the authors of the Trojan did not bother too much about protecting their product from decompilation and debugging, which ultimately simplified the analysis of the encryption algorithm and obtaining the key.  Yes, and the general impression: someone just wanted to quickly cut the money, not really worrying about protecting your product from hacking. <br><br>  It is hoped that in the future such malware will not gain wide popularity.  It is better to harmless Vinlockers than such extortionists, thanks to whom you can lose your files forever. </div><p>Source: <a href="https://habr.com/ru/post/159811/">https://habr.com/ru/post/159811/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159799/index.html">Hard drives and spintronics</a></li>
<li><a href="../159801/index.html">Cloud servers from Infobox</a></li>
<li><a href="../159803/index.html">Evil Birds Success Story</a></li>
<li><a href="../159805/index.html">Next week Roskomnadzor‚Äôs ‚Äúblack list‚Äù can be replenished with Twitter and LiveJournal blog hosting sites.</a></li>
<li><a href="../159809/index.html">Microsoft fails?</a></li>
<li><a href="../159813/index.html">New design of the online publication "ToWave"</a></li>
<li><a href="../159815/index.html">Do it yourself: how to make a video at home</a></li>
<li><a href="../159817/index.html">5 reasons why Cisco bought Meraki for $ 1.2 billion</a></li>
<li><a href="../159819/index.html">Simon Marlow leaves Microsoft Research for Facebook</a></li>
<li><a href="../159827/index.html">Microsoft is working on its version of AR-points</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>