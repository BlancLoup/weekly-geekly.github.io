<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DB is not only data storage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Using the database only for data storage is the same as calling the Unix interface for working with files. Therefore, I want to remind you about the w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DB is not only data storage</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/o1/t_/g4/o1t_g4i4iyk2wbbfyv61pq45mfa.png" align="left" height="35%" width="35%">  Using the database only for data storage is the same as calling the Unix interface for working with files.  Therefore, I want to remind you about the well-known and not-so-functioning database functions that I would like to see more often in combat web applications. </p><a name="habracut"></a><br><h2 id="tldr">  tl; dr </h2><br><p>  Below will be about authentication, users, access rights, data integrity, FDW, logging and statistics.  Nothing new. </p><br><h2 id="primechaniya">  Notes </h2><br><ul><li>  I will keep in mind Ruby on Rails and Postgres, but most of the mentions are well portable to other languages ‚Äã‚Äãand DBMS. </li><li>  I will not say anything new, all this has long been described in the documentation and articles.  I just want to remind once again about the tools and where they can be applied to make life a little better. </li></ul><br><h2 id="peerident-autentifikaciya">  Peer / ident authentication </h2><br><p> Absolutely health thing, which almost no one uses.  She maps user Unix user DB.  In the first case, it maps the local user, and in the second, the remote user.  The profit is that you can throw out the host, username and password from the config (and the database name can be thrown out), but everything will work as before.  Plus, it will be more convenient to enter the console for direct debugging (just psql from the terminal instead of all these <code>-h -U -W -d</code> and so on). </p><br><p>  PG documentation about <a href="https://www.postgresql.org/docs/current/static/auth-methods.html">peer</a> and <a href="https://www.postgresql.org/docs/current/static/auth-methods.html">ident</a> . </p><br><p>  Nuances: suitable, if you have not only root and superuser on the server;  in the case of ident, you control the network, the hardware and you are sure that there are no masters and saboteurs there. </p><br><h3 id="primery-ispolzovaniya">  Examples of using </h3><br><p>  Security.  You can not drag off the password from the database and connect to it from the local environment or from somewhere else.  There is no password and there is nothing to drag away. </p><br><p>  Access control.  If there are several access roles on a production or another server and they are already divided at the unix level, then it is convenient to attach database users to them.  In this case, the same code base will connect under different database users.  For example, tech support and developers climb into the same rails console, but for some it is readonly, and for the second it is full-fledged. </p><br><h2 id="prava-dostupa">  Access rights </h2><br><p>  In Unix, everyone thinks about them and looks at work from under root or on <code>'chmod 777'</code> .  But in the database everything is somehow different.  Superuser and go.  Although there is no less (and maybe even more) cool. </p><br><p>  There is a hierarchy of role inheritance (a bit like a group in Unix), there are different levels of access: to specific objects (like file access rights), to specific operators (like rules in <code>sudoers</code> ), even <a href="https://www.postgresql.org/docs/current/static/ddl-rowsecurity.html">to specific strings</a> .  In short, everything is there.  Use. </p><br><h3 id="oblasti-prilozheniya">  Application areas </h3><br><p>  In the minimal version, together with the above-mentioned peer / ident, it is possible to separate the user for migrations / deployments and the user for the daily work of the application.  It, at least, will save from a call <a href="https://en.wikipedia.org/wiki/Data_definition_language">DDL</a> in.  Of course, there are many cases of modifying the database structure "to hot".  This and zero-downtime deploy, and different hotfixes, and rebildy indexes with concurency (and sometimes without).  But, in general, the DDL application should not do. </p><br><p>  Another option: if you have ‚Äúmicroservices‚Äù, but, for some reason, they use the same database, then explicitly sharing access to the database objects is a very good idea.  After all, interaction interfaces should be as localized as possible, and anarchic access to all data contributes to the erosion of logic and responsibility. </p><br><h2 id="ogranichenie-celostnosti">  Integrity constraint </h2><br><p>  Rails 5 has at least started working with reference and data integrity.  But, in general, many developers believe that validation in the model or its surroundings is sufficient to maintain a consistent state of the data.  Alas, this is not the case. </p><br><p>  Validations can be skipped, you can go directly to the database and use sql-i, you can nakosyachit during migration.  In general, a lot of things can be done.  Therefore, everything that business logic relies on must be nailed by the constraints in the database.  This is the only way to preserve the integrity of the data and not get "surprises" at the next Deploy. </p><br><h2 id="foreign-data-wrapper">  Foreign data wrapper </h2><br><p>  This is about connecting one database to another database in order to access the remote tables as if they were their own.  The main profit is that the web application is not involved here at all, but there are a lot of optimizations, when two identical databases work (in general, there are pushdowns for different adapters, but everything is difficult, therefore it is easier to assume that the PG-PG bundle works well, and everything else - as it will). </p><br><h3 id="ispolzovanie-fdw">  Using FDW </h3><br><p>  Instead of configs with the coordinates of several databases in a web application, it is incomparably easier to leave one connection to the database and resolve everything at the level of the database itself.  In the same place, by itself, the question of access rights and choice of objects to which access is needed will be resolved. </p><br><p>  Plus, in the future, you can replace the external table with a materialized view or just a table, but do not change anything in the web application. </p><br><p>  And yet, you can <a href="https://habr.com/post/309126/">connect to the exotic</a> type of MS Access and the problems with restrictions on the use of reports in the models disappear.  After all, if you have 2+ connections, then you will not make a join of two databases at the web application level, although ORM (in particular, ActiveRecord) will honestly try to do it ... and fall off.  And at the database level this can be done, in some cases, almost without an overhead projector. </p><br><h2 id="logirovanie">  Logging </h2><br><p>  About him, almost everyone knows and everyone uses.  But just in case, let me remind you: do not hesitate to log long requests.  Out of the box, in PG, it is off.  You need to poke <code>log_min_duration_statement</code> .  With regards to its value, there are many holivars and, perhaps, they stumble me, but first, put a couple of seconds.  Since if you have a large application, you hardly read it and you know what to do, and if it is small, then you have no time to deal with small brakes and only fatal things bother you. </p><br><p>  Just remember about N + 1.  The DB will not tell you anything about it.  Use third-party tools.  For example, <a href="https://github.com/flyerhzm/bullet">bullet</a> and common sense. </p><br><h2 id="statistika">  Statistics </h2><br><p>  We must remember that she is and that she can die.  At first, everything is fine.  But over time, usually, the following is obtained: the rate of change of data is approximately the same, and the size of the table is increasing.  Consequently, the vacuum / analyze table starts to happen less and less, and at some point the scheduler starts to miss.  At best, the request falls into the above mentioned logging, at worst - you just suffer and do not understand why.  In general, look in <code>pg_stat_user_tables</code> and relate the vacuum / analytic dates to the load on the tables. </p><br><p>  And sometimes you can use statistics for an approximate <code>count</code> .  It rarely comes in handy, but it is pretty accurate, because PG is not Oracle and the <code>count</code> for the entire table is not executed for O (1), although I really want to. </p><br><h2 id="konec">  the end </h2><br><p>  Thanks for reading.  If not difficult, answer the question below.  In the light of a recent article about <a href="https://habr.com/post/422667/">GQL instead of SQL,</a> he began to worry me especially strongly. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/422989/">https://habr.com/ru/post/422989/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422977/index.html">Mikhail Bessmeltsev with a colleague developed new algorithms for graphics vectorization</a></li>
<li><a href="../422979/index.html">American analogue of the GDPR: what you need to know about the act of the CCPA</a></li>
<li><a href="../422981/index.html">The simplest implementation of the Entity Component System</a></li>
<li><a href="../422985/index.html">Quick start a web project (BE - Java Spring, FE - React Redux, interaction - Rest, WebSocket)</a></li>
<li><a href="../422987/index.html">And again the 256th day of the year</a></li>
<li><a href="../422993/index.html">Burnout OLED TVs in real tests</a></li>
<li><a href="../422995/index.html">QA mitap in Redmadrobot</a></li>
<li><a href="../422997/index.html">The book "Modern PHP"</a></li>
<li><a href="../422999/index.html">Create your own dataset with aliens</a></li>
<li><a href="../423003/index.html">Peskov: Roscomnadzor requirements for Facebook are not super complex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>