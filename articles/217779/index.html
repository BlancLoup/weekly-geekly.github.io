<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Emulation of pressing multimedia keys in Windows, Linux and Mac OS X</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the Qt :: Key enumeration, 15 types of media control keys are defined for the QKeyEvent event (see the table at the end of the article). All of the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Emulation of pressing multimedia keys in Windows, Linux and Mac OS X</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1f7/38a/910/1f738a910803f7f4e372d65e8aa28657.jpg"></div><br>  In the Qt :: Key enumeration, 15 types of media control keys are defined for the QKeyEvent event (see the table at the end of the article).  All of them can be used in the event filter (installEventFilter) to handle keystrokes on the multimedia keyboard (allowing you to control the audio device and playback). <br>  The article discusses the inverse problem - sending multimedia control commands to the system by emulating key presses on Windows, Linux and MacOSX (operating systems are ordered by the time spent on finding a solution).  The material presented in the article can be a starting point for further study of the issue of cross-platform event sending to the system message processing cycle. <br><a name="habracut"></a><br>  Before proceeding directly to the description of the source code, let's look at where emulation of multimedia keys can be used at all, for example: <br><ul><li>  creating audio playback control widgets; </li><li>  emulation of user input when testing applications; </li><li>  creating an application for remote audio control.  In this case, the application on the computer acts as a server, and the client is a smartphone.  Such a bundle will allow you to control audio / video without getting up from the couch or, for example, automatically pause playback when an incoming call arrives; </li><li>  creating an application that ‚Äúshares‚Äù the keyboard and mouse on two or more computers over the network (after having added the code to the full set of keys); </li><li>  creation of ‚Äúsmart home‚Äù systems, new man-machine interfaces (voice command control, etc.). </li></ul><br>  Since QEvent allows you to send a message only to a specific object "inside" the application, standard means of Qt will not work to emulate keystrokes.  For this, we will use the Api system calls (in the case of Windows) or the corresponding libraries (the X Window System on Linux and a number of frameworks on Mac OS X). <br>  For convenience of description, we will place almost the entire implementation of sending messages in the <i>sendKeyEventToSystem</i> function <i>(Qt :: Key qtKey)</i> , which is passed the key code from the Qt :: Key enumeration.  This function will be called from slots, for example: <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">playPauseToogle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      postKeyEventToSystem(Qt::Key_MediaTogglePlayPause); }</span></span></code> </pre>  We will separate the platform-dependent code with the <i>#ifdef OS_TYPE</i> and <i>#endif</i> directives <i>(</i> we will <i>move</i> part of the code in Objective-C to a separate file macx.mm, but more on that later). <br><br><h4>  Keyboard emulation on Windows </h4><br>  In this operating system, the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms646310%2528v%3Dvs.85%2529.aspx">SendInput</a> function is responsible for sending messages.  It allows you to send messages with codes, a complete list of which is presented on the MSDN <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd375731%2528v%3Dvs.85%2529.aspx">Virtual-Key Codes</a> page. <br>  To use this feature, you must include the header file &lt;Windows.h&gt;. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> Q_OS_WIN32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WINVER 0x0500 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Windows.h&gt; #endif</span></span></span></span></code> </pre><br>  There are many examples of using this function on the Internet and its use should not cause problems, so I immediately cite the code (in the part of Windows): <br><pre> <code class="cpp hljs">sendKeyEventToSystem(Qt::Key qtKey) { <span class="hljs-comment"><span class="hljs-comment">//   . qtKey -   #ifdef Q_OS_WIN32 INPUT ip; //  ip.type = INPUT_KEYBOARD; ip.ki.wScan = 0; ip.ki.time = 0; ip.ki.dwExtraInfo = 0; //     switch (qtKey) { case Qt::Key_MediaPrevious: ip.ki.wVk = VK_MEDIA_PREV_TRACK; //  break; case Qt::Key_MediaTogglePlayPause: ip.ki.wVk = VK_MEDIA_PLAY_PAUSE; //    break; case Qt::Key_MediaNext: ip.ki.wVk = VK_MEDIA_NEXT_TRACK; //  break; default: return; break; } //    ip.ki.dwFlags = 0; SendInput(1, &amp;ip, sizeof(INPUT)); //    ip.ki.dwFlags = KEYEVENTF_KEYUP; SendInput(1, &amp;ip, sizeof(INPUT)); #endif }</span></span></code> </pre>  Hereinafter, only 3 keys will be used in the examples.  At the end of the article is a table of correspondence codes. <br><br><h4>  Keyboard emulation on Linux </h4><br>  To emulate keys in Linux, in my opinion, the easiest way is to use the libXtst developer library ( <a href="https://packages.debian.org/ru/sid/libxtst-dev">X11 Record extension library</a> ). <br>  To get it from the packages, run the command: <pre> <code class="bash hljs">sudo apt-get install libxtst-dev</code> </pre>  It will also be necessary to connect the library in the project file: <br><pre> <code class="cpp hljs">unix:!macx:LIBS += -lXtst -lX11</code> </pre><br>  At the beginning of the file, we include the necessary header files and define a number of constants corresponding to the codes of multimedia keys (the fact is that there are no codes for multimedia keys in the X11 / keysymdef.h file). <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> Q_OS_LINUX #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;X11/Xlib.h&gt; #include &lt;X11/extensions/XTest.h&gt; #define XF86AudioLowerVolume 0x1008ff11 #define XF86AudioMute 0x1008ff12 #define XF86AudioRaiseVolume 0x1008ff13 #define XF86AudioPlay 0x1008ff14 #define XF86AudioStop 0x1008ff15 #define XF86AudioPrev 0x1008ff16 #define XF86AudioNext 0x1008ff17 #define XF86AudioPause 0x1008ff31 #endif</span></span></span></span></code> </pre><br>  Linux emulation code: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> Q_OS_LINUX unsigned int key; unsigned int keycode; switch (qtKey) { case Qt::Key_MediaPrevious: key = XF86AudioPrev; break; case Qt::Key_MediaTogglePlayPause: key = XF86AudioPlay; break; case Qt::Key_MediaNext: key = XF86AudioNext; break; default: return; break; } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   X Display *display; display = XOpenDisplay(NULL); //    keycode = XKeysymToKeycode(display, key); //    XTestFakeKeyEvent(display, keycode, 1, 0); //    XTestFakeKeyEvent(display, keycode, 0, 0); //   X XFlush(display); //   X XCloseDisplay(display); #endif</span></span></span></span></code> </pre><br><h4>  Keyboard emulation on Mac OS X </h4><br>  Attempts to find a solution for MacOS X did not bear fruit (scant examples were written in Objective-C), until Google came across an article from the Habr <a href="http://habrahabr.ru/post/133700/">Integration of Qt applications into Mac OS X (using Cocoa and Objective-C ++)</a> .  I already came across an English-language article that described how to isolate C ++ code for use in an Objective-C application.  I also needed the exact opposite - to isolate the Objective-C code (which performed the functions I needed, but at the same time the compiler cursed).  Everything turned out to be quite simple: <br>  1. created the macx.mm file and placed the Objective-C code in it (the line automatically appeared in the project file <pre> <code class="cpp hljs">OBJECTIVE_SOURCES += macx.mm</code> </pre> <br>  2. created the macx.h file and placed the function declaration from macx.mm in it (adding #include "macx.h" in macx.mm). <br>  3. In the project file, add the necessary frameworks, in particular: <br><pre> <code class="cpp hljs">macx:LIBS += -framework ApplicationServices -framework IOKit</code> </pre> <br>  4. Inside the macro conditional compilation for Mac OS X added the necessary headers and macx.h. <br>  5. In the switch-case structure already familiar to you, inserted the calls of the new function. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, at the beginning of the file, we had a design for Mac OS X: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> Q_OS_MAC #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ApplicationServices/ApplicationServices.h&gt; //   UInt8 #include &lt;IOKit/hidsystem/ev_keymap.h&gt; //  #include "mac.h" //    Objective-C  #endif</span></span></span></span></code> </pre><br>  The following code is added to the <i>sendKeyEventToSystem</i> function: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> Q_OS_MAC switch (qtKey) { case Qt::Key_MediaPrevious: HIDPostAuxKey( NX_KEYTYPE_PREVIOUS ); break; case Qt::Key_MediaTogglePlayPause: HIDPostAuxKey( NX_KEYTYPE_PLAY ); break; case Qt::Key_MediaNext: HIDPostAuxKey( NX_KEYTYPE_NEXT ); break; default: return; break; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br><br>  Contents of the mac.mm file: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Cocoa/Cocoa.h&gt; #import &lt;IOKit/hidsystem/IOHIDLib.h&gt; #import &lt;IOKit/hidsystem/ev_keymap.h&gt; #include "macx.h" static io_connect_t get_event_driver(void) { static mach_port_t sEventDrvrRef = 0; mach_port_t masterPort, service, iter; kern_return_t kr; if (!sEventDrvrRef) { // Get master device port kr = IOMasterPort( bootstrap_port, &amp;masterPort ); check( KERN_SUCCESS == kr); kr = IOServiceGetMatchingServices( masterPort, IOServiceMatching( kIOHIDSystemClass ), &amp;iter ); check( KERN_SUCCESS == kr); service = IOIteratorNext( iter ); check( service ); kr = IOServiceOpen( service, mach_task_self(), kIOHIDParamConnectType, &amp;sEventDrvrRef ); check( KERN_SUCCESS == kr ); IOObjectRelease( service ); IOObjectRelease( iter ); } return sEventDrvrRef; } void HIDPostAuxKey(const UInt8 auxKeyCode ) { NXEventData event; kern_return_t kr; IOGPoint loc = { 0, 0 }; //     UInt32 evtInfo = auxKeyCode &lt;&lt; 16 | NX_KEYDOWN &lt;&lt; 8; bzero(&amp;event, sizeof(NXEventData)); event.compound.subType = NX_SUBTYPE_AUX_CONTROL_BUTTONS; event.compound.misc.L[0] = evtInfo; kr = IOHIDPostEvent( get_event_driver(), NX_SYSDEFINED, loc, &amp;event, kNXEventDataVersion, 0, FALSE ); check( KERN_SUCCESS == kr ); //     evtInfo = auxKeyCode &lt;&lt; 16 | NX_KEYUP &lt;&lt; 8; bzero(&amp;event, sizeof(NXEventData)); event.compound.subType = NX_SUBTYPE_AUX_CONTROL_BUTTONS; event.compound.misc.L[0] = evtInfo; kr = IOHIDPostEvent( get_event_driver(), NX_SYSDEFINED, loc, &amp;event, kNXEventDataVersion, 0, FALSE ); check( KERN_SUCCESS == kr ); }</span></span></span></span></code> </pre><br><h5>  Conclusion: </h5><br>  It was a bit strange for me that there is still no openly accessible cross-platform library that allows you to send messages (including keyboard events, mouse events, etc.).  In any case, I could not find such a library.  The presented code is far from perfect (imagine how the switch-case sequence grows when new keys are added).  Nevertheless, let it be a small contribution to the common pool of knowledge about writing cross-platform applications. <br>  During the work on the article, it was noticed that VirtualBox <a href="https://www.virtualbox.org/ticket/4263">intercepts pressing of multimedia keys</a> (tested on Ubuntu - everything worked with c hardware).  This flaw is deprived of WMWare (tested on Mac OS X). <br><br>  Appendix: List of multimedia keys and their definitions (using #define). <br><br><table><tbody><tr><th>  Qt :: Key </th><th>  Windows </th><th>  Linux </th><th>  Mac os x </th></tr><tr><td>  Qt :: Key_VolumeDown </td><td>  VK_VOLUME_DOWN </td><td>  XF86AudioLowerVolume </td><td>  NX_KEYTYPE_SOUND_DOWN </td></tr><tr><td>  Qt :: Key_VolumeMute </td><td>  VK_VOLUME_MUTE </td><td>  XF86AudioMute </td><td>  NX_KEYTYPE_MUTE </td></tr><tr><td>  Qt :: Key_VolumeUp </td><td>  VK_VOLUME_UP </td><td>  XF86AudioRaiseVolume </td><td>  NX_KEYTYPE_SOUND_UP </td></tr><tr><td>  Qt :: Key_BassBoost </td><td></td><td></td><td></td></tr><tr><td>  Qt :: Key_BassUp </td><td></td><td></td><td></td></tr><tr><td>  Qt :: Key_BassDown </td><td></td><td></td><td></td></tr><tr><td>  Qt :: Key_TrebleUp </td><td></td><td></td><td></td></tr><tr><td>  Qt :: Key_TrebleDown </td><td></td><td></td><td></td></tr><tr><td>  Qt :: Key_MediaPlay </td><td>  VK_MEDIA_PLAY_PAUSE </td><td>  XF86AudioPlay </td><td>  NX_KEYTYPE_PLAY </td></tr><tr><td>  Qt :: Key_MediaStop </td><td>  VK_MEDIA_STOP </td><td>  XF86AudioStop </td><td></td></tr><tr><td>  Qt :: Key_MediaPrevious </td><td>  VK_MEDIA_PREV_TRACK </td><td>  XF86AudioPrev </td><td>  NX_KEYTYPE_PREVIOUS </td></tr><tr><td>  Qt :: Key_MediaNext </td><td>  VK_MEDIA_NEXT_TRACK </td><td>  XF86AudioNext </td><td>  NX_KEYTYPE_NEXT </td></tr><tr><td>  Qt :: Key_MediaRecord </td><td></td><td></td><td></td></tr><tr><td>  Qt :: Key_MediaPause </td><td></td><td>  XF86AudioPause </td><td></td></tr><tr><td>  Qt :: Key_MediaTogglePlayPause </td><td>  VK_MEDIA_PLAY_PAUSE </td><td>  XF86AudioPlay </td><td>  NX_KEYTYPE_PLAY </td></tr></tbody></table><br>  Related Links: <br>  1. Existing approaches to problem solving: <a href="http://stackoverflow.com/questions/9409011/c-qt-cross-platform-library-for-simulating-keyboard-input-sendkeys-send-ke">C ++ (Qt) cross-platform library for simulating keyboard input, sendkeys, send kestrokes, etc</a> <br>  2. Description of the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms646310%2528v%3Dvs.85%2529.aspx">SendInput</a> function and the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd375731%2528v%3Dvs.85%2529.aspx">list of keyboard codes</a> on the MSDN website. <br>  3. <a href="https://shanetully.com/2012/07/simulating-mediakey-presses-in-x11/">Simulating Mediakey Presses in C &amp; X11</a> - this article describes how in Linux using the utility "xev" (in Ubuntu: "sudo apt-get install x11-utils"), you can learn the key codes, as well as in addition to the <a href="https://wiki.archlinux.org/index.php/Extra_Keyboard_Keys">article with archlinux .org</a> . <br>  4. Emulation of multimedia keys <a href="http://stackoverflow.com/questions/11045814/emulate-media-key-press-on-mac">on MacOS X in the Python programming language</a> . </div><p>Source: <a href="https://habr.com/ru/post/217779/">https://habr.com/ru/post/217779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217765/index.html">Smart home control panel. iphone in the wall</a></li>
<li><a href="../217767/index.html">Who is better: compare 5 popular credit cards</a></li>
<li><a href="../217769/index.html">The history of the Eiffel Tower and ... "Descriptive Geometry"</a></li>
<li><a href="../217771/index.html">How to minimize setting for content site</a></li>
<li><a href="../217775/index.html">Cosmos Facts Hard to Believe</a></li>
<li><a href="../217783/index.html">How we learned to read the thoughts of system administrators</a></li>
<li><a href="../217789/index.html">Voice control media center</a></li>
<li><a href="../217791/index.html">Updateable multi-user macro</a></li>
<li><a href="../217797/index.html">Half-life 3 will be released in the fall of 2014</a></li>
<li><a href="../217799/index.html">How to reduce the cost of a virtual data center with a USB flash drive</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>