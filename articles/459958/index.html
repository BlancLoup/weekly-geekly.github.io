<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parsing tasks from the Hydra conference - load balancing and in-memory storage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few days ago there was a Hydra conference . The guys from the JUG.ru Group invited dream speakers (Leslie Lamport! Cliff Click! Martin Kleppmann!) A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parsing tasks from the Hydra conference - load balancing and in-memory storage</h1><div class="post__text post__text-html js-mediator-article"><p>  A few days ago there was a <a href="https://hydraconf.com/">Hydra conference</a> .  The guys from the JUG.ru Group invited dream speakers (Leslie Lamport! Cliff Click! Martin Kleppmann!) And dedicated two days to distributed systems and computing.  The contour was one of the three partners of the conference.  We talked on the stand, talked about our distributed storage, played bingo, solved puzzles. </p><br><p>  This is a post with an analysis of tasks on the Contour stand from the author of their text.  Who was on the Hydra is your reason to remember pleasant impressions, who was not - a chance to stretch your brains with a <em>big O-</em> notation. </p><br><p>  There were even participants who disassembled a flipchart on the slides to record their decision.  I am not joking - they handed over for checking just such a stack of paper: </p><br><p><img src="https://habrastorage.org/webt/6k/m8/59/6km859kxtxuu_21czx2sn-l5do0.jpeg"></p><br><p>  In total there were three tasks: </p><br><ul><li>  about choosing replicas on weights for load balancing </li><li>  about sorting query results to in-memory database </li><li>  on state transfer in a distributed system with ring topology </li></ul><a name="habracut"></a><br><h1 id="zadacha-1-clusterclient">  Task 1. ClusterClient </h1><br><p>  It was necessary to propose an algorithm for effectively choosing K from N weighted replicas of the distributed system: </p><br><blockquote>  There is a massively distributed cluster of N nodes.  Metadata associated with nodes (eg, their latencies, 4xx / 5xx response rates, etc.).  If you are not selected, you must be able to choose the right way to choose a node. <br><br>  Propose an algorithm to select nodes efficiently.  Estimate its computational complexity using big O notation. </blockquote><br><div class="spoiler">  <b class="spoiler_title">Why is everything in English?</b> <div class="spoiler_text"><p>  Because in such a way the participants of the conference struggled with them and because English was the official language of Hydra.  Tasks looked like this: </p><br><p><img src="https://habrastorage.org/webt/to/5s/0a/to5s0amsnoyj1q_hxhl0z3gczzy.png"></p></div></div><br><p>  Take a paper and a pencil, think, do not rush to immediately open spoilers :) </p><br><div class="spoiler">  <b class="spoiler_title">Analysis of the solution (video)</b> <div class="spoiler_text"><p>  Beginning at 5:53, just 4 minutes: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HAiQ2llS0bE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  But how the guys with the flipchart pitch their decision: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/U_yfKDwXppg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><div class="spoiler">  <b class="spoiler_title">Analysis of the solution (text)</b> <div class="spoiler_text"><p>  There is such a solution on the surface: sum up the weights of all the replicas, generate a random number from 0 to the sum of all weights, then choose an i-replica such that the sum of the replica weights from 0 to (i-1) -th is less than the random number, and the sum of the replica weights from 0 to i-th is greater than him.  So it turns out to choose one replica, and to select the next one, you need to repeat the whole procedure, without considering the selected replica.  With this algorithm, the complexity of choosing one replica is O (N), the complexity of choosing K replicas is O (N ¬∑ K) ~ O (N <sup>2</sup> ). </p><br><p><img src="https://habrastorage.org/webt/cq/1w/hg/cq1whgt1skw7dcwo3ck7wh6rbto.png"></p><br><p>  Quadratic complexity is bad, but it can be improved.  For this, we construct a segment <a href="http://brestprog.by/topics/segmenttree/">tree</a> for the weights sums.  You will get a tree with a depth of lg N, in the leaves of which there will be replica weights, and in the rest of the nodes - partial sums, up to the sum of all weights in the root of the tree.  Next, we generate a random number from 0 to the sum of all weights, find the i-th replica, remove it from the tree and repeat the procedure to find the remaining replicas.  With this algorithm, the complexity of building a tree is O (N), the complexity of finding the i-th replica and removing it from the tree is O (lg N), the complexity of choosing K replicas is O (N + K lg N) ~ O (N lg N) . </p><br><p><img src="https://habrastorage.org/webt/u-/23/tx/u-23txhrw-1dl14qilobw3laro4.png"></p><br><p>  Linear-logarithmic complexity is more pleasant than quadratic, especially for large K. </p><br><p>  This algorithm is <a href="">implemented in the code of</a> the ClusterClient library from the <a href="https://tech.kontur.ru/vostok">Vostok</a> project.  (There the tree is built as O (N lg N), but this does not affect the final complexity of the algorithm.) </p></div></div><br><h1 id="zadacha-2-zebra">  Task 2. Zebra </h1><br><p>  It was necessary to propose an algorithm for efficient sorting of documents in memory by an arbitrary non-indexed field: </p><br><blockquote>  Your team is tasked with in-memory document database.  If necessary, you can select the number of fields for a sample of the number of M (usually N &lt;100 &lt;&lt; M).  A bit less common workload after skipping top documents (S ~ N). <br><br>  Propose an algorithm to execute such queries efficiently.  Estimate of computational complexity of scenarios. </blockquote><br><div class="spoiler">  <b class="spoiler_title">Analysis of the solution (video)</b> <div class="spoiler_text"><p>  Beginning at 34:50, just 6 minutes: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HAiQ2llS0bE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><div class="spoiler">  <b class="spoiler_title">Analysis of the solution (text)</b> <div class="spoiler_text"><p>  Surface solution: sort all documents (for example, using <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D1%258B%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D1%258F_%25D1%2581%25D0%25BE%25D1%2580%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0">quicksort</a> ), then take N + S documents.  In this case, the complexity of sorting is on average O (M lg M), at worst - O (M <sup>2</sup> ). </p><br><p>  It is obvious that sorting all M documents in order to take only a small part from them is inefficient.  In order not to sort all documents, the <a href="https://en.wikipedia.org/wiki/Quickselect">quickselect</a> algorithm is <a href="https://en.wikipedia.org/wiki/Quickselect">suitable</a> , which will select the N + S documents you <a href="https://en.wikipedia.org/wiki/Quickselect">need</a> (they can be sorted by any algorithm).  In this case, the complexity will decrease to O (M) on average, and the worst case will remain the same. </p><br><p>  However, you can make it even more efficient - use the <a href="https://stackoverflow.com/questions/30914801/optimal-algorithm-to-return-largest-k-elements-from-an-array-of-infinite-number">binary heap streaming</a> algorithm.  In this case, the first N + S documents are added to the min- or max-heap (depending on the sorting direction), and then each next document is compared with the root of the tree, which contains the minimum or maximum document at the current time, and if necessary is added to the tree .  In this case, the complexity in the worst case, when you have to constantly rebuild the tree - O (M lg M), the complexity on average - O (M), as when using quickselect. </p><br><p>  However, heap streaming is more efficient due to the fact that in practice most of the documents can be discarded without rebuilding the heap, after a single comparison with its root element.  Such sorting is implemented in the Zebra document in-memory database developed and used in the Contour. </p></div></div><br><h1 id="zadacha-3-state-swaps">  Task 3. State swaps </h1><br><p>  It was necessary to propose the most efficient algorithm for the state shift: </p><br><blockquote>  Your team has been tied up with a cluster of N nodes.  The i-th node's state should not be transferred to the first node.  It is supported by the two states exchange atom states atomically.  It is known that a state swap takes M milliseconds.  For every moment. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      How long does it take for all the nodes in a cluster? </blockquote><br><div class="spoiler">  <b class="spoiler_title">Analysis of the solution (text)</b> <div class="spoiler_text"><p>  Surface solution: exchange the states of the first and second element, then the first and third, then the first and fourth, and so on.  After each exchange, the state of one element will be in the desired position.  You have to do O (N) permutations and spend O (N ¬∑ M) time. </p><br><p><img src="https://habrastorage.org/webt/lx/f6/8p/lxf68pgl8xz2tqhhc58r_1m03y4.png"></p><br><p>  Linear time is long, so you can exchange the states of elements in pairs: the first with the second, the third with the fourth, and so on.  After each exchange, the state of each second element will be in the desired position.  You have to do O (lg N) permutations and spend O (M lg N) time. </p><br><p><img src="https://habrastorage.org/webt/mm/5n/jq/mm5njqmglg6ma2nlrkxsd14coeu.png"></p><br><p>  However, the shift can be made even more efficient - not in a linear, but in a constant time.  To do this, the first step is to exchange the state of the first element with the last, the second with the last but one, and so on.  The state of the last element will be in the desired position.  And now you need to exchange the state of the second element with the last, third with the last but one and so on.  After this round of exchanges, the status of all elements will be in the desired position.  A total of O (2M) ~ O (1) permutations will be done. </p><br><p><img src="https://habrastorage.org/webt/ul/gz/os/ulgzosuwmplrlvpyxh_1fh7fndg.png"></p><br><p>  Such a decision would not surprise a mathematician who still remembers that a turn is a composition of two axial symmetries.  By the way, it is trivially generalized for a shift not by one, but by K &lt;N positions.  (Write in the comments exactly how.) </p></div></div><br><p>  Do you like puzzles?  Know other solutions?  Share in the comments. </p><br><p>  And here are some useful links at last: </p><br><ul><li>  learn more about <a href="https://tech.kontur.ru/infra">infrastructure development</a> in Contour </li><li>  look at the records of internal <a href="https://www.youtube.com/playlist%3Flist%3DPLc82OEDeni8TxAybSoENHU-hJ4mRbVQG2">batches with reports</a> on distributed systems </li><li>  watch the cycle of video lectures ‚Äú <a href="https://tech.kontur.ru/algorithms-for-everyone">Unusual algorithms for ordinary people</a> ‚Äù </li><li>  subscribe to our <a href="https://t.me/KonturTech">channel in Telegram</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/459958/">https://habr.com/ru/post/459958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459934/index.html">The digest of interesting materials for the mobile developer # 306 (July 8 - 14)</a></li>
<li><a href="../459936/index.html">9 more tricks to work with Visual Studio</a></li>
<li><a href="../459952/index.html">Some experience with backup & storage</a></li>
<li><a href="../459954/index.html">Why one of the largest IT companies joined CNCF - a fund developing cloud infrastructure</a></li>
<li><a href="../459956/index.html">Implantation in the absence of teeth, as a result of late appeals to the dentist</a></li>
<li><a href="../45996/index.html">Password is not long enough</a></li>
<li><a href="../459964/index.html">8 simple UI techniques to make the design prototype dynamic, without resorting to animation</a></li>
<li><a href="../459968/index.html">What really happened to the missing Malaysian Boeing (part 3/3)</a></li>
<li><a href="../45997/index.html">Benefit from Habr?</a></li>
<li><a href="../459970/index.html">Promise.allSettled</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>