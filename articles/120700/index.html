<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Safe and secure Linux (our response to Chamberlain)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading recent articles on Habr√© on the topic of security of Linux systems, I had a desire to share my point of view on this question. 
 The art...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Safe and secure Linux (our response to Chamberlain)</h1><div class="post__text post__text-html js-mediator-article">  After reading recent articles on Habr√© on the topic of security of Linux systems, I had a desire to share my point of view on this question. <br>  The article as a whole is designed for novice administrators, therefore, it contains obvious things for a good specialist.  Valuable additions and comments are welcome. <br>  I almost won't give excerpts from config files for three reasons: <br><ol><li>  This will lead to an excessive growth of the article. </li><li>  Mana and Google has not been canceled </li><li>  Point 2 is very useful for the development of a specialist. </li></ol><br><br>  So, how to improve the security and reliability of the server (and workstation) based on Linux? <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will divide this task into 3 parts: <br><ol><li>  (Pro) active security assurance - toughening system and daemons settings.  This also includes setting up a firewall. </li><li>  Passive security and reliability monitoring system. </li><li>  Backups </li></ol><br><h6>  Tighter system settings </h6><br><ol><li>  <strong>Disable unused services / daemons</strong> .  Carefully review the list of processes (for example, using the command ps -ef | less) and identify those that you do not need.  Make sure that they are not needed by the system itself.  Disable. </li><li>  If it is possible, <strong>change the standard ports and interfaces</strong> on which the remaining services are listened to and configure additional security restrictions using the services themselves (that is, by editing their configuration files / adding keys to the launch parameters). <br>  I will illustrate with sshd.  Here you need to do the following - change the standard port from the 22nd to any free one, for example, to 6622. Deny access under the root login.  Rigidly set the list of allowed usernames to access.  Allow sshd to listen only on a specific address.  As an option to allow access only by key, but I do not really like it <br>  <b>UPD</b> Keys are unanimously recognized as a great way to access the server, so use them (but do not completely disable the password). <br></li><li>  All services that are used only by the system administrator or by a limited number of people should be available only through a vpn or ssh connection. </li><li>  Wherever it is possible <b>to switch to using an encrypted connection</b> (pop3-&gt; pops3, http-&gt; https, etc.) </li><li> <strong>Iptables</strong> <br>  Setting up a firewall is a very interesting topic that you need to devote to a separate article. <br>  The basic principles are: <br>  The firewall should work on the whitelist principle, that is, everything that is not explicitly allowed is prohibited. <br>  This can be achieved in two ways: <br>  <b>Method number 1</b> <br>  Setting the default firewall policy with the iptables -P INPUT DROP, iptables -P OUTPUT DROP and iptables -P FORWARD DROP commands.  After executing these commands, all incoming, outgoing and transit traffic for which no permit rules have been created will be blocked, so they should be executed with caution. <br>  Before you do anything with iptables, I strongly recommend that you study the excellent <a href="http://www.frozentux.net/iptables-tutorial/iptables-tutorial.html">manual</a> from Oskar Andreasson <br>  When reading it, pay attention to the purpose (action) of the LOG, which allows you to write to the log various data on the packets entering the system.  This greatly helps in the initial writing of the firewall.  I can advise about the following order of firewall settings: <br>  a) Write all the necessary rules <br>  b) Add a logging rule to the end of each chain (it will catch all packets that you did not take into account in the previous rules and write information about them to the system) <br>  c) Enable the firewall <br>  d) Find unaccounted connections in the syslog and add rules for them to the firewall. <br>  Item (d) is repeated until the records in the syslog disappear. <br>  It is clear that you should not mindlessly add everything that appears in the syslog, because the results of unauthorized access attempts will be visible there. <br>  I note that the default policy DROP should be enabled only after the successful completion of item (d) - this ensures that existing services continue their work while debugging the firewall. <br>  Also note one not quite clear for beginners point: <br>  Here is an excerpt from what a standard firewall template should contain. <br> <code>iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT <br> iptables -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT <br></code> <br>  These rules allow inbound and outbound packets that belong to already established sessions. <br>  This works of course only for stateful protocols, in particular for the tcp protocol. <br>  If you do not use these rules, then for each application you will have to write 2 rules - one for the INPUT chain, and the second for OUTPUT. <br>  If we use them, then we can limit ourselves to only one, one that allows the initial connection to be established. <br><br>  <b>Method number 2</b> <br>  At the end of each chain, write a rule that sends all packets to REJECT. <br>  That is, in the standard case you need to add three rules - iptables -A INPUT -j REJECT, iptables -A OUTPUT -j REJECT and iptables -A FORWARD -j REJECT. <br>  As a result of adding these rules, all packages that are not explicitly allowed by the previous rules will be rejected with the message port-unreachable. <br>  Everything else needs to be done in the same way as in method # 1, including adding rules with --state RELATED, ESTABLISHED. <br><br>  Method number 2 is the most ideologically correct and I advise you to use it, but the choice is yours. <br></li><li>  <strong>SELinux</strong> <br>  Very interesting and promising thing.  Restricts access rights to processes anywhere.  Every action that a process is allowed to do must be spelled out in the policy associated with it. <br>  There is another similar system - Apparmor (as far as I know it is used in ubuntu linux). <br>  Honestly, I haven‚Äôt worked closely with both systems yet (so I can‚Äôt give special recommendations), I partially used SELinux in one project, but due to the time pressure I was then, I had to temporarily postpone this task.  Soon I will definitely return to the SELinux setup, because I really liked it. <br></li></ol><br><h6>  Monitoring </h6><br>  Break-ins and accidents are known to be better prevented than to eliminate their consequences. <br>  In this regard, a well-tuned monitoring system is very relevant, which at the first signs of a problem will immediately give a signal to the administrator. <br><ol><li>  <strong>Nagios</strong> <br>  There are several large monitoring systems (nagios, zabbix, cacti, munin). <br>  I tried them all and eventually settled on Nagios.  Very convenient and flexible to set up the system. <br>  A huge number of plugins for monitoring, and if there is no suitable plug-in, you can write your own in any language you like (for example, I use bash and python for this). <br>  At a minimum, you need to set up monitoring of processor load, memory, swap, free disk space, load average.  It is very desirable to monitor the availability of critical services (for example, apache, mysql, nginx, tomcat, etc.). </li><li>  <strong>MRTG / RRD</strong> <br>  The dynamics of changes in various indicators are conveniently viewed on the graphs generated by the MRTG. <br>  MRTG allows you to view in a convenient way the dependence of various system parameters on time. <br>  For example, you can see how the CPU and memory usage change depending on the time of day.  You can draw graphs for almost any indicator - from the processor temperature to the number of queries to the database.  MRTG is an instument, extremely useful for analyzing the state of the system. <br>  MRTG has several limitations and shortcomings that can be circumvented using the RRD utility from the same author. </li><li>  <strong>Smartd + smartmontools</strong> <br>  Allows you to monitor the status of hard drives and detect suspicious readings at an early stage.  Can be integrated into Nagios. <br>  For example, the non-zero value of the variable Reallocated_Sector_Ct indicates that the bad sectors appeared on the disk, and have appeared for a long time because smart learns about the presence of bads only after the factory remap table is full (here I can be a little mistaken, the theory about this for a long time did not update, it is possible that at modern hard drives the bads are immediately visible through smart). <br>  It is possible and necessary to configure the smartd so that all suspicious readings are immediately sent by email to the administrator. </li><li>  <strong>Log analyzers</strong> <br>  It is clear that manually monitoring the system logs for errors is a thankless task. <br>  For this purpose, there have long been many log analyzers. <br>  I advise you to put several systems at once and choose the one that you like more. <br>  You can start with logwatch. </li><li>  <strong>Remote syslog</strong> <br>  What do you think, what is the first goal of an attacker who has penetrated into any system? <br>  The goal is to <strong>hide your presence</strong> . <br>  To do this, he will definitely remove all references to his actions from the system logs (and also try to replace some system utilities, but more on that below). <br>  In order to protect against the negative consequences of deleting logs, it is necessary to organize their recording on a remote server.  It is desirable that ssh access to this server was impossible (you can go through the IP KVM yourself) or be very difficult, otherwise nothing will prevent the hacker from deleting the unmodified copy of the logs stored there.  On the log server itself, it is most convenient to store the logs in any DBMS. <br></li><li>  <strong>HIDS and NIDS</strong> <br>  <strong>HIDS</strong> monitors the state of the system (logs, the integrity of system utilities, etc.) and informs the administrator if a security breach is suspected.  It will help if the attacker from the previous paragraph replaces any system utility in order to hide its presence or to secure access to the system.  For example, you can replace the utilities ps, who, w, last so that the administrator cannot see who is logged in to the system at the moment.  Replace the iptables and sshd utilities so that they allow an attacker to freely enter the system. <br>  HIDS will certainly not be able to prevent such actions, but it will be able to notify the administrator about them. <br>  One example of HIDS is OSSEC. <br><br>  <strong>NIDS</strong> If HIDS monitors the internal state of the system, then NIDS analyzes suspicious network activity (port scanning, password attempts, various attacks against system services, etc.).  The most famous NIDS is Snort. </li></ol><br><br><h6>  Backups </h6><br><ol><li>  As you know, system administrators are divided into those who do not make backups, those who already do them and those who think that they do. <br>  This saying is filled with deep meaning. <br>  Backups may be needed in many cases, for example, after hardware problems with the system, after it has been hacked, after incorrect actions of an administrator or developer. <br>  You can conditionally divide backups into file system backups and database backups. <br>  It is very desirable to have a separate server for storing backups, ideally also located separately from all other equipment.  Separately means at a distance of 5 kilometers, no less. <br><br>  There is a lot of software written for backup, but I prefer to use scripts written by me personally.  So I get full control over the process. <br>  For file system backups, it is easier to use rsync with the appropriate keys.  In most cases, it is more convenient to make an incremental backup. <br>  For database backups, it is best to use the utilities provided by the database vendors, but in the case of mysql I was a little away from this rule. <br>  The standard backup utility, mysqldump, does not behave very well when removing backups, namely, it ‚Äúlocks‚Äù the tables into a record, prohibiting writing them at the time of the backup (although this could be completely avoided in the case of innodb, but mysqldump does not know how do this).  This is very important when using large databases, at least 10-20 GB in size, where table locking can last 10-20 minutes.  In addition, restoring large databases from such a backup takes many hours. <br>  In such a situation it is more reasonable to use the system master-&gt; slave. <br>  On the server, the mysql slave is configured for the database that needs to be backed up.  In the future, backups are no longer removed from the main base, but from its slave.  In the event of an accident, you can not even immediately restore the database, but simply redirect all requests to the slave server, which will greatly save time.  For removing backups from the slave server and for its initial preparation, it is convenient to use the <a href="http://www.percona.com/docs/wiki/percona-xtrabackup:innobackupex:how_to_recipes">Innobackupex</a> utility from the Percona company.  For example, it allows you to make a backup suitable for the subsequent raising of the slave server without stopping the main base (without locking it for writing). <br>  There is another very important point - it is necessary to <b>periodically check backups</b> for their correctness, otherwise you risk at the most inopportune moment to detect empty or broken archives. <br></li></ol><br><br>  It is very important to keep documentation (for example in the wiki) on all servers serviced and not to forget to update it with any changes to the server settings.  Very often there are cases when a system administrator cannot recall the details of setting up a system with which he has not worked for a long time. <br><br>  That's all.  All valuable additions again please express in the comments to the article.  I would very much like to bring the article to the main page so that as many specialists as possible can notice it. <br><br>  PS The article made some edits to the results of discussions in the comments.  Thanks to everyone. </div><p>Source: <a href="https://habr.com/ru/post/120700/">https://habr.com/ru/post/120700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120693/index.html">Virtualize! Virtualization News Digest # 0</a></li>
<li><a href="../120695/index.html">Motorola Droid 3 video has flowed into the network</a></li>
<li><a href="../120696/index.html">IPv6 Day Scalax Cloud Ready</a></li>
<li><a href="../120697/index.html">The life cycle of cryptographic hash algorithms</a></li>
<li><a href="../120698/index.html">SkypeTab - tabs for Linux Skype. Now for any window manager and panel</a></li>
<li><a href="../120701/index.html">The axis of evil: what George W. Bush meant or the star wars in the IT world - ‚Äúthe second coming of Apple‚Äù</a></li>
<li><a href="../120702/index.html">csync2 or how to facilitate the work with the cluster</a></li>
<li><a href="../120703/index.html">Email Marketing Basics</a></li>
<li><a href="../120704/index.html">Smart home: planning and preparing yourself</a></li>
<li><a href="../120706/index.html">Internet sample 1985-1990 (simulator)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>