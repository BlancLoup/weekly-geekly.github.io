<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How smart service SMS handler works (shows only important information)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article contains a description of the internal device of the smart service SMS handler. 
 The application parses incoming SMS messages and shows ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How smart service SMS handler works (shows only important information)</h1><div class="post__text post__text-html js-mediator-article"><p>  This article contains a description of the internal device of the smart service SMS handler. <br>  The application parses incoming SMS messages and shows only important information from them. <br>  Shows beautiful, fast and convenient. </p><br><p>  <strong>1. How it works</strong> </p><br><p>  We register permission to receive and read SMS in the manifest. </p><br><pre><code class="hljs pgsql">&lt;uses-permission android:<span class="hljs-type"><span class="hljs-type">name</span></span>="android.permission.RECEIVE_SMS"/&gt; &lt;uses-permission android:<span class="hljs-type"><span class="hljs-type">name</span></span>="android.permission.READ_SMS"/&gt;`</code> </pre> <a name="habracut"></a><br><p>  In the same place we register <code>receiver</code> <br>  The permission <code>action_sms_received_test</code> needed for testing. <br>  In order not to spend money on real sms during testing, I send Intent with this action from the application and catch it. </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".receivers.SmsReceiver"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:priority</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2147483647"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.provider.Telephony.SMS_RECEIVED"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action_sms_received_test"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.BOOT_COMPLETED"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  The receiver will now receive all incoming messages. </p><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (intent.getAction()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ACTION_SMS_RECEIVED: handleIncomingSms(context, intent); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ACTION_SMS_RECEIVED_TEST: <span class="hljs-comment"><span class="hljs-comment">// do test break; } }</span></span></code> </pre> <br><p>  Now in the <code>handleIncomingSms(context, intent);</code> method <code>handleIncomingSms(context, intent);</code>  you need to figure out what kind of SMS came to us, and decide what to do. <br>  If it is service, we disassemble it, get useful information, and display it in a beautiful way. <br>  How we understand whether it is service or not - I will describe later. </p><br><p>  Roughly, it looks like this </p><br><pre> <code class="hljs vala"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> handleIncomingSms(Context context, Intent intent) { Li(<span class="hljs-string"><span class="hljs-string">"handleIncomingSms"</span></span>); Bundle bundle = intent.getExtras(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bundle == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>[] pdus = (<span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>[]) bundle.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(PDUS); String smsText = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">Object</span></span> pdu : pdus) { final SmsMessage message = SmsMessage.createFromPdu((byte[]) pdu); smsText += message.getMessageBody(); } checkTemplates(context, smsText); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Li(<span class="hljs-string"><span class="hljs-string">"handleIncomingSms - Exception"</span></span>, Log.getStackTraceString(e)); } }</code> </pre> <br><p>  Method <code>checkTemplates();</code> </p><br><pre> <code class="hljs pgsql">private <span class="hljs-type"><span class="hljs-type">void</span></span> checkTemplates(Context context, String smsText) { Li("checkTemplates", smsText); // <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> templates List&lt;SmsTemplate&gt; smsTemplates = DatabaseManager.getSmsTemplates(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (smsTemplates == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } // <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sms <span class="hljs-type"><span class="hljs-type">text</span></span> according <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (SmsTemplate smsTemplate : smsTemplates) { List&lt;String&gt; messageLines = SmsNewParser.getMessageLines(smsTemplate, smsText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (messageLines != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Sender sender = DatabaseManager.getSender(smsTemplate.sender); showPopupDialog(context, messageLines, sender != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? sender.iconUrl : ""); } } }</code> </pre> <br><p>  <code>showPopupDialog</code> method </p><br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void showPopupDialog(Context context, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>&gt; message, <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> iconUrl) { Li(<span class="hljs-string"><span class="hljs-string">"showPopupDialog"</span></span>, message, iconUrl); Intent popupIntent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(context, PopupActivity.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); popupIntent.putExtra(PopupActivity.ICON_URL, iconUrl); popupIntent.putExtra(PopupActivity.MESSAGE_0, message.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)); popupIntent.putExtra(PopupActivity.MESSAGE_1, message.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)); popupIntent.putExtra(PopupActivity.MESSAGE_2, message.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)); popupIntent.putExtra(PopupActivity.MESSAGE_3, message.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>)); popupIntent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK | Intent.FLAG_ACTIVITY_NEW_TASK); context.startActivity(popupIntent); }</code> </pre> <br><p>  After that, the user sees such a screen. <br>  The point is to quickly see useful information. </p><br><p><img src="https://dl.dropboxusercontent.com/u/1816879/captainsms/pictures/screenshots/captain_sms_screenshot_2_small.png" alt="image"></p><br><p>  <strong>2. Algorithm of recognition of SMS and the issuance of important information</strong> </p><br><p>  2.1.  Briefly </p><br><ul><li>  The server has templates </li><li>  Each template indicates a) how SMS should look like b) what exactly to show for it </li><li>  The application synchronizes each time it starts. </li><li>  Each incoming message is run on all templates. </li><li>  If a template is found, to which it corresponds - important information is shown in the required form. </li></ul><br><p>  2.2.  Details about the model </p><br><p>  The template looks like this </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"sender"</span></span>: <span class="hljs-string"><span class="hljs-string">"bank_alfa"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"3*8272; Pokupka; Uspeshno; Summa: 212,30 RUR; Ostatok: 20537,96 RUR; RU/MOSKVA/GETT; 15.04.2016 06:02:43"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mask"</span></span>: <span class="hljs-string"><span class="hljs-string">"~N~*~N4~; ~BANK_ACTION_0~; Uspeshno; Summa: ~SUM_0~ ~CURRENCY_0~; ~BANK_ACTION_1~: ~SUM_1~ ~CURRENCY_1~; ~WORD~; ~N2~.~N2~.~N4~ ~N2~:~N2~:~N2~"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lines"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTRA_PURCHASE"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUM_0"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTRA_TOTAL"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUM_1"</span></span> } ] }</code> </pre> <br><ul><li>  <code>sender</code> - the sender </li><li>  <code>text</code> - the initial text of this SMS.  can be used for tests </li><li>  <code>mask</code> - the template itself.  used official words like <code>~FOO~</code> </li><li>  <code>lines</code> - lines of the message to be displayed on the screen.  They can specify parts of the template, and you can use words that are not in the template. </li></ul><br><p>  Service words are divided into <code>extra</code> and ordinary. <br>  <code>Extra</code> means that they are not in the template. <br>  Examples: </p><br><p>  <code>~SUM~</code> is an ordinary service word.  Indicates an expression with numbers separated by a full stop or comma. <br>  Used to determine the amount of money.  Regex is used to find it. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUM"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"regex"</span></span>: <span class="hljs-string"><span class="hljs-string">"\\d+[.,]{0,1}\\d+"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"values"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"is_extra"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> <br><p>  <code>~CURRENCY~</code> is a common word that can take several meanings.  For its search it is used enumeration of its values </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"CURRENCY"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"regex"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"values"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"usd"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"rur"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"eur"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"rub"</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"is_extra"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> <br><p>  <code>~EXTRA_CODE_WORD~</code> is a service word of type <code>extra</code> .  Used to display the text "Codeword" in the result. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTRA_CODE_WORD"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"regex"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"values"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"is_extra"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre> <br><p>  we also need pictures to show who sent the message. <br>  This information is stored in <code>sender</code> objects. </p><br><p>  Example: <br>  This is Alpha Bank and its icon. </p><br><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">"bank_alfa"</span></span>, icon_url: <span class="hljs-string"><span class="hljs-string">"https://dl.dropboxusercontent.com/u/1816879/CaptainSms/logo_alfa.png"</span></span> }</code> </pre> <br><p>  As a result, no server is stored </p><br><ul><li>  Templates </li><li>  Service words </li><li>  Senders </li></ul><br><p>  Full json can be seen <a href="">here.</a> </p><br><p>  <strong>2.3.</strong>  <strong>Details about the algorithm</strong> </p><br><p>  We download the model, save it. <br>  Then follows the procedure of parsing SMS and the creation of the resulting message. </p><br><p>  To parse the text of a message, I use the <code>SmsParser</code> class with static methods. <br>  The main method is <code>getMessageLines(SmsTemplate smsTemplate, String realSmsText)</code> <br>  It returns message strings if everything is ok, or <code>null</code> if we have not found a suitable template. <br>  This method is called from this place of the <code>checkTemplates</code> method above. </p><br><pre> <code class="hljs pgsql"> // <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sms <span class="hljs-type"><span class="hljs-type">text</span></span> according <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (SmsTemplate smsTemplate : smsTemplates) { List&lt;String&gt; messageLines = SmsNewParser.getMessageLines(smsTemplate, smsText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (messageLines != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Sender sender = DatabaseManager.getSender(smsTemplate.sender); showPopupDialog(context, messageLines, sender != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? sender.iconUrl : ""); } }</code> </pre> <br><p>  We go through all the patterns from the database and try to take the <code>message lines</code> for everyone. <br>  If it works, we show a screen with information. </p><br><p>  Logic <code>getMessageLines</code> briefly <br>  We run by the mask and compare it character by character with the text of the SMS, writing down the values ‚Äã‚Äãof the encountered service words in the array, or throwing out <code>null</code> if there are inconsistencies </p><br><p>  Logic <code>getMessageLines</code> more: </p><br><ul><li>  We run character by character mask </li><li>  If the symbol is the beginning of the service word ( <code>~</code> ), then: <br>  - We understand what this word is (for example, ~ SUM_0 ~) <br>  - Calculate its value in the text SMS (for example, <code>255.00</code> ) <br>  - We cut off this word from the mask, and this value is from the text (in order to continue to run character by character) </li><li>  Otherwise, if it is a simple symbol, then: <br>  - If they coincide in max and text, then we cut them off from there and from there to further compare <br>  - If they are different, then throw out <code>null</code> - the text does not fit the template </li></ul><br><p>  Logic with code examples </p><br><p>  As parameters, the template and sms text come to the method. </p><br><pre> <code class="hljs delphi"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>&gt; getMessageLines(SmsTemplate smsTemplate, <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> smsText)</code> </pre> <br><p>  At the beginning of the method, we initialize the list of service words.  They got to base from regular updating with api. <br>  We need a global variable, since  The method is large and broken apart. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initReservedWords</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Li(<span class="hljs-string"><span class="hljs-string">"initReservedWords"</span></span>); mReservedWords.clear(); mReservedWords = DatabaseManager.getReservedWords(); }</code> </pre> <br><p>  Then create a list of service words from the specified template. </p><br><pre> <code class="hljs pgsql"> List&lt;ReservedWord&gt; reservedWords = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (SmsTemplateLine <span class="hljs-type"><span class="hljs-type">line</span></span> : smsTemplate.lines) { reservedWords.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(getReservedWordByName(<span class="hljs-type"><span class="hljs-type">line</span></span>.line)); }</code> </pre> <br><p>  those.  if we have a pattern </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"sender"</span></span>: <span class="hljs-string"><span class="hljs-string">"bank_alfa"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"3*8272; Pokupka; Uspeshno; Summa: 212,30 RUR; Ostatok: 20537,96 RUR; RU/MOSKVA/GETT; 15.04.2016 06:02:43"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mask"</span></span>: <span class="hljs-string"><span class="hljs-string">"~N~*~N4~; ~BANK_ACTION_0~; Uspeshno; Summa: ~SUM_0~ ~CURRENCY_0~; ~BANK_ACTION_1~: ~SUM_1~ ~CURRENCY_1~; ~WORD~; ~N2~.~N2~.~N4~ ~N2~:~N2~:~N2~"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lines"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTRA_PURCHASE"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUM_0"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTRA_TOTAL"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUM_1"</span></span> } ] }</code> </pre> <br><p>  then we want to get a list </p><br><ul><li>  EXTRA_PURCHASE </li><li>  SUM_0 </li><li>  EXTRA_TOTAL </li><li>  SUM_1 </li></ul><br><p>  further comes the basic logic </p><br><pre> <code class="hljs pgsql"> // <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> match symbol <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> symbol try { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { String s = mask.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s.equals(ReservedWord.SYMBOL)) { // <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> a reserved word ReservedWord currentReservedWord = getFirstReservedWord(mask); String valueOfCurrentReservedWord = getValueOfReservedWord(smsText, mask, currentReservedWord); // <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the list, <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> reserved word <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the list <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reservedWords.contains(currentReservedWord) &amp;&amp; valueOfCurrentReservedWord.length() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>.put(currentReservedWord.getForm(), valueOfCurrentReservedWord); } // cut <span class="hljs-type"><span class="hljs-type">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> mask <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> look next symbols smsText = smsText.substring(valueOfCurrentReservedWord.length()); mask = mask.substring(currentReservedWord.getForm().length()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s.equals(smsText.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>))) { // that symbols matches, go <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the next symbol smsText = smsText.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); mask = mask.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* * that symbol does not match, so text not match that mask, so method fails * because we cannot return correct values according to that list of reserved word */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (mask.length() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); } catch (StringIndexOutOfBoundsException e) { <span class="hljs-comment"><span class="hljs-comment">/* * There is some error during parsing. * That mean text does not match mask. */</span></span> Li(TAG, "getMessageLines - Exception - " + <span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.getStackTraceString(e)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br><p>  It does exactly what is described above, as "The logic of <code>getMessageLines</code> more detailed:" </p><br><p>  Next, we re-sort the list, because  in the text it is found in a different order than our <code>message lines</code> </p><br><pre> <code class="hljs pgsql"> // convert list <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the right <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> List&lt;String&gt; valuesList = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ReservedWord word : reservedWords) { LLog.e(TAG, "getMessageLines - return list - " + <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(word.getForm())); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">values</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(word.getForm()) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { valuesList.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">values</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(word.getForm())); } }</code> </pre> <br><p>  Next, we add <code>extra</code> words like  we did not find them when passing through the text SMS. </p><br><pre> <code class="hljs pgsql"> // <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> the extra words <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; reservedWords.size(); i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reservedWords.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(i).isExtra) { valuesList.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(i, reservedWords.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(i).<span class="hljs-keyword"><span class="hljs-keyword">values</span></span>.iterator().next().<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } }</code> </pre> <br><p>  This is why this is why. <br>  At the entrance we were given <code>smsTemplate</code> .  He has a set of messageLines.  For example, there were 4 of them. </p><br><pre> <code class="hljs objectivec"> <span class="hljs-string"><span class="hljs-string">"lines"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTRA_PURCHASE"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUM_0"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTRA_TOTAL"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUM_1"</span></span> } ] }</code> </pre> <br><p>  But in the process of checking the text for a match with the template, we found only <code>SUM_0</code> and <code>SUM_1</code> <br>  Since  This data, which really is in the text of SMS. <br>  Thus, after the first piece of logic, we have an array of two elements (in this case, <code>212,30</code> and <code>20537,96</code> ). <br>  But at the output we need to submit 4 lines (to these two we need to add <code>EXTRA_PURCHASE</code> and <code>EXTRA_TOTAL</code> ), and in the necessary order. <br>  Therefore, at the end of the method we add them. </p><br><p>  As a result, at the output we get an array of four lines. </p><br><p>  For example, if we had a pattern </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"sender"</span></span>: <span class="hljs-string"><span class="hljs-string">"bank_alfa"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"3*8272; Pokupka; Uspeshno; Summa: 212,30 RUR; Ostatok: 20537,96 RUR; RU/MOSKVA/GETT; 15.04.2016 06:02:43"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mask"</span></span>: <span class="hljs-string"><span class="hljs-string">"~N~*~N4~; ~BANK_ACTION_0~; Uspeshno; Summa: ~SUM_0~ ~CURRENCY_0~; ~BANK_ACTION_1~: ~SUM_1~ ~CURRENCY_1~; ~WORD~; ~N2~.~N2~.~N4~ ~N2~:~N2~:~N2~"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lines"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTRA_PURCHASE"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUM_0"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTRA_TOTAL"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUM_1"</span></span> } ] }</code> </pre> <br><p>  then at the output we get </p><br><ul><li>  Purchase </li><li>  212.30 </li><li>  Left </li><li>  20537.96 </li></ul><br><p>  This is where the main logic ends. <br>  Then we just show it in our pop-up activ by this method. </p><br><pre> <code class="hljs lisp">showPopupDialog(<span class="hljs-name"><span class="hljs-name">context</span></span>, messageLines, sender != null ? sender.iconUrl : <span class="hljs-string"><span class="hljs-string">""</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  The text <code>messageLines</code> simply displayed in the text of the views. <br>  <code>iconUrl</code> loaded into the image view using <a href="https://github.com/bumptech/glide">Glide</a> - everything is extremely simple. </p><br><p>  Conclusion </p><br><p>  Obviously, the algorithm is primitive and can be improved. <br>  Of ideas </p><br><ul><li>  split api into different json files (for example, one json for each sender) </li><li>  clever algorithm for running on patterns (first, all with codes - they are needed most quickly, then frequently used, then all the others) </li><li>  You can probably improve the parsing code itself (check for creating unnecessary objects, reduce the number of loops, etc.) </li></ul><br><p>  But the assigned task solves. </p><br><p><img src="https://habrastorage.org/files/f55/02c/f07/f5502cf07d5142028217192bfcb6e68e.png" alt="image"></p><br><p>  I attach the <a href="">main class</a> for parsing messages. <br>  It is slightly different from the code above, <br>  because  The code above has been improved visually. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/303990/">https://habr.com/ru/post/303990/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303976/index.html">Rust game development. Ecosystem overview</a></li>
<li><a href="../303978/index.html">18 free photo stocks that will save your ad</a></li>
<li><a href="../303984/index.html">Disadvantages of pure functional programming</a></li>
<li><a href="../303986/index.html">PSReadLine install syntax highlighting in PowerShell console</a></li>
<li><a href="../303988/index.html">A compilation of lessons for a novice JavaScript game developer.</a></li>
<li><a href="../303994/index.html">Why is it sometimes better to buy a ready-made software product than to develop your</a></li>
<li><a href="../303998/index.html">Create your tags in RSpec tests</a></li>
<li><a href="../304000/index.html">Vidom - blazingly fast alternative to React</a></li>
<li><a href="../304004/index.html">‚ÄúWhy did I quit algorithmic trading for web startups?‚Äù: The story of a US developer</a></li>
<li><a href="../304008/index.html">Installing Firebird on D-Link DNS-325</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>