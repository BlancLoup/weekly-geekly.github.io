<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Django and time zones</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are several ordinary things that from time to time spoil the blood of our brother: cases, numerals and time zones, with a damned transition to s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Django and time zones</h1><div class="post__text post__text-html js-mediator-article">  There are several ordinary things that from time to time spoil the blood of our brother: cases, numerals and time zones, with a damned transition to summer / winter time.  Involuntarily you will envy the Chinese who have only one time zone for the whole country, and there are no trace of cases.  It will be quite good to once and for all deal with time zones and transformations between them, at least for Django applications. <br><a name="habracut"></a><br>  In Python itself, this is not bad, there is an excellent pytz module, and the built-in datetime object works correctly with time zones.  Things are easy - to implement a convenient strapping.  The first thing that comes to mind is to write a localtime template filter and call it like this: <br><br><blockquote><code><font color="#BC7A00">{{</font> <font color="#19177C">comment.time_added</font> <font color="#666666">|</font> <font color="#0000FF">localtime</font> <font color="#BC7A00">}}</font>  <br> <font color="#BC7A00">{{</font> <font color="#19177C">comment.time_added</font> <font color="#666666">|</font> <font color="#0000FF">localtime</font> <font color="#666666">|</font> <font color="#0000FF">date</font> <font color="#BA2121">:"dmY"</font> <font color="#BC7A00">}}</font> <br></code> </blockquote><br>  But immediately a couple of problems arise.  First, the filter function does not take context, and therefore will not be able to determine to which time zone to bring time.  Secondly, the current time zone can be understood in different ways: taken from the settings of the current user, determined by the selected city or by IP.  Those.  what is now a local time zone depends on the application and, accordingly, such a filter will need to be constantly rewritten.  And thirdly, all these parameters need to be passed into the context. <br><br>  The first problem is solved by using the tag instead of the filter (it can get the context), though it will not look so beautiful: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><font color="#BC7A00">{%</font> <font color="#008000"><strong>localtime</strong></font> <font color="#19177C">comment.time_added</font> <font color="#BC7A00">%}</font>  <br> <font color="#BC7A00">{%</font> <font color="#008000"><strong>localtime</strong></font> <font color="#19177C">comment.time_added</font> <font color="#008000"><strong>as</strong></font> <font color="#19177C">time_added</font> <font color="#BC7A00">%}{{</font> <font color="#19177C">time_added</font> <font color="#666666">|</font> <font color="#0000FF">date</font> <font color="#BA2121">:"dmY"</font> <font color="#BC7A00">}}</font> <br></code> </blockquote><br>  Especially risky and impatient connoisseurs of beauty can use the <a href="http://code.djangoproject.com/ticket/12116">patch</a> , it just allows you to transfer the context to the filter. <br><br>  There are troubles with the context, you can write <a href="http://docs.djangoproject.com/en/dev/ref/templates/api/">your context processor</a> , and you can use the standard <a href="http://docs.djangoproject.com/en/dev/ref/templates/api/">django.core.context_processors.request</a> and fill its timezone property with the help of Middleware: <br><br><blockquote> <code><font color="#008000"><strong>class</strong></font> <font color="#0000FF"><strong>TimezoneMiddleware</strong></font> ( <font color="#008000">object</font> ): <br> <font color="#BA2121"><em>""" <br>   request  timezone <br> """</em></font> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">process_request</font> ( <font color="#008000">self</font> , request): <br> <font color="#008000"><strong>assert</strong></font> <font color="#008000">hasattr</font> (request, <font color="#BA2121">'session'</font> ), <font color="#BA2121">"*.TimezoneMiddleware requires session middleware to be installed."</font> <br> request <font color="#666666">.</font> timezone <font color="#666666">=</font> get_timezone(request) <br> request <font color="#666666">.</font> session[ <font color="#BA2121">'timezone'</font> ] <font color="#666666">=</font> request <font color="#666666">.</font> timezone <br> <font color="#008000"><strong>return</strong></font> <font color="#008000">None</font> <br></code> </blockquote><br>  Dependence on the session middleware can be removed if you are not going to cache the time zone in the session.  The <code>get_timezone()</code> function will depend on the application and may look like this: <br><br><blockquote> <code><font color="#008000"><strong>def</strong></font> <font color="#0000FF">get_timezone</font> (request): <br> <font color="#408080"><em>#   </em></font> <br> <font color="#008000"><strong>if</strong></font> <font color="#008000">hasattr</font> (request, <font color="#BA2121">'user'</font> ) <font color="#AA22FF"><strong>and</strong></font> request <font color="#666666">.</font> user <font color="#666666">.</font> is_authenticated(): <br> profile <font color="#666666">=</font> request <font color="#666666">.</font> user <font color="#666666">.</font> get_profile() <br> <font color="#008000"><strong>if</strong></font> profile <font color="#666666">.</font> timezone: <br> <font color="#008000"><strong>return</strong></font> profile <font color="#666666">.</font> timezone <br> <br> <font color="#408080"><em>#   </em></font> <br> <font color="#008000"><strong>if</strong></font> request <font color="#666666">.</font> session <font color="#666666">.</font> has_key( <font color="#BA2121">'timezone'</font> ): <br> <font color="#008000"><strong>return</strong></font> request <font color="#666666">.</font> session[ <font color="#BA2121">'timezone'</font> ] <br> <br> <font color="#408080"><em>#    IP,      </em></font> <br> city_id <font color="#666666">=</font> ip_to_city_id(request <font color="#666666">.</font> META[ <font color="#BA2121">'REMOTE_ADDR'</font> ]) <br> <font color="#008000"><strong>if</strong></font> city_id: <br> <font color="#008000"><strong>try</strong></font> : <br> city <font color="#666666">=</font> City <font color="#666666">.</font> objects <font color="#666666">.</font> get(pk <font color="#666666">=</font> city_id) <br> <font color="#008000"><strong>if</strong></font> city <font color="#666666">.</font> timezone: <br> <font color="#008000"><strong>return</strong></font> city <font color="#666666">.</font> timezone <br> <font color="#008000"><strong>except</strong></font> City <font color="#666666">.</font> DoesNotExist: <br> <font color="#008000"><strong>pass</strong></font> <br> <br> <font color="#408080"><em>#      </em></font> <br> <font color="#008000"><strong>return</strong></font> pytz <font color="#666666">.</font> timezone(settings <font color="#666666">.</font> FALLBACK_TIMEZONE) <br></code> </blockquote><br>  Actually, it would be possible to give the code for the tag and the template filter and it will round out, but a professionally lazy programmer, like me, decides that writing a tag or a localtime filter is troublesome every time, plus when issuing forms you need to manually convert the time in the fields there and back, plus in the absence of the request context (sending letters by crown, for example) it will not work without additional gestures, plus you need to be constantly alert when working in views - the calendar with events may look different for different time zones.  Well, hardworking guys can take the filter code in the example to the above patch and be like this, let the rest be ready for a little witchcraft. <br><br>  Obviously, if we want dates and times to be automatically transferred to the current time zone, then we really can't do without some magic.  All the data from the models we get through their fields is excellent, transforming the time after sampling and before inserting you can get the desired effect.  However, the fields do not know anything about the context of the template, or about the request object, they may not exist at all.  Obviously, an active time zone must be global.  You can see how a similar situation is resolved in django.utils.translation and implement the same for time zones: <br><br><blockquote> <code><font color="#008000"><strong>import</strong></font> <font color="#0000FF"><strong>pytz</strong></font> <br> <font color="#008000"><strong>from</strong></font> <font color="#0000FF"><strong>django.utils.thread_support</strong></font> <font color="#008000"><strong>import</strong></font> currentThread <br> <br> _active <font color="#666666">=</font> {} <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">default_timezone</font> (): <br> <font color="#BA2121"><em>""" <br>    . <br>        <br> """</em></font> <br> <font color="#008000"><strong>from</strong></font> <font color="#0000FF"><strong>django.conf</strong></font> <font color="#008000"><strong>import</strong></font> settings <br> _default_timezone <font color="#666666">=</font> pytz <font color="#666666">.</font> timezone(settings <font color="#666666">.</font> TIME_ZONE) <br> <font color="#008000"><strong>global</strong></font> default_timezone <br> default_timezone <font color="#666666">=</font> <font color="#008000"><strong>lambda</strong></font> : _default_timezone <br> <font color="#008000"><strong>return</strong></font> _default_timezone <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">activate</font> (tz): <br> <font color="#008000"><strong>if</strong></font> <font color="#008000">isinstance</font> (tz, pytz <font color="#666666">.</font> tzinfo <font color="#666666">.</font> BaseTzInfo): <br> _active[currentThread()] <font color="#666666">=</font> tz <br> <font color="#008000"><strong>else</strong></font> : <br> _active[currentThread()] <font color="#666666">=</font> pytz <font color="#666666">.</font> timezone(tz) <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">deactivate</font> (): <br> <font color="#008000"><strong>global</strong></font> _active <br> <font color="#008000"><strong>if</strong></font> currentThread() <font color="#AA22FF"><strong>in</strong></font> _active: <br> <font color="#008000"><strong>del</strong></font> _active[currentThread()] <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">get_timezone</font> (): <br> tz <font color="#666666">=</font> _active <font color="#666666">.</font> get(currentThread(), <font color="#008000">None</font> ) <br> <font color="#008000"><strong>if</strong></font> tz <font color="#AA22FF"><strong>is</strong></font> <font color="#AA22FF"><strong>not</strong></font> <font color="#008000">None</font> : <br> <font color="#008000"><strong>return</strong></font> tz <br> <font color="#008000"><strong>return</strong></font> default_timezone() <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">to_active</font> (dt): <br> tz <font color="#666666">=</font> get_timezone() <br> <font color="#008000"><strong>if</strong></font> dt <font color="#666666">.</font> tzinfo <font color="#AA22FF"><strong>is</strong></font> <font color="#008000">None</font> : <br> dt <font color="#666666">=</font> default_timezone() <font color="#666666">.</font> localize(dt) <br> <font color="#008000"><strong>return</strong></font> dt <font color="#666666">.</font> astimezone(tz) <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">to_default</font> (dt): <br> <font color="#008000"><strong>if</strong></font> dt <font color="#666666">.</font> tzinfo <font color="#AA22FF"><strong>is</strong></font> <font color="#008000">None</font> : <br> <font color="#008000"><strong>return</strong></font> default_timezone() <font color="#666666">.</font> localize(dt) <br> <font color="#008000"><strong>else</strong></font> : <br> <font color="#008000"><strong>return</strong></font> dt <font color="#666666">.</font> astimezone(default_timezone()) <br></code> </blockquote><br>  The <code>activate()</code> function sets the current time zone, <code>deactivate()</code> returns the default belt.  <code>to_default()</code> and <code>to_active()</code> convert the time to the server belt or current.  It remains to write your own model field: <br><br><blockquote> <code><font color="#008000"><strong>class</strong></font> <font color="#0000FF"><strong>TimezoneDateTimeField</strong></font> (models <font color="#666666">.</font> DateTimeField): <br> __metaclass__ <font color="#666666">=</font> models <font color="#666666">.</font> SubfieldBase <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">_to_python</font> ( <font color="#008000">self</font> , value): <br> <font color="#BA2121"><em>""" <br>       datetime <br> """</em></font> <br> <font color="#008000"><strong>return</strong></font> <font color="#008000">super</font> (TimezoneDateTimeField, <font color="#008000">self</font> ) <font color="#666666">.</font> to_python(value) <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">to_python</font> ( <font color="#008000">self</font> , value): <br> <font color="#BA2121"><em>""" <br>      datetime. <br>         <br> """</em></font> <br> <font color="#008000"><strong>if</strong></font> value <font color="#AA22FF"><strong>is</strong></font> <font color="#008000">None</font> : <br> <font color="#008000"><strong>return</strong></font> value <br> <font color="#008000"><strong>return</strong></font> timezone <font color="#666666">.</font> to_active( <font color="#008000">self</font> <font color="#666666">.</font> _to_python(value)) <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">get_db_prep_value</font> ( <font color="#008000">self</font> , value): <br> <font color="#BA2121"><em>""" <br>         <br> """</em></font> <br> <font color="#008000"><strong>if</strong></font> value <font color="#AA22FF"><strong>is</strong></font> <font color="#AA22FF"><strong>not</strong></font> <font color="#008000">None</font> : <br> value <font color="#666666">=</font> timezone <font color="#666666">.</font> to_default( <font color="#008000">self</font> <font color="#666666">.</font> _to_python(value)) <br> <font color="#008000"><strong>return</strong></font> connection <font color="#666666">.</font> ops <font color="#666666">.</font> value_to_db_datetime(value) <br></code> </blockquote><br>  And set the active time zone for each request, for example, by adding <code>TimezoneMiddleware</code> : <br><br><blockquote> <code><font color="#008000"><strong>class</strong></font> <font color="#0000FF"><strong>TimezoneMiddleware</strong></font> ( <font color="#008000">object</font> ): <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">process_request</font> ( <font color="#008000">self</font> , request): <br> <font color="#666666">...</font> <br> timezone <font color="#666666">.</font> activate(request <font color="#666666">.</font> timezone) <br> <font color="#008000"><strong>return</strong></font> <font color="#008000">None</font> <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">process_response</font> ( <font color="#008000">self</font> , request, response): <br> timezone <font color="#666666">.</font> deactivate() <br> <font color="#008000"><strong>return</strong></font> response <br></code> </blockquote><br>  Done, just replace the standard <code>DateTimeField</code> with our field and time is magically transformed everywhere: in templates, in forms, and in the admin panel.  Of course, there is no limit to perfection, you can implement your own form field for hanging the active time zone for the time received from the user, you can write a filter for those cases when third-party applications are used and their models are not with our fields.  What I did in one project <a href="http://www.gdesneg.ru/">about the ski vacation</a> , for which all this code was written. <br><br>  I hope everyone who has read this far has received either practical benefits or aesthetic pleasure, which, I believe, is familiar to many who write on Django. <br><br>  <b>PS</b> In the recently released Django 1.2, the interface of the model fields has changed, therefore, the given code for <code>TimezoneDateTimeField</code> will need to be completed in accordance with <a href="http://docs.djangoproject.com/en/dev/releases/1.2/">the update instructions</a> </div><p>Source: <a href="https://habr.com/ru/post/94230/">https://habr.com/ru/post/94230/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../94223/index.html">Do not hide the choice of language in the drop-down menu!</a></li>
<li><a href="../94224/index.html">Path to 10 Billion Tweets</a></li>
<li><a href="../94225/index.html">The European Commission plans to provide all Europeans with high-speed Internet access by 2020</a></li>
<li><a href="../94226/index.html">Event Reminder with HolidaySH</a></li>
<li><a href="../94228/index.html">KA4-TV: Issue # 21: Splinter Cell: Conviction</a></li>
<li><a href="../94231/index.html">Displaying a hierarchical data structure in WPF using anchors and templates</a></li>
<li><a href="../94238/index.html">QR code as the basis of the brand</a></li>
<li><a href="../94240/index.html">Rutracker.Org Addons: Firefox extension for Rutracker.Org</a></li>
<li><a href="../94241/index.html">Computer games 26 years ago</a></li>
<li><a href="../94245/index.html">Google AdWords Remarketing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>