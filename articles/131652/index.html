<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Design patterns for Android development. Part 3 - User Interface, Testing, AndroidMock</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article I explained what MVP is and how to organize an application development process using MVP. Now I will show you how I developed my T...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Design patterns for Android development. Part 3 - User Interface, Testing, AndroidMock</h1><div class="post__text post__text-html js-mediator-article">  In the last article I explained what MVP is and how to organize an application development process using MVP.  Now I will show you how I developed my T-Alarm. <br><br>  At first I made a presentation and presenter, as described in the last article. <br><br><h4>  View </h4><br>  Naturally, my view is a successor to the class of Activity, more precisely RoboActivity, what I am talking about in brief.  Below is a very typical source code for the alarm settings editing window: <br><a name="habracut"></a><br><pre><code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AlarmEdit</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoboActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAlarmEdit</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@InjectView</span></span>(R.id.ae_et_AlarmName) EditText etName; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> AlarmEditPresenter presenter; <span class="hljs-meta"><span class="hljs-meta">@InjectView</span></span>(R.id.ae_btn_Save) Button btnSave; <span class="hljs-meta"><span class="hljs-meta">@InjectView</span></span>(R.id.ae_btn_Cancel) Button btnCancel; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.alarm_edit); presenter.onCreate(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); btnSave.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); btnCancel.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View btn)</span></span></span><span class="hljs-function"> </span></span>{ AlarmEdit.ClickSourceItem clickItem = AlarmEdit.ClickSourceItem.CANCEL; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (btn.getId()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> R.id.ae_btn_Save: clickItem = AlarmEdit.ClickSourceItem.SAVE; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> R.id.ae_btn_Cancel: clickItem = AlarmEdit.ClickSourceItem.CANCEL; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } presenter.onClick(clickItem); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAlarmName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> etName.getText().toString(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAlarmName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String alarmName)</span></span></span><span class="hljs-function"> </span></span>{ etName.setText(alarmName); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bundle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getViewBundle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getIntent().getExtras(); } }</code> </pre> <br>  So let's get down to this example. <br>  Let's start with what RoboActivity is and why it is needed here.  RoboActivity is included with RoboGuice.  RoboGuice is a Dependency Injection Framework for Android. <br>  More details on RoboGuice are available on the project website: <br>  <a href="http://code.google.com/p/roboguice/wiki/SimpleExample%3Ftm%3D6">code.google.com/p/roboguice/wiki/SimpleExample?tm=6</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this class, I use RoboGuice to avoid the oddities in the onCreate method, like: <br><pre> <code class="hljs lisp">etName = (<span class="hljs-name"><span class="hljs-name">EditText</span></span>) findViewById(<span class="hljs-name"><span class="hljs-name">R</span></span>.id.ae_et_AlarmName)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  RoboGuice does it all for me when creating activity by processing lines with <a href="https://habrahabr.ru/users/inject/" class="user_link">Inject</a> tags ..., for example: <br><pre> <code class="hljs css">@<span class="hljs-keyword"><span class="hljs-keyword">InjectView</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">R</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">ae_et_AlarmName</span></span>) EditText etName;</code> </pre> <br>  I give the name of the resources as follows: <br>  &lt;abbr.  activity name&gt; _ &lt;abbr.  name of control type&gt; _ &lt;control name&gt; <br>  So it is easier to target among a large heap of resource identifiers, which of the entire application are dumped into one namespace "R.id". <br><br>  Also I create Presenter here using RoboGuice through the following ad: <br><pre> <code class="hljs css">@<span class="hljs-keyword"><span class="hljs-keyword">Inject</span></span> AlarmEditPresenter presenter;</code> </pre> <br>  In fact, RoboGuice has a few more uses that I will show next. <br><br>  Thus, at the time of the onCreate () method execution, all the fields in my class are already initialized and I do not need to bother with their initialization separately, my code looks nicer. <br><br>  In the onCreate () method, I only register the current class as OnClickListener and transfer to the presenter a link to this presentation class, so that the presenter will further control the presentation properties.  Due to this, Inversion of Control is obtained when the business logic in the presenter controls the presentation. <br>  I do this to test business logic, which is concentrated in a separate class presenter, which is weakly dependent on other parts of the application.  Then I will show how when testing I tear out the presenter from the program's environment, connect various stubs and imitations instead of other components and perform tests over the presenter. <br><br>  The onClick () method shows that all commands that the presentation receives from the user are transmitted to the presenter.  Here I‚Äôll only convert the identifiers of the buttons to commands, so that when debugging I‚Äôll see the names of the commands, not the numbers corresponding to the resources in the R.id class, and it‚Äôs not worth adding any presentations to the presenter. <br><br>  Here the presentation communicates directly with the presenter, without using an interface.  I did so because I do not need to replace the presenter with imitation.  I do not test performance in unit tests. <br><br>  The setAlarmName () and getAlarmName () methods are used by the presenter to display and get the name of the alarm in the editing window. <br><br>  The getViewBundle () method is needed to get the ID of the edited alarm clock, which I pass through Intent.  The alarm clock itself comes from the model that the repository loads, while all the alarm clocks are loaded into the model at once, because there are not many of them.  The model is loaded in the first activity of the program, there is a list of alarm clocks and I already need to have a model with all the alarms. <br>  Through the use of Roboguice, I have a singleton model.  That is, in the whole application I have one copy of the model and I do not need to transfer it from activity to activity.  The presenter of each activity gets a model from Roboguice: <br><pre> <code class="hljs css">@<span class="hljs-keyword"><span class="hljs-keyword">Inject</span></span> IAlarmListModel alarmListModel;</code> </pre> <br>  Since Singleton is not implemented through a static class, but through RoboGuice, I can replace the model in the tests with the simulation I need. <br><br>  The code presented here and in the interface is the entire additional code that I had to write using MVP.  The rest of the code that is in presenter should be written anyway, because it contains the necessary business logic. <br>  In other words, the MVP fee is a few mapping lines, which is not much compared to what we get when using MVP. <br><br><h4>  Intefrace IAlarmEdit </h4><br>  The interface is extremely simple and simply contains methods for the presenter to communicate with the presentation, as well as to replace the presentation with imitation in tests. <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAlarmEdit</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ClickSourceItem { SAVE, CANCEL } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAlarmName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAlarmName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String alarmName</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> Bundle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getViewBundle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) }</span></span></code> </pre><br><br><h4>  How Presenter Works </h4><br>  Starting the implementation of the user interface, I wanted to make it as fast as possible, because no one likes the brake programs.  At first, I planned to concentrate as much logic as possible in the service so as not to load the user interface.  But then I discovered that the service is running in the same thread as the user interface.  And for using separate threads there is a great thing AsyncTask.  It was through her that I did multithreading in the program, and both in the user interface and in the service. <br><br>  Therefore, in the presenter there is an instance of the class IModelLoader, which asynchronously calls the repository and passes it a model for saving.  In more detail about asynchronous reading / loading I will write in the following articles. <br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AlarmEditPresenter implements IModelReciver { @Inject <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IModelLoader modelSaver; private <span class="hljs-type"><span class="hljs-type">int</span></span> id; private AlarmEdit <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onCreate(IAlarmEdit alarmEdit) { //   ,   //   this.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> = alarmEdit; // id    Bundle bundle = <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.getViewBundle(); id = bundle.getInt(MainScreenPresenter.BUNDLE_ARG_ALARM_ID); //   ,     // ,      //    . alarmListModel.takeAlarmForEdit(id); //     <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.setAlarmName(alarmListModel.getEditingAlarm().getName()); //  ,   //     modelSaver.setReciver(this); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onClick(AlarmEdit.ClickSourceItem clickItem) { switch(clickItem) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SAVE: // ,    alarmListModel.getEditingAlarm().setName(<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.getAlarmName()); //     alarmListModel.updateAlarm(alarmListModel.getEditingAlarm()); //   . modelSaver.saveModel(); //   . //     . break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CANCEL: //     . <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.setResult(Activity.RESULT_CANCELED); <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.finish(); break; } } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>(String event) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(event.equals(IModelLoader.EVENT_ALARM_MODEL_SAVE)) { // ,   . // . <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.setResult(Activity.RESULT_OK); <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.finish(); } } }</code> </pre><br>  In fact, I still have a lot of code in this presenter, but there is nothing new in terms of MVP in it, so I didn‚Äôt give it. <br><br>  I note only that in the presenter there is also such a member of the class: <br><pre> <code class="hljs scala"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">IDateHolder</span></span> dateHolder;</code> </pre> <br>  I need IDateHolder to simulate the time and locale I need in tests, and in a real application, Roboguice substitutes a class that returns the system time and locale. <br>  In particular, on the main window there is the current time - this is a string that displays the time in the current locale.  I have tests in which I imitate the time and locale I need and check that the string has gone to the view in the correct locale.  Thanks to these tests, I am sure that my program works correctly in different locales. <br><br><h4>  Presenter test </h4><br>  Due to the fact that in the presenter all the connections with the other components are made through interfaces, I can simulate these interfaces in tests.  What am I going to do now. <br><br>  In this test, I have a task: check AlarmEditPresenter.  I need to check that he takes the ID from the form, takes the desired alarm clock from the model and correctly displays its name in the edit control. <br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> TestAlarmEditPresenter extends RoboUnitTestCase&lt;TestApplication&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AlarmEditModule extends AbstractAndroidModule { //       presenter- //   RoboGuice    presenter  //          @Override protected <span class="hljs-type"><span class="hljs-type">void</span></span> configure() { bind(AlarmEditPresenter.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); bind(IAlarmListModel.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>) .toProvider(AlarmListModelProvider.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); } } private IAlarmListModel model; @Override protected <span class="hljs-type"><span class="hljs-type">void</span></span> setUp() throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> { TestApplication.alarmTestModule = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AlarmEditModule(); super.setUp(); model = AndroidMock.createNiceMock(IAlarmListModel.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); AlarmListModelProvider.alarmListModel = model; } //    private <span class="hljs-type"><span class="hljs-type">void</span></span> initializeTest() { AndroidMock.<span class="hljs-keyword"><span class="hljs-keyword">reset</span></span>(model); } <span class="hljs-comment"><span class="hljs-comment">/** *          View * @throws Exception */</span></span> @MediumTest <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> testAlarmEditOpen() throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> { initializeTest(); AlarmItem alarm = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AlarmItem(); alarm.setName("Test Name"); //,   <span class="hljs-number"><span class="hljs-number">2</span></span>     model.takeAlarmForEdit(<span class="hljs-number"><span class="hljs-number">2</span></span>); //  ,    presenter AndroidMock.expect(model.getEditingAlarm()).andStubReturn(alarm); AndroidMock.replay(model); //    Intent   //,     <span class="hljs-number"><span class="hljs-number">2</span></span> Bundle bundle = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Bundle(); bundle.putInt(MainScreenPresenter.BUNDLE_ARG_ALARM_ID, <span class="hljs-number"><span class="hljs-number">2</span></span>); AlarmEdit <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> = AndroidMock.createMock(AlarmEdit.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); AndroidMock.expect(<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.getViewBundle()).andStubReturn(bundle); //      <span class="hljs-keyword"><span class="hljs-keyword">View</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.setAlarmName("Test Name"); AndroidMock.replay(<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>); //  presenter AlarmEditPresenter presenter = getInjector().getInstance(AlarmEditPresenter.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); //  presenter.onCreate(<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>); //,      ,    AndroidMock.verify(<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>); //,        AndroidMock.verify(model); } }</code> </pre><br>  For the nested class AlarmEditModule and its configure () method, see the following articles for more details on using RoboGuice. <br><br>  In the setUp () method, I create an imitation and put it in the provider.  In general, why do I need a provider: with its help, I solve the following problem.  When initializing fields marked with the <a href="https://habrahabr.ru/users/inject/" class="user_link">Inject</a> attribute, <a href="https://habrahabr.ru/users/inject/" class="user_link">it is</a> necessary to substitute the necessary simulations.  RoboGuice, by the type of field, will find that it is necessary to use such a provider (see the configure () method), through which it will substitute the desired imitation. <br><br>  In the initializeTest () method, which is performed before each test, I clear the state of all simulations after other tests to ensure the isolation of the tests. <br><br>  In the test itself, I first prepare imitations: <br>  I create an alarm clock and tell the model to imitate that if the presenter asks for an editable alarm clock, then return to him this prepared alarm clock: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">AndroidMock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.expect</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">view</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.getViewBundle</span></span>())<span class="hljs-selector-class"><span class="hljs-selector-class">.andStubReturn</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bundle</span></span>);</code> </pre> <br>  I also indicate that I expect certain calls: <br><pre> <code class="hljs vhdl">//,   <span class="hljs-number"><span class="hljs-number">2</span></span>     model.takeAlarmForEdit(<span class="hljs-number"><span class="hljs-number">2</span></span>); ..... //      <span class="hljs-keyword"><span class="hljs-keyword">View</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.setAlarmName(<span class="hljs-string"><span class="hljs-string">"Test Name"</span></span>);</code> </pre><br>  After that, an instance of the AlarmEditPresenter class is created via RoboGuice.  You must create it through RoboGuice so that it fills all the fields marked with the <a href="https://habrahabr.ru/users/inject/" class="user_link">Inject</a> attribute <a href="https://habrahabr.ru/users/inject/" class="user_link">with the</a> desired values. <br>  Then I call the method presenter.onCreate (view) in which the alarm clock is loaded and its name is transferred to the view. <br><br>  And in the end I check that presenter made all the necessary calls: <br><br><pre> <code class="hljs dos">//,      ,    AndroidMock.<span class="hljs-built_in"><span class="hljs-built_in">verify</span></span>(view); //,        AndroidMock.<span class="hljs-built_in"><span class="hljs-built_in">verify</span></span>(model);</code> </pre><br>  To clarify the remaining details, I will tell about: <br><br><h4>  AndroidMock </h4><br>  This is a framework for creating imitations.  You can read more about it here: <br>  <a href="http://code.google.com/p/android-mock/">code.google.com/p/android-mock</a> <br><br>  Here I will explain what AndroidMock is and what features of its use I found in my project. <br><br>  All Mock Framework in all languages ‚Äã‚Äãare designed for the following: <br><br>  First, make a simulation of a given interface or class.  Simulation is an instance of an interface or class and can be passed to all methods where an instance of the original interface or class is required.  Immediately after creation, imitation has all fields, albeit with values ‚Äã‚Äãof 0 or null, depending on the type, and you can also call any method that is also 0 or null, depending on the type. <br><br>  If it doesn‚Äôt matter what is called in imitation, or imitation is simply not used in the test, but the class under test is not created without imitation, then in that case an empty imitation is created in one line and passed to the class being created. <br><br>  Secondly.  For imitation, you can specify in one line that if such a method is called, then return such and such a value.  In the example above, this is the line: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">AndroidMock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.expect</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">view</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.getViewBundle</span></span>())<span class="hljs-selector-class"><span class="hljs-selector-class">.andStubReturn</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bundle</span></span>);</code> </pre> <br>  Typically, this imitation feature is used when the class implementing the interface is not yet ready, or when the method is ready, but in order for it to work properly, you need to prepare it for a long time.  And in order not to bother with preparing the data for a method that, as a rule, is not even the subject of a test, it is easier to simply simulate the result returned by it. <br>  By the way, if I had expected two calls, and they would have to return different results, I would write: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">AndroidMock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.expect</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">view</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.getViewBundle</span></span>())<span class="hljs-selector-class"><span class="hljs-selector-class">.andReturn</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bundle1</span></span>); <span class="hljs-selector-tag"><span class="hljs-selector-tag">AndroidMock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.expect</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">view</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.getViewBundle</span></span>())<span class="hljs-selector-class"><span class="hljs-selector-class">.andReturn</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bundle2</span></span>);</code> </pre><br>  Thirdly.  After executing the test for imitation, you can check that all the necessary calls were made, but there were no necessary ones. <br>  In my example, this is the string: <br><pre> <code class="hljs pgsql">AndroidMock.verify(<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>);</code> </pre> <br>  She checks.  that all expectations that were described before the line <br><pre> <code class="hljs pgsql">AndroidMock.replay(<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>);</code> </pre> <br>  fulfilled. <br><br>  It must be said that not only the fact of the method call is checked, but that the method is called with the correct arguments: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">AndroidMock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.expect</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">view</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.getViewBundle</span></span>(1))<span class="hljs-selector-class"><span class="hljs-selector-class">.andReturn</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bundle1</span></span>); <span class="hljs-selector-tag"><span class="hljs-selector-tag">AndroidMock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.expect</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">view</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.getViewBundle</span></span>(2))<span class="hljs-selector-class"><span class="hljs-selector-class">.andReturn</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bundle2</span></span>);</code> </pre><br>  In this case, different values ‚Äã‚Äãwill be returned for different arguments, and during the check you can check that there was a call with the specified arguments. <br><br>  When creating an imitation there are three methods: <br>  <b>AndroidMock.createNiceMock ()</b> - Creates a weak imitation.  When checking will not be taken into account, extra methods were called.  Only that declared methods will be checked.  It is usually used when it is necessary to track that the correct methods were called, and if there were unnecessary ones, then it is not scary. <br>  In those cases when imitation is needed only to create a class, they just use weak imitation and do not even cause verification after the test. <br><br>  <b>AndroidMock.createMock ()</b> - Creates a regular imitation.  To verify that all necessary methods were called, and unnecessary methods were not called.  This will check the number of calls.  Usually one line in describing expectations is one call.  But if you use the andStubReturn () method, then it is a lot of calls.  You can also indicate a specific number of calls: andReturn (). Times (3); <br><br>  <b>AndroidMock.createStrcitMock ()</b> - Creates a strict simulation.  in this case, even the order of method calls is checked. <br><br>  Detailed reference information can be found on the AndroidMock and EasyMock project pages. <br><br>  Unfortunately, AndroidMock has serious flaws. <br>  It was announced that it could mimic built-in classes, such as MediaPlayer, but that was a long time ago and this does not work with the latest versions of the Android SDK. <br>  You have to make your own interface, which contains all the necessary methods from the main class and how to make a View, which contains an instance of the real MediaPlayer and maps all calls from the interface to the methods of the real class. <br>  In the tests, I imitate the created interface. <br><br>  Therefore, I am going to look for another Framework for creating imitations. <br><br><h4>  Read in other articles. </h4><br>  - <a href="http://habrahabr.ru/blogs/android_development/131369/">Introduction</a> <br>  - <a href="http://habrahabr.ru/blogs/android_development/131446/">MVP and Unit tests.</a>  <a href="http://habrahabr.ru/blogs/android_development/131446/">Jedi Way</a> <br>  - User Interface, Testing, AndroidMock <br>  - <a href="http://habrahabr.ru/blogs/android_development/132646/">Saving data.</a>  <a href="http://habrahabr.ru/blogs/android_development/132646/">Domain Model, Repository, Singleton and BDD</a> <br>  - Server side implementation, RoboGuice, testing <br>  - Small tasks, settings, logging, ProGuard </div><p>Source: <a href="https://habr.com/ru/post/131652/">https://habr.com/ru/post/131652/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131646/index.html">LiveKniga.Ru, or a story about a blog with stories about stories</a></li>
<li><a href="../131647/index.html">We make a macro flash from the built-in flash</a></li>
<li><a href="../131648/index.html">PHP library for working with the Yandex.Money API</a></li>
<li><a href="../131649/index.html">We write our auto-update service</a></li>
<li><a href="../131650/index.html">We write a math reference book for Android, we connect the Begun ad</a></li>
<li><a href="../131653/index.html">Ino - working with Arduino from the command line</a></li>
<li><a href="../131654/index.html">Google Map API (custom labels and tooltips)</a></li>
<li><a href="../131656/index.html">Google+ for Android has also been updated.</a></li>
<li><a href="../131657/index.html">Fruity Loops - soon for Android users</a></li>
<li><a href="../131660/index.html">30 years with QNX: Trainers of Channel's trains improve their skills on simulators based on QNX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>