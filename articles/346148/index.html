<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configure Azure Application Insights for diagnosing software with microservice architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Application Insights is a cool thing that allows you to diagnose, profile and analyze the use of deployed systems (including in production mode), and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configure Azure Application Insights for diagnosing software with microservice architecture</h1><div class="post__text post__text-html js-mediator-article"><p>  <strong>Application Insights</strong> is a cool thing that allows you to diagnose, profile and analyze the use of deployed systems (including in production mode), and at the same time does not require any effort from the developer.  Of course, all this becomes possible at the price of an agonizing initial setup. </p><br><p>  Of course, there is no special setting in the promotional videos, but life is more complicated, especially if your software is microservice.  Why?  And everything is very simple. </p><br><p>  What should the diagnostic system in the microservice architecture do first of all? <br>  Correctly, correlate diagnostics from various microservices within one operation. <br>  Tyrknul user in the UI button - you need to see the diagnostics from all N microservices that somehow processed this tyrk.  An exception happened somewhere - it is necessary to see not only in which microservice it happened, but also in the framework of which operation it happened. <br>  Only here, Application Insights, from the point of view of a specific microservice, is primarily the SDK.  And there are several such SDKs - for JS, for .NET Core, .NET (with its own settings for MVC, WebAPI, WCF), for Java, <a href="https://docs.microsoft.com/en-us/azure/application-insights/">etc.</a> </p><br><p>  Some of these SDKs are opensource, some are internal MS development.  And to get everything started - they need to be friends. </p><br><p>  This is the main difficulty. </p><br><p>  Not to say that I have achieved 100% enlightenment in this matter. <br>  But at least, I have already collected a few rakes and I have a working sample from the UI on ASP.NET MVC (not Core) + JS and two microservices (Asp.Net WebApi, WCF) </p><br><p>  Who cares - I ask under the cat. </p><a name="habracut"></a><br><h2 id="nemnogo-pro-application-insights">  A little about Application Insights </h2><br><p>  If in a nutshell - it works like this: </p><br><ol><li>  Using the SDK, handles or automatically generates objects from <a href="https://docs.microsoft.com/en-us/azure/application-insights/application-insights-data-model">the</a> Application Insights <a href="https://docs.microsoft.com/en-us/azure/application-insights/application-insights-data-model">data model</a> for software events. </li><li>  Generated objects are uploaded to Azure via the REST API </li><li>  In Azure there are tools (very rich) for analyzing the generated information </li></ol><br><h2 id="kak-data-model-application-insights-mappitsya-na-mikroservisnuyu-arhitekturu">  How does the Application Insights model date map to microservice architecture? </h2><br><p><img src="https://habrastorage.org/webt/t-/1c/ci/t-1cci3qp4w6vsfbtfy3mnslfok.jpeg"></p><br><p>  As can be seen from the picture, each kick in the microservice \ UI \ API generates a Request on the side where they kicked and Dependency on the side they kicked. <br>  In the course of work, trace events, error messages, custom events, as well as such specialized objects as pageView can also be generated. </p><br><h2 id="kak-application-insights-korreliruet-mezhdu-soboy-obekty">  How Application Insights Correlates Objects </h2><br><p><img src="https://habrastorage.org/webt/vx/th/q8/vxthq8ubppfmp7k61lghfu1rd00.jpeg"></p><br><p>  The blue arrows in the picture show the connections between the objects.  As seen, </p><br><ol><li><p>  All objects are associated with a specific operation (this is not a separate entity of the AI ‚Äã‚Äãdate-model, they simply have the same property. The operation is initialized when the first request is not within the scope of the operation) </p><br></li><li><p>  Trace messages / error messages / custom events / microservice dependencies are connected in addition to the request object (also through a property) </p><br></li><li>  Request objects are additionally associated with the Dependency object (unless this is the very first Request) also through a property. </li></ol><br><p>  Details can be found in the <a href="https://docs.microsoft.com/en-us/azure/application-insights/">official</a> Application Insights <a href="https://docs.microsoft.com/en-us/azure/application-insights/">documentation.</a> </p><br><h2 id="chto-dalshe">  What's next? </h2><br><p>  And then there will be a description of two scenarios of interaction between microservices with a detailed description of the method of implementation. </p><br><h2 id="scenariy-1---ajax-mvc-webapi">  Scenario 1 - AJAX, MVC, WebApi </h2><br><p><img src="https://habrastorage.org/webt/2w/oz/gj/2wozgjutfctgowige3tnz5kixkq.jpeg"></p><br><p>  Or the same, but with the words: </p><br><ol><li><p>  To display the page, it is required in the MVC controller to obtain data from the WebAPI microservice (via HttpClient) </p><br></li><li>  After displaying the page, she herself, using jQuery, climbs onto the server in the MVC controller and receives more data, which in turn is also taken from the WebAPI microservice. </li></ol><br><h3 id="chto-my-hotim-poluchit">  What we want to get </h3><br><p>  We want to be able to </p><br><ol><li>  See page view </li><li>  See that the server went to microservice to generate a page </li><li>  See that the page itself was performing ajax request to the server </li><li>  To see that the server also went to microservice to satisfy this request. </li><li>  In case of an error somewhere, we want to immediately see the context within which it occurred. </li></ol><br><p>  Ideally, we should see all the information on one screen as a sequence of actions. <br>  Of course, all of these goals will ultimately be achieved. <br>  In order not to torment - </p><br><h3 id="snachala-rezultat">  First the result: </h3><br><p>  The transition from the page to the diagnostic information on the operation <br><img src="https://habrastorage.org/webt/pw/cj/l6/pwcjl6x4q874_jxrwn4lkdffqyk.jpeg"></p><br><p>  Diagnostic information itself <br><img src="https://habrastorage.org/webt/6i/kh/gc/6ikhgcailn4weh5y2lvcclf5a3q.jpeg"></p><br><p>  And now with an error in microservice: <br><img src="https://habrastorage.org/webt/f_/as/ee/f_aseeat-6vcxvit-wstt32scis.jpeg"></p><br><h3 id="detali-realizacii">  Implementation details </h3><br><h4 id="v-web-api-mikroservise">  In the Web API microservice: </h4><br><ul><li>  Installing NuGets <em>Microsoft.ApplicationInsights</em> , <em>Microsoft.ApplicationInsights.Web</em> , <em>Microsoft.AspNet.WebApi.Tracing</em> </li><li>  With the packages above comes TraceListener for ApplicationInsights, it is written in the web.config itself. </li><li>  In WebApiConfig we specify <em>config.EnableSystemDiagnosticsTracing ()</em> </li><li>  Implement an <em>IExceptionFilter</em> that logs all uncaught errors in ApplicationInsights, write it in FilterConfig.cs </li></ul><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, Inherited = true, AllowMultiple = true)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WebApiAITrackingAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">FilterAttribute</span></span>, <span class="hljs-title"><span class="hljs-title">IExceptionFilter</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnException</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExceptionContext filterContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (filterContext != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; filterContext.HttpContext != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; filterContext.Exception != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ApplicationInsightsSettings.TelemetryClient.TrackException(filterContext.Exception); } } }</code> </pre> <br><p>  TelemetryClient - object from the ApplicationInsights SDK.  It is not recommended to create it every time, so it is here singleton through ApplicationInsightsSettings </p></div></div><br><h4 id="v-aspnet-mvc-ui">  In ASP.Net MVC UI: </h4><br><ul><li>  Install the <em>Microsoft.ApplicationInsights</em> NuGet, <em>Microsoft.ApplicationInsights.Web</em> </li><li>  Implement an <em>IExceptionFilter</em> that logs all uncaught errors in ApplicationInsights, write it in FilterConfig.cs (the same as for the Web API microservice) </li><li>  Implement <em>HttpClientHandler</em> to work with HttpClient, creating Dependency. <br>  Here it is a little more detailed: in general, the <a href="https://docs.microsoft.com/en-us/azure/application-insights/application-insights-correlation">documentation declares</a> that System.Net.HttpClient, starting from which version it is able to create Dependency from which version. <br>  And this is indeed true.  But he does it not directly (he does not work directly with the AI ‚Äã‚ÄãSDK), but slightly through one place, so this Dependency does not always bind correctly to Request.  So when I got tired of catching bugs with this - I wrote my HttpClientHandler </li></ul><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DependencyTrackingHandler</span></span> : <span class="hljs-title"><span class="hljs-title">HttpClientHandler</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DependencyTrackingHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _dependencyCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;HttpResponseMessage&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpRequestMessage request, CancellationToken cancellationToken</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> op = ApplicationInsightsSettings.TelemetryClient.StartOperation&lt;DependencyTelemetry&gt;(request.Method.Method + <span class="hljs-string"><span class="hljs-string">" "</span></span> + request.RequestUri.AbsolutePath)) { op.Telemetry.Target = request.RequestUri.Authority; op.Telemetry.Type = request.Method.Method; op.Telemetry.Data = request.Method.Method + <span class="hljs-string"><span class="hljs-string">" "</span></span> + request.RequestUri.ToString(); op.Telemetry.Id += <span class="hljs-string"><span class="hljs-string">"."</span></span> + Interlocked.Increment(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _dependencyCounter).ToString(); request.Headers.Add(<span class="hljs-string"><span class="hljs-string">"Request-Id"</span></span>, op.Telemetry.Id); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.SendAsync(request, cancellationToken).Result; op.Telemetry.ResultCode = result.StatusCode.ToString(); op.Telemetry.Success = result.IsSuccessStatusCode; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } } }</code> </pre> <br><p>  As you can see, the meaning of this handler is to wrap the HttpClient call in DependencyTelemetry, and also (and this is very important), set the correct <em>Request_Id</em> header. <br>  About heders also a little more detail.  Through them, the AI ‚Äã‚Äãinfrastructure transmits information about the operation id, as well as information about the id dependency when making calls via the HttpClient. <br>  Headers for these purposes are used such: "Request-Id", "x-ms-request-id", "x-ms-request-root-id".  For the correlation to be correctly initialized, the first one or (the second and third one) is enough. <br>  More information about correlations and heders can be read in the <a href="https://docs.microsoft.com/en-us/azure/application-insights/application-insights-correlation">documentation</a> (although it is rather messy) </p></div></div><br><ul><li>  We recall that here we are dealing with two SDKs - for JS and for .NET, so somewhere in MVC views we are looking for code that initializes appInsight on the browser side, and then </li><li>  We register there <em>InstrumentationKey</em> </li></ul><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> appInsights=<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.appInsights||<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">config</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">config</span></span></span><span class="hljs-function">)</span></span>{ t[config] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>; t.queue.push(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ t[config].apply(t, i)})} } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = { <span class="hljs-attr"><span class="hljs-attr">config</span></span>:config},u=<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>,e=<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>,o=<span class="hljs-string"><span class="hljs-string">'script'</span></span>,s=u.createElement(o),i,f;<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(s.src=config.url||<span class="hljs-string"><span class="hljs-string">'//az416426.vo.msecnd.net/scripts/a/ai.0.js'</span></span>,u.getElementsByTagName(o)[<span class="hljs-number"><span class="hljs-number">0</span></span>].parentNode.appendChild(s),t.cookie=u.cookie,t.queue=[],i=[<span class="hljs-string"><span class="hljs-string">'Event'</span></span>,<span class="hljs-string"><span class="hljs-string">'Exception'</span></span>,<span class="hljs-string"><span class="hljs-string">'Metric'</span></span>,<span class="hljs-string"><span class="hljs-string">'PageView'</span></span>,<span class="hljs-string"><span class="hljs-string">'Trace'</span></span>,<span class="hljs-string"><span class="hljs-string">'Ajax'</span></span>];i.length;)r(<span class="hljs-string"><span class="hljs-string">'track'</span></span>+i.pop());<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> r(<span class="hljs-string"><span class="hljs-string">'setAuthenticatedUserContext'</span></span>),r(<span class="hljs-string"><span class="hljs-string">'clearAuthenticatedUserContext'</span></span>),config.disableExceptionTracking||(i=<span class="hljs-string"><span class="hljs-string">'onerror'</span></span>,r(<span class="hljs-string"><span class="hljs-string">'_'</span></span>+i),f=e[i],e[i]=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">config, r, u, e, o</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = f &amp;&amp; f(config, r, u, e, o); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s !== !<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; t[<span class="hljs-string"><span class="hljs-string">'_'</span></span> + i](config, r, u, e, o),s}),t }({ <span class="hljs-attr"><span class="hljs-attr">instrumentationKey</span></span>: <span class="hljs-string"><span class="hljs-string">"@Microsoft.ApplicationInsights.Extensibility.TelemetryConfiguration.Active.InstrumentationKey"</span></span> });</code> </pre> </div></div><br><ul><li>  We synchronize the global operation between the server and the browser (so that in one global operation we can also display server diagnostics and diagnostics from the browser) </li></ul><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.appInsights.queue.push(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serverId =<span class="hljs-string"><span class="hljs-string">"@Context.GetRequestTelemetry().Context.Operation.Id"</span></span>; appInsights.context.operation.id = serverId; });</code> </pre> <br><pre> <code class="hljs markdown">    WA <span class="hljs-strong"><span class="hljs-strong">**Sergey Kanzhelev**</span></span>    [<span class="hljs-string"><span class="hljs-string">http://apmtips.com</span></span>](<span class="hljs-link"><span class="hljs-link">http://apmtips.com</span></span>)</code> </pre> </div></div><br><h2 id="scenariy-2---ajax-wcf-webapi">  Scenario 2 - AJAX, WCF, WebApi </h2><br><p><img src="https://habrastorage.org/webt/dj/wk/u5/djwku5_56carrbsrgkwemn2ubla.jpeg"></p><br><p>  Or the same, but with the words: </p><br><ul><li>  To display the page does not require data from microservice </li><li>  After displaying the page, she, using jQuery, climbs into WCF microservice and receives more data, which in turn is also taken from WebAPI microservice. </li></ul><br><p>  The objectives are the same as in the previous scenario. </p><br><h3 id="snachala-rezultat-1">  First the result: </h3><br><p><img src="https://habrastorage.org/webt/lz/vg/ff/lzvgfftysqyim7h7edkrdpx2pjo.jpeg"><br>  With an error in microservice: <br><img src="https://habrastorage.org/webt/k_/2b/mk/k_2bmklng-lxgx9qwhpdjfmcahk.jpeg"></p><br><h3 id="detali-realizacii-1">  Implementation details </h3><br><p>  In the Web API microservice - nothing new relative to the previous scenario. </p><br><h4 id="v-aspnet-mvc-ui-1">  In ASP.Net MVC UI: </h4><br><ul><li>  Somewhere in the MVC view, we look for code that initializes appInsight on the browser side, and then <em>redefines the appInsights</em> function. <em>_AjaxMonitor.sendHandler</em> </li></ul><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.appInsights.queue.push(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ appInsights._ajaxMonitor.sendHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, n</span></span></span><span class="hljs-function">) </span></span>{ e.ajaxData.requestSentTime = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appInsights.config.disableCorrelationHeaders) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appInsights.context.operation.id; e.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"x-ms-request-root-id"</span></span>, i); e.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"x-ms-request-id"</span></span>, e.ajaxData.id); } e.ajaxData.xhrMonitoringState.sendDone = !<span class="hljs-number"><span class="hljs-number">0</span></span>; }; });</code> </pre> </div></div><br><p>  With this a little more detail.  As you know, requests via XmlHttpRequest to hosts that are different from the current one are subject to additional security, so-called.  <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a> <br>  This is expressed in the fact that the http API can fly so-called.  preflight requests before the main for the headers, method and host of the main request. <br>  So, for some reason, the Application Insights SDK for JS seems to be very afraid of sending these preflight requests and therefore <a href="">never sends</a> correlation headers to hosts other than the current (taking into account the port). <br>  On the Application Insights SDK command for JS, <a href="https://github.com/Microsoft/ApplicationInsights-JS/issues/479">FR is</a> already running on this. <br>  In the code above, as a WA, the check for matching hosts is simply removed, and thus the headers are sent anyway. </p><br><h4 id="v-wcfapi">  In WcfApi: </h4><br><ul><li>  Install the <em>Microsoft.ApplicationInsights</em> , <em>Microsoft.ApplicationInsights.Web</em> , <em>Microsoft.ApplicationInsights.Wcf</em> NuGet (from <a href="https://www.myget.org/F/applicationinsights-sdk-labs/"></a>  <a href="https://www.myget.org/F/applicationinsights-sdk-labs/">https://www.myget.org/F/applicationinsights-sdk-labs/</a> ) </li><li>  We delete from ApplicationInsights.config <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.ApplicationInsights.Web.OperationNameTelemetryInitializer, Microsoft.AI.Web"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> </li><li>  Mark the attribute [ <em>ServiceTelemetry</em> ] class of service </li><li>  Do not forget to set the Method = "*" in the WebInvoke attribute for the methods of the service interface (since preflight requests with the OPTIONS method will arrive in it) </li><li>  We implement the answer to the preflight request in the service methods </li></ul><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckCorsPreFlight</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cors = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WebOperationContext.Current != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = WebOperationContext.Current.IncomingRequest; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = WebOperationContext.Current.OutgoingResponse; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.Method == <span class="hljs-string"><span class="hljs-string">"OPTIONS"</span></span>) { response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Methods"</span></span>, <span class="hljs-string"><span class="hljs-string">"GET, POST, OPTIONS"</span></span>); response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Headers"</span></span>, <span class="hljs-string"><span class="hljs-string">"Content-Type, X-Requested-With, x-ms-request-root-id, x-ms-request-id"</span></span>); response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Credentials"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>); cors = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> origin = request.Headers.GetValues(<span class="hljs-string"><span class="hljs-string">"Origin"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (origin.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Origin"</span></span>, origin[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Origin"</span></span>, <span class="hljs-string"><span class="hljs-string">"*"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cors; }</code> </pre> </div></div><br><h2 id="v-kachestve-bonusa---zaprosy-dlya-application-insights-analytics">  As a bonus - requests for Application Insights Analytics </h2><br><h3 id="poluchenie-id-globalnoy-operacii-po-faktu-prosmotra-stranicy">  Getting the global operation id on the page view </h3><br><pre> <code class="sql hljs">pageViews | order by timestamp desc | project timestamp, operation_Id, name</code> </pre> <br><p><img src="https://habrastorage.org/webt/yd/py/l0/ydpyl04ir3f5gw4kcthzqs5_po8.jpeg"></p><br><h3 id="poluchenie-id-globalnoy-operacii-po-faktu-vozniknoveniya-oshibki">  Getting the id of the global operation upon the occurrence of an error </h3><br><pre> <code class="sql hljs">exceptions | order by timestamp desc | project timestamp, operation_Id, problemId, assembly</code> </pre> <br><p>  Also for these purposes it is convenient to use the new interface Failures. <br><img src="https://habrastorage.org/webt/xy/ly/tr/xylytrtcbnt9odvlmg82xuejnmy.jpeg"></p><br><h3 id="poluchenie-diagnosticheskih-dannyh-po-globalnoy-operacii">  Obtaining diagnostic data for global operation </h3><br><pre> <code class="sql hljs">requests | union dependencies | union pageViews | union exceptions | where operation_Id == "&lt;place operation id here&gt;" | order by timestamp desc | project timestamp, itemType, data = iif(itemType == "exception", problemId, name)</code> </pre><br><p><img src="https://habrastorage.org/webt/en/ji/0c/enji0czho5hdvvbszxotskpr-ay.jpeg"></p><br><p>  <strong>Thanks to all</strong> <br>  <a href="https://github.com/AndreyPoturaev/appinsightdd">Test project on github</a> </p><br><p>  What to read: <br>  <a href="http://apmtips.com/">Amptips.com mega blog</a> <br>  <a href="https://docs.microsoft.com/en-us/azure/application-insights/">Official documentation</a> </p><br><p>  I would be grateful for any constructive criticism! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346148/">https://habr.com/ru/post/346148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346138/index.html">Game Design Techniques: Mixing</a></li>
<li><a href="../346140/index.html">Results of the development of computer vision in one year</a></li>
<li><a href="../346142/index.html">Hot reboot of components in React</a></li>
<li><a href="../346144/index.html">Mobile devices from the inside. Memory markup, file structure description and markup memory</a></li>
<li><a href="../346146/index.html">Python, under the pirate flag</a></li>
<li><a href="../346152/index.html">The head of Intel suspected of selling the company's shares at $ 24 million due to the vulnerability of processors</a></li>
<li><a href="../346154/index.html">Simplify ReactJS Components with RxJs</a></li>
<li><a href="../346160/index.html">Open Source Cisco Cybersecurity Projects</a></li>
<li><a href="../346162/index.html">Do observers affect usability testing results?</a></li>
<li><a href="../346164/index.html">Specter and Meltdown</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>