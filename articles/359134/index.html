<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to write a decentralized multiblockchein exchange in a day</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a report on my participation in the second stage of the hackathon, organized by karma.red . You can read more about the hackathon on a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to write a decentralized multiblockchein exchange in a day</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ub/tx/of/ubtxofmlzzc0txkzull2kuoxujk.png"><br><br>  This article is a report on my participation in the second stage of the hackathon, organized by <a href="https://www.karma.red/">karma.red</a> .  You can read more about the hackathon on a <a href="https://h.karma.red/">special page</a> . <br><br>  For those who like to read the code, not the article - <a href="https://github.com/quantum13/hackathon_karma2">the project repository</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Video lovers are also not offended :) <a href="https://www.youtube.com/watch%3Fv%3DuIsr-_lvC4I">In this video,</a> you can listen to a brief summary of the article, see how the exchange is implemented step by step and see its work live. <br><br><a name="habracut"></a><br>  <a href="https://geektimes.com/post/300637/">An article by</a> another hackathon participant from Vladivostok (the three organizers from Vladik and one from Ulan-Ude, the organizers of the online stage paid for flying and living in Moscow). <br><br>  The photos in the article - Vadim Frantsev, the pictures are mine, from a quick presentation of the project to protect the project :) So, with the formalities over, let's go. <br><br>  After issuing <a href="https://docs.google.com/document/d/1zrM2lPJWkt0J_67Koshkz2hG4N7P3KO4W0FOWUNsYMo/edit">assignments</a> , I had a choice - either to take up a decentralized exchange, or for an arbitration court.  In the task with the court, it would be necessary to create a system with a reputation, to program the simulation.  It would be too simple and a bit like my project <a href="https://github.com/quantum13/hackathon_karma">in the first stage</a> . <br><br>  The work of the decentralized exchange is based on atomic interblockchain exchanges (swaps), I have long wanted to understand them, but all hands did not reach.  After giving myself an hour to research (if I couldn‚Äôt figure it out, I‚Äôd have to go to court) I went to read.  After reading the <a href="https://github.com/decred/atomicswap">documentation for the implementation of exchanges</a> for several blockchains, I realized that everything was easy and took over the exchange. <br><br><h3>  What is this decentralized exchange: </h3><br><ul><li>  <b>Engine</b>  This can be your own blockchain or smart contract on another blockchain.  Responsibilities include accepting orders (order, order) for buying / selling, their matching (matching, matching) </li><li>  <b>Blockchains with support for blocking coins with unlocking by time / secret</b> .  Such as ethereum, bitcoin and its fork, eos, etc. </li><li>  <b>Interface (optional)</b> .  To view the glass, submit orders, notifications, etc. </li></ul><br><img src="https://habrastorage.org/webt/fk/co/tv/fkcotvtgjjwyj_1lh4cy2d0wz18.png"><br><br>  For simplicity, exchanges can be exchanged only through the currency of the exchange.  In this case, the exchange will be able to initiate atomic exchanges in the blockchain of the exchange. <br><br>  Since  besides ethereum, there are no other blockchains with smart contacts now, so I chose it for prototyping.  Its use in the military stock exchange seems unlikely due to the price of gas and its limitations.  In this regard, there is some hope for EOS. <br><br><h3>  Atomic exchanges </h3><br>  You can read detailed documentation <a href="https://github.com/decred/atomicswap">here</a> .  Very brief retelling: <br><br><ul><li>  Dasha has 1 bitcoin, Masha has 10 esters.  They want to exchange them so that no one can fool each other. </li><li>  Dasha generates a secret and a hash from the secret </li><li>  (Initiate step) Dasha blocks 1 bitcoin so that only Masha can get it, indicating the secret, or Dasha herself two days after blocking </li><li>  Dasha passes the transaction ID with a lock and hash from the secret to Masha </li><li>  (Step participate) Masha checks the Dasha's transaction and, if everything is correct, Masha, using a smart contract, blocks 10 airs so that only Dasha can receive them, specifying a secret, or Masha herself a day after blocking </li><li>  Masha hands over the transaction with the funds blocking to Dasha </li><li>  (Redeem step) Dasha checks the transaction and, if the amount and date of the block is correct, takes 10 airs, specifying the secret </li><li>  (Redeem step) Masha learns the secret and takes bitcoin with it </li></ul><br><h3>  Putting it all together </h3><br><ul><li>  Dasha sends an order to sell 1 bitcoin at the price of 10 esters per bitcoin </li><li>  Masha makes a deposit in 20 airs on an exchange contract </li><li>  Masha sends an order to buy 2 bitcoins for the price of 10 esters per bitcoin </li><li>  Exchange Matches Orders <br><br><ol><li>  An order is created for Masha to buy 1 bitcoin at the price of 10 airs per bitcoin </li><li>  Atomic metabolism is initiated.  In this case, 10 ethers are removed from the balance of Masha and are blocked in the contract of atomic exchange.  Since  For initiation, you need a secret and a hash from a secret, then the buyer (in this case, Masha) must deposit a stock of hashes of secrets on the exchange in order for each initiated exchange to have a new hash. </li></ol><br></li><li>  Then all the actions described in the previous section take place, regardless of the exchange. </li></ul><br><img src="https://habrastorage.org/webt/f4/lc/bt/f4lcbtxh8-lm4wlfe1geaqynwxo.png"><br><br><h3>  My implementation </h3><br>  I took this implementation as the basis for the atomic swap contract: <a href="https://github.com/AltCoinExchange/ethatomicswap">github.com/AltCoinExchange/ethatomicswap</a> .  The peculiarity of this implementation is that for a new atomic exchange there is no need to deploy a new contract.  Everything happens in it, as in a certain registry of atomic exchanges. <br><br>  In this contract, I added the ability to manually specify the initiator and the second participant of the exchange, in order to specify them when initiating the exchange from the exchange contract.  The final version is <a href="">here</a> . <br><br>  The following has been implemented in <a href="">the exchange engine</a> : <br><br><ul><li>  <a href="">Adding stock hashes</a> </li><li>  <a href="">Deposit</a> and <a href="">Withdrawal</a> </li><li>  Submission of orders for the <a href="">purchase</a> and <a href="">sale</a> , but with some restrictions due to the prototypical nature of the contract and the time limit: <br><br><ul><li>  There are no gas limit checks: cycles are not limited, in combat contracts you cannot do that </li><li>  For comparisons of orders, a counter-order is taken, not with the best price, but the first </li><li>  Only submitted applications are split when compared with smaller ones.  For example, if there was an application for the purchase of 10 air, and you are applying for the sale of 2x, then the orders will not wind up. </li></ul><br></li><li>  <a href="">Initiation of atomic metabolism</a> in the contract of the registry of atomic exchanges </li></ul><br>  In order not to write the interface, I wrapped the contracts in the <a href="https://github.com/quantum13/hackathon_karma2/tree/master/constructors">designers</a> for the <a href="https://smartz.io/">smartz.io</a> platform and secured the contracts through these designers, quickly obtaining an interface for managing the contracts. <br><br>  I didn‚Äôt have enough time to demonstrate the exchange of the broadcast to bitcoin, so I showed the exchange of the broadcast from the rinkeby test network to the broadcast of their test network kovan: <br><br><img src="https://habrastorage.org/webt/hh/ci/ph/hhciphnxvm9iytrvbp4zgg35onu.png"><br><br><h3>  A couple of pictures and links </h3><br>  Links to control panels for contracts signed by me (you need to install the browser extension metamask to access the ethereum blockchain from the browser).  If you wish, you can enclose your <br><br><ul><li>  Atomic swap registry <a href="https://smartz.io/instance/6a7168050631827efa23ec5b">control panel</a> in rinkeby </li><li>  <a href="https://smartz.io/instance/f481a04a1198eac2a8938477">Control panel</a> exchange in rinkeby </li><li>  Atomic swap registry <a href="https://smartz.io/instance/ef5d6f674f4a64a20caeaa61">control panel</a> in kovan </li></ul><br>  Pictures for unwilling to put extensions: <br><br><div class="spoiler">  <b class="spoiler_title">Registry Control Panel</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/e_/hm/96/e_hm96pss697u-zmmbvx0jehjjm.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Control panel exchange</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xw/km/cs/xwkmcs4zd_pxblhxpeifjhth4m4.png"><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/359134/">https://habr.com/ru/post/359134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../359120/index.html">Experiments with kube-proxy and node unavailability in Kubernetes</a></li>
<li><a href="../359122/index.html">A bunch of different ways to read bits</a></li>
<li><a href="../359124/index.html">TOTAL 3 months: Alternative to paid shutdown of advertising in the free Android application</a></li>
<li><a href="../359130/index.html">How we made a highload ++ game with voxel graphics and VR</a></li>
<li><a href="../359132/index.html">Go 1.11: AVX-512 with Go</a></li>
<li><a href="../359136/index.html">Machine learning and a polypropylene extruder: history 3 places on the hakatone Sibur</a></li>
<li><a href="../359142/index.html">Internet ombudsman invited the Prosecutor General‚Äôs Office to check Roskomnadzor, millions of Amazon addresses are still blocked</a></li>
<li><a href="../359144/index.html">The insides of the SDR chip AD9361 - when microelectronics is more profitable than drug trafficking</a></li>
<li><a href="../359146/index.html">Simple and efficient calculation of Modbus CRC16 in PLC and MK without bitwise shift and tables</a></li>
<li><a href="../359148/index.html">Adobe bought Magento for $ 1.68 billion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>