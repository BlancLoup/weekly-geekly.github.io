<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expanding WDS Functionality: Adding Download Capability to UEFI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 


 This article outlines the steps you need to follow to add UEFI mode to your WDS. 


 Those. The instruction in this article assumes that yo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expanding WDS Functionality: Adding Download Capability to UEFI</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello! </p><br><p>  This article outlines the steps you need to follow to add UEFI mode to your WDS. </p><br><p>  Those.  The instruction in this article assumes that you already have, roughly the following configuration: </p><br><pre><code class="plaintext hljs">1. Windows Server 2012R2 ( ) 2.   DHCP    WDS 3.   WDS 4. IIS 5.      Ubuntu</code> </pre> <br><p>  Also, here are described the actions that did not bring me the proper result. <br>  <em>I described them, to facilitate the search and save your time.</em> </p><br><h2 id="predislovie">  Foreword </h2><br><p>  I did it somehow at WDS with a lot of buns, because  tired of constantly running around with a bunch of flash drives and rewriting them. </p><br><p>  Helped me by the way then these articles: <br>  <a href="https://habr.com/ru/post/171329/">Add WDS universality</a> <br>  <a href="https://habr.com/ru/post/175669/">PXE boot menu with System Center Configuration Manager</a> </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">It looks like this</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ux/kh/ku/uxkhkuhqfxpjw4hmhdhcshmrmzw.png"></p></div></div><br><p>  And everything was fine, new images were added for download, the winPE image was overlaid with new features and everything worked. </p><br><p>  But far from all devices support BIOS / Legacy boot mode, or if they support it, its inclusion may be in a very non-obvious place. </p><br><p>  Yes, and installing windows in legacy mode, when you can install in UEFI, is not cool. </p><br><p>  In the end, I decided to add the ability to download to UEFI, and went to Google. </p><br><p>  But I did not find any structured information on how to get a WDS + UEFI worker. <br>  Actually, that's why I decided to write this article. </p><br><p>  Before starting, I will describe the problem that took the most time. </p><br><div class="spoiler">  <b class="spoiler_title">When adding UEFI to WDS, the following is possible, a rather not obvious situation:</b> <div class="spoiler_text"><p>  If you add the boot file to the WDS and when you try to load it on the device <br>  in UEFI, you see the following text: <br> <code>The selected boot device failed. Press &lt;Enter&gt; to Continue.</code> <br>  Or <code>Boot Device Not Found</code> <br>  But loading in legacy works for you. <br>  Then one of the possible options is the absence of the <strong>wdsmgfw.efi</strong> file, <br>  along the following path: <code>%WDSpath%\Boot\x64\wdsmgfw.efi</code> </p><br><p>  You can <code>C:\Windows\System32\RemInst\boot\x64\wdsmgfw.efi</code> it here: <code>C:\Windows\System32\RemInst\boot\x64\wdsmgfw.efi</code> <br>  Or, if you lack this file for some reason, I uploaded it to <a href="https://drive.google.com/file/d/10uNaSnlcDz98pihzPkiOfvP1OsPbYsEg/view%3Fusp%3Dsharing">google</a> . <br>  For this decision, thanks to the guys from <a href="https://www.reddit.com/r/sysadmin/comments/9fj6ct/cant_get_uefi_pxe_boot_to_wds_working_ive_tried/">Reddit</a> . </p><br><p>  With this problem I killed the most time, because  I thought the problem was somewhere in the WDS or DHCP configuration. </p><br><p>  I set up policies by adding Vendor Classes (vendor classes) for different architectures, and configuring DHCP options 060, 066, 067. <a href="https://gal.vin/2017/05/05/pxe-booting-for-uefi-bios/">Instructions</a> for configuring DHCP policies. </p><br><div class="spoiler">  <b class="spoiler_title">ASCII architecture for configuring DHCP</b> <div class="spoiler_text"><p>  PXEClient: Arch: 00000 - BIOS / Legacy <br>  PXEClient: Arch: 00006 - UEFI x86 <br>  PXEClient: Arch: 00007 - UEFI x64 </p></div></div><br><p>  I also tried various versions of the <code>.efi</code> boot files <code>.efi</code> </p><br><ul><li>  syslinux </li><li>  grub 2 </li></ul><br><p>  I also tried to find a problem in the Event Log. <br> <code>win + r -&gt; eventvwr -&gt;     -&gt; Microsoft -&gt; Windows -&gt; Deployment-Services-Diagnostics</code> </p> <br><p>  But, as I said above, the problem lay in the <strong>wdsmgfw.efi</strong> file. <br>  Either I accidentally deleted it myself, or it was not copied during installation. <br>  and configure WDS. </p></div></div><br><p>  Well, let's get started! </p><br><h2 id="instrukciya">  Instruction </h2><br><h4 id="etap-1---proverka-rabotosposobnosti-wds">  Stage 1 - WDS Health Check </h4><br><p>  Take any device or virtual machine with support for booting in UEFI mode over the network and try to boot. </p><br><p>  You should have the following picture: </p><br><p><img src="https://habrastorage.org/webt/6z/1s/gb/6z1sgbqwvnlt0dm4hxvoykknlck.png"></p><br><p>  If so, then great, you can continue. <br>  If not, then look what I wrote in the preface. </p><br><h4 id="etap-2---sborka-zagruzochnogo-fayla-ipxe">  Step 2 - Build the iPXE boot file </h4><br><p>  Run Ubuntu, prepared in advance, open the terminal and insert this line: </p><br><pre> <code class="plaintext hljs">git clone https://git.ipxe.org/ipxe.git ipxe</code> </pre> <br><p><img src="https://habrastorage.org/webt/xx/rm/3m/xxrm3m6uw_ljjlenptc4pxq9spw.png"></p><br><p>  <em>Here I would like to make a small note, that you may have to add the packages necessary for compiling C and C ++ in Ubuntu.</em> <em><br></em>  <em>I just had them already installed.</em> </p><br><p>  Downloaded?  - Well! <br>  Now you need to make a configuration file for the assembly. <br>  In the terminal, we write: </p><br><pre> <code class="plaintext hljs">cd ipxe/src gedit chain.ipxe</code> </pre> <br><p>  And paste into this file, the following code, and then save: </p><br><pre> <code class="plaintext hljs">#!ipxe dhcp chain http://%IP-address-your-IIS-server%/install.ipxe</code> </pre> <br><p>  Go back to the terminal and start the compilation: </p><br><pre> <code class="plaintext hljs">make bin-x86_64-efi/ipxe.efi EMBED=chain.ipxe</code> </pre> <br><p><img src="https://habrastorage.org/webt/dv/ur/nz/dvurnzemv1eroll_0udqysn4jhw.png"></p><br><p>  If everything is in order, then you should get the following output in the terminal: </p><br><p><img src="https://habrastorage.org/webt/kn/cf/is/kncfisuctq18hs9dewvpfwd4ovg.png"></p><br><p>  And the file <strong>ipxe.efi</strong> , along the path: <code>ipxe/src/bin-x86_64-efi/ipxe.efi</code> <br>  <em>If you for some reason failed to compile on your own,</em> <em><br></em>  <em>I attached my <a href="https://drive.google.com/file/d/189NZhU0hdZSiYvFoLI83AZbfAv3cQCOK/view%3Fusp%3Dsharing">file</a> .</em> <em><br></em>  <em>It is compiled for download from <code>http://192.168.0.100/install.ipxe</code></em> </p><br><p>  This is all about Ubuntu. </p><br><h4 id="etap-3---dobavlenie-ipxeefi-k-wds">  Stage 3 - Adding ipxe.efi to WDS </h4><br><p>  We take the file that we received in the second stage and copy it along the path: <br> <code>%WDSpath%\Boot\x64\%your-boot-folder%\EFI\BOOT\</code> <br>  After rename it to BOOTX64.EFI. <br>  <em>This is not necessarily so easy.</em> </p><br><p>  Then we start <strong>cmd</strong> on behalf of the administrator, and we write the following commands: </p><br><pre> <code class="plaintext hljs">wdsutil /set-server /bootprogram:Boot\x64\%your-boot-folder%\EFI\BOOT\BOOTX 64.EFI /architecture:x64uefi  wdsutil /set-server /N12bootprogram:Boot\x64\%your-boot-folder%\EFI\BOOT\BOOTX 64.EFI /architecture:x64uefi</code> </pre> <br><p>  This will install the resulting file for downloading via WDS. </p><br><p>  Check the configuration: </p><br><pre> <code class="plaintext hljs">wdsutil /get-server /Show:Config</code> </pre> <br><p><img src="https://habrastorage.org/webt/a_/70/mo/a_70mobbjq86x8tlyvyw7ywuht8.png"></p><br><p>  <em>I also copied the ipxe.efi file, renamed it to BOOTIA32.EFI, and configured the boot for it, just in case.</em> <em><code>architecture:x86uefi</code> <br></em>  <em>But by and large, this makes no sense, because</em>  <em>Bootmgfw.efi file does not support x86</em> </p><br><p>  Check what happened. <br><img src="https://habrastorage.org/webt/nz/oz/pi/nzozpiqidmvmolqo3qf6fr1rurc.png"><br>  Great, WDS passes our file for download and it in turn looks for the configuration along the path: <code>http://192.168.0.100/install.ipxe</code> </p><br><h4 id="etap-4---konfiguraciya-menyu">  Stage 4 - Menu Configuration </h4><br><p>  Go to the root folder of your site. <br>  The default is: <code>C:\inetpub\wwwroot</code> </p><br><p>  Create a text file <strong>install.ipxe</strong> . </p><br><p>  And we configure it according to the <a href="http://ipxe.org/docs">documentation</a> and your needs. <br>  There is also a Russian-language <a href="http://tdkare.ru/sysadmin/index.php/IPXE">description of</a> commands. <br>  I used <a href="https://doc.rogerwhittaker.org.uk/ipxe-installation-and-EFI/">this</a> instruction when configuring my WDS. </p><br><div class="spoiler">  <b class="spoiler_title">Install.ipxe configuration example</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#!ipxe :start menu Please choose an operating system to start/install item --gap Start Win PE item WinPE-x64 WinPE x64 item --gap ipxe shell item shell Drop to iPXE shell choose target &amp;&amp; goto ${target} :failed echo Booting failed, dropping to shell goto shell :shell echo Type 'exit' to get the back to the menu shell set menu-timeout 0 set submenu-timeout 0 goto start :WinPE-x64 kernel http://192.168.0.100/wimboot initrd http://192.168.0.100/peSE/Boot/bcd initrd http://192.168.0.100/peSE/Boot/boot.sdi initrd http://192.168.0.100/peSE/Boot/peSE64.wim boot || goto failed</code> </pre> </div></div><br><p>  About the configuration for downloading winPE can be read <a href="http://ipxe.org/howto/winpe">here</a> . </p><br><h4 id="etap-5---mime-types">  Stage 5 - MIME types </h4><br><p>  After creating the menu and adding all the necessary files to the IIS root folder, <br>  must be given access to them. </p><br><p>  Because  even if you try to download a file from a browser, you will get an error at its address: <code>HTTP 404.3 - Not Found</code> . <br><img src="https://habrastorage.org/webt/4c/vi/13/4cvi1361vfaauyhjrikkgt3p7fw.png"></p><br><p>  To do this, you need to add MIME types to the IIS control panel, in accordance with <br>  with file extensions that you will have to download via http. </p><br><p>  I was not looking for what type of MIME is better suited for this purpose, and asked for <code>application/octet-stream</code> , after which it all worked. </p><br><p>  For files that have no extension, use a period. </p><br><p>  Like this: </p><br><p><img src="https://habrastorage.org/webt/zx/5s/-m/zx5s-mjbkbw1vd5z_bwrl0irtyu.png"></p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  In the end, we get the ability to boot on a local network through UEFI. </p><br><p>  If we did everything correctly, then there will be something like this boot selection menu: </p><br><p><img src="https://habrastorage.org/webt/gw/rw/a4/gwrwa4osswfqlolnyur-xpvbm8g.png"></p><br><p>  If you have the basic tools prepared and you will not bother with the configuration, then it takes about 10-20 minutes to implement this feature. <br>  It took me 2 working days because  I had to google a lot. </p><br><p>  Successful implementation! </p><br><p>  Thank you for your attention and many thanks to those people whose articles helped me! <br>  On Habr√© it: <a href="https://habr.com/ru/users/ingtar/" class="user_link">Ingtar</a> and <a href="https://habr.com/ru/users/deeptown/" class="user_link">Deeptown</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/448476/">https://habr.com/ru/post/448476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448462/index.html">AppCode 2019.1: Swift 5, improved backlight, navigation and autocompletion, moving expressions and more</a></li>
<li><a href="../448464/index.html">Simple implementation of multithreading in PHP</a></li>
<li><a href="../448470/index.html">Content marketing in the USA, Latin America and Asia: useful tips, links and tools for budget promotion</a></li>
<li><a href="../448472/index.html">How PROCESS_DUP_HANDLE turns into PROCESS_ALL_ACCESS</a></li>
<li><a href="../448474/index.html">We are looking for memory leaks in Python applications</a></li>
<li><a href="../448478/index.html">Moon mission "Bereshit" - the preliminary cause of the accident was announced</a></li>
<li><a href="../448480/index.html">Docker user</a></li>
<li><a href="../448482/index.html">Factory testing of modular data center</a></li>
<li><a href="../448484/index.html">Aboriginal microbes</a></li>
<li><a href="../448486/index.html">‚ÄúIn November of 2018, we accidentally fell into spam on all fronts.‚Äù How I saved mailing with the company with a million base</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>