<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Logging in a distributed php application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article will talk about the benefits of logging. I will tell about logs on PSR. I‚Äôll add some personal recommendations for working with the level,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Logging in a distributed php application</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/xm/rd/rj/xmrdrjy7rtwa8f2__bcbjrdry4y.png"></p><br><p>  The article will talk about the benefits of logging.  I will tell about logs on PSR.  I‚Äôll add some personal recommendations for working with the level, message, and context of the logged event.  An example will be given of how to organize logging and monitoring using ELK in an application written in Laravel and launched via Docker in several instances.  Sign for an important rule of the alert system.  I will give an example of a script that raises the whole monitoring stack with one team. </p><a name="habracut"></a><br><h2 id="polza-logirovaniya">  The benefits of logging </h2><br><p>  Well-organized logging allows at least the following: </p><br><ul><li>  Know that something is not going as planned (there are errors) </li><li>  Know the details of the error, which will help to say with whom and where the error occurred, and to prevent a repeat </li><li>  Know that everything goes as planned (access.log, debug-, info-levels) </li></ul><br><p>  By itself, writing to the log will not tell you all this, but with the help of logs you will be able to find out the details of events on your own, or set up a log monitoring system that will be able to report problems.  If the messages in the logs are accompanied by a sufficient amount of context, this greatly simplifies debugging, because you will have more data available about the situation in which the event occurred. </p><br><h2 id="chem-pisat-i-chto-pisat">  What to write and what to write </h2><br><p> Part of the php community developed recommendations for some of the tasks of writing code.  One such recommendation is the <a href="https://www.php-fig.org/psr/psr-3/">PSR-3 Logger Interface</a> .  She just describes what you need to log.  For this, the <code>Psr\Log\LoggerInterface</code> of the "psr / log" package has been developed.  When using it, you need to know about the three components of the event: </p><br><ol><li>  <strong>Level</strong> - event importance </li><li>  <strong>Message</strong> - text describing the event </li><li>  <strong>Context</strong> - an array of additional information about the event </li></ol><br><h3 id="urovni-sobytiya-po-psr-3">  PSR-3 Event Levels </h3><br><p>  The levels are borrowed from RFC 5424 - The Syslog Protocol, a rough description of their following: </p><br><ul><li>  debug - Detailed debugging information. </li><li>  info - Interesting events </li><li>  notice - Significant events, but not errors </li><li>  warning - Exceptional cases, but not errors </li><li>  error - Execution errors that do not require short-term intervention. </li><li>  critical - critical states (system component unavailable, unexpected exception) </li><li>  alert - Action requires immediate intervention. </li><li>  emergency - The system does not work </li></ul><br><p>  There is a description, but it is not always easy to follow them, due to the difficulty of determining the importance of certain events.  For example, in the context of a single request, it was not possible to access the connected resource.  When recording this event, we do not know whether one such request failed, and maybe only one user has such requests fail.  It depends on it, it requires immediate intervention, or it is a rare case, it can wait, or even it can be ignored.  Such issues are resolved in the framework of monitoring logs.  But the level is still necessary to determine.  Therefore, the levels of logging in the team can be negotiated.  Example: </p><br><ul><li>  <strong>emergency</strong> is a level for external systems that can look at your system and accurately determine that it does not fully work, or its self-diagnosis does not work. </li><li>  <strong>alert</strong> - the system itself can diagnose its state, for example, with a scheduled task, and as a result, record an event with this level.  These can be checks of connected resources or something specific, for example, a balance in the account of an external resource used. </li><li>  <strong>critical</strong> - an event when a component of the system fails, which is very important and should always work.  This is highly dependent on what the system does.  Suitable for events that are important to quickly find out, even if it happened only once. </li><li>  <strong>error</strong> - an event has occurred, which should be reported when soon repeating.  Could not perform an action that must be performed, but at the same time such an action does not fall under the description of critical.  For example, it was not possible to save the user's avatar by his request, but the system is not a service of avatars, but a chat system. </li><li>  <strong>warning</strong> - events for immediate notification of which you need to dial a significant number of them over a period of time.  Failed to perform an action, the failure of which does not break anything serious.  These are still errors, but the correction of which may await the work schedule.  For example, it was not possible to save the user's avatar, and the system was an online store.  Notification is needed (at high frequency) to find out about sudden anomalies, because they can be symptoms of more serious problems. </li><li>  <strong>notice</strong> are events that report system deviations that are part of the normal operation of the system.  For example, the user specified the wrong password at the entrance, the user did not fill in the middle name, but it is not necessary, the user bought the order for 0 rubles, but you have this provided in rare cases.  Notification of them at high frequency is also necessary, since a sharp increase in the number of deviations may be the result of an error that must be urgently corrected. </li><li>  <strong>info</strong> - events, the occurrence of which reports the normal functioning of the system.  For example, a user has registered, a user has purchased a product, a user has left a review.  Notification of such events should be set up in the opposite way: if an insufficient number of such events occurred during a period of time, then they should be notified, because their decrease could be caused by an error. </li><li>  <strong>debug</strong> - events for debugging any process in the system.  If you add enough data to the event context, you can diagnose the problem, or you can conclude that the process is functioning properly in the system.  For example, a user opened a product page and received a list of recommendations.  Significantly increases the number of events sent, so it is permissible to remove logging of such events after some time.  As a result, the number of such events in the normal operation will be variable, then monitoring to notify them can be omitted. </li></ul><br><h3 id="soobschenie-sobytiya">  Event message </h3><br><p>  For PSR-3, the message must be either a string or an object with the <code>__toString()</code> method.  In addition, according to PSR-3, the message string may contain placeholders of the type <code>‚ÄùUser {username} created‚Äù</code> , which can be replaced with values ‚Äã‚Äãfrom the context array.  When using Elasticsearch and Kibana for monitoring, I recommend not using placeholders, but writing fixed lines, because this will simplify event filtering, and the context will always be near.  In addition, I propose to pay attention to the additional requirements for the message: </p><br><ol><li>  The text should be short but meaningful.  This is what will come in alerts, and that will be in the lists of events. </li><li>  Text is better to be unique for different parts of the program.  This will make it possible to understand from an alert, without looking into the context, in which part the event occurred. </li></ol><br><h3 id="kontekst-sobytiya">  Event context </h3><br><p>  The event context for PSR-3 is an array (can be nested) of variable values, for example, entity IDs.  The context can be left blank if the message says everything about the event.  If an exception is logged, the entire exception should be passed, not just <code>getMessage()</code> .  When using Monolog via <a href="https://github.com/Seldaek/monolog/blob/master/src/Monolog/Formatter/NormalizerFormatter.php">NormalizerFormatter,</a> useful data will be automatically extracted from the exclusion and added to the context of the event, including the glasstrack.  That is, instead of </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'exception'</span></span> =&gt; $exception-&gt;getMessage(), ]</code> </pre> <br><p>  use </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'exception'</span></span> =&gt; $exception, ]</code> </pre> <br><p>  In Laravel, you can automatically enter data into the context for events.  This can be done through the <a href="https://laravel.com/docs/5.8/errors">Global Log Context</a> (only for uncaught exceptions or through <code>report()</code> ), or through the LogFormatter (for all events).  Usually, information is added with the current user id, the request URI, IP, request UUID, and the like. </p><br><p>  When using Elasticsearch as a log repository, remember that it uses fixed data types.  That is, if you passed in the context of <code>customer_id</code> number, then when you try to save an event with a different type, for example, a string (uuid), then such a message will not be recorded.  Types in the index are fixed when they first receive the value.  If indexes are created every day, then the new type will be recorded only on the next day.  But even this will not get rid of all the problems, because for Kibana the types will be mixed and some of the operations associated with the type will be unavailable until there are mixed indexes. </p><br><p>  To prevent this problem, I recommend sticking to the rules: </p><br><ul><li>  Do not use too general key names, which may be of different types. </li><li>  Make an explicit cast to a value type if there is no certainty about its type. </li></ul><br><p>  Example: instead of </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'response'</span></span> =&gt; $response-&gt;all(), <span class="hljs-string"><span class="hljs-string">'customer_id'</span></span> =&gt; $id, <span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; $someValue, ]</code> </pre> <br><p>  use </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'smsc_response_data'</span></span> =&gt; json_encode($response-&gt;all()), <span class="hljs-string"><span class="hljs-string">'customer_id'</span></span> =&gt; (string) $customer_id, <span class="hljs-string"><span class="hljs-string">'smsc_request_some_value'</span></span> =&gt; (string) $someValue, ]</code> </pre> <br><h3 id="vyzov-loggera-iz-koda">  Call logger from code </h3><br><p>  To quickly record events in the log, you can think of several options.  Consider some of them. </p><br><ol><li>  Declare a global <code>log()</code> function and call it from different parts of the program.  This approach has many drawbacks.  For example, in classes where we refer to this function, an implicit dependency is formed.  This should be avoided.  In addition, such a logger is difficult to configure when the system needs to have several different ones.  Another disadvantage, if we are talking about working with Laravel, is that we do not use the opportunities provided by the framework to solve this problem. </li><li>  Use Laravel facade \ Log.  With this approach, the parts of the system that access this facade begin to depend on the framework.  In parts of the system that we are not going to take out from under the framework, such a solution is quite suitable.  For example, writing from some instances of the console command, background task, controller.  Or when there is already an intricate structure of services, and it is not so easy to throw an instance of the logger into them. </li><li>  Resolve the logger dependency through the <code>app()</code> and <code>resolve()</code> helpers.  The approach has the same drawbacks as the use of the facade, but you need to write a little more code. </li><li>  Specify a dependency on the logger in the class constructor that this logger will use.  In this case, the same <code>LoggerInterface</code> should be specified as the type in order to comply with the <a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">DIP</a> .  Thanks to autowiring frameworks, dependencies are automatically resolved to implement according to their declared abstractions.  In Laravel, in some classes, dependencies can be specified in a separate method, instead of being specified in the constructor of the entire class. </li></ol><br><h3 id="gde-v-kode-vyzyvat-logger">  Where in the code to call the logger </h3><br><p>  When organizing code in a project, a question may arise in which class should I write to the log.  Should it be a service?  Or it needs to be done where the service is called from: controller, background task, console command?  Or should each exception itself decide what to write to the log using its <code>report</code> (Laravel) method?  There is no simple answer to all questions at once. </p><br><p>  Consider the <a href="https://laravel.com/docs/5.8/errors">ability</a> , given by Laravel, to delegate to the exception class the task of logging itself.  An exception cannot know how critical it is for the system to determine the level of an event.  In addition, an exception does not have access to the context, unless it is specifically added when this exception is raised.  To call the <code>render</code> method on an exception, you must either not catch the exception (the global ErrorHandler will be used), or catch and use the global helper <code>report()</code> .  This method allows not to call the PSR-3 logger every time we can catch this exception.  But I do not think that for the sake of this it is worth giving the exception such responsibility. </p><br><p>  It may seem that we can always log only in services.  Indeed, in some services you can make logging.  But consider a service that does not depend on the project and, in general, we plan to bring it into a separate package.  Then this service is not aware of its importance in the project, and, therefore, will not be able to determine the level of logging.  For example, an integration service with a specific SMS gateway.  If we get a network error, it does not mean that it is serious enough.  Perhaps the system has an integration service with another SMS gateway, through which there will be a second attempt to send, then the error from the first can be reported as warning, and the error of the second as error.  Only all these integrations should be called from another service, which will be logged.  It turns out that the error is in one service, and log in the other.  But sometimes we do not have a wrapper service over another service ‚Äî we call it directly from the controller.  In this case, I consider it permissible to write to the log in the controller instead of writing a service decorator for logging. </p><br><p>  Example showing dependency usage and context passing: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Commands</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>\<span class="hljs-title"><span class="hljs-title">ExampleService</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Log</span></span>\<span class="hljs-title"><span class="hljs-title">LoggerInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Example</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $signature = <span class="hljs-string"><span class="hljs-string">'example'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExampleService $service, LoggerInterface $logger)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $service-&gt;example(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $exception) { $logger-&gt;critical(<span class="hljs-string"><span class="hljs-string">'Example error'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'exception'</span></span> =&gt; $exception, ]); } } }</code> </pre><br><h2 id="kuda-pisat">  Where should i write </h2><br><p>  According to the <a href="https://12factor.net/ru/logs">12 factorial application</a> , you need to write to the stdout, stderr of the application runtime.  It would be possible to specify <code>php://stdout</code> in the logger config, but due to the <a href="https://github.com/docker-library/php/issues/207">peculiarity of</a> php-fpm 7.2 in the official docker image we get to docker logs </p><br><blockquote>  [21-Mar-2016 14:10:02] WARNING: [pool www] child 12 said into stdout: "2016-03-21 14:10:02 [xxxx] [-] [-] [info] Session started" </blockquote><p>  And the length of such a message is limited (cropped). <br>  UPD: This problem is not in php-fpm 7.3, but this does not mean that all the options below have become useless. </p><br><p>  Consider solutions to the problem. </p><br><ol><li>  Ignore 12-factor, docker-way and write to files.  Laravel (Monolog) can even customize the rotation of the logs.  Further, messages from files can be collected using Filebeat and sent to Logstash for analysis. </li><li>  Write to the fifo file by redirecting its contents to the stderr docker container.  Read more about this solution <a href="https://github.com/docker-library/php/issues/207">here</a> . </li><li>  We can combine both solutions.  Write to files that will be collected with Filebeat and sent to Logstash.  Write to the stderr container in order to be able to use <code>docker logs</code> commands and be ready for conveniently collecting logs from the container orchestration environment. </li><li>  Send logs from the application directly further, for example, via UDP to increase performance. </li></ol><br><p>  Record format options: </p><br><ul><li>  Human-readable (line breaks, indents, etc.) </li><li>  Machine readable (usually json) </li><li>  Both formats are simultaneously: machine-readable in stdout for further routing, human-readable in case of sudden problems with routing and fast debug </li></ul><br><p>  Any of the options assumes that the logs are routed ‚Äî at least, sent to a single log processing (storage) system for the following reasons: </p><br><ol><li>  Long-term storage and archiving </li><li>  Building large-scale trend plots </li><li>  Flexible event notification system </li></ol><br><p>  The docker has the ability to specify a log manager.  The default is <code>json-file</code> , that is, the docker adds the output from the container to the json-file on the host.  If we choose a log manager that will send records somewhere over the network, then we will no longer be able to use the <code>docker logs</code> .  If the container's stdout / stderr was chosen as the only place to record application logs, then in case of network problems or problems at the single storage, it may not be possible to quickly retrieve the records for debug. </p><br><p>  We can use json-file docker and filebeat.  We will receive both local logs and further routing.  It is worth noting here another feature of the docker.  When recording an event longer than 16KB, the docker breaks the entry with the <code>\n</code> character, which confuses many log collectors.  This is an <a href="https://github.com/moby/moby/issues/34855">issue</a> .  The problem with the side of the docker was not resolved, so it was decided by the collectors.  From some versions, Filebeat <a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-docker.html">supports</a> this docker behavior and correctly merges events. </p><br><p>  You can decide for yourself what your project will be the combination of all the possibilities of destinations and recording formats. </p><br><h2 id="ispolzovanie-filebeat--elk--elastalert">  Using Filebeat + ELK + Elastalert </h2><br><p>  Briefly, the role of each service can be described as: </p><br><ul><li>  Filebeat - collects events from files and sends </li><li>  Logstash - parses the event and sends </li><li>  Elasticsearch - stores structured events </li><li>  Kibana - displays events (graphs, aggregations, etc.) </li><li>  Elastalert - sends alerts based on requests </li></ul><br><p>  Additionally, you can: zabbix, metricbeat, grafana, and more. </p><br><p>  Now more about each. </p><br><h3 id="filebeat">  Filebeat </h3><br><p>  It can be run as a separate service on the host, it can be a separate docker container.  To work with the stream of events from docker it uses the host path <code>/var/lib/docker/containers/*/*.log</code> .  Filebeat has a wide <a href="https://www.elastic.co/guide/en/beats/filebeat/master/filebeat-input-container.html">range of options</a> that can be used to set behavior in various situations (the file is renamed, the file is deleted, and so on).  Filebeat can parse json itself inside an event, but not json can get into the events, which will lead to an error.  All event processing is best done in one place. </p><br><div class="spoiler">  <b class="spoiler_title">Snippet configuration for filebeat 6</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">filebeat.inputs: - type: docker containers: ids: - "*" processors: - add_docker_metadata: ~</code> </pre></div></div><br><h3 id="logstash">  Logstash </h3><br><p>  Able to receive events from many sources, but here we are considering Filebeat. <br>  In each event, except for the event itself from stdout / stderr, there is metadata (host, container, etc.).  There are many built-in processing filters: parsing according to regulars, parsing json, changing, adding, deleting fields, etc. Suitable for parsing both application logs and nginx access.log in an arbitrary format.  It can transfer data to different storages, but here we consider Elasticsearch. </p><br><div class="spoiler">  <b class="spoiler_title">Logstash filter configuration fragment</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">if [status] { date { match =&gt; ["timestamp_nginx_access", "dd/MMM/yyyy:HH:mm:ss Z"] target =&gt; "timestamp_nginx" remove_field =&gt; ["timestamp_nginx_access"] } mutate { convert =&gt; { "bytes_sent" =&gt; "integer" "body_bytes_sent" =&gt; "integer" "request_length" =&gt; "integer" "request_time" =&gt; "float" "upstream_response_time" =&gt; "float" "upstream_connect_time" =&gt; "float" "upstream_header_time" =&gt; "float" "status" =&gt; "integer" "upstream_status" =&gt; "integer" } remove_field =&gt; [ "message" ] rename =&gt; { "@timestamp" =&gt; "event_timestamp" "timestamp_nginx" =&gt; "@timestamp" } } }</code> </pre> </div></div><br><h3 id="elasticsearch">  Elasticsearch </h3><br><p>  Elasticsearch is a very powerful tool for a wide range of tasks, but for the purpose of monitoring logs, you can use it knowing only a certain minimum. <br>  Saved events are documents, documents are stored in indexes. <br>  Each index is a scheme in which a type is defined for each field of a document.  You cannot save an event in the index if at least one field has an unsuitable type. <br>  Different types allow you to do different operations on a group of documents (for numbers - sum, min, max, avg, etc., for strings - fuzzy search, and so on). <br>  For management logs, it is usually recommended to use daily indices - every day a new index. </p><br><p>  Ensuring the stable operation of Elasticsearch with the growth of data is a task that requires deeper knowledge of this tool.  But a quick solution to the stability problem is to automatically delete obsolete data.  For this, I propose to break the event levels in different indexes in logstash.  This will allow longer to store rare, but more important events. </p><br><div class="spoiler">  <b class="spoiler_title">Logstash Output Configuration Fragment</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">output { if [fields][log_type] == "app_log" { if [level] in ["DEBUG", "INFO", "NOTICE"] { elasticsearch { hosts =&gt; "${ES_HOST}" index =&gt; "logstash-app-log-debug-%{+YYYY.MM.dd}" } } else { elasticsearch { hosts =&gt; "${ES_HOST}" index =&gt; "logstash-app-log-error-%{+YYYY.MM.dd}" } } } }</code> </pre> </div></div><br><p>  To automatically delete outdated indexes, I suggest using a program from Elastic <a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/index.html">Curator</a> .  The launch of the program is added to the Cron schedule, the configuration itself can be stored in a separate file. </p><br><div class="spoiler">  <b class="spoiler_title">Configuration snippet to remove obsolete indexes</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">action: delete_indices description: logstash-app-log-error options: ignore_empty_list: True filters: - filtertype: pattern kind: prefix value: logstash-app-log-error- - filtertype: age source: name direction: older timestring: '%Y.%m.%d' unit: months unit_count: 6</code> </pre> </div></div><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For durable event storage, I suggest using alternative storage systems that can be connected as reception services from Filebeat or Logstash, or completely separately. </font><font style="vertical-align: inherit;">In recent versions, Elasticsearch introduced partitioning into </font></font><a href="https://www.elastic.co/blog/implementing-hot-warm-cold-in-elasticsearch-with-index-lifecycle-management"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hot-warm-cold indices</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , perhaps you should consider them.</font></font></p><br><h3 id="kibana"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kibana </font></font></h3><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kibana is used here as a tool to read the event log. </font><font style="vertical-align: inherit;">This is a web application that makes requests to Elasticsearch. </font><font style="vertical-align: inherit;">Allows you to build dashboards with different visualizations of indicators.</font></font></p><br><p>   Kibana ‚Äî         Discovery   . ,   Discovery       app   warning  ,    time, message, exception class, host, client_id. </p><br><p>  ,  Discovery       nginx,       404    time, message, request, status. <br>   Kibana   ,        :  ,  ,     . ,       (        ). </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/c1d/feb/5a3/c1dfeb5a364508015c4787f5e457528a.jpg" alt="image"></p></div></div><br><h3 id="elastalert"> Elastalert </h3><br><p> Elastalert      Elasticsearch      .  , .   <a href="https://elastalert.readthedocs.io/en/latest/ruletypes.html">  </a> ,          . <br>       ,         (),       . </p><br><p>   : </p><br><ul><li>       ALERT, EMERGENCY.  ‚Äî 10  </li><li>       CRITICAL.  ‚Äî 30  </li><li>    ,  N   X  M  </li><li>    10 INFO  3  </li><li>   nginx   200, 201, 304     75%  ,     50  </li></ul><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Blacklist ALERT, EMERGENCY type: blacklist index: logstash-app-* compare_key: "level" blacklist: - "ALERT" - "EMERGENCY" realert: minutes: 5 alert: - "slack"</code> </pre></div></div><br><p>             ‚Äî <strong>  </strong> .       ,      ,   .        Kibana. </p><br><p>    , ,   http-     75%  ,     ,   ,     ,    .  -   ,     ,      ,     . </p><br><p>         , ,  ,     ,       Kibana,        . </p><br><p>    5     .    , ,     ,  ,  ,     . </p><br><p>      ,          .       . </p><br><p>            Kibana    .            . </p><br><h2 id="vsyo-vmeste">   </h2><br><p>      docker-.     ,         ,    staging-  production-,      . </p><br><p>   ,   Elastalert,      .  Elastalert  ,    <br> <code>envsubst &lt; /opt/elastalert/config.dist.yaml &gt; /opt/elastalert/config.yaml</code>  entrypoint-   ,   . </p><br><p>        ,       ,       ,     . </p><br><div class="spoiler"> <b class="spoiler_title">    Makefile       </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">build: docker build -t some-registry/elasticsearch elasticsearch docker build -t some-registry/logstash logstash docker build -t some-registry/kibana kibana docker build -t some-registry/nginx nginx docker build -t some-registry/curator curator docker build -t some-registry/elastalert elastalert push: docker push some-registry/elasticsearch docker push some-registry/logstash docker push some-registry/kibana docker push some-registry/nginx docker push some-registry/curator docker push some-registry/elastalert pull: docker pull some-registry/elasticsearch docker pull some-registry/logstash docker pull some-registry/kibana docker pull some-registry/nginx docker pull some-registry/curator docker pull some-registry/elastalert prepare: docker network create -d bridge elk-network || echo "ok" stop: docker rm -f kibana || true docker rm -f logstash || true docker rm -f elasticsearch || true docker rm -f nginx || true docker rm -f elastalert || true run-logstash: docker rm -f logstash || echo "ok" docker run -d --restart=always --network=elk-network --name=logstash -p 127.0.0.1:5001:5001 -e "LS_JAVA_OPTS=-Xms256m -Xmx256m" -e "ES_HOST=elasticsearch:9200" some-registry/logstash run-kibana: docker rm -f kibana || echo "ok" docker run -d --restart=always --network=elk-network --name=kibana -p 127.0.0.1:5601:5601 --mount source=elk-kibana,target=/usr/share/kibana/optimize some-registry/kibana run-elasticsearch: docker rm -f elasticsearch || echo "ok" docker run -d --restart=always --network=elk-network --name=elasticsearch -e "ES_JAVA_OPTS=-Xms1g -Xmx1g" --mount source=elk-esdata,target=/usr/share/elasticsearch/data some-registry/elasticsearch run-nginx: docker rm -f nginx || echo "ok" docker run -d --restart=always --network=elk-network --name=nginx -p 80:80 -v /root/elk/.htpasswd:/etc/nginx/.htpasswd some-registry/nginx run-elastalert: docker rm -f elastalert || echo "ok" docker run -d --restart=always --network=elk-network --name=elastalert --env-file=./elastalert/.env some-registry/elastalert run: prepare run-elasticsearch run-kibana run-logstash run-elastalert delete-old-indices: docker run --rm --network=elk-network -e "ES_HOST=elasticsearch:9200" some-registry/curator curator --config /curator/curator.yml /curator/actions.yml</code> </pre> </div></div><br><p>      : </p><br><ul><li>    80  nginx,     basic auth  Kibana </li><li>  Logstash  .       ssh- </li><li>       nginx </li><li>    ,  docker- </li><li>           </li><li>          </li><li>       ,  .env-    nginx- </li><li>  *_JAVA_OPTS   ,          4GB RAM (        ES). </li></ul><br><p>  ,          xpack-. </p><br><p>    docker-compose. ,   ,   Dockerfile-,  Filebeat,  Logstash,  ,   ,     ,    ,        VCS. </p><br><p>       .      .     ,    ( Laravel    scheduler), ,     5   .          ALERT.     ,    .    ,     ,      . </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  ,      ,    ,           .       . ,   -      .              .   ,   ,  . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/456676/">https://habr.com/ru/post/456676/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../456664/index.html">Who to sue when the robot loses your money</a></li>
<li><a href="../456666/index.html">WebTotem or how we want to make the Internet safer</a></li>
<li><a href="../456670/index.html">About a very spy authentication method</a></li>
<li><a href="../456672/index.html">Nginx recipes: asynchronous notifications from PostgreSQL to websocket</a></li>
<li><a href="../456674/index.html">New features for Facebook promotion that you didn't know about</a></li>
<li><a href="../456680/index.html">Eight named laws in UX design (part 2)</a></li>
<li><a href="../456682/index.html">Undefined behavior with outdated ANSI C function declarations</a></li>
<li><a href="../456684/index.html">Fixing minor bug in calc.exe</a></li>
<li><a href="../456686/index.html">The subtleties of interviewing when hiring a remote</a></li>
<li><a href="../456690/index.html">Everyday Headphones by Case Guru - CGPods Sport</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>