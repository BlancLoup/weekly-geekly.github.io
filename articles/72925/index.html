<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring mysql for ssl replications (Debian, Ubuntu)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is for those who need to set up master-slave replication on the mysql server using a secure connection. When the need arose, I was faced ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring mysql for ssl replications (Debian, Ubuntu)</h1><div class="post__text post__text-html js-mediator-article">  This article is for those who need to set up master-slave replication on the mysql server using a secure connection.  When the need arose, I was faced with a lack of information in Russian about configuring replication and almost no information at all, how to do it using ssl.  In the end, I managed to raise replication.  I want to share my experience and broken links. <a name="habracut"></a><br><br>  The following installation commands are examples of configuration files related to debian-like systems (including ubuntu).  In other distributions they may differ.  For example, to install programs in RH and CentOS instead of ‚Äúapt-get install‚Äù you need to write ‚Äúyum install‚Äù. <br>  The article is relevant, starting from August 2009 until such time as the developers of the programs used here do not change anything. <br>  Mysql-server-5.0, Ubuntu 8.04-9.04 and the corresponding Debian. <br><br><h4>  Preparatory work - make the keys </h4><br>  Further it will be told how to configure replications.  If the safety of the connection does not bother you, this item is not for you. <br>  The muscle settings file suggests using prog-tinika to create keys: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code># For generating SSL certificates I recommend the OpenSSL GUI "tinyca".</code> <br> <br>  I listened to it, although true Linux users are required to create keys from the command line.  If you do not labor, then: <br><br> <code>sudo apt-get install tinyca <br> sudo tinyca2</code> <br> <br>  In the program you need: <br><ol><li>  Create CA certificate (set Common Name parameter in cacert).  Next, create a certificate and key (created in pairs) for the server and the client (do not forget to enter the password of the CA certificate that we invented when we created it). </li><li>  Export the CA certificate and server and client certificates to the PEM format with the names cacert.pem, my-server-cert.pem and my-client-cert.pem respectively. </li><li>  Export the server and client keys ( <b>note</b> , the Without passphrase = Yes option, otherwise muscular will not be able to decrypt your certificate, it will require the CA certificate password) to the PEM format with the names my-server-key.pem and my-client-key.pem, respectively. </li><li>  Give all 5 files read permissions to the owner and group, no write permissions.  Well, make sure that Muskul was either the owner or was a member of the group. </li></ol><br><br>  Commands to change rights and owners in order of mention: <br><br> <code>chmod 440 *.pem <br> chown root:mysql *.pem</code> <br> <br>  A CA certificate is an author's certificate; it serves to bundle server and client certificates.  The server will need a certificate and server key, on the client a certificate and a client key, and both will need the author's certificate - cacert. <br><br><h4>  Configure the master server </h4><br>  In debian-like systems (at least) the command is specified in the file my.cnf <br><br> <code>!includedir /etc/mysql/conf.d/</code> <br> <br>  which says include all configuration files (* .cnf) from the specified directory.  Create a replica.cnf file there with the following content: <br><br> <code>[mysqld] <br> log-bin = /var/log/mysql/mysql-bin.log <br> slave-compressed = 1 <br> binlog-do-db = mydb <br> server-id = 1 <br> <br> # ssl params <br> ssl-ca=/etc/mysql/my-cacert.pem <br> ssl-cert=/etc/mysql/my-server-cert.pem <br> ssl-key=/etc/mysql/my-server-key.pem</code> <br> <ul><li>  log-bin - the path to the binary logging database change file. </li><li>  slave-compressed - allows you to compress the data transmitted from the master to the slave </li><li>  binlog-do-db - the name of the database that we are going to replicate </li><li>  server-id - server identifier, must be unique within interconnected servers </li></ul><br><br>  The ssl parameters are specified if there is a desire to protect the connection for replications.  The previously created keys are indicated.  Put them in the muscle folder, next to my.cnf.  My attempts to put them in the / etc / mysql / certs / folder resulted in errors like "I can not get a certificate from a file ...".  Perhaps there are solutions for other folders, but I did not begin to look for them. <br><br>  After the movements made, you need to overload the muscle, go into it and see <br><br> <code>SHOW VARIABLES LIKE '%ssl%';</code> <br> <br>  In the answer, the have_ssl and / or have_openssl parameter has the value YES in the case of sucks, and DISABLED in all bad other cases (the absence of the parameter indicates that your muscle assembly does not support ssl).  If yes we did not find us, go to the logs to look for the cause: /var/log/mysql.log, /var/log/mysql.err, / var / log / syslog or somewhere else, depending on where the muscle is configured to log itself on your system. <br><br>  We also need to set up a separate user for replications.  This is solved by executing the request. <br><br> <code>GRANT REPLICATION SLAVE ON *.* TO 'slave_user'@'%.slave.domain' IDENTIFIED BY 'slave_password' require SSL</code> <br> <br>  In case security does not bother us, the words ‚Äúrequire SSL‚Äù should be omitted.  In the domain name ‚Äú%‚Äù works the same as ‚Äú*‚Äù in the entry ‚Äú* .cnf‚Äù. <br><br>  Now the same user needs to be given rights to read our database tables: <br><br> <code>GRANT SELECT ON mydb.* TO 'slave_user'@'%.slave.domain' IDENTIFIED BY 'slave_password' require SSL</code> <br> <br>  In other docks, there are instructions to give the rights SUPER or even ALL, but I did not do it, but it works all the same. <br><br><h4>  Transfer the DB to the slave </h4><br>  Before creating a database dump, you need to lock the tables - in order to avoid trouble: <br><br> <code>USE mydb; <br> FLUSH TABLES WITH READ LOCK;</code> <br> <br>  Next, look at the status of the wizard: <br><br> <code>SHOW MASTER STATUS;</code> <br> <br>  And we will write down the values ‚Äã‚Äãof the File and Position fields on the list - they will still be useful to us.  I had these values ‚Äã‚Äãmysql-bin.000002 and 412 respectively.  It is important not to get lost in zeros :) <br><br>  Now we will dump the database: <br><br> <code>mysqldump -u slave_user -pslave_password --opt mydb &gt; mydb.sql</code> <br> <br>  Due to the fact that we have given our slave few rights, this command may be cursed (I did not try it, did a dump via <a href="http://www.webmin.com/">webmin</a> ).  In this case, either add permissions to the user, or dump from under another user. <br><br>  Finally, unlock the tables: <br><br> <code>UNLOCK TABLES;</code> <br> <br>  And rewrite the dump to the server slave. <br><br><h4>  Connect client </h4><br>  On the client-slave server you need to fill in the data in the database: <br><br> <code>mysql -u root -p <br> [create database mydb] <br> [use mydb] <br> source /path/to/mydb.sql <br> exit</code> <br> <br>  In square brackets there are commands that are not necessary to execute if you already have database creation commands in your mydb.sql script. <br><br>  Although it is written in other instructions, I did not create the user slave_user and give him any rights on the client server.  If that - links at the end of the article to you in clicks. <br><br>  Next, create the file /etc/mysql/conf.d/replica.cnf <br><br> <code>[mysqld] <br> server-id = 2 <br> <br> [client] <br> # ssl params <br> ssl-ca=/etc/mysql/my-cacert.pem <br> ssl-cert=/etc/mysql/my-client-cert.pem <br> ssl-key=/etc/mysql/my-client-key.pem</code> <br> <br>  The second client part is for secure connections.  The main thing is not to forget to put the previously created keys in the specified folder. <br><br>  Overload the muscle, go into it and execute a series of commands: <br><br> <code>SLAVE STOP; <br> <br> CHANGE MASTER TO <br> MASTER_HOST='master.host.ru', <br> MASTER_USER='slave_user', <br> MASTER_PASSWORD='slave_password', <br> MASTER_LOG_FILE='mysql-bin.000002', <br> MASTER_LOG_POS=412, <br> MASTER_CONNECT_RETRY=30, <br> <br> MASTER_SSL = 1, <br> MASTER_SSL_CA = '/etc/mysql/my-cacert.pem', <br> MASTER_SSL_CERT = '/etc/mysql/my-client-cert.pem', <br> MASTER_SSL_KEY = '/etc/mysql/my-client-key.pem' <br> <br> START SLAVE;</code> <br> <br><ul><li>  MASTER_HOST - host name (or IP address) of the master server </li><li>  MASTER_LOG_FILE and MASTER_LOG_POS - data received from the master server and recorded previously on the list </li><li>  MASTER_CONNECT_RETRY - time (in seconds) until the next attempt to connect with the master in the event of a disconnection </li><li>  MASTER_SSL - set to 1 if you want to use a secure connection, otherwise - 0. If you set 0, then do not specify the MASTER_SSL_CA, MASTER_SSL_CERT and MASTER_SSL_KEY parameters either. </li></ul><br><br>  At the moment, replication should already work :) <br>  Check by changing the data on the server.  Almost immediately (a few seconds difference) they should change on the client.  If it does not change, go to the logs to look for reasons.  Or we go to read other docks: <br><br><h4>  If not earned </h4><br>  The article describes how I raised replication on my own servers.  Perhaps due to differences in settings or for other reasons you will not be able to make everything work.  Then I can only leave links to resources that have helped me. <br><br>  <a href="http://www.opennet.ru/tips/info/1696.shtml">http://www.opennet.ru/tips/info/1696.shtml</a> - rusish, without ssl, do not forget to read kamenty (there are useful) <br>  <a href="http://www.webnext.ru/blog/2007/08/21/replication-mysql-master-slave.html">http://www.webnext.ru/blog/2007/08/21/replication-mysql-master-slave.html</a> - Russian, without ssl, at a gallop across Europe <br>  <a href="http://dibaliklayar.blogspot.com/2006/10/replication-of-mysql-50-using-ssl.html">http://dibaliklayar.blogspot.com/2006/10/replication-of-mysql-50-using-ssl.html</a> - English, with ssl, was read without attention, because I found it already after hitting my forehead <br><br>  Shl.  Yes, I found a fairly detailed and useful description of setting up replications <a href="http://habrahabr.ru/blogs/mysql/56702/">here</a> .  Without ssl, but a lot of interesting. <br><br>  The second option is to ask in the comments, if not me, then other habra people will prompt.  You look, and earn. <br>  If there are explanations or comments - I ask you to write too, I myself am wondering why some things are needed, although it works without them. </div><p>Source: <a href="https://habr.com/ru/post/72925/">https://habr.com/ru/post/72925/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../72915/index.html">Zend Framework and magic quotes</a></li>
<li><a href="../72917/index.html">Apple is returning to using Twitter to promote content from the iTunes Store</a></li>
<li><a href="../72920/index.html">The script to automatically build qutIM from SVN for Linux</a></li>
<li><a href="../72923/index.html">Writing a basic wave robot in python</a></li>
<li><a href="../72924/index.html">Contests non stop!</a></li>
<li><a href="../72927/index.html">Simplicity in good web design</a></li>
<li><a href="../72929/index.html">Multithreading, general data and mutexes</a></li>
<li><a href="../72930/index.html">Jeff Dean reveals Google secrets</a></li>
<li><a href="../72932/index.html">Fee for free</a></li>
<li><a href="../72933/index.html">Super fast (and neat) robots from ABB</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>