<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Filling firmware in STM32 via USB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my project, I use the microcontroller STM32F103C8 and the stm32duino framework . This Arduino clone offers a special bootloader that allows you to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Filling firmware in STM32 via USB</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/50c/046/5e3/50c0465e38ec8d772f985a4cc26288a6.png" alt="image"><br><br>  In my project, I use the <a href="https://ru.aliexpress.com/item/Arm-cortex-m3-stm32f103c8t6-stm32-core-board-development-board/1539984258.html">microcontroller STM32F103C8</a> and the <a href="https://github.com/rogerclarkmelbourne/Arduino_STM32">stm32duino framework</a> .  This Arduino clone offers a special bootloader that allows you to upload firmware via USB, without using external components like ST-Link or USB-UART adapter. <br><br>  Today I needed to work with a bare controller from under CooCox and without stm32duino.  But that's the problem.  Even a simple blinker poured through this bootloader does not work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's figure it out.  Perhaps my calculations seem to someone commonplace.  But I am just starting to study the STM32 controllers and, in search of a problem, I killed at least half a day.  Suddenly this article will shorten the development time. <br><a name="habracut"></a><br>  I have nothing against ST-Link and other debuggers.  But it won't be in my finished device, but it will definitely be USB.  Why not immediately lay the opportunity to update the firmware via USB?  Personally, I find this method convenient.  the more so that all the same I have already connected a cord through which the power and USB Serial are going. <br><br>  Let's see how the bootloader works.  First, using the example of AVR controllers.  Why did I remember about him?  I switched from Arduino and subconsciously expected the same behavior.  But the STM32 turned out to be different.  Because I want to talk about the difference between these two microcontrollers. <br><br>  So.  In AVR ATMega microcontrollers, you can reserve a certain amount of memory under the bootloader near the end of the flash.  With the help of fuse bits, you can adjust from which address the program will start.  If there is no bootloader, the program starts from the address 0x0000.  If there is a bootloader, it starts from some other address (for example, in ATMega32 with 0x3C00, if the bootloader size is 2k). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/32a/c00/3a7/32ac003a7b0509cd8b322ba9b3ffc359.png" alt="image"></div><br>  When the bootloader has done its work, it transfers control to the main program from the address 0x0000.  Those.  the program always starts at address 0x0000.  The compiler and linker work taking into account the fact that the code will be located at the beginning of the address space. <br><br>  In STM32 microcontrollers, this is not the case.  All programs start at address 0x0800000.  The bootloader is not so special.  This is the same program that starts from the same starting address.  In the process of operation, the bootloader can receive firmware (via USB or UART, read from a flash drive, receive from a satellite, get from a whatever, ...) and write it to addresses higher than the bootloader itself.  And, of course, at the end of their work, to transfer control to the main program. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/82d/bdf/a0a/82dbdfa0ac179f37a3f8ee67cb4d4c44.png" alt="image"></div><br>  So when compiling the firmware, you need to know where the bootloader will write the firmware and adjust the addresses accordingly. <br><br>  On this with the theory of everything.  We proceed to practice.  Below is a step-by-step instruction on how to screw the USB bootloader to the STM32F1xx series microcontrollers, and maybe to some others too. <br><br>  There are, however, some limitations on circuitry.  Here I, unfortunately, is not strong.  ITP needs a pull-up resistor 1.5k for the PA12 port (also known as USB D +).  This allows the bootloader to connect and disconnect from USB at the right times. <br><br>  Instruction: <br><br><ul><li>  Downloading <a href="https://github.com/rogerclarkmelbourne/STM32duino-bootloader">github.com/rogerclarkmelbourne/STM32duino-bootloader</a> .  In the directory STM32F1 \ binaries there is already a package of compiled bootloaders for different boards.  The index at the end of the file name indicates where the LED is connected.  In the case of <a href="https://ru.aliexpress.com/item/Arm-cortex-m3-stm32f103c8t6-stm32-core-board-%250Adevelopment-board/1539984258.html">my board</a> where the LED is connected to pin C13, I used the file generic_boot20_pc13.bin. <br><br></li><li>  Flash <a href="https://geektimes.ru/post/277928/">according to the instructions</a> .  Yes, you will need a USB-UART adapter, but you can <a href="http://www.st.com/en/embedded-software/stsw-link004.html">also use the debugger</a> . <br><br></li><li>  Now the microcontroller is ready to be downloaded through the USB bootloader.  But you still need to correct the firmware itself.  And you need to do 2 things: <br><br><ul><li>  Specify the linker starting address.  In CooCox, this is done in the project settings, the Link tab, the Memory Areas section, the IROM1 Start Address.  The bootloader occupies the first 8 kilobytes, so the starting address of the firmware will be 0x0800000 + 0x2000 = 0x08002000.  Size field, probably, should also be reduced by 8k. <br><br></li><li>  Somewhere at the beginning of the program before the initialization of the periphery make a call <br><br><pre><code class="cpp hljs">NVIC_SetVectorTable(NVIC_VectTab_FLASH, <span class="hljs-number"><span class="hljs-number">0x2000</span></span>);</code> </pre> <br><br>  UPDATE 05/17/2018: In the current version of the STM32Cube, the function NVIC_SetVectorTable () is not.  Instead, you can fix the define VECT_TAB_OFFSET in the system_stm32f1xx.c file (or a similar one for another microcontroller). <br></li></ul><br></li><li>  The firmware firmware can be <a href="https://github.com/rogerclarkmelbourne/Arduino_STM32">taken from the stm32duino project</a> .  In the tools directory, look for a script called maple_upload.  I used only the screw version - maple_upload.bat. <br><br></li><li>  Run like this: <br><br><pre> <code class="hljs css">"<span class="hljs-selector-tag"><span class="hljs-selector-tag">maple_upload</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bat</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">COM20</span></span> 2 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">EAF</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0003</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">Path</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">To</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Firmware</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bin</span></span>"</code> </pre> <br>  Instead of COM20, you need to substitute your port where the microcontroller is hooked. <br><br>  Zalivator thing is very gentle, does not like relative paths.  so the path to the firmware must be specified completely. <br><br>  1EAF: 0003 is the VID and PID <br><br>  2 is the AltID parameter, which indicates that the firmware should be uploaded to the address 0x08002000 (read <a href="http://www.rogerclark.net/improved-maple-bootloader-for-stm32/">here</a> ). <br></li></ul><br>  Another bit of nuance.  Before uploading the firmware, you need to start the bootloader.  The easiest way is to press the reset button.  After that, the bootloader will start and the firmware will wait for a few seconds.  If at that moment nobody launched maple_upload, the loader will transfer control to the main firmware. <br><br>  In order not to press resets each time, motherboards based on libmaple / stm32duino use a trick.  They listen to usb serial port.  If a DTR signal appears there and a key sequence of bytes is transmitted, the microcontroller is reloaded into a bootloader.  See <a href="">rxHook () function</a> . <br><br>  This may cause inconvenience.  If the microcontroller zaglyuchil and hung, then he no longer listens to the port.  Therefore, he can not hear the key sequence and reboot into the bootloader.  Then only reset to help. <br><br>  That's all.  I hope my article will shed light on how the bootloader works in the STM32 and how you can download the firmware via the USB port.  Unfortunately, the threshold of entry is still high, but suddenly someone my article will help him overcome. </div><p>Source: <a href="https://habr.com/ru/post/403007/">https://habr.com/ru/post/403007/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../402995/index.html">BrickerBot malware turns IoT gadgets into "brick"</a></li>
<li><a href="../402997/index.html">First Time: A Short Review of the Movie</a></li>
<li><a href="../402999/index.html">Polyphasic sleep - a story of successful experience</a></li>
<li><a href="../403003/index.html">Scientists have developed bacteria that can detect colitis in mice.</a></li>
<li><a href="../403005/index.html">Fact-checking: who decides what to believe?</a></li>
<li><a href="../403009/index.html">Alizar has typed 5000 publications on Geektimes</a></li>
<li><a href="../403011/index.html">From head to toe: a few examples of smart clothes and accessories</a></li>
<li><a href="../403013/index.html">Study: perhaps the domestication of modern wolves</a></li>
<li><a href="../403015/index.html">Is a Hawking-Milner StarShot Possible?</a></li>
<li><a href="../403017/index.html">Cosmic virtual reality: a selection of Cosmonautics Day for children</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>