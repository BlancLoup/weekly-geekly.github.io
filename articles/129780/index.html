<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL Sharding on Yii Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To begin with, our project is at the initial stage of development, and its launch is planned for the 1st of November. And, in order to immediately cut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL Sharding on Yii Framework</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/de0719ab/25f3a83f/2e440616/2bb07b5c.jpg" align="left">  To begin with, our project is at the initial stage of development, and its launch is planned for the 1st of November.  And, in order to immediately cut off all possible criticism with regards to premature optimization, I would say that the team was tasked with developing an application to cope with abrupt load changes (from 1,000 to 50,000, etc.).  In this regard, it was decided to build a highly scalable architecture that allows you to easily and quickly increase system performance at the expense of the hardware (on the scale-out principle). <br><br><a name="habracut"></a><br><br>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br><h5>  Platform </h5><br>  We chose the platform quickly - it was decided to develop a project based on the Yii Framework.  I can briefly say that reviews of familiar developers inspired me to study it a year and a half ago, and the choice of yii, as a platform for developing this project, was made thanks to a long google, tests and comparative characteristics (such as <a href="http://www.yiiframework.com/performance/">www.yiiframework.com/performance</a> ) <br><br>  It was decided not to abandon the use of Yii ActiveRecord as an ORM, because it is very convenient in terms of development, and there is always the possibility of later reworking bottlenecks to use direct queries to the database.  At the initial stage, the bottleneck itself seemed to us to be the data storage structure, since the stated requirements hinted to us that a very large stream of queries that one server could not cope with would soon go to MySQL (chosen for data storage). <br><br><h5>  Replication </h5><br>  Replication, as a solution, disappeared immediately.  At the initial stage of development (first year), it would allow us to forget about the problems with the load, but later we would have to solve the newly raised problem of the constantly loaded master (by the way, these problems are solved in very muddy ways such as a proxy for the master, slave as a master for slaves etc.).  Yes, and the constant work of admins to maintain relevant data in the databases and pulling logs could lead to disastrous consequences, since nobody canceled the human factor. <br><br><h5>  Sharding </h5><br>  The choice fell on horizontal scaling (sharding) mysql.  I will not go into the details of such a principle of data allocation, I will only say that instances of one entity (rows of one table) are spread across different servers (described in more detail <a href="http://highload.com.ua/index.php/2009/05/06/%25D1%2588%25D0%25B0%25D1%2580%25D0%25B4%25D0%25B8%25D0%25BD%25D0%25B3-%25D0%25BF%25D0%25B0%25D1%2580%25D1%2582%25D0%25B8%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5-%25D1%2580%25D0%25B5%25D0%25BF%25D0%25BB%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2586/">here</a> ).  The tables, divided into shards, are selected according to the ‚Äúmost frequently visited‚Äù principle, i.e., those to which there are very many requests (no matter what type). <br><br>  In our case, we selected several basic tables, which we decided to flatten horizontally between the servers.  I'll tell you on the example of a table of users, which we expect several million.  So, we have a user table (tbUser) spread across multiple servers, and for each requested user we now also need to know which server it is on.  There are many solutions to this situation, when it is proposed, for example, to take the remainder of dividing the UID by the number of servers, etc. But in this case there is a problem when adding new servers and you need to write additional user transfer scripts that block the table or something else.  Therefore, to determine the server on which the user is stored, we chose a variant of third-party data storage such as UID =&gt; SERVER_ID, and we took Redis as the storage itself. <br><br><h5>  Rediska setup </h5><br>  To interact with Redis, the <a href="http://rediska.geometria-lab.net/">Rediska</a> library was installed.  Integrating it with Yii is easy - you need to download the library, place it, for example, in / protected / vendor / rediska and be sure to put the following in the Rediska.php header: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> spl_autoload_unregister(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'YiiBase'</span></span>,<span class="hljs-string"><span class="hljs-string">'autoload'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>) . <span class="hljs-string"><span class="hljs-string">'/Rediska/Autoloader.php'</span></span>; Rediska_Autoloader::register(); spl_autoload_register(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'YiiBase'</span></span>, <span class="hljs-string"><span class="hljs-string">'autoload'</span></span>)); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rediska</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rediska_Options</span></span></span></span></code> </pre> <br><br>  This solution temporarily disables autoload Yii and turns on Radiskovsky (otherwise, autoloads simply conflict). <br><br>  In the / protected / components / directory, we created our own component using this library: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).<span class="hljs-string"><span class="hljs-string">'/../vendor/rediska/Rediska.php'</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RediskaConnection</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $options = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_rediska; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_rediska = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rediska(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;options); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_rediska; } }</code> </pre><br><br>  ... and hooked it up in main.php <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'RediskaConnection'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'class'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'application.components.RediskaConnection'</span></span>, <span class="hljs-string"><span class="hljs-string">'options'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'servers'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'server1'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'host'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'192.168.0.131'</span></span>, <span class="hljs-string"><span class="hljs-string">'port'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'6379'</span></span>, <span class="hljs-string"><span class="hljs-string">'timeout'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'3'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// in seconds 'readTimeout'=&gt;'3', // in seconds ), ), 'serializerAdapter'=&gt;'json', ), ),</span></span></code> </pre><br><br>  All Rediska settings are described at the office.  Site.  After configuring a new component, it is enough to check it with get / set <br><br><pre> <code class="php hljs">Yii::app()-&gt;RediskaConnection-&gt;getConnection()-&gt;set(<span class="hljs-string"><span class="hljs-string">'key'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> Yii::app()-&gt;RediskaConnection-&gt;getConnection()-&gt;get(<span class="hljs-string"><span class="hljs-string">'key'</span></span>);</code> </pre><br><br><h5>  Database Preparation </h5><br>  When all the minor troubles with Redis ended, we moved on to creating a couple of MySQL instances with similar databases: <br><br><pre> <code class="php hljs"> <span class="hljs-string"><span class="hljs-string">'shard1'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'CDbConnection'</span></span>, <span class="hljs-string"><span class="hljs-string">'connectionString'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'mysql:host=192.168.0.131;dbname=dbshard'</span></span>, <span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'dbuser'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'dbpass'</span></span>, <span class="hljs-string"><span class="hljs-string">'autoConnect'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">'charset'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>, ), <span class="hljs-string"><span class="hljs-string">'shard2'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'CDbConnection'</span></span>, <span class="hljs-string"><span class="hljs-string">'connectionString'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'mysql:host=192.168.0.61;dbname=dbshard'</span></span>, <span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'dbuser'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'dbpass'</span></span>, <span class="hljs-string"><span class="hljs-string">'autoConnect'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">'charset'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>, ),</code> </pre><br><br><h5>  Software implementation of sharding </h5><br>  On these bases, we placed only tables that undergo sharding (including tbUser), so as not to get confused later.  Now it was necessary to think over the mechanism of data distribution among the received servers.  To this end, it was decided to create the CShardedActiveRecord class, which essentially extends CActiveRecord and overrides the methods we need.  The principle of operation is as follows: we redefined the beforeSave (), which now determines the server to save the new record (the same remainder after dividing the UID by SERVER_QUANTITY) and saves the calculated value in Redis, and the id record to save is generated using an incremental counter implemented with using Redis increment () (this allows you to have through id numbering in all databases);  redefined findByPk (), which now also gets the server number to be sampled.  All code is shown below: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Sharded active record */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CShardedActiveRecord</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Used in find by PK and * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> integer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_pk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Used connection * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> CDbConnection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_connection = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> db/ar/CActiveRecord#getDbConnection() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDbConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_null(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_connection)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_connection; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_null(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_pk)) { $serverName = Yii::app()-&gt;params-&gt;servers[<span class="hljs-string"><span class="hljs-string">'serverNames'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $serverId = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getServerId(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_pk); $serverName =<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(Yii::app()-&gt;params-&gt;servers[<span class="hljs-string"><span class="hljs-string">'serverNames'</span></span>][$serverId]) ? Yii::app()-&gt;params-&gt;servers[<span class="hljs-string"><span class="hljs-string">'serverNames'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] : Yii::app()-&gt;params-&gt;servers[<span class="hljs-string"><span class="hljs-string">'serverNames'</span></span>][$serverId]; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_connection = Yii::app()-&gt;{$serverName}; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_connection; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_connection = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRedisKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tableName() . <span class="hljs-string"><span class="hljs-string">'_'</span></span> . $key; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> server id or false, for null $pk */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getServerId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($pk)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_null($pk)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $serverId = Yii::app()-&gt;RediskaConnection-&gt;getConnection()-&gt;get(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRedisKey($pk)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $serverId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByPk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($pk, $condition = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $params = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_integer($pk)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> (<span class="hljs-string"><span class="hljs-string">'primary key must be integer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_pk = $pk; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;removeConnection(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::findByPk($pk, $condition, $params); } <span class="hljs-comment"><span class="hljs-comment">/** * Set unique id for new record * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> boolean */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeSave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::beforeSave()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getIsNewRecord()) { $key = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tableName().<span class="hljs-string"><span class="hljs-string">'_counter'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_pk = Yii::app()-&gt;RediskaConnection-&gt;getConnection()-&gt;increment($key); $serverId = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id % Yii::app()-&gt;params-&gt;servers[<span class="hljs-string"><span class="hljs-string">'serverCount'</span></span>]; $result = Yii::app()-&gt;RediskaConnection-&gt;getConnection()-&gt;set(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRedisKey(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id), $serverId); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;removeConnection(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre><br><br><h5>  Total </h5><br>  Thus, we got our own ActiveRecord for sharding tables, and now we just had to create models that inherit functionality not from CActiveRecord, but from CShardedActiveRecord.  Overridden methods are enough for us, since  Most of the samples from the database are PK-based, and the database search is implemented using Sphinx (for which we even wrote our DataProvider so that you can use widgets integrated in Yii that work only with DataProvider).  Further, by simple inserts and samples in the table, we tested the work of our component and were satisfied with the result of our work. </div><p>Source: <a href="https://habr.com/ru/post/129780/">https://habr.com/ru/post/129780/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129772/index.html">Independent upgrade of Macbook pro (mid 2010)</a></li>
<li><a href="../129774/index.html">FreeArc - modern archiver</a></li>
<li><a href="../129775/index.html">Odessa: two months of work by the sea</a></li>
<li><a href="../129776/index.html">Developers explain why they killed "Start" in Windows 8</a></li>
<li><a href="../129779/index.html">2GIS opens a development office in Kiev</a></li>
<li><a href="../129784/index.html">Electronic medical records - is it necessary?</a></li>
<li><a href="../129787/index.html">New iPod nano features overview</a></li>
<li><a href="../129788/index.html">Online testing for Linux users</a></li>
<li><a href="../129791/index.html">8 countries signed the Anti-Counterfeiting Trade Agreement (ACTA)</a></li>
<li><a href="../129792/index.html">Unscientific poking method: Samsung will seek a global ban on iPhone 4S</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>