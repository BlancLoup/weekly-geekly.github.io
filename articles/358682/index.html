<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ARM MBED OS. Work with arbitrary MK STM32 under PlatformIO</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When in January of this year I wrote a material about the LittleFS file system (integrated into arm mbed os), I promised to soon describe the creation...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ARM MBED OS. Work with arbitrary MK STM32 under PlatformIO</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/17f/dc3/bc9/17fdc3bc964874b4ba78db02dd22a000.png" alt="image" align="left">  When in January of this year I wrote a material about the <b>LittleFS</b> file system (integrated into arm mbed os), I promised to soon describe the creation of a project with arm mbed os for an arbitrary <b>STM32</b> microcontroller.  As is known, the online <b>IDE</b> from <b>ARM</b> (or rather, the dedicated division of <b>Arm mbed</b> ) supports, firstly, a strictly defined number of debugging boards, and their number is small;  secondly, it exports online examples on the basis of which it is possible to build some of its projects, only for the most well-known IDEs: <b>ARM</b> , <b>uVision KEIL</b> and <b>IAR</b> .  Moreover, some examples are not exported at all.  That is, only options for <b>IAR</b> , or only for <b>KEIL</b> , and so on are available for export.  So, as it seemed at that time, learning how to ‚Äúfasten‚Äù the arm mbed os to any MK would not be superfluous at all. <br><br>  However, life makes its own adjustments to any plans, and for a long time it did not work in this direction.  But the question remained open, and now, after a considerable time, I return to the subject. <br><a name="habracut"></a><br>  One way or another, an important question remained unresolved.  We all use different <b>IDEs</b> and different toolchains.  The porting process is quite complicated, and requires certain dances with a tambourine.  For example, the assembler for <b>GCC</b> does not support the x86 syntax (there is <b>AT &amp; T</b> ), so the very first and elementary problem that a programmer will face here is a curse of the same <b>GCC</b> compiler on assembler inserts in the source code of the Arm mbed operating system. <br><br>  Someone is using <b>IAR</b> , someone is <b>uVision</b> , someone is writing in <b>Sublime Text</b> , and someone (like me) - in <b>Code :: Blocks</b> .  Someone is using Windows, and someone is using Linux.  To embrace the immense and embrace the uncovered we are unable to, and at the same time leave one of the options without consideration - it means leaving some part of the audience behind. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The solution came suddenly and turned out to be quite simple and universal. <br><br><h3>  PlatformIO IDE. </h3><br>  <b>PlatformIO</b> is a cross-platform toolchain written in python, the presence of which on the user's machine is perhaps the only mandatory condition (not lower than version 2.7). <br><br>  In terms of its performance and the used <b>PlatformIO</b> toolkit, I was reminded a few years ago of the IDE <b>MicroEJ Studio</b> , which could write code for microcontrollers in Java.  Subsequently, MicroJVM (written in C) was poured into the MC, and the code was executed in it.  However, the environment did not receive wide distribution, and did not go to the masses. <br><br>  <b>PlatformIO</b> can be used as part of a number of common IDE and code editors: <br><br><ul><li>  <b>Atom</b> ; </li><li>  <b>Clion</b> ; </li><li>  <b>Eclipse</b> ; </li><li>  <b>Emacs</b> ; </li><li>  <b>NetBeans</b> ; </li><li>  <b>Qt Creator</b> ; </li><li>  <b>Sublime Text</b> ; </li><li>  <b>Vim</b> ; </li><li>  <b>Visual Studio</b> ; </li><li>  <b>Vscode</b> etc. </li></ul><br>  The main feature of <b>PlatformIO</b> is the use of the configuration file ‚Äúplatformio.ini‚Äù, which is used to determine the target platform of the project, and then load the libraries and build dependencies in accordance with the description that is in this configuration file. <br><br>  The main elements are <b>PlatformIO IDE</b> and <b>PlatformIO Core</b> . <br>  In a rather distant 2016, <b>PlatformIO</b> was a candidate for award in the nomination ‚ÄúBest IoT Software &amp; Tools‚Äù in the 2016 IoT Awards competition. <br>  This is in general terms.  Detailed documentation can be found on the project platformio.org website and in the <a href="http://docs.platformio.org/en/latest/">Documentation</a> section. <br>  Our task is to install the required development tools, create a project, and do something in it. <br><br><h3>  Atom vs.  VS Code </h3><br>  There are two editors available for download on the home page: <b>Atom</b> and <b>VS Code</b> .  I tried both, and immediately say: <b>VS Code is</b> more convenient.  If only because there is an elementary transition in the code.  Looking ahead, I‚Äôll say: you don‚Äôt see arm mbed os in the library and source project, they‚Äôre all in the local repository, so only your <b>main.cpp</b> and everything else you create will be in the project tree.  Therefore, to watch some declarations, classes and their objects, class interfaces, will have one hundred percent.  And <b>Atom</b> doesn't have such an opportunity ...  And when using <b>Atom,</b> you will have to be content with only the documentation of mbed os.  Agree, it is inconvenient. <br><br>  So, further consideration of the process I spend as applied to <b>VS Code</b> .  We need to do the following steps: <br><br><ol><li>  Install VS Code. </li><li>  Install PlatformIO IDE. </li><li>  Configure udev rules (for Linux users) - it may not be necessary, but in order not to bounce on a chair, we will put a preemptive strike. </li><li>  Create a project and include the minimum functionality.  Make sure that it is assembled, loaded and debugged on the board (OCD / GDB is used as the server). </li></ol><br>  Install <b>VS Code by</b> clicking on the <a href="https://platformio.org/platformio-ide">link</a> and downloading the installer for the desired system. <br><br>  After installation, run the editor, open the Extensions panel, and enter ‚Äúplatformio‚Äù in the search.  The first option will pop up ‚Äú <b>PlatformIO IDE</b> ‚Äù.  Click ‚ÄúInstall‚Äù, wait for the installation to finish, reboot the editor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/39e/12e/b01/39e12eb01120fcfb9bef7e23108725ad.jpg" alt="image"></div><br>  Linux users can immediately install udev rules for adequate debugging.  In principle, this step can be omitted, and you can return to it if the terminal displays a message like ‚Äú <b>Remote communication error.</b> ‚Äù At the start of the debugger <b>.</b>  <b>Target disconnected .: Connection reset by peer.</b>  " <br><br>  Open the terminal and write in it: <br><br><pre><code class="vbscript hljs">sudo curl -fsSL https://raw.githubusercontent.com/platformio/platformio-core/develop/scripts/<span class="hljs-number"><span class="hljs-number">99</span></span>-platformio-udev.rules &gt; /etc/udev/rules.d/<span class="hljs-number"><span class="hljs-number">99</span></span>-platformio-udev.rules</code> </pre> <br>  If the terminal issues ‚ÄúPermission denied‚Äù, then download the file ‚Äú99-platformio-udev.rules‚Äù by <a href="https://raw.githubusercontent.com/platformio/platformio-core/develop/scripts/99-platformio-udev.rules">reference</a> , and forcibly copy the file into etc / udev: <br><br><pre> <code class="vbscript hljs">sudo cp <span class="hljs-number"><span class="hljs-number">99</span></span>-platformio-udev.rules /etc/udev/rules.d/<span class="hljs-number"><span class="hljs-number">99</span></span>-platformio-udev.rules</code> </pre><br>  Note that after the cp command, the full path to the file must be specified.  If the .rules file is in the folder, for example, ‚ÄúDownloads,‚Äù then the terminal command will look like this: <br><br><pre> <code class="vbscript hljs">sudo cp ~/Downloads/<span class="hljs-number"><span class="hljs-number">99</span></span>-platformio-udev.rules /etc/udev/rules.d/<span class="hljs-number"><span class="hljs-number">99</span></span>-platformio-udev.rules</code> </pre><br>  Next, perform: <br><br><pre> <code class="vbscript hljs">sudo usermod -a -G dialout $USER sudo usermod -a -G plugdev $USER</code> </pre><br>  where <b>$ USER</b> is your username.  For example, I have this subdia. <br>  After that, all problems with the debugger, if they could arise, should be solved. <br><br><h3>  Environment and local repository arm mbed os </h3><br>  After installing the environment, it will not be superfluous to understand where the arm mbed os local repository is located (as I said, you will not see it in the project tree), where all the mbed os sources are located, and where the compiled project is stored. <br><br>  During the installation, <b>platformIO</b> deploys the arm mbed local repository (and not only it) along the $ HOME / .platformio / packages path.  Here, for example, arm mbed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f9b/5fd/9f1/f9b5fd9f1fa9112cc0494e8907bd7c97.jpg" alt="image"></div><br>  Firmware files and precompiled sources are located directly in the project folder. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/315/96b/520/31596b5200b5a79b98fe6889bd76c31c.jpg" alt="image"></div><br>  That's all we need to know about where it is stored.  We proceed directly to the creation of the project. <br><br><h3>  Creating a project. </h3><br>  Briefly about the project being created.  For obvious reasons, I decided to create a project for the board, which is not included in the structure supported by ARM online IDE, namely <b>STM32F4DISCOVERY</b> . <br><br>  In the world of embedded systems, it is customary to create demonstration projects with flashing LEDs.  We will not do this - it is already simple and uninteresting.  <b>PlatformIO</b> implies several types of projects: <b>cmsis</b> , <b>hal</b> , <b>rtos</b> , and so on.  Since we are talking about arm mbed os, that is, the operating system, we will create a project for <b>rtos</b> . <br><br>  In the project, we will create and run three tasks (Task): the first will multiply the <i>float</i> arrays (we have the Cortex-M4F processor, so use the FPU), the second task ... well, blink the LEDs (=)), and the third to determine CPU utilization. <br><br>  So let's go. <br><br>  Open <b>VS Code</b> .  First of all, the <b>PIO Home</b> window will open.  Choose ‚Äú <b>New Project</b> ‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e8f/300/11f/e8f30011fedfebdc47023c50951cf4f6.jpg" alt="image"></div><br>  In the ‚Äú <b>Project Wizard</b> ‚Äù window, indicate the name of the project (for us, let it be ‚Äúarmmbed_F407_CPU_usage‚Äù), and select the board in the ‚Äú <b>Board</b> ‚Äù drop-down list.  For readers who plan to use the material when writing software for their copyright boards: yes, binding to a specific board, but all the legs and the periphery can be reconfigured.  Next, I will say a few words about it, do not rush to get upset.  So, <b>Board</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/341/7fe/109/3417fe10902c438b211e741de174f53a.jpg" alt="image"></div><br>  Select <b>STM32F4DISCOVERY</b> , and go to the ‚Äú <b>Framework</b> ‚Äù window.  Here we have several options. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/89c/efd/c8d/89cefdc8d362c2a5896f194178f1b3ef.jpg" alt="image"></div><br>  Since we agreed to use arm mbed os, it is obvious that here we choose the option ‚Äú <b>mbed</b> ‚Äù.  Click ‚Äú <b>finish</b> ‚Äù - done.  The master will think a little and open the newly created project blank.  Take a look at this. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b58/13c/f96/b5813cf965d4b1e9a1deb41c270264ce.jpg" alt="image"></div><br>  As I mentioned above, there are only two default folders in the project: <b>lib</b> (empty) and <b>src</b> , which contains a single <b>main.cpp</b> file.  I‚Äôm not going to see the whole source code here.  But nevertheless, we have the opportunity to use all the functionality of arm mbed os.  To use <b>rtos</b> , we have to add the build flag to the ‚Äú <b>platformio.ini</b> ‚Äù file: <br><br><pre> <code class="vbscript hljs">build_flags =-DPIO_FRAMEWORK_MBED_RTOS_PRESENT</code> </pre><br>  In general, the configuration file deserves separate consideration.  This approach reminded <b>me of TIRTOS / SYSBIOS</b> from <b>Texas Instruments</b> with their config file <b>.cfg</b> , even though everything is much simpler in arm mbed.  In the configuration file, you can declare a lot - from hardware resources to build flags and debugging.  For example, here is the composition of the simplest configuration file: <br><br><pre> <code class="vbscript hljs">[env:disco_f407vg] platform = ststm32 framework = mbed board = disco_f407vg</code> </pre><br>  And this is the config file of our example in its final form: <br><br><pre> <code class="vbscript hljs">[env:disco_f407vg] platform = ststm32 board = disco_f407vg framework = mbed build_flags = -DPIO_FRAMEWORK_MBED_RTOS_PRESENT -O1 -Wl,-u_printf_float -D std=gnu99 -fno-builtin-printf -fexceptions -fpermissive debug_flags = -D DEBUG=<span class="hljs-number"><span class="hljs-number">1</span></span> -DDEBUG_LEVEL=DEBUG_NONE monitor_baud = <span class="hljs-number"><span class="hljs-number">115200</span></span></code> </pre><br>  So there is something to learn at your leisure. <br><br>  So, we begin to bring the project in the form that we need. <br><br>  I will give the code in blocks, and explain what is happening in it.  To begin with, we need to include the header files ‚Äú <b>mbed.h</b> ‚Äù and ‚Äú <b>rtos.h</b> ‚Äù in the source code.  I think it is clear why. <br><br>  The ‚Äú <b>main</b> ‚Äù function will take the following form: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ Thread thread0; Thread thread1; Thread thread2; Thread::attach_idle_hook (&amp;sleeping_sun); thread0.start (&amp;ledblink); thread1.start (&amp;cpu_usage); thread2.start (&amp;math_thread); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { } } <span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span></code> </pre><br>  First, we create objects of the class ‚Äú <b>Thread</b> ‚Äù, that is, in essence, our tasks (Task, Thread), which will provide us with a certain functionality. <br>  If someone noticed, the next line is <br><br><pre> <code class="cpp hljs">Thread::attach_idle_hook (&amp;sleeping_sun);</code> </pre><br>  This is the ‚Äú <b>idle</b> ‚Äù task - that is, a task with a low priority, which only has the time that is left for the processor after performing tasks with normal and high priorities.  Well, in our case, this task will remain hungry, since the processor will not have time for it.  I brought it here just for example. <br><br>  Next, we start the tasks in turn using the ‚Äú <b>start</b> ‚Äù method, passing it links to the functions of the tasks, namely, what will be performed in the process.  This ‚Äú <b>ledblink</b> ‚Äù is a shmorgalka, ‚Äú <b>cpu_usage</b> ‚Äù is the CPU usage count, and the hardest is ‚Äú <b>math_thread</b> ‚Äù, which performs the multiplication of arrays. <br><br>  Let's take a look at each of the tasks.  With ‚Äú <b>ledblink</b> ‚Äù everything is simple. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ledblink</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { myled1 = !myled1; Thread::wait (<span class="hljs-number"><span class="hljs-number">500</span></span>); } } <span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span></code> </pre><br>  We alternately change the state of the output with the LED to the opposite, and cause a delay of 500 ms.  By the way, the declaration ‚Äú <b>myled1</b> ‚Äù looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">DigitalOut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myled1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED1)</span></span></span></span>;</code> </pre><br>  Let us now turn our attention to the ‚Äú <b>cpu_usage</b> ‚Äù task. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu_usage</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ Timer tim; <span class="hljs-function"><span class="hljs-function">CPU_Usage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tim, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; cpu.working(); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> value = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { cpu.delay(<span class="hljs-number"><span class="hljs-number">0.25</span></span>); value = cpu.update(); pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"CPU %i"</span></span>, value); } } <span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span></code> </pre><br>  Here everything is somewhat more complicated.  In general, in order not to invent a bicycle, I used a ready-made library written by one cheerful guy in 2014 for arm mbed, which is called: <b>CPU_Usage</b> .  You can take it by <a href="https://os.mbed.com/users/dextorslabs/code/CPU_Usage/">reference</a> , there is a brief description of it.  The library uses a timer (we see an object of class <b>Timer tim</b> ).  First, the constructor of the class ‚Äú <b>cpu</b> ‚Äù is called, then alternately the methods ‚Äú <b>working</b> ‚Äù (start of work), and ‚Äú <b>update</b> ‚Äù - calculation of the processor load in percent. <br><br>  Perhaps now is the best time to demonstrate.  I will show a screen from the debug mode. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1b0/281/bc4/1b0281bc45b352f64ac86dc8183b8c94.jpg" alt="image"></div><br>  At the top left, we see the value ‚Äú <b>value</b> ‚Äù = 95. This means that the processor was 95% loaded at that moment.  In general, according to the results of the experiment, this value when performing the same tasks ranged from 87 to 98%. <br><br>  By the way, why do I show screenshots from a debugger and not from a terminal?  It's simple, I have no UART-USB adapter at hand, so I can't use the UART terminal (this is the ‚Äú <b>pc.printf ()</b> ‚Äù function - this is just the output from the UART, pc is an object of the <b>Serial</b> class). <br><br>  Both the last and the most voracious for the processor is the <b>math_thread</b> task.  We will look at it - first in the ‚Äúbare‚Äù form, then we will slightly complement the arm mbed with buns. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math_thread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> rand_num_dmassi1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> rand_num_dmassi2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { rand_num_dmassi1 = RandomMassIndex(); rand_num_dmassi2 = RandomMassIndex(); result = (DigMas1[rand_num_dmassi1]*DigMas2[rand_num_dmassi2]); } } <span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span></code> </pre><br>  When I thought of how to load the processor, multiplying the arrays immediately came to my mind.  And I remembered the situation as a customer, for whom I did something remotely (and also debugged remotely, after half the world), shouted to me on Skype: ‚Äú <i>You are a programmer, so load the processor!</i>  <i>He is quite cold, make it so that he warmed up!</i>  ".  Let's now make it so that our MCU warms up.  =) <br><br>  And I decided not to multiply arrays sequentially, but to generate their indices using a random number generator.  And here to me one wonderful mathematical library came to the rescue: <b>alglib</b> .  It covers a huge layer of mathematical functionality, and you can take it <a href="http://alglib.sources.ru/">here</a> .  We will not use the entire huge layer of functionality, of course, but we will use a small piece. <br><br>  If you look at the task calculator of the work, then we will see there two calls ‚Äú <b>RandomMassIndex ()</b> ‚Äù.  This is just a function that returns a value in the range (our range is limited by the number of elements of the arrays). <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> RandomMassIndex (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> randval; alglib_impl::ae_state mystate; randval = alglib_impl::ae_randominteger(<span class="hljs-number"><span class="hljs-number">18</span></span>, &amp;mystate); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> randval; } <span class="hljs-comment"><span class="hljs-comment">/******************************END_OF_FILE*********************************/</span></span></code> </pre><br>  So what are we doing here?  First, we initialize the ‚Äú <b>ae_state</b> ‚Äù structure (it is used for internal needs), and then we simply call the ‚Äú <b>ae_randominteger</b> ‚Äù method, to which we give a link to our structure, and the range in which we want to get the generated random number (we have 0..18 ).  This number must be less than the maximum generated value.  The number of elements in the array is 20 (0..19), and the maximum number is 19. So, as a boundary argument, 18 fits us perfectly. <br><br>  By the way, you can look at the results of calling this function. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f6c/c64/d76/f6cc64d7660cd0ad0db27f39d5bbd598.jpg" alt="image"></div><br>  At the top left, the generated random indices of the arrays, ‚Äú <b>rand_num_dmassi1</b> ‚Äù and ‚Äú <b>rand_num_dmassi2</b> ‚Äù.  13 and 12. <br><br>  Let's run another cycle, see if it changes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b97/8d7/402/b978d7402649d24f625bc3284d05d4a3.jpg" alt="image"></div><br>  11 and 17. Changed.  So it works. <br><br>  Since we are talking about the analysis of resources (in particular, about the use of CPU time), we devote a little time to memory and the priorities of tasks.  <b>Arm</b> mbed os implements a whole class of <b>rtos :: Thread</b> for these needs. <br><br>  Directly in the task ‚Äú <b>math_thread</b> ‚Äù we add the following lines: <br><br><pre> <code class="cpp hljs">osThreadId_t this_thread_id; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> this_thread_stacksize; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> osPriority_t this_thread_priority; this_thread_id = osThreadGetId(); this_thread_stacksize = osThreadGetStackSize(this_thread_id); this_thread_priority = osThreadGetPriority(this_thread_id);</code> </pre><br>  Here (and above) I used the keyword volatile - so that the variable can be monitored. <br><br>  So, first we get the task <b>ID</b> for further use.  Then we call the methods to determine the stack of the task and its priority.  Priority can be changed on the go - in some applications it is claimed. <br>  We look. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d18/22f/322/d1822f322e4b365cc166a042e6f13371.jpg" alt="image"></div><br>  We see that the size of the task stack is 4096 bytes, and the priority is <b>osPriorityNormal</b> .  Normal, in general, priority. <br><br>  In addition, we can estimate the degree of usability, the size of the unused and used stack.  Right in the <b>main</b> add: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> threads_stack; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> threads_max_stack; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> free_stack; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> used_stack;</code> </pre><br>  And after running tasks: <br><br><pre> <code class="cpp hljs">threads_stack = thread0.stack_size(); threads_stack = thread1.stack_size(); threads_stack = thread2.stack_size(); threads_max_stack = thread0.max_stack(); threads_max_stack = thread1.max_stack(); threads_max_stack = thread2.max_stack(); free_stack = thread0.free_stack(); free_stack = thread1.free_stack(); free_stack = thread2.free_stack(); used_stack = thread0.used_stack(); used_stack = thread1.used_stack(); used_stack = thread2.used_stack();</code> </pre><br>  Four methods are called here.  ‚Äú <b>Stack_size ()</b> ‚Äù returns the size of the task stack (similar to what we evaluated a little earlier), ‚Äú <b>max_stack ()</b> ‚Äù returns the size of the maximum used during execution, ‚Äú <b>free_stack ()</b> ‚Äù returns the size of free space, and ‚Äú <b>used_stack ()</b> ‚Äù - size used  Return values ‚Äã‚Äãare in bytes.  For all three of our tasks, these values ‚Äã‚Äãwill be the same. <br><br>  Let's see what they show us <s>on TV</s> in the debugger. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/856/c6d/73b/856c6d73b7b0882796ea1ec45438dd13.jpg" alt="image"></div><br>  As you can see, we have eaten quite a bit from 4096 bytes - only 64 bytes, and we still have 4032 bytes in stock. <br><br>  Perhaps, we will end up on this with experiments and analysis - I already started playing. <br><br>  Yes, what else I would like to say about the author's boards.  Now someone can say, they say, he took <b>F4Discovery</b> , he <b>played</b> it for his own pleasure, and I have a homemade board in general, and the LEDs generally hang on other legs, and in general, I want to raise <b>SPI</b> on it.  So, in the <b>armbed</b> repository, in the ‚Äú <b>targets</b> ‚Äù folder (we select further our very specific MCUs - they are dark there), in the directories of each microcontroller, there are wonderful headers named ‚Äú <b>PinNames.h</b> ‚Äù, ‚Äú <b>PeripheralPins.h</b> ‚Äù and ‚Äú <b>PeripheralNames .h</b> ‚Äù.  Editing these files, you can add / edit / delete peripherals. <br><br>  On this, perhaps, I will stop.  More examples for various applications arm mbed (including non- <b>rtos</b> , and just <b>bare metal</b> ) can be cloned or downloaded by the <a href="https://github.com/platformio/platform-ststm32">archive here</a> . <br><br>  <a href="https://drive.google.com/open%3Fid%3D1K4Xy5GsFXCdxxB3eqwqipLs63xdDDxEn">I</a> attach the <a href="https://drive.google.com/open%3Fid%3D1K4Xy5GsFXCdxxB3eqwqipLs63xdDDxEn">link to the archive</a> (Google Drive) with our created example to the material, and place the full source code below under the spoiler - for complete coverage of the whole picture.  If anything - welcome to mail subdia.subdia@gmail.com. <br><br><div class="spoiler">  <b class="spoiler_title">main.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mbed.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rtos.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CPU_Usage.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"alglibmisc.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ap.h"</span></span></span><span class="hljs-meta"> DigitalOut myled1(LED1); DigitalOut myled2(LED2); Timer tim; CPU_Usage cpu(tim, 1); Serial pc(USBTX,USBRX,9600); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PRETTY_ENOUGH 20 float DigMas1[PRETTY_ENOUGH] = {0.1234, 1.1234, 2.1234, 3.1234, 4.1234, 5.1234, 6.1234, 7.1234, 8.1234, 9.1234, 10.1234, 11.1234, 12.1234, 13.1234, 14.1234, 15.1234, 16.1234, 17.1234, 18.1234, 19.1234}; float DigMas2[PRETTY_ENOUGH] = {0.5678, 1.5678, 2.5678, 3.5678, 4.5678, 5.5678, 6.5678, 7.5678, 8.5678, 9.5678, 10.5678, 11.5678, 12.5678, 13.5678, 14.5678, 15.5678, 16.5678, 17.5678, 18.5678, 19.5678}; uint16_t RandomMassIndex (void); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**************************************************************************/</span></span></span><span class="hljs-meta"> void math_thread(void) { volatile uint16_t rand_num_dmassi1 = 0; volatile uint16_t rand_num_dmassi2 = 0; float result; osThreadId_t this_thread_id; volatile uint32_t this_thread_stacksize; volatile osPriority_t this_thread_priority; while (true) { rand_num_dmassi1 = RandomMassIndex(); rand_num_dmassi2 = RandomMassIndex(); result = (DigMas1[rand_num_dmassi1]*DigMas2[rand_num_dmassi2]); this_thread_id = osThreadGetId(); this_thread_stacksize = osThreadGetStackSize(this_thread_id); this_thread_priority = osThreadGetPriority(this_thread_id); } } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**************************************************************************/</span></span></span><span class="hljs-meta"> void cpu_usage (void) { uint8_t value = 0; while (true) { cpu.delay(0.25); value = cpu.update(); pc.printf(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CPU %i"</span></span></span><span class="hljs-meta">, value); } } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**************************************************************************/</span></span></span><span class="hljs-meta"> void ledblink (void) { while (true) { myled1 = !myled1; Thread::wait (500); } } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**************************************************************************/</span></span></span><span class="hljs-meta"> void sleeping_sun(void) { return; } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**************************************************************************/</span></span></span><span class="hljs-meta"> int main (void) { Thread thread0; Thread thread1; Thread thread2; volatile uint32_t threads_stack; volatile uint32_t threads_max_stack; volatile uint32_t free_stack; volatile uint32_t used_stack; Thread::attach_idle_hook (&amp;sleeping_sun); thread0.start (&amp;ledblink); thread1.start (&amp;cpu_usage); thread2.start (&amp;math_thread); threads_stack = thread0.stack_size(); threads_stack = thread1.stack_size(); threads_stack = thread2.stack_size(); threads_max_stack = thread0.max_stack(); threads_max_stack = thread1.max_stack(); threads_max_stack = thread2.max_stack(); free_stack = thread0.free_stack(); free_stack = thread1.free_stack(); free_stack = thread2.free_stack(); used_stack = thread0.used_stack(); used_stack = thread1.used_stack(); used_stack = thread2.used_stack(); cpu.working(); while (true) { } } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**************************************************************************/</span></span></span><span class="hljs-meta"> uint16_t RandomMassIndex (void){ uint16_t randval; alglib_impl::ae_state mystate; randval = alglib_impl::ae_randominteger(18, &amp;mystate); return randval; } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/******************************END_OF_FILE*********************************/</span></span></span></span></code> </pre><br></div></div><br>  Thank you for your attention, all a good day and good mood. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ddd/c37/8a5/dddc378a54ea0b5aebfaa30004d2dd13.jpg" alt="image"></div></div><p>Source: <a href="https://habr.com/ru/post/358682/">https://habr.com/ru/post/358682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358672/index.html">Why you should stop using grocery roadmap and try GIST</a></li>
<li><a href="../358674/index.html">Javier Mertens: ‚ÄúCryptojacking is one of the most brilliant attacks I've seen.‚Äù</a></li>
<li><a href="../358676/index.html">Mathematical modeling haboo-future</a></li>
<li><a href="../358678/index.html">FAS rendered YouTube and torrents from Russian jurisdiction</a></li>
<li><a href="../358680/index.html">Troubleshooting Node.js Applications Under the Hood</a></li>
<li><a href="../358686/index.html">Megafon ordered the Kupol storage complex to store traffic according to the law of Spring</a></li>
<li><a href="../358688/index.html">ESET discovered two 0-day vulnerabilities in Adobe Reader and Microsoft Windows</a></li>
<li><a href="../358690/index.html">We pack in containers, deploy, monitor - the program Root Conf</a></li>
<li><a href="../358692/index.html">Selection: 6 open frameworks for creating backtesters of trading strategies in Python</a></li>
<li><a href="../358694/index.html">UPD Broadcast. We invite you to the New PostgreSQL 11 features mitap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>