<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to Javascript Source Maps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Have you ever thought how it would be great if you could easily read and debug the minified javascript code in the production environment in one file ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to Javascript Source Maps</h1><div class="post__text post__text-html js-mediator-article">  Have you ever thought how it would be great if you could easily read and debug the minified javascript code in the production environment in one file and even debug it without affecting performance?  Now this is possible if you use a piece called <a href="https://docs.google.com/document/d/1U1RGAehQwRypUTovF1KRlpiOFze0b-_2gc6fAH0KY0k/edit%3Fhl%3Den_US%26pli%3D1%26pli%3D1">source maps</a> . <br><br>  In short, this is a way to associate a minified / merged file with the files from which it came out.  During the build for the combat environment, in addition to minifying and merging files, a mapper file is also generated that contains information about the source files.  When a call is made to a specific place in the minified file, a search is made in the mapper, which calculates a string and a character in the source file.  Developer Tools (WebKit nightly builds or Google Chrome Canary) can parse this file to automatically and transparently replace files, as if working with source files.  At the time of writing (the <i>original article - approx. Transl.</i> ) Firefox blocked the development of support for Source Map.  Learn more at the <a href="https://wiki.mozilla.org/DevTools/Features/SourceMap">MozillaWiki Source Map</a> . <br><a name="habracut"></a><br>  <a href="http://www.thecssninja.com/demo/source_mapping/">An example is the correct location definition in the source code.</a> <br><br>  In this example, you can right-click anywhere in the textarea and select the item ‚ÄúGet original location‚Äù.  In this case, the mapper file will be accessed with the transfer of the line and character number in the minified code, and the corresponding piece of code from the source file will be shown.  The line number and symbol number in the source file and other interesting information will be displayed in the console. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/04e/10e/02f/04e10e02fd4a900ec4dc8e1da57465de.png" alt="image"><br><br><h4>  Real use </h4><br>  Before watching the next example, you need to activate the source maps view in Chrome Canary or WebKit nightly, for this, activate the item ‚ÄúEnable source maps‚Äù in the properties (see screenshot) <br><img src="https://habrastorage.org/getpro/habr/post_images/8d3/c75/7ec/8d3c757ec23eb877080d4650a61e8f9b.png" alt="image"><br><br>  We continue.  The previous example was interesting, but how can it be used?  Go to <a href="http://dev.fontdragr.com/">dev.fontdragr.com with your</a> Google Chrome browser and you will see that the javascripts on the page are not compiled and you can watch individual js-files.  This is all due to the use of the mapper, and in fact the code on the page is compiled.  All errors, outputs to the log and breakpoints will map to the source code, and debugging the code will be very convenient.  As a result, you can work with the production site as a test. <br><br>  <a href="http://dev.fontdragr.com/">Example - look in the console on fontdragr.com</a> <br><br><h4>  Why do we need Source Maps? </h4><br>  Now, mapping only works between source files and a compressed / merged version, but there is talk of mapping for languages ‚Äã‚Äãcompiled into JavaScript (for example, CoffeeScript), and even support for CSS preprocessors, such as SASS and LESS. <br>  In the future, we could easily use almost any language, as if it were natively supported by the browser: <br><ul><li>  CoffeeScript </li><li>  ECMAScript 6 and above </li><li>  SASS / LESS, etc. </li><li>  Virtually any language that compiles to javascript </li></ul><br>  Check out the screencast in which CoffeeScript is debugged in the experimental build of the Firefox console: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/2aQw1dSIYko%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhgebAlilmJru84fKWDACqAH86wR5w" frameborder="0" allowfullscreen=""></iframe><br><br>  Google Web Toolkit (GWT) recently added support for <a href="http://code.google.com/p/google-web-toolkit/wiki/SourceMaps">Source Maps</a> and Ray Cromwell from GWT made an excellent screencast showing how Source Map works in action. <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/-xJl22Kvgjg%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhjZ24StUiNMh5taOUMlt5_lYKQQsg" frameborder="0" allowfullscreen=""></iframe><br><br>  Another example uses the Google <a href="http://code.google.com/p/traceur-compiler/">Traceur</a> library, which allows you to write to ES6 (ECMAScript 6) and compile to ES3-compatible code.  The Traceur compiler also generates a source map.  Look at <a href="http://www.thecssninja.com/demo/source_mapping/ES6/">an example of</a> using the features of ES6 (classes and traits) as if they were natively supported by the browser.  The textarea in the example also allows you to write ES6 code that will be compiled on the fly in ES3 and a mapper file will also be created. <br> <a href="http://www.thecssninja.com/demo/source_mapping/ES6/"><img src="https://habrastorage.org/getpro/habr/post_images/8fb/9d6/ef1/8fb9d6ef1f4a5e841fedc51923270775.png" alt="image"></a> <br>  <a href="http://www.thecssninja.com/demo/source_mapping/ES6/">Example - you can write code on ES6 and immediately look in the debugger</a> <br><br><h4>  How it works? </h4><br>  So far, the only compiler / minifier with Source Map support is the Closure compiler (as generated by the mapper, as described below, it is written below).  When minifying JavaScript, a file mapper will also be created.  While Closure compiler does not add to the end of the file a special comment for Google Chrome Canary dev tools that the file mapper is available: <br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//@ sourceMappingURL=/path/to/file.js.map</span></span></code> </pre> <br>  Such a comment allows the browser to search for the right place in the source file using the file mapper.  If you don‚Äôt like the idea of ‚Äã‚Äãusing weird comments, you can add a special header to the compiled file: <br><pre> <code class="html hljs xml">X-SourceMap: /path/to/file.js.map</code> </pre><br>  Like the comment, it will tell the client where to find the mapper for this file.  Using the title also allows you to work with languages ‚Äã‚Äãthat do not support single-line comments. <br><img src="https://habrastorage.org/getpro/habr/post_images/9fb/228/cd0/9fb228cd0d50d0ee16514e3aff6864a8.png" alt="image"><br>  The file mapper will be downloaded only if the property is enabled and the console is open.  And of course, you will need to upload the source files so that they are accessible by the paths specified in the mapper. <br><br><h4>  How to generate a file mapper? </h4><br>  As mentioned above, you will need a <a href="https://developers.google.com/closure/compiler/">Closure compiler</a> for minifikatsi, splicing and generating a mapper file for the necessary JavaScript files.  To do this, run the command: <br><pre> <code class="bash hljs">java -jar compiler.jar \ --js script.js \ --create_source_map ./script-min.js.map \ --source_map_format=V3 \ --js_output_file script-min.js</code> </pre><br>  The required flags are <code>--create_source_map</code> and <code>--source_map_format</code> .  The latter is needed because  By default, the mapper is created in V2 format, and we need V3. <br><br><h4>  Inside Source Map </h4><br>  To better understand the Source Map, take for example a small file mapper and analyze in detail how the "addressing" is arranged.  Below is a slightly modified example from the <a href="https://docs.google.com/document/d/1U1RGAehQwRypUTovF1KRlpiOFze0b-_2gc6fAH0KY0k/edit%3Fhl%3Den_US%26pli%3D1%26pli%3D1">V3 spec</a> : <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">version</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">file</span></span>: <span class="hljs-string"><span class="hljs-string">"out.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">sourceRoot</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">sources</span></span>: [<span class="hljs-string"><span class="hljs-string">"foo.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"bar.js"</span></span>], <span class="hljs-attr"><span class="hljs-attr">names</span></span>: [<span class="hljs-string"><span class="hljs-string">"src"</span></span>, <span class="hljs-string"><span class="hljs-string">"maps"</span></span>, <span class="hljs-string"><span class="hljs-string">"are"</span></span>, <span class="hljs-string"><span class="hljs-string">"fun"</span></span>], <span class="hljs-attr"><span class="hljs-attr">mappings</span></span>: <span class="hljs-string"><span class="hljs-string">"AAgBC,SAAQ,CAAEA"</span></span> }</code> </pre><br><br>  You may notice that this is a regular object literal containing all the necessary information: <br><ul><li>  Version mapper </li><li>  Name of minified / merged file for production </li><li>  <code>sourceRoot</code> allows <code>sourceRoot</code> to add a prefix to the path to the source files </li><li>  <code>sources</code> contains source file names. </li><li>  <code>names</code> contains all real variable / function names from the resulting file. </li><li>  and <code>mappings</code> are the corresponding minified names. </li></ul><br><br><h4>  BASE64 VLQ or how to make the Source Map small </h4><br>  Initially, the specification described a very detailed derivation of all dependencies, which made the file mapper 10 times larger than the generated file.  The second version reduced the file size by half, and the third version reduced it again by half.  Now for the 133kB file ~ 300kB file mapper is generated.  How did you manage to achieve such a reduction and still be able to track complex dependencies? <br>  Used <a href="http://en.wikipedia.org/wiki/Variable-length_quantity">VLQ</a> (Variable Length Quantity) and Base64-coding.  The <code>mappings</code> property is one very large string.  Inside this line, a semicolon (;) separates the line numbers in the generated file.  Inside the resulting string, commas are used to separate code segments.  Each of the segments is 1, 4 or 5 VLQ-fields.  Some may be longer due to the continuation bit.  Each segment is based on the previous one, which helps to reduce the file size. <br><img src="https://habrastorage.org/getpro/habr/post_images/d42/13a/568/d4213a5680213f9540b0e4f63eac1761.png" alt="image"><br>  As mentioned earlier, each segment can be 1, 4 or five VLQ.  The diagram shows 4 VLQs with one continuation bit.  Let us analyze it in more detail and show how the mapper calculates the position in the source file.  A segment consists of five things: <br><ul><li>  The character number in the generated file. </li><li>  Original file </li><li>  Line number in source file </li><li>  Symbol number in source file </li><li>  Original name (if any) </li></ul><br>  ( <i>comment perev .: not mastered to the end to translate this part of the article, you can fully read the original; if you want to help - write, I will be grateful</i> ) <br><br><h4>  Potential problems with XSSI </h4><br>  The specification talks about potential problems with implementing XSS when using the Source Map.  You can get rid of it by writing at the beginning of your map file " <code>)]}</code> " to make this js file invalid and cause an error.  WebKit dev tools already know how to bar it: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) === <span class="hljs-string"><span class="hljs-string">")]}"</span></span>) { response = response.substring(response.indexOf(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>)); }</code> </pre><br>  As you can see, the first three characters are truncated and they are checked for compliance with the non-valid code specified in the specification, and in this case everything is cut to the next newline character. <br><br><h4>  <code>@sourceURL</code> and <code>displayName</code> in action: <code>eval</code> and anonymous functions </h4><br>  Although these two agreements are not yet included in the Source Map specification, they can seriously simplify work with <code>eval</code> and anonymous functions. <br>  The first helper is very similar to the <code>//@ sourceMappingURL</code> and is generally mentioned in the specification (V3).  By including this special comment in the code, which will then be executed via <code>eval</code> , you can call it <code>eval</code> , which will give them more logical names when working in the console.  Below is a simple example using the CoffeeScript compiler: <br><br>  <a href="http://www.thecssninja.com/demo/source_mapping/compile.html">Example - eval code passed with generated name</a> <br><img src="https://habrastorage.org/getpro/habr/post_images/5f4/0be/d81/5f40bed817e4b72ce75073280419be70.png" alt="image"><br><br>  Another helper allows you to name anonymous functions using the <code>displayName</code> property specified in the context of this function.  View <a href="http://www.thecssninja.com/demo/source_mapping/displayName.html">this example</a> to see the <code>displayName</code> in action. <br><br>  <a href="http://www.thecssninja.com/demo/source_mapping/displayName.html">Example - names for anonymous functions via <code>displayName</code> (WebKit NIghtly only)</a> <br><img src="https://habrastorage.org/getpro/habr/post_images/5ad/cdc/5e0/5adcdc5e0ffc23bb5bbdd03e0716c3f6.png" alt="image"><br>  When profiling, beautiful names will be displayed instead of <code>(anonymous function)</code> .  But most likely the <code>displayName</code> will not be included in the final build of Google Chrome.  Although there is still hope, they also suggest renaming the property to <a href="http://code.google.com/p/chromium/issues/detail%3Fid%3D116220">debugName</a> . <br>  By the time this article was written, the assignment of names to code executed via <code>eval</code> is supported only by Firefox and Google Chrome.  The <code>displayName</code> property is available only in Google Chrome nightly builds. <br><br><h4>  Join </h4><br>  There is a very long <a href="https://github.com/jashkenas/coffee-script/issues/558">discussion about Source Map support in CoffeeScript</a> . <br>  UglifyJS also has <a href="https://github.com/mishoo/UglifyJS/issues/315">a Source Map support ticket</a> . <br>  You can help if you take part in the discussion and give an opinion on the need for support of the Source Map.  The more tools that support this technology, the easier it will be to work, so demand its support in your favorite OpenSource project. <br><br><h4>  Source Map is not perfect </h4><br>  There is one trouble with using Source Map for normal debugging.  The problem is that when you try to check the value of an argument or a variable defined in the context of the source file, the context will not return anything, because  he doesn't really exist.  We need some kind of reverse mapping to check the value of the corresponding variable / argument in the minified code and match it to the source code. <br>  The problem is solved, and with proper attention to the Source Map may appear even more interesting of its application. <br><br><h4>  Tools and Resources </h4><br><ul><li>  Nick Fitzgerald fork of <a href="https://github.com/fitzgen/UglifyJS/tree/source-maps">UglifyJS</a> with Source Map support </li><li>  Paul Irish made a simple <a href="http://dl.dropbox.com/u/39519/sourcemapapp/index.html">demo of</a> Source Map </li><li>  Conrad Irwin wrote a convenient <a href="https://github.com/ConradIrwin/ruby-source_map">Source Map gem</a> for Ruby developers. </li><li>  What else to read about the <a href="http://blog.getfirebug.com/2009/08/11/give-your-eval-a-name-with-sourceurl/">naming of eval</a> and the <a href="http://www.alertdebugging.com/2009/04/29/building-a-better-javascript-profiler-with-webkit/">displayName property</a> </li><li>  You can see the <a href="">source code of the Closure Compiler of</a> creating the Source Map. </li><li>  Some screenshots and talk about support for <a href="https://plus.google.com/110412141990454266397/posts/iqXo5AyHkyd">GWT source maps</a> </li></ul><br><br>  Source Map is a powerful tool for the developer.  It allows you to keep the production code as compressed as possible, but at the same time allows you to debug it.  It is also useful for novice developers to view code written by experienced developers, in order to learn how to properly structure and write their code without having to wade through minified code.  What are you waiting for?  Generate a Source Map for your project! </div><p>Source: <a href="https://habr.com/ru/post/148098/">https://habr.com/ru/post/148098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148090/index.html">x86 in production: high end industrial controllers, pascal and viruses</a></li>
<li><a href="../148093/index.html">Parallels puzzle: Bertrand Serlet, mobile apps and new motivation program</a></li>
<li><a href="../148094/index.html">Amazon added ssd storage support to hi1.4xlarge top instance</a></li>
<li><a href="../148095/index.html">Public performance. What? How? What for?</a></li>
<li><a href="../148096/index.html">Geek Picnic - open air for IT-specialists</a></li>
<li><a href="../148099/index.html">Debug Objective-C ARC retain</a></li>
<li><a href="../148100/index.html">Nokia quarterly report: Lumia sales doubled, another billion lost</a></li>
<li><a href="../148101/index.html">Games that treat (Jane McGonigal at TEDGlobal 2012)</a></li>
<li><a href="../148102/index.html">So what happened to Sberbank?</a></li>
<li><a href="../148103/index.html">Monumental Foam</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>