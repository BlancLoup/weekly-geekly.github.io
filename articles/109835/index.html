<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Watir: easy parsing of complex sites</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anyone who writes parsers knows that you can parse a hundred sites and get stuck for a few days on the hundred-first. The structure of the next frostb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Watir: easy parsing of complex sites</h1><div class="post__text post__text-html js-mediator-article"><a href="http://watir.com/"><img src="http://altentee.com/wp-content/uploads/watir.png" alt="image" align="left"></a>  Anyone who writes parsers knows that you can parse a hundred sites and get stuck for a few days on the hundred-first.  The structure of the next frostbitten site can be arbitrarily complex, and when it comes to compressed javascript and ajax requests, it can become more expensive than the information itself to decrypt them and extract information using ordinary curl and retexps. <br><br>  Roughly speaking, the problem is that javascript is running in the browser, but not on the server.  You need to either write the js interpreter in one of the server languages ‚Äã‚Äã( <a href="http://timwhitlock.info/blog/2009/11/14/jparser-and-jtokenizer-released/">jParser and jTokenizer</a> ), or put a browser on the server, send requests to it and pull out the resulting dom-tree. <br><br>  In antiquity, in such cases, we built our bike: we ran a browser on a separate machine, js in it, which constantly knocked on the server and received tasks (jobs) from it, the site itself was loaded into the iframe, and the script sent the dom-tree from the outside back to server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now there are more advanced tools - <a href="https://developer.mozilla.org/en/xulrunner">xulrunner</a> ( <a href="http://simile.mit.edu/wiki/Crowbar">crowbar</a> ) and <a href="http://watir.com/">watir</a> .  The first is headless firefox.  Crowbar even has an <a href="http://simile.mit.edu/wiki/Solvent">ff-plugin for visually highlighting the necessary data</a> , which is generated by a special parser-js-code, however cookies are not supported there, but the reluctance to dole.  Watir is positioned by developers as a debugging tool, but we will use it for its intended purpose and, as an example, we will get some data from the site <a href="http://www.travelocity.com/Hotels">travelocity.com</a> . <br><br><a name="habracut"></a>  Watir is a ruby ‚Äã‚Äãgem through which the interaction with the browser takes place.  There are versions for different platforms - watir, firewatir and safariwatir.  Despite the detailed <a href="http://wiki.openqa.org/display/WTR/FireWatir%2BInstallation">installation manual</a> , I had problems in both Windows and Ubunt.  In windows (ie6), watir does not work on ruby ‚Äã‚Äã1.9.1.  I had to install version 1.8.6, then it worked.  In ubunt, in order for FireWatir to work (or the usual watir via firefox), you need to put the jssh plugin in your browser.  But the version offered for FireWatir on the <a href="http://wiki.openqa.org/display/WTR/FireWatir%2BInstallation">install</a> page did not work with my FireFox 3.6 on Ubuntu 10.04. <br><br>  To check if jssh works for you or not, you need to launch <code>firefox -jssh</code> and then send something to port 9997 ( <code>telnet localhost 9997</code> ).  If the port does not open, or firefox crashes (like mine), then you need to collect your jssh, detailed instructions for building are <a href="http://skythink.com/doc/building-jssh-for-watir-with-ubuntu">here</a> . <br><br>  Let's start writing a hotel parser with <a href="http://www.travelocity.com/Hotels">travelocity.com</a> .  For example, we choose the prices of rooms in all hotels in the direction of New York, NY, USA for today.  We will work with FireWatir on Ubuntu 10.4. <br><br>  Launch the browser and load the page with the form: <br><br> <code>require "rubygems"&lt;br&gt;require "firewatir"&lt;br&gt;ff = FireWatir::Firefox.new&lt;br&gt;ff.goto("http://www.travelocity.com/Hotels")&lt;br&gt;</code> <br>  Fill out the form with the necessary values ‚Äã‚Äãand make submit: <br><br> <code>ff.text_field(:id,"HO_to").val("New York, NY, USA")&lt;br&gt;ff.text_field(:id,"HO_fromdate").val(Time.now.strftime("%m/%d/%Y"))&lt;br&gt;ff.text_field(:id,"HO_todate").val(Time.tomorrow.strftime("%m/%d/%Y"))&lt;br&gt;ff.form(:name,"formHO").submit&lt;br&gt;</code> <br>  We are waiting for the end of the download: <br><br> <code>ff.wait_until{ff.div(:id,"resultsList").div(:class,"module").exists?}&lt;br&gt;</code> <br>  wait_until is a very important instruction.  When submitting a form on the site, several redirects are made, and after - ajax request.  You need to wait for the final page load, and only AFTER this work with the dom-tree.  How do I know that the page has loaded?  Need to see what elements appear on the page after ajax.  In our case, after a request to /pub/gwt/hotel/esf/hotelresultlist.gwt-rpc, several <code>&lt;div class="module"&gt;</code> elements appear in the resultsPage.  We are waiting until they appear.  I note that some commands, such as text_field, submit, already include wait_until, so this command is not needed before them. <br><br>  Now we are going through the pages: <br><br> <code>while true do&lt;br&gt; ff.wait_until{ff.div(:id,"resultsList").div(:class,"module").exists?}&lt;br&gt; ...&lt;br&gt; next_link = ff.div(:id,"resultcontrol-top").link(:text,"Next")&lt;br&gt; if (next_link.exists?) then next_link.click else break end&lt;br&gt;end&lt;br&gt;</code> <br>  Where there is an ellipsis in the code, there is a direct pulling of the data.  There is a temptation to apply watir and in this case, for example, run on all the divs in the resultsList with this command: <br><br> <code>ff.div(:id,"resultsList").divs.each.do |div|&lt;br&gt; if (div.class_name != "module") then next end&lt;br&gt; ...&lt;br&gt;end&lt;br&gt;</code> <br>  And from each diva pull out the hotel name and price: <br><br> <code>m = div.h2(:class,"property-name").html.match(/propertyId=(\d+)[^&lt;&gt;]*&gt;([^&lt;&gt;]*)&lt;\/a[^&lt;&gt;]*&gt;/)&lt;br&gt;data["id"] = m[1] unless m.nil?&lt;br&gt;data["name"] = m[2] unless m.nil?&lt;br&gt;data["price"] = div.h3(:class,"price").text&lt;br&gt;</code> <br>  But this should not be done.  Each watir command to dom-tree elements is an extra request to the browser.  I work for about a second.  Much more efficiently for the same second at a time to pull out the entire dom and instantly parse the regular regulars: <br><br> <code>ff.div(:id,"resultsList").html.split(/&lt;div[^&lt;&gt;]*class\s*=\s*["']?module["']?[^&lt;&gt;]*&gt;/).each do |str|&lt;br&gt;m = str.match(/&lt;a[^&lt;&gt;]*propertyId=(\d+)[^&lt;&gt;]*&gt;([\s\S]*?)&lt;\/a[^&lt;&gt;]*&gt;/)&lt;br&gt; data["id"] = m[1] unless m.nil?&lt;br&gt; data["name"] = m[2] unless m.nil?&lt;br&gt; m = str.match(/&lt;h3[^&lt;&gt;]*class\s*=\s*["']?price["']?[^&lt;&gt;]*&gt;([\s\S]*?)&lt;\/h3[^&lt;&gt;]*&gt;/)&lt;br&gt; data["price"] = m[1] unless m.nil?&lt;br&gt;end&lt;br&gt;</code> <br>  I advise you to use watir only where necessary.  Filling and submitting forms, waiting until the browser executes js code, and then - getting the final html-code.  Yes, access to the values ‚Äã‚Äãof elements via watir seems more reliable than parsing the code flow without a dom structure.  To pull out the inside of some diva, inside of which there may be other divs, you need to write a hard-to-read regular expression.  But still it is much faster.  If there are many such divs, the simplest solution is to use a simple recursive function to break the whole code by tag nesting level.  I wrote such a thing in <a href="https://github.com/Kasheftin/pageparser">one of its class in php</a> . </div><p>Source: <a href="https://habr.com/ru/post/109835/">https://habr.com/ru/post/109835/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109823/index.html">Grid Mousepad</a></li>
<li><a href="../109825/index.html">And I love tenders!</a></li>
<li><a href="../109827/index.html">Stellarium 0.10.6: Short Guide</a></li>
<li><a href="../109831/index.html">Kharkov office</a></li>
<li><a href="../109832/index.html">Seize the moment</a></li>
<li><a href="../109836/index.html">PBX Yeastar MyPBX 1600 - Iron Asterisk</a></li>
<li><a href="../109838/index.html">We collect home NAS on Intel Atom</a></li>
<li><a href="../109839/index.html">Rover throws users of the action "Music without borders"</a></li>
<li><a href="../109840/index.html">Hackers have launched ad campaigns in advertising networks of Google and Microsoft</a></li>
<li><a href="../109841/index.html">Samsung has released a new type of flexible AMOLED-display</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>