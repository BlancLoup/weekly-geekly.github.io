<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chew linear-square regulator to control the inverted pendulum</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preamble 
 I continue the detailed description of the use of a linear-quadratic regulator on the example of control of an inverted pendulum. By the wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chew linear-square regulator to control the inverted pendulum</h1><div class="post__text post__text-html js-mediator-article"><h1>  Preamble </h1><br>  I continue the detailed description of the use of a linear-quadratic regulator on the example of control of an inverted pendulum.  By the way, the term ‚ÄúLCR‚Äù very inaccurately captures the essence of what is happening, as I have already been suggested in the comments, in the Russian school of control theory this approach is called ‚Äúanalytical design of optimal regulators‚Äù, which is significantly more accurate. <br><br>  <i>As usual, I try to chew up the math to the maximum so that the material is available to the interested student.</i>  <i>I am deeply convinced that the use of mathematics in an amicable way should be paid: any formula should be used only when it is intended to facilitate understanding, and not to show off.</i> <br><br>  So, this is the fourth article, for a better understanding of what is happening, it would be nice to read the previous three: <br><ul><li>  1. <a href="https://habrahabr.ru/post/277275/"><b>Least squares methods</b></a> </li><li>  2. <a href="https://habrahabr.ru/post/277671/"><b>Linear square controller, introductory</b></a> </li><li>  3. <a href="https://habrahabr.ru/post/280486/"><b>DC motor control with linear-square controller</b></a> </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here is a picture of the system (clickable): <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d3f/c9f/b0e/d3fc9fb0eb13163ee9be6a54ec7bac47.jpg"></a> <br><a name="habracut"></a><br><h1>  Used sensors </h1><br>  I have only two sources of information about what is happening in the system, these are two incremental encoders, one (1000 pulses per revolution) indicates the position of the carriage, the second (2000 pulses per revolution) gives the position of the pendulum itself.  In the previous article I considered pulses with the help of the Arduin itself, but this is rather inaccurate and poorly resistant to noisy readings of encoders.  In addition, it spends the already weak computing resources atmega.  Now I have installed one <a href="http://www.avagotech.com/docs/AV02-0096EN">HCTL-2032</a> microcircuit (about five euros per aliexpress), it can count the pulses of two encoders, providing 32-bit counters for this.  To save Arduin's legs, there is 74hc165 between the counter and the Arduina itself, reading one byte in parallel and delivering this byte in series. <br><br><h1>  We measure the parameters of the engine again </h1><br>  Compared to the previous article, I have slightly changed the system parameters (another engine driver plus put the encoder on the carriage), so I measure the system parameters again.  So, with a small step (about one volt, from -24V to 24V), I apply a constant voltage to the motor and measure the change in the speed of the carriage.  The carriage speed is considered as the difference between the adjacent carriage positions divided by the past tense (the correctness of this approach is later).  The code used can be seen <a href="">here</a> . <br><br>  Horizontal time in seconds, and the vertical speed of the carriage in meters per second.  Noisy curves are the results of a real measurement; smooth curves are my mathematical model of the system.  At present, the task is to calculate the model for smooth curves that approximate reality. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c3b/113/303/c3b113303821dab5f5968d80e0dae37a.png"><br><br>  It turned out that I had slightly overdone it with a motor, at 24V the carriage accelerates by about 60 meters per second per second and the system's rigidity is not enough for a reasonable measurement of anything.  Therefore, I cut the measurements at fifteen volts; in the initial part of the curves one can see oscillations in the speed of the carriage. <br><br>  So, for each measurement, I consider the steady-state speed (plateau height) and draw a graph, on which the applied voltage is horizontally and the steady-state speed is vertical. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5eb/546/193/5eb546193776fe00051e2a057640a60d.png"><br><br>  If I had no friction in the system, then this graph would be linear, and my model would be constructed as v_ {k + 1} = a * v_k + b * u_k.  And after all, it is almost linear in its positive and negative parts at the same time, but these two straight lines do not pass through zero.  This is (including) due to friction.  We see that if at a positive voltage we add, and at a negative we literally take a fraction of a volt, the graph will pass through zero and become linear. <br><br>  If we want to take into account the friction in the system, then the model is constructed as follows (do not forget to read the previous article, if it is not clear where this formula comes from): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7eb/384/afa/7eb384afab7385fd6cd212fd17b1bac1.png"><br><br>  So, with the data, we need to find the values ‚Äã‚Äãof a, b, and c.  Fitting can be done as you please, given that it is done only once on the desktop, you can simply make three nested cycles.  <a href="https://github.com/ssloy/tutorials/blob/master/tutorials/pendulum/measurements/measurements.py">Here is</a> the fitting code that tells me that for a 20ms sampling between measurements, a = .4, b = .06, c = -. 01.  That is, the voltage required to compensate for friction in my system is equal to one tenth of a volt.  The curves obtained by this approximation are superimposed on the real measurement in the picture above. <br><br><h1>  We control the applied force, not the voltage </h1><br>  Total, at the moment our system can be written as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ab3/166/a83/ab3166a83716a64ef1bac3144511117d.png"><br><br>  Unfortunately, this is not a linear differential equation of the form x_ {k + 1} = A x_k + B u_k, which is necessary for a linear-quadratic regulator.  In addition, even if it were not for this, then I need to add another pendulum to the carriage, but I do not know how to derive the dependence of the position and angular velocity of the pendulum on the voltage.  I would prefer that, as a control, I would have not the tension, but the acceleration of the carriage itself: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/31e/ea3/7b3/31eea37b31b5be675a1d946e8b2020e2.png"><br><br>  <i>Strictly speaking, x_ {k + 1} = x_k + dt v_k + (dt) ^ 2/2 a_k, but for dt = .02 seconds (dt) ^ 2/2 equals .0002, which is already negligible, therefore discarded from records</i> <br><br>  OK, suppose my regulator uses acceleration as a control.  But in fact, in reality, I have to apply voltage to the motor.  How to get it?  Very simple: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d6f/9fa/e34/d6f9fae34808f7e22d6f3b5612124169.png"><br><br>  That is, having the current speed (system state), we can easily calculate the voltage that must be applied to obtain the necessary acceleration.  Thus, we killed two birds with one stone at a time: and we got rid of the nonlinearity in the regulator, but at the same time leaving the friction compensation, and got an intuitive control.  It is much easier for me to imagine acceleration rather than voltage, which has a very non-linear effect on speed. <br><br><h1>  Simple but long math or add a pendulum </h1><br><h3>  Equations of motion of a pendulum </h3><br>  So, the task is to add a pendulum to our system and write the corresponding linear equations for the controller.  Let's give a complete list of the necessary physical quantities for this: <br><br><ul><li>  m: mass of the pendulum </li><li>  M: carriage weight </li><li>  f: force applied by the motor to the carriage through the belt </li><li>  2l: pendulum length (l is the distance from the loop to the center of mass of the pendulum) </li><li>  I: moment of inertia of the pendulum (by the way, do your fonts allow you to see the difference between I and l?) </li><li>  Œ∏ (t): the angle of deflection of the pendulum from the vertical, zero in the unstable equilibrium position, increases clockwise </li><li>  x (t): carriage position </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/b56/0eb/031/b560eb03131aa239d3263fd056367d6a.png"><br><br>  In total, the variables of my system will be a four-dimensional vector consisting of the position of the carriage, its speed, the angle of deflection of the pendulum and its angular velocity.  The task now is to write a system of linear differential equations of this kind: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/49d/d34/891/49dd348911352615c399afbbd6387beb.png"><br><br>  If we manage to record it in continuous form, then we simply discretize and we won the fight.  Please note that here I use as a control the applied force, not acceleration, but Newton's second law will show us how to do this.  So, we need to find the unknown matrices A and B. <br><br>  Let us write Newton's second law for the carriage: the acceleration of the carriage multiplied by the mass equals the sum of two horizontal forces: the first force is our control, the force applied through the belt by the electric motor.  The second force is the force with which the pendulum, trying to fall or rise, pushes the carriage to the side.  To find it, we can write the coordinates of the center of the mass of the pendulum as a two-dimensional vector (x (t) + l sin (Œ∏ (t)), l cos (Œ∏ (t))).  If we differentiate twice the coordinate, we get acceleration, and the force is the acceleration to the mass.  Since we are only interested in the horizontal component, it makes sense to take only the second derivative of x (t) + l sin (Œ∏ (t). Total: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ebe/9bb/244/ebe9bb24489ad2ff176c9c20c973e9a9.png"><br><br>  This is a non-linear equation, but it can be well approximated linear around an equilibrium point.  If the angle is close to zero, then the first remarkable limit (well, or the Taylor series) says that the sine of the angle is approximately equal to the angle.  The same for cosine: for angles close to zero, the cosine is almost equal to one.  Well, in the same way, we neglect the powers, starting with the square (if we have a speed equal to .1 radians per second, then the square of the speed will give a very small contribution (.01), so we ignore them boldly): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a54/f43/f2d/a54f43f2db01b976fac8bd9bb7975fe6.png"><br><br>  Then the previous equation can be approximated linear: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/993/42e/254/99342e25477ec14c7d289c3860ea6cf3.png"><br><br>  Now we write Newton's second law (version for rotation) for the pendulum.  For a start, what is Newton's second law for rotation?  This sum of the moments is equal to the angular acceleration multiplied by the moment of inertia.  The moment of inertia is such an analogue of mass for translational motion.  We are interested in the projection of all forces on the straight line, perpendicular to the pendulum (after all, only the perpendicular component rotates, right?) Well, of course, these forces must be multiplied by the shoulder to get a moment.  The forces acting on the pendulum are three: gravity and the horizontal and vertical components of the support reaction force, which we can get as last time, twice taking the time derivative of the coordinates of the center of mass of the pendulum: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/pendulum/doc/f08.png"><br><br>  Let's approximate it with a linear equation: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/pendulum/doc/f09.png"><br><br>  We write equations (1) and (2) into the system: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/pendulum/doc/f10.png"><br><br>  For convenience, we call the determinant of the matrix the letter D: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/pendulum/doc/f11.png"><br><br>  Let's reverse the matrix: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/pendulum/doc/f12.png"><br><br>  Now we write our differential equations, in fact, we found the matrices A and B: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/pendulum/doc/f13.png"><br><br><h3>  Discretize the linear system </h3><br><br>  So, we have written the continuous differential equation: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/pendulum/doc/f14.png"><br><br>  For a constant step Œît we get the following: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/pendulum/doc/f15.png"><br><br>  If we denote by E the unit matrix 4x4, then we can write: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/pendulum/doc/f16.png"><br><br>  The moment of inertia for a rod that rotates around the end can be viewed <a href="https://en.wikipedia.org/wiki/List_of_moments_of_inertia">here</a> , so we simplify everything you can: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/pendulum/doc/f17.png"><br><br>  This is the most important equation of motion of the pendulum. <br><br><h1>  Line square controller </h1><br>  The code for calculating the coefficient of the regulator can be found <a href="https://github.com/ssloy/tutorials/blob/master/tutorials/pendulum/lqr.py">here.</a>  I used to use the smallest squares for counting, but it is still rather cumbersome, so in the new code the gain matrix is ‚Äã‚Äãconsidered directly.  Matlab for this is optional, quite enough for the usual python. <br><br>  So, LCR, we are told that if we take the controlling force f_k = 24.95 x_k + 18.54 v_k + 70.44 Œ∏_k + 14.96 œâ_k, then we should get the following behavior systems: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/324/ab2/96d/324ab296dd4bcc89c3647a0056d41219.png"><br><br>  x_k is the position of the carriage, v_k is its speed, Œ∏_k is the angle of the pendulum, œâ_k is its angular velocity.  The voltage on the graph is given in tens of volts to roughly equalize the scales of the three graphs. <br><br><h1>  We score coefficients in arduin </h1><br>  This is how I got a pendulum, the control code can be viewed <a href="">here</a> : <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/BgGslwu8Bec%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhiNZ0Ri-eNjFeIm1HMfW-WPu2MkpQ" frameborder="0" allowfullscreen=""></iframe><br><br>  In principle, I am quite pleased with the result so far.  The amplitude of the deviation of the carriage from the desired position in the area of ‚Äã‚Äãtwo centimeters, which is pretty decent.  Why does it not stand still rooted to the zero position, catching the deviations of the pendulum with very small movements?  There are several reasons.  The simplest is a gap in the gearbox of the motor, which is about five millimeters of the carriage position, which means that the carriage is quite expensive to change the direction of movement.  The next, and no less important reason is the estimate of the angular velocity of the motion of the pendulum (and of the velocity of the carriage). <br><br>  How to estimate the speed of movement, if only an incremental encoder is available?  The easiest way is to take the last two values ‚Äã‚Äãof the encoder and divide their difference by the past tense. This is known as <a href="https://en.wikipedia.org/wiki/Finite_difference">finite differences</a> and is widely used in practice. <br><br>  Let's look at the following chart: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/949/653/817/9496538179a8f1678f86334cbe17d1ef.png"><br><br>  I recorded the angle of the pendulum for a few seconds, it is shown in red.  The graph is a bit noisy due to the resolution of the encoder, but overall it‚Äôs pretty smooth.  The speed we have to find synthetically from the history of the position of the pendulum.  If we take directly the difference of two neighboring positions and divide by 20 milliseconds, then this will give us a blue graph.  The advantage of finite differences is that they are very easy to program.  Their disadvantage is that they dramatically amplify any measurement noise. <br><br>  If we take this estimate of speed, then the regulator goes crazy: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/p00H2Q4OBEE%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhfCmh-ux-8RgnNJJEDqzZLCusCsg" frameborder="0" allowfullscreen=""></iframe><br><br>  The only difference with the previous video is the speed rating, nothing else. <br><br>  In an amicable way, one would need to approximate the red curve by some polynomial, and assume its derivative is the main idea of ‚Äã‚Äãthe <a href="https://en.wikipedia.org/wiki/Savitzky%25E2%2580%2593Golay_filter">Savitsky-Golay filter</a> .  In order not to rack my brains, I simply smoothed the speed estimate, taking not the next samples, but the difference of the current sample and eight samples ago, dividing by (20ms * 8).  This approach greatly smoothes the speed estimate, but its disadvantage is that it lags the system.  Look at the green curve: it is clearly behind the real situation.  Such a delay in the estimation makes my pendulum sway slightly. <br><br>  By the way, if you take the Savitsky-Golay filter in the forehead, it will also create a similar delay.  Thus, I found a reasonable compromise for me between achieving the goal and the simplicity of artillery.  I plan to deal with noisy measurements with completely different methods, this is a topic for future conversations.  Also in subsequent conversations will include the automatic swing of the pendulum, so that he himself rises from the lower to the upper state. <br><br>  Stay tuned! </div><p>Source: <a href="https://habr.com/ru/post/301276/">https://habr.com/ru/post/301276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301258/index.html">Strelki.js - another library for working with arrays</a></li>
<li><a href="../301262/index.html">Difficult to translate distribution agreements</a></li>
<li><a href="../301268/index.html">Yandex.Algorithm. Analysis of last year's qualifying round and the last chance to participate in the championship</a></li>
<li><a href="../301270/index.html">12 ideas on how to improve game localization</a></li>
<li><a href="../301274/index.html">Fifth "Webmaster" right now</a></li>
<li><a href="../301278/index.html">Why automation of work with the client sometimes does not help, but hinders</a></li>
<li><a href="../301282/index.html">Router on Golang</a></li>
<li><a href="../301286/index.html">What are the bad sample solutions for ‚Äúquick launch‚Äù of your own business?</a></li>
<li><a href="../301288/index.html">Experience of moving to a Single Page Application with an emphasis on SEO</a></li>
<li><a href="../301290/index.html">UX for beginners: a practical guide. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>