<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Embedding PyPy Code in C Applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Note translator: 
 As correctly suggested in the comments, in spite of the title, this article will focus not on directly embedding code, but on creat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Embedding PyPy Code in C Applications</h1><div class="post__text post__text-html js-mediator-article">  <i>Note</i>  <i>translator:</i> <i><br></i>  <i>As correctly suggested in the comments, in spite of the title, this article will focus not on directly embedding code, but on creating shared libraries in Python.</i>  <i>But since this is just a translation, I decided to leave the name closer to the original.</i> <br><hr><br><img src="https://habrastorage.org/files/b1c/71c/b62/b1c71cb6299741fc9b60f3500f199c27.jpg" align="left">  At the <a href="http://www.pygrunn.org/">PyGrunn 2016</a> conference, I gave a talk on the Python <i>cffi</i> package and its use for embedding PyPy code in C applications. <br><br>  With the release of <i>cffi 1.5.0</i> and its subsequent inclusion in PyPy 5, it becomes possible to embed PyPy code.  This is done by compiling Python code into a dynamic library, which can then be used in any other language.  In this article, I will show you how to do this. <br><a name="habracut"></a><br><h2>  Embedded API </h2><br>  The first step is to define an interface that defines how the C application should call our Python code.  We need to point this out using prototypes of C functions.  For our example, we consider a function that performs some kind of computation, but, of course, it can be anything. <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> first, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> second)</span></span></span></span>;</code> </pre> <br>  Now we need to implement these calculations in Python: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> my_library <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ffi, lib @ffi.def_extern() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(first, second)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""      . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> abs(first - second)</code> </pre><br>  This fragment contains several special things for its proper embedding.  The first line imports <code>ffi</code> and <code>lib</code> objects from a dynamic library.  By doing this, the implementation accesses the functions provided by cffi and can be used for more complex tasks, such as allocating memory.  The name <code>my_library</code> defined below and corresponds to the name of our dynamic library. <br><br>  The second thing we notice in this fragment is the decorator <code>@ffi.def_extern</code> .  He tells cffi that the decorated functions should be represented in a public API created by the C library.  Decorated functions will be matched with the prototypes specified in the API declaration and their arguments, and the returned values ‚Äã‚Äãwill be converted automatically. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Script generating library </h2><br>  Now that we have an API and its implementation, we need to actually embed it somewhere.  For this we use a script that generates a dynamic library.  It requires that the two code snippets listed above are in the <code>api.h</code> and <code>implementation.py</code> files. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cffi ffi = cffi.FFI() ffi.embedding_api(open(<span class="hljs-string"><span class="hljs-string">"api.h"</span></span>).read()) ffi.embedding_init_code(open(<span class="hljs-string"><span class="hljs-string">"implementation.py"</span></span>).read()) ffi.set_source(<span class="hljs-string"><span class="hljs-string">"my_library"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) ffi.compile(verbose=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre><br>  This script is very simple.  We must specify our API and provide its implementation.  Both are read from disk and correspond to the code snippets given in the previous section. <br><br>  After specifying the source code, we must say cffi the name of our library.  In this example, this is <code>my_library</code> .  In addition, there is a place to add additional C-code that provides types for the header file of our API, for example, by including the appropriate header files (which is not allowed in <code>embedding_api</code> ).  It remains only to compile the source code to create a file of our library. <br><br>  Running the script displays some information and creates our library: <br><pre> <code class="bash hljs">$ pypy embed.py generating ./my_library.c running build_ext building <span class="hljs-string"><span class="hljs-string">'my_library'</span></span> extension ... $ ls my_library.dylib -rwxr-xr-x 1 djinn staff 9856 May 15 14:46 my_library.dylib</code> </pre><br>  All that's left is to use it somewhere! <br><br><h2>  Using application </h2><br>  Using embedded Python code is actually very simple.  You can do this with the following code: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include "api.h" int main(void) { float result = compute(12.34f, 10.0f); printf("The result: %f\n", result); return 0; }</span></span></span></span></code> </pre><br>  As you can see, almost nothing is needed to call our Python code.  Using the CPython API, you would have to start the interpreter and perform many parameter and return value conversions.  But not with cffi!  The library created takes over, so you can focus on really useful work.  The last thing I have to show you is how to compile and run this code. <br><pre> <code class="bash hljs">$ clang -o <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> test.c my_library.dylib $ ./<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> The result: 2.340000</code> </pre><br>  And here it is!  With just a few lines of code, we wrote a C program that runs the PyPy interpreter and executes our Python code as if it were C code. Of course, I showed you only the basics, but this is really powerful technology.  For more information, see the <a href="http://cffi.readthedocs.io/en/latest/embedding.html">cffi documentation</a> . </div><p>Source: <a href="https://habr.com/ru/post/302050/">https://habr.com/ru/post/302050/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302028/index.html">Why does Amazon have such a low profit with such a high revenue?</a></li>
<li><a href="../302030/index.html">They are not taken into programmers: "reverse engineering" of the person</a></li>
<li><a href="../302032/index.html">Creating a blog on symfony 2.8 lts [Part 2]</a></li>
<li><a href="../302044/index.html">ReactOS 0.4.2 will be excellent</a></li>
<li><a href="../302046/index.html">Dash Financing and Management System</a></li>
<li><a href="../302056/index.html">Telegram Site Helper 2.0 - chat assistant for a site based on Telegram</a></li>
<li><a href="../302060/index.html">IT & Security Forum 2016 is over</a></li>
<li><a href="../302062/index.html">[PF] Print PDF under .NET, vector approach, practice</a></li>
<li><a href="../302066/index.html">Vacation programmatically, or as I did not participate in the competition for programming on JS. Part two</a></li>
<li><a href="../302068/index.html">Overview of options for organizing access to corporate network services from the Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>