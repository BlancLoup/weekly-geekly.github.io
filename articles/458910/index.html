<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Benchmarking PostgreSQL with large Linux pages</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Linux kernel provides a wide range of configuration options that can affect performance. It's all about getting the right configuration for your a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Benchmarking PostgreSQL with large Linux pages</h1><div class="post__text post__text-html js-mediator-article"><img width="40%" align="left" src="https://habrastorage.org/webt/u0/hs/uc/u0hsucgpyp_pgw1mwtyzdtkvd1o.jpeg">  The Linux kernel provides a wide range of configuration options that can affect performance.  It's all about getting the right configuration for your application and workload.  Like any other database, PostgreSQL uses the Linux kernel for optimal configuration.  Poorly configured settings can result in poor performance.  Therefore, it is important that you measure database performance after each tuning session to avoid performance degradation.  In one of my previous publications, ‚ÄúTuning Linux Kernel Parameters for PostgreSQL Optimization,‚Äù I described some of the most useful parameters of the Linux kernel and how they can help you improve database performance.  Now I‚Äôm going to share my test results after setting up large Linux pages with another PostgreSQL workload.  I ran a comprehensive test suite for various PostgreSQL download sizes and simultaneous number of clients. <br><br><h2>  Testing machine </h2><br><ul><li>  Supermicro server: <br><ul><li>  Intel¬Æ Xeon¬Æ CPU E5-2683 v3 @ 2.00GHz </li><li>  2 sockets / 28 cores / 56 threads </li><li>  Memory: 256GB of RAM </li><li>  Storage: SAMSUNG SM863 1.9TB Enterprise SSD </li><li>  Filesystem: ext4 / xfs </li></ul></li><li>  OS: Ubuntu 16.04.4, kernel 4.13.0-36-generic </li><li>  PostgreSQL: version 11 </li></ul><a name="habracut"></a><br><h2>  Linux kernel settings </h2><br>  I used the default kernel settings without any optimization / tuning other than disabling the transparent large pages (Transparent HugePages).  Transparent large pages are enabled by default and highlight the page size, which may not be recommended for use by the database.  As a rule, databases require large, fixed-size pages that are not covered by large transparent pages.  Therefore, it is always recommended to disable this feature and use classic large pages by default. <br><br><h2>  PostgreSQL settings </h2><br>  I used the same PostgreSQL settings for all the tests to record different PostgreSQL workloads with different settings for large Linux pages.  Here is the PostgreSQL setting used for all tests: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <sup>postgresql.conf</sup> <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">shared_buffers</span></span> = <span class="hljs-string"><span class="hljs-string">'64GB'</span></span> work_mem = <span class="hljs-string"><span class="hljs-string">'1GB'</span></span> random_page_cost = <span class="hljs-string"><span class="hljs-string">'1'</span></span> maintenance_work_mem = <span class="hljs-string"><span class="hljs-string">'2GB'</span></span> synchronous_commit = <span class="hljs-string"><span class="hljs-string">'on'</span></span> seq_page_cost = <span class="hljs-string"><span class="hljs-string">'1'</span></span> max_wal_size = <span class="hljs-string"><span class="hljs-string">'100GB'</span></span> checkpoint_timeout = <span class="hljs-string"><span class="hljs-string">'10min'</span></span> synchronous_commit = <span class="hljs-string"><span class="hljs-string">'on'</span></span> checkpoint_completion_target = <span class="hljs-string"><span class="hljs-string">'0.9'</span></span> autovacuum_vacuum_scale_factor = <span class="hljs-string"><span class="hljs-string">'0.4'</span></span> effective_cache_size = <span class="hljs-string"><span class="hljs-string">'200GB'</span></span> min_wal_size = <span class="hljs-string"><span class="hljs-string">'1GB'</span></span> wal_compression = <span class="hljs-string"><span class="hljs-string">'ON'</span></span></code> </pre> <br><h2>  Testing scheme </h2><br>  In testing the testing scheme plays an important role.  All tests are performed three times for 30 minutes for each run.  I took the average of these three indicators.  Tests were conducted using the PostgreSQL <a href="https://www.postgresql.org/docs/current/pgbench.html">pgbench</a> performance testing tool.  pgbench works with a scale factor, with one scale factor of approximately 16 MB of workload. <br><br><h2>  Large pages (HugePages) </h2><br>  Linux uses 4 KB of memory by default, along with large pages.  BSD has Super Pages, while Windows has Large Pages.  PostgreSQL only supports large pages (Linux).  In cases of large memory usage, small pages degrade performance.  By installing large pages, you increase the allocated memory for the application and, therefore, reduce the transaction costs that occur during allocation / swapping;  that is, you increase productivity by using large pages. <br><br>  Here is the setting of large pages when using a large page size of 1 GB.  You can always get this information from / proc. <br><br>  <sup>$ cat / proc / meminfo |</sup>  <sup>grep -i huge</sup> <br><br><pre> <code class="nginx hljs">AnonHugePages: 0 <span class="hljs-attribute"><span class="hljs-attribute">kB</span></span> ShmemHugePages: <span class="hljs-number"><span class="hljs-number">0</span></span> kB HugePages_Total: <span class="hljs-number"><span class="hljs-number">100</span></span> HugePages_Free: <span class="hljs-number"><span class="hljs-number">97</span></span> HugePages_Rsvd: <span class="hljs-number"><span class="hljs-number">63</span></span> HugePages_Surp: <span class="hljs-number"><span class="hljs-number">0</span></span> Hugepagesize: <span class="hljs-number"><span class="hljs-number">1048576</span></span> kB</code> </pre> <br>  For more information on large pages, please read my previous blog post. <br><br>  <a href="https://www.percona.com/blog/2018/08/29/tune-linux-kernel-parameters-for-postgresql-optimization/">https://www.percona.com/blog/2018/08/29/tune-linux-kernel-parameters-for-postgresql-optimization/</a> <br><br>  Usually the size of large pages is 2 MB and 1 GB, so it makes sense to use the size of 1 GB instead of the much smaller size of 2 MB. <br><br>  <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/s-memory-transhuge">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/s-memory-transhuge</a> <br>  <a href="https://kerneltalks.com/services/what-is-huge-pages-in-linux/">https://kerneltalks.com/services/what-is-huge-pages-in-linux/</a> <br><br><h2>  Test results </h2><br>  This test shows the overall effect of different sizes of large pages.  The first test set was created with a default page size in Linux of 4KB without the inclusion of large pages.  Note that the huge transparent pages were also turned off and remained off during all these tests. <br><br>  Then a second set of tests was performed with a large page size of 2 MB.  Finally, the third set of tests is performed with the size of large pages of 1 GB. <br><br>  All of these tests were performed in PostgreSQL version 11. The kits include a combination of different database sizes and clients.  The graph below shows comparative performance results for these tests with TPS (transactions per second) on the Y axis, database size and number of clients per database size on the X axis. <br><br><img src="https://habrastorage.org/webt/1k/pu/1r/1kpu1rufj-fpl3iszxtzvnjxfgg.png"><br><br>  From the above graph, it can be seen that performance gains with large pages increase with increasing number of clients and database size if the size remains in a previously allocated buffer in shared memory (shared buffer). <br><br>  This test shows TPS versus client count.  In this case, the size of the database is 48 GB.  On the Y axis, we have TPS, and on the X axis, we have the number of connected clients.  The size of the database is small enough to fit in the shared buffer, which is set to 64 GB. <br><br><img src="https://habrastorage.org/webt/fc/j_/kn/fcj_knw5ujqg-vvyzcxnl2wkclu.png"><br><br>  If large pages are set to 1 GB, then the more customers, the higher the relative performance increase. <br><br>  The following graph is the same as above, except for the database size of 96 GB.  This exceeds the size of the shared buffer, which is set to 64 GB. <br><br><img src="https://habrastorage.org/webt/z8/6r/je/z86rjeljjqfr_nyaylzzpv7xf9q.png"><br><br>  The key observation here is that performance with large pages of 1 GB increases as the number of clients increases, and ultimately it gives more performance than large pages of 2 MB or a standard page size of 4 KB. <br><br>  This test shows TPS depending on the size of the database.  In this case, the number of connected clients is 32. On the Y axis, we have TPS, and on the X axis, the size of the database. <br><br><img src="https://habrastorage.org/webt/cg/90/oi/cg90oidu2mlqyp40deo9fzcmlki.png"><br><br>  As expected, when the database goes beyond the pre-allocated large pages, performance drops significantly. <br><br><h2>  Summary </h2><br>  One of my key recommendations is that we need to turn off transparent large pages (Transparent HugePages).  You will see the greatest performance gains when the database is placed in a shared buffer with large pages enabled.  Choosing the size of large pages requires a small amount of trial and error, but this can potentially lead to a significant increase in TPS when the size of the database is large, but remains small enough to fit into the shared buffer. </div><p>Source: <a href="https://habr.com/ru/post/458910/">https://habr.com/ru/post/458910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458902/index.html">5 common mistakes novice programmers in Python</a></li>
<li><a href="../458904/index.html">Visualizing the number of wins for NBA teams using animated bar charts in R</a></li>
<li><a href="../458906/index.html">[Ekaterinburg, Announcement] Flutterton - workshop about the development on Flutter</a></li>
<li><a href="../458908/index.html">Scanning documents online</a></li>
<li><a href="../45891/index.html">Overview of MQ (Messages queue) for use in projects on PHP. Part 2</a></li>
<li><a href="../458912/index.html">Migrate to Zimbra with imapsync</a></li>
<li><a href="../458914/index.html">What (not) you need to know to create games on Unity</a></li>
<li><a href="../458916/index.html">Under the hood of React. We write our implementation from scratch</a></li>
<li><a href="../458918/index.html">What can you learn from the design of giperkazualnyh games</a></li>
<li><a href="../45892/index.html">Stages of development of a promotional site. Request</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>