<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The secret of object-oriented development in Rails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will provide you with a translation of the post of Steve Klabnik, a well-known developer, Ruby devotee, one of the winners of the Ruby Hero A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The secret of object-oriented development in Rails</h1><div class="post__text post__text-html js-mediator-article">  <i>Today we will provide you with a translation of the <a href="http://blog.steveklabnik.com/2011/09/06/the-secret-to-rails-oo-design.html">post of</a> Steve Klabnik, a well-known developer, Ruby devotee, one of the winners of the Ruby Hero Award this year.</i>  <i>What is this reward?</i>  <i>It is awarded by the winners of last year to those community members who showed themselves the most: they created significant learning content, developed plugins and gems, participated in open source projects.</i>  <i>Such an award was created to honor the most distinguished people and give them the recognition they deserve.</i> <i><br></i>  <i>You can <a href="http://rubyc.eu/">chat</a> with Steve at the <a href="http://rubyc.eu/">RubyC</a> conference in Kiev on November 5-6 this year.</i> <br><br>  I often tell people that I taught Ruby through Rails.  This is one of the worst ways, but by that time I had already learned so many programming languages ‚Äã‚Äãthat it did not bother me.  However, it gave me a slightly distorted sense of how carefully I designed the classes needed for Rails applications.  Fortunately, I biasedly look at the code written by others, and noticed that there is one important thing that is found in the development of many people I respect. <br><br>  I think these people also consider this thing unique.  This is not when people who cannot write good code try, but it still turns out badly.  It's like a flag signal.  Now, when I see someone injecting this thing, I immediately think: "he fumbles."  Maybe I trust my feelings too much, but this advanced development technique offers many interrelated advantages to your Rails applications, is easy to apply and speeds up testing by an order of magnitude or more.  Unfortunately, for many beginner Rails developers this is not obvious, but I would like <i>you to</i> write the code better and here I am, so that, with your permission, ‚Äúreveal the secret‚Äù and share this powerful technique with you. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  It's called "Old Simple Ruby Object" <br><br>  Yes exactly.  Ruby is a class that does not inherit anything.  It is so simple that it is hidden in a prominent place.  Favorite Rails creators, old simple Ruby Objects, or ‚ÄúPOROs‚Äù as some like to call them, are a hidden weapon against complexity.  That's what I mean.  Consider this ‚Äúsimple‚Äù model: <br><blockquote><code><a href="http://s-c.me/23126/s"></a> <a href="http://s-c.me/23126/h"></a> <font color="black">Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#cc6633">Post</font> &lt; <font color="#cc6633">ActiveRecord::Base</font> <font color="#0000ff">def self</font> .as_dictionary dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ).inject({}) {|h, l| h[l] = []; h} <font color="#cc6633">Post</font> .all.each <font color="#0000ff">do</font> | <font color="#0000ff">p</font> | dictionary[ <font color="#0000ff">p</font> .title[ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> <font color="#0000ff">end</font> dictionary <font color="#0000ff">end</font> <font color="#0000ff">end</font></font></code> <ol> <li> <code><font color="black"><a href="http://s-c.me/23126/s"></a> <a href="http://s-c.me/23126/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#cc6633">Post</font> &lt; <font color="#cc6633">ActiveRecord::Base</font> <font color="#0000ff">def self</font> .as_dictionary dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ).inject({}) {|h, l| h[l] = []; h} <font color="#cc6633">Post</font> .all.each <font color="#0000ff">do</font> | <font color="#0000ff">p</font> | dictionary[ <font color="#0000ff">p</font> .title[ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> <font color="#0000ff">end</font> dictionary <font color="#0000ff">end</font> <font color="#0000ff">end</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/23126/s"></a> <a href="http://s-c.me/23126/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#cc6633">Post</font> &lt; <font color="#cc6633">ActiveRecord::Base</font> <font color="#0000ff">def self</font> .as_dictionary dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ).inject({}) {|h, l| h[l] = []; h} <font color="#cc6633">Post</font> .all.each <font color="#0000ff">do</font> | <font color="#0000ff">p</font> | dictionary[ <font color="#0000ff">p</font> .title[ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> <font color="#0000ff">end</font> dictionary <font color="#0000ff">end</font> <font color="#0000ff">end</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/23126/s"></a> <a href="http://s-c.me/23126/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#cc6633">Post</font> &lt; <font color="#cc6633">ActiveRecord::Base</font> <font color="#0000ff">def self</font> .as_dictionary dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ).inject({}) {|h, l| h[l] = []; h} <font color="#cc6633">Post</font> .all.each <font color="#0000ff">do</font> | <font color="#0000ff">p</font> | dictionary[ <font color="#0000ff">p</font> .title[ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> <font color="#0000ff">end</font> dictionary <font color="#0000ff">end</font> <font color="#0000ff">end</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://s-c.me/23126/s"></a> <a href="http://s-c.me/23126/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#cc6633">Post</font> &lt; <font color="#cc6633">ActiveRecord::Base</font> <font color="#0000ff">def self</font> .as_dictionary dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ).inject({}) {|h, l| h[l] = []; h} <font color="#cc6633">Post</font> .all.each <font color="#0000ff">do</font> | <font color="#0000ff">p</font> | dictionary[ <font color="#0000ff">p</font> .title[ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> <font color="#0000ff">end</font> dictionary <font color="#0000ff">end</font> <font color="#0000ff">end</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/23126/s"></a> <a href="http://s-c.me/23126/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#cc6633">Post</font> &lt; <font color="#cc6633">ActiveRecord::Base</font> <font color="#0000ff">def self</font> .as_dictionary dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ).inject({}) {|h, l| h[l] = []; h} <font color="#cc6633">Post</font> .all.each <font color="#0000ff">do</font> | <font color="#0000ff">p</font> | dictionary[ <font color="#0000ff">p</font> .title[ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> <font color="#0000ff">end</font> dictionary <font color="#0000ff">end</font> <font color="#0000ff">end</font></font></code> </li> <li> <code><font color="black"><font color="#0000ff"><a href="http://s-c.me/23126/s"></a> <a href="http://s-c.me/23126/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#cc6633">Post</font> &lt; <font color="#cc6633">ActiveRecord::Base</font> <font color="#0000ff">def self</font> .as_dictionary dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ).inject({}) {|h, l| h[l] = []; h} <font color="#cc6633">Post</font> .all.each <font color="#0000ff">do</font> | <font color="#0000ff">p</font> | dictionary[ <font color="#0000ff">p</font> .title[ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> end dictionary <font color="#0000ff">end</font> <font color="#0000ff">end</font></font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://s-c.me/23126/s"></a> <a href="http://s-c.me/23126/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#cc6633">Post</font> &lt; <font color="#cc6633">ActiveRecord::Base</font> <font color="#0000ff">def self</font> .as_dictionary dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ).inject({}) {|h, l| h[l] = []; h} <font color="#cc6633">Post</font> .all.each <font color="#0000ff">do</font> | <font color="#0000ff">p</font> | dictionary[ <font color="#0000ff">p</font> .title[ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> <font color="#0000ff">end</font> dictionary <font color="#0000ff">end</font> <font color="#0000ff">end</font></font></code> </li> <li> <code><font color="black"><font color="#0000ff"><a href="http://s-c.me/23126/s"></a> <a href="http://s-c.me/23126/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#cc6633">Post</font> &lt; <font color="#cc6633">ActiveRecord::Base</font> <font color="#0000ff">def self</font> .as_dictionary dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ).inject({}) {|h, l| h[l] = []; h} <font color="#cc6633">Post</font> .all.each <font color="#0000ff">do</font> | <font color="#0000ff">p</font> | dictionary[ <font color="#0000ff">p</font> .title[ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> <font color="#0000ff">end</font> dictionary end <font color="#0000ff">end</font></font></font></code> </li> <li> <code><font color="black"><font color="#0000ff"><a href="http://s-c.me/23126/s"></a> <a href="http://s-c.me/23126/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#cc6633">Post</font> &lt; <font color="#cc6633">ActiveRecord::Base</font> <font color="#0000ff">def self</font> .as_dictionary dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ).inject({}) {|h, l| h[l] = []; h} <font color="#cc6633">Post</font> .all.each <font color="#0000ff">do</font> | <font color="#0000ff">p</font> | dictionary[ <font color="#0000ff">p</font> .title[ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> <font color="#0000ff">end</font> dictionary <font color="#0000ff">end</font> end</font></font></code> </li> </ol></blockquote><br>  We want to show a pointer to the first letter for all our posts.  To do this, we create a dictionary and put our posts in it.  Suppose we do not need to break the list into pages, so do not pay attention to the request of all posts from the database.  The idea is important: now we can show all posts by name: <br><blockquote> <code><a href="http://s-c.me/23127/s"></a> <a href="http://s-c.me/23127/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  - Post.as_dictionary <font color="#0000ff">do</font> | letter, list | </li><li>  % <font color="#0000ff">p</font> = letter </li><li>  % ul </li><li>  - list.each <font color="#0000ff">do</font> | post | </li><li>  % li = link_to post </li></ol></blockquote><br>  Of course.  On the one hand, the code is not <i>bad</i> .  But he is also not good: we are worried about the representation inside the model designed for business logic.  So let's fix this using the Presenter pattern: <br><br><blockquote> <code><a href="http://s-c.me/23128/s"></a> <a href="http://s-c.me/23128/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">DictionaryPresenter</font> </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">initialize</font> (collection) </li><li>  @collection = collection </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">as_dictionary</font> </li><li>  dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ) .inject ({}) {| h, l |  h [l] = [];  h} </li><li></li><li>  @ collection.each <font color="#0000ff">do</font> |  <font color="#0000ff">p</font> | </li><li>  dictionary [ <font color="#0000ff">p</font> .title [ <font color="#008000">0</font> ]] &lt;&lt; <font color="#0000ff">p</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  dictionary </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  Now we can use DictionaryPresenter.new (Post.all) .as_dictionary.  He has many advantages: we brought the logic of representation from the model.  We <i>have already</i> added a new feature: any collection can now be displayed with a pointer.  We can easily write separate tests for this representative class and they will be fast. <br><br>  Despite my love for the ‚ÄúRepresentative‚Äù pattern, this post is not about him.  This principle also appears in other places, ‚Äúthis concept deserves its own class‚Äù.  Before moving on to another example, let's expand this one: if we want to sort our posts by title, this class will work, but we will not be able to show, say, users, because users have no names (title fields).  Moreover, we get a large number of posts on "A", because the names often begin with the article "a", and in fact we need the first letter of the second word.  We can make 2 types of Representatives, but then we will lose generality and the concept of an ‚Äúindex‚Äù will again have 2 Representatives in our system.  As you understood correctly: PORO will save us! <br><br>  Let's slightly change our Representative to accept the policy object: <br><br><blockquote> <code><a href="http://s-c.me/23129/s"></a> <a href="http://s-c.me/23129/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">DictionaryPresenter</font> </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">initialize</font> (policy, collection) </li><li>  @policy = policy </li><li>  @collection = collection </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">as_dictionary</font> </li><li>  dictionary = ( <font color="#008000">'A'</font> .. <font color="#008000">'Z'</font> ) .inject ({}) {| h, l |  h [l] = [];  h} </li><li></li><li>  @ collection.each <font color="#0000ff">do</font> |  <font color="#0000ff">p</font> | </li><li>  dictionary [@ policy.category_for ( <font color="#0000ff">p</font> )] &lt;&lt; <font color="#0000ff">p</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  dictionary </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  Now we can add policies and make them different: <br><blockquote> <code><a href="http://s-c.me/23143/s"></a> <a href="http://s-c.me/23143/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">UserCategorizationPolicy</font> </li><li>  <font color="#0000ff">def self</font> .category_for (user) </li><li>  user.username [ <font color="#008000">0</font> ] </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">class</font> <font color="#cc6633">PostCategorizationPolicy</font> </li><li>  <font color="#0000ff">def self</font> .category_for (post) </li><li>  <font color="#0000ff">if</font> post.starts_with? ( <font color="#008000">"A"</font> ) </li><li>  post.title.  <font color="#0000ff">split</font> [ <font color="#008000">1</font> ] [ <font color="#008000">0</font> ] </li><li>  <font color="#0000ff">else</font> </li><li>  post.title [ <font color="#008000">0</font> ] </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li><li></li></ol></blockquote><br>  Bam! <br><blockquote> <code><a href="http://s-c.me/23130/s"></a> <a href="http://s-c.me/23130/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  DictionaryPresenter.  <b>new</b> (PostCategorizationPolicy, Post.all) .as_dictionary </li></ol></blockquote><br>  Yes, it gets a bit long.  It happens :) But now you can see that each concept has one idea in our system.  The representative does not care how things are arranged, and only politicians dictate how they are arranged.  In fact, my names are a bit lame, perhaps it would be better to call UsernamePolicy or TitlePolicy, actually.  We don't even care what class they are! <br><br>  And so in everything.  Combining Ruby's flexibility with my favorite example from Efficiently Working with Legacy Code, we can turn complex calculations into objects.  Take a look at this code: <br><br><blockquote> <code><a href="http://s-c.me/23131/s"></a> <a href="http://s-c.me/23131/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">Quote</font> &lt; <font color="#cc6633">ActiveRecord :: Base</font> </li><li>  <font color="#696969"># &lt;snip&gt;</font> </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">pretty_turnaround</font> </li><li>  <font color="#0000ff">return</font> <font color="#008000">""</font> <font color="#0000ff">if</font> turnaround.  <font color="#0000ff">nil</font> ? </li><li>  <font color="#0000ff">if</font> purchased_at </li><li>  offset = purchased_at </li><li>  days_from_today = (( <font color="#cc6633">Time</font> .now - purchased_at.to_time) / 60/60/24) .floor + <font color="#008000">1</font> </li><li>  <font color="#0000ff">else</font> </li><li>  offset = <font color="#cc6633">Time</font> .now </li><li>  days_from_today = turnaround + <font color="#008000">1</font> </li><li>  <font color="#0000ff">end</font> </li><li>  time = offset + (turnaround * <font color="#008000">60</font> * <font color="#008000">60</font> * <font color="#008000">24</font> ) </li><li>  <font color="#0000ff">if</font> (time.strftime ( <font color="#008000">"% a"</font> ) == <font color="#008000">"Sat"</font> ) </li><li>  time + = <font color="#008000">2</font> * <font color="#008000">60</font> * <font color="#008000">60</font> * <font color="#008000">24</font> </li><li>  <font color="#0000ff">elsif</font> (time.strftime ( <font color="#008000">"% a"</font> ) == <font color="#008000">"Sun"</font> ) </li><li>  time + = <font color="#008000">1</font> * <font color="#008000">60</font> * <font color="#008000">60</font> * <font color="#008000">24</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#008000">"# {time.strftime ("</font> % A% d% B <font color="#008000">")} (# {days_from_today} business days from today)"</font> </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  Oh!  This method displays the return (calculation) time, but, as you can see, this is a complex calculation.  We could understand it more simply if we used method extraction (Method Extract method of refactoring) several times to break it, but then we risk clogging our Quote class with more code only necessary for a nice calculation of time.  Also, please do not look at the fact that the model implements the presentation logic - this is just an example of a bulky code. <br><br>  So, now the first step of this refactoring, which Feather (the author of ‚ÄúWorking Effectively With the Legacy Code‚Äù) calls the ‚ÄúBreak Out Method Object‚Äù.  You can open your Working Effectively With Legacy Code on page 330 and read more.  If you do not have it, buy it :).  Actually, I digress.  Here is a plan of action: <br>  1. Create a new calculation class. <br>  2. Define in it a method for work in a new way. <br>  3. Copy the body of the old method and replace the references to pointers with objects. <br>  4. Create a constructor for it, which takes arguments to assign the variables used in step 3. <br>  5. Delegate the old method to the new class and method. <br><br>  I slightly changed the original Ruby template because we cannot rely on the compiler (Lean On The Compiler) and a few steps Feather does just that.  In any case, let's try on this code.  Step one: <br><br><blockquote> <code><a href="http://s-c.me/23132/s"></a> <a href="http://s-c.me/23132/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">Quote</font> &lt; <font color="#cc6633">ActiveRecord :: Base</font> </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">pretty_turnaround</font> </li><li>  <font color="#696969">#snip</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">class</font> <font color="#cc6633">TurnaroundCalculator</font> </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  Second: <br><br><blockquote> <code><a href="http://s-c.me/23133/s"></a> <a href="http://s-c.me/23133/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">TurnaroundCalculator</font> </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">calculate</font> </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  Third: <br><br><blockquote> <code><a href="http://s-c.me/23134/s"></a> <a href="http://s-c.me/23134/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">TurnaroundCalculator</font> </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">calculate</font> </li><li>  <font color="#0000ff">return</font> <font color="#008000">""</font> <font color="#0000ff">if</font> @turnaround.  <font color="#0000ff">nil</font> ? </li><li>  <font color="#0000ff">if</font> @purchased_at </li><li>  offset = @purchased_at </li><li>  days_from_today = (( <font color="#cc6633">Time</font> .now - purchased_at.to_time) / 60/60/24) .floor + <font color="#008000">1</font> </li><li>  <font color="#0000ff">else</font> </li><li>  offset = <font color="#cc6633">Time</font> .now </li><li>  days_from_today = @turnaround + <font color="#008000">1</font> </li><li>  <font color="#0000ff">end</font> </li><li>  time = offset + (@turnaround * <font color="#008000">60</font> * <font color="#008000">60</font> * <font color="#008000">24</font> ) </li><li>  <font color="#0000ff">if</font> (time.strftime ( <font color="#008000">"% a"</font> ) == <font color="#008000">"Sat"</font> ) </li><li>  time + = <font color="#008000">2</font> * <font color="#008000">60</font> * <font color="#008000">60</font> * <font color="#008000">24</font> </li><li>  <font color="#0000ff">elsif</font> (time.strftime ( <font color="#008000">"% a"</font> ) == <font color="#008000">"Sun"</font> ) </li><li>  time + = <font color="#008000">1</font> * <font color="#008000">60</font> * <font color="#008000">60</font> * <font color="#008000">24</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#008000">"# {time.strftime ("</font> % A% d% B <font color="#008000">")} (# {days_from_today} business days from today)"</font> </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  I like to give the usual names at the beginning, and then change them at step 5 after it is clear what exactly he does.  Most likely, our code itself will tell us a good name. <br><br>  Fourth: <br><br><blockquote> <code><a href="http://s-c.me/23135/s"></a> <a href="http://s-c.me/23135/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">TurnaroundCalculator</font> </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">initialize</font> (purchased_at, turnaround) </li><li>  @purchased_at = purchased_at </li><li>  @turnaround = turnaround </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">calculate</font> </li><li>  <font color="#696969">#snip</font> </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  Fifth: <br><br><blockquote> <code><a href="http://s-c.me/23136/s"></a> <a href="http://s-c.me/23136/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">Quote</font> &lt; <font color="#cc6633">ActiveRecord :: Base</font> </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">pretty_turnaround</font> </li><li>  TurnaroundCalculator.  <b>new</b> (purchased_at, turnaround) .calculate </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  Done!  We have to run the tests and see how they pass.  Even if ‚Äúrunning tests‚Äù means checking manually ... <br><br>  So what's the advantage?  Well, now we can begin the process of refactoring, but we are in our own little clean room.  We can add methods to our TurnaroundCalcuator class without clogging the Quote class, we can write quick tests for Calculator only and break the idea of ‚Äã‚Äãcalculations in one place where it can be easily changed later.  Here is our class after several refactorings: <br><br><blockquote> <code><a href="http://s-c.me/23137/s"></a> <a href="http://s-c.me/23137/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">TurnaroundCalculator</font> </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">calculate</font> </li><li>  <font color="#0000ff">return</font> <font color="#008000">""</font> <font color="#0000ff">if</font> @turnaround.  <font color="#0000ff">nil</font> ? </li><li></li><li>  <font color="#008000">"# {arrival_date} (# {days_from_today} business days from today)"</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  protected </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">arrival_date</font> </li><li>  <font color="#cc6633">real_turnaround_time</font> .strftime ( <font color="#008000">"% A% d% B"</font> ) </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">real_turnaround_time</font> </li><li>  <font color="#cc6633">adjust_time_for_weekends</font> ( <font color="#cc6633">start_time</font> + <font color="#cc6633">turnaround_in_seconds</font> ) </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">adjust_time_for_weekends</font> (time) </li><li>  <font color="#0000ff">if</font> <font color="#cc6633">saturday</font> ? (time) </li><li>  time + <font color="#008000">2</font> * <font color="#008000">60</font> * <font color="#008000">60</font> * <font color="#008000">24</font> </li><li>  <font color="#0000ff">elsif</font> <font color="#cc6633">sunday</font> ? (time) </li><li>  time + <font color="#008000">1</font> * <font color="#008000">60</font> * <font color="#008000">60</font> * <font color="#008000">24</font> </li><li>  <font color="#0000ff">else</font> </li><li>  time </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">saturday</font> ? (time) </li><li>  time.strftime ( <font color="#008000">"% a"</font> ) == <font color="#008000">"Sat"</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">sunday</font> ? (time) </li><li>  time.strftime ( <font color="#008000">"% a"</font> ) == <font color="#008000">"Sun"</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">turnaround_in_seconds</font> </li><li>  @turnaround * <font color="#008000">60</font> * <font color="#008000">60</font> * <font color="#008000">24</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">start_time</font> </li><li>  @purchased_at <font color="#0000ff">or</font> <font color="#cc6633">Time</font> .now </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">days_from_today</font> </li><li>  <font color="#0000ff">if</font> @purchased_at </li><li>  (( <font color="#cc6633">Time</font> .now - @ purchased_at.to_time) / 60/60/24) .floor + <font color="#008000">1</font> </li><li>  <font color="#0000ff">else</font> </li><li>  @turnaround + <font color="#008000">1</font> </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  Wow!  This code that I wrote 3 years ago is not perfect, but it can almost be understood.  And each piece makes sense.  This is after 2 or 3 waves of refactoring, which I will probably reveal in a separate post, because what has now turned out is somewhat more illustrative than I thought.  In any case, you get the idea.  This is what I mean when I say that it is aimed at five-line methods in Ruby;  if your code is clear, you can easily edit it. <br><br>  The idea of ‚Äã‚Äãextracting clean Ruby objects is also valid in Rails.  Look at this route: <br><br><blockquote> <code><a href="http://s-c.me/23138/s"></a> <a href="http://s-c.me/23138/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  root: to =&gt; <font color="#008000">'dashboard # index'</font> ,: constraints =&gt; LoggedInConstraint </li></ol></blockquote><br>  BUT?  LoggedInConstraint? <br><br><blockquote> <code><a href="http://s-c.me/23139/s"></a> <a href="http://s-c.me/23139/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#cc6633">LoggedInConstraint</font> </li><li>  <font color="#0000ff">def self</font> .matches? (request) </li><li>  current_user </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  Oh yeah.  The object that describes the routing policy.  Wonderful.  Also examples of validation shamelessly stolen from <a href="http://omgbloglol.com/post/392895742/improved-validations-in-rails-3">omgbloglol</a> : <br><br><blockquote> <code><a href="http://s-c.me/23140/s"></a> <a href="http://s-c.me/23140/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">def</font> <font color="#cc6633">SomeClass</font> &lt; <font color="#cc6633">ActiveRecord :: Base</font> </li><li>  validate: category_id,: proper_category =&gt; <font color="#0000ff">true</font> </li><li>  <font color="#0000ff">end</font> </li><li></li><li>  <font color="#0000ff">class</font> <font color="#cc6633">ProperCategoryValidator</font> &lt;ActiveModel :: EachValidator </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">validate_each</font> (record, attribute, value) </li><li>  <font color="#0000ff">unless</font> record.user.category_ids.  <font color="#0000ff">include</font> ? (value) </li><li>  record  <b>errors</b> .add attribute, <font color="#008000">'has bad category.'</font> </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li><li>  <font color="#0000ff">end</font> </li></ol></blockquote><br>  This is not a pure Ruby class, but you get the idea. <br><br>  Now you probably think: ‚ÄúSteve, this is not only for Rails, you lied!‚Äù Well, yes, actually, you caught me: this is not a secret for object-oriented Rails, this is more a general object-oriented approach.  But there is something specific to Rails that seems to be enticing you to never break classes.  Perhaps lib / seems such a repository of garbage.  It is possible that the 15-minute examples only include ActiveRecord models.  Perhaps more closed Rails applications, (Attention: just my own opinion) than open non-Rails, so there are not many good examples to rely on.  (I have such a hunch, because Rails is often used to develop websites for companies. Gemes? Exactly? My web application? Not much. Nevertheless, I do not have statistics to confirm.) <br><br>  In general: retrieving domain objects is good.  They make your tests quick, the code short, and make it easier to make changes later.  I still have something to say about this, especially about the ‚Äúquick tests‚Äù, but I have already exhausted the possible length of the post.  Until next time! </div><p>Source: <a href="https://habr.com/ru/post/128556/">https://habr.com/ru/post/128556/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128549/index.html">Network game on bash: chess</a></li>
<li><a href="../128551/index.html">Yahoo has received several offers to sell its assets.</a></li>
<li><a href="../128552/index.html">Loading a page using Ajax as VKontakte</a></li>
<li><a href="../128553/index.html">HP and Universal launched their own music service in Russia</a></li>
<li><a href="../128555/index.html">Analysis of the malware for Android on the example of Trojan-Spy.AndroidOS.Zbot.a / Android.Smssniffer / Android / SpySMS / AndroidOS_SMSREP.B</a></li>
<li><a href="../128557/index.html">Using Ext JS 4 widgets within the Ext JS 3 interface</a></li>
<li><a href="../128558/index.html">Clonezilla Server - backup 100 PCs at night is no longer a problem</a></li>
<li><a href="../128560/index.html">How do you store work documents and files?</a></li>
<li><a href="../128562/index.html">HowTo: How to make Django friends with WebSocket (socket.io, sockjs)</a></li>
<li><a href="../128563/index.html">A second video editor was built into Youtube</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>