<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How long can you be mistaken thinking that Foglight will promptly report a problem with memory loading</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you know that feeling of confidence when you know what is happening, you know that everything is under control, then you may be familiar with the f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How long can you be mistaken thinking that Foglight will promptly report a problem with memory loading</h1><div class="post__text post__text-html js-mediator-article">  If you know that feeling of confidence when you know what is happening, you know that everything is under control, then you may be familiar with the feeling when it turns out that this is far from being the case.  In this post, I will talk about how I sat on a flat surface in a puddle, why it happened and what kind of work was done on the bugs.  It's about Quest Foglight and the built-in memory check rule. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9fa/d53/14b/9fad5314b143f8921ded719897935056.png"><a name="habracut"></a><br><br>  In my first <a href="http://habrahabr.ru/post/214409/">article,</a> I described how the Quest Folight monitoring system was commissioned in our department.  A couple of weeks ago, after the next release, complaints started about the fact that one of the services was clogging up the memory and arranging problems in the form of ‚Äúsystem out of memory exception‚Äù to our customers.  So we are dealing with a banal memory leak.  Why is the monitoring silent, because in fact the memory was clogged up gradually and all the thresholds for triggering the rule were passed during the day?  At least two times we should have received an alert, but this did not happen.  Let's try to figure it out together. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the picture you see the VMW Virtual Machine Memory Utilization rule and the fact that the rule covers the VMWVirtualMachineMemory topology.  So far, everything is correct and nothing portends a trick. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/387/37b/dd8/38737bdd8db18f4866e5b840a61b6621.png"><br><br>  Now take a look at one of the thresholds.  We are interested in the line "#utilization from $ scope.hostMemory #. Scope, in this case, we have VMWVirtualMachineMemory from the previous picture. Still, there is no trick, but it is there. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3bf/5fe/b54/3bf5feb54673b0debe61b688b73c4abc.png"><br><br>  If you already understand what's the matter, then you know more about vCenter than I do.  Where is the problem?  The problem was found in the analysis of what feeds vCenter as statistics.  From <a href="https://www.vmware.com/support/developer/vc-sdk/visdk400pubs/ReferenceGuide/memory_counters.html">this link</a> you can learn about the various metrics that can be learned from the vCenter.  What we used all this time turned out to be nothing more than Active Memory.  If you don‚Äôt want to follow the links, here‚Äôs a quote: ‚ÄúIt‚Äôs actively used as a guideline.‚Äù Those who already laugh at this are right.  What is a memory leak?  A memory leak is like a hamster; it takes seeds of itself and lays it behind the cheek, but at the same time it does not take any active actions with them.  This means that if the load rises gradually, and not abruptly, then our rule will not work!  That is why we consistently received alerts when we tested this rule with memtest and did not receive anything during a leak. <br><br>  Then we opened the case with the supplier and received confirmation that yes, we are right of course, but there is no alternative to get the required information from the VMware cartridge.  We were recommended to use host agents as an alternative to obtain the required information.  I am sure that many have never used this monitoring system and are not aware of an absolutely wild approach to collecting data from the operating system.  There is simply no mechanism for importing or automatically adding machines to the system.  It is required to manually add each, spending an average of one and a half minutes.  Needless to say that no one wants to manually add a few hundred virtual locks, and even then you have to keep track of what they have deleted and what they added. <br><br>  The solution was a few scripts written in powershell.  One constantly checks and compares the list of included virtuals where there is a non-zero IP.  The second one is connected directly to the virtual machines via WMI and collects what is required.  Immediately I confess that I am not an expert on powershell and therefore I submit my scripts for review only as an introduction - there is nothing to boast about.  It is enough to mention that I was not able to master the powershell jobs at once, although the understanding of the fact that it was necessary to parallelize - the script consistently checking a couple of hundreds of virtual machines took 10 minutes, is not the best way to collect data.  Now these scripts collect data for Foglight for me, and already in it I create rules and reports, although you could do it right in the script, but then there would be no beautiful display of data on the big screen. <br><br>  Here is the data collection script.  Nothing phenomenal.  Some had to be cut out - there are different specifics of our environment. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="hljs mel">$csv = Import-Csv .\Inv.csv #Load inventory foreach ($server <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $csv){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($server.<span class="hljs-string"><span class="hljs-string">"Domain Name"</span></span> -like <span class="hljs-string"><span class="hljs-string">"**"</span></span>){ #This limits the number of concurrently running jobs. Set number of jobs and sleep timer here. While ($(Get-Job -state running).count -ge <span class="hljs-number"><span class="hljs-number">50</span></span>){ Start-Sleep -Milliseconds <span class="hljs-number"><span class="hljs-number">250</span></span> } Start-Job -scriptblock { param($ipAddress, $hostName, $domainName) $return=@() $Memory=Get-WmiObject win32_operatingsystem -ComputerName $ipAddress | Foreach {<span class="hljs-string"><span class="hljs-string">"{0:N2}"</span></span> -f ((($_.TotalVisibleMemorySize - $_.FreePhysicalMemory)*<span class="hljs-number"><span class="hljs-number">100</span></span>)/ $_.TotalVisibleMemorySize)} $return=New-Object PSObject $return|Add-Member -MemberType <span class="hljs-string"><span class="hljs-string">"NoteProperty"</span></span> -Name <span class="hljs-string"><span class="hljs-string">"ipAddress"</span></span> -Value $ipAddress $return|Add-Member -MemberType <span class="hljs-string"><span class="hljs-string">"NoteProperty"</span></span> -Name <span class="hljs-string"><span class="hljs-string">"memoryUtilization"</span></span> -Value $Memory $return|Add-Member -MemberType <span class="hljs-string"><span class="hljs-string">"NoteProperty"</span></span> -Name <span class="hljs-string"><span class="hljs-string">"hostName"</span></span> -Value $hostName $return|Add-Member -MemberType <span class="hljs-string"><span class="hljs-string">"NoteProperty"</span></span> -Name <span class="hljs-string"><span class="hljs-string">"domainName"</span></span> -Value $domainName <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($error[<span class="hljs-number"><span class="hljs-number">0</span></span>]) { $return|Add-Member -MemberType <span class="hljs-string"><span class="hljs-string">"NoteProperty"</span></span> -Name <span class="hljs-string"><span class="hljs-string">"Error"</span></span> -Value $error[<span class="hljs-number"><span class="hljs-number">0</span></span>] } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $return|Add-Member -MemberType <span class="hljs-string"><span class="hljs-string">"NoteProperty"</span></span> -Name <span class="hljs-string"><span class="hljs-string">"Error"</span></span> -Value <span class="hljs-string"><span class="hljs-string">"NA"</span></span> } $return } -ArgumentList ($server.<span class="hljs-string"><span class="hljs-string">"IP Address"</span></span>, $server.<span class="hljs-string"><span class="hljs-string">"VMName"</span></span>.toUpper(), $server.<span class="hljs-string"><span class="hljs-string">"Domain Name"</span></span>.toUpper()) } } Get-Job | Wait-Job -Timeout <span class="hljs-number"><span class="hljs-number">30</span></span> $recievedObject = Get-Job | Receive-Job Get-Job | Remove-Job -Force #start building folight observation set Write-Output <span class="hljs-string"><span class="hljs-string">"TABLE WMI"</span></span> foreach($observation <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $recievedObject) { Write-Output <span class="hljs-string"><span class="hljs-string">"START_SAMPLE_PERIOD"</span></span> Write-Output <span class="hljs-string"><span class="hljs-string">"host.String.id = $($observation.hostName).$($observation.domainName)"</span></span> Write-Output <span class="hljs-string"><span class="hljs-string">"ipAddress.String = $($observation.ipAddress)"</span></span> Write-Output <span class="hljs-string"><span class="hljs-string">"physicalMemoryUsed:percent = $($observation.memoryUtilization)"</span></span> Write-Output <span class="hljs-string"><span class="hljs-string">"error.StringObservation.obs =$($observation.Error)"</span></span> Write-Output <span class="hljs-string"><span class="hljs-string">"END_SAMPLE_PERIOD"</span></span> } Write-Output <span class="hljs-string"><span class="hljs-string">"END_TABLE"</span></span></code> </pre> </div></div><br><br>  Constructive criticism is welcome. </div><p>Source: <a href="https://habr.com/ru/post/218843/">https://habr.com/ru/post/218843/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../218827/index.html">UP Review! 3D Printer Mini</a></li>
<li><a href="../218829/index.html">Testing client-server API security</a></li>
<li><a href="../218833/index.html">Writing a file system in the Linux kernel</a></li>
<li><a href="../218837/index.html">Dev Story: Crystalux - nuances of developing and promoting puzzles for Android</a></li>
<li><a href="../218841/index.html">The program of the course "Java Core"</a></li>
<li><a href="../218845/index.html">Hello% habrauser%! Let's get acquainted!</a></li>
<li><a href="../218847/index.html">Two days to the International Space Apps Challenge</a></li>
<li><a href="../218849/index.html">4 ways to grow your business with customers</a></li>
<li><a href="../218851/index.html">Samsung introduced new smart bulbs</a></li>
<li><a href="../218853/index.html">PCIe SSD, subspecies and future</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>