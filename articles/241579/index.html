<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploy Django apps using Ansible for Dummies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 

 Most recently, my colleague introduced me to the wonderful manual work automation tool called Ansbile . After that, the idea was instantl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploy Django apps using Ansible for Dummies</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br><br>  Most recently, my colleague introduced me to the wonderful manual work automation tool called <a href="http://www.ansible.com/home">Ansbile</a> .  After that, the idea was instantly born to write something of our own, which simplifies the very manual work.  What do you usually have to do with your hands?  Correctly, deploy. <br><br>  In this article I will talk about how using ansible to roll out a django-project on a clean remote server ubuntu 14.04, while creating for the project an individual user. <br><a name="habracut"></a><br>  What is ansible?  A set of commands written in python that allow you to automatically perform specified actions on remote machines.  Wonderful!  Let's build an action plan, how would we do it with pens? <br><ul><li>  Part 1 (and using superuser rights) <br><ul><li>  Install on a clean virtual machine software: mariadb, nginx, supervisor, python-mysqldb, python-virtualenv, python-pip, supervisor, uwsgi; </li><li>  Configure nginx config; </li><li>  Configure supervisor config; </li><li>  Create a new user of the system specifically for this project (of course optional); </li></ul></li><li>  Part 2 (on behalf of the user, the project owner) <br><ul><li>  Copy the project; </li><li>  Create a virtual environment (with the necessary packages inside); </li><li>  Configure local_settings.py (in it we store the database access settings, as well as the STATIC_ROOT and MEDIA_ROOT paths); </li><li>  Create a table structure in the database (syncdb for django &lt;1.7, migrate); </li><li>  Collect all the static in one place; </li></ul></li><li>  Part 3 (again switch to superuser rights) <ul><li>  Restart mysql; </li><li>  Restart nginx; </li><li>  Restart supervisor; </li></ul></li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Without further ado, get down to business. <br><br>  What does ansible begin with - with the hosts file.  In it we indicate all the machines available to us, over which actions will be taken.  In our case, the machine is one (I will not talk about how to perform operations on several machines, the purpose of the article is not in this) and the file looks like this: <br><br><pre><code class="bash hljs">[project-hosts] root ansible_ssh_host=192.168.0.102 ansible_ssh_user=freylis ansible_ssh_pass=z ansible_sudo_pass=z user ansible_ssh_host=192.168.0.102 ansible_ssh_user=example2 ansible_ssh_pass=zz [user-hosts] user [root-hosts] root</code> </pre> <br>  Let's break it down. <br>  In the [project-hosts] section, all the machines at our disposal are listed, with the details of access to them.  In our case, the machine is one, but indicated twice: the first one contains the root credentials, on behalf of which the system will be configured, the second - the credentials of the user who has not yet been created, the owner of our django application.  The first parameter is the alias of this machine. <br><br>  The [user-hosts] and [root-hosts] sections unite the machines into groups according to their general purpose (I hope this is understandable. Route in one group, non-root ones in another). <br><br>  So, with the hosts figured out.  Now we need to somehow tell the ansible what to do. <br><br>  But first, talk about variables.  It is absolutely clear that, for example, the project name is used many times: in the nginx config, supervisor, project paths, etc.  Ansible has many ways to specify variables, but I prefer the following: in the grpou_vars directory, create a file with the section name from the hosts file.  For example, I did not bother and created a file called project-hosts.  Now the variables declared in this file will be accessible to all machines included in the [project-hosts] section, i.e.  globally for our project. <br><br>  Here is all I needed for this project (ansible uses the jinja2 syntax): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # system options # # linux username username: # about password crypt # http://docs.ansible.com/faq.html#how-do-i-generate-crypted-passwords-for-the-user-module # or run `mkpasswd --method=SHA-512` # here crypted user_crypt_password: # really password user_password: z user_homedir: "/home/{{ username }}" mysql_root_user: root # root mysql user mysql_root_password: "" # # project options # # project slug ( if u have `example/manage.py` and example/example/settings.py` - `example` is project_slug) project_slug: # url or list urls for nginx project_url: project_dir: "{{ user_homedir }}/projects/{{ project_slug }}" project_homedir: "{{ user_homedir }}/projects/{{ project_slug }}/{{ project_slug }}" # virtualenv name env: "{{ project_dir }}/env" # port for uwsgi, must be unique for each project uwsgi_port: 9000 # mysql database for current project mysql_database: "{{ project_slug }}" # mysql user for current project mysql_user: # mysql user password for current project mysql_user_password: # # django settings # debug: True local_settings: 'local_settings.py' # set empty string if not used requirements: 'requirements.txt'</span></span></code> </pre><br>  Let's first deal with the configuration of the system.  Create a root-playbook.yml file with the following content: <br><pre> <code class="bash hljs">--- - hosts: root-hosts sudo: <span class="hljs-literal"><span class="hljs-literal">true</span></span> roles: - system</code> </pre><br>  Here I will explain two things: <br><br>  1. hosts: root-hosts - a directive telling us about which group of machines to perform the following actions; <br>  2. roles: system - a list of directories with further action scenarios. <br><br>  Let's take a look at the scripts directory.  It has the following form: <br><br><pre> <code class="bash hljs">roles/ system/ handlers/ main.yml tasks/ main.yml templates/ nginx.j2 supervisor.j2</code> </pre><br>  Here: <br>  handlers - stores a description of the handlers.  For example, it contains a description of how to restart nginx; <br>  tasks - all over the head.  List of tasks for Ansible; <br>  templates - templates of files we need for some daemons; <br><br>  We go in order. <br><br>  handlers: <br><pre> <code class="bash hljs">--- - name: restart site supervisorctl: name={{ project_url }} state=restarted - name: restart mysql service: name=mysql state=restarted enabled=yes - name: restart nginx service: name=nginx state=restarted enabled=yes</code> </pre><br>  The Ansible Yml syntax is clear: the name of a directive, the directive itself, an action with parameters.  These handlers will be used in our tasks, if the task is completed - kindly launch the necessary handler (notify section) <br>  tasks: <br><br><pre> <code class="bash hljs">--- <span class="hljs-comment"><span class="hljs-comment"># apt-get update - name: updating the system apt: update_cache=yes cache_valid_time=86400 notify: - restart server #  apt-key   mariadb - name: Add mariadb apt repository key apt_key: id=0xcbcb082a1bb943db keyserver=hkp://keyserver.ubuntu.com:80 state=present #     mariadb - name: Add mariadb apt repository apt_repository: repo='deb http://mirror.timeweb.ru/mariadb/repo/10.1/debian wheezy main' state=present #    - name: install packages apt: pkg={{ item.name }} state=present with_items: - name: python-mysqldb - name: python-virtualenv - name: python-pip - name: supervisor - name: mariadb-server - name: nginx - name: uwsgi - name: uwsgi-plugin-python #   supervisor.conf.j2   templates      (   ) - name: copy supervisor config template: src=supervisor.conf.j2 dest=/etc/supervisor/conf.d/{{ project_url }}.conf notify: - restart site #     - name: create linux user user: name={{ username }} shell=/bin/bash home={{ user_homedir }} password={{ user_crypt_password }} #   mysql    - name: Create MySQL user mysql_user: &gt; name={{ mysql_user }} host=% password={{ mysql_user_password }} priv={{ mysql_database }}.*:ALL login_user={{ mysql_root_user }} login_password={{ mysql_root_password }} state=present notify: - restart mysql # create database - name: Create MySQL database mysql_db: &gt; name={{ mysql_database }} collation=utf8_general_ci encoding=utf8 login_user={{ mysql_root_user }} login_password={{ mysql_root_password }} state=present notify: - restart mysql #  nginx.j2   templates      - name: copy nginx config template: src=nginx.j2 dest=/etc/nginx/sites-available/{{ project_url }} notify: - restart nginx - name: create symlink nginx config file: src=/etc/nginx/sites-available/{{ project_url }} dest=/etc/nginx/sites-enabled/{{ project_url }} state=link</span></span></code> </pre><br>  Disassemble one section line by line: <br><br>  - name: updating the system - the name displayed in the deployment process <br>  - apt: update_cache = yes cache_valid_time = 86400: apt - the name of the directive is ansible (I call them directives).  update_cache, cache_valid_time - directive parameters; <br>  - notify: - restart server - an action from the handlers that must be done to complete the task. <br><br>  Actually, the syntax is extremely simple.  If some parameters are not clear - you can read in the documentation for Ansible.  But I would like to draw attention to the template directive.  It takes two parameters: src - the name of the source file stored in the templates directory of the current role and dest - where this file should be put, having previously been rendered using all available variables. <br><br>  For example, my nginx.j2 template file looks like this: <br><br><pre> <code class="bash hljs">server { root {{ project_dir }}/{{ project_slug }}; access_log {{ project_dir }}/logs/nginx-access.log; error_log {{ project_dir }}/logs/nginx-errors.log; server_name {{ project_url }}; gzip on; gzip_min_length 1000; gzip_proxied expired no-cache no-store private auth; gzip_types text/plain application/xml; location / { include uwsgi_params; uwsgi_pass 127.0.0.1:{{ uwsgi_port }}; } location /static { root {{ project_dir }}; } location /media { root {{ project_dir }}; } location /robots.txt { root {{ project_dir }}; } }</code> </pre><br>  The attentive reader noticed that with the user directive we created a new user of our system.  Let's deploy our project on his behalf. <br><br>  Create another playbook with the name user-playbook.yml and the following content: <br><br><pre> <code class="bash hljs">--- - hosts: user-hosts sudo: <span class="hljs-literal"><span class="hljs-literal">false</span></span> roles: - django - hosts: root-hosts sudo: <span class="hljs-literal"><span class="hljs-literal">true</span></span> tasks: - name: restart site <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supervisor supervisorctl: name={{ project_url }} state=restarted - name: restart mysql service: name=mysql state=restarted enabled=yes - name: restart nginx service: name=nginx state=restarted enabled=yes</code> </pre><br>  And inside, we see that a certain django role is first performed, and then again using the superuser's rights, the restarting daemons task is performed.  Let's look at what we need to deploy the django project: <br><br><pre> <code class="bash hljs">--- - name: create project directory file: path={{ project_dir }} state=directory - name: create logs directory file: path={{ project_dir }}/logs state=directory - name: create project home directory file: path={{ project_homedir }} state=directory <span class="hljs-comment"><span class="hljs-comment">#  ,      - name: unarchive project archive unarchive: src=/tmp/django_deploy.tar dest={{ project_homedir }} - name: create virtualenv pip: virtualenv={{ env }} virtualenv_site_packages=yes {% if requirements %}requirements={{ project_homedir }}/{{ requirements }}{% endif %} #  uwsgi.j2   ,    .     - name: copy uwsg file template: src=uwsgi.j2 dest={{ project_homedir }}/uwsgi.{{ project_slug }}.ini #  - name: copy local_settings.py template: src=local_settings.py dest={{ project_homedir }}/{{ project_slug }}/{{ local_settings }} - name: syncdb (for django&lt;1.7) django_manage: command=syncdb virtualenv={{ env }} app_path={{ project_homedir }} - name: migrate database django_manage: command=migrate virtualenv={{ env }} app_path={{ project_homedir }} - name: collectstatic django_manage: command=collectstatic virtualenv={{ env }} app_path={{ project_homedir }} - name: create media directory file: path={{ project_dir }}/media state=directory #      django-tinymce - name: create `uploads` directory file: path={{ project_dir }}/media/uploads state=directory</span></span></code> </pre><br><br>  That's all.  We installed the necessary software on a clean system, created a new user, deployed a django project on its behalf and restarted all the servers. <br><br>  All this happiness starts like this: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     (   )       ansible-playbook -i hosts root-playbook.yml #       tar -cf /tmp/django-deploy.tar * #       ansible-playbook -i hosts user-playbook.yml</span></span></code> </pre><br><br>  A working project for deploying on ubuntu server 14.04 is in the <a href="https://github.com/freylis/ansible-django-deploy">repository</a> . <br><br>  Thank you for your time, I hope it was useful. </div><p>Source: <a href="https://habr.com/ru/post/241579/">https://habr.com/ru/post/241579/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241565/index.html">The digest of interesting news and materials from the world of PHP No. 50 (October 6 - October 26, 2014)</a></li>
<li><a href="../241567/index.html">Strongly typed combinators for constructing a parser and a natural language synthesizer</a></li>
<li><a href="../241571/index.html">Conference Connect () - we look together announcements of key products for developers on the Microsoft platform</a></li>
<li><a href="../241573/index.html">VMware broke the CBT mechanism for backing up virtual machines</a></li>
<li><a href="../241577/index.html">The book ‚ÄúGetting Started with LLVM Core Libraries‚Äù has been released.</a></li>
<li><a href="../241581/index.html">A brief excursion into the cooling server</a></li>
<li><a href="../241585/index.html">Differences between Windows Mobile and Windows CE in data collection terminals</a></li>
<li><a href="../241587/index.html">Expressive JavaScript: The Secret Life of Objects</a></li>
<li><a href="../241589/index.html">Overview of Microsoft Azure platform updates for September</a></li>
<li><a href="../241591/index.html">Web Application Development Basics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>