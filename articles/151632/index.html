<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Office 365 sync with AD DS, use AD FS 2.0 to create a Single Sign-On</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, I would like to share with you the knowledge gained in this area. 
 This article is hardly useful to experienced administrators or eng...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Office 365 sync with AD DS, use AD FS 2.0 to create a Single Sign-On</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, I would like to share with you the knowledge gained in this area. <br>  This article is hardly useful to experienced administrators or engineers, all this can be <s>dealt</s> with using <s>Google</s> Bing and patience, but it happens that deadlines are tight, the topic is not interesting, or some other circumstances interfere with the workflow.  In addition, I do not have the opportunity to take screenshots of everything and everything, because in part they will be stumbled from the web, but the installation process of most components comes down to poking a button further to insanity. <br><a name="habracut"></a><br><h5>  Risks </h5>  Zero, one-way synchronization, if the authorities didn‚Äôt like \ earned anything \ didn‚Äôt allocate money \ everything broke - stop DirSync and AD FS, Delete DirSync, delete MSOL_AD_Sync account in AD DS, delete synchronized accounts from Office 365. If mail has moved you can set up forwarding back. <br><br><h5>  Minimum infrastructure requirements </h5>  Server for AD FS, Windows Server 2008 or higher, domain member, not domain controller <br>  Server for DirSync'A (Microsoft utility to synchronize AD DS and Office 365), Windows Server 2003 or higher, domain member, not domain controller, NET Framework 3.0 or 3.5, and Powershell <br>  AD DS 2003 mixed \ native mode or higher, from <b>one</b> forest.  Enterprise administrator account in the domain.  It is used only to create MSOL_AD_Sync, login \ password is not saved anywhere in DirSync'e.  The account is granted permissions to read and synchronize changes in AD DS. <br>  Administrator account for Office 365, <a href="http://onlinehelp.microsoft.com/ru-ru/office365-enterprises/gg584188.aspx">domain verified in Office 365</a> .  The domain name may not coincide with the verified domain, in this case you just need to <a href="http://technet.microsoft.com/en-us/library/cc756018.aspx">add the UPN domain suffix</a> and bind users to this suffix. <br>  Certificate for AD FS publication (any, even a self-signed one, will come down for testing) <br><br>  <b>Note</b> : DirSync works on ports 80 and 443, does not know how to log in to proxy servers, for it you will need to make a separate ‚Äúhole‚Äù in the proxy server.  To synchronize more than 50,000 users, you will need to install a full SQL server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Office 365 </h5>  First you need to activate synchronization with AD DS, this step is convenient to do first, since enabling synchronization takes up to 24 hours (less practice), this time is more than enough to set up and prepare the other components involved in synchronization. <br><br>  1. Go to the Office 365 portal, in the users section. <br>  2. We are looking for ‚ÄúActive Directory Synchronization‚Äù and click the ‚ÄúSet up‚Äù button. <br>  3. In the window that opens, under item number 3, we enable synchronization by clicking on ‚ÄúActivate‚Äù <br>  4. In point 4 we swing DirSync. <br><br><h5>  AD FS </h5>  Before installing AD FS, you must <a href="http://technet.microsoft.com/ru-ru/library/cc732785(v%3Dws.10).aspx">import</a> or generate a <a href="http://technet.microsoft.com/ru-ru/library/cc731014(v%3Dws.10).aspx">domain</a> or <a href="">self-signed</a> certificate that will be used to publish AD FS to IIS. <br><br>  <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D10909">Download</a> AD FS 2.0, install it, we need AD FS Server, not AD FS Server Proxy.  After installing AD FS 2.0, go to IIS and bind the AD FS site to port 443 and certificate. <br>  <b>Note</b> : It is recommended to remove the binding to port 80 and enable ‚ÄúRequire SSL‚Äù in the site settings.  All this is done intuitively through the IIS Management interface. <br><br>  Next, go to the AD FS 2.0 Management Console and run the AD FS 2.0 Server Configuration Wizard or C: \ Program Files \ Active Directory Federation Services 2.0 \ FsConfigWizard.exe.  Actually, further, further, further, further ... It is necessary to set up a <b>farm</b> , an account service for AD FS is desirable, the minimum additional permissions necessary for its work are the right of ‚Äúwrite‚Äù to the OU ‚ÄúProgram Data‚Äù. <br><br>  You can check by clicking on the link _https: //adfs_server_name/adfs/ls/idpinitiatedsignon.aspx <br><br><h5>  Installing DirSync </h5>  The process is very simple, on and on and on and on.  After installation, the wizard opens.  Again, quite trivial, on the second paragraph, you need to specify the Office 365 administrator account (synchronization with AD DS should be enabled at this point), on the third paragraph, specify the administrator's enterprise account.  In the fourth paragraph, you will be offered to include ‚ÄúRich Coexistance‚Äù, but I will not consider it in the framework of this article.  After installation, you can remove the checkmark "Synchronize directories now", it will not synchronize now, but synchronization is performed on a schedule every 3 hours. <br><br>  Now a little "magic" <br>  C: \ Program Files \ Microsoft Online Directory Sync \ SYNCBUS \ Synchronization Service \ UIShell \ miisclient.exe in this path lies the hidden GUI for DirSync (in fact, it is the usual Fim Synchronization Service).  If your knowledge is enough, you can ‚Äúplay around‚Äù with the settings, but changing the settings through the GUI is not supported by Microsoft, if something needs to be changed, Microsoft offers to go through the Configuration wizard again.  If you are not allowed in the DirSync GUI, you just need to re-login, your account has been added to the Fim Synch Service group. <br>  Forced synchronization can be done through the DirSync GUI or via powershell: <br><br>  1. Run povershell <br>  2. cd C: \ Program Files \ Microsoft Online Directory Sync <br>  3.. \ DirSyncConfigShell.psc1 <br>  4. In the new window Start-OnlineCoexistenceSync <br>  results can be viewed through the Event Log and \ or on the Office 365 portal. <br><img src="https://habrastorage.org/storage2/cb0/01a/666/cb001a666ee9b59b65810bb886c66299.png"><br><br>  For a test run, you can choose which OUs will be synchronized.  To do this, we go to the GUI, double-click the SourceAD management agent in the item ‚ÄúConnect to Active Directory forest‚Äù, click ‚ÄúContainers‚Äù and select the necessary containers.  If you have several domains, then select the desired domain from the list and click on ‚ÄúContainers‚Äù.  Repeat with each domain. <br>  <b>Note</b> : If you do not do this in Office 365, all accounts from all OUs will "go away".  Including service accounts and ‚Äúbuilt-in‚Äù accounts. <br><br><h5>  A bunch of AD FS 2.0 - Office 365 </h5>  <a href="http://onlinehelp.microsoft.com/ru-RU/Office365-enterprises/hh124998.aspx">We download</a> and install the Sign-in Assistant and powershell module for working with Office 365 on the AD FS server.  A new shortcut will appear in the Start menu and on the desktop, powershell for working with Office 365 (you can use the ‚Äúnormal‚Äù powershell after making <b>import-module MSOnline</b> ). <br><br>  Making the domain federated: <br>  1. $ cred = Get-Credential - in the appeared window we drive in the login \ password of the administrative account of Office 365. <br>  2. Connect-MsolService ‚ÄìCredential $ cred - connect to Office 365. <br>  3. Set-MsolADFSContext ‚ÄìComputer &lt;AD FS 2.0 server name&gt; is an optional step, only needed if you are running powershell not from the computer on which the AD FS Server is installed. <br>  4. Convert-MSOLDomainToFederated - domainname &lt;domain.com&gt; - you need to specify the name of the ‚Äúroot‚Äù domain, if you say you need to convert office365.domain.com, you must have verified the office365.domain.com and domain.com domains.  But when converting a domain, you need to specify domain.com, not office365.domain.com.  Converted domain and all subdomains. <br>  <b>Note</b> : After this operation, users will <b>NOT</b> be able to use Office 365 if the AD FS-Office 365 bundle is not configured or configured incorrectly, the domain has already become federated. <br>  5. Update-MSOLFederatedDomain ‚Äìdomainname &lt;domain.com&gt; <br><br>  If everything is done correctly, go to the Office 365 login page. You will see that the password field is no longer available. <br><img src="https://habrastorage.org/storage2/9cf/d0a/200/9cfd0a200159fda325a607419ad62e35.jpg"><br><br><h5>  Publishing AD FS Server Using ISA or TMG </h5>  Published as a regular web site, but there are a couple of nuances: <br>  1. Block high-bit characters and verify normalization in https protocol properties should be turned off. <br>  2. Link Translation must be turned off. <br>  3. In the settings of the rule there should be a checkmark ‚Äúrequest appear to come from the ISA server computer '‚Äù <br>  4. In the listener settings, you must add the certificate that you imported into IIS when installing AD FS. <br><br>  After publication, you can check the work through the <a href="https://portal.microsoftonline.com/">Office 365 portal</a> or <a href="">outlook.com</a> page.  Great <a href="https://www.testexchangeconnectivity.com/">site</a> for troubleshooting SSO. <br>  <b>Note</b> : In order for users to work, they need to assign licenses, you can assign a license to the test user by hand.  For bulk adding of licenses to users it is possible to use <a href="http://community.office365.com/en-us/wikis/sso/how-to-use-powershell-to-automatically-assign-licenses-to-your-office365-users.aspx">powershell</a> . <br><br><h5>  Results </h5><br>  The result is a working infrastructure where users can log in to Office 365 using their mailbox and password from the ‚Äúcomputer‚Äù.  All passwords are stored in your AD DS.  Passwords are not synchronized (for this, you need AD FS).  All changes to user information are made in your native AD DS and replicated to Office 365 automatically. <br><br>  I hope the article is useful to someone. <br>  The experience was obtained as a ‚Äúside event‚Äù when working with FIM 2010, it‚Äôs a pity that we don‚Äôt have a community around this program, I plan to write about FIM in the future. </div><p>Source: <a href="https://habr.com/ru/post/151632/">https://habr.com/ru/post/151632/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151624/index.html">Human colony on Mars. Detailed study of the Mars One project</a></li>
<li><a href="../151626/index.html">Design Patterns (Head First Design Patterns)</a></li>
<li><a href="../151628/index.html">Neurobiology and artificial intelligence: part one - educational program</a></li>
<li><a href="../151629/index.html">We glue several pdf files into one using Mac OS</a></li>
<li><a href="../151631/index.html">Common Event Format inside</a></li>
<li><a href="../151633/index.html">2GIS data on Rambler Maps</a></li>
<li><a href="../151634/index.html">About how I ported Java to donet</a></li>
<li><a href="../151635/index.html">Erasmus Mundus Scholarship for Higher Education in Europe</a></li>
<li><a href="../151637/index.html">Apple encodes video using JPEG, JSON and <canvas></a></li>
<li><a href="../151638/index.html">How Larry Laffer spoke in Russian or About the interpreters of the Sierra quests</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>