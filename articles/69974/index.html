<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OLTP games</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, the topic of implementing high-performance applications has become popular on Habr√©. We also decided to experiment a little bit in this dire...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OLTP games</h1><div class="post__text post__text-html js-mediator-article">  Recently, the topic of implementing high-performance applications has become popular on Habr√©.  We also decided to experiment a little bit in this direction and share the current results of our research. <br><br>  The <em>‚ÄúHello, world!‚Äù</em> Test subject is the simplest OLTP system: <br><br><div style="text-align:center;"><img src="http://img201.imageshack.us/img201/909/mainb.jpg"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Performance and resiliency requirements are key to such systems.  Therefore, the search for a solution to the problem was carried out in the direction of: C, C ++, fastcgi, nginx, lighttpd, oracle.  First of all, we were curious to try various options for building OLTP on these technologies, as well as measure performance and peak loads. <br><br><a name="habracut"></a><br><h4>  And so, the conditions of the problem </h4><br>  It is necessary to process transactions of the form: transfer X cu  (money, but what did you think) from account A to account B. In order not to invent a bicycle and ensure scalability, the HTTP protocol was selected for interaction with the client. <br><br><h4>  Requests are </h4><br>  <strong>server.com/paysys.request?account=123&amp;operator=456&amp;money=789</strong> <br>  which means: transfer 789 money from the account of the operator 456 to the account of the user 123. <br><br>  There are only three labels in the database: <br><br><img src="http://img201.imageshack.us/img201/9679/tablesp.jpg"><br>  <sub>(Figure 1. Database structure)</sub> <br><br>  The transaction procedure is not much more complicated than the database structure: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ;</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; begin o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) then o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> else <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; insert <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) values ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">procedure</font> PROCESS_TRANS(p_account_id <font color="#0000ff">in</font> number, p_operator_id <font color="#0000ff">in</font> number, p_sum <font color="#0000ff">in</font> number, o_result <font color="#0000ff">out</font> number) <font color="#0000ff">is</font> l_cnt  number; <font color="#0000ff">cursor</font> cur_account <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_account <font color="#0000ff">where</font> id = p_account_id <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> balance; <font color="#0000ff">cursor</font> cur_operator <font color="#0000ff">is</font> <font color="#0000ff">select</font> id <font color="#0000ff">from</font> pay_operator <font color="#0000ff">where</font> id = p_operator_id <font color="#0000ff">and</font> total &gt;= p_sum <font color="#0000ff">for</font> <font color="#0000ff">update</font> <font color="#0000ff">of</font> total; <font color="#0000ff">begin</font> o_result := -1; <font color="#008000">-- tansaction begins</font> <font color="#0000ff">select</font> <font color="#0000ff">count</font> (1) <font color="#008000">-- if such operator exist?</font> <font color="#0000ff">into</font> l_cnt <font color="#0000ff">from</font> pay_operator opr <font color="#0000ff">where</font> opr.id = p_operator_id; <font color="#0000ff">if</font> (l_cnt != 1) <font color="#0000ff">then</font> o_result := -2; <font color="#008000">-- Operator not found!</font> <font color="#0000ff">return</font> ; <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">open</font> cur_account; <font color="#0000ff">open</font> cur_operator; <font color="#0000ff">fetch</font> cur_account <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- need to fetch to update rows later</font> <font color="#0000ff">fetch</font> cur_operator <font color="#0000ff">into</font> l_cnt; <font color="#008000">-- 0/1 row in cursor as selected by prim_key</font> <font color="#0000ff">if</font> cur_account%notfound <font color="#0000ff">then</font> o_result := -3; <font color="#008000">-- Account not found!</font> elsif cur_operator%notfound <font color="#0000ff">then</font> o_result := -4; <font color="#008000">-- Operator has not enough money</font> <font color="#0000ff">else</font> <font color="#0000ff">update</font> pay_account <font color="#0000ff">set</font> balance = (balance + p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_account; <font color="#0000ff">update</font> pay_operator <font color="#0000ff">set</font> total = (total - p_sum) <font color="#0000ff">where</font> <font color="#0000ff">current</font> <font color="#0000ff">of</font> cur_operator; <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pay_transaction ( id, account_id, operator_id, money, datetime ) <font color="#0000ff">values</font> ( pay_transaction_seq.nextval, p_account_id, p_operator_id, p_sum, sysdate ); <font color="#0000ff">commit</font> ; o_result := 1; <font color="#008000">-- transaction successfully finished!</font> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <font color="#0000ff">close</font> cur_account; <font color="#0000ff">close</font> cur_operator; <font color="#0000ff">end</font> ;</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The most ideologically and practically correct approach to building a high-load server application with a large number of simultaneous connections is the implementation of the multiplexer ( <a href="http://www.kegel.com/c10k.html">The C10K problem</a> ). <br>  We decided to take the "unconventional" <em>Oracle 10.2 Express Edition</em> as the database.  Transaction (update) in the database we performed for <em>~ 2 ms</em> .  At times, when Oracle flushed data to disk (apparently <em>dbwr was</em> writing modified data blocks from the buffer cache), the transaction was delayed to <em>~ 20 ms</em> . <br><br>  To connect to the database, we decided to use libraries from the manufacturer.  As such, within our task, there were 2 jokes: <ul><li>  Oracle Call Interface ¬© </li><li>  Oracle C ++ Call Interface (C ++) </li></ul>  OCCI, in the best OOP traditions, is much more visual and easy to use.  However, its low-level counterpart has an undeniable advantage: OCI allows you to perform non-blocking (asynchronous) queries to the database, which is necessary to implement a multiplex server with multiple queries to the database as part of processing a single client.  Many are unhappy that for the sake of the possibility of non-blocking calls, it is necessary to write a rather cumbersome code and ask Oracle to open the source code for OCCI, but, as far as I know, so far to no avail.  In terms of performance, the 2 brothers differ very little, which is quite expected. <br><br><h4>  Ingredients: </h4><ul><li>  Oracle XE 10.2 </li><li>  Nginx 0.7.62 </li><li>  Lighttpd 1.4.23 </li></ul>  dwelt on <em>Ubuntu 9.04</em> under <em>VMWare</em> on an <em>Acer 5920G</em> laptop, for lack of any other hardware :).  We hope the lack of resources (in both senses) did not affect the objectivity of the results of comparative tests, because all the tests were carried out in the same environment. <br><br>  Immediately make a reservation that in setting up Oracle, we are far from Tom Kite, therefore, with tuning the database and operating system did not bother much.  Let's do it when we move to a full server. <br><br>  For the purity of the experiment, ~ 100k records were recorded in each tablet. <br><br><h2>  Experiences </h2><br>  How to build such a system?  We first came to mind the simplest solution based on the FastCGI protocol.  I think it‚Äôs not worth explaining once again how FastCGI differs from its progenitor CGI.  For a high-loaded application, this difference is fundamental.  I would like to dwell on another nuance, which we found out far from immediately. <br><br>  The FastCGI specification provides for the preservation of a user connection for the possibility of implementing multiplexed processing of several requests simultaneously.  In simple terms, you can call an asynchronous operation in the request handler and calmly give the processor time to other clients, and at the next iteration of the polling cycle get the result of the called operation and, sending the answer to the client, close the connection.  Unfortunately, nginx and lighttpd (as well as the libfcgi and fastcgipp libraries) do not yet support this, demanding to close the connection before processing the next client. <br><br>  However, in this example, we limited ourselves to only one short query to the database, which can be fully executed simultaneously, without fear of any significant loss in performance. <br><br>  Nginx and lighttpd allow you to interact with FastCGI by two methods: via TCP channel and Unix Domain Socket.  The advantage of the first approach is the possibility of clustering FastCGI servers, the disadvantage is the relatively high overhead of data transfer (TCP stack though).  UDS, however, works only locally, due to which higher performance is ensured. <br><br>  I would like to say a lot of ‚Äúwarm‚Äù words about the second method.  After the first tests, it was found that almost a tenth of requests with more than 200 clients (on our hardware) reach the FastCGI application.  The snag was in the net.unux.max_dgram_qlen kernel variable, which limits the size of the request queue when writing to the socket.  By default, this option was 10, which explained the loss of requests.  After setting the value to 10,000, everything seemed to return to normal.  But it was not there.  Almost a tenth of the requests were guaranteed to fall off, and nginx wrote terrible words <em>‚Äúconnect () to socket failed (11: Resource temporary unavailable)‚Äù in logia</em> .  In Russian, with a large number of simultaneous requests, the socket was ‚Äúchoking‚Äù.  We have not yet been able to solve this problem.  Although productivity has increased, but who needs it, when about 10% of transactions are completed with the <em>‚Äú502‚Äù</em> code. <br><br><br><h3>  FastCGI server: </h3><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">const</font> <font color="#0000ff">char</font> * bind_address = <font color="#A31515">": 9000"</font> ; </li><li>  <font color="#0000ff">const</font> <font color="#0000ff">char</font> * db_user_name = <font color="#A31515">"orauser"</font> ; </li><li>  <font color="#0000ff">const</font> <font color="#0000ff">char</font> * db_password = <font color="#A31515">"pass"</font> ; </li><li>  <font color="#0000ff">const</font> <font color="#0000ff">char</font> * db_conn_str = <font color="#A31515">"comp: 1521 / xe"</font> ; </li><li></li><li>  <font color="#0000ff">int</font> main ( <font color="#0000ff">int</font> argc, <font color="#0000ff">char</font> * <font color="#0000ff">const</font> argv []) </li><li>  { </li><li>  <font color="#0000ff">using</font> <font color="#0000ff">namespace</font> oracle :: occi; </li><li></li><li>  <font color="#0000ff">int</font> listenQueueBacklog = 4000; </li><li>  FCGX_Request request; </li><li></li><li>  <font color="#0000ff">if</font> (FCGX_Init ()) </li><li>  exit (1); </li><li></li><li>  <font color="#0000ff">int</font> listen_socket = FCGX_OpenSocket (bind_address, listenQueueBacklog); </li><li>  <font color="#0000ff">if</font> (listen_socket &lt;0) </li><li>  exit (1); </li><li></li><li>  <font color="#0000ff">if</font> (fchmod (listen_socket, S_IROTH | S_IWOTH)) </li><li>  exit (1); </li><li></li><li>  <font color="#0000ff">if</font> (FCGX_InitRequest (&amp; request, listen_socket, 0)) exit (1); </li><li></li><li>  Environment * env = Environment :: createEnvironment (Environment :: DEFAULT); </li><li>  Connection * conn = env-&gt; createConnection (db_user_name, db_password, db_conn_str); </li><li>  Statement * stmt = conn-&gt; createStatement ( </li><li>  <font color="#A31515">"BEGIN PAY_SYS.PROCESS_TRANS (: v1,: v2,: v3,: v4); END;"</font>  ); </li><li></li><li>  <font color="#0000ff">while</font> (FCGX_Accept_r (&amp; request) == 0) </li><li>  { </li><li>  <font color="#0000ff">bool</font> noException = <font color="#0000ff">false</font> , succesful = <font color="#0000ff">false</font> ; </li><li></li><li>  <font color="#0000ff">long</font> start = GetTickCount (); </li><li>  <font color="#0000ff">char</font> * <font color="#0000ff">params</font> = FCGX_GetParam ( <font color="#A31515">"QUERY_STRING"</font> , request.envp); </li><li>  <font color="#0000ff">int</font> operatorID, accountID, moneySum, result = -1; </li><li></li><li>  operatorID = GetIntParam ( <font color="#0000ff">params</font> , <font color="#A31515">"operator ="</font> ); </li><li>  accountID = GetIntParam ( <font color="#0000ff">params</font> , <font color="#A31515">"account ="</font> ); </li><li>  moneySum = GetIntParam ( <font color="#0000ff">params</font> , <font color="#A31515">"money ="</font> ); </li><li></li><li>  <font color="#0000ff">if</font> (operatorID &lt;= 0 || accountID &lt;= 0 || moneySum &lt;= 0) </li><li>  { </li><li>  FCGX_FPrintF (request. <font color="#0000ff">Out</font> , <font color="#A31515">"HTTP / 1.0 503 Params Error \ n"</font> ); </li><li>  FCGX_FPrintF (request. <font color="#0000ff">Out</font> , <font color="#A31515">"Content-type: text / html \ r \ n \ r \ n"</font> ); </li><li>  FCGX_FPrintF (request. <font color="#0000ff">Out</font> , <font color="#A31515">"wrong params &lt;br&gt; \ n"</font> ); </li><li>  FCGX_Finish_r (&amp; request); </li><li>  <font color="#0000ff">continue</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">try</font> </li><li>  { </li><li>  stmt-&gt; setInt (1, accountID); </li><li>  stmt-&gt; setInt (2, operatorID); </li><li>  stmt-&gt; setInt (3, moneySum); </li><li>  stmt-&gt; registerOutParam (4, OCCIINT, <font color="#0000ff">sizeof</font> (result)); </li><li>  stmt-&gt; execute (); </li><li>  result = stmt-&gt; getInt (4); </li><li></li><li>  <font color="#0000ff">if</font> (result == 1) </li><li>  succesful = <font color="#0000ff">true</font> ; </li><li>  } </li><li>  <font color="#0000ff">catch</font> (SQLException &amp; sqlExcp) </li><li>  { </li><li>  error_log (sqlExcp.getMessage (). c_str ()); </li><li>  } </li><li></li><li>  <font color="#0000ff">if</font> (succesful) </li><li>  { </li><li>  FCGX_FPrintF (request. <font color="#0000ff">Out</font> , <font color="#A31515">"HTTP / 1.0 200 OK \ n"</font> ); </li><li>  FCGX_FPrintF (request. <font color="#0000ff">Out</font> , <font color="#A31515">"Content-type: text / html \ r \ n \ r \ n"</font> ); </li><li>  FCGX_FPrintF (request. <font color="#0000ff">Out</font> , <font color="#A31515">"SQL result =% d"</font> , result); </li><li>  } </li><li>  <font color="#0000ff">else</font> </li><li>  { </li><li>  FCGX_FPrintF (request. <font color="#0000ff">Out</font> , <font color="#A31515">"HTTP / 1.0 503 DatabaseError \ n"</font> ); </li><li>  FCGX_FPrintF (request. <font color="#0000ff">Out</font> , <font color="#A31515">"Content-type: text / html \ r \ n \ r \ n"</font> ); </li><li>  FCGX_FPrintF (request. <font color="#0000ff">Out</font> , <font color="#A31515">"Database error occured"</font> ); </li><li>  error_log ( <font color="#A31515">"db error"</font> ); </li><li>  } </li><li></li><li>  FCGX_Finish_r (&amp; request); </li><li>  } </li><li></li><li>  conn-&gt; terminateStatement (stmt); </li><li>  env-&gt; terminateConnection (conn); </li><li>  Environment :: terminateEnvironment (env); </li><li></li><li>  <font color="#0000ff">return</font> 0; </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br><h2>  Total </h2><br>  Used siege and ab.  Due to memory problems, siege flatly refused to make more than 380 requests per second, while ab ‚Äúsqueezed‚Äù up to 1000 requests, but then referred to an excessive number of open sockets. <br><br>  For the reliability of the results, testing was carried out according to the scheme of 10,000 queries at 100, 200, 300, 400 simultaneous.  For FastCGI on this machine with default kernel settings, the loads were enough to overcome the critical threshold of 10% of lost requests.  The lighttpd + fastcgi bundle began to ‚Äústumble‚Äù at ~ 200 requests, while the nginx bundle held up to ~ 300 simultaneous connections.  With a load of more than 400 simultaneous connections, both FastCGI options fell off with the message ‚Äúapr_poll: The timeout specified has expired (70007)‚Äù, while the nginx module without any screaming evened out with 1000 simultaneous connections via ab.  The tests, again, rested against the "iron".  For clarity, we decided to present the measurement results in the form of graphs. <br><br>  So, on the x-axis - the number of simultaneous requests, on the y-axis - in accordance with the caption to the chart. <br><br><img src="http://img225.imageshack.us/img225/5023/longestrequest.png"><br>  <sub>(Figure 2. The longest query, s)</sub> <br><br><img src="http://img225.imageshack.us/img225/707/meantime.png"><br>  <sub>(Figure 3. Average request processing time, sec.)</sub> <br><br><img src="http://img201.imageshack.us/img201/1341/rps.png"><br>  <sub>(Figure 4. The number of requests processed per second)</sub> <br><br><img src="http://img233.imageshack.us/img233/3711/testtime.png"><br>  <sub>(Figure 5. Time spent on processing 10,000 requests, sec.)</sub> <br><br><h2>  Conclusion. </h2><br>  Resource limitations did not allow for overwhelming results, but we believe that comparative testing was entirely successful.  Test results do not claim to be complete, but in general, in our opinion, confirm the expectations.  Surely leading domestic athlete with a minimum of additional equipment.  What a huge respect for him and his coach!  In conjunction with FastCGI, he again bypasses a little bit of his foreign rival. <br><br>  In our experiments, the mechanism of asynchronous calls to the database has not yet been used.  It is curious how the test results will change if we complicate the processing of the client to several calls to the database and implement a full multiplexer.  On FastCGI, this will not work, but this can be done with the nginx module, and also for completeness of the experiments, to call into the ranks of the "experimental" own HTTP daemon based on a library like poco, asio, pion ... <br><br>  In general, <em>to be continued ...</em> <br><br>  <strong>UPD</strong> <br>  Nginx modules are server extensions statically compiled with it.  Built-in functionality like SSL and FastCGI is also implemented as modules.  Plus - speed, minus - the complexity of the update on a running machine.  Excellent manuals are <a href="http://www.evanmiller.org/">here</a> . <br>  A stripped-down example is below.  For a change, work with ORACLE via the OCI C-library. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#008000">// option WITHOUT setting support via nginx.conf and error PROCESSING</font> </li><li></li><li>  #include &lt;ngx_config.h&gt; </li><li>  #include &lt;ngx_core.h&gt; </li><li>  #include &lt;ngx_http.h&gt; </li><li>  #include &lt; <font color="#0000ff">string</font> .h&gt; </li><li>  #include &lt;oci.h&gt; </li><li></li><li>  <font color="#0000ff">const</font> text * db_user_name = ( <font color="#0000ff">const</font> text *) <font color="#A31515">"orauser"</font> ; </li><li>  <font color="#0000ff">const</font> text * db_password = ( <font color="#0000ff">const</font> text *) <font color="#A31515">"pass"</font> ; </li><li>  <font color="#0000ff">const</font> text * db_conn_str = ( <font color="#0000ff">const</font> text *) <font color="#A31515">"comp: 1521 / xe"</font> ; </li><li>  <font color="#0000ff">const</font> text * command = ( <font color="#0000ff">const</font> text *) </li><li>  <font color="#A31515">"BEGIN PAY_SYS.PROCESS_TRANS (: v1,: v2,: v3,: v4); END;"</font>  ; </li><li></li><li>  OCIEnv * env; </li><li>  OCISvcCtx * context; </li><li>  OCISession * session; </li><li>  OCIServer * server; </li><li>  OCIError * error; </li><li>  OCIStmt * statement; </li><li>  OCIBind * bnd1, * bnd2, * bnd3, * bnd4; </li><li></li><li>  <font color="#0000ff">int</font> operatorID, accountID, sum, result; </li><li>  <font color="#0000ff">static</font> <font color="#0000ff">char</font> * ngx_http_payment_init (ngx_conf_t * cf, </li><li>  ngx_command_t * cmd, <font color="#0000ff">void</font> * conf); </li><li></li><li>  <font color="#008000">// array of possible module options in nginx.conf</font> </li><li>  <font color="#0000ff">static</font> ngx_command_t ngx_http_payment_commands [] = </li><li>  { <font color="#008000">// set only one main option, including the module in the specified Location</font> </li><li>  {ngx_string ( <font color="#A31515">"payment_enabled"</font> ), </li><li>  NGX_HTTP_LOC_CONF | NGX_CONF_NOARGS, </li><li>  ngx_http_payment_init, </li><li>  NGX_HTTP_LOC_CONF_OFFSET, </li><li>  0, </li><li>  Null} </li><li>  ngx_null_command <font color="#008000">// terminates an array</font> </li><li>  }; </li><li>  <font color="#008000">// callback, don't use</font> </li><li>  <font color="#0000ff">static</font> ngx_http_module_t ngx_http_payment_module_ctx = </li><li>  { </li><li>  NULL, <font color="#008000">/ * preconfiguration * /</font> </li><li>  NULL, <font color="#008000">/ * postconfiguration * /</font> </li><li>  NULL, <font color="#008000">/ * create main configuration * /</font> </li><li>  NULL, <font color="#008000">/ * init main configuration * /</font> </li><li>  NULL, <font color="#008000">/ * create server configuration * /</font> </li><li>  NULL, <font color="#008000">/ * merge server configuration * /</font> </li><li>  NULL, <font color="#008000">/ * create location configuration * /</font> </li><li>  NULL <font color="#008000">/ * merge location configuration * /</font> </li><li>  }; </li><li>  <font color="#008000">// module handle, includes all parameters</font> </li><li>  ngx_module_t ngx_http_payment_module = </li><li>  { </li><li>  NGX_MODULE_V1, </li><li>  &amp; ngx_http_payment_module_ctx, <font color="#008000">/ * module context * /</font> </li><li>  ngx_http_payment_commands, <font color="#008000">/ * module directives * /</font> </li><li>  NGX_HTTP_MODULE, <font color="#008000">/ * module type * /</font> </li><li>  NULL, <font color="#008000">/ * init master * /</font> </li><li>  NULL, <font color="#008000">/ * init module * /</font> </li><li>  NULL, <font color="#008000">/ * init process * /</font> </li><li>  NULL, <font color="#008000">/ * init thread * /</font> </li><li>  NULL, <font color="#008000">/ * exit thread * /</font> </li><li>  NULL, <font color="#008000">/ * exit process * /</font> </li><li>  NULL, <font color="#008000">/ * exit master * /</font> </li><li>  NGX_MODULE_V1_PADDING </li><li>  }; </li><li></li><li>  <font color="#0000ff">void</font> SetCallParams ( <font color="#0000ff">int</font> oper, <font color="#0000ff">int</font> account, <font color="#0000ff">int</font> money) </li><li>  { </li><li>  <font color="#0000ff">if</font> (bnd1! = 0) OCIHandleFree ((dvoid *) bnd1, OCI_HTYPE_BIND); </li><li>  <font color="#0000ff">if</font> (bnd2! = 0) OCIHandleFree ((dvoid *) bnd2, OCI_HTYPE_BIND); </li><li>  <font color="#0000ff">if</font> (bnd3! = 0) OCIHandleFree ((dvoid *) bnd3, OCI_HTYPE_BIND); </li><li>  <font color="#0000ff">if</font> (bnd4! = 0) OCIHandleFree ((dvoid *) bnd4, OCI_HTYPE_BIND); </li><li></li><li>  <font color="#008000">// copy from the stack to be able to pass a valid pointer</font> </li><li>  result = 0; </li><li>  operatorID = oper; </li><li>  accountID = account; </li><li>  sum = money; </li><li></li><li>  <font color="#008000">// bind the parameters to the SQL call</font> </li><li>  OCIBindByPos (statement, &amp; bnd1, error, 1, &amp; accountID, </li><li>  <font color="#0000ff">sizeof</font> (accountID), SQLT_INT, (dvoid *) 0, </li><li>  (ub2 *) 0, (ub2 *) 0, (ub4) 0, (ub4 *) 0, OCI_DEFAULT); </li><li>  OCIBindByPos (statement, &amp; bnd2, error, 2, &amp; operatorID, </li><li>  <font color="#0000ff">sizeof</font> (operatorID), SQLT_INT, (dvoid *) 0, </li><li>  (ub2 *) 0, (ub2 *) 0, (ub4) 0, (ub4 *) 0, OCI_DEFAULT); </li><li>  OCIBindByPos (statement, &amp; bnd3, error, 3, &amp; sum, <font color="#0000ff">sizeof</font> (sum), SQLT_INT, </li><li>  (dvoid *) 0, (ub2 *) 0, (ub2 *) 0, (ub4) 0, </li><li>  (ub4 *) 0, OCI_DEFAULT); </li><li>  OCIBindByPos (statement, &amp; bnd4, error, 4, &amp; result, <font color="#0000ff">sizeof</font> (result), SQLT_INT, </li><li>  (dvoid *) 0, (ub2 *) 0, (ub2 *) 0, (ub4) 0, (ub4 *) 0, OCI_DEFAULT); </li><li>  } </li><li>  <font color="#008000">// main handler, all work is done here</font> </li><li>  <font color="#0000ff">static</font> ngx_int_t ngx_http_payment_handler (ngx_http_request_t * r) </li><li>  { </li><li>  <font color="#008000">// clear the body section</font> </li><li>  ngx_int_t rc = ngx_http_discard_request_body (r); </li><li></li><li>  <font color="#0000ff">if</font> (rc! = NGX_OK &amp;&amp; rc! = NGX_AGAIN) </li><li>  { </li><li>  ngx_log_error (NGX_LOG_ERR, r-&gt; connection-&gt; log, 0, </li><li>  <font color="#A31515">"Failed ngx_http_discard_request_body ()"</font> ); </li><li>  <font color="#0000ff">return</font> rc; </li><li>  } </li><li></li><li>  <font color="#008000">// strings in nginx are stored as a pair length-data,</font> </li><li>  <font color="#008000">// not as traditional C-style zero-end</font> </li><li>  <font color="#008000">// copy for the parser to work</font> </li><li>  <font color="#0000ff">const</font> <font color="#0000ff">int</font> buflen = 100; </li><li>  <font color="#0000ff">char</font> buf [buflen + 1]; </li><li>  <font color="#0000ff">int</font> len = (r-&gt; args.len &lt;buflen)?  r-&gt; args.len: buflen; </li><li>  buf [len] = <font color="#A31515">'\ 0'</font> ; </li><li>  ngx_memcpy (buf, r-&gt; args.data, r-&gt; args.len); </li><li></li><li>  <font color="#0000ff">int</font> successful = 0; </li><li>  <font color="#0000ff">int</font> <font color="#0000ff">operator</font> , abonent, money, result = -1; </li><li></li><li>  <font color="#008000">// call the simplest parser</font> </li><li>  <font color="#0000ff">operator</font> = GetIntParam (buf, <font color="#A31515">"operator ="</font> ); </li><li>  abonent = GetIntParam (buf, <font color="#A31515">"abonent ="</font> ); </li><li>  money = GetIntParam (buf, <font color="#A31515">"money ="</font> ); </li><li></li><li>  <font color="#0000ff">if</font> ( <font color="#0000ff">operator</font> &gt; 0 &amp;&amp; abonent&gt; 0 &amp;&amp; money&gt; 0) </li><li>  { </li><li>  SetCallParams ( <font color="#0000ff">operator</font> , abonent, money); </li><li></li><li>  <font color="#0000ff">int</font> retCode = OCIStmtExecute ( </li><li>  context, statement, error, (ub4) 1, (ub4) 0, </li><li>  (OCISnapshot *) NULL, (OCISnapshot *) NULL, </li><li>  (ub4) OCI_COMMIT_ON_SUCCESS); </li><li></li><li>  <font color="#0000ff">if</font> (retCode == OCI_SUCCESS) </li><li>  successful = 1; </li><li>  } </li><li></li><li>  r-&gt; headers_out.content_type.len = <font color="#0000ff">sizeof</font> ( <font color="#A31515">"text / html"</font> ) - 1; </li><li>  r-&gt; headers_out.content_type.data = (u_char *) <font color="#A31515">"text / html"</font> ; </li><li>  r-&gt; headers_out.content_length_n = 0; </li><li></li><li>  <font color="#0000ff">if</font> (successful == 1) </li><li>  r-&gt; headers_out.status = NGX_HTTP_OK; </li><li>  <font color="#0000ff">else</font> </li><li>  r-&gt; headers_out.status = NGX_HTTP_INTERNAL_SERVER_ERROR; </li><li></li><li>  <font color="#008000">// ... forming the body of the response and sending it to nginx .. see emiller examples</font> </li><li>  } </li><li></li><li>  <font color="#0000ff">static</font> <font color="#0000ff">char</font> * ngx_http_payment_init (ngx_conf_t * cf, </li><li>  ngx_command_t * cmd, </li><li>  <font color="#0000ff">void</font> * our_conf) </li><li>  { </li><li>  <font color="#008000">// set nginx handler</font> </li><li>  ngx_http_core_loc_conf_t * core_conf = </li><li>  ngx_http_conf_get_module_loc_conf (cf, ngx_http_core_module); </li><li>  core_conf-&gt; handler = ngx_http_payment_handler; </li><li></li><li>  <font color="#008000">// oracle</font> </li><li>  bnd1 = (OCIBind *) 0; </li><li>  bnd2 = (OCIBind *) 0; </li><li>  bnd3 = (OCIBind *) 0; </li><li>  bnd4 = (OCIBind *) 0; </li><li></li><li>  OCIEnvCreate ((OCIEnv **) &amp; env, (ub4) OCI_DEFAULT, </li><li>  (dvoid *) 0, (dvoid * (*) (dvoid *, size_t)) 0, </li><li>  (dvoid * (*) (dvoid *, dvoid *, size_t)) 0, </li><li>  ( <font color="#0000ff">void</font> (*) (dvoid *, dvoid *)) 0, (size_t) 0, (dvoid **) 0); </li><li>  <font color="#008000">/ * allocate a server handle * /</font> </li><li>  OCIHandleAlloc ((dvoid *) env, (dvoid **) &amp; server, </li><li>  OCI_HTYPE_SERVER, 0, (dvoid **) 0); </li><li>  <font color="#008000">/ * allocate an error handle * /</font> </li><li>  OCIHandleAlloc ((dvoid *) env, (dvoid **) &amp; error, </li><li>  OCI_HTYPE_ERROR, 0, (dvoid **) 0); </li><li>  <font color="#008000">/ * create a server context * /</font> </li><li>  <font color="#0000ff">int</font> retCode = OCIServerAttach (server, error, db_conn_str, </li><li>  strlen (( <font color="#0000ff">const</font> <font color="#0000ff">char</font> *) db_conn_str), OCI_DEFAULT); </li><li></li><li>  <font color="#008000">/ * allocate a service handle * /</font> </li><li>  retCode = OCIHandleAlloc ((dvoid *) env, (dvoid **) &amp; context, </li><li>  OCI_HTYPE_SVCCTX, 0, (dvoid **) 0); </li><li>  <font color="#008000">/ * set the server attribute in the service context * /</font> </li><li>  retCode = OCIAttrSet ((dvoid *) context, OCI_HTYPE_SVCCTX, </li><li>  (dvoid *) server, (ub4) 0, OCI_ATTR_SERVER, error); </li><li>  <font color="#008000">/ * allocate a user session handle * /</font> </li><li>  retCode = OCIHandleAlloc ((dvoid *) env, (dvoid **) &amp; session, </li><li>  OCI_HTYPE_SESSION, 0, (dvoid **) 0); </li><li>  <font color="#008000">// set up user &amp; password for our session</font> </li><li>  retCode = OCIAttrSet ((dvoid *) session, OCI_HTYPE_SESSION, </li><li>  ( <font color="#0000ff">void</font> *) db_user_name, (ub4) strlen (( <font color="#0000ff">const</font> <font color="#0000ff">char</font> *) db_user_name), </li><li>  OCI_ATTR_USERNAME, error); </li><li>  retCode = OCIAttrSet ((dvoid *) session, OCI_HTYPE_SESSION, </li><li>  ( <font color="#0000ff">void</font> *) db_password, (ub4) strlen (( <font color="#0000ff">const</font> <font color="#0000ff">char</font> *) db_password), </li><li>  OCI_ATTR_PASSWORD, error); </li><li>  <font color="#008000">// start session</font> </li><li>  retCode = OCISessionBegin (context, error, session, </li><li>  OCI_CRED_RDBMS, OCI_DEFAULT); </li><li></li><li>  <font color="#008000">/ * set the user session attribute in the service context * /</font> </li><li>  retCode = OCIAttrSet ((dvoid *) context, OCI_HTYPE_SVCCTX, </li><li>  (dvoid *) session, (ub4) 0, </li><li>  OCI_ATTR_SESSION, error); </li><li>  OCIHandleAlloc ((dvoid *) env, (dvoid **) &amp; statement, </li><li>  OCI_HTYPE_STMT, (size_t) 0, (dvoid **) 0); </li><li>  OCIStmtPrepare (statement, error, command, (ub4) strlen (( <font color="#0000ff">char</font> *) command), </li><li>  (ub4) OCI_NTV_SYNTAX, (ub4) OCI_DEFAULT); </li><li>  <font color="#0000ff">return</font> NGX_CONF_OK; </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br></div><p>Source: <a href="https://habr.com/ru/post/69974/">https://habr.com/ru/post/69974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../69968/index.html">Aaaaaaaaaaaaaaaaaaaaaaaaaa !!! - A Reckless Disregard for Gravity!</a></li>
<li><a href="../69970/index.html">In posterous appeared themes</a></li>
<li><a href="../69971/index.html">Rules Yaroslav Greshilova</a></li>
<li><a href="../69972/index.html">Simple house pro game</a></li>
<li><a href="../69973/index.html">Free domain name registration</a></li>
<li><a href="../69975/index.html">Another Trojan and web studio</a></li>
<li><a href="../69976/index.html">A formula editor appeared in Google Docs.</a></li>
<li><a href="../69977/index.html">Google translate</a></li>
<li><a href="../69981/index.html">"Hello, I am a technical writer"</a></li>
<li><a href="../69982/index.html">Something terrible is happening in the world of advertising</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>