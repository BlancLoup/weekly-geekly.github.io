<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transferring tabular data from stored procedure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It will be about methods of obtaining the results of the procedure in the form of tables for further work with them in SQL. I think the majority of wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transferring tabular data from stored procedure</h1><div class="post__text post__text-html js-mediator-article">  It will be about methods of obtaining the results of the procedure in the form of tables for further work with them in SQL.  I think the majority of what is stated here can be useful only in applications with complex SQL logic and lengthy procedures.  I do not presume to say that these methods are the most effective.  This is just what I use in my work.  All this works under Microsoft SQL Server 2008. <br>  To those who are familiar with the topic, I propose to scroll through the post to the fifth method. <br><a name="habracut"></a><br>  Let the procedure from which we need to obtain data be: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> Proc1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> p1, <span class="hljs-string"><span class="hljs-string">'b'</span></span> p2 <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><h4>  1 Method </h4><br>  One of the easiest methods.  We use the <code>insert ... exec ...</code> construction <code>insert ... exec ...</code> <br><pre> <code class="sql hljs">if object_id(N'tempdb..<span class="hljs-comment"><span class="hljs-comment">#t1',N'U') is not null drop table #t1 create table #t1(p1 int, p2 varchar(max)) insert #t1 exec Proc1 select * from #t1</span></span></code> </pre><br><h5>  Advantages and disadvantages: </h5><br><ul><li>  The fields transferred are listed 2 times (these are internal <code>select</code> , external table creation and <code>insert</code> ).  Plus, the enumeration of fields occurs with each new similar call.  (I add this criterion, because with a large number of revisions and a set of places to call a procedure, the process of changing the output data becomes very time consuming) </li><li>  It has a serious limitation - we can only get one table. </li><li>  To <code>exec Proc1</code> procedure in the simple output mode, no additional actions are required, it is enough to run <code>exec Proc1</code> without <code>insert</code> </li></ul><br><br><h4>  2 Method </h4><br>  By writing to a previously created table.  Here you have to add insert to the procedure: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> Proc1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-comment"><span class="hljs-comment">#t1(p1, p2) select 1 p1, 'b' p2 end</span></span></code> </pre><br>  In fact, we moved the insert string inside the procedure. <br><pre> <code class="sql hljs">if object_id(N'tempdb..<span class="hljs-comment"><span class="hljs-comment">#t1',N'U') is not null drop table #t1 create table #t1(p1 int, p2 varchar(max)) exec Proc1 select * from #t1</span></span></code> </pre><br><h5>  Advantages and disadvantages: </h5><br><ul><li>  Transferred fields are listed 2 times, and one more transfer for each new use </li><li>  For the procedure to work in simple output mode, you will need to either write a separate procedure that <code>Proc1</code> tables received from <code>Proc1</code> , or determine when to output them inside <code>Proc1</code> .  For example, based on the existence of a table for insertion: </li></ul><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> Proc1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> object_id(N<span class="hljs-string"><span class="hljs-string">'tempdb..#t1'</span></span>,N<span class="hljs-string"><span class="hljs-string">'U'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">show</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-comment"><span class="hljs-comment">#t1(p1 int, p2 varchar(max)) end insert #t1(p1, p2) select 1 p1, 'b' p2 if (@show = 1) begin select * from #t1 end end</span></span></code> </pre><br>  I do not consider the possibility of passing through permanent tables, because  if required, the task is not to relate to this topic.  If not, then we get unnecessary problems with blocking and identification between sessions. <br><br><h4>  3 Method </h4><br>  In essence, it is a refinement of the second method.  To simplify support, create a custom table type.  It looks like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> tt1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(p1 <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, p2 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> Proc1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-comment"><span class="hljs-comment">#t1(p1, p2) select 1 p1, 'b' p2 end go -- : declare @t1 tt1 if object_id(N'tempdb..#t1',N'U') is not null drop table #t1 select * into #t1 from @t1 exec Proc1 select * from #t1</span></span></code> </pre><br><h5>  Advantages and disadvantages: </h5><br><ul><li>  Transmitted fields are listed 2 times, with each new use does not add complexity </li><li>  Organizing the direct output of the result also requires additional actions. </li><li>  There are some difficulties with creating indexes and restrictions, since  we cannot create them with <code>select ... into</code> constructions <code>select ... into</code> </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  4 Method </h4><br>  The complication of the third method, which allows you to create a table with constraints and indexes.  In difference from previous works under Microsoft SQL Server 2005. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> Proc1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-comment"><span class="hljs-comment">#t1(p1, p2) select 1 p1, 'b' p2 end go create procedure Proc1_AlterTable as begin alter table #t1 add p1 int, p2 varchar(max) alter table #t1 drop column delmy end go -- : if object_id(N'tempdb..#t1',N'U') is not null drop table #t1 create table #t1(delmy int) exec Proc1_AlterTable exec Proc1 select * from #t1</span></span></code> </pre><br>  However, usually the delmy time column is not used, instead the table is created simply with one first column (here with p1). <br><br><h5>  Advantages and disadvantages: </h5><br><ul><li>  Transmitted fields are listed 2 times, with each new use does not add complexity </li><li>  For immediate output of the result, additional actions are also required. </li><li>  It was unexpectedly discovered that sometimes, for unknown reasons, there are locks on the <code>alter table #t1</code> structure, and the process waits for the complete completion of the <code>Proc1</code> (not <code>Proc1_AlterTable</code> !) Parallel query.  If anyone knows what this is connected with - share, I will be glad to hear :) </li></ul><br><br><h4>  5 Method </h4><br>  This method uses pre-created procedures.  It is based on the inclusion of a dynamic SQL query in the procedure being run.  However, it is quite easy to use. <br><br>  To use it, the procedure must be processed as follows: <br><br>  1. At the beginning of the procedure include the lines: <br><pre> <code class="sql hljs">if object_id('tempdb..<span class="hljs-comment"><span class="hljs-comment">#ttInclusion', 'U') is null create table #ttInclusion(lvl int, i int) exec util.InclusionBegin</span></span></code> </pre><br>  2. Alter all output selects of the procedure to create temporary tables starting with <code>#Output</code> (for example <code>into #Output</code> , <code>into #Output5</code> , <code>into #OutputMySelect</code> ).  If the procedure does not create a result set, then no action is required. <br>  3. At the end of the procedure, include the line: <br><pre> <code class="sql hljs">exec util.InclusionEnd <span class="hljs-comment"><span class="hljs-comment">--  ,   #Output,       util.InclusionBegin</span></span></code> </pre><br>  For our example, we get: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> Proc1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> object_id(<span class="hljs-string"><span class="hljs-string">'tempdb..#ttInclusion'</span></span>, <span class="hljs-string"><span class="hljs-string">'U'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-comment"><span class="hljs-comment">#ttInclusion(lvl int, i int) exec util.InclusionBegin select 1 p1, 'b' p2 into #Output1 exec util.InclusionEnd --  ,   #Output,       util.InclusionBegin end</span></span></code> </pre><br>  The launch is carried out as follows: <br><pre> <code class="sql hljs">if object_id('tempdb..<span class="hljs-comment"><span class="hljs-comment">#ttInclusionParameters', 'U') is null create table #ttInclusionParameters(lvl int, pr int, val varchar(max)) exec util.InclusionRun' select * from #InclusionOutput1 ', 1, '#InclusionOutput' exec Proc1</span></span></code> </pre><br>  Since the generated SQL is not always good, the given example is better suited for small instructions.  If there is a lot of code, you can either put it into a separate procedure and from the dynamic part make only an exec call, or reload the data into new temporary tables.  In the latter case, of course, there is another ‚Äúextra‚Äù copying, but it often happens that at this stage we can group the result and select only the necessary fields for further processing (for example, if in any case all the returned data is not required) ). <br><br>  The <code>util.InclusionRun</code> functions are passed 3 parameters: <br><ul><li>  <code>@sql</code> - SQL script that executes inside the called procedure </li><li>  <code>@notShowOutput</code> - if = 1, then block output of tables starting with <code>#Output</code> </li><li>  <code>@replaceableTableName</code> - (default = <code>'#Output'</code> ) set the prefix in the name of the tables used in <code>@sql</code> , to replace it with the corresponding <code>#Output*</code> table in the script.  For example, if you specify <code>#InclusionOutput</code> , and two tables <code>#Output55</code> and <code>#Output0A</code> created in the procedure, in <code>@sql</code> you can refer to <code>#Output55</code> as <code>#InclusionOutput1</code> , and <code>#Output0A</code> as <code>#InclusionOutput2</code> </li></ul><br><br>  The work is structured in such a way that the launch of <code>Proc1</code> , without first running <code>util.InclusionRun</code> leads to the natural work of the procedure with the output of all the data that it displayed before processing. <br><br><h5>  Nuances of use: </h5><br><ul><li>  Imposes restrictions on the use of the <code>return</code> in the procedure, since  it needs to be started <code>util.InclusionEnd</code> </li><li>  Outputting selects from the launched procedures output the result earlier than even those # Output-tables that were created before they were called (this is logical, since the output occurs only in <code>util.InclusionEnd</code> ) </li></ul><br><br><h5>  Advantages and disadvantages: </h5><br><ul><li>  Transmitted fields are listed once, with each new use not adding complexity. </li><li>  No direct action is required to display the result. </li><li>  It is necessary to remember and consider the nuances of use. </li><li>  Due to additional procedures, more instructions are executed, which can reduce the speed of frequent calls (I think that this can be neglected at startup less than once per second) </li><li>  Perhaps, it may complicate the understanding of the code for employees who are not familiar with this method: the procedure acquires two exec-calls and the non-obviousness that all <code>#Output</code> tables will be displayed </li><li>  Allows you to easily organize unit testing without external tools </li></ul><br><br><h5>  Demonstration of use: </h5><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  Code: <br><pre> <code class="sql hljs">if object_id('dbo.TestInclusion') is not null <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> dbo.TestInclusion <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> dbo.TestInclusion @i <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> object_id(<span class="hljs-string"><span class="hljs-string">'tempdb..#ttInclusion'</span></span>, <span class="hljs-string"><span class="hljs-string">'U'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-comment"><span class="hljs-comment">#ttInclusion(lvl int, i int) exec util.InclusionBegin if object_id('tempdb..#tmp2', 'U') is not null drop table #tmp2 select @i myI into #tmp2 if object_id('tempdb..#tmp3', 'U') is not null drop table #tmp3 select @i + 1 myI into #tmp3 select * into #Output0 --  (  util.InclusionEnd) from #tmp2 union all select * from #tmp3 select ' TestInclusion' alt into #OutputQwerty --  (  util.InclusionEnd) exec util.InclusionEnd --     #Output       util.InclusionBegin end go set nocount on set ansi_warnings off if object_id('tempdb..#ttInclusionParameters', 'U') is not null drop table #ttInclusionParameters go select ' 1:  TestInclusion.         myI   : 2  3.    1 : " TestInclusion"' exec dbo.TestInclusion 2 go select ' 2:  TestInclusion.         testSum   : 5' if object_id('tempdb..#ttInclusionParameters', 'U') is null create table #ttInclusionParameters(lvl int, pr int, val varchar(max)) exec util.InclusionRun ' select sum(myI) testSum from #InclusionOutput1 ', 1, '#InclusionOutput' exec dbo.TestInclusion 2</span></span></code> </pre><br><br>  Result: <br><pre> <code class="bash hljs">-----------------------------------------------------------------------------------------------------------------------------------------------------------  1:  TestInclusion.         myI   : 2  3.    1 : <span class="hljs-string"><span class="hljs-string">" TestInclusion"</span></span> myI ----------- 2 3 alt -----------------------  TestInclusion ------------------------------------------------------------------------------------------------------  2:  TestInclusion.         testSum   : 5 testSum ----------- 5</code> </pre><br></div></div><br><br><h5>  The functions themselves: </h5><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="sql hljs">if not exists(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.schemas <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = <span class="hljs-string"><span class="hljs-string">'util'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> exec (<span class="hljs-string"><span class="hljs-string">'create schema util'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> util.InclusionBegin <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   : 1.       1.1.     : if object_id('tempdb..#ttInclusion', 'U') is null create table #ttInclusion(lvl int, i int) exec util.InclusionBegin 1.1.   select'         #Output ( into #Output, into #Output5, into #OutputMySelect) 1.2.     : exec util.InclusionEnd --  ,   #Output,       util.InclusionBegin 2.  ,    ,       (      #Output* ): if object_id('tempdb..#ttInclusionParameters', 'U') is null create table #ttInclusionParameters(lvl int, pr int) exec util.InclusionRun('&lt;sql         &gt;')  .   util.InclusionRun */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ansi_warnings <span class="hljs-keyword"><span class="hljs-keyword">off</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @lvl <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> object_id(<span class="hljs-string"><span class="hljs-string">'tempdb..#ttInclusionParameters'</span></span>, <span class="hljs-string"><span class="hljs-string">'U'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @lvl = <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(lvl) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-comment"><span class="hljs-comment">#ttInclusionParameters -- null ,           if (@lvl is not null) begin insert #ttInclusionParameters(lvl, pr) select @lvl+1 lvl, null pr end end if object_id('tempdb..#ttInclusion', 'U') is not null begin --     #Output,   util.InclusionEnd    insert #ttInclusion(lvl, i) select isnull(@lvl, 0), so.object_id i from tempdb.sys.objects so where so.type = 'U' and so.name like '#[^#]%' and object_id('tempdb..' + so.name, 'U') is not null and not exists (select top 1 null from #ttInclusion where i = so.object_id) end end GO go alter procedure util.InclusionEnd as begin /*   : 1.       1.1.     : if object_id('tempdb..#ttInclusion', 'U') is null create table #ttInclusion(lvl int, i int) exec util.InclusionBegin 1.1.   select'         #Output ( into #Output, into #Output5, into #OutputMySelect) 1.2.     : exec util.InclusionEnd --  ,   #Output,       util.InclusionBegin 2.  ,    ,       (      #Output* ): if object_id('tempdb..#ttInclusionParameters', 'U') is null create table #ttInclusionParameters(lvl int, pr int) exec util.InclusionRun('&lt;sql         &gt;')  .   util.InclusionRun */ set nocount on set ansi_warnings off ---------------------------------------------------------------------------------------------------- --  declare @lvl int , @p0 varchar(max) --(@sql) sql     , @p1 varchar(max) --(@notShowOutput)   '1'        ,    #Output,    , @p2 varchar(max) --(@replaceableTableName)    if object_id('tempdb..#ttInclusionParameters', 'U') is not null begin --   select @p1 = max(val) from #ttInclusionParameters where pr = 1 --      (max(lvl) -    null     util.InclusionBegin) select @lvl = max(lvl) - 1 from #ttInclusionParameters if @lvl is not null begin -- select @p0 = max(case when pr = 0 then val end) , @p2 = max(case when pr = 2 then val end) from #ttInclusionParameters where lvl = @lvl having max(pr) is not null --   ,    ,   null- delete #ttInclusionParameters where lvl &gt;= @lvl and (lvl &gt; @lvl or @p0 is not null) end end ---------------------------------------------------------------------------------------------------- --    #Output if object_id('tempdb..#InclusionOutputs', 'U') is not null drop table #InclusionOutputs create table #InclusionOutputs(i int, tableName varchar(max), num int) if object_id('tempdb..#ttInclusion', 'U') is not null begin insert #InclusionOutputs(i, tableName, num) select so.object_id i, left(so.name, charindex('_', so.name)-1) tableName, row_number() over (order by so.create_date) num from tempdb.sys.objects so where so.type = 'U' and so.name like '#[^#]%' and object_id('tempdb..' + so.name, 'U') is not null and so.name like '#Output%' and not exists (select top 1 null from #ttInclusion where i = so.object_id and lvl &lt;= isnull(@lvl, lvl)) --   ,     delete #ttInclusion where lvl &lt;= @lvl end else begin insert #InclusionOutputs(i, tableName, num) select so.object_id i, left(so.name, charindex('_', so.name)-1) tableName, row_number() over (order by so.create_date) num from tempdb.sys.objects so where so.type = 'U' and so.name like '#[^#]%' and object_id('tempdb..' + so.name, 'U') is not null and so.name like '#Output%' end ---------------------------------------------------------------------------------------------------- --  (    -   #Output) declare @srcsql varchar(max) --    util.InclusionRun if (@p0 is not null and @p0 &lt;&gt; '') begin --  @replaceableTableName if (@p2 is not null and @p2 &lt;&gt; '') begin select @p0 = replace(@p0, @p2 + cast(num as varchar(10)), replace(tableName, '#', '#&lt;tokenAfterReplace&gt;')) from #InclusionOutputs order by num desc select @p0 = replace(@p0, '&lt;tokenAfterReplace&gt;', '') end --   select @srcsql = isnull(@srcsql + ' ' + char(13), '') + @p0 + ' ' + char(13) end --  #Output  if (@p1 is null or @p1 &lt;&gt; '1') --  1,   ! begin --    select @srcsql = isnull(@srcsql + ' ' + char(13), '') --   select @srcsql = isnull(@srcsql + ' ', '') + 'select * from ' + tableName from #InclusionOutputs order by num asc end if (@srcsql is not null) begin exec (@srcsql) end end go alter procedure util.InclusionRun @sql varchar(max), --sql       ( util.InclusionEnd) @notShowOutput bit, -- = 1,       #Output @replaceableTableName varchar(100) = '#Output' --        @sql,      #Output*   . -- ,   #InclusionOutput,       #Output55  #Output0A, --   @sql    #Output55   #InclusionOutput1,   #Output0A   #InclusionOutput2 as begin set nocount on set ansi_warnings off if object_id('tempdb..#ttInclusionParameters', 'U') is null begin print ' util.InclusionRun  , ..      #ttInclusionParameters! ' return end declare @lvl int select @lvl = isnull(max(lvl), 0) + 1 from #ttInclusionParameters insert #ttInclusionParameters(lvl, pr, val) select @lvl, 0, @sql union all select @lvl, 1, '1' where @notShowOutput = 1 union all select @lvl, 2, @replaceableTableName end</span></span></code> </pre><br></div></div><br><br><h4>  Other methods </h4><br>  You can use the parameter transfer from the function ( <code>OUTPUT</code> ) and, based on its value, restore the table.  For example, you can pass a cursor or XML. <br>  There is <a href="http://technet.microsoft.com/ru-ru/library/ms188655.aspx">an article</a> on this topic. <br>  I don‚Äôt see the point of using the cursor for this task, only if the cursor is initially required.  But XML looks promising.  <a href="http://habrahabr.ru/post/96145/">Here are</a> very interesting results of performance tests. <br>  It is interesting to hear how you use ways to simplify this task :) <br><br>  <b>UPD 03/31/2014:</b> Adjusted the post on the ideas from the comments </div><p>Source: <a href="https://habr.com/ru/post/217649/">https://habr.com/ru/post/217649/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217639/index.html">Working with SQL Server in Hybrid Cloud Scripts. Part 2</a></li>
<li><a href="../217641/index.html">New hub "Chrome Extensions" (from October 2014 - "Extensions for browsers")</a></li>
<li><a href="../217643/index.html">Huawei Tecal RH2288H V2 - First Impressions</a></li>
<li><a href="../217645/index.html">How Minkowski in Flappy Bird played</a></li>
<li><a href="../217647/index.html">while (true) {Apple sues Samsung for $ 2 billion}</a></li>
<li><a href="../217651/index.html">How to move from the Objectives of the technical support unit to indicators that are understandable to employees</a></li>
<li><a href="../217653/index.html">Moai SDK 1.5 - cross-platform 2D game engine</a></li>
<li><a href="../217655/index.html">Making ‚Äúlife‚Äù in Linux easier or automating process startup using cron</a></li>
<li><a href="../217657/index.html">Wi-Fi Controller Access Points on Mikrotik</a></li>
<li><a href="../217659/index.html">Forecast for the number of likes in the post. SNA Hackathon 2014</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>