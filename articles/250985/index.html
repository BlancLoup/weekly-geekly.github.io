<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Custom PHP Project Optimization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this publication I want to talk about how non-traditional methods we were able to reduce the load on the servers and speed up the processing time o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Custom PHP Project Optimization</h1><div class="post__text post__text-html js-mediator-article">  In this publication I want to talk about how non-traditional methods we were able to reduce the load on the servers and speed up the processing time of the page several times. <br><br><img src="https://habrastorage.org/files/8e5/aed/55f/8e5aed55fd6d46cd9c1332000efdbf90.png" alt="image"><br><br>  Traditional methods, I think, are known to all: <br><ul><li>  Optimization of SQL queries; </li><li>  Find and fix bottlenecks; </li><li>  Transition to Memcache for frequently used data; </li><li>  Installing APC, XCache and the like; </li><li>  Client optimization: CSS sprites, etc. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In our project, all this was done, but the problem of page processing speed remained.  The average page processing speed was around 500ms.  At one point, the idea came to analyze what resources there are and what they can spend. <br><a name="habracut"></a><br>  After the analysis, the following main resources were identified that need to be monitored: <br><br><ol><li>  CPU time; </li><li>  RAM; </li><li>  Timeout of other resources (MySQL, memcache); </li><li>  Disk latency. </li></ol><br>  In our project, we almost do not use writing to disk, so we immediately excluded the 4th item. <br><br>  Next began the search for bottlenecks. <br><br><h4>  Stage 1 </h4><br>  The first thing that was tried was profiling MySQL queries, searching for slow queries.  The approach did not bring much success: several requests were optimized, but the average page processing time did not change much. <br><br><h4>  Stage 2 </h4><br>  Next was an attempt to profile code with the help of XHProf.  This gave acceleration in narrow places and could reduce the load by about 10-15%.  But this did not solve the main problem either.  (If you're interested, I can write a separate article on how to optimize using XHProf. You just let me know in the comments.) <br><br><h4>  Stage 3 </h4><br>  In the third stage, the thought came to see how much memory is spent on processing the request.  It turned out that this is the problem - a simple request may require you to load up to 20mb code in the RAM.  And the reason for this was incomprehensible, since there is a simple page load - without queries to the database, or downloading large files. <br><br>  It was decided to write an analyzer and find out how much memory each php file requires when it is turned on. <br><br>  The analyzer is very simple: the project already had an autoloader for the files, which based on the class name itself loaded the required file (autoload).  It simply added 2 lines: how much memory was there before the file was loaded, how much it became after. <br><br>  Code example: <br><br><pre><code class="php hljs">Profiler::startLoadFile($fileName); <span class="hljs-keyword"><span class="hljs-keyword">Include</span></span> $fileName; Profiler::endLoadFile($fileName);</code> </pre> <br>  The first line saves how much memory was in the beginning, the last line - subtracts the difference and adds to the list of downloads.  The profiler also stores the file download queue (backtrack). <br><br>  At the end of the execution of all the code, we added the output of the panel with the collected information. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> Profiler:showPanel();</code> </pre><br>  The analysis showed very interesting reasons why excessive memory can be used.  After we analyzed all the pages and removed the download of extra files, the page began to require less than 8mb of memory.  Updating the page has become faster, the load on the servers has decreased and the same machines have the ability to process more clients. <br><br>  Next comes the list of things that we changed.  It is worth noting that the functionality itself has not changed.  Only the structure of the code has changed. <br><br>  All examples are made specially simplified, since there is no possibility to provide the original project code. <br><br><h4>  Example 1: Loading, but not using large parent classes </h4><br>  Example: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SysPage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Page</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">helloWorld</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Hello World"</span></span>; } }</code> </pre><br>  The file itself is very small, but at the same time, it pulls at least one other file, which can be quite large. <br><br>  <b>There are several solutions:</b> <br><br><ol><li>  Remove inheritance where not needed; </li><li>  Make sure all parent classes are minimal in size. </li></ol><br><br><h4>  Example 2: Using long classes, although only a small part of the class is needed </h4><br>  Very similar to the previous item.  Example: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Page</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isActive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-comment"><span class="hljs-comment">//     1000-2000  }</span></span></code> </pre><br>  Naturally, PHP does not know that you need only 1 function.  As soon as a call is made to this class, the entire file is loaded. <br><br>  <b>Decision:</b> <br>  If there are similar classes, then it is worth allocating the functionality that is used everywhere in a separate class.  In the current class, you can refer to the new class for compatibility. <br><br><h4>  Example 3: Loading a large class for constants only </h4><br>  Example: <br><br><pre> <code class="php hljs">$CONFIG[<span class="hljs-string"><span class="hljs-string">'PAGES'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'news'</span></span> =&gt; Page::PAGE_TYPE1, <span class="hljs-string"><span class="hljs-string">'about'</span></span> =&gt; Page::PAGE_TYPE2, );</code> </pre><br>  Or: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(get(<span class="hljs-string"><span class="hljs-string">'page'</span></span>)==Page::PAGE_TYPE1){}</code> </pre><br>  Those.  The example is similar to the previous one, only now it is constant.  The solution is the same as in the past case. <br><br><h4>  Example 4: Auto-creation in the constructor of classes that may not be used </h4><br>  Example: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Action</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $handler; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle5</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle6</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle7</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle8</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle9</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle10</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $info = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handler-&gt;getInfo(); } }</code> </pre><br>  If Handler is used frequently, then there is no problem.  A completely different question if it is used only in 1 of the functions out of 20. <br><br>  <b>Decision:</b> <br>  We remove from the constructor, go to the lazy loading through the __get magic method or, for example: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle10</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $info = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handler()-&gt;getInfo(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handler===<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handler; }</code> </pre><br><h4>  Example 5: Uploading unnecessary language files / configs </h4><br>  Example: You have a large file with settings for all pages of all menu items.  There may be many arrays in the file. <br><br>  If part of the data is rarely used and part is often used, then this file is a candidate for separation. <br><br>  Those.  It is worth loading these settings only when they are needed. <br><br>  An example of the use of memory with us: <br><br>  A file of 16 kb, just an array of data - requires from 100 kb and above. <br><br><h4>  Example 6: Using serialize / unserialize </h4><br>  Some of the settings that change frequently are stored in a file in serialize format.  We found that it loads both the processor and the RAM, and it turned out that on PHP version 5.3.x, the unserialize function has a very strong memory leak. <br><br>  After optimization, we got rid of these functions as much as possible where possible.  We decided to store the data in files as an array saved via var_export and load it back with include / require.  Thus, we were able to use the APC mode. <br><br>  Unfortunately, for the data stored in memcache, this approach does not work. <br><br><h4>  Results </h4><br>  All these examples are easily found and very easily corrected without much changing the structure of the project.  We took the rule: ‚Äúany files that require more than 100kb should be checked to see if their downloads can be optimized.  We also looked at the situation when several files were loaded from the same branch.  In this situation, we looked at whether it was possible not to load the entire file branch at all.  The key thought was: ‚Äúeverything we download should make sense.  If you can not download in any way - it is better not to download. <br><br><h4>  Conclusion </h4><br>  After we removed everything above, one request to the server began to require about 2 times less RAM.  This gave us a decrease in processor load of about 2 times without reconfiguring servers and reducing the average download speed of one page several times. <br><br><h4>  Future plans </h4><br>  If it is interesting, there is an idea in the plans to describe ways of profiling code and finding bottlenecks using XHprof. </div><p>Source: <a href="https://habr.com/ru/post/250985/">https://habr.com/ru/post/250985/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250973/index.html">Speech at the conference: what is important to know</a></li>
<li><a href="../250975/index.html">Selenium for Python. Chapter 4. Search for items</a></li>
<li><a href="../250977/index.html">Objective-C Runtime for Si-Schnick. Part 2</a></li>
<li><a href="../250979/index.html">CxxMock - Mock Objects in C ++</a></li>
<li><a href="../250981/index.html">HTML5 MathMl</a></li>
<li><a href="../250989/index.html">Receive radio footage and other digital transmissions using a conventional receiver and computer</a></li>
<li><a href="../250991/index.html">The Equation, Carbanak, Desert Falcons: Report with Security Analyst Summit</a></li>
<li><a href="../250995/index.html">UART in ATtiny13 or How to display data from the MC for 52p</a></li>
<li><a href="../250997/index.html">Plotting in LaTeX / PGFPlots</a></li>
<li><a href="../250999/index.html">Recover local and domain passwords from hiberfil.sys</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>