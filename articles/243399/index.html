<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Algorithms and solutions when developing the C # JavaScript engine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear habrovchane! 

 A little less than a year ago, I also, in the sandbox, published an article about the beginning of the development of the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Algorithms and solutions when developing the C # JavaScript engine</h1><div class="post__text post__text-html js-mediator-article">  Hello, dear habrovchane! <br><br>  A little less than a year ago, I also, in the sandbox, published an article about the beginning of the development of <a href="http://habrahabr.ru/sandbox/75576/">the JavaScript engine in C #</a> .  A year has passed since the creation of the project and I am pleased to present you the first version of this creation, which can be downloaded on <a href="https://www.nuget.org/packages/NiL.JS/">nuget</a> . <br>  But in this article I will not promote, make comparisons with competitors, measure performance and so on.  Here I will write about what I had to go through, what kind of blood it all was and what I had to face. <br><a name="habracut"></a><br>  <b>Typing conflict</b> <br><br>  This problem was one of the first.  And it follows from the fact that at the very beginning the goal was set to ensure easy interaction with the .NET classes.  As a result, all built-in types of the standard JavaScript library are implemented by the same types in C #. <br>  Everyone knows that in JavaScript you can call any function in the context of any object.  Some of these cases are even described in the specification.  For example, what happens if the <i>arguments</i> object that stores the function call arguments and their number is sent to some function from <i>Array.prototype</i> ?  That's right, it will work as with a regular array and return the correct result.  And how to implement it in C # ?!  It turned out there is such a way: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Through Reflection, get the <i>MethodInfo of</i> the method you want to call. </li><li>  Get <i>MethodHandle.GetFunctionPointer ()</i> </li><li>  Via <i>Activator,</i> create a delegate with the arguments of the types used in the original function, but add the first argument of the <i>object</i> type. </li></ol><br>  Now we can call this delegate, passing the first argument an object of any reference type. <br><br>  As you can see, there is no magic here, standard documented functions are used.  But to what comes after that, the creators of the platform, obviously, did not prepare - Visual Studio cannot decide on the type and does not even try to call <i>ToString</i> during debugging, and the <i>is</i> operator returns <i>true</i> when checking for the type that declared the method, even if object inherit from <i>object</i> only makes them related.  Saves <i>GetType</i> , which does not cheat and returns a real type. <br>  Understanding the danger of such an operation, I added the <i>AllowUnsafeCall</i> attribute, the designer of which requires Ian to indicate an alternative type that I‚Äôm ready to receive inside the method marked by it (the heirs of the specified type will also come). <br><br>  <b>Sparse Array (Sparse Array)</b> <br><br>  JavaScript arrays have a wonderful property - to store elements with indices 0, 1, 2 and 10005000, not to occupy several gigabytes of memory, and even to select existing indexes in ascending order when iterating, which is not characteristic of hash tables that you can think about.  In search of a suitable data structure that has these properties, and even fast, a lot of books and websites were crammed.  At some point, this whole mess of information degenerated into a ‚Äúprefix binary search tree with processor cache optimization‚Äù.  It sounds loud and long, but in reality the implementation of this structure takes a little more than 100 lines of code. <br>  Three fields are created for storing objects: one array for the ‚Äútree node‚Äù, the second array for the values ‚Äã‚Äãthemselves, and an integer number of selected elements. <br>  Each node has 4 fields: <br><br><ol><li>  Key to access.  Unsigned integer 32 bits </li><li>  The index of the first child (or zero, which is more appropriate in this case) </li><li>  Index of the second descendant </li><li>  Index bit.  Created for optimization </li></ol><br>  By default, we assume that the object with index 0 has already been added to the array. <br>  Addition: <br><br><ol><li>  Let <i>i</i> = 31; </li><li>  If the key is equal to the key of the current element, write the added value to the array of values ‚Äã‚Äãby the index of the current element and exit. </li><li>  If the key of the current item is greater than the added key, write the added key to the current item, add the value to the array of values, then call the recursively with the previous key and value, and then exit. </li><li>  Take the <i>i-th</i> bit of the key.  If it is 0, make the current element of the first child, otherwise the second child, reduce <i>i</i> by 1. If the descendant is an element with index 0, add a new element, assign it to the previous child, descendants of a new element element with index 0, make the key equal to the key to be added , the bit index is <i>i</i> and write the value.  Otherwise, go to step 2. </li></ol><br>  Receiving: <br>  Here, without formalization, since it is the same as adding, with the only difference that there is no step 3, in the second step we return the value, not write it, and in the absence of the required descendant, the element processes the absence of the requested value, but do not add a new one. <br><br>  During the experiments, it turned out that this structure (and this is pure binary tree), works not much slower than the hash table.  At the same time, there is one feature: if before the formal execution of the algorithm for adding or receiving a ‚Äústep‚Äù into a random element, then there is a chance that it will lead us to the desired element in fewer steps (here the value of the bit index, which was processed during add this item stored in box 4).  Another nice feature was that by successively adding elements, they are stored in indices that correspond exactly to their keys, which reduces the search time to O (1). <br>  Here is the structure turned out.  When I implemented it, the time for passing SunSpider 0.9.1 decreased by 10%.  In my opinion, this is not bad. <br><br>  <b>Rope String (Rope string)</b> <br><br>  On Habr√© already <a href="http://habrahabr.ru/post/144736/">wrote about this</a> , so here I will write only the idea.  When string concatenation occurs in .NET, a new string is created, the value in which is first copied from the first line, then from the second.  On the face of O (n + m).  Rope String is an object that stores references to source objects, not copying their value.  In essence, it is a promise that these two lines, if required, will be one line.  It turns out O (1).  Of course, if we call ToString for each such object, which, in this case, takes O (n + m), we won‚Äôt win, but when they create Rope from Rope and Rope from Rope ... we can combine them in linear time using stringbuilder.  When I added this solution, the time for all the same SunSpider'e decreased by 5 times. <br><br>  <b>Type prediction (Prediction type)</b> <br><br>  This optimization is specific to the dynamic nature of JavaScript.  Again an example: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = a + b;</code> </pre> <br>  Which of the many "+" implementations should be called in the third line?  Well, of course, the addition of numbers is not worth thinking here.  But what is obvious to man is not always clear to the car.  And therefore, when the execution reaches the third row, the virtual machine should think and ‚Äúwalk around‚Äù in the huge comparison table.  <i>Type prediction</i> is an attempt to teach a computer to analyze operations a bit closer to how a person does it.  Therefore, in the third line, the addition operator of numbers will be called, which will only follow, and if we did not make a mistake in the prediction and will call the standard implementation, if this, all the same, has happened.  Now this optimization is still in the process of integration, but already with the replacement of the operators "+", "&lt;", "&gt;", "&lt;=", "&gt; =" the effect is well noticeable. <br>  Separately, I mention once again about concatenation.  Now this effect is overlapped by Rope String, but sometime, replacing <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"abc"</span></span> + <span class="hljs-number"><span class="hljs-number">1234</span></span> + <span class="hljs-number"><span class="hljs-number">567</span></span></code> </pre> <br>  On the multiple line merge operator (with one pass through all elements), I received double acceleration. <br><br>  In conclusion, a little about the project.  The engine has remained interpretive.  There have been attempts to add JIT using System.Linq.Expressions, but for some reason this decision only led to a slowdown, therefore this direction is abandoned. </div><p>Source: <a href="https://habr.com/ru/post/243399/">https://habr.com/ru/post/243399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../24339/index.html">Wifi Outlaw</a></li>
<li><a href="../243391/index.html">Facebook's Osquery Introduction</a></li>
<li><a href="../243393/index.html">Should everyone learn programming?</a></li>
<li><a href="../243395/index.html">Moving from online to offline IDE when programming Nucleo-F401RE</a></li>
<li><a href="../243397/index.html">Well.js is another approach to modular JavaScript development.</a></li>
<li><a href="../2434/index.html">Newspapers are looking for readers on MySpace</a></li>
<li><a href="../243401/index.html">Customize viewing of individual Issue in Atlassian Jira</a></li>
<li><a href="../243403/index.html">A brief synopsis of javascript</a></li>
<li><a href="../243405/index.html">Game hackathon, December 6-7, Moscow</a></li>
<li><a href="../243407/index.html">Odroid-W + W Docking Board LCD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>