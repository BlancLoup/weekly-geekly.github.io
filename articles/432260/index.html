<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Changing global settings on local command servers in the infrastructure using Gitlab CI and Ansible [Concept]</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article describes the possibility / idea / concept of changing global settings on local command servers in a large infrastructure using Gitlab CI...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Changing global settings on local command servers in the infrastructure using Gitlab CI and Ansible [Concept]</h1><div class="post__text post__text-html js-mediator-article"><hr><br><p>  This article describes the possibility / idea / concept of changing global settings on local command servers in a large infrastructure using Gitlab CI and Ansible. </p><br><p>  Suppose you have 20 development teams and 1 admin / DevOps team.  How to change admin passwords on all servers?  How to add Enterprise root certificate to all servers?  Etc. </p><a name="habracut"></a><br><h2 id="kakuyu-zadachu-reshaet">  What problem solves? </h2><br><p>  Typical situation: <br>  There are global administrators / DevOps. <br>  There are global settings (NTP, DNS, Proxy, etc.) <br>  There are local development teams: TeamA, TeamB, TeamC, TeamD, etc. <br>  There are developers who can only go to the servers of their team. <br>  How to add / update global administrators, global settings? </p><br><p><img src="https://habrastorage.org/webt/hh/n6/sa/hhn6sal6fyuse2qaei0nefh9ta4.png"></p><br><p>  The task is complicated by the fact that global settings are stored separately from local settings of commands in private repositories. </p><br><p>  If you have a few servers in the whole company, then you can run Ansible in a simple mode - start updating global administrators, global settings on all servers at once. </p><br><p>  For large installations, companies typically use Puppet, Chef. </p><br><h2 id="koncepciya">  Concept </h2><br><p>  To change global settings on local command servers in a large infrastructure, I propose a mechanism for git submodules. </p><br><p>  In the repository with local settings, git submodules with global settings are used. </p><br><p>  Below is a schematic diagram of connecting a private repository with global settings to local command repositories. </p><br><p><img src="https://habrastorage.org/webt/sr/cd/3c/srcd3cupezpf06nq7tzn4njhlfm.png"></p><br><p>  You can use the concept of updating global settings using git submodule in infrastructure with Puppet, Chef, Salt, but the article gives an example with Ansible. </p><br><p>  For example, install tomcat, mysql, nginx and apply global settings to them in a team called team. </p><br><p>  In gitlab, there is a common group, which contains common settings. </p><br><p>  The common group has a base-bootstrap project that contains administrators, sysctl settings, etc. </p><br><p>  Usually the company has several development departments - more often they are called teams. </p><br><p>  In gitlab we create a team group (you will have your own team name). </p><br><p>  In the team group we create projects: application, database, loadbalancer. </p><br><p>  Screenshot from base-bootstrap, application, database, loadbalancer: </p><br><p><img src="https://habrastorage.org/webt/ty/1v/q9/ty1vq9atrxvq9h6ifjrkw1jdgge.png"></p><br><p>  The base-bootstrap repository is enabled as a git submodule in the application, database, loadbalancer repository. </p><br><p>  At each commit in the application, database repository, loadbalancer starts the update of the base-bootstrap submodule. </p><br><p>  After that, ansible-playbook from base-bootstrap and ansible-playbook from base-bootstrap are applied to the application, database, loadbalancer servers. </p><br><p><img src="https://habrastorage.org/webt/np/ym/0j/npym0jnwchybipoarkbbejqztgo.png"></p><br><p>  That is, if you add a new administrator to the base-bootstrap or change the system settings in the base-bootstrap, then with the application, database, loadbalancer commit, the new settings from the base-bootstrap will be applied in application, database, loadbalancer. </p><br><h2 id="podgotovka">  Training </h2><br><p>  It is necessary to read the articles about Ansible for beginners: </p><br><p>  <a href="https://habr.com/post/304732/"># Ansible where to start</a> </p><br><p>  <a href="https://habr.com/post/305400/"># Ansible Handbook</a> </p><br><p>  You should have gitlab and gitlab-runner deployed with the docker installed. </p><br><p>  The docker executor is used here as an example - you can use the Shell executor. </p><br><p>  How to deploy gitlab and gitlab-runner: </p><br><p>  <a href="https://habr.com/company/southbridge/blog/306596/"># Article about Gitlab-CI from Southbridge</a> </p><br><p>  <a href="https://habr.com/post/344324/"># Continuous integration and deployment of Docker in GitLab CI</a> </p><br><p>  You must have 3 servers (for example, on ubuntu): application, database, loadbalancer. </p><br><p>  Application, database, loadbalancer are common names. </p><br><p>  All examples can be expanded, improved, use other software - the article shows a general principle. </p><br><h3 id="kak-realizovat">  How to implement </h3><br><p>  The repository and all the code for the test can be taken from here: <a href="https://github.com/patsevanton/ansible-gitlab-habr">https://github.com/patsevanton/ansible-gitlab-habr</a> </p><br><p>  If you go to the server by login / password, then in the right group (in this case it‚Äôs a team), create the userpassword variable (when you change, you must also change the variable in the code) and specify the password there (the password is used in the code) </p><br><p>  Do not forget to create on the target servers the user you need with sudo rights (the code uses the user user). </p><br><p>  For those who go to the server via SSH keys, you need to create in the team group a variable SSH_PRIVATE_KEY and add a private user key to it that will connect to the server. </p><br><p>  Here is a simple example of connecting to servers, so the security issues in the article are not considered. </p><br><p>  In each repository (application, database, loadbalancer) create a git submodule: </p><br><pre><code class="plaintext hljs">git submodule add git@gitlab.example.com:common/base-bootstrap.git git submodule add git@gitlab.example.com:team/team-users.git</code> </pre> <br><p>  Submodule is needed to access the shared private repository. </p><br><p>  In our case, this is a repository with common base-bootstrap settings and a repository of team-users team users. </p><br><p>  Where gitlab.example.com is your gitlab server. </p><br><p>  Then in .gitmodules we change the path to the repository to relative </p><br><p>  Example: </p><br><pre> <code class="plaintext hljs">[submodule "team-users"] path = team-users url = ../team-users.git [submodule "base-bootstrap"] path = base-bootstrap url = ../../common/base-bootstrap.git</code> </pre> <br><p>  In each repository in hosts, we change the IP for ours, in ansible.cfg, we change the remote_user for our user. </p><br><p>  If you have no commits in the last few hours / days of the repository, and you need to roll out new general changes to the server (for example, you need to add a new admin) - for such situations there is a ansible-pull. </p><br><p>  Configure the ansible-pull to download the common / base-bootstrap repository. </p><br><p>  To do this, add the deploy to deploy repository. </p><br><p>  Go to the common / base-bootstrap repository then go to settings / repository / Deploy Tokens. </p><br><p>  Create a token.  The resulting username and password are written to base-bootstrap / vars / cron.yml. </p><br><p>  After checking that everything works correctly - I think it is worth changing the start time of the ansible-pull from "every 2 minutes" to the one that suits you. </p><br><p>  If ansible-pull is dropped, it means that the CI of this service will drop, which starts at every commit to this service repository (let's say the service is called application) </p><br><h2 id="proverka">  Check </h2><br><h3 id="sozdanie-novogo-administratora">  Creating a new administrator. </h3><br><p>  Try adding a new admin to <a href="">https://github.com/patsevanton/ansible-gitlab-habr/blob/master/commons/base-bootstrap/vars/users.yml</a> </p><br><h3 id="izmenenie-sysctl">  Change sysctl </h3><br><p>  Try adding / changing sysctl settings at <a href="">https://github.com/patsevanton/ansible-gitlab-habr/blob/master/commons/base-bootstrap/vars/sysctl.yml</a> </p><br><h3 id="dobavlenie-zapisey-v-cron">  Add entries to cron </h3><br><p>  Try adding cron entries to <a href="">https://github.com/patsevanton/ansible-gitlab-habr/blob/master/commons/base-bootstrap/vars/cron.yml</a> </p><br><h2 id="rasshirenie-ili-ustanovka-vashih-prilozheniy">  Expansion or installation of your applications </h2><br><p>  First you need to find the role to install your applications. </p><br><p>  Go to <a href="https://galaxy.ansible.com/">https://galaxy.ansible.com/</a> and find the role to install your application. </p><br><p>  Try installing your application using the role from the console to your servers.  Usually in the descriptions of all the roles there is an instruction. </p><br><p>  For example, try installing java next to tomcat.  First install the geerlingguy.java role </p><br><pre> <code class="plaintext hljs">ansible-galaxy install geerlingguy.java</code> </pre> <br><p>  Create standard ansible.cfg same as repositories. </p><br><p>  Create inventory: </p><br><pre> <code class="plaintext hljs">[java] java ansible_host=IP-</code> </pre> <br><p>  Create a playbook java.yml </p><br><pre> <code class="plaintext hljs">- hosts: java become: yes vars_files: - vars/main.yml roles: - { role: geerlingguy.java }</code> </pre> <br><p>  Run ansible-playbook java.yml </p><br><p>  If everything went successfully we add to the desired project (in this case, application) </p><br><p>  The role of geerlingguy.java is added in after the role of robertdebock.tomcat <a href="">https://github.com/patsevanton/ansible-gitlab-habr/blob/master/team/application/tomcat-app.yml#L11</a> </p><br><p>  The same with all other applications that you need to install on the server. </p><br><h2 id="testirovanie-playbook-i-bezopasnost">  Playbook Testing and Security </h2><br><p>  To simplify the article, the issue of storing passwords and testing is not affected. </p><br><p>  There are articles on testing the playbook: <br>  <a href="https://habr.com/company/southbridge/blog/303762/"># Ansible: testing playbooks (part 1)</a> </p><br><p>  <a href="https://habr.com/post/351974/"># Testing and continuous integration for Ansible roles with Molecule and Jenkins</a> </p><br><h2 id="otvety-na-voprosy">  Answers on questions </h2><br><p>  1) Mentat: And why is it still not like it is written in the ansible dock, with environments?  From the first reading it looks like an attempt to reinvent it all over again.  There, it is quite convenient to use all this types of ansible-playbook -i env / teamA personalAPlaybook.yml <br>  Answer: This scheme allows you to change global settings.  What is described in the question is changing the local settings of the commands. </p><br><p>  PS Perhaps the same functionality is implemented in Ansible Tower.  But I can‚Äôt say anything about this - I didn‚Äôt work with Ansible Tower. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/432260/">https://habr.com/ru/post/432260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432248/index.html">Parsing by layout (sass, pug, gulp, bem)</a></li>
<li><a href="../432250/index.html">Rust news # 3 (November 2018)</a></li>
<li><a href="../432252/index.html">How to earn more in the IT sector in Russia?</a></li>
<li><a href="../432256/index.html">Autumn aggravation: how RTM hackers staged a massive attack on banks and businesses on behalf of state institutions</a></li>
<li><a href="../432258/index.html">U-NOVUS 2018: workshop</a></li>
<li><a href="../432262/index.html">We make our USB sound card with galvanic isolation</a></li>
<li><a href="../432264/index.html">GitLab 11.5 released with control panels for operators and security professionals and access control GitLab Pages</a></li>
<li><a href="../432268/index.html">How to turn a client into data: we change video surveillance and video analytics for retail</a></li>
<li><a href="../432270/index.html">HappySecretSantaBot - Telegram bot for the game "Secret Santa"</a></li>
<li><a href="../432272/index.html">How we prepare stores for the new year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>