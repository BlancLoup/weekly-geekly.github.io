<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart wifi light switch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear reader. 

 Some lyrics in the beginning. The idea of ‚Äã‚Äãa "smart" light switch is not new at all and, probably, this is the first thing ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart wifi light switch</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8cf/a56/9c8/8cfa569c88ff458c8c84c600a6b3c67a.jpg"><br><br>  Good day, dear reader. <br><br>  Some lyrics in the beginning.  The idea of ‚Äã‚Äãa "smart" light switch is not new at all and, probably, this is the first thing that comes to mind for those who began to get acquainted with the Arduino platform and IoT elements.  And I am not an exception.  After experimenting with the elements of the chains, motors and LEDs, I want to do something more applied, which is in demand in everyday life and, most importantly, it will be convenient to use, and will not remain a victim of the experiment in disagreement to comfort. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I will tell you how I made a switch that will work as usual (that is, which is usually fixed on the wall) and at the same time allow you to control it via WiFi (or via the Internet, as it is done in this case). <a name="habracut"></a><br><br>  So, we will make a list of what is needed for the implementation of our plans.  I will say straight away that I intended not to spend much money on components and selected components based on the feedback on the forums and the price-to-quality ratio.  Therefore, some components may seem out of place here for experienced electric drivers, but please do not judge strictly, because  I'm just a newcomer to electrical engineering and I would really appreciate comments from more experienced specialists. <br><table><tbody><tr><th>  No </th><th>  Name </th><th>  Description </th><th>  Price </th></tr><tr><td>  one </td><td>  <a href="http://www.hlktech.net/product_detail.php%3FProId%3D54">HLK-PM01</a> </td><td>  Adapter 220VAC to 5VDC </td><td>  4,02 ‚Ç¨ </td></tr><tr><td>  2 </td><td>  <a href="http://www.fotek.com.hk/solid/SSR-1.htm">SSR-40DA</a> </td><td>  Solid state relay to control the current in the circuit </td><td>  3,35 ‚Ç¨ </td></tr><tr><td>  3 </td><td>  <a href="http://www.advanced-monolithic.com/pdf/ds1117.pdf">AMS1117-3.3</a> </td><td>  Voltage reducer from 5V to 3V </td><td>  1,29 ‚Ç¨ </td></tr><tr><td>  four </td><td>  <a href="http://www.esp8266.com/wiki/doku.php%3Fid%3Desp8266-module-family">ESP8266-01</a> </td><td>  Wifi microcontroller </td><td>  2,35 ‚Ç¨ </td></tr><tr><td colspan="3" align="right">  <b>Total:</b> </td><td>  11,01 ‚Ç¨ </td></tr></tbody></table><br>  I also needed: the server with which the switch will be controlled via the Internet, Arduino Uno, with which I programmed ESP, the router and consumables like wires, terminals, etc., all this can vary from taste and will not affect on the end result. <br><br>  Prices are taken from Ebay, where I bought them. <br><br>  Here are the elements from the table: <br><br><img src="https://habrastorage.org/files/1ef/70b/dc9/1ef70bdc91704739b496786442c19517.jpg"><br><br>  Now you can make and wiring diagram: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/eb8/740/8f0/eb87408f0f4743d986dbe39f4abe02b3.png"></div><br><br>  As you probably noticed, the scheme is very simple.  Everything is assembled easily, quickly and without soldering.  A kind of working prototype, which does not need to mess around for a long time.  Everything is connected by wires and terminals.  The only negative is that the relay does not fit into the switch socket.  Yes, initially I planned to shove it all into the wall behind the switch to look aesthetically pleasing.  But to my regret, there was little space in the nest and the relay simply did not fit either along or across: <br><br><img src="https://habrastorage.org/files/ce9/090/c6f/ce9090c6ff18427486c49ce2f48570e6.jpg"><br><br>  Therefore, temporarily I took the relay to the socket, until I found a suitable switch box with a socket to hide the iron inside.  But there is nothing more permanent than temporary, is there no?  Therefore, it all looks like this now: <br><br><img src="https://habrastorage.org/files/69c/45e/792/69c45e79281a4ce8a02bd6cf17ece631.jpg"><br><br>  Insulating tape will save from electric shock ... I hope. <br><br>  Now let's talk about the software part. <br><br>  And before proceeding to the analysis of the code and details, I will give the general scheme of the implementation of the control light bulb. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9b7/7cc/efe/9b77ccefe7c84f339fd25435ba3c74f0.png"></div><br><br>  I hope that someday I will rewrite everything and the connection will be based on a faster protocol than HTTP, but for the beginning it will come down.  Remotely the light bulb changes its state in approximately 1-1.5 seconds, and from the switch instantly, as befits a decent switch. <br><br><h2>  Programming ESP8266-01 </h2><br>  The easiest way to do this is with the Arduino.  You can download the necessary libraries for Arduino IDE from <a href="https://github.com/esp8266/Arduino">GitHub</a> .  There are all the instructions for installation and configuration. <br><br>  Next, we need to connect the ESP to the computer, for this we need either a USB to Serial Adapter (such as <a href="https://google.com/search%3Fq%3DFTDI%2BUSB%2BSerial%2B3.3V">FTDi</a> , <a href="https://google.com/search%3Fq%3DCH340%2BUSB%2BSerial%2B3.3V">CH340</a> , <a href="https://google.com/search%3Fq%3DFT232RL%2BUSB%2BSerial%2B3.3V">FT232RL</a> ) or any Arduino platform (I had an Arduino Uno) with RX and TX outputs. <br><br>  It is worth noting that ESP8266-01 is powered by 3.3 Volts, which means that in no case do not connect it to the Arduino's power supply, which (often) is powered by 5 Volts, directly, otherwise everything will burn to hell.  You can use the voltage reducer, which is shown in the table above. <br><br>  The connection scheme is simple: we connect the <abbr title="Transmitter">TX</abbr> , <abbr title="Receiver">RX</abbr> and <abbr title="Ground">GND</abbr> ESP to the RX, TX and GND adapter / Arduino, respectively.  After that, in fact, the connection is ready for use.  The microcontroller can be programmed using the Arduino IDE. <br><br>  <b>A couple of nuances when using Arduino Uno:</b> <br><ul><li>  On Uno there is an output for 3.3V, but it was not enough.  When ESP is connected to it, everything seems to be working, the indicators are lit, but the connection with the COM port is lost.  So I used another 3.3V power supply for ESP. </li><li>  In addition, UNO had no problems communicating with ESP, given that UNO was powered by 5V, and ESP by 3B. </li></ul><br>  After several experiments with ESP8266-01, it turned out that ESPs are sensitive to voltages connected to GPIO0 and GPIO2.  At the moment of launch, they should not be grounded in any way, if you intend to start it in normal mode.  More details about the start of the microcontroller <a href="https://github.com/esp8266/esp8266-wiki/wiki/Boot-Process">here</a> .  I did not know this and I had to slightly change the scheme, since  In the ESP-01 version, only these 2 pins are present and both are used in my scheme. <br><br>  Here is the ESP program itself: <br><br><div class="spoiler">  <b class="spoiler_title">Show code</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WiFi.h&gt; #include &lt;WiFiClient.h&gt; #include &lt;ESP8266WebServer.h&gt; #include &lt;ESP8266mDNS.h&gt; #include &lt;ESP8266HTTPClient.h&gt; extern "C" { //         initVariant #include "user_interface.h" } const char* ssid = "WIFISSID"; //  WiFi const char* password = "***************"; //  WiFi const String self_token = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; //      const String serv_token = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; //      const String name = "IOT_lamp"; //  ,   const String serverIP = "192.168.1.111"; //  IP WEB  bool lamp_on = false; bool can_toggle = false; int button_state; ESP8266WebServer server(80); //   HTTPClient http; //   const int lamp = 2; //    GPIO2 const int button = 0; // ""   GPIO0 //     void handleRoot() { server.send(200, "text/plain", "Hello! I am " + name); } //     void handleNotFound(){ String message = "not found"; server.send(404, "text/plain", message); } //    void turnOnLamp(){ digitalWrite(lamp, LOW); lamp_on = true; } //    void turnOffLamp(){ digitalWrite(lamp, HIGH); lamp_on = false; } //     ./. void sendServer(bool state){ http.begin("http://"+serverIP+"/iapi/setstate"); String post = "token="+self_token+"&amp;state="+(state?"on":"off"); //          http.addHeader("Content-Type", "application/x-www-form-urlencoded"); int httpCode = http.POST(post); http.end(); } //    void toggleLamp(){ if(lamp_on == true) { turnOffLamp(); sendServer(false); } else { turnOnLamp(); sendServer(true); } } //      void handleOn(){ String token = server.arg("token"); if(serv_token != token) { String message = "access denied"; server.send(401, "text/plain", message); return; } turnOnLamp(); String message = "success"; server.send(200, "text/plain", message); } //      void handleOff(){ String token = server.arg("token"); if(serv_token != token) { String message = "access denied"; server.send(401, "text/plain", message); return; } turnOffLamp(); String message = "success"; server.send(200, "text/plain", message); } //  MAC    IP void initVariant() { uint8_t mac[6] = {0x00, 0xA3, 0xA0, 0x1C, 0x8C, 0x45}; wifi_set_macaddr(STATION_IF, &amp;mac[0]); } void setup(void){ pinMode(lamp, OUTPUT); pinMode(button, INPUT_PULLUP); //   INPUT_PULLUP turnOffLamp(); WiFi.hostname(name); WiFi.begin(ssid, password); //     WiFi while (WiFi.status() != WL_CONNECTED) { delay(500); } //     server.on("/", handleRoot); server.on("/on", HTTP_POST, handleOn); server.on("/off", HTTP_POST, handleOff); server.onNotFound(handleNotFound); //   server.begin(); } void loop(void){ server.handleClient(); //    button_state = digitalRead(button); if (button_state == HIGH &amp;&amp; can_toggle) { toggleLamp(); can_toggle = false; delay(500); } else if(button_state == LOW){ can_toggle = true; } }</span></span></span></span></code> </pre> <br></div></div><br>  <b>A couple of comments on the code:</b> <br><ul><li>  It is very important to declare a pin GPIO0 as pinMode (button, <b>INPUT_PULLUP</b> ), since  in the circuit, we do not use a resistor for this button.  And ESP has its own ‚Äústitched‚Äù for these very purposes. </li><li>  When catching the state of the button, it is desirable to set a delay when reading to avoid false triggering at the moment of pressing. </li></ul><br><h2>  WEB server programming </h2><br>  Here you can give free rein to your imagination and use any means available to create a service that will process requests sent by the switch and send on / off requests. <br><br>  I used <a href="http://www.yiiframework.com/">Yii</a> for this purpose.  I chose this framework for several reasons, I needed autorization (since the portal is available on the Internet) and role management (for future experiments), and I also just like it.  And now my management portal looks like this: <br><br><img src="https://habrastorage.org/files/119/cb0/e72/119cb0e72f4845f8a6cac74fc856787a.png"><br><br>  To control the light bulb in the network reach zone, the server itself would be enough for ESP.  But you want to have logs, logic and other devices in the future, so it‚Äôs still better to use a separate server for management. <br><br>  This is all about the portal, I think it makes no sense to write more about it, but if you have questions, I‚Äôll be happy to answer them in the comments. <br><br><h2>  Instead of conclusion </h2><br>  Thank you if you have read the article to the end and may have found something useful in it.  I will be glad to advice and criticism.  In general, it still seems to me that the bottleneck in the circuit is the 5V Adapter and I will be glad if you share your experience in solving such problems.  As for the ESP8266-01, so far it has not caused me any complaints except for the special use of GPIO pins.  It works stably for the second week.  Successes in projects. </div><p>Source: <a href="https://habr.com/ru/post/393497/">https://habr.com/ru/post/393497/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../393485/index.html">LED DIY flashlight at 100,000 lumens with water cooling</a></li>
<li><a href="../393487/index.html">Turbo Dryer: The Easy Way to Quickly Dry Drenched Shoes, Socks, or Clothes</a></li>
<li><a href="../393491/index.html">Magnificent Seven Novelty Gyro Scooters Available</a></li>
<li><a href="../393493/index.html">Return of Eric - the first UK speaking robot</a></li>
<li><a href="../393495/index.html">The man is in prison because he could not decrypt the contents of the HDD</a></li>
<li><a href="../393499/index.html">American student died from electric shock, repeating a physical experiment with YouTube</a></li>
<li><a href="../393501/index.html">Intelligence agencies began to intercept SMS-codes Telegram authorization</a></li>
<li><a href="../393505/index.html">Xiaomi mi Band2 "accidentally" lit up on the hand of the CEO</a></li>
<li><a href="../393507/index.html">Project "Eye" Part 21</a></li>
<li><a href="../393511/index.html">Ministry of Internal Affairs ordered infrasound system to influence violators of law and order</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>