<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bot for Telegram for 48 hours on Perl or how to buy cat food without leaving the chat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Looking for a long time in the direction of the bots theme for Telegram and Facebook, everything did not take the time to look at what these animals a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bot for Telegram for 48 hours on Perl or how to buy cat food without leaving the chat</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/d5e/ea6/caf/d5eea6caf9cc423093b37146b2b88c78.jpg"><br><br>  Looking for a long time in the direction of the bots theme for Telegram and Facebook, everything did not take the time to look at what these animals are.  And most importantly - there was no intelligible idea why such a bot might be needed in real life, given that neither Tg nor Fb Messanger in my life I actively use. <br><br>  And quite by chance there was an opportunity to immerse a little in this area and solve an applied task quite to myself.  For example, buy cat food without leaving the chat) <br><a name="habracut"></a><br>  On a quiet Saturday morning I accidentally stumbled upon a note that <a href="http://www.akit.ru/olimpiada/">an</a> international (!) Online Olympiad (!!) in the Perl language (!!!) is being held.  Despite the surrealism of the event (about which there were no announcements on any specialized resource including Habr), I signed up and got the task at 10.15am on Monday - to develop a bot for one of the instant messengers that interacts with any online store within 48 hours.  Deciding that this is a great chance to immerse yourself in the topic, I took up the task. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The choice of online store was simple - in <a href="http://ulmart.ru/">Yulmart</a> I buy even cat food.  Yes, and find out the current price for some piece of iron without putting the application on the phone is sometimes necessary. <br><br>  The assignment was received on Monday morning and nobody canceled the work affairs, so the main part of the development went on in the evening and at night. <br><br><h4>  First night </h4><br>  The first night was devoted to writing a parser for mobile issuing of an online store and implementing all the necessary operations with a basket and placing an order (pickup, without registration).  Yulmart is represented in different cities and to complete the picture it was necessary to realize the choice of the current city and the pick-up point.  Since the perverted parsers are my specialty, there were no special difficulties with this.  The only ambush was that I had to spend a couple of hours understanding why an error occurred during the final checkout.  It turned out that I too quickly demanded a response from the online store and he does not have time to carry out the order on his internal accounting system.  The five-second delay solved the problem and by morning the module implementing the API with the Ulmart site was ready. <br><br>  Pseudo-API can: <br><br><ul><li>  Get a list of directory partitions </li><li>  Search by catalog </li><li>  Get a list of catalog items or search results </li><li>  Receive information about a product with all its characteristics </li><li>  Choose a current city (prices, availability and selection of a pickup point depend on it) </li><li>  Manage the basket </li><li>  Place an order for pickup from the selected item </li></ul><br>  I did not manage to implement filters in the catalog due to time constraints.  But the basic functionality is there and you can try to transfer it to the Telegram bot platform, about which at this point I only knew that it exists) <br><br>  Spoiler: now you can buy cat food directly from the Telegram <br><br><img src="https://habrastorage.org/web/b14/462/4ca/b144624ca58a42ab939e83d3d18d4aaf.jpg"><br><br><h4>  Second night </h4><br>  Now it's time to get acquainted with the bot capabilities of the Telegram API.  Since before that time I did not use Telegram, it was an accelerated immersion in the topic)) I will not paint the details - there are enough articles on this topic.  I will note only those features that I noticed in the context of solving my problem.  As it turned out, creating a more or less convenient interface for the chat bot of an online store is another task ... <br><br><ol><li>  It was a pity to install a web server, an SSL certificate and study the event-based model of time, so a slow but acceptable for the prototype option was chosen with a long pool of bot requests and single-stream (forgive) their processing <br><br></li><li>  The platform decides for me all the questions regarding user sessions - great.  The initial idea with the implementation of the state machine for storing intermediate information between requests was dropped after some time, since it was easier to pass parameters to the interface elements.  Ugly, but quickly. <br><br></li><li>  For some reason I blunted and did not immediately realize that within the framework of processing a single request, you can form several answers.  Therefore, the bot is silent after receiving the request, but does not warn what he thinks (everywhere except handling the search) <br><br><img src="https://habrastorage.org/web/990/f19/c7b/990f19c7ba1544d5b0677be9141b99ad.jpg"><br><br></li><li>  The telegram does not know how to arrange the control buttons in the messages optimally.  It is necessary to form the grid of buttons yourself, and if there are a lot of them (and it is not clear how many will be), then this is an additional difficulty.  In addition, they can be made a limited number (which is correct), but ... <br><br></li><li>  ... since besides these buttons and textual input of options for interacting with the bot, this does not complicate the implementation of the selection of goods from the list and pagination. <br><br><img src="https://habrastorage.org/web/378/7fb/da0/3787fbda0669450fb7d014fa917aa2d0.jpg"><br><br>  And when I programmed the list, I still did not understand that it was possible to give several answers (see clause 3), otherwise I could have done it differently - under each position of the list there is my own button ‚Äúmore‚Äù.  Not the fact that it would be better, but suddenly. <br><br></li><li>  There is a lack of opportunities to form answers with columns.  This would greatly simplify the work with long selection lists.  For example, selecting the current city in the bot looks like a list of active buttons: <br><br><img src="https://habrastorage.org/web/492/84b/cdd/49284bcdd4b34cb9b654eff82741adc8.jpg"><br>  Or a list of products - it would be optimal to display it in three columns, for example: a picture, a name, a ‚ÄúDetails‚Äù button, but no. <br></li></ol><br>  And so, in general, a simple and pleasant API of the platform allowed to create a chat bot for the night that can do everything that was previously implemented in the pseudo-API. <br><br>  Including cart management: <br><br><img src="https://habrastorage.org/web/572/31d/189/57231d18949c4fc38954374d211a067b.jpg"><br><br>  Choosing a pickup point: <br><br><img src="https://habrastorage.org/web/cb5/fa3/b7a/cb5fa3b7a06547e887554784f5632d79.jpg"><br><br>  And final order: <br><br><img src="https://habrastorage.org/web/da2/c22/9a4/da2c229a47254cd4bcf31a1d818a3319.jpg"><br><br>  By morning, the bot was finished and running on a test server! <br><br><div class="spoiler">  <b class="spoiler_title">Where can I touch it</b> <div class="spoiler_text">  The bot is called <a href="https://telegram.me/ecom_ulmart_bot">@ecom_ulmart_bot</a> and still works on a test bench, accepting and processing requests in the long pool mode in one (!!!) stream. <br><br>  Therefore, if you torture him - have patience)) <br></div></div><br>  Since this is more likely a prototype chatbot, then it has much to develop: <br><br><ul><li>  Make multithreaded request processing through WebHooks </li><li>  Poshamanit interface </li><li>  Make it possible to embed in other chat rooms as an inline bot (if you suddenly need to know if top mining graphics cards are on sale) </li><li>  As a development of functionality, you can add a comparison of prices for selected products with offers from other online stores. </li></ul><br>  And if someone <a href="https://github.com/roman-lugovkin/ecom-ulmart-bot">gets</a> their hands on it, then you can do this by taking the source <a href="https://github.com/roman-lugovkin/ecom-ulmart-bot">from github</a> and registering your bot (another api-token) for this task. <br><br><div class="spoiler">  <b class="spoiler_title">And what about the international competition?</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/10f/9a1/a5d/10f9a1a5d81e4e169cf84fa0a8807b0e.jpg"><br><br>  And nothing) <br><br>  I never received a response to my decision.  Recalling about myself a week later I received an answer that ‚Äúthe results will be about to be summed up,‚Äù and then silence. <br><br>  I think the only one who accidentally saw this ad and sent some solution.  So, Larry Wall‚Äôs comment on my own crooked code I never received)) <br></div></div><br>  It was a fun experience and the next target platform is Facebook Messenger.  The idea for a new chat bot is already there! </div><p>Source: <a href="https://habr.com/ru/post/333586/">https://habr.com/ru/post/333586/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333576/index.html">Blockchain: a revolution for which we are not ready</a></li>
<li><a href="../333578/index.html">When the trees were big: how a small data center experienced a hurricane</a></li>
<li><a href="../333580/index.html">npm link on steroids</a></li>
<li><a href="../333582/index.html">Search InterSystems documentation using iKnow and iFind technologies</a></li>
<li><a href="../333584/index.html">A collection of developer tools</a></li>
<li><a href="../333588/index.html">Debugging the Android application using a browser</a></li>
<li><a href="../333590/index.html">Configuring the Apache CloudStack Failover Management Server using MariaDB Galera Replication</a></li>
<li><a href="../333592/index.html">Application of the principle of poka-yoke in programming using the example of PHP</a></li>
<li><a href="../333594/index.html">The system of rewinding time in the style of Prince of Persia</a></li>
<li><a href="../333596/index.html">I am the cause of the emergence of the Hungarian notation in Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>