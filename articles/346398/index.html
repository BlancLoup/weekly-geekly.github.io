<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How it works: Merkle trees in the bitcoin network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nodes in the blockchain network are anonymous and operate in the absence of trust. In this situation, the problem of data verification arises: how to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How it works: Merkle trees in the bitcoin network</h1><div class="post__text post__text-html js-mediator-article">  Nodes in the blockchain network are anonymous and operate in the absence of trust.  In this situation, the problem of data verification arises: how to verify that the correct transactions are recorded in the block?  It will take a lot of time and computing resources to evaluate each unit.  To solve the problem and simplify the process <a href="https://brilliant.org/wiki/merkle-tree/">help</a> trees Mercle. <br><br>  What it is, how it is used, what alternatives exist - we will tell further <br><br> <a href="https://habrahabr.ru/company/bitfury/blog/346398/"><img src="https://habrastorage.org/webt/bg/98/kt/bg98ktg4fxia1walmk4td40quca.jpeg"></a> <a name="habracut"></a><br>  <font color="#A9A9A9"><i>/ image <a href="https://www.flickr.com/photos/allisonharger/5648103467/">Allison Harger</a> <a href="https://creativecommons.org/licenses/by-nd/2.0/">CC</a></i></font> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  The Merkle Tree - What It Looks Like </h2><br>  Blocks in a bitcoin blockchain are permanently written files that <a href="https://ru.bitcoinwiki.org/wiki/%25D0%2591%25D0%25BB%25D0%25BE%25D0%25BA">contain</a> information about transactions performed by users.  Additionally, each block <a href="https://bitcoin.org/en/developer-guide">contains a</a> Generation Transaction (or <a href="https://bitcoin.org/en/glossary/coinbase-transaction">Coinbase Transaction</a> ) - this is a transaction with address information with a reward for solving a block, which is always first on the list. <br><br>  All transactions in the block are <a href="https://bitcoin.org/en/developer-guide">represented</a> as strings in hexadecimal format (raw transaction format), which is hashed to obtain transaction identifiers (txid).  On their basis, a hash of the block is built, which is taken into account by the subsequent block, <a href="https://habrahabr.ru/company/bitfury/blog/327272/">ensuring the</a> immutability and coherence of the registry.  The unit hash value is collected using the Merkle tree, the concept of which was <a href="https://patents.stackexchange.com/questions/17901/validity-of-patent-on-merkle-trees">patented</a> by Ralph Charles Merkle in 1979. <br><br>  <a href="https://en.wikipedia.org/wiki/Merkle_tree">A Merkle tree</a> , or hash tree, is a binary tree whose leaf nodes are transaction hashes, and internal vertices are the results of the addition of the values ‚Äã‚Äãof the associated vertices.  Here is an example of a hash tree with three leaf transactions: <br><br><img src="https://habrastorage.org/webt/pp/x8/to/ppx8tozza6jmlqlvcbddjf8zcda.png"><br>  <font color="#A9A9A9"><i>/ image <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE_%25D1%2585%25D0%25B5%25D1%2588%25D0%25B5%25D0%25B9">MrTsepa</a> <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC</a></i></font> <br><br>  The construction of the tree <a href="https://habrahabr.ru/company/bitfury/blog/327272/">is</a> as follows: <br><br><ol><li>  The hashes of transactions placed in the block are calculated: hash (L1), hash (L2), hash (L3), and so on. </li><li>  Hashes are calculated from the sum of transaction hashes, for example hash (hash (L1) + hash (L2)).  Since the Merkle tree is binary, the number of elements at each iteration must be even.  Therefore, if a block contains an odd number of transactions, then the latter is duplicated and added to itself: hash (hash (L3) + hash (L3)). </li><li>  Further, hashes are calculated from the sum of hashes again.  The process is repeated until a single hash is obtained - the root of the Merkle tree (merkle root).  It <a href="https://bitcoin.stackexchange.com/questions/1110/how-do-i-implement-a-merkle-tree">is a</a> cryptographic proof of the integrity of the block (that is, that all transactions are in the stated order).  The root value is fixed in the block header. </li></ol><br>  In the bitcoin blockchain, Mercle trees are constructed <a href="https://en.bitcoin.it/wiki/Protocol_documentation">using</a> SHA-256 double hashing.  Here is an example of hashing the string hello: <br><br>  <b>First round SHA-256:</b> <br>  2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824 <br><br>  <b>Round two:</b> <br>  9595c9df90075148eb06860365df33584b75bff782a510c6cd4883a419833d50 <br><br>  And here is an example of the <a href="https://habrahabr.ru/company/bitfury/blog/327272/">implementation</a> of the Merkle trees used by Bitcoin in Python (you can find the results of the function in the repository on GitHub by the <a href="https://gist.github.com/anonymous/7eb080a67398f648c1709e41890f8c44">link</a> ): <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> hashlib <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merkle_root</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lst)</span></span></span><span class="hljs-function">:</span></span> sha256d = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: hashlib.sha256(hashlib.sha256(x).digest()).digest() hash_pair = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x, y: sha256d(x[::<span class="hljs-number"><span class="hljs-number">-1</span></span>] + y[::<span class="hljs-number"><span class="hljs-number">-1</span></span>])[::<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(lst) == <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lst[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(lst) % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span>: lst.append(lst[<span class="hljs-number"><span class="hljs-number">-1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> merkle_root([ hash_pair(x, y) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x, y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zip(*[iter(lst)] * <span class="hljs-number"><span class="hljs-number">2</span></span>) ])</code> </pre> <br><h2>  What are the hash trees for </h2><br>  File systems use Merkle trees to check information for errors, and distributed databases use data synchronization.  In blockchains, hash trees allow <a href="https://bitcoin.org/en/developer-guide">for a</a> simplified payment verification (SPV). <br><br>  SPV clients, called light (because they store only block headers, not their contents), do not recalculate all the hashes to <a href="https://bitcoin.stackexchange.com/questions/48928/why-does-each-block-store-a-merkle-root">verify</a> the transaction information, but <a href="https://bitcoin.org/en/developer-guide">ask</a> for Merkle‚Äôs proof.  It <a href="https://impgun.wordpress.com/2015/11/22/merkling-in-ethereum/">consists</a> of a root and a branch, including hashes from the requested transaction to the root, since the client does not need information about other operations.  By adding the requested hashes and comparing them with the root, the client makes sure that the transaction is in its place. <br><br>  This approach allows you to work with arbitrarily large amounts of data, since it significantly reduces the load on the network, since only the necessary hashes are downloaded.  For example, the weight of a block with five maximum size transactions <a href="https://bitcoin.org/en/developer-guide">is</a> more than 500 kilobytes.  The weight of the proof of Merkle in the same case will not exceed 140 bytes. <br><br><h2>  Analogs of Merkle Trees </h2><br>  Binary trees of Merkle are well suited for verifying the sequence of elements, so they cope with the task of storing the transaction structure.  However, they limit the ability of light clients who do not receive information about the state of the system.  For example, it is not possible to find out how many coins there are at the specified address. <br><br>  To circumvent the constraints, researchers and developers are upgrading existing algorithms and developing new ones.  For example, the Ethereum blockchain platform <a href="https://easythereentropy.wordpress.com/2014/06/04/understanding-the-ethereum-trie/">uses the</a> so-called <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D1%2584%25D0%25B8%25D0%25BA%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE">Merkle prefix tree</a> (Trie).  This is a data structure that stores an associative array with keys. <br><br>  Unlike binary Merkle trees, the key that identifies a particular tree node is ‚Äúdynamic‚Äù.  Its value is determined by the location on the tree and is formed by connecting the characters assigned to the edges of the graph, passing from the root to the specified node. <br><br>  In Ethereum, the block header <a href="https://github.com/ethereum/wiki/wiki/Patricia-Tree">contains</a> three Merkle prefix trees at once: for transactions, information on their execution and status.  This approach allowed easy customers to receive <a href="https://impgun.wordpress.com/2015/11/22/merkling-in-ethereum/">answers</a> from the system to the questions: ‚ÄúIs there a transaction in the specified block?‚Äù, ‚ÄúHow many coins are in the account?‚Äù And ‚ÄúWhat will the system state be after the completion of this transaction?‚Äù. <br><br>  Another alternative to classic Mercle trees is the HashFusion hash value combination method <a href="https://www.labs.hpe.com/techreports/2017/HPE-2017-08.pdf">proposed by</a> Hewlett Packard Labs.  As noted in the company, the new approach allows calculating hash values ‚Äã‚Äãin stages.  The components of the hash are calculated as soon as the data becomes available, and then merged with each other if necessary. <br><br>  HashFusion involves building parts of a hash using a binary merge function.  It is associative and non-commutative, so it can be used to combine hashes at the time of formation.  This allows you to reduce the amount of memory needed to store them. <br><br><img src="https://habrastorage.org/webt/py/cn/hl/pycnhluvluhqgjehzdf0nidolvc.png"><br><br>  The operation of a binary function is constructed as follows: it accepts hash values ‚Äã‚Äã(generated by classical hashing functions) as input and converts them into matrices of integers.  Then the matrices are multiplied, and the result is turned back into a byte array of fixed length. <br><br>  HPE representatives say that HashFusion implements more flexible structures than Merkle trees, which allow you to update existing hashes and selectively delete / insert new values.  The authors hope that in the future the technology will find application in file systems, cloud solutions and distributed registries. <br><br>  There are other algorithms that the IT community is developing to optimize metadata processing and build Merkle trees.  Among them is the <a href="https://brage.bibsys.no/xmlui/bitstream/handle/11250/2451328/17770_FULLTEXT.pdf">iSHAKE</a> solution, the author of which proposes to replace the process of building hash trees with the introduction of a reversible operation.  It will allow to restore / add and delete new values ‚Äã‚Äãfrom the structure.  You can also <a href="https://csrc.nist.gov/csrc/media/events/workshop-on-cybersecurity-in-a-post-quantum-world/documents/papers/session5-hulsing-paper.pdf">note the</a> modified algorithm for digital signature organization eXtended Merkle Signature Scheme (XMSS) and the SPHINCS algorithm. <br><br>  Most of these proposals are at the testing stage and have not yet found wide application - however, some of them are <a href="https://cryptoservices.github.io/quantum/2015/12/08/XMSS-and-SPHINCS.html">predicting a</a> great future in the world of <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2581%25D1%2582%25D0%25BA%25D0%25B2%25D0%25B0%25D0%25BD%25D1%2582%25D0%25BE%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25BA%25D1%2580%25D0%25B8%25D0%25BF%25D1%2582%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%258F">post-quantum cryptography</a> . <br><br><hr><br>  <i>PS On January 25, Bitfury in Kiev will hold a free workshop, during which practical features of development using <a href="https://exonum.com/">Exonum</a> will be disassembled.</i> <i><br><br></i>  <i>Our experts will tell and show how to deploy your own blockchain and how to write a service.</i>  <i>The meeting will be useful to developers on Rust, C ++ and JavaScript, making the first steps in blockchain development, as well as those who have already tried to create blockchain solutions.</i> <i><br><br></i>  <i>You can find out more information about the event and speakers, as well as register for the event <a href="https://bitfury.timepad.ru/event/642089/">here</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/346398/">https://habr.com/ru/post/346398/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346386/index.html">About the peculiarities of using VPN Zaborona on routers for bypassing locks in Ukraine</a></li>
<li><a href="../346388/index.html">Lindenmeyer systems</a></li>
<li><a href="../346390/index.html">We invite speakers at PHDays: tell us how you see the digital state</a></li>
<li><a href="../346394/index.html">How it works: monitoring of power supply of data center Selectel</a></li>
<li><a href="../346396/index.html">We squeeze the maximum out of accounting computer technology. Part 1</a></li>
<li><a href="../346404/index.html">Separation of chats and search in Telegram</a></li>
<li><a href="../346406/index.html">AngularJS + Webpack = lazyLoad</a></li>
<li><a href="../346408/index.html">Attention! S in Ethereum stands for Security. Part 2. EVM features</a></li>
<li><a href="../346410/index.html">Visual Tcl GUI Designer with theme widget support</a></li>
<li><a href="../346412/index.html">Several books for beginner and continuing developer for Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>