<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search for the shortest path in the transport graph (concept) + source</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There was somehow a project with me that was associated with a map of the city. And the idea arose that since there is a map with routes and the corre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search for the shortest path in the transport graph (concept) + source</h1><div class="post__text post__text-html js-mediator-article">  There was somehow a project with me that was associated with a map of the city.  And the idea arose that since there is a map with routes and the corresponding stops of urban transport, then why not make a search for the route from point A to point B on it. <br><br>  Since the hardware where the software was supposed to be placed has an extremely narrow Internet channel, the search would have to be fully carried out locally, that is, without involving the server‚Äôs capacity.  In addition, of course, I wanted to not lose the user's attention and give him the result as soon as possible. <br><br>  For about an hour or two I was sitting and could not think of anything, and then I had the idea that I could consider the route, not as a lot of stops, but as 1 point.  And if I take the routes to a point, then I get a very simple graph. <br>  The idea seemed good, and I liked it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first thing I did was stop the transport routes from sites.  Then he began to count. <br>  This turned out to be not a difficult task; we take every stop of the route and see if there are any stops of any other route in the radius we set.  The radius took 600m (in the latest version 400m) - the estimated distance that a person can walk without pain on foot from one stop to another if a transfer is necessary.  Probably, this distance can be reduced, say, to 200m, since the distance from one stop to another at an intersection does not exceed this distance. <br><br>  So, after all these manipulations, I got a graph, along which you can quickly build a path from one route to another.  Thus, we have a graph that stores information about the transitions from one urban transport route to another, a kind of meta graph. <br><br>  Over several months, the algorithm has been corresponded a couple of times, then I‚Äôll tell you in more detail about the latest implementation. <br><br>  The quality of the video is terrible, but how to do better, I have not found. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/CtacSJYxWjU%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700191,15700253&amp;usg=ALkJrhh7sx4qXAUBhKINff1WlHUe6_US3w" frameborder="0" allowfullscreen=""></iframe><br><br>  The average time spent on the steps: <br><br>  gpt - 0.009s, find the nearest stops to the click point <br>  grt - 0.001s, find the shortest path from the route to the route <br>  apt - 0.0001s, add stops and turning points to our route <br>  all - 0.01c, the total time to perform a search path <br><a name="habracut"></a><br><br><h4>  Data: </h4><br><br>  We have a certain map of the city, with the routes of urban transport marked on it (90 routes) and the coordinates of the corresponding stops belonging to these routes. <br><br>  On the map, the routes look like this: <br><br><img src="https://habrastorage.org/storage2/0e6/327/ffc/0e6327ffc90035c873b8b7dc06ffff1c.png"><br><br><div class="spoiler">  <b class="spoiler_title">A boring description of the structure of the base</b> <div class="spoiler_text">  Data is presented in the following tables: <br><br><pre><code class="sql hljs">route( id, name, color, route_type_id ) //    route_type( id, name ) //   - , , , ,  route_points( id, marker_description_id, route_id, marker_order ) // ,    marker( id, x, y, address ) //  marker_category( id, name ) //     marker_description( id, name, marker_category_id, marker_id )</code> </pre> <br>  In order not to waste time every time you search for a route, it‚Äôs time to calculate the distance between stops (as part of route 1) and write it in the appropriate table. <br>  Get the distance table: <br><br><pre> <code class="sql hljs"> route_distance( route_id, //  roite_point_from_id, //    roite_point_to_id, //     distance //        )</code> </pre><br>  Next, we will construct a meta-graph of transitions, that is, we will find those stops of the route, within whose radius there are stops from other routes.  As already noted, I chose a radius of 400 meters. <br>  The result of processing is written in the table: <br><br><pre> <code class="sql hljs"> route_cross_points( route_from_id, //    route_to_id, //    route_point_from_id, //    route_point_to_id, //    distance //   ) //,   </code> </pre><br></div></div><br><h4>  Data upload to php </h4><br><br>  All my software implementations based on MYSQL were very slow.  I decided to move away from the base.  I unloaded the data into the array and decided to work through the socket.  In my case, the uploaded data takes up about 19MB of RAM. <br>  The main array is our $ graf array.  This is a three-dimensional array of keys for which: <br><ul><li>  1st key is the route from which we are transplanted </li><li>  2nd key that is transplanted </li><li>  3rd transfer point </li></ul><br><pre> <code class="php hljs"> $r = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db-&gt;query(<span class="hljs-string"><span class="hljs-string">' select routeFrom rf, routeTo rt, markerFrom mf, markerTo mt, distance d from route_cross_points RCP '</span></span>); $kf = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($r <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k =&gt; $v) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;graf[(int)($v[<span class="hljs-string"><span class="hljs-string">'rf'</span></span>])][(int)($v[<span class="hljs-string"><span class="hljs-string">'rt'</span></span>])][] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>((int)($v[<span class="hljs-string"><span class="hljs-string">'mf'</span></span>]), (int)($v[<span class="hljs-string"><span class="hljs-string">'mt'</span></span>]), (float)($v[<span class="hljs-string"><span class="hljs-string">'d'</span></span>])); } $graf[$idFrom][$idTo] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-number"><span class="hljs-number">0</span></span> =&gt; $v1, <span class="hljs-comment"><span class="hljs-comment">//  ,        1 =&gt; $v2 //  ,        ..... );</span></span></code> </pre><br>  Since the stop of one route can fall between 2 stops of another or the routes adjoin at more than 1 point, we will get a lot of transfer options.  So, $ v1, $ v2 are these transfers. <br><br>  Also in memory is an array with distances inside the route, that is, an array of the form: <br>  $ routeDistance [$ idRoute] [$ pFrom] [$ pTo] = (float); <br>  Where: <br><ul><li>  $ idRoute - id of our route, </li><li>  $ pFrom - stop with which to go, </li><li>  $ pTo - stop where to go, </li><li>  (float) - the value of the path in abstract units. </li></ul><br><pre> <code class="php hljs"> $rt = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db-&gt;query(<span class="hljs-string"><span class="hljs-string">' select route_id rni, POINT1 p1, POINT2 p2, distance d from route_distance '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($rt <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k =&gt; $v) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;routeDistance[(int)($v[<span class="hljs-string"><span class="hljs-string">'rni'</span></span>])][(int)($v[<span class="hljs-string"><span class="hljs-string">'p1'</span></span>])][(int)($v[<span class="hljs-string"><span class="hljs-string">'p2'</span></span>])] = (int)($v[<span class="hljs-string"><span class="hljs-string">'d'</span></span>]); }</code> </pre><br><br><h4>  Finding the way </h4><br><br>  To start the search we need to find a stop from where we will go and where.  After we have found the nearest stops from where ($ idFrom) and where ($ idTo) to go, we have determined the belonging of the stops to the routes, we will try to find the way. <br><br>  To find a path with 1 transplant: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($graf[$idFrom][$idTo])) { <span class="hljs-comment"><span class="hljs-comment">//      1   . }</span></span></code> </pre><br>  The search for a path, for example, with 2 transplants is implemented like this: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($graf[$idFrom] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $keyOne =&gt; $one) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($graf[$idTo][$keyOne])) { <span class="hljs-comment"><span class="hljs-comment">//        ,   ,        . } }</span></span></code> </pre><br>  Accordingly, in order to find a way, for example, with 3 transfers, we write as follows: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($graf[$idFrom] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $keyOne =&gt; $one) <span class="hljs-comment"><span class="hljs-comment">//             { foreach($graf[$idFrom] as $keyTwo =&gt; $two)//           { if(isset($graf[$keyOne][$keyTwo])){ } } }</span></span></code> </pre><br><br>  After these operations, we get a set of routes of the form $ id1 -&gt; $ id2 -&gt; $ id3 -&gt; $ id4.  Where $ id * is the route id. <br>  Next, we need to understand which path is the fastest.  We have a start stop ($ pStart) and a stop end ($ pEnd).  Also in the $ graf table, we know the transfer points (from where, where and the distance) are our values ‚Äã‚Äã$ v1, $ v2. <br>  I'll sign for $ id1 -&gt; $ id2.  We add to them data on all transfers: <br><br><pre> <code class="php hljs"> $id1($pStart, $v1[<span class="hljs-string"><span class="hljs-string">'from'</span></span>]) -&gt; $id2($v1[<span class="hljs-string"><span class="hljs-string">'to'</span></span>], $pEnd) $id1($pStart, $v2[<span class="hljs-string"><span class="hljs-string">'from'</span></span>]) -&gt; $id2($v2[<span class="hljs-string"><span class="hljs-string">'to'</span></span>], $pEnd) $id1($pStart, $v3[<span class="hljs-string"><span class="hljs-string">'from'</span></span>]) -&gt; $id2($v3[<span class="hljs-string"><span class="hljs-string">'to'</span></span>], $pEnd)</code> </pre><br>  A bit of obvious, to evaluate the route you need to add up everything: <br><br><pre> <code class="php hljs"> $routeDistance[$id1][$pStart][$v1[<span class="hljs-string"><span class="hljs-string">'from'</span></span>]] + $v1[<span class="hljs-string"><span class="hljs-string">'distance'</span></span>] + $routeDistance[$id2][$v1[<span class="hljs-string"><span class="hljs-string">'to'</span></span>]][$pEnd]; $routeDistance[$id1][$pStart][$v2[<span class="hljs-string"><span class="hljs-string">'from'</span></span>]] + $v2[<span class="hljs-string"><span class="hljs-string">'distance'</span></span>] + $routeDistance[$id2][$v2[<span class="hljs-string"><span class="hljs-string">'to'</span></span>]][$pEnd]; $routeDistance[$id1][$pStart][$v3[<span class="hljs-string"><span class="hljs-string">'from'</span></span>]] + $v3[<span class="hljs-string"><span class="hljs-string">'distance'</span></span>] + $routeDistance[$id2][$v3[<span class="hljs-string"><span class="hljs-string">'to'</span></span>]][$pEnd];</code> </pre><br>  $ routeDistance [$ id1] [$ pStart] [$ v1 ['from']] - distance inside the route. <br>  $ v1 ['distance'] - how much time is spent on transplantation, also in abstract units. <br><br>  Accordingly, the minimum value of the calculated amounts, this will be our desired path.  Next, we restore the stops that are inside the route, but are located between the point of entry into the route and the exit from it. <br><br><h4>  Example </h4><br><br>  For convenience, we choose several routes: <br><br><img src="https://habrastorage.org/storage2/bf9/135/df8/bf9135df80f72b67677456c397aa4d0d.png"><br><br>  We roll up the routes to points and get the graph: <br><br><img src="https://habrastorage.org/storage2/746/698/f04/746698f04089990ec3d20ecf21fde7ee.png"><br><br>  Suppose we need to go from 2 to 5 routes. <br>  According to our graph we get this sample paths: <br><br><img src="https://habrastorage.org/storage2/ba6/23f/e57/ba623fe57af7eb4b7e7d46588b6775e8.png"><br><br>  Further we work with the received routes.  We need to know which route is the fastest. <br><br>  Calculation of the value of the "attractiveness" of the route: <br><ol><li>  We take the stop of the start of the route and all possible stops of the transfer to another route.  According to the route_distance table, we find the length of the path from the start stop within the route to the stop of the transfer. </li><li>  Now you need to take into account the time for transplantation.  Add to the calculated length in accordance with the table route_cross_point are long between the stop with which we are transplanted and the stop at which we are transplanted. </li><li>  Repeat for each route. </li></ol><br><br>  Take the first line of our sample. <br><br><img src="https://habrastorage.org/storage2/2fd/90d/dd8/2fd90ddd86ff3707ee94308b5087a32a.png"><br><br>  $ routeDistance [2] [p.1] [p.3] + d1 + $ routeDistance [3] [p.5] [p.6] + d3 + $ routeDistance [5] [p.7] [p.8 ] = (float) <br>  $ routeDistance [2] [p.1] [p.4] + d2 + $ routeDistance [3] [p.5] [p.6] + d3 + $ routeDistance [5] [p.7] [p.8 ] = (float) <br>  $ routeDistance - the distance within the route. <br>  d * - time to transfer. <br>  p.1 - stop where we are going. <br>  p.8 - stop where we are going. <br>  d1 - the distance between p.3 and p.5 <br><br>  The minimum number is the best way. <br><br><h4>  What is missing and how you can develop: </h4><br><br>  - as long as the algorithm does not take into account the existing road network and does not lay a pedestrian route from point A to the transport stop and, accordingly, from the last public transport stop from the received route to point B; <br>  - of course, you can further consider the cost of routes and, if necessary, enter the optional selection of criteria by which to choose a route (minimum cost, time, transfers, etc.), while by default we consider the target criterion to be minimum transfers; <br>  - if they had entered fares depending on the length of the path, then also in the algorithm there would not be much to add; <br><br>  Sources <a href="https://mega.co.nz/">download</a> .  Unpack  The path should not contain Russian characters. </div><p>Source: <a href="https://habr.com/ru/post/188364/">https://habr.com/ru/post/188364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188352/index.html">SIP client interaction. Part 1</a></li>
<li><a href="../188354/index.html">A brief introduction to GNU autoconf</a></li>
<li><a href="../188358/index.html">‚ÄúBoys - to the left, girls - to the right‚Äù, or add the ‚ÄúGender‚Äù field in the Oracle database</a></li>
<li><a href="../188360/index.html">Justification of the need to purchase SSD for developers</a></li>
<li><a href="../188362/index.html">DLNA server for home and family</a></li>
<li><a href="../188368/index.html">Simulation of a neural network</a></li>
<li><a href="../188370/index.html">Selection of mnemonic quotes for car and phone numbers</a></li>
<li><a href="../188372/index.html">Basic principles of game development</a></li>
<li><a href="../188374/index.html">The story of a bad start - the option "All myself"</a></li>
<li><a href="../188376/index.html">Emacs as an IDE for Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>