<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Codecha - programmer captcha, or how not to design an API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On my website I use Codecha - a programmer captcha. This is a unique captcha, which requires writing the body of a function that solves the problem in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Codecha - programmer captcha, or how not to design an API</h1><div class="post__text post__text-html js-mediator-article">  On my website I use <a href="http://codecha.org/">Codecha</a> - a programmer captcha.  This is a unique captcha, which requires writing the body of a function that solves the problem in one of the selected programming languages. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa2/202/9e2/fa22029e296cd9317f0cae0d98fdc2a4.png" alt="KDPV - widget of this very captcha"><br><br>  It does not provide as reliable protection against bots as, for example, Google reCAPTCHA (the task set is limited and can be resolved quite quickly and then ready answers are given), but it helps against non-programmers (for a certain category of forums, crowds of students asking doing their laboratory work is a real problem, worse than spam bots).  But the note is not about that. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The problem I encountered while using Codecha is a completely inconvenient API for both the captcha widget and the server. <br><a name="habracut"></a><br>  To begin with, I propose to briefly look at how to connect the widget.  I will not copy the documentation, only the most important thing. <br><br>  So, we register, somewhere in the form we add the following code: <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//codecha.org/api/challenge?k=YOUR_PUBLIC_KEY"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  With the widget all.  Now, when submitting the form, you need to get the <i>codecha_challenge_field</i> and <i>codecha_response_field fields</i> , and then send them to the server for verification.  Hereinafter, the server code will be on Node.js. <br><br>  Parsing the form, calling the check function (using promises and <a href="https://github.com/kriskowal/q-io">q-io</a> ): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HTTP = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"q-io/http"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> checkCaptcha = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, fields</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> challenge = fields.codecha_challenge_field; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = fields.codecha_response_field; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!challenge) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.reject(<span class="hljs-string"><span class="hljs-string">"Captcha challenge is empty"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!response) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.reject(<span class="hljs-string"><span class="hljs-string">"Captcha is empty"</span></span>, <span class="hljs-string"><span class="hljs-string">"error"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = <span class="hljs-string"><span class="hljs-string">`challenge=</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${challenge}</span></span></span><span class="hljs-string">&amp;response=</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${response}</span></span></span><span class="hljs-string">&amp;remoteip=</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${req.ip}</span></span></span><span class="hljs-string">&amp;privatekey=PRIVTE_KEY`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-string"><span class="hljs-string">"http://codecha.org/api/verify"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HTTP.request({ <span class="hljs-attr"><span class="hljs-attr">url</span></span>: url, <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: [body], <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>, <span class="hljs-string"><span class="hljs-string">"Content-Length"</span></span>: Buffer.byteLength(body) }, <span class="hljs-attr"><span class="hljs-attr">timeout</span></span>: (<span class="hljs-number"><span class="hljs-number">15</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-comment"><span class="hljs-comment">//15  }).then(function(response) { if (response.status != 200) return Promise.reject("Failed to check captcha"); return response.body.read("utf8"); }).then(function(data) { var result = data.toString(); if (result.replace("true") == result) return Promise.reject("Invalid captcha"); return Promise.resolve(); }); };</span></span></code> </pre><br>  If the test is successful, the string <i>‚Äútrue‚Äù</i> will be returned, otherwise - the string <i>‚Äúfalse‚Äù</i> . <br><br>  It would seem that everything is simple, what issues can there be at all?  But no.  The fun begins when the user has sent one message using AJAX and wants to send the next one without refreshing the page.  For this reCAPTCHA, for example, provides the method <i>grecaptcha.reset</i> , but Codecha does not have such a method.  When solving a captcha, all its HTML is deleted, leaving only the text, indicating successful completion of the task.  You have to update the page. <br><br>  The same thing happens if, for example, an error occurred on the server when checking the captcha on the server.  In this case, the task-task pair on the Codecha server is invalid, and a repeated check of the same pair will return <i>‚Äúfalse‚Äù</i> .  The user will again have to refresh the page (in this case, he will also lose all the data entered into the form). <br><br>  Not good at it.  Maybe there is some hidden widget API?  It should be.  But no. <br><br><div class="spoiler">  <b class="spoiler_title">We look at the code of the script that was inserted into the form</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> codecha = { <span class="hljs-attr"><span class="hljs-attr">language</span></span>: <span class="hljs-string"><span class="hljs-string">"PHP"</span></span>, <span class="hljs-attr"><span class="hljs-attr">publicKey</span></span>: <span class="hljs-string"><span class="hljs-string">"e37ea65c651a4eada4d5d4e97ae92d90"</span></span>, <span class="hljs-attr"><span class="hljs-attr">fieldPrefix</span></span>: <span class="hljs-string"><span class="hljs-string">"codecha_"</span></span>, <span class="hljs-attr"><span class="hljs-attr">base_url</span></span>: <span class="hljs-string"><span class="hljs-string">"//codecha.org"</span></span>, <span class="hljs-attr"><span class="hljs-attr">spinner_path</span></span>: <span class="hljs-string"><span class="hljs-string">"/static/ajax-loader.gif"</span></span>, <span class="hljs-attr"><span class="hljs-attr">css_path</span></span>: <span class="hljs-string"><span class="hljs-string">"/static/widget.css"</span></span>, <span class="hljs-attr"><span class="hljs-attr">survey</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">callbacks</span></span>: {}, }; codecha.callbacks.hideErrorOverlay = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ codecha.errorOverlayDiv.hidden = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } codecha.callbacks.codeSubmit = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = codecha.CORCSRequest(codecha.base_url + <span class="hljs-string"><span class="hljs-string">"/api/code"</span></span>); codecha.disable(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params = { <span class="hljs-string"><span class="hljs-string">'challenge'</span></span>: codecha.challenge, <span class="hljs-string"><span class="hljs-string">'code'</span></span>: codecha.codeArea.value }; xhr.send(codecha.serialize(params)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }; codecha.callbacks.choseLanguage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ codecha.languageSelector.hidden = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; codecha.languageSelector.style.display = <span class="hljs-string"><span class="hljs-string">''</span></span>; codecha.changeChallenge.value = <span class="hljs-string"><span class="hljs-string">"\u2713"</span></span>; codecha.button.disabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; codecha.changeChallenge.onclick = codecha.callbacks.requestNewChallenge; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }; codecha.callbacks.requestNewChallenge = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ codecha.disable(); codecha.setStatus(<span class="hljs-string"><span class="hljs-string">"waiting"</span></span>); codecha.languageSelector.hidden = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; codecha.languageSelector.style.display = <span class="hljs-string"><span class="hljs-string">'none'</span></span>; codecha.changeChallenge.value = <span class="hljs-string"><span class="hljs-string">"change lang"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lang = codecha.languageSelector[codecha.languageSelector.selectedIndex].value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = codecha.CORCSRequest(codecha.base_url + <span class="hljs-string"><span class="hljs-string">"/api/change"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params = { <span class="hljs-string"><span class="hljs-string">'challenge'</span></span>: codecha.challenge, <span class="hljs-string"><span class="hljs-string">'k'</span></span>: codecha.publicKey, <span class="hljs-string"><span class="hljs-string">'lang'</span></span>: lang }; xhr.send(codecha.serialize(params)); codecha.changeChallenge.onclick = codecha.callbacks.choseLanguage; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }; codecha.callbacks.textAreaKeyPress = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ev</span></span></span><span class="hljs-function">) </span></span>{ object = codecha.codeArea; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ev.keyCode == <span class="hljs-number"><span class="hljs-number">9</span></span>) { start = object.selectionStart; end = object.selectionEnd; object.value = object.value.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, start) + <span class="hljs-string"><span class="hljs-string">"\t"</span></span> + object.value.substr(end); object.setSelectionRange(start + <span class="hljs-number"><span class="hljs-number">1</span></span>, start + <span class="hljs-number"><span class="hljs-number">1</span></span>); object.selectionStart = object.selectionEnd = start + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }; codecha.callbacks.updateState = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = codecha.CORCSRequest(codecha.base_url + <span class="hljs-string"><span class="hljs-string">"/api/state"</span></span>); xhr.send(codecha.serialize({ <span class="hljs-string"><span class="hljs-string">'challenge'</span></span>: codecha.challenge })); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }; codecha.callbacks.sendSurvey = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = codecha.CORCSRequest(codecha.base_url + <span class="hljs-string"><span class="hljs-string">"/api/survey"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mark = codecha.surveyMark[codecha.surveyMark.selectedIndex].value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params = { <span class="hljs-string"><span class="hljs-string">'challenge'</span></span>: codecha.challenge, <span class="hljs-string"><span class="hljs-string">'response'</span></span>: codecha.response, <span class="hljs-string"><span class="hljs-string">'mark'</span></span>: mark, <span class="hljs-string"><span class="hljs-string">'opinion'</span></span> : codecha.surveyOpinion.value }; xhr.send(codecha.serialize(params)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }; codecha.callbacks.switchToRecaptcha = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> challengeField = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(codecha.fieldPrefix + <span class="hljs-string"><span class="hljs-string">"challenge_field"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> responseField = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(codecha.fieldPrefix + <span class="hljs-string"><span class="hljs-string">"response_field"</span></span>); codecha.removeElement(codecha.mainDiv); codecha.removeElement(codecha.recaptchaSwitch); codecha.removeElement(challengeField); codecha.removeElement(responseField); codecha.recaptchaDiv.hidden = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = codecha.CORCSRequest(codecha.base_url + <span class="hljs-string"><span class="hljs-string">"/api/recaptchify"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params = { <span class="hljs-string"><span class="hljs-string">'challenge'</span></span>: codecha.challenge }; xhr.send(codecha.serialize(params)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }; codecha.removeElement = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">element</span></span></span><span class="hljs-function">) </span></span>{ element.parentElement.removeChild(element); }; codecha.removeRecatpcha = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.removeElement(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.recaptchaDiv); }; codecha.escape = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> div = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'div'</span></span>); div.appendChild(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createTextNode(str)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> div.innerHTML; }; codecha.serialize = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ array = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> obj) { array[array.length] = <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(key) + <span class="hljs-string"><span class="hljs-string">"="</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(obj[key]); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = array.join(<span class="hljs-string"><span class="hljs-string">"&amp;"</span></span>); result = result.replace(<span class="hljs-regexp"><span class="hljs-regexp">/%20/g</span></span>, <span class="hljs-string"><span class="hljs-string">"+"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }; codecha.enable = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.button.disabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.changeChallenge.disabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeArea.disabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.spinner.hidden = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }; codecha.disable = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.button.disabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.changeChallenge.disabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeArea.disabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.spinner.hidden = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }; codecha.inject_css = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> css_link=<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"link"</span></span>); css_link.setAttribute(<span class="hljs-string"><span class="hljs-string">"rel"</span></span>, <span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span>); css_link.setAttribute(<span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-string"><span class="hljs-string">"text/css"</span></span>); css_link.setAttribute(<span class="hljs-string"><span class="hljs-string">"href"</span></span>, codecha.base_url + codecha.css_path); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementsByTagName(<span class="hljs-string"><span class="hljs-string">"head"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].appendChild(css_link); }; codecha.setStatus = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.statusSpan.innerHTML = state; }; codecha.setResponseFields = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> challengeField = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fieldPrefix + <span class="hljs-string"><span class="hljs-string">"challenge_field"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> responseField = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fieldPrefix + <span class="hljs-string"><span class="hljs-string">"response_field"</span></span>); challengeField.value = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.challenge; responseField.value = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response; }; codecha.setChallenge = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uuid, language_name, wording, top, sampleCode, bottom</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.challenge = uuid; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wordingDiv.innerHTML = <span class="hljs-string"><span class="hljs-string">"&lt;strong&gt;"</span></span> + language_name + <span class="hljs-string"><span class="hljs-string">":&lt;/strong&gt; "</span></span> + wording; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeAreaTop.innerHTML = <span class="hljs-string"><span class="hljs-string">"&lt;pre&gt;\n"</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.escape(top)+<span class="hljs-string"><span class="hljs-string">"&lt;/pre&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeArea.value = sampleCode; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeAreaBottom.innerHTML = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.escape(bottom); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (top.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeAreaTop.hidden = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeAreaTop.hidden = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bottom.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeAreaBottom.hidden = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeAreaBottom.hidden = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }; codecha.showErrorMessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.errorMessageDiv.innerHTML = message; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.errorOverlayDiv.hidden = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }; codecha.showSurvey = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ codecha.mainDiv.innerHTML = <span class="hljs-string"><span class="hljs-string">"\ &lt;strong&gt;Challenge completed! You may proceed.&lt;/strong&gt; \ If you have some spare time you may help us improve our widget by answearing any question below. \ Challenge was: \ &lt;select id=\"codecha_survey_mark_selector\"&gt; \ &lt;option value=\"5\"&gt;a way too hard&lt;/option&gt; \ &lt;option value=\"4\"&gt;a bit too hard&lt;/option&gt; \ &lt;option value=\"3\" selected&gt;perfect&lt;/option&gt; \ &lt;option value=\"2\"&gt;a bit too easy&lt;/option&gt; \ &lt;option value=\"1\"&gt;a way too easy&lt;/option&gt; \ &lt;/select&gt; \ How do you like our widget? \ &lt;textarea id=\"codcha_survey_opinion_area\" name=\"codcha_survey_opinion_area\"&gt;I like/dislike it because...&lt;/textarea&gt; \ &lt;input type=\"submit\" class=\"codecha_button\" name=\"codecha_survey_submit\" id=\"codecha_survey_submit\" value=\"SUBMIT\"/&gt;\ "</span></span>; codecha.surveySubmit = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_survey_submit"</span></span>); codecha.surveyMark = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_survey_mark_selector"</span></span>); codecha.surveyOpinion = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codcha_survey_opinion_area"</span></span>); codecha.surveySubmit.onclick = codecha.callbacks.sendSurvey; }; codecha.CORCSRequest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"withCredentials"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xhr) { xhr.open(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> XDomainRequest != <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) { xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XDomainRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, url); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { xhr = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.responseText); }; xhr.onerror = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ alert(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); codecha.enable(); }; xhr.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"Content-type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xhr; }; codecha.init = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write( <span class="hljs-string"><span class="hljs-string">"&lt;input type=\"hidden\" id=\""</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fieldPrefix + <span class="hljs-string"><span class="hljs-string">"challenge_field\" /name=\""</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fieldPrefix + <span class="hljs-string"><span class="hljs-string">"challenge_field\" /&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;input type=\"hidden\" id=\""</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fieldPrefix + <span class="hljs-string"><span class="hljs-string">"response_field\" name=\""</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fieldPrefix + <span class="hljs-string"><span class="hljs-string">"response_field\" /&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;div id=\"codecha_widget\"&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;div id=\"codecha_error_overlay\"&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;a href=\"#\" id=\"codecha_error_overlay_hide\"&gt;hide&lt;/a&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;div id=\"codecha_error_message\"&gt;&lt;/div&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;/div&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;div id=\"codecha_wording\"&gt;&lt;/div&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;div id=\"codecha_code_area_top\"&gt;&lt;/div&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;textarea name=\"codecha_code_area\" id=\"codecha_code_area\"&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;/textarea&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;div id=\"codecha_code_area_bottom\"&gt;&lt;/div&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;div id=\"codecha_bottom_container\"&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;a title=\"click to learn more\" href=\""</span></span> + codecha.base_url + <span class="hljs-string"><span class="hljs-string">"/about\" target=\"_blank\" id=\"codecha_about\"&gt;Codecha&lt;/a&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;div id=\"codecha_bottom\"&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;span id=\"codecha_spinner\"&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;span id=\"codecha_status\"&gt;waiting&lt;/span&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;img alt=\"spinner\" src=\""</span></span> + codecha.base_url + codecha.spinner_path + <span class="hljs-string"><span class="hljs-string">"\" /&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;/span&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;select id=\"codecha_language_selector\"&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;option value=\"c\" &gt;C/C++&lt;/option&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;option value=\"java\" &gt;Java&lt;/option&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;option value=\"python\" &gt;Python&lt;/option&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;option value=\"ruby\" &gt;Ruby&lt;/option&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;option value=\"php\" selected &gt;PHP&lt;/option&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;option value=\"haskell\" &gt;Haskell&lt;/option&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;/select&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;input type=\"submit\" class=\"codecha_button\" name=\"codecha_change_challenge\" id=\"codecha_change_challenge\" title=\"request new challenge\" value=\"change lang\"/&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;input type=\"submit\" class=\"codecha_button\" name=\"codecha_code_submit_button\" id=\"codecha_code_submit_button\" value=\"VERIFY\"/&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;/div&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;/div&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;/div&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;div id=\"codecha_recaptcha\"&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;/div&gt;"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mainDiv = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_widget"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeArea = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_code_area"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeAreaTop = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_code_area_top"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeAreaBottom = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_code_area_bottom"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wordingDiv = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_wording"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.errorOverlayDiv = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_error_overlay"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.errorMessageDiv = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_error_message"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.errorHide = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_error_overlay_hide"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.button = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_code_submit_button"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.spinner = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_spinner"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.statusSpan = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_status"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.languageSelector = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_language_selector"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.recaptchaDiv = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_recaptcha"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.changeChallenge = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"codecha_change_challenge"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.changeChallenge.onclick = codecha.callbacks.choseLanguage; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.button.onclick = codecha.callbacks.codeSubmit; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.errorHide.onclick = codecha.callbacks.hideErrorOverlay; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.codeArea.onkeydown = codecha.callbacks.textAreaKeyPress; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.errorOverlayDiv.hidden = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.spinner.hidden = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.languageSelector.hidden = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.languageSelector.style.display = <span class="hljs-string"><span class="hljs-string">'none'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.inject_css(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.enable(); codecha.setChallenge(<span class="hljs-string"><span class="hljs-string">"d847842d3225459582722c8695ef8523"</span></span>, <span class="hljs-string"><span class="hljs-string">"PHP"</span></span>, <span class="hljs-string"><span class="hljs-string">"For given numbers \u0022a\u0022 and \u0022b\u0022 write a function named \u0022lessab\u0022 that returns the value \u00221\u0022 if \u0022a\u0022 is less than \u0022b\u0022, and returns the value \u00220\u0022 otherwise.\u000A"</span></span>, <span class="hljs-string"><span class="hljs-string">"function lessab($a,$b) {\u000A"</span></span>, <span class="hljs-string"><span class="hljs-string">"# put your code here\u000A"</span></span>, <span class="hljs-string"><span class="hljs-string">"\u000A}\u000A"</span></span>); }; codecha.init();</code> </pre><br></div></div><br>  Open the spoiler, press Ctrl + F and enter "codecha.init".  Yes, yes it is true.  You can <a href="http://codecha.org/api/challenge%3Fk%3De37ea65c651a4eada4d5d4e97ae92d90%26survey">try it</a> yourself.  This is exactly the HTML code as a string, which is added to the page using <i>document.write</i> .  Don't even ask me what's wrong with that. <br><br>  But that's not all!  (c) advertising miracle devices <br><br>  How does, for example, change the language?  Send a request, and then ... a drum roll ... <br><br><pre> <code class="javascript hljs">xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.responseText); };</code> </pre><br>  Oh yeah!  It would be possible to finish here, but I decided to finish the cactus to the end.  For this, I wrote my wrapper on Codecha.  I will not go into too much rant, I will immediately give the code with explanations. <br><br>  So, HTML widget: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"captcha"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codechaContainer"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_public_key"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PUBLIC_KEY"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_challenge_field"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_challenge_field"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CHALLENGE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_response_field"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_response_field"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_ready_widget"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display: none;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span>Challenge completed! You may proceed.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_widget"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_error_overlay"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hidden</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_error_overlay_hide"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"javascript:void(0);"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha.hideErrorOverlay();"</span></span></span><span class="hljs-tag">&gt;</span></span>hide<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_error_message"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_wording"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_code_area_top"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_code_area"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_code_area"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_code_area_bottom"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_bottom_container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"click to learn more"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//codecha.org/about"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_blank"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_about"</span></span></span><span class="hljs-tag">&gt;</span></span>Codecha<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_bottom"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_spinner"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hidden</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_status"</span></span></span><span class="hljs-tag">&gt;</span></span>waiting<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//codecha.org/static/ajax-loader.gif"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_language_selector"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hidden</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display: none;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"c"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">selected</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span>C/C++<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java"</span></span></span><span class="hljs-tag">&gt;</span></span>Java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"python"</span></span></span><span class="hljs-tag">&gt;</span></span>Python<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ruby"</span></span></span><span class="hljs-tag">&gt;</span></span>Ruby<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"php"</span></span></span><span class="hljs-tag">&gt;</span></span>PHP<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"haskell"</span></span></span><span class="hljs-tag">&gt;</span></span>Haskell<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_change_challenge"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_change_challenge"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"request new challenge"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"change lang"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha.chooseLanguage(); return false;"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_code_submit_button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha_code_submit_button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"VERIFY"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"codecha.codeSubmit(); return false;"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Client Script: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> codecha = {}; <span class="hljs-comment"><span class="hljs-comment">//     function id(_id) { return document.getElementById(_id); } function node(type, text) { if (typeof type != "string") return null; type = type.toUpperCase(); return ("TEXT" == type) ? document.createTextNode(text ? text : "") : document.createElement(type); }; function post(action, data) { return $.ajax(action, { type: "POST", data: data, dataType: "text" }); }; codecha.mustRequestNewChallenge = false; codecha.serialize = function(obj) { var array = []; for (key in obj) array[array.length] = encodeURIComponent(key) + "=" + encodeURIComponent(obj[key]); var result = array.join("&amp;"); result = result.replace(/%20/g, "+"); return result; }; codecha.escape = function(str) { var div = node("div"); div.appendChild(node("text", str)); return div.innerHTML; }; codecha.enable = function() { id("codecha_code_submit_button").disabled = false; id("codecha_change_challenge").disabled = false; id("codecha_code_area").disabled = false; id("codecha_spinner").hidden = true; }; codecha.disable = function() { id("codecha_code_submit_button").disabled = true; id("codecha_change_challenge").disabled = true; id("codecha_code_area").disabled = true; id("codecha_spinner").hidden = false; }; codecha.hideErrorOverlay = function() { id("codecha_error_overlay").hidden = true; } codecha.setStatus = function(state) { id("codecha_status").innerHTML = state; }; codecha.updateState = function() { post("//codecha.org/api/state", codecha.serialize({ 'challenge': id("codecha_challenge_field").value })).then(function(response) { var match = /codecha\.response\s*\=\s"([^"]+)"/gi.exec(response); if (match) { codecha.mustRequestNewChallenge = true; id("codecha_response_field").value = match[1]; id("codecha_widget").style.display = "none"; id("codecha_ready_widget").style.display = ""; } else { eval(response.replace(".callbacks", "")); } }).catch(function(err) { console.log(err); }); }; codecha.showErrorMessage = function(message) { id("codecha_error_message").innerHTML = message; id("codecha_error_overlay").hidden = false; }; codecha.setChallenge = function(uuid, langName, wording, top, sampleCode, bottom) { id("codecha_challenge_field").value = uuid; id("codecha_wording").innerHTML = "&lt;strong&gt;" + langName + ":&lt;/strong&gt; " + wording; id("codecha_code_area_top").innerHTML = "&lt;pre&gt;\n"+this.escape(top)+"&lt;/pre&gt;"; id("codecha_code_area").value = sampleCode; id("codecha_code_area_bottom").innerHTML = codecha.escape(bottom); id("codecha_code_area_top").hidden = (top.length &lt;= 0); id("codecha_code_area_bottom").hidden = (bottom.length &lt;= 0); }; codecha.choseLanguage = function() { id("codecha_language_selector").hidden = false; id("codecha_language_selector").style.display = ""; id("codecha_change_challenge").value = "\u2713"; id("codecha_code_submit_button").disabled = true; id("codecha_change_challenge").onclick = codecha.requestNewChallenge; return false; }; codecha.requestNewChallenge = function() { codecha.disable(); codecha.setStatus("waiting"); var select = id("codecha_language_selector"); select.hidden = true; select.style.display = "none"; id("codecha_change_challenge").value = "change lang"; id("codecha_change_challenge").onclick = codecha.choseLanguage; id("codecha_response_field").value = ""; var p; if (!codecha.mustRequestNewChallenge) { p = Promise.resolve(); } else { p = Promise.resolve().then(function() { return $.getJSON("/api/codechaChallenge.json"); }).then(function(model) { codecha.mustRequestNewChallenge = false; id("codecha_challenge_field").value = model; return Promise.resolve(); }); } p.then(function() { var params = { "challenge": id("codecha_challenge_field").value, "k": id("codecha_public_key").value, "lang": select.options[select.selectedIndex].value }; return post("//codecha.org/api/change", codecha.serialize(params)); }).then(function(response) { eval(response); }).catch(function(err) { console.log(err); }); return false; }; codecha.codeSubmit = function() { codecha.disable(); var params = { "challenge": id("codecha_challenge_field").value, "code": id("codecha_code_area").value }; post("//codecha.org/api/code", codecha.serialize(params)).then(function(response) { codecha.setStatus("sending"); setTimeout(codecha.updateState, 1000); }).catch(function(err) { console.log(err); }); }; (function() { var link = node("link"); link.setAttribute("rel", "stylesheet"); link.setAttribute("type", "text/css"); link.setAttribute("href", "//codecha.org/static/widget.css"); document.querySelector("head").appendChild(link); })(); window.addEventListener("load", function load() { window.removeEventListener("load", load, false); codecha.disable(); codecha.requestNewChallenge(); }, false); var reloadCaptcha = function() { codecha.requestNewChallenge(); id("codecha_widget").style.display = ""; id("codecha_ready_widget").style.display = "none"; };</span></span></code> </pre><br>  Server code: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requestChallenge = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-string"><span class="hljs-string">`http://codecha.org/api/challenge?k=PUBLIC_KEY`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HTTP.request({ <span class="hljs-attr"><span class="hljs-attr">url</span></span>: url, <span class="hljs-attr"><span class="hljs-attr">timeout</span></span>: (<span class="hljs-number"><span class="hljs-number">15</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>) }).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.status != <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.reject(<span class="hljs-string"><span class="hljs-string">"Failed to get challenge"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.body.read(<span class="hljs-string"><span class="hljs-string">"utf8"</span></span>); }).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> match = <span class="hljs-regexp"><span class="hljs-regexp">/codecha.setChallenge\("([^"]+)"/gi</span></span>.exec(data.toString()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!match) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.reject(<span class="hljs-string"><span class="hljs-string">"Captcha server error"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(match[<span class="hljs-number"><span class="hljs-number">1</span></span>]); }); };</code> </pre><br>  Now let's deal with what is happening here.  First, we refer to the very address of the script that is inserted into the form, and with the help of a regular expression we isolate the task identifier.  Then we substitute the identifier into the HTML template and finally give the page to the user. <br><br>  The client script, in turn, sends a request to switch jobs.  It is important to note that when requesting a new job, you must pass the ID of the previous one.  We get a new task, we substitute it in the widget.  But the most interesting thing next. <br><br>  After the user enters the task and the Codecha server checks it (everything is almost identical to the original widget), we DO NOT remove the interface elements, but simply hide them.  After sending an AJAX request message to the server, we can call the <i>reloadCaptcha</i> function, which will request the task ID from our server, and then, using its ID, will receive a new task from the Codecha server and fill the widget again.  The user at the same time feels dry and comfortable, because the page is not required to refresh. <br><br>  In the end I would like to give some recommendations: <br><br><ol><li>  Never, NEVER use eval to interpret a response from a server.  This will only add headaches to developers, but will not help protect the API from their intervention. </li><li>  Think about how your product will be used.  Consider all the options, even the most implausible (although the case described in the note is quite mundane).  Try to make the API suitable for use in all situations. </li><li>  Do not tie the receipt of a new, in no way related to the previous, piece of data to the information about the previous piece of data.  This, again, will only add a headache, but will not protect against anything. </li><li>  If you decide to protect the API from interference, then at least use obfuscation.  Without it, it is a meaningless waste of his and others time. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/272129/">https://habr.com/ru/post/272129/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272119/index.html">Few nice mancalas</a></li>
<li><a href="../272121/index.html">3CX Phone System 14 Service Pack 2 with a new console for the Secretary and WallBoard</a></li>
<li><a href="../272123/index.html">Unity in action. Multiplatform C # Development</a></li>
<li><a href="../272125/index.html">Angular Light for jQuery / JS developers</a></li>
<li><a href="../272127/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 19. "Carders Market"</a></li>
<li><a href="../272131/index.html">Accidents on server farms in Azerbaijan and the UK</a></li>
<li><a href="../272133/index.html">11 errors of your backups</a></li>
<li><a href="../272135/index.html">December 4, see Visual Studio Connect 2015 in Russia online</a></li>
<li><a href="../272137/index.html">Django release 1.9</a></li>
<li><a href="../272141/index.html">We build services on the basis of Nginx and Tarantool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>