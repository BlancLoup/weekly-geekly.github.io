<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How MySQL Optimizes ORDER BY, LIMIT, and DISTINCT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are tasks that, within the framework of relational DBMS, do not have universal solutions and in order to get at least some acceptable result, yo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How MySQL Optimizes ORDER BY, LIMIT, and DISTINCT</h1><div class="post__text post__text-html js-mediator-article">  There are tasks that, within the framework of relational DBMS, do not have universal solutions and in order to get at least some acceptable result, you have to invent a whole set of crutches, which you then proudly call ‚ÄúArchitecture‚Äù.  Not so long ago, I just met just that. <br><img src="https://habrastorage.org/storage1/24bf5260/4fde5b0d/5b6d36b9/08844585.png"><br>  Suppose there are some entities A and B, interconnected according to the <b>One-to-Many</b> principle.  The number of instances of entity data is large enough.  When displaying entities for a user, it is necessary to apply a number of independent criteria, both for entity A and for entity B. Moreover, the criteria are the result of sets of sufficiently large power ‚Äî on the order of several million entries.  Filtering criteria and sorting principle is set by the user.  How (I would also ask: Why do they need millions of records on one screen? - but they say it is necessary) to show all this to the user in the time of 0 seconds? <br>  It is always interesting to solve such problems, but their solution is highly dependent on the DBMS that controls your database.  If you have a trump ace up your sleeve in the form of an Oracle, then there is a chance that he will use these crutches himself.  But let's go down to earth - we only have MySQL, so we‚Äôll have to read the theory. <br><a name="habracut"></a><br>  Using sql task can be formulated as follows: <br><blockquote><code><font color="black"><font color="#0000ff">drop</font> <font color="#0000ff">table</font> <font color="#0000ff">if</font> <font color="#0000ff">exists</font> pivot; <br> <font color="#0000ff">drop</font> <font color="#0000ff">table</font> <font color="#0000ff">if</font> <font color="#0000ff">exists</font> entity_details; <br> <font color="#0000ff">drop</font> <font color="#0000ff">table</font> <font color="#0000ff">if</font> <font color="#0000ff">exists</font> entity; <br> <br> <font color="#0000ff">create</font> <font color="#0000ff">table</font> pivot <br> ( <br> row_number <font color="#0000ff">int</font> (4) unsigned auto_increment, <br> <font color="#0000ff">primary</font> <font color="#0000ff">key</font> pk_pivot (row_number) <br> ) <br> engine = innodb; <br> <br> <font color="#0000ff">insert</font> <font color="#0000ff">into</font> pivot(row_number) <br> <font color="#0000ff">select</font> <font color="#0000ff">null</font> <br> <font color="#0000ff">from</font> information_schema.global_status g1, information_schema.global_status g2 <br> <font color="#0000ff">limit</font> 500; <br> <br> <font color="#0000ff">create</font> <font color="#0000ff">table</font> entity(entt_id <font color="#0000ff">int</font> (10) unsigned auto_increment, <br> order_column            datetime, <br> high_selective_column <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">not</font> <font color="#0000ff">null</font> , <br> low_selective_column <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">not</font> <font color="#0000ff">null</font> , <br> data_column <font color="#0000ff">varchar</font> (32), <br> <font color="#0000ff">constraint</font> pk_entity <font color="#0000ff">primary</font> <font color="#0000ff">key</font> (entt_id) <br> ) <br> engine = innodb; <br> <br> <font color="#0000ff">create</font> <font color="#0000ff">table</font> entity_details(edet_id <font color="#0000ff">int</font> (10) unsigned auto_increment, <br> det_high_selective_column <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">not</font> <font color="#0000ff">null</font> , <br> det_low_selective_column <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">not</font> <font color="#0000ff">null</font> , <br> det_data_column <font color="#0000ff">varchar</font> (32), <br> entt_entt_id <font color="#0000ff">int</font> (10) unsigned, <br> <font color="#0000ff">constraint</font> pk_entity_details <font color="#0000ff">primary</font> <font color="#0000ff">key</font> (edet_id) <br> ) <br> engine = innodb; <br> <br> <font color="#0000ff">insert</font> <font color="#0000ff">into</font> entity(order_column, <br> high_selective_column, <br> low_selective_column, <br> data_column <br> ) <br> <font color="#0000ff">select</font> date_add(str_to_date("20000101", "%Y%m%d"), <br> <font color="#0000ff">interval</font> (p1.row_number + (p2.row_number - 1) * 300 + (p3.row_number - 1) * 300 * 300) <font color="#0000ff">second</font> <br> ) <br> order_column, <br> round((p1.row_number + (p2.row_number - 1) * 300 + (p3.row_number - 1) * 300 * 300) / 3, 0) <br> high_selective_column, <br> (p1.row_number + (p2.row_number - 1) * 300 + (p3.row_number - 1) * 300 * 300) mod 10 low_selective_column, <br> p1.row_number + (p2.row_number - 1) * 300 + (p3.row_number - 1) * 300 * 300 data_column <br> <font color="#0000ff">from</font> ( <font color="#0000ff">select</font> * <font color="#0000ff">from</font> pivot <font color="#0000ff">limit</font> 300) p1, <br> ( <font color="#0000ff">select</font> * <font color="#0000ff">from</font> pivot <font color="#0000ff">limit</font> 300) p2, <br> ( <font color="#0000ff">select</font> * <font color="#0000ff">from</font> pivot <font color="#0000ff">limit</font> 300) p3; <br> <br> <font color="#0000ff">insert</font> <font color="#0000ff">into</font> entity_details(det_high_selective_column, <br> det_low_selective_column, <br> det_data_column, <br> entt_entt_id <br> ) <br> <font color="#0000ff">select</font> e.high_selective_column + p.row_number det_high_selective_column, <br> <font color="#0000ff">case</font> <font color="#0000ff">when</font> e.low_selective_column = 0 <font color="#0000ff">then</font> 0 <font color="#0000ff">else</font> p.row_number <font color="#0000ff">end</font> det_low_selective_column, <br> concat(e.data_column, <font color="#A31515">' det'</font> ) det_data_column, <br> e.entt_id <br> <font color="#0000ff">from</font> entity e, <br> ( <font color="#0000ff">select</font> * <font color="#0000ff">from</font> pivot <font color="#0000ff">limit</font> 2) p; <br> <br> <font color="#0000ff">create</font> <font color="#0000ff">index</font> idx_entity_details_entt <br> <font color="#0000ff">on</font> entity_details(entt_entt_id); <br> <br> <font color="#0000ff">select</font> * <br> <font color="#0000ff">from</font> entity_details ed, entity e <br> <font color="#0000ff">where</font> ed.entt_entt_id = e.entt_id <br> <font color="#0000ff">order</font> <font color="#0000ff">by</font> order_column <font color="#0000ff">desc</font> <br> <font color="#0000ff">limit</font> 0, 10; <br></font></code> </blockquote><br>  The query plan in the forehead does not console. <br><table><tbody><tr><td>  id </td><td>  select_type </td><td>  table </td><td>  type </td><td>  possible_keys </td><td>  key </td><td>  key_len </td><td>  ref </td><td>  rows </td><td>  Extra </td></tr><tr><td>  one </td><td>  SIMPLE </td><td>  e </td><td>  ALL </td><td>  PRIMARY </td><td></td><td></td><td></td><td>  26982790 </td><td>  Using filesort </td></tr><tr><td>  one </td><td>  SIMPLE </td><td>  ed </td><td>  ref </td><td>  idx_entity_details_entt </td><td>  idx_entity_details_entt </td><td>  five </td><td>  test.e.entt_id </td><td>  one </td><td>  Using where </td></tr></tbody></table><br>  Before making a bunch of unnecessary indexes, let's analyze if it is possible to solve such a problem on the basis of 2 tables.  Let the first table store the characteristics of the entity, and the second the components themselves.  Normally, to ensure referential integrity, you have to use constraints, but if you have two tables of this kind with large amounts of data and constant DML'ing, I would not advise doing this because of <a href="http://bugs.mysql.com/bug.php%3Fid%3D15136">Not a BUG # 15136</a> .  And putting the database into read committed mode with an explicit setting of the dangerous innodb_locks_unsafe_for_binlog parameter to true will not save you.  Well this is so, by the way, back to our sheep.  First, let's take a look at the documentation - what opportunities do we have to speed up <b>order by</b> . <br><img src="https://habrastorage.org/storage1/5c222ae3/f111433c/2ff34e60/d81d8114.png"><br>  Option 1. Suppose we have an index, the first fields in which are the columns listed in where, and the last column on which the sorting is done.  Since the data in the index is stored in sorted form, MySQL can use it to optimize sorting.  The algorithm will be as follows.  Applying access predicates, we find the parts of the index we need.  In the plan, you will see either <b>range</b> , or <b>ref</b> , or <b>index</b> in the <b>type</b> column.  Receiving the next portion of data, in runtime mode, we read the remaining columns we need to complete the join (for the index may not have all the necessary columns, which sounds logical) and produce connections with the following table.  Since we read the data from the index in an orderly manner, then at the output of such a join, the data will be obtained in an ordered form.  When you get the right amount of data, you can stop reading the index.  For us, the main disadvantage of this approach is that the columns by which the search is performed and the column by which the sorting is performed are in different tables.  So you have to do denormalization. <br>  Options 2 and 3 are only suitable for the case when the data volume for the connection is small, i.e.  they are suitable only for highly selective speakers.  In option two, we sort the results at the beginning, and then produce join, in option three, the sorting is done after the join.  Since the sorting performed by MySQL can be performed only on one table - in the third case a temporary table is required.  It's not scary, but it can be very long.  However, the third case is the only possible option when MySQL can apply various optimizations to speed up the join.  In the first two cases it will be nested loops.  In terms of execution, these sortings will differ as follows: <br><table><tbody><tr><td>  Using index to sort </td><td>  Is empty </td></tr><tr><td>  Using filesort for table A </td><td>  ‚ÄúUsing filesort‚Äù </td></tr><tr><td>  Saving JOIN results to a temporary table and using filesort </td><td>  ‚ÄúUsing temporary;  Using filesort ‚Äù </td></tr></tbody></table><br>  In the second and third methods, the sorting <b>limit</b> can be applied only after the end of the sorting process, for this reason, options 2 and 3 are not used in all cases. <br>  Mysterious filesort is nothing more than a quick sort merge. <br><img src="https://habrastorage.org/storage1/140f1de3/42ee336f/81525537/9b6a421b.png"><br>  Sorting can be done in two ways.  The first is that sorting is done at the beginning, and then the rest of the data from the table necessary for the end of the query is read.  The second option is considered optimized, because the table is read once, together with all the necessary columns, and then sorted.  According to the plan, you cannot distinguish them from each other, but through a quick experiment, it is possible to do it.  But whether or not an optimized sorting is <b>applied, the max_length_for_sort_data</b> parameter <b>answers</b> .  If the data contained in the tuples is less than specified in this parameter, the sorting will be optimized. <br><blockquote> <code><font color="black"><font color="#0000ff">drop</font> <font color="#0000ff">procedure</font> <font color="#0000ff">if</font> <font color="#0000ff">exists</font> pbenchmark_filesort; <br> delimiter $$ <br> <font color="#0000ff">create</font> <font color="#0000ff">procedure</font> pbenchmark_filesort(i_repeat_count <font color="#0000ff">int</font> (10)) <br> main_sql: <br> <font color="#0000ff">begin</font> <br> <font color="#0000ff">declare</font> v_variable_value <font color="#0000ff">int</font> (10); <br> <font color="#0000ff">declare</font> v_loop_counter <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">default</font> 0; <br> <font color="#0000ff">declare</font> <font color="#0000ff">continue</font> handler <font color="#0000ff">for</font> <font color="#0000ff">sqlstate</font> <font color="#A31515">'42S01'</font> <font color="#0000ff">begin</font> <br> <font color="#0000ff">end</font> ; <br> <br> <font color="#0000ff">create</font> <font color="#0000ff">temporary</font> <font color="#0000ff">table</font> <font color="#0000ff">if</font> <font color="#0000ff">not</font> <font color="#0000ff">exists</font> temp_sort_results( <br> row_number <font color="#0000ff">int</font> (10) unsigned <br> ) <br> engine = memory; <br> <font color="#0000ff">truncate</font> <font color="#0000ff">table</font> temp_sort_results; <br> <br> <font color="#0000ff">select</font> variable_value <br> <font color="#0000ff">into</font> v_variable_value <br> <font color="#0000ff">from</font> information_schema.session_status <br> <font color="#0000ff">where</font> variable_name = <font color="#A31515">'INNODB_ROWS_READ'</font> ; <br> <br> begin_loop: <br> loop <br> <font color="#0000ff">set</font> v_loop_counter  = v_loop_counter + 1; <br> <br> <font color="#0000ff">if</font> v_loop_counter &lt;= i_repeat_count <font color="#0000ff">then</font> <br> <font color="#0000ff">insert</font> <font color="#0000ff">into</font> temp_sort_results(row_number) <br> <font color="#0000ff">select</font> sql_no_cache row_number <font color="#0000ff">from</font> pivot <font color="#0000ff">order</font> <font color="#0000ff">by</font> concat(row_number, <font color="#A31515">'0'</font> ) <font color="#0000ff">asc</font> ; <br> <font color="#0000ff">truncate</font> <font color="#0000ff">table</font> temp_sort_results; <br> <font color="#0000ff">iterate</font> begin_loop; <br> <font color="#0000ff">end</font> <font color="#0000ff">if</font> ; <br> <br> leave begin_loop; <br> <font color="#0000ff">end</font> loop begin_loop; <br> <br> <font color="#0000ff">select</font> variable_value - v_variable_value records_read <br> <font color="#0000ff">from</font> information_schema.session_status <br> <font color="#0000ff">where</font> variable_name = <font color="#A31515">'INNODB_ROWS_READ'</font> ; <br> <font color="#0000ff">end</font> <br> $$ <br> delimiter ; <br> <br> <font color="#0000ff">set</font> <font color="#0000ff">session</font> max_length_for_sort_data = 0; <br> <font color="#0000ff">call</font> pbenchmark_filesort(10000); <br> <font color="#008000">-- records_read</font> <br> <font color="#008000">-- 10 000 000</font> <br> <font color="#008000">-- 0:00:12.317    Query OK</font> <br> <br> <font color="#0000ff">set</font> <font color="#0000ff">session</font> max_length_for_sort_data = 1024; <br> <font color="#0000ff">call</font> pbenchmark_filesort(10000); <br> <font color="#008000">-- records_read</font> <br> <font color="#008000">-- 5 000 000</font> <br> <font color="#008000">-- 0:00:06.228    Query OK</font> <br> <br></font></code> </blockquote><br>  As you can see from the example, the sorting according to algorithm number 2 is really twice as fast, because it reads 2 times less lines.  However, it should be borne in mind that optimized sorting requires a significant amount of memory, and if you set the value of the <b>max_length_for_sort_data</b> variable to a too high value, you will get a lot of input and full processor idle time. <br>  So, we will use all the power of the available solutions.  We are doing denormalization (how will you support it, is another question).  And we build composite indices for non-selective columns and ordinary ones for highly selective ones.  Thus, sorting by index and limit limit will be used for queries that only include low-selective columns, and for highly selective ones, more compact and fast indices will be used followed by single-pass filesort without merging. <br><blockquote> <code><font color="black"><font color="#0000ff">create</font> <font color="#0000ff">table</font> entity_and_details(entt_entt_id <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">not</font> <font color="#0000ff">null</font> , <br> edet_edet_id <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">not</font> <font color="#0000ff">null</font> , <br> order_column                datetime, <br> high_selective_column <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">not</font> <font color="#0000ff">null</font> , <br> low_selective_column <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">not</font> <font color="#0000ff">null</font> , <br> det_high_selective_column <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">not</font> <font color="#0000ff">null</font> , <br> det_low_selective_column <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">not</font> <font color="#0000ff">null</font> , <br> <font color="#0000ff">constraint</font> pk_entity_and_details <font color="#0000ff">primary</font> <font color="#0000ff">key</font> (entt_entt_id, edet_edet_id) <br> ) <br> engine = innodb; <br> <br> <font color="#0000ff">insert</font> <font color="#0000ff">into</font> entity_and_details(entt_entt_id, <br> edet_edet_id, <br> order_column, <br> high_selective_column, <br> low_selective_column, <br> det_high_selective_column, <br> det_low_selective_column <br> ) <br> <font color="#0000ff">select</font> entt_id, <br> edet_id, <br> order_column, <br> high_selective_column, <br> low_selective_column, <br> det_high_selective_column, <br> det_low_selective_column <br> <font color="#0000ff">from</font> entity_details ed, entity e <br> <font color="#0000ff">where</font> ed.entt_entt_id = e.entt_id; <br> <br> <font color="#0000ff">create</font> <font color="#0000ff">index</font> idx_entity_and_details_low_date <br> <font color="#0000ff">on</font> entity_and_details(low_selective_column, order_column); <br> <br> <font color="#0000ff">create</font> <font color="#0000ff">index</font> idx_entity_and_details_det_low_date <br> <font color="#0000ff">on</font> entity_and_details(det_low_selective_column, order_column); <br> <br> <font color="#0000ff">create</font> <font color="#0000ff">index</font> idx_entity_and_details_date <br> <font color="#0000ff">on</font> entity_and_details(order_column); <br> <br> <font color="#0000ff">create</font> <font color="#0000ff">index</font> idx_entity_and_details_high <br> <font color="#0000ff">on</font> entity_and_details(high_selective_column); <br> <br> <font color="#0000ff">create</font> <font color="#0000ff">index</font> idx_entity_and_details_det_high <br> <font color="#0000ff">on</font> entity_and_details(det_high_selective_column); <br></font></code> </blockquote><br>  Unfortunately, after denormalization, we got one drawback.  Page layout can scatter the details of one entity across different pages.  We cannot allow this, so I propose to set up churches further.  Instead of selecting all the necessary data at once - we select only the identifiers of the entity A, with the condition of all the criteria, add to the <b>limit</b> design for paging, and then pick up the details of the entity. <br><blockquote> <code><font color="black"><font color="#0000ff">select</font> <font color="#0000ff">distinct</font> entt_entt_id <br> <font color="#0000ff">from</font> entity_and_details <br> <font color="#0000ff">where</font> det_low_selective_column = 0 <br> <font color="#0000ff">order</font> <font color="#0000ff">by</font> order_column <br> <font color="#0000ff">limit</font> 0, 3; <br> <br> <font color="#0000ff">select</font> * <br> <font color="#0000ff">from</font> entity_and_details <br> <font color="#0000ff">where</font> entt_entt_id <font color="#0000ff">in</font> (10, 20, 30); <br></font></code> </blockquote><br>  I admit honestly, in my mind, the construction of the form of <b>distinct</b> + <b>order by</b> + <b>limit</b> according to the table of such volumes cannot work quickly, however, the MySQL developers think differently.  When working on this issue, I came across a bug <a href="http://bugs.mysql.com/bug.php%3Fid%3D33087">Not Not BUG # 33087</a> , which, as usual, turned out to be not a bug, but a feature.  After that, I decided to understand how MySQL optimizes <b>distinct</b> .  The first phrase in the documentation was: to optimize <b>distinct</b> , all the same optimizations that are used for <b>group by</b> can be used.  Total grouping can be performed by two algorithms. <br><img src="https://habrastorage.org/storage1/7e14adce/cb675f1b/f873342a/f758d16f.png"><br>  The first case can be applied only if there is an index that sets the grouping automatically.  The second scheme is used in all other cases.  The index grouping is performed sequentially and can be limited - and this is very good for us, since this is exactly what we need to display the results on low selective indices.  Temporary tables with this approach are not used (to be honest, this is not entirely true, since in general you need to store the results of the partial join, as well as the values ‚Äã‚Äãthemselves resulting from the grouping for the current group, but these are trifles).  The second scheme works terribly slowly and eats a bunch of RAM, since all the results of the grouping should be stored in a temporary table, the primary key in which is the group identifier.  For very large values, this table is converted to MyISAM and flushed to disk.  All new groups are first searched in this large table, and then they change the values ‚Äã‚Äãin it, if necessary, or add a new line if the group is not found.  Final sorting finishes the performance of this algorithm.  It is for this reason that if you do not need an ordered set, it is often recommended to add <b>order by null</b> . <br>  Thus, the first approach, as well as the fact that MySQL stops further data retrieval if the <b>limit</b> construction is used together with <b>distinct</b> , and allows us to get the result of grouping very quickly. <br><br><h2>  Now about the unpleasant </h2><br>  So, we got an algorithm that quickly finds the first records, but this algorithm cannot calculate the total number of records.  As a workaround, you can return one more entry so that the <i>Next</i> button appears on the screen. <br>  MySQL cannot use more than one index in a query for a single table.  What does it threaten us with?  Let's try to execute the query type: <br><blockquote> <code><font color="black"><font color="#0000ff">select</font> <font color="#0000ff">distinct</font> entt_entt_id <br> <font color="#0000ff">from</font> entity_and_details <br> <font color="#0000ff">where</font> det_low_selective_column = 0 <font color="#0000ff">and</font> low_selective_column = 1 <br> <font color="#0000ff">order</font> <font color="#0000ff">by</font> order_column <br> <font color="#0000ff">limit</font> 0, 3;</font></code> </blockquote> <br>  Believe you will not wait for it to end, because if you look at the data, you will see a specially formed failure there.  The set satisfying the criterion <b>det_low_selective_column = 0</b> has no intersections with the set satisfying the criterion <b>low_selective_column = 1</b> .  We know this, but unfortunately, MySQL knows nothing about it.  Therefore, he chooses an index, which in his opinion is most suitable for scanning and makes a full scan of 2 indexes, selected and PK.  This is deadly for a long time since scanning the primary key is actually a full table scan due to its cluster organization.  All such gaps must be routed to multiple indices. <br><br>  And finally, the most embarrassing moment.  InnoDB uses only one mutex for each index.  Therefore, when you alternately run queries that write and read data at the same time, the InnoDB engine locks the index, suspending read operations, since a write operation can cause B-Tree splitting and the records you are looking for may end up on another page.  Smart databases do not block the entire tree, but only its split part.  In MySQL, this algorithm is not yet implemented (although you can see the InnoDB plugin on this topic, in 5.5 it seems to have become a standard, maybe things are not so bad there).  In order to get around this problem, you need to separate the data, that is, use partitions.  All indexes in partition tables are locally partitioned, in fact, each partition in this regard is a separate table, but partitioning is another story and I will not touch on it in this article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Conclusion </h2><br>  The solution of a number of problems that the harsh reality gives us is impossible to describe in two words.  The problem of multi-criteria search in several sets is one of them.  You can use the <a href="http://sphinxsearch.com/">Sphinx</a> and download a number of templates provided by this community, but sooner or later you will still encounter a problem to which no one has come up with a solution.  And so, then you have to go into the documentation, study the data and persuade users not to do it.  I hope this review article will allow you to avoid some of the pitfalls that await you on this thorny path. <br><br>  ZY  a number of optimizations for group by had to be omitted, since the article was already very large.  You can read about them in the <a href="http://dev.mysql.com/doc/refman/5.5/en/group-by-optimization.html">official documentation</a> , as well as a <a href="http://explainextended.com/2011/03/28/mysql-splitting-aggregate-queries/">number of practical tips</a> , to fully understand the issues. <br>  <font color="gray">* All code sources were highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="gray">Source Code Highlighter</font></a> .</font> </div><p>Source: <a href="https://habr.com/ru/post/125428/">https://habr.com/ru/post/125428/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125419/index.html">Nokia is changing the phone designation system</a></li>
<li><a href="../125421/index.html">About singletons and static constructors</a></li>
<li><a href="../125423/index.html">VMware revised volume of vRAM entitlement in vSphere 5</a></li>
<li><a href="../125424/index.html">HTML5 Drag and Drop file upload</a></li>
<li><a href="../125427/index.html">Published preliminary sketches of the future interface Firefox</a></li>
<li><a href="../125431/index.html">The world of open-source in your pocket</a></li>
<li><a href="../125432/index.html">C #, Talk with a computer or System.Speech</a></li>
<li><a href="../125433/index.html">PhoneGap 1.0 allows you to write applications for seven platforms</a></li>
<li><a href="../125436/index.html">Linux Doctor Workplace</a></li>
<li><a href="../125437/index.html">"System Administrator 2011". Results</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>