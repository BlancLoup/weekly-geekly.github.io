<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we translated server to php 7</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="php 7 was released almost a year ago, version 7.1 is already on the nose, which is currently being released. The Internet is full of positive reviews,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we translated server to php 7</h1><div class="post__text post__text-html js-mediator-article">  php 7 was released almost a year ago, version 7.1 is already on the nose, which is currently being released.  The Internet is full of positive reviews, but it‚Äôs time to use it in production.  The experience of moving a combat server with thirty projects to it will be discussed in this article. <br><br>  The seventh version offers us many new features, but the main killer innovation php7, I believe, is an increase in performance and a decrease in memory consumption.  We tried it for a long time in internal projects, we made sure that it gives an increase not only in synthetic tests, it was decided to transfer all production to it. <br><a name="habracut"></a><br><h3>  Server and projects </h3><br>  Our production server is a HP server with a four-core Xeon X3430 processor at 2.40GHz and 16GB of RAM.  About 30 sites are hosted on the server, about half of them are medium-sized online stores, for 10-20 thousand products with an attendance of about 1-2 thousand unique visitors per day.  All projects are written on yii framework 1.1 of different versions, ranging from the 14th and up to 17. Everything works on a bunch of nginx-php-fpm. <br><br>  We did not move from a good life.  The server was tough to cope with requests and, during peak hours, the incoming robot of some indiscreet search engine or the parser of some schoolboy, if they did not drop the server, delivered a noticeable amount of problems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  How to move </h3><br>  We decided that we could not switch everything at once, we need to translate on one or two projects.  Raised the second version of the demon php-fpm for seven.  For the site for which the move was planned, a second separate socket was raised.  Next, the socket was replaced in the nginx configuration.  This allowed us in case of detection of any problems to quickly change the socket back and one command service nginx reload to return the site to a healthy state. <br><br><h3>  What happened to the server </h3><br>  On day x, the victim was chosen, which is not a pity, the configs were changed, the process began.  On the site, the transition was immediately felt.  Pages began to be given for 400-500 ms.  instead of 600-800 ms.  Here is a picture of the return time of the main page of the first victim.  Pay attention to the beginning of September. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/664/21a/2ed/66421a2ed7f0c6c26a48576bc10dad5e.png" alt="image"></div><br>  Unfortunately, we monitor only the main pages with nagios, they are fairly well optimized, so the growth there is noticeable, but not the maximum.  The maximum is visible on heavy pages with a large number of goods, there it is even more significant, but I have no graphs. <br><br>  After the translation of two or three projects, the picture in general on the server began to change.  Each subsequent move unloading it even more.  This picture shows the dynamics of the last four weeks. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e23/08c/5fc/e2308c5fc74cc5e6272e6159eb098307.png" alt="image"></div><br>  It became easier for the server, it could be seen even on those sites that were the last in line and worked on php 5.6 until the last moment (we are looking at September, October) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/37c/0ea/0ec/37c0ea0ecc86aa4a11333191bde6843a.png" alt="image"></div><br>  And now we have arrived at this state, on the graph in October and November it does not need comments. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/981/94c/c79/98194cc79bda913f1b681fad6778638f.png" alt="image"></div><br>  Fell on the disk subsystem <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/53f/e8b/f18/53fe8bf18951fd6b71aeec6f023b6622.png" alt="image"></div><br><h3>  What were the problems </h3><br>  As we expected, the new version did not bring big problems (otherwise we would simply not have mastered the move) <br><br>  Of the most significant was only one.  It is connected with the fact that php allows you to shoot yourself a leg, then the second leg, and even the hand with which you shoot. <br><br>  The seven functions of the substr function changed in the seven, one of the methods for handling the http request broke in yii, but Alexander Makarov and his colleagues corrected it a long time ago, so everything was decided by updating the framework version on these projects. <br><br>  From interesting.  One of the sites did not start right away, it turned out in his code there was a method in which two input parameters had the same name.  5.6 worked quietly and buggy, but 7.0.  swore and fell. <br><br>  Well, not without razdolbaystva.  Two sites worked on one socket, for the first they changed the name of the socket, nobody remembered about the second site and it was not monitored, as a result, he lay all night until marketers saw the next day errors in the metrics and did not run. <br><br><h3>  At last </h3><br>  By experience, good code is easy to port to the new version of php.  With half of these projects, we switched from 5.4 to 5.6 without any changes at all and the whole bundle at once.  So write good code, use good frameworks and, most importantly, don't be afraid of changes - they are always for the best;) </div><p>Source: <a href="https://habr.com/ru/post/315300/">https://habr.com/ru/post/315300/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315284/index.html">Pepelats with Gravizapa - as I searched (and even found) CRM for a medical center</a></li>
<li><a href="../315286/index.html">Why and how to transfer corporate email security to the cloud. Part 2</a></li>
<li><a href="../315288/index.html">The new version of business process management solution JBoss BPM Suite will increase the role of using microservices</a></li>
<li><a href="../315294/index.html">learnopengl. Lesson 1.6 - Textures</a></li>
<li><a href="../315298/index.html">Hammer on the office, work remotely</a></li>
<li><a href="../315302/index.html">Email Services Digest: Featured Email Products and Podcasts by Product Hunt</a></li>
<li><a href="../315304/index.html">How to create an informative, but convenient corporate site?</a></li>
<li><a href="../315306/index.html">Mobio Talks with Irina Shashkina, CEO of Lingualeo</a></li>
<li><a href="../315310/index.html">How cloud technologies change the world of sports</a></li>
<li><a href="../315312/index.html">Questions and answers about communication and technology in space. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>