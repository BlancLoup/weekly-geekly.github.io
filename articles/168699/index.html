<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to: AD + MSSQL to SSRS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. I decided that the AD data processing experience using SQL would be useful not only for me, I couldn‚Äôt find an intelligible manual in Russia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to: AD + MSSQL to SSRS</h1><div class="post__text post__text-html js-mediator-article">  Good day.  I decided that the AD data processing experience using SQL would be useful not only for me, I couldn‚Äôt find an intelligible manual in Russian. <br><a name="habracut"></a><br><br><p>  <sub><font color="#7F7F7F">For the presentation style, I ask you not to hit hard, I tried to explain as accessible as possible, as I wanted to see when I was looking for info.</font></sub> <sub><br></sub> <br></p><br><p>  Actually, the task: ‚ÄúAnd make us a report on all the users of the company, and so that its groups are derived.‚Äù  I don‚Äôt know how real it is with some kind of native AD administration tools, but the first idea that came to mind was to write a request to AD and pull out all the information that it could put in a thread and continue to process what your heart desires, whether it's a reporting service or something in the spirit of crystal reports.  How to reach to AD? <br></p><br>  It turns out that MSSQL has a native OLE DB provider for connecting to AD.  Add our linked server to server objects: <br><br><pre><code class="sql hljs">EXEC master.dbo.sp_addlinkedserver @server = N'ADSI' , @srvproduct=N'Active Directory Service Interfaces' , @provider=N'ADSDSOObject' , @datasrc=N'adsdatasource'</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At once I would like to note that the code used in the topic has been tested several times over the past few days on different servers (2008/2008 R2 / 2012) and the generated sql script is given. <br><br><p>  <sub><font color="#7F7F7F">How via gui I will not say, because I do not know;)</font></sub> <sub><font color="#7F7F7F"><br></font></sub> </p><br>  After we have created the server, you need to add a login to it: <br><pre> <code class="sql hljs">EXEC master.dbo.sp_addlinkedsrvlogin @rmtsrvname=N'ADSI' ,@useself=N'False' ,@locallogin=NULL ,@rmtuser=N'Domain\user' ,@rmtpassword='password'</code> </pre><br>  I want to note that in the settings of the server itself, we obviously do not specify the specific ldap connection that interests us. <br><br>  Settings generated by the sql server: <br><pre> <code class="sql hljs">EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'collation compatible', @optvalue=N'false' EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'data access', @optvalue=N'true' EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'dist', @optvalue=N'false' EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'pub', @optvalue=N'false' EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'rpc', @optvalue=N'false' EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'rpc out', @optvalue=N'false' EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'sub', @optvalue=N'false' EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'connect timeout', @optvalue=N'0' EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'collation name', @optvalue=null EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'lazy schema validation', @optvalue=N'false' EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'query timeout', @optvalue=N'0' EXEC master.dbo.sp_serveroption @server=N'ADSI', @optname=N'<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> remote <span class="hljs-keyword"><span class="hljs-keyword">collation</span></span><span class="hljs-string"><span class="hljs-string">', @optvalue=N'</span></span><span class="hljs-literal"><span class="hljs-literal">true</span></span><span class="hljs-string"><span class="hljs-string">' EXEC master.dbo.sp_serveroption @server=N'</span></span>ADSI<span class="hljs-string"><span class="hljs-string">', @optname=N'</span></span>remote proc <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> promotion<span class="hljs-string"><span class="hljs-string">', @optvalue=N'</span></span><span class="hljs-literal"><span class="hljs-literal">true</span></span><span class="hljs-string"><span class="hljs-string">'</span></span></code> </pre><br>  That's it, we have a server.  Now you need a query.  For queries you can use two dialects: <br><ol><li>  1) SQL similar syntax - and used it. </li><li>  2) LDAP is a similar syntax - in my opinion it looks more logical, but I found out about it when I did it. <br></li></ol><br>  Requests are executed via OPENQUERY to the server of interest to us.  In the query in the FROM, we write a link in the form of LDAP: // dc = maindomain, dc = rootfolder, we wrap it in apostrophes and write a select sheet.  This link can be obtained either from admins, or you can search the ad for the branch you need with any convenient ldap browser. <br>  Request: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENQUERY(ADSI,<span class="hljs-string"><span class="hljs-string">'SELECT cn,sAMAccountName FROM ''LDAP://dc=maindomain,dc=rootfolder'''</span></span>)</code> </pre><br>  Click f5.  Ur request works.  Joy is short, after 900 lines (less than a second) falls out <br><blockquote>  <font color="#F30E00">Can not fetch a row from the OLE DB provider "ADSDSOObject" for the linked server "ADSI".</font> <font color="#F30E00"><br></font> </blockquote> <font color="#F30E00"><br></font> <br>  At once I will say that this is a custom restriction of the AD itself, and not the driver, or the provider, or something else.  Well, if it is not only 2000, in 2000 it is not configured.  How it is configured we can see <a href="http://support.microsoft.com/kb/315071">here</a> . <br>  We can go two ways: ask admins to reconfigure or bypass this limitation.  The ultimate goal is to get all users. <br>  Reduce the search range: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENQUERY(ADSI,<span class="hljs-string"><span class="hljs-string">'SELECT cn,sAMAccountName FROM ''LDAP://dc=maindomain,dc=rootfolder'' WHERE AND objectClass=''person'' AND objectClass&lt;&gt;''computer'' '</span></span>)</code> </pre><br><br>  Again a lot?  Well, then you need to cheat.  You can search for a specific user for example.  But then we need to know the logins of all users is also not good.  Well, we find at least those whose login begins with abc.  We will search by field sAMAccountName - this is a field which in all AD schemes seems to be as it is, well, if you are not using an extremely unique scheme.  If, however, extreme, then contact the admins let them find it (the scheme) for you.  I think the field decided.  Now the dialect differs from the ansi sql: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENQUERY(ADSI,<span class="hljs-string"><span class="hljs-string">'SELECT cn,sAMAccountName FROM ''LDAP://dc=maindomain,dc=rootfolder'' WHERE sAMAccountName =''abc*'' AND objectClass=''person'' AND objectClass&lt;&gt;''computer'' '</span></span>)</code> </pre><br>  If there are users starting with abc, then he will return something to you: <br><br>  sAMAccountName cn <br>  abceeeee abceeeee dfdf eee <br><br>  Yes, in reverse order.  No, I do not know why.  Well, for example, we will think up a nested loop with enumeration of combinations of letters from a to z and a search of the type sAMAccountName = aa *, then sAMAccountName = ab *, omit the dynamic query.  For example, users received.  Now you need to get the group. <br><br>  Please: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENQUERY(ADSI,<span class="hljs-string"><span class="hljs-string">'SELECT memberOf,cn,sAMAccountName FROM ''LDAP://dc=maindomain,dc=rootfolder'' WHERE sAMAccountName =''abc*'' AND objectClass=''person'' AND objectClass&lt;&gt;''computer'' '</span></span>)</code> </pre><br>  We get: <br><blockquote>  <font color="#F30E00">Can not get the data from the OLE DB provider "ADSDSOObject" for the linked server "ADSI".</font>  <font color="#F30E00">Could not convert or mismatch or overflow.</font> <font color="#F30E00"><br></font> </blockquote> <font color="#F30E00"><br></font> <br>  memberOf can be somewhat, well, logical in principle.  We will ask not the user‚Äôs groups, but the groups in which there is a user and we will invite the whole structure.  To get all the groups, we are looking for a group whose member has the registered dn of our desired user. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENQUERY(ADSI,<span class="hljs-string"><span class="hljs-string">'SELECT name FROM ''LDAP://dc=maindomain,dc=rootfolder'' WHERE objectCategory = ''Group'' AND member=''CN=username,OU=Departments,dc=maindomain,dc=rootfolder'' '</span></span>)</code> </pre><br>  Groups got what else to pull out of them is better to look in the scheme. <br><br>  Now try the user "umi (Yumi Chinese Department)".  Well, strange user, I do not argue.  But the English name, and in Russian brackets, is quite normal.  Okay, not the point. <br>  Request: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENQUERY(ADSI,<span class="hljs-string"><span class="hljs-string">'SELECT name FROM ''LDAP://dc=maindomain,dc=rootfolder'' WHERE objectCategory = ''Group'' AND member=''CN=umi(  ),OU=Departments,dc=maindomain,dc=rootfolder'' '</span></span>)</code> </pre><br>  The answer is also obtained if this user has any groups.  But if we export a user from where something where we have a user is called some sort of Russian long abracadabra, then the string we will have <br><br> <code>umi(  ,      ,   )</code> <br>  And on cn we have a limit of 64 characters, total we get: <br><br> <code>umi(  ,      </code> <br>  From the point of view of the query, everything is fine, sql will not be cursed on the request curve, but ldap provider will swear and say that <blockquote>  <font color="#F30E00">‚ÄúHere is our query‚Äù for the execution against the OLE DB provider ‚ÄúADSDSOObject‚Äù for the linked server ‚ÄúADSI‚Äù.</font> <font color="#F30E00"><br></font> </blockquote> <font color="#F30E00"><br></font> <br>  Yes, you can not look for brackets.  At first I thought that it was possible to screen through quotes, then I thought that through a slash, then through an ampersand, I thought a lot.  Does not work.  The answer came by itself: I tried to find the same user in the ldap browser (you can take anyone, I think it will still be useful).  And when constructing a query when I typed a slash, he himself suggested to me which characters can be escaped. <br>  The list here is: <blockquote><ol><li> <code>( - \28</code> </li> <li> <code>) - \29</code> </li> <li> <code>* - \2A</code> </li> <li> <code>\ - \5C</code> </li> <li> <code>Carriage Return - \0D</code> </li> <li> <code>Line Feed - 0A</code> </li> <li> <code>NUL - \00 <br></code> </li></ol></blockquote><br>  Separately, it is worth noting the apostrophe, as you see in the list of screenings apostrophe no.  From AD's point of view, everything is fine, the query is working, an error is thrown exactly at the request processing by the provider. It can only be escaped through sql <br><br>  Our dn looks like this: <code>CN=Luk'yanova Inna (  ),OU=Departments,dc=maindomain,dc=rootfolder</code> . <br><br>  We assigned it somehow in @dn.  So that you do not have to sit around picking how many apostrophes put here: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @dn = <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(@dn,<span class="hljs-string"><span class="hljs-string">''''</span></span>,<span class="hljs-string"><span class="hljs-string">''''''''''</span></span>)</code> </pre><br>  Well, and then, and then either in the procedure, or just where you need to push this query (queries) and work with the sql-tables as you like. <br><br>  <sub><font color="#7F7F7F">PS about errors in the topic, please notify me in a personal, and not through the comments.</font></sub> <sub><font color="#7F7F7F"><br></font></sub> <br></div><p>Source: <a href="https://habr.com/ru/post/168699/">https://habr.com/ru/post/168699/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168689/index.html">dot42 - C # compiler for Dalvik Runtime</a></li>
<li><a href="../168691/index.html">MongoDB Replication on Amazon EC2</a></li>
<li><a href="../168693/index.html">Opening of the IT-club MODX in Yekaterinburg</a></li>
<li><a href="../168695/index.html">IOS 6.1.1 beta released</a></li>
<li><a href="../168697/index.html">Setting up Inkscape to work with black and white graphics</a></li>
<li><a href="../168701/index.html">Review of the ASUS Zenbook UX31A Touch Ultrabook Touch</a></li>
<li><a href="../168705/index.html">Isometric Sapper on LibCanvas (html5)</a></li>
<li><a href="../168707/index.html">Why is Keccak so cool and why was it chosen as the new SHA-3</a></li>
<li><a href="../168709/index.html">First household appliances</a></li>
<li><a href="../168711/index.html">We measure the performance of drives or again about IOPS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>