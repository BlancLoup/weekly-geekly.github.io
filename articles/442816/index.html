<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create your own game controller</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Source of inspiration 
 At game shows, developers of Objects in Space showed a demo of their game with a controller on the cockpit of a huge spacecraf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create your own game controller</h1><div class="post__text post__text-html js-mediator-article"><h2>  Source of inspiration </h2><br>  At game shows, developers of <a href="http://objectsgame.com/" rel="external nofollow">Objects in Space</a> showed a demo of their game with a controller on the cockpit of a huge spacecraft.  It was supplemented with illuminated buttons, analog instruments, status lights, switches, etc ... This greatly affects the immersion in the game: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e96/44d/1ad/e9644d1ad417a9a97f888feea64d0e8a.jpg"></div><br>  On the game site laid out <a href="http://objectsgame.com/the-controllers/arduino-tutorial/" rel="external nofollow">tutorial on Arduino</a> with a description of the <a href="http://objectsgame.com/the-controllers/ois-serial-data-protocol/" rel="external nofollow">communication protocol</a> for such controllers. <br><br>  <strong>I want to create the same for my game</strong> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this example, I‚Äôll spend about $ 40 to add beautiful, big, and heavy switches to the cockpit of a racing simulator.  The main costs are connected with these switches - if I used simple switches / buttons, the price was two times lower!  This is real equipment capable of withstanding 240 watts of power, and I will only use about 0.03 watts of it. <br><br>  Warning: I decided to save, so leave a link to a cheap Chinese website, where I buy a bunch of different components / tools.  One of the drawbacks of buying components for cheap is that they often have no documentation, so I will solve this problem in the article. <br><a name="habracut"></a><br><h2>  Main components </h2><br><ul><li>  <a href="https://www.banggood.com/Mega-2560-R3-ATmega2560-16AU-Control-Board-Without-USB-Cable-For-Arduino-p-1044805.html%3Fp%3DL107012055587201508R%26amp%3Bcur_warehouse%3DCN" rel="external nofollow">Arduino Mega2560</a> - $ 9 <br></li><li>  <a href="https://www.banggood.com/12V-Racing-Car-Ignition-Switch-4-Blue-1-Red-LED-Toggle-Button-Panel-Housing-p-1363098.html%3Fp%3DL107012055587201508R%26amp%3Bcur_warehouse%3DCN" rel="external nofollow">Ignition Switch Racing Panel</a> - $ 26 <br></li><li>  A bunch of connecting wires ( <a href="https://www.banggood.com/40pcs-20cm-Male-To-Male-Color-Breadboard-Cable-Jumper-Cable-Dupont-Wire-p-70127.html%3Fp%3DL107012055587201508R%26amp%3Bcur_warehouse%3DCN" rel="external nofollow">"male to male"</a> , <a href="https://www.banggood.com/40pcs-20cm-Male-to-Female-Color-Breadboard-Cable-Jump-Wire-Jumper-p-992837.html%3Fp%3DL107012055587201508R%26amp%3Bcur_warehouse%3DCN" rel="external nofollow">"male to female"</a> , etc ...) - $ 2 </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f5c/e18/fb6/f5ce18fb6e69f6d2dd322d5295a8c7db.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c43/2d0/b89/c432d0b89b271194d7e3c72a96f4a458.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/454/485/de1/454485de13be106ba6733352efa8c249.jpg"></div><br><h2>  Recommended tools </h2><br><ul><li>  Soldering iron ( <em>it is worth choosing a <a href="https://www.banggood.com/MINI-TS100-Digital-OLED-Programmable-Interface-DC-5525-Soldering-Iron-Station-Built-in-STM32-Chip-p-984214.html">good one</a> , but <a href="https://www.banggood.com/YIHUA-908D-220V-LED-Digital-Display-Soldering-Station-Soldering-Iron-Kit-p-1059873.html">cheap</a> work can do it</em> ) </li><li>  Solder ( <em><a href="https://www.banggood.com/100g-0_7mm-6040-Tin-Lead-Soldering-Wire-Reel-Solder-Rosin-Core-p-1025802.html">with rosin 60/40</a> - it is easy to work with it, although it is harmful to the environment</em> .) <br></li><li>  <a href="https://www.banggood.com/Soloop-328pcs-21-Polyolefin-Halogen-Free-Heat-Shrink-Tube-Sleeving-5-Color-8-Size-p-969574.html">Shrink tube</a> ( <em>and industrial hair dryer, hair dryer or cigarette lighter</em> ) or <a href="https://www.banggood.com/3M-Electrical-Insulating-Tape-Household-Electrical-Adhesive-Tape-p-931869.html">electrical tape</a> <br></li><li>  <a href="https://www.banggood.com/Electric-20W-Hot-Melt-Art-Craft-Glue-Gun-with-50Pcs-Free-Mini-Clear-Glue-Sticks-p-1084022.html">Glue gun</a> ( <em>and rods to it</em> ), or some kind of <a href="https://www.banggood.com/60g-Rapid-Curing-Epoxy-Adhesive-Quick-Drying-AB-Resin-Hardener-Material-Universal-Glue-p-1329144.html">epoxy resin</a> <br></li><li>  <a href="https://www.banggood.com/BSIDE-ADM08A-6000-Counts-True-RMS-Digital-Multimeter-p-1071663.html">Multimeter</a> <br></li><li>  <a href="https://www.banggood.com/Multifunctional-Durable-Multifunction-Handle-Tool-Wire-Stripper-Stripping-Pliers-p-983170.html">Wire cutters / pliers for stripping wires</a> , or just scissors if you need to save. </li></ul><br><h2>  Software </h2><br><ul><li>  <a href="https://www.arduino.cc/en/main/software" rel="external nofollow">Arduino IDE</a> for programming the Arduino processor </li><li>  To create a controller that appears as a real USB hardware controller / joystick: <br><ul><li>  <a href="https://www.microchip.com/developmenttools/ProductDetails/FLIP" rel="external nofollow">FLIP</a> for flashing new firmware to Arduino USB controller </li><li>  <a href="https://github.com/harlequin-tech/arduino-usb" rel="external nofollow">Arduino-usb</a> library on github </li></ul></li><li>  To create a controller with which the game communicates directly ( <em>or which is displayed as a virtual USB controller / joystick</em> ) <ul><li>  My library <a href="https://github.com/hodgman/ois_protocol" rel="external nofollow">ois_protocol</a> on github <br></li><li>  <a href="http://vjoystick.sourceforge.net/site/" rel="external nofollow">VJoy driver</a> if you want to use the controller as a virtual USB controller / joystick. </li></ul></li></ul><br><h2>  A warning </h2><br>  I studied electronics in high school, learned to use a soldering iron, learned that the red wires need to be connected with the red ones, and the black wires with the black ones ... Volts, amps, resistance and the equations connecting them - that's all that my formal electronics training has been exhausted. <br><br>  For me it was a learning project, so it may have bad tips or mistakes! <br><br><h1>  Part 1. Putting the controller! </h1><br><h2>  We work with switches without documentation ... </h2><br>  As mentioned above, I buy cheap parts from a low-margin retailer, so the first step is to figure out how these switches / buttons work. <br><br><h3>  Simple two-prong button / switch </h3><br>  Everything is simple with a button - there are no LEDs in it and only two contacts.  We switch the multimeter to continuity mode / dialing ( <img src="https://habrastorage.org/getpro/habr/post_images/628/15d/e9f/62815de9fa4516b533fa2a44197455da.gif">  ) and touch the probes of different contacts ‚Äî the OL will be displayed on the screen (open loop): this means that there is no connection between the two probes.  Then press the button, still touching the contact probes - something like 0.1Œ© should now appear on the screen and the multimeter will begin to squeak ( <em>indicating that there is a very low resistance between the probes - a closed circuit</em> ). <br><br>  Now we know that when the button is pressed, the circuit closes, and when it is released, it opens.  In the diagram, this can be described as a simple switch: <img src="https://habrastorage.org/getpro/habr/post_images/ff1/078/8d9/ff10788d996450509595baba45cad58e.png"><br><br><h2>  Connect the switch to the Arduino </h2><br>  Find two pins on the Arduino: labeled GND and labeled ‚Äú2‚Äù (or any other arbitrary number ‚Äî these are general-purpose I / O pins that we can manage through the software). <br><br>  If we connect the switch in this way, and then order the Arduino to configure contact ‚Äú2‚Äù as an INPUT contact, we get the circuit shown on the left (in the figure below).  When the button is pressed, contact 2 will directly connect to ground / 0V, and when released, contact 2 will not be connected to anything.  This state ( <em>not connected to anything</em> ) is called ‚Äúfloating‚Äù (a state with high impedance) and, unfortunately, it is not a very good state for our purposes.  When we read data from a contact in the software ( <em>using digitalRead (2)</em> ), we get LOW if the contact is grounded, and an unpredictable result (LOW or HIGH) if the contact is in the floating state! <br><br>  To fix this, we can configure the contact to be in INPUT_PULLUP mode, which connects to a resistor inside the processor and creates the circuit shown on the right.  In this circuit, with the switch open, contact 2 has a path to + 5V, so when it is read, the result will always be HIGH.  When the switch is closed, the contact will still have a path with high resistance to + 5V, as well as a path without resistance to ground / 0V, which ‚Äúwins‚Äù, due to which we get LOW when reading the contact. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/450/a26/fa9/450a26fa93dae881e4f2aca3f68d52ad.png"></div><br>  For software developers, the order may seem to be the reverse - when we press a button, we read false / LOW, and when it is released, true / HIGH. <br><br>  You can do the opposite, but the processor has only built-in pull-up resistors and there are no drag-down resistors, so we will stick to this model. <br><br>  The simplest program for Arduino, which reads the state of the switch and informs the PC about its state, looks something like the one shown below.  You can click the download button in the Arduino IDE, and then open the Serial Monitor (in the Tools menu) to see the results. <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); pinMode(<span class="hljs-number"><span class="hljs-number">2</span></span>, INPUT_PULLUP); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> state = digitalRead(pin); Serial.println( state == HIGH ? <span class="hljs-string"><span class="hljs-string">"Released"</span></span> : <span class="hljs-string"><span class="hljs-string">"Pressed"</span></span> ); delay(<span class="hljs-number"><span class="hljs-number">100</span></span>);<span class="hljs-comment"><span class="hljs-comment">//artifically reduce the loop rate so the output is at a human readable rate... }</span></span></code> </pre> <br><h2>  Other switches almost without documentation ... </h2><br><h3>  Three-pin LED switch </h3><br>  Fortunately, on the main switches of my panel there are marks of three contacts: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/43a/9c1/8e7/43a9c18e7e7c13e8ce02744fe8320bb6.jpg"></div><br>  I'm not completely sure how it works, so we will switch the multimeter to continuity mode again and touch all contact pairs with the switch turned on and off ... however, this time the multimeter does not squeak when we touch the [GND] and [+] probes with On "switch!  The only configuration in which the multimeter beeps ( <em>detects a connection</em> ) is when the switch is on, and the probes are on [+] and [lamp]. <br><br>  The LED inside the switch blocks the measurement of continuity, so from the checks made above, we can assume that the LED is connected directly to the [GND] contact, and not to the [+] and [lamp] contacts.  Next we switch the multimeter to the diode test mode (symbol <img src="https://habrastorage.org/getpro/habr/post_images/aa4/e65/abe/aa4e65abeb894a55aa7074cbb67543aa.jpg">  ) and check the pairs of contacts again, but this time the polarity is important ( <em>red and black probe</em> ).  Now, if we connect the red probe with [lamp], and the black one with [GND], the LED will light up, and 2.25V will be displayed on the multimeter.  This is the direct voltage of the diode, or the minimum voltage required to turn it on.  Regardless of the position of the switch, 2.25V from [lamp] to [GND] causes the LED to light up.  If we connect the red probe with [+], and the black one with [GND], the LED will light up only when the switch is on. <br><br>  From these readings, we can assume that the insides of this switch look something like the diagram below: <br><br><ol><li>  [+] and [lamp] are short-circuited when the switch is on / closed. <br></li><li>  A positive voltage from [lamp] to [GND] always lights the LED. <br></li><li>  A positive voltage from [+] to [GND] lights the LED only when the switch is on / closed. </li></ol><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bd6/34a/728/bd634a728856e82e71eecafa5d42d8a4.png"></div><br>  Honestly, the presence of a resistor here can only be guessed.  The LED <strong>must</strong> be connected to the appropriate resistor to limit the current supplied to it, or it will burn.  Mine is not burned and looks like it is working properly.  On the seller‚Äôs website forum, I found a post that talks about an installed resistor that supports operation up to 12 V, and this saved me time to check / calculate a suitable resistor. <br><br><h3>  Connect the switch to the Arduino </h3><br>  The easiest way to use the switch is with the Arduino, ignoring the [lamp] contact: connect [GND] to GND in Arduino and connect [+] with one of the numbered Arduino contacts, for example, 3. <br><br>  If we configure pin 3 as INPUT_PULLUP ( <em>as well as for the previous button</em> ), we arrive at the result shown below.  At the top left is the value that we will receive by executing ‚ÄúdigitalRead (3)‚Äù in the Arduino code. <br><br>  When the switch is on / closed, we read LOW and the LED lights up!  To use this switch in this configuration, we can use the same Arduino code as in the button example. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fd5/cc5/8ba/fd5cc58ba50f376abbd42806718b0f92.png"></div><br><h3>  Problems of this decision </h3><br>  After connecting to the Arduino, the complete chain looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/92c/305/f91/92c305f91bf0cf6fac213e2eba1db65e.png"></div><br>  However, here we can see that when the switch is closed, in addition to a small current limiting resistor in front of the LED (I assume that its resistance is 100 Ohms), there is also a pull-up resistor of 20 kŒ©, which further reduces the amount of current flowing through the LED.  This means that while the circuit is working, the LED will not be very bright. <br><br>  Another drawback of this scheme is that we do not have software control over the LED ‚Äî it is turned on when the switch is on and turned off otherwise. <br><br>  You can see what happens if we connect the [lamp] contact to either 0V or + 5V. <br><br>  If [lamp] is connected to 0V, then the LED is always off ( <em>regardless of the position of the switch</em> ), and the recognition of the position of the Arduino still runs.  This allows us to disable the LED programmatically if you wish! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a55/de7/6d3/a55de76d395358050d3c96139e47df73.png"></div><br>  If [lamp] is connected to + 5V, then the LED is always on ( <em>regardless of the position of the switch</em> ), <strong>but the</strong> position recognition of the Arduino is broken - HIGH will always be read from the contact. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/310/ea5/4a8/310ea54a861f7f89bc624261abd71ce5.png"></div><br><h3>  We connect this switch to the Arduino correctly </h3><br>  We can overcome the limitations described above ( <em>low current / brightness of the LED and the lack of software control over the LED</em> ) by writing more code!  To resolve the conflict between the ability to control the LED and the position recognition broken because of it, we can divide two tasks in time, that is, temporarily turn off the LED when reading the sensor contact (3). <br><br>  First, we connect the [lamp] contact to another general-purpose Arduino contact, for example, 4, so that the lamp can be controlled. <br><br>  To create a program that will correctly read the switch position and control the LED (we will make it blink), we just need to turn off the LED before reading the switch state.  The LED will turn off for only a fraction of a millisecond, so the flicker should not be noticeable: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pinSwitch = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pinLed = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//connect to the PC Serial.begin(9600); //connect our switch's [+] connector to a digital sensor, and to +5V through a large resistor pinMode(pinSwitch, INPUT_PULLUP); //connect our switch's [lamp] connector to 0V or +5V directly pinMode(pinLed, OUTPUT); } void loop() { int lampOn = (millis()&gt;&gt;8)&amp;1;//make a variable that alternates between 0 and 1 over time digitalWrite(pinLed, LOW);//connect our [lamp] to +0V so the read is clean int state = digitalRead(pinSwitch); if( lampOn ) digitalWrite(pinLed, HIGH);//connect our [lamp] to +5V Serial.println(state);//report the switch state to the PC }</span></span></code> </pre> <br>  In Arduino Mega, pins 2-13 and 44-46 can use the analogWrite function, which actually does not create voltages from 0V to + 5V, but approximates it with a square wave.  If desired, you can use it to control the brightness of the LED!  This code will make the light pulsate, not just flicker: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lampState = (millis()&gt;&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>)&amp;<span class="hljs-number"><span class="hljs-number">0xFF</span></span>;<span class="hljs-comment"><span class="hljs-comment">//make a variable that alternates between 0 and 255 over time digitalWrite(pinLed, LOW);//connect our [lamp] to +0V so the read is clean int state = digitalRead(pinSwitch); if( lampState &gt; 0 ) analogWrite(pinLed, lampState); }</span></span></code> </pre> <br><h2>  Build Tips </h2><br>  The post is already quite large, so I will not add another tutorial on soldering, you can google it! <br><br>  However, I will give the most basic tips: <br><br><ul><li>  When connecting wires with large metal contacts, first make sure that the soldering iron is heated and for some time heat and metal contact.  The point of soldering is to form a permanent joint by creating an alloy, but if only one part of the joint is hot, then you can easily get a ‚Äúcold joint‚Äù that looks like a joint but is not really connected. <br></li><li>  When connecting two wires, <i>first</i> put one piece of heat shrink tubing on one of them - after connecting the tube, you will not be able to put on the tube.  This seems obvious, but I constantly forget about it and I have to use tape instead of a tube ... Pull the shrink tube away from the connection so that it does not heat up ahead of time.  After checking the solder joint, slide the tube onto it and heat it. <br></li><li>  Thin small connecting wires, which I mentioned at the beginning, are well suited for solderless connections (for example, when connected to an Arduino!), But rather fragile.  After soldering, use a glue gun to fix them and eliminate all stresses from the connection itself.  For example, the red wires in the picture below can be accidentally pulled while working, so after soldering I fixed them with a drop of hot glue: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a0d/fa0/1d4/a0dfa01d48145b489d680cc6e7f43bc8.jpg"></div></li></ul><br><h1>  Part 2. Turn the device into a game controller! </h1><br>  In order for the OS to recognize the device as a USB gaming controller, you need a fairly simple code, but, unfortunately, you also need to replace the firmware of the Arduino USB chip with another, which can be taken here: <a href="https://github.com/harlequin-tech/arduino-usb" rel="external nofollow">https://github.com/harlequin-tech/arduino-usb</a> . <br><br>  But after uploading this firmware to the Arduino, the device becomes a USB joystick and ceases to be an Arduino.  Therefore, to reprogram it, you need to re-flash the original Arduino firmware.  These iterations are quite painful - load the Arduino code, flash the joystick firmware, test, flash the arduino firmware, repeat ... <br><br>  An example program for Arduino that can be used with this firmware is shown below ‚Äî it configures three buttons as inputs, reads their values, copies the values ‚Äã‚Äãinto the data structure expected by this firmware, and then sends the data.  Wash off, lather, repeat. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// define DEBUG if you want to inspect the output in the Serial Monitor // don't define DEBUG if you're ready to use the custom firmware #define DEBUG //Say we've got three buttons, connected to GND and pins 2/3/4 int pinButton1 = 2; int pinButton2 = 3; int pinButton3 = 4; void setup() { //configure our button's pins properly pinMode(pinButton1, INPUT_PULLUP); pinMode(pinButton2, INPUT_PULLUP); pinMode(pinButton3, INPUT_PULLUP); #if defined DEBUG Serial.begin(9600); #else Serial.begin(115200);//The data rate expected by the custom USB firmware delay(200); #endif } //The structure expected by the custom USB firmware #define NUM_BUTTONS 40 #define NUM_AXES 8 // 8 axes, X, Y, Z, etc typedef struct joyReport_t { int16_t axis[NUM_AXES]; uint8_t button[(NUM_BUTTONS+7)/8]; // 8 buttons per byte } joyReport_t; void sendJoyReport(struct joyReport_t *report) { #ifndef DEBUG Serial.write((uint8_t *)report, sizeof(joyReport_t));//send our data to the custom USB firmware #else // dump human readable output for debugging for (uint8_t ind=0; ind&lt;NUM_AXES; ind++) { Serial.print("axis["); Serial.print(ind); Serial.print("]= "); Serial.print(report-&gt;axis[ind]); Serial.print(" "); } Serial.println(); for (uint8_t ind=0; ind&lt;NUM_BUTTONS/8; ind++) { Serial.print("button["); Serial.print(ind); Serial.print("]= "); Serial.print(report-&gt;button[ind], HEX); Serial.print(" "); } Serial.println(); #endif } joyReport_t joyReport = {}; void loop() { //check if our buttons are pressed: bool button1 = LOW == digitalRead( pinButton1 ); bool button2 = LOW == digitalRead( pinButton2 ); bool button3 = LOW == digitalRead( pinButton3 ); //write the data into the structure joyReport.button[0] = (button1?0x01:0) | (button2?0x02:0) | (button3?0x03:0); //send it to the firmware sendJoyReport(joyReport) }</span></span></code> </pre> <br><h1>  Part 3. Integrating the device with your own game! </h1><br>  If you have control over the game with which the device should interact, then as an alternative, you can communicate with the controller directly - there is no need to make it visible to the OS as a joystick!  At the beginning of the post, I mentioned Objects In Space;  This approach was used by its developers.  They created a simple communication ASCII protocol that allows the controller and the game to communicate with each other.  It is enough to list the serial ports of the system ( <em>they are also COM ports in Windows; by the way, <a href="" rel="external nofollow">look at how awful it looks in C</a></em> ), find the port to which the device called ‚ÄúArduino‚Äù is connected, and start reading / writing ASCII via this link. <br><br>  On the Arduino side, we simply use the Serial.print functions that were used in the examples shown above. <br><br>  At the beginning of this post, I also mentioned my library for this task: <a href="https://github.com/hodgman/ois_protocol" rel="external nofollow">https://github.com/hodgman/ois_protocol</a> . <br><br>  It contains C ++ code that can be integrated into the game and used as a ‚Äúserver‚Äù, and Arduino code that can be executed in the controller to use as a ‚Äúclient‚Äù. <br><br><h2>  Customize Arduino </h2><br>  In <a href="" rel="external nofollow">example_hardware.h,</a> I created classes to abstract individual buttons / switches;  for example, ‚ÄúSwitch‚Äù is a simple button from the first example., and ‚ÄúLedSwitch2Pin‚Äù is a switch with a controlled LED from the second example. <br><br>  The sample code for my button bar is in <a href="" rel="external nofollow">example.ino</a> . <br><br>  As a small example, let's assume that we have a single button that needs to be sent to the game, and one game-controlled LED.  The required Arduino code looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ois_protocol.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//instantiate the library OisState ois; //inputs are values that the game will send to the controller struct { OisNumericInput myLedInput{"Lamp", Number}; } inputs; //outputs are values the controller will send to the game struct { OisNumericOutput myButtonOutput{"Button", Boolean}; } outputs; //commands are named events that the controller will send to the game struct { OisCommand quitCommand{"Quit"}; } commands; int pinButton = 2; int pinLed = 3; void setup() { ois_setup_structs(ois, "My Controller", 1337, 42, commands, inputs, outputs); pinMode(pinButton, INPUT_PULLUP); pinMode(pinLed, OUTPUT); } void loop() { //read our button, send it to the game: bool buttonPressed = LOW == digitalRead(pin); ois_set(ois, outputs.myButtonOutput, buttonPressed); //read the LED value from the game, write it to the LED pin: analogWrite(pinLed, inputs.myLedInput.value); //example command / event: if( millis() &gt; 60 * 1000 )//if 60 seconds has passed, tell the game to quit ois_execute(ois, commands.quitCommand); //run the library code (communicates with the game) ois_loop(ois); }</span></span></span></span></code> </pre> <br><h2>  Customize the game </h2><br>  The game code is written in the style of "single header".  To import the library, we include into the game <a href="" rel="external nofollow">oisdevice.h</a> . <br><br>  In a single CPP file, before executing the #include header, we will write #define OIS_DEVICE_IMPL and #define OIS_SERIALPORT_IMPL - this will add the source code of the classes to the CPP file.  If you have your own statements, logging, strings or vectors, then there are several other OIS_ * macros that can be defined before importing a header to take advantage of the engine. <br><br>  You can use the following code to list the COM ports and create a connection with a specific device: <br><br><pre> <code class="cpp hljs">OIS_PORT_LIST portList; OIS_STRING_BUILDER sb; SerialPort::EnumerateSerialPorts(portList, sb, <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> it = portList.begin(); it != portList.end(); ++it ) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> label = it-&gt;name + <span class="hljs-string"><span class="hljs-string">'('</span></span> + it-&gt;path + <span class="hljs-string"><span class="hljs-string">')'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-comment"><span class="hljs-comment">/*device selection choice*/</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> gameVersion = <span class="hljs-number"><span class="hljs-number">1</span></span>; OisDevice* device = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OisDevice(it-&gt;id, it-&gt;path, it-&gt;name, gameVersion, <span class="hljs-string"><span class="hljs-string">"Game Title"</span></span>); ... } }</code> </pre> <br>  After receiving an OisDevice instance, you should regularly call its Poll member function (for example, in each frame), you can get the current state of the controller's output using DeviceOutputs (), use device events using PopEvents (), and send values ‚Äã‚Äãto the device using SetInput (). <br><br>  An example of an application doing all this can be found here: <a href="" rel="external nofollow">example_ois2vjoy / main.cpp</a> . <br><br><h1>  Part 4. What if I want parts 2 and 3 at the same time? </h1><br>  In order for the controller to work in other games (part 2), you need to install your own firmware and one Arduino program, but in order for the controller to be fully programmed by the game, we used the standard Arduino firmware and another Arduino program.  But what if we want both possibilities at the same time? <br><br>  An example of the application to which I gave the link above ( <a href="https://github.com/hodgman/ois_protocol/tree/master/serial_host_cpp/example_ois2vjoy" rel="external nofollow">ois2vjoy</a> ) solves this problem. <br><br>  This application communicates with the OIS device (program from part 3), and then on the PC converts this data into ordinary controller / joystick data, which is then transmitted to the <em>virtual</em> controller / joystick device.  This means that you can allow your controller to constantly use the OIS library (no other firmware is required), and if we want to use it as a normal controller / joystick, then just run the ois2vjoy application on the PC that performs the conversion. <br><br><h1>  Part 5. Completion </h1><br>  I hope someone this article seemed useful or interesting.  Thank you for reading to the end! <br><br>  If you are curious, then I invite you to participate in the development of the <a href="https://github.com/hodgman/ois_protocol" rel="external nofollow">ois_protocol</a> library!  I think it would be great to develop a single protocol to support all sorts of self-made controllers in games and encourage the games to directly support self-made controllers! </div><p>Source: <a href="https://habr.com/ru/post/442816/">https://habr.com/ru/post/442816/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442806/index.html">The preliminary program DUMP-2019 is ready. Speakers from Evil Martians, Tinkoff.ru, HTML Academy, SkyEng, 2GIS</a></li>
<li><a href="../442808/index.html">We invite you to the Droid Party - a meeting dedicated to the practical issues of developing Android applications and devices</a></li>
<li><a href="../442810/index.html">Myths of popular physics, continued: Gravity</a></li>
<li><a href="../442812/index.html">‚ÄúI don‚Äôt see any reason to use Python to work with Spark, except for laziness‚Äù</a></li>
<li><a href="../442814/index.html">10 years have passed, and no one has figured out how to use the blockchain. And here again?</a></li>
<li><a href="../442818/index.html">10 common mistakes in writing English and how to deal with them</a></li>
<li><a href="../442822/index.html">Data center at sea and in orbit: do they have practical meaning?</a></li>
<li><a href="../442824/index.html">Welcome to Silicon Valley</a></li>
<li><a href="../442826/index.html">Social engineering as dramaturgy, or what is common to a phishing domain and "Chekhov's gun"</a></li>
<li><a href="../442828/index.html">Hitch-free IT management</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>