<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another article about indexing ajax sites by search engines</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Stylish, fashionable, youth today to make a site on AJAX, from the user's point of view, this is fast and convenient, and search engines with such sit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another article about indexing ajax sites by search engines</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d04/8df/920/d048df92092f40f1b1988bfd499a6b1c.jpg" alt="image"><br><br>  Stylish, fashionable, youth today to make a site on AJAX, from the user's point of view, this is fast and convenient, and search engines with such sites may have problems. <a name="habracut"></a><br><br>  The most correct solution is to use regular links, but load the content with ajax, leaving the opportunity to get content via a regular link for users with JS (it isn‚Äôt) disabled and robots disabled.  That is, you need to develop it in the old way, with regular links, layout and view-shki, then you can handle all the javascript links, hang content loading via ajax on them using a link from the href attribute, a tag, in a very simplified form should look something like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs">$(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-string"><span class="hljs-string">'a.ajaxlinks'</span></span>, <span class="hljs-string"><span class="hljs-string">'function(e) { e.stopPropagation(); e.preventDefault(); var pageurl = $(this).attr('</span></span>href<span class="hljs-string"><span class="hljs-string">'); $.ajax({ url: pageurl, data: { ajax: 1 }, success: function( resp ) { $('</span></span>#content<span class="hljs-string"><span class="hljs-string">').html(resp); } }); });</span></span></code> </pre> <br>  Here we simply load the same pages, but with ajax, while on the backend you need to process the special GET parameter ajax and, if available, give the page without a layout, well, if it is rough. <br><br>  But the architecture is not always designed for this, besides, sites on angularjs, and others like it, work somewhat harder, and substitute content on the uploaded html template with variables.  For such sites (or you can already call them applications), the search engines invented the HashBang technology, in short, this is a link of the form <a href="http://example.com/">example.com/#!/cats/grumpy-cat</a> , when the search robot sees #!  he makes a request to the server at <a href="http://example.com/%3F_escaped_fragment_%3D/cats/grumpy-cat">example.com/?_escaped_fragment_=/cats/grumpy-cat</a> , i.e.  replaces "#!" with "? _escaped_fragment_ =", and the server should give the generated html search engine identical to the one that the user would see from the original link.  But if the application uses the HTML5 History API, and links like #! Do not apply, you need to add a special meta tag to the head section: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fragment"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  At the sight of this tag, the search robot will understand that the site is powered by ajax, and will redirect all requests for receiving site content to the link: <a href="http://example.com/%3F_escaped_fragment_%3D/cats/grumpy-cat">example.com/?_escaped_fragment_=/cats/grumpy-cat</a> instead of <a href="http://example.com/cats/grumpy-cat">example.com/cats/grumpy- cat</a> . <br><br>  You can handle these requests using the framework used, but in a complex application with angularjs, this is a bunch of extra code. <br><br>  The way we go is described in the following scheme from Google: <br><img src="https://habrastorage.org/getpro/habr/post_images/a8b/295/481/a8b295481bdf4f569241f0b143ee13d2.png" alt="image"><br><br>  To do this, we will catch all requests from _escaped_fragment_ and send them to phantom.js on the server, which will generate html-impressions of the requested page using server-side webkit tools and give it to the crawler.  Users will remain working directly. <br><br>  First, install the necessary software, if not installed yet, like this: <br><pre> <code class="bash hljs">yum install screen npm instamm phantomjs ln -s /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/node_modules/phantomjs/lib/phantom/bin/phantomjs /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/phantomjs</code> </pre><br>  Next, write (well, or take ready) server-side js-script (server.js), which will make html-snapshots: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> system = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'system'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (system.args.length &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Missing arguments."</span></span>); phantom.exit(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> server = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webserver'</span></span>).create(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(system.args[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> urlPrefix = system.args[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parse_qs = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">s</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queryString = {}; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"a"</span></span>); a.href = s; a.search.replace( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(<span class="hljs-string"><span class="hljs-string">"([^?=&amp;]+)(=([^&amp;]*))?"</span></span>, <span class="hljs-string"><span class="hljs-string">"g"</span></span>), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span></span><span class="hljs-function">) </span></span>{ queryString[$<span class="hljs-number"><span class="hljs-number">1</span></span>] = $<span class="hljs-number"><span class="hljs-number">3</span></span>; } ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> queryString; }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> renderHtml = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, cb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> page = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).create(); page.settings.loadImages = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; page.settings.localToRemoteUrlAccessEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; page.onCallback = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ cb(page.content); page.close(); }; <span class="hljs-comment"><span class="hljs-comment">// page.onConsoleMessage = function(msg, lineNum, sourceId) { // console.log('CONSOLE: ' + msg + ' (from line #' + lineNum + ' in "' + sourceId + '")'); // }; page.onInitialized = function() { page.evaluate(function() { setTimeout(function() { window.callPhantom(); }, 10000); }); }; page.open(url); }; server.listen(port, function (request, response) { var route = parse_qs(request.url)._escaped_fragment_; // var url = urlPrefix // + '/' + request.url.slice(1, request.url.indexOf('?')) // + (route ? decodeURIComponent(route) : ''); var url = urlPrefix + '/' + request.url; renderHtml(url, function(html) { response.statusCode = 200; response.write(html); response.close(); }); }); console.log('Listening on ' + port + '...'); console.log('Press Ctrl+C to stop.');</span></span></code> </pre><br>  And run it in the <a href="http://help.ubuntu.ru/wiki/screen">screenshot</a> using <a href="http://phantomjs.org/">phantomjs</a> : <br><pre> <code class="bash hljs">screen -d -m phantomjs --disk-cache=no server.js 8888 http://example.com</code> </pre><br>  Next, we configure nginx (apache in a similar way) to proxy requests to the running daemon: <br><pre> <code class="bash hljs">server { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ~ <span class="hljs-string"><span class="hljs-string">"_escaped_fragment_=(.+)"</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$real_url</span></span> <span class="hljs-variable"><span class="hljs-variable">$1</span></span>; rewrite ^ /crawler<span class="hljs-variable"><span class="hljs-variable">$real_url</span></span>; } location ^~ /crawler { proxy_pass http://127.0.0.1:8888/<span class="hljs-variable"><span class="hljs-variable">$real_url</span></span>; } ... }</code> </pre><br>  Now when you request <a href="http://example.com/cats/grumpy-cat">example.com/cats/grumpy-cat,</a> search robots will contact the link <a href="http://example.com/%3F_escaped_fragment_%3Dcats/grumpy-cat">example.com/?_escaped_fragment_=cats/grumpy-cat</a> , which will be intercepted by nginx, will be sent to phantomjs, which will generate html on the server through the browser engine. and give it to the robot. <br><br>  In addition to Google, Yandex and Bing search robots, this will also work for sharing the link via facebook. <br><br>  References: <br>  <a href="https://developers.google.com/webmasters/ajax-crawling/docs/getting-started">https://developers.google.com/webmasters/ajax-crawling/docs/getting-started</a> <br>  <a href="">https://help.yandex.ru/webmaster/robot-workings/ajax-indexing.xml</a> <br><br>  <b>UPD (12/2/16)</b> : <br>  Configs for apache2 from <a href="https://habrahabr.ru/users/kot-ezhva/" class="user_link">kot-ezhva</a> : <br><br>  In case of using html5mode: <br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">RewriteEngine</span></span></span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span> RewriteCond <span class="hljs-variable"><span class="hljs-variable">%{QUERY_STRING}</span></span> (.*)_escaped_fragment_= RewriteRule ^(.*) 127.0.0.1:8888/<span class="hljs-number"><span class="hljs-number">$1</span></span><span class="hljs-meta"><span class="hljs-meta"> [P] ProxyPassReverse / 127.0.0.1:8888/</span></span></code> </pre><br>  If URLs with a grid: <br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">RewriteEngine</span></span></span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span> RewriteCond <span class="hljs-variable"><span class="hljs-variable">%{QUERY_STRING}</span></span> _escaped_fragment_=(.*) RewriteRule ^(.*) 127.0.0.1:8888/<span class="hljs-number"><span class="hljs-number">$1</span></span><span class="hljs-meta"><span class="hljs-meta"> [P] ProxyPassReverse / 127.0.0.1:8888/</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/254213/">https://habr.com/ru/post/254213/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254203/index.html">Clearing HTML tags from attributes</a></li>
<li><a href="../254205/index.html">TLS decryption of Java application traffic using logs</a></li>
<li><a href="../254207/index.html">English company blames Facebook for using its proprietary data center project for the Open Compute Project</a></li>
<li><a href="../254209/index.html">What answers do I expect at the testing interview?</a></li>
<li><a href="../254211/index.html">Long live fragrant soap, or how to fix improper scaling of Windows programs</a></li>
<li><a href="../254215/index.html">10 tips on prototyping in Sketch</a></li>
<li><a href="../254217/index.html">No anonymity</a></li>
<li><a href="../254221/index.html">MMORPG without too much detail: a year later</a></li>
<li><a href="../254223/index.html">About the effect of the applet on the iPhone in the LTE network</a></li>
<li><a href="../254227/index.html">Ban on bitcoin in Russia this fall?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>