<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of an external battery on four LiFePO4 batteries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Simplified diagram BQ40Z50-R1 

 External batteries (power banks) are actively used to charge smartphones and other mobile gadgets. This device is sim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of an external battery on four LiFePO4 batteries</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/lu/xt/1n/luxt1n81ms84ovom69egdejgse4.png"><br>  <i>Simplified diagram BQ40Z50-R1</i> <br><br>  External batteries (power banks) are actively used to charge smartphones and other mobile gadgets.  This device is simple in structure: lithium-ion or lithium-polymer batteries, control circuit board, housing.  But by itself, the development of charging circuits for external batteries and electric vehicles is not so simple, here you can experiment and propose new solutions. <br><br>  Within one project, we developed an external battery with support for normal and fast charging, including solar batteries.  Another requirement is to minimize the dimensions of the device.  At the first stage, we implemented the usual charging of four identical LiFePO4 batteries at the expense of the microcontroller and the BQ40Z50-R1 charge manager, without using a specialized charge chip and PWM.  In addition to the charge, the microcontroller beautifully controls the indicator LEDs and interacts with the user via BLE.  We share the details of this development stage. <br><a name="habracut"></a><br><h2>  Problem statement and solution </h2><br>  For chargers, one of the important parameters is the use of batteries with a certain type of chemistry.  Taking into account the fact that the LiFePO4 lithium-iron-phosphate battery has several advantages compared to other varieties (for example, the ability to charge a large current), it was chosen for the new charger. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Typically, the specified parameters of the battery is achieved through the use of several batteries of lower capacity and voltage.  The purpose of using batteries with a serial connection is to reduce losses, increase efficiency.  Usually in any system consisting of several series-connected batteries, there is the problem of unbalancing the charge of individual batteries.  This problem is solved by battery charge leveling - a design method that allows you to increase battery safety, battery life, and overall service life. <br><br>  To reduce the cost and size of the new charger, it was decided to use the BQ40Z50-R1 chip from Texas Instruments as a ‚Äúcharger‚Äù and ‚Äúbalancer‚Äù for four LiFePO4 batteries, despite the fact that this is a microcircuit - manager, not ‚Äúcharger‚Äù (t. E. It can control the parameters of voltage, current, etc., but not control the process of charge).  For details on the BQ40Z50-R1, see the <a href="http://www.ti.com/lit/ds/symlink/bq40z50-r1.pdf">technical specifications</a> and <a href="http://www.ti.com/lit/ug/">reference</a> . <br><br>  Battery parameters: <br><br><ul><li>  Rated voltage 3.2 V </li><li>  Maximum allowable voltage 3.65 V </li><li>  Rated charging current at full discharge 400 mA </li></ul><br>  To program the BQ40Z50-R1 chip, we used the specialized software package Battery Management Studio ( <a href="http://www.ti.com/tool/bqstudio">bqStudio</a> ) and <a href="http://www.ti.com/tool/EV2300">the EV2300 interface board</a> ‚Äî all of these are tools for developers from Texas Instruments.  The task of bqStudio is to generate the correct settings for the BQ40Z50-R1 manager so that it ‚Äúbefriends‚Äù with the battery used. <br><br><h3>  Circuitry </h3><br>  As already noted, the BQ40Z50-R1 chip is a charging manager that is used to monitor battery charge / discharge parameters, as well as set up various battery charge / discharge algorithms depending on current parameters (for example, temperature, charge / discharge current, etc.) . <br><br>  Chip developers have provided the possibility of active charge mode and mode with current limit (Pre-charge), which is used when the battery is completely discharged.  The circuit design of the device does not change (see the <a href="http://www.ti.com/lit/ds/symlink/bq40z50-r1.pdf">specification</a> ).  It is only necessary to recalculate the current-limiting resistor in the Pre-charge circuit.  In our case, to charge the selected batteries, LiFePO4 needed a charging current of about 400 mA. <br><br><h3>  Setting up the chip BQ40Z50-R1 </h3><br>  The BQ40Z50-R1 is configured using the <a href="http://www.ti.com/tool/bqstudio">bqStudio</a> software package.  We use the SMB to USB converter to record the set parameters and communicate with the microcircuit: <br><br><img src="https://habrastorage.org/webt/wo/zj/sp/wozjspu7qm-mjzfcngm5iazzmtq.jpeg"><br>  <i>EV2300 Programmer</i> <br><br>  We will not describe the connection itself, since  about him in detail in the technical specifications and reference.  As a result, the program should start as shown in the screenshot: <br><br><img src="https://habrastorage.org/webt/lt/qm/nm/ltqmnm0sckhwsr5t8vqlcviroty.png"><br>  <i>Interface of the Battery Management Studio program (bqStudio)</i> <br><br>  Let us tell you about the steps for setting up the BQ40Z50-R1: <br><br>  <b>1. Selecting a similar battery chemistry profile (Chemistry Programming)</b> <br><br>  When installing the program, the Chem.ini file is present in the package, which describes more than 1,000 types of batteries, different in chemical composition, capacity, number of cells, and other criteria.  Texas Instruments constantly updates the list of chemical parameters of batteries from various manufacturers.  But if the desired battery is not in the list - it doesn't matter, the chemistry parameters can be set manually.  In order for the charger to work correctly, you need to select the battery profile that is most suitable for development and click the Update Chemistry from Database button: <br><br><img src="https://habrastorage.org/webt/v_/gz/vv/v_gzvvlknqhfaa9u2yks56nvk8u.png"><br>  <i>BqStudio window interface to select chemistry profile</i> <br><br>  <b>2. Calibration</b> <br><br>  First of all, we report to bqStudio the current state of affairs, which requires measuring the real values: <br><br><ul><li>  battery voltage; </li><li>  voltage on the 1st cell; </li><li>  input voltage; </li><li>  current; </li><li>  temperature </li></ul><br>  Measured parameters are entered into the program and press the "Calibrate" button. <br><br>  <b>3. Settings</b> <br><br>  Then we connect the necessary functions: <br><br><ul><li>  on / off protection ( <b>Protection</b> ); </li><li>  thermistors ( <b>Temperature Enable / Mode</b> ); </li><li>  the mode of determining the charge and discharge of the battery ( <b>SOC Flag Config</b> ): by voltage or by capacity; </li><li>  the inclusion of balancing ( <b>Balancing configuration</b> ); </li><li>  enable / disable one-time protection ( <b>Fuse</b> ); </li><li>  enabling / disabling self-restoring protection ( <b>Protection</b> ); </li><li>  what should turn on automatically after power-up ( <b>Manufacturing</b> ) - the bits <b>FET_EN = 1</b> and <b>GAUGE_EN = 1</b> must be set. </li></ul><br>  <b>4. Advanced Charge Algorithm</b> <br><br>  This mode of operation is embedded in the BQ chip.  An external microcontroller can enable and use this mode to control charge current, voltage, and other charge parameters.  The BQ40Z50-R1 chip will carry out all measurements, analysis and calculation of the charge parameters required for the battery and send recommendations to the microcontroller on the SMBus bus.  BQ can also control external keys for switching modes and charging currents and protection.  To use this mode correctly, it is necessary to make a number of settings: currents, voltages for different temperature ranges, a sign of the end of charge, balancing. <br><br>  For the correct operation of this mode, we configure the following fields in the control program window: <br><br><ul><li>  The temperature at which the charge modes will switch ( <b>Temperature Range</b> ) </li><li>  Charge currents and voltages for the temperature ranges specified above ( <b>Low / Standart / High / Rec Temp Charging</b> ) </li><li>  <b>Pre-Charging</b> Current </li><li>  <b>Maintenance Charging</b> Current - to compensate for self-discharge </li><li>  Voltages ( <b>Voltage range</b> ), on which the following flags are set, they will be visible to the microcontroller in the Charging status register: <br>  <b>-</b> <b>PV</b> - Pre-charge mode <br>  <b>-</b> <b>LV</b> - low voltage <br>  <b>-</b> <b>MV</b> - average <br>  <b>-</b> <b>HV</b> - high </li></ul><br>  In our case, it was necessary to change the <b>Precharge Start Voltage</b> [2,14.4.8.1] parameters in the <b>Data Memory</b> settings to 2300 mV;  <b>Charging Voltage Low</b> [2,14.4.8.2] at 3500 mV;  <b>Charging Voltage Med</b> [2,14.4.8.1] at 3555 mV;  <b>Charging Voltage High</b> [2,14.4.8.1] at 3600 mV.  By default, the BQ40Z50-R1 already has automatic charge / discharge control, so it was necessary to only write the parameters of the chip by pressing Write_All.  At the end of the record in the status bar appears Successful. <br><br><img src="https://habrastorage.org/webt/o-/9x/hm/o-9xhmljivpotlaxqgsv0je1bas.png"><br>  <i>Data Memory menu in bqStudio software package</i> <br><br>  <b>5. Protection</b> <br><br>  Without setting the protection can not be: <br><br><ul><li>  We set the PCHGC-current protection register, at which the Pre-charge will be turned off for a specified time, if the current at this time exceeds the set threshold. </li><li>  We install protection for <b>Under voltage</b> and <b>Over voltage</b> (from the description on the battery). </li><li>  The remaining parameters are left by default. </li></ul><br>  <b>6. Charge Measurement (Gas Gauging)</b> <br><br>  Gas Gauging is a special feature of the BQ40Z50-R1 chip for calculating the current battery capacity and the remaining time until full charge or discharge. <br><br>  For the operation of this mode, we configure the most important of many installations: <br><br><ul><li>  <b>Design</b> - predicted values ‚Äã‚Äãof battery capacity and voltage </li><li>  <b>FD</b> - Voltage Levels or Full Discharge Capacities </li><li>  <b>TD</b> - voltage levels or capacitance to turn off the discharge </li><li>  <b>FC</b> - voltage levels or full charge capacity </li><li>  <b>TC</b> - Voltage or Capacity Levels to Disconnect Charge </li></ul><br>  Many parameters for this mode are taken from the battery database.  If the required battery is not in the database, you can pick up a similar one and carry out a full training cycle for the BQ40Z50-R1. <br><br>  The learning process for calculating battery capacity: <br><br><ol><li>  Fully discharge the battery and wait about 5 hours. </li><li>  Send the command <b>Enable</b> and <b>Reset</b> .  ( <b>Data Memory / Gas Gauging / State / Update Status</b> ).  In the <b>LStatus</b> registers <b>, the</b> status should be updated to <b>0x04</b> . </li><li> Charge the battery until the time in the <b>ChargeStatus</b> register of the FC (Full charge) status bit changes to ‚Äú1‚Äù.  Then you should wait about 2 hours.  <b>LStatus</b> should change to <b>0x05</b> .  Of course, you need to charge the battery by the method recommended by the battery manufacturer. </li><li>  Discharge to the C / 10 level and wait for about 5 hours ( <b>LStatus</b> should change to <b>0x06</b> ). </li><li>  Everything.  The learning cycle is completed. </li></ol><br>  After the learning cycle, BQ40Z50-R1 should correct the values ‚Äã‚Äãin <b>Qmax</b> and some other cells and allow the work of the balancing function during charging. <br><br><h2>  findings </h2><br>  The result is a "charger" with Pre-charge mode for charging the battery.  When the battery is completely discharged - the charging current is indeed about 400 mA, but over time the current drops as expected and by the end of the charge (reaching the nominal voltage) is about 50 mA. <br><br>  The total charge time in this case is 5-6 hours.  The capacity of the battery at the end of the charge is 80-90% of nominal.  If you do not need fast charging of several batteries, you need to minimize the cost of the charge chip and reduce the space on the board, then this is your option. </div><p>Source: <a href="https://habr.com/ru/post/350142/">https://habr.com/ru/post/350142/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350132/index.html">GObject: Inheritance and Interfaces</a></li>
<li><a href="../350134/index.html">DoctrineSolrBundle - Search by Solct-based Doctrine entity on Symfony2 / 3</a></li>
<li><a href="../350136/index.html">Random evolutionary strategies in machine learning</a></li>
<li><a href="../350138/index.html">How to whale eat java application and not choke</a></li>
<li><a href="../350140/index.html">Asynchronous work with PostgreSQL in C</a></li>
<li><a href="../350144/index.html">Richard Hamming: Chapter 29. You get what you measure</a></li>
<li><a href="../350148/index.html">Flask Mega-Tutorial, Part XIII: I18n and L10n (Edition 2018)</a></li>
<li><a href="../350152/index.html">We are testing the array of OceanStor Dorado V3: so ordinary that right at all</a></li>
<li><a href="../350154/index.html">ViyaDB: analytical database for unsorted data</a></li>
<li><a href="../350156/index.html">Learn OpenGL. Lesson 4.8 - Advanced GLSL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>