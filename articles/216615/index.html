<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cubieboard A10. Learning to control the system from a remote control</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 


 I decided to write an article about my experience with IR on Cubieboard. 

 Not so long ago, I ordered myself this wonderful device (...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cubieboard A10. Learning to control the system from a remote control</h1><div class="post__text post__text-html js-mediator-article">  Hello, Habr! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/550/9c1/902/5509c190236ea67b4fa42cd7a5cf9c42.png"><br>  I decided to write an article about my experience with IR on Cubieboard. <br><br>  Not so long ago, I ordered myself this wonderful device (I ordered it specifically for the future home server, and, therefore, only use the server OS on it). The choice fell on Cubian ( <a href="http://cubian.org/">http://cubian.org/</a> ) because it‚Äôs your own bike. do not want. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It was supposed to deploy on the cube nginx, php5, samba, mocd and several of its services to control the relay unit. <br>  During the study of the cube I decided to try to set up IR to receive commands from the console from the old TV tuner, I could not deploy the solution in the form of lirc, I began to look for other solutions, I did not find anything good. <br><br>  I wrote my decision, which I am sharing with you now. <br><a name="habracut"></a><br>  Initially, I wanted to get by with only bash, but I was not attracted to reread the device once a second or more / less often, why drive the processor into an empty one, heating the baby once more.  Then the solution came in the direction of php, since it will still be installed. <br><br>  Recently, I came across an <a href="http://habrahabr.ru/post/216211/">article</a> on Habr√©, my solution is close to the proposed @ ntfs1984, but not the same. <br>  So as I am not allowed to comment, I decided to play in the sandbox. <br><br>  Let's get started <br>  Initially, after installing the system, the device is not available, since the corresponding modules are not loaded, in the case of cubieboard a10 and cubian - this is the <b><i>sunxi_ir</i></b> module <br>  We check its loading by the <i>lsmod</i> command <br><img src="https://habrastorage.org/getpro/habr/post_images/4a9/24e/bd9/4a924ebd90120aaec6f4d12af39dd98d.png"><br>  I draw your attention, I execute all commands as <b>root</b> . <br>  By default, the system does not load this module; for manual loading, you can use the command: <br><pre><code class="bash hljs">modprobe sunxi_ir</code> </pre> <br>  If the module is launched successfully, <i>modprobe</i> will not say anything, but the cherished line will appear in the <i>lsmod</i> list.  Also an important factor to make sure that everything worked, you need to check whether the input device appeared: <br><img src="https://habrastorage.org/getpro/habr/post_images/b2b/bbf/baa/b2bbbfbaac0d7d951f0b92f724ce3d59.png"><br>  in my case it was <i>event1</i> <br>  the surest way to check whether this device is to do it <br><pre> <code class="bash hljs">cat /dev/input/event1 | hexdump</code> </pre>  (Stop the process can be [Ctrl] + [C]) <br>  hexdump displays data in a ‚Äúbeautiful‚Äù format, plus we can find out the code of the pressed button in the same way, but you can do without it. <br><img src="https://habrastorage.org/getpro/habr/post_images/675/d8d/437/675d8d437368429a9181caa8a0097797.png"><br>  For each button pressed we get four lines, the first couple of lines - the button on the remote was pressed ( <b>0090 0001</b> ), the second - the button was released ( <b>0090 0000</b> ).  You can get a lot of useful things from these lines, I didn‚Äôt go deep into it, but only paid attention to the button code (in the example, this is <i>0090</i> ).  But I can say that <i>532a</i> is the remote control code, if someone decides to tie the program to the console. <br>  If everything is the same, go to the next step - setting autoload <br><pre> <code class="bash hljs">nano /etc/modules</code> </pre> <br>  and add only one line at the end <br>  <i>sunxi_ir</i> <br>  This is the name of our module, which we downloaded above.  An example of my <i>modules</i> : <br><img src="https://habrastorage.org/getpro/habr/post_images/c11/c0e/7db/c11c0e7dbd5331b08be7ea900f4cccdb.png"><br>  Saved and left. <br><br>  So, the preparations for working with IR are over, now let's move on to the most important part, this is writing a program that can read the device and perform the necessary actions. <br>  We need a demon that will monitor the clicks, initially it was planned to follow somehow the device, and in the case of the pressed button - to perform.  Immediately I will say that I did not want to create an infinite loop that would check in a second whether the button was pressed on the remote or not.  I wanted to create such a program, which would work <i>only</i> by pressing, the rest of the time I was just dozing.  As a result, the idea of ‚Äã‚Äãworking with php files was born, when you can read the file bit by bit: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/php5 &lt;?php $dev="/dev/input/event1"; $f=fopen($dev, 'rb'); if($f){ while (!feof($f)){ $b=fread($f,32); //     64 , 32- ,  32 -  $d=bin2hex($b); // hex  $d=substr($d,18,8); //      $button=substr($d,0,4); // $key=substr($d,4); //0001  0000 switch($button){ case "0090": echo "POWER ".($key=="0001"?"down":"up")."\n"; } //  : /*if($key=="0001"){ if($button=="0090"){ //       } }else{ if($button=="0090"){ //       } } */ } } ?&gt;</span></span></code> </pre><br>  Save the file as <i>/ tmp / tst</i> <br>  Let the file be executable <br><pre> <code class="bash hljs">chmod +x /tmp/ts</code> </pre>  Run, check: <br><img src="https://habrastorage.org/getpro/habr/post_images/a07/9dc/52a/a079dc52a4c1be39de86535e39d29d03.png"><br>  Now, complicating the switch for each button, we get the processing of each button on the remote.  Well and, in fact, not to display ‚Äúempty‚Äù words, but to assign the necessary action. <br>  By slightly complicating the program, we get (/ usr / sbin / mylirc): <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/php5 &lt;?php function AccessFile($file,$access){ if(file_exists($file)){ // ! if($f=@fopen($file,$access)){fclose($f);}else{exit("not have access to $file\n");} }else{ return "$file not found (may not have access to the folder)\n"; } } $dev=""; $log=0; if(count($argv)==1){ exit("Use ".dirname( __FILE__ )."/".basename($_SERVER['SCRIPT_FILENAME'])." --device=device [--log=logfile]\n"); }else{ for($i=1;$i&lt;count($argv);$i++){ $cmd=explode("=",$argv[$i]); switch($cmd[0]){ case "--device": $dev=$cmd[1]; echo AccessFile($cmd[1],"rb"); break; case "--log": $log=$cmd[1]; echo AccessFile($cmd[1],"w"); break; } } } if($dev==""){ exit("Use ".dirname( __FILE__ )."/".basename($_SERVER['SCRIPT_FILENAME'])." --device=device [--log=logfile]\n"); } include("/etc/mylirc/buttom_avermedia.php"); if($log){exec("echo `date` &gt; $log");} $f=fopen($dev, 'rb'); if($f){ while (!feof($f)){ $b=fread($f,32); $d=bin2hex($b); $d=substr($d,18,8); $button =substr($d,0,4); $key =substr($d,4); $l=0; for($i=0;$i&lt;count($command);$i++){ if(trim($button)==trim($command[$i][1]) &amp;&amp; trim($key)==trim($command[$i][2])){ $l=1; if(trim($command[$i][3])!=""){ //  exec($command[$i][3]." &gt; /dev/null 2&gt;/dev/null &amp;"); }else{ //  ,     : if($log){exec("echo ".$command[$i][0]." ".$command[$i][1]." cmd=null &gt;&gt; $log");}// } } } if(!$l){ //  ,      : if($log){exec("echo not buttom $button $key &gt;&gt; $log");}// } } } ?&gt;</span></span></code> </pre><br>  The program writes logs if the corresponding parameter (- log) was passed and swears if the parameter --device is not passed <br>  Settings file (/etc/mylirc/buttom_avermedia.php): <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $command=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">//: //, , ,  $command[]=array("POWER", "00ff","0001","led green 1"); $command[]=array("POWER", "00ff","0000",""); $command[]=array("NUMB 1", "0005","0001","led green 0"); $command[]=array("NUMB 1", "0005","0000",""); //   </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  The program <i>led green 1 (0)</i> (this is my script on bash, which I put in / usr / sbin /) <br>  turned on and off a light bulb on a cube (green in the example), but you can execute any console command you wish.  Execution goes from root, accordingly, it will need to take this into account and lower privileges to the desired user if necessary. <br>  The program must be started at system startup as a daemon, so that you can start / stop / restart / check the operation of the program (/ usr / sbin / mylirc), which is based on the /etc/init.d/ssh script, rewritten and saved as /etc/init.d/01_lirc: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ### BEGIN INIT INFO # Provides: 01_lirc # Required-Start: $remote_fs $syslog # Required-Stop: $remote_fs $syslog # Default-Start: 2 3 4 5 # Default-Stop: # Short-Description: LIRC on PHP server ### END INIT INFO set -e # /etc/init.d/01_lirc: start and stop the "LIRC on PHP" daemon test -x /usr/sbin/mylirc || exit 0 ( /usr/sbin/mylirc -\? 2&gt;&amp;1 | grep -q mylirc ) 2&gt;/dev/null || exit 0 umask 022 . /lib/lsb/init-functions run_by_init() { ([ "$previous" ] &amp;&amp; [ "$runlevel" ]) || [ "$runlevel" = S ] } export PATH="${PATH:+$PATH:}/usr/sbin:/sbin" case "$1" in start) log_daemon_msg "Starting LIRC on PHP deamon" "mylirc" || true if start-stop-daemon --quiet --oknodo --exec /usr/sbin/mylirc --background --start -- --device=/dev/input/event1 --log=/var/log/log_lirc; then log_end_msg 0 || true else log_end_msg 1 || true fi ;; stop) log_daemon_msg "Stopping LIRC on PHP deamon" "mylirc" || true if start-stop-daemon --stop --oknodo --name mylirc --retry=KILL/1; then log_end_msg 0 || true else log_end_msg 1 || true fi ;; restart) log_daemon_msg "Restarting LIRC on PHP deamon" "mylirc" || true start-stop-daemon --stop --oknodo --name mylirc --retry=KILL/1; if start-stop-daemon --quiet --oknodo --exec /usr/sbin/mylirc --background --start -- --device=/dev/input/event1 --log=/var/log/log_lirc; then log_end_msg 0 || true else log_end_msg 1 || true fi ;; status) ID=`(lsof | grep mylirc | grep /dev/ 2&gt;&amp;1) 1&gt;/dev/null || echo 0;` if [ "$ID" = "0" ]; then echo "LIRC on PHP deamon \033[37;1;41m shutdown \033[0m"; else echo "LIRC on PHP deamon \033[37;1;42m started \033[0m"; fi tput sgr0 ;; *) log_action_msg "Usage: /etc/init.d/mylirc {start|stop|restart|status}" || true exit 1 esac exit 0</span></span></code> </pre><br><br>  Now you can check the operation of the daemon with the following commands: <br><pre> <code class="bash hljs">/etc/init.d/01_lirc start</code> </pre>  Stop: <br><pre> <code class="bash hljs">/etc/init.d/01_lirc stop</code> </pre>  Status: <br><pre> <code class="bash hljs">/etc/init.d/01_lirc status</code> </pre> <br>  and similarly <i>restart</i> <br>  To add a daemon to autoload, do the following: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/init.d/ update-rc.d 01_lirc defaults</code> </pre><br>  Remove from startup: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/init.d/ update-rc.d 01_lirc remove</code> </pre><br><br>  PS I skated the program, it has been stable for two weeks.  Suggestions and comments are welcome. <br><br>  Pss <br>  <a href="http://geektimes.ru/users/edwardoid/" class="user_link">edwardoid</a> suggested <a href="http://geektimes.ru/users/edwardoid/" class="user_link">creating</a> a script that would generate a settings file (similar to /etc/mylirc/buttom_avermedia.php), <div class="spoiler">  <b class="spoiler_title">here is the result</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/php5 &lt;?php declare(ticks = 1); pcntl_signal(SIGINT, "signal_handler"); function signal_handler($signal){ global $f,$out; if($signal==SIGINT){ fclose($f); exec('echo ?\&gt; &gt;&gt; '.$out); exit("\n$out create!\n"); } } function AccessFile($file,$access){ if(file_exists($file)){ // ! if($f=@fopen($file,$access)){fclose($f);}else{exit("not have access to $file\n");} }else{ return "$file not found (may not have access to the folder)\n"; } } $dev=""; $out=""; if(count($argv)==1){ exit("Use ".dirname( __FILE__ )."/".basename($_SERVER['SCRIPT_FILENAME'])." --device=device --out=config.php\n"); }else{ for($i=1;$i&lt;count($argv);$i++){ $cmd=explode("=",$argv[$i]); switch($cmd[0]){ case "--device": $dev=$cmd[1]; echo AccessFile($cmd[1],"rb"); break; case "--out": $out=$cmd[1]; echo AccessFile($cmd[1],"w"); break; } } } if(($dev=="")||($out=="")){ exit("Use ".dirname( __FILE__ )."/".basename($_SERVER['SCRIPT_FILENAME'])." --device=device --out=config.php\n"); } echo "press [Ctrl]+[C] to stop and press any button on the remote\n"; $f=fopen($dev, 'rb'); if($f){ exec('echo \&lt;?php &gt; '.$out); exec('echo " \$command=array();" &gt;&gt; '.$out); $i=0; $j=1; while (!feof($f)){ $b=fread($f,32); $b=bin2hex($b); $b=substr($b,18,8); $button =substr($b,0,4); $key =substr($b,4); $i=$i+($j++)%2; //  $but='$command[]=array("'.$i.'", "'.$button.'","'.$key.'",""); // #'.$i; exec('echo \' '.$but.'\' &gt;&gt; '.$out); echo $but."\n"; //   ,  ,       } } ?&gt;</span></span></code> </pre><br></div></div>  Thanks for the idea! </div><p>Source: <a href="https://habr.com/ru/post/216615/">https://habr.com/ru/post/216615/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216599/index.html">Short life and one game adventures</a></li>
<li><a href="../216601/index.html">We ride the floppy and study the promising router. (In this article, not a single TP-Link MR3020 and TL-WR703N were injured, and HAME MPR A100 (A2) got off lightly)</a></li>
<li><a href="../216603/index.html">Oculus presented the Rift Development Kit 2 at the GDC 2014 conference</a></li>
<li><a href="../216605/index.html">Yii connection many to many</a></li>
<li><a href="../216609/index.html">The history of the creation of a torrent render for 3ds max</a></li>
<li><a href="../216619/index.html">Volvo makes sure you don't fall asleep</a></li>
<li><a href="../216621/index.html">Competition from Veeam! The main prize is a $ 25,000 round-the-world trip for two, and not only</a></li>
<li><a href="../216623/index.html">Managing JavaScript UI stream using WinJS scheduler</a></li>
<li><a href="../216625/index.html">Force Majeure with Alexei Kibkalo</a></li>
<li><a href="../216627/index.html">Tickets for AppSummit - iOS, Android, Windows and business on applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>