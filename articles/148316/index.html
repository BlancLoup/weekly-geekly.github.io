<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing Debian on a physically accessible system without a monitor and keyboard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I had only a laptop on my hands for a long time and I recently got hold of a system unit. Without a monitor and keyboard, in other words, a headless s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing Debian on a physically accessible system without a monitor and keyboard</h1><div class="post__text post__text-html js-mediator-article">  I had only a laptop on my hands for a long time and I recently got hold of a system unit.  Without a monitor and keyboard, in other words, a headless system.  Thus the <b>problem</b> arose <b>:</b> <br><br>  Install it on a physically accessible Debian machine, without having the ability to connect a monitor or keyboard to it, but with some set of software and hardware resources. <br><a name="habracut"></a><br>  Namely: <ol><li>  the target machine with the POST order already set up in the BIOS Setup "NO ERROR" or "ALL, NO KEYBOARD" (otherwise, the procedure will not even start downloading at least something *) and loading set up first from one sata device, then from another (the remaining details of the boot order were not important) </li><li>  a laptop </li><li>  local network (in my case, a wi-fi router with a wired connection to the target machine and a wireless one with a laptop. But the details are not fundamental) </li><li>  Internet access (inexpensive and preferably fast) </li><li>  Half-collapsible collapsible external hard disk 2.5 "with internal sata-interface and external usb </li></ol><br>  The task can be considered completed if Debian is installed on the internal hard disk of the target machine, and the last one with power on will be accessible via SSH without user intervention. <br><br><h4>  Solution scheme </h4><br>  The optimal solution to this problem was the following sequence of actions: <br><ol><li>  revitalize a part of the external hard disk drive enough to install Debian there </li><li>  on a laptop, bind an usb-connected external hard drive to a vmdk file using the VBoxManage software from the Oracle VirtualBox virtualization package, install it on an external Debian hard disk and configure it </li><li>  disassemble the external hard drive and connect it to the target machine via the sata interface, the first in the download queue, boot the machine and connect to it from the laptop via SSH </li><li>  clone the system from a 2.5 "disk to a native 3.5" target machine and reconfigure grub2, controlling the target machine from the laptop via SSH </li></ol><br><h5>  Alternatives </h5><br>  Generally speaking, this problem has many solutions.  Instead of the proposed scheme in my place, another user, in most cases more experienced and prepared, could choose one of the following solutions: <br><ol><li>  Modify the existing Debian distribution so that it automatically installs and configures the system without a single question to the user when booting from a CD / DVD, including splitting the hard disk of the target machine into partitions as necessary.  To do this, you will need to write a special preseed-file with answers to all installer requests and hope that you have all correctly taken into account.  Read more in the <a href="">official documentation</a> . </li><li>  To set up a DHCP server on a laptop (or use a router), some web server to publish a preseed file and a tftp server to transfer the initial boot code pxelinux.0 over the network to the target machine - that is, use PXE boot ( for which BIOS boot support must be enabled.  This is the most powerful approach that does not use an important strategic advantage of my situation - physical access to the target machine. </li><li>  Find a suitable live-cd Linux distribution or change an existing one (for example, using the simple-cdd utility or others) so that it boots without a single issue and automatically picks up the SSH server, and then manually install the Debian distribution (this process is also well described in <a href="">documentation</a> ) </li><li>  To use some other way, however, in most cases it will turn out to be either a combination of the described ones, or it will go beyond the available resources: for example, the existence of a usb-sata adapter for a 3.5 "drive or at least such a trifle as an adapter ‚ÄúDad-dad‚Äù for sata (a 3.5 "drive could be powered from the power supply unit of the target machine and use a controller from a 2.5" external drive to connect it via usb to a laptop or directly connect a 3.5 "drive to a laptop, for example, instead of Slim-DVD -drive.When with uncomplicated skill it is  it is possible - but only if there is such an adapter) </li></ol><br><h5>  A bit more </h5><br>  Now I will describe in more detail the steps that led me to success and, I hope, will lead you in a similar situation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  First stage </h6><br>  First, let's connect an external disk (capacity 160 GB, one partition for the whole disk, ext3 file system) to a laptop with a Linux system installed and check it for errors with automatic correction of the latter (hereinafter we will read the commands with the prefix # executed as root. We also assume that the external hard disk is determined by the laptop as a sdc device): <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># fsck -f -y -c /dev/sdc1</span></span></code> </pre> <br>  -f - check the disk even if it is marked as not containing errors <br>  -y - answer ‚Äúyes‚Äù to all questions automatically.  That is, just fix all the errors <br>  -c - search and mark broken disk blocks.  For these purposes, there is a special utility badblocks, but with the help of this option you automatically send its fsck report. <br>  Note that you do not specify a disk, but a specific partition on it. <br>  In my case, the test "died" at 20% of execution due to the huge number of errors, which is why I made the simple decision to create a 20 GB partition at the beginning of the disk (this is more than enough to install Debian).  To repartition a disk, it is convenient to use the cfdisk utility: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cfdisk /dev/sdc</span></span></code> </pre> <br>  In interactive mode, you simply configure the disk as necessary: ‚Äã‚ÄãI created a 20-GB primary partition at the beginning of the disk, leaving the rest of the space empty (and also marked it as <b>bootable beforehand</b> . Don't forget to write the changes to the disk before exiting the program).  Then we create a file system on it: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkfs.ext3 /dev/sdc1</span></span></code> </pre> <br>  And again we check that everything is fine: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># fsck -f -y -c /dev/sdc1</span></span></code> </pre> <br><br><h6>  Second phase </h6><br>  Suppose you have VirtualBox installed.  Then create a vmdk disk image that actually displays all operations with it on a physical disk (we assume that you are in a directory convenient to you, for example, ~ / VirtualBox \ VMs \ desktop): <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vboxmanage internalcommands createrawvmdk -filename usb-hdd160.vmdk -rawdisk /dev/sdc</span></span></code> </pre> <br>  Now create a new virtual machine with the name ‚Äúdesktop‚Äù: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vboxmanage createvm --name desktop --ostype Debian --register</span></span></code> </pre> <br>  Give her the appropriate amount of RAM: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vboxmanage modifyvm desktop --memory 512</span></span></code> </pre> <br>  Equip a controller to connect hard drives and CD / DVD-drives: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vboxmanage storagectl desktop --name "sata" --add sata</span></span></code> </pre> <br>  And connect our external hard drive: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vboxmanage storageattach desktop --storagectl "sata" --port 0 --type hdd --medium ./usb-hdd160.vmdk</span></span></code> </pre> <br>  In order to disconnect a disk (it will come in handy again and again), you need to select ‚Äúnothing‚Äù as the medium: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vboxmanage storageattach desktop --storagectl "sata" --port 0 --type hdd --medium none</span></span></code> </pre> <br>  Now it's time to think about where we are going to install Debian.  If I had a normal Internet channel, I chose a ‚Äúsmall installation image‚Äù, if you wish, you can download a full-size CD or even a DVD.  Details <a href="http://www.debian.org/distrib/">here</a> .  Also, due to the installation in the virtual machine, you will have to limit to the i386 version - 64-bit guests VirtualBox only supports on hosts with hardware virtualization support VT-x or AMD-V - only not the cheapest processors can boast this.  So let the Debian iso-image be in the current directory, for example, debian-6.0.5-i386-netinst.iso.  Then, in the image and likeness of connecting a hard disk, we will connect it too: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vboxmanage storageattach desktop --storagectl "sata" --port 1 --type dvddrive --medium ./debian-6.0.5-i386-netinst.iso</span></span></code> </pre> <br>  You can run the car: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vboxmanage startvm desktop</span></span></code> </pre> <br>  (some of these actions can also be performed from the VirtualBox GUI. When starting it, do not forget that the machines are created by default for only one user, so run the GUI also as root. As an ordinary user, you can hardly perform all these manipulations since working with a hard disk requires privileged access. Use sudo) <br>  Now you need to go through all the stages of the installation, specify the passwords for root and the user, and also, and it is critically important, choose an <b>SSH server</b> among the installation templates.  Due to the very fragile state of the disk, I minimized my actions when it was broken down - I mounted the existing partition as / and did not select the swap partition - it can be connected already on the target machine.  After the installation is complete, you can still work on the system, adjust something to your taste, as long as you can access it from the keyboard and monitor, check that everything is really loading by disabling the iso image, etc. <br><br><h6>  Third stage </h6><br>  At the third stage, all you need is to connect the external drive to the target machine and turn it on.  The router helped me at this stage because I looked at the ip of the machine on its status page and opened an SSH session from a laptop at this address: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ssh root@192.168.0.103</span></span></code> </pre> <br>  Your car address is likely to be different. <br><br><h6>  Fourth stage </h6><br>  If everything worked out, it remains to transfer the system from an external disk to an internal one.  Regarding this stage, there are especially many opinions (including not quite correct ones), how to implement it, I will offer one.  First, given the work blindly, it will be very useful to do everything described in this section, first on a laptop in a virtual machine.  Following this <a href="http://mirspo.narod.ru/vbox/">wonderful guide</a> and the comments I have already made, you can connect another virtual hard disk to the desktop virtual machine and, considering that this is an internal drive of the target machine, practice on it.  Ultimately, you should be able to unmount the external drive and still boot your Debian from the virtual one.  To further bring the situation closer to the ‚Äúcombat‚Äù situation, you can work with the virtual machine via SSH from the host machine (laptop).  To do this, for example, you can leave the network settings (NAT) of the virtual machine by default, but relocate the ports: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vboxmanage modifyvm desktop --natpf1 "guestssh,tcp,,2222,,22"</span></span></code> </pre> <br>  (details <a href="https://www.virtualbox.org/manual/ch06.html">here</a> ) <br>  Now any call to 2222 (the number is arbitrary, but it is desirable that it exceed 1024 - only root can access the smaller ports) the port of your laptop will be sent to port 22 (standard SSH) of the virtual machine.  You can open a session from the host: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ssh -p 2222 root@localhost</span></span></code> </pre> <br>  (most likely, localhost leads to 127.0.0.1).  Secondly, it is not necessary to copy the entire disk with dd, because it takes a long time and will not go smoothly in most practical cases.  You can use cp, rsync to copy the file system, but the special utility dump / restore is most suitable (it works extremely quickly and reliably), and to restore the boot order you don‚Äôt get rid of copying with the MBR dd - modern Debian uses grub2 who likes to address disks by unique UUID numbers - you will leave in the system all links to an external hard disk. <br>  So, you need to do the following (the target machine is loaded from an external disk, let it be / dev / sda, the internal disk is / dev / sdb, you work from a laptop via <b>SSH</b> ): <br>  Using internal cfdisk, split the internal disk in the same way (or almost the same - the partition into which you will copy should contain the data intended for it): <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cfdisk /dev/sdb</span></span></code> </pre> <br>  Create a file system on it: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkfs.ext3 /dev/sdb1</span></span></code> </pre> <br>  Mount it: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mount /dev/sdb1 /mnt</span></span></code> </pre> <br>  And copy the external disk file system into it: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># (dump -0f - /) | ( cd /mnt; restore -rf - )</span></span></code> </pre> <br>  Now you need to configure grub2.  First, chroot into the copied file system: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mount --bind /dev /mnt/dev # mount --bind /proc /mnt/proc # chroot /mnt</span></span></code> </pre> <br>  Now we are actually in the Debian environment on the internal disk of the target machine.  Update the configuration of hard drives (now there is garbage left by the virtual machine): <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grub-mkdevicemap</span></span></code> </pre> <br>  - it will automatically be written to the /boot/grub/device.map file.  Update grub2 configuration: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># update-grub</span></span></code> </pre> <br>  Perform its installation on the internal disk: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grub-install /dev/sdb</span></span></code> </pre> <br>  (note, you specify a disk, not a partition on it) <br>  And again it is worth updating the configuration: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># update-grub</span></span></code> </pre> <br>  Now cancel chroot and turn off the system: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># exit # halt</span></span></code> </pre> <br>  Now unplug the external drive and start the target machine again.  You must re-access it via SSH from a laptop. <br>  Now you can create and connect a swap partition: allocate a place to it using cfdisk, then execute <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkswap /dev/sdb2 # sync; sync; sync # swapon /dev/sdb2</span></span></code> </pre> <br>  (sync flushes system buffers) <br>  It is possible to start a home section, etc. (you can see <a href="">here</a> ). <br>  The system is ready to go. <br><br>  Related Links: <br><ol><li>  <a href="http://www.linuxreport.org/content/view/67/36/">www.linuxreport.org/content/view/67/36</a> </li><li>  <a href="http://ru.wikibooks.org/wiki/Grub_2">wiki grub2 in Russian</a> </li></ol><br><br>  PS Regarding the resuscitation of an external hard drive, I asked questions on the forums <a href="http://www.cyberforum.ru/hdd/thread627604.html">cyberforum.ru</a> and <a href="http://forum.oszone.net/thread-239145.html">oszone.net</a> .  I would be grateful for any ideas presented in any place convenient for you. </div><p>Source: <a href="https://habr.com/ru/post/148316/">https://habr.com/ru/post/148316/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148309/index.html">How small bugs in the Microsoft linker haunt Linux, using the example of Firefox</a></li>
<li><a href="../148310/index.html">Another attempt to understand the problem of artificial intelligence</a></li>
<li><a href="../148311/index.html">Mobile development with Gideros Studio. Part 0</a></li>
<li><a href="../148312/index.html">Managing configuration files in .net projects</a></li>
<li><a href="../148313/index.html">The principles of minimalism in developing games for mobile platforms</a></li>
<li><a href="../148317/index.html">Defending against spam with IronPort c170</a></li>
<li><a href="../148318/index.html">Auto-Renewable Subscription in iOS: proper implementation and pitfalls</a></li>
<li><a href="../148319/index.html">Recognition of numbers by 4 points</a></li>
<li><a href="../148323/index.html">Bot for browser Angry Pets</a></li>
<li><a href="../148324/index.html">Sublime Text 2: How to create a snippet?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>