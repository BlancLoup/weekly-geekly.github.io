<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Translation: 30 days Windows Mobile, the third day - GPS Compass (.NET vs WinAPI / C)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The third part of the translation cycle. Today we have on line the GPS Compass . Previous article, Bluetooth manager - http://habrahabr.ru/blogs/mobil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Translation: 30 days Windows Mobile, the third day - GPS Compass (.NET vs WinAPI / C)</h1><div class="post__text post__text-html js-mediator-article">  The third part of the translation cycle.  Today we have on line the <strong>GPS Compass</strong> .  Previous article, Bluetooth manager - <a href="http://habrahabr.ru/blogs/mobiledev/61703/">http://habrahabr.ru/blogs/mobiledev/61703/</a> . <br><br><h2>  Chris Kraft.  C # </h2><br>  The original is <a href="http://www.cjcraft.com/blog/2008/06/04/30DaysOfNETWindowsMobileApplicationsDay03GPSCompass.aspx">here</a> . <br><br>  I'm not a designer, but as mentioned earlier, the app should look attractive.  Therefore, I found a very good free image for GPS compass in <a title="Compass" href="http://commons.wikimedia.org/wiki/Compass_rose">Wikimedia</a> .  When the basis for registration was chosen, it remains to determine the mechanism for obtaining GPS data.  The following options were available: <br><ol><li>  receive data via <a title="serial port" href="http://msdn.microsoft.com/en-us/library/aa446565.aspx">serial port</a> </li><li>  using the <a title="OpenNetCF GPS" href="http://blogs.msdn.com/mikehall/archive/2005/03/31/404302.aspx">OpenNetCF GPS library</a> </li><li>  using <a title="GPS Intermediate Driver" href="http://msdn.microsoft.com/en-us/library/ms850332.aspx">GPS Intermediate Driver</a> </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><img alt="GPS Compass application" src="http://www.cjcraft.com/blog/content/binary/WindowsLiveWriter/30D.NETWindowsMobileApplicationsDay03GPS_13428/image_thumb.png" align="left" hspace="10">  I stopped at the third option, because  it is fairly new and, as the documentation says, ‚Äúit‚Äôs useful because  provides an intermediate level of abstraction between manufacturers of GPS devices and developers. "  No one makes equipment in the same way - there are always features and pitfalls. <br><br><br>  To test the application, I needed a device with GPS, and I even had this (AT &amp; T Tilt), but unfortunately, the signal level in the room went to zero.  Fortunately, Microsoft found the FakeGPS utility, which is just right for my purposes.  This utility uses a text file with GPS data to emulate the functioning of a real GPS receiver. <br><br>  In the documentation, I quickly discovered what I needed - a description of the structure of <a href="http://msdn.microsoft.com/en-us/library/ms893674.aspx">GPS_POSITION</a> .  For my simple application, I only needed one <strong>flHeading</strong> field, in degrees.  North corresponds to zero. <br><br>  At this stage, bundled with the <a href="http://www.microsoft.com/downloads/details.aspx%3Ffamilyid%3D06111A3A-A651-4745-88EF-3D48091A390B%26displaylang%3Den">Windows Mobile 6 SDK</a> in the examples, I found the GPS Application - <strong>C: \ Program Files \ Windows Mobile 6 SDK \ Samples \ PocketPC \ CS \ GPS</strong> <br><br>  Of course, it was possible to write everything from scratch, but I will repeat it again - always try to make the most of the available developments. <br><br>  The application had a good status screen, which I called up on the menu.  However, the main component of the application, of course, is displayed in the screenshot above.  In principle, based on this example, you can build any application that uses GPS. <br><br>  Download <a href="">source code</a> . <br><br>  <em>Note</em>  <em>translator:</em> Chris does not like to give code examples in his articles, preferring to immediately give a link to the file with the source code of the project.  However, I allow myself to make particularly interesting inserts, if this is relevant.  In the case of GPS Compass, it is useless to bring pieces of code, since  it will be either too little or too much.  I will say one thing - if Chris did not have an application from the SDK at hand, he would have suffered thoroughly, since  in the example, all the wrappers are written around the native structures, enumerations and methods; this example is also good for studying the characteristics of <strong>marshalling</strong> large and complex structures. <br><br><h2>  Christopher Fairbairn.  WinAPI - C </h2><br>  In Windows Mobile 5 and above, there is a unified API called <a title="GPS Intermediate Driver" href="http://msdn.microsoft.com/en-us/library/ms850332.aspx">GPS Intermediate Driver</a> , which will allow multiple applications to simultaneously use one GPS device.  This is a high-level interface that saves us from having to parse <a href="http://www.gpsinformation.org/dale/nmea.htm">NEMA sentences</a> , etc. <br><br>  To connect to a GPS device, we need to connect gpsapi.h and call <a href="http://msdn.microsoft.com/en-us/library/bb202113.aspx">GPSOpenDevice</a> <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//    GPS Intermediate Driver</font> &lt;br/&gt; <br> HANDLE hGPS = GPSOpenDevice(NULL, NULL, NULL, 0);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  This API <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D0%25B4%25D1%2581%25D1%2587%25D1%2591%25D1%2582_%25D1%2581%25D1%2581%25D1%258B%25D0%25BB%25D0%25BE%25D0%25BA">counts links</a> , which means that every call to GPSOpenDevice must necessarily have a closing GPSCloseDevice.  GPS equipment will disconnect only when the last client has terminated the connection. <br><br><br>  Next, for information, we use the methods <a href="http://msdn.microsoft.com/en-us/library/bb202050.aspx">GPSGetPosition</a> or <a href="http://msdn.microsoft.com/en-us/library/bb202076.aspx">GPSGetDeviceState</a> to obtain the position or status of the device, respectively.  For example, to get the current location, you can use the following code: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">GPS_POSITION pos;&lt;br&gt; &lt;br&gt; <font color="#008000">//  </font> &lt;br&gt;memset(&amp;pos, 0, <font color="#0000ff">sizeof</font> (pos));&lt;br&gt;pos.dwVersion = GPS_VERSION_CURRENT;&lt;br&gt;pos.dwSize = <font color="#0000ff">sizeof</font> (pos);&lt;br&gt; &lt;br&gt; <font color="#008000">//  GPS intermediate driver</font> &lt;br&gt; <font color="#008000">//  .</font> &lt;br&gt;GPSGetPosition(hGPS, &amp;pos, 500000, 0);</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Please note that the <a href="http://msdn.microsoft.com/en-us/library/bb202062.aspx">GPS_POSITION</a> structure contains the dwValidFlags field.  This is a bitmask that tells you which fields contain the correct information.  For example, if the GPS_VALID_LATITUDE flag is not set in the field, this means that the dblLatitude field cannot be relied on. <br><br>  We use one interesting feature in our GPS compass.  By passing two event handlers as parameters to the GPSOpenDevice method, we eliminate the need to periodically poll the device using GPSGetPosition.  Instead, we simply wait until an event is triggered, with a guarantee of receiving data that is different from the previously obtained values. <br><br><h3>  Creating a menu. </h3><br>  This is the first application that required the menu.  The menu is created in the resource editor and loaded using the <a href="http://msdn.microsoft.com/en-us/library/aa931828.aspx">SHCreateMenuBar</a> .  The call to this method is usually placed in the <a href="http://msdn.microsoft.com/en-us/library/aa931243.aspx">WM_INITDIALOG</a> handler: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">case</font> WM_INITDIALOG:&lt;br&gt; <font color="#008000">// Configure the menu</font> &lt;br&gt; SHMENUBARINFO mbi;&lt;br&gt; memset(&amp;mbi, 0, <font color="#0000ff">sizeof</font> (mbi));&lt;br&gt; mbi.cbSize = <font color="#0000ff">sizeof</font> (mbi);&lt;br&gt; mbi.hWndParent = hWnd; <font color="#008000">// the dialog's handle</font> &lt;br&gt; mbi.nToolBarId = IDR_MENU; <font color="#008000">// the menu resource id</font> &lt;br&gt; mbi.hInstRes = GetModuleHandle(NULL);&lt;br&gt; mbi.dwFlags = SHCMBF_HMENU;&lt;br&gt; &lt;br&gt; <font color="#008000">// Create the menu</font> &lt;br&gt; SHCreateMenuBar(&amp;mbi);&lt;br&gt; <font color="#0000ff">break</font> ;</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Next, there is a whole <a href="http://msdn.microsoft.com/en-us/library/aa926150.aspx">set of APIs</a> for interacting with menu items.  For example, you can activate or deactivate a specific item using the <a href="http://msdn.microsoft.com/en-us/library/aa931329.aspx">EnableMenuItem</a> : <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">// Disable a menu item with id 'IDC_SOME_ITEM'</font> &lt;br&gt;EnableMenuItem(hMenu, IDC_SOME_ITEM,&lt;br&gt; MF_BYCOMMAND | MF_GRAYED);&lt;br&gt; &lt;br&gt; <font color="#008000">// Enable a menu item with id 'IDC_SOME_ITEM'</font> &lt;br&gt;EnableMenuItem(hMenu, IDC_SOME_ITEM,&lt;br&gt; MF_BYCOMMAND | MF_ENABLED);</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Note that the same method is called to set different states of menu items.  The correct place for such calls is in the <a href="http://msdn.microsoft.com/en-us/library/aa929343.aspx">WM_INITMENUPOPUP</a> handler.  This message is sent to the menu owner immediately before the menu is displayed. <br><br>  Download <a href="">source code</a> . <br><br><h2>  Conclusion from the translator </h2><br>  What I like in the translation of two articles at once - Chris describes how to quickly distribute the necessary functionality in C #, and Christopher always digs deeper and describes the subtleties of libraries that often can‚Äôt be seen from .net if you don‚Äôt understand.  Accordingly, even if there is no need or desire to program in pure WinAPI, knowing how everything works inside is very useful. <br><br></div><p>Source: <a href="https://habr.com/ru/post/65185/">https://habr.com/ru/post/65185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../65176/index.html">Promo of the Resident Evil sequel</a></li>
<li><a href="../65177/index.html">Meet RW</a></li>
<li><a href="../65178/index.html">Road to sky</a></li>
<li><a href="../65180/index.html">The difference in rendering between 3.0 and 3.5. Bug or feature?</a></li>
<li><a href="../65184/index.html">PHP: work with time intervals</a></li>
<li><a href="../65188/index.html">We combine supply and demand</a></li>
<li><a href="../65191/index.html">Google Wave made friends with Silverlight</a></li>
<li><a href="../65192/index.html">Base stations Yota in Moscow</a></li>
<li><a href="../65194/index.html">Synaptic ClearPad 3000 - 10-finger touchscreen display</a></li>
<li><a href="../65197/index.html">ITooLabs Unified Communications Server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>