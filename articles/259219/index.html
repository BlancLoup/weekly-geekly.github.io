<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cheat sheet on mongodb: e-commerce, migration, frequently used operations and a little about transactions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is a small cheat sheet for mongodb and some long requests with a couple of recipes. Sometimes it is convenient when some little things are c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cheat sheet on mongodb: e-commerce, migration, frequently used operations and a little about transactions</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/e36/58a/ca6/e3658aca69ab496895f5bc53c7357632.jpeg"><br><p> This post is a small cheat sheet for <code>mongodb</code> and some long requests with a couple of recipes.  Sometimes it is convenient when some little things are collected in one place, I hope everyone who is interested in <code>mongodb</code> will find something useful for themselves. </p><br><p>  It would not be desirable, that the post was perceived in a key of holivar on a subject <code>SQL vs. NOSQL</code>  <code>SQL vs. NOSQL</code> And so it is clear that everywhere there are pluses and minuses, in this case it is just somewhere a little bit of help, somewhere there are a few examples of what you have come across.  Examples on <code>mongo shell</code> and <code>python</code> . </p><br><ol><li>  <a href="https://habr.com/ru/post/259219/">Migrating to new versions in mongodb</a> <br><ul><li>  <a href="https://habr.com/ru/post/259219/">Up to version 2.6</a> </li><li>  <a href="https://habr.com/ru/post/259219/">From 2.6 to 3.0 versions</a> </li><li>  <a href="https://habr.com/ru/post/259219/">New in PyMongo</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/259219/">Comparison and logical queries</a> </li><li>  <a href="https://habr.com/ru/post/259219/">Full-text search in Mongodb, regexp, indexes, etc.</a> </li><li>  <a href="https://habr.com/ru/post/259219/">Atomic operators (modifying data)</a> </li><li>  <a href="https://habr.com/ru/post/259219/">Some words about transactions in Mongodb</a> <br><ul><li>  <a href="https://habr.com/ru/post/259219/">Unique index</a> </li><li>  <a href="https://habr.com/ru/post/259219/">Biphasic commit</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/259219/">Aggregation framework and JOINs in Mongodb</a> </li><li>  <a href="https://habr.com/ru/post/259219/">Examples</a> <br><ul><li>  <a href="https://habr.com/ru/post/259219/">Trees, comments in Mongodb</a> </li><li>  <a href="https://habr.com/ru/post/259219/">Tags, blogs</a> </li><li>  <a href="https://habr.com/ru/post/259219/">E-commerce, and complex filters in Mongodb</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/259219/">Small Python sandbox</a> </li></ol><br><a name="habracut"></a><br><h3><a name="1"></a>  <font color="green">Mongodb Migration</font> </h3><br><h3><a name="11"></a>  <font color="blue">Up to version 2.6</font> </h3><br><p>  After the release of version <code>2.6</code> , <code>mongodb</code> added a new system for assigning user rights to databases, separate collections.  And, accordingly, when updating this should be considered. </p><br><p>  1) It is necessary to switch from version <code>2.4</code> to version <code>2.6</code> .  From <code>2.2</code> to <code>2.6</code> there will be no backward compatibility, so you need to upgrade step by step. </p><br><p>  Actually, the update itself: </p><br><pre> <code class="bash hljs">apt-get update apt-get install mongodb-org</code> </pre> <br><p>  2) After upgrading to <code>2.6</code> you need to go to the <code>admin</code> database and execute several commands that will check the compatibility of documents. </p><br><pre> <code class="bash hljs">use admin db.upgradeCheckAllDBs()</code> </pre> <br><p>  3) Since from version <code>2.6</code> in <code>mongodb</code> , as already mentioned, there are distinctions on roles and setting rights for any user up to the collection to read, write, etc., respectively, these roles must be set, otherwise you will not be able to execute the <code>auth</code> command . </p><br><pre> <code class="bash hljs">db.auth(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>,<span class="hljs-string"><span class="hljs-string">'password'</span></span>)</code> </pre> <br><p>  To do this, you first need to create the user "Administrator" in the <code>admin</code> database </p><br><pre> <code class="bash hljs">db.createUser({user:<span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>:<span class="hljs-string"><span class="hljs-string">"passwd"</span></span>, roles:[{role:<span class="hljs-string"><span class="hljs-string">"userAdminAnyDatabase"</span></span>, db:<span class="hljs-string"><span class="hljs-string">"admin"</span></span>}]})</code> </pre> <br><p>  4) After that, go to your desired database, with which they are going to work and to which we want to connect, and create a user there. </p><br><pre> <code class="bash hljs">use newdb db.createUser({user:<span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>:<span class="hljs-string"><span class="hljs-string">"passwd"</span></span>, roles:[{role:<span class="hljs-string"><span class="hljs-string">"dbAdmin"</span></span>, db:<span class="hljs-string"><span class="hljs-string">"newdb"</span></span>}]})</code> </pre> <br><p>  A record will automatically be created in the <code>admin</code> database in the <code>system.users</code> collection <code>system.users</code> <br>  You can view database users with the command: </p><br><pre> <code class="bash hljs">db.runCommand( { usersInfo: [ { user: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, db: <span class="hljs-string"><span class="hljs-string">"newdb"</span></span> } ], showPrivileges: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } )</code> </pre> <br><p>  Well, do not forget to reboot after all this. </p><br><pre> <code class="bash hljs">service mongod restart</code> </pre> <br><p>  In <code>ubuntu</code> c this version of the service is called not <code>mongodb</code> but <code>mongod</code> and the config in <code>/etc</code> is called <code>mongod.conf</code> . Most likely, this is due to the lack of backward compatibility so that you don‚Äôt mix up the update. </p><br><h3><a name="12"></a>  <font color="blue">From 2.6 to 3.0 versions</font> </h3><br><p>  A lot has already been written about the new version <code>3.0</code> and the revolutionary changes in the storage engine; I will not repeat it. </p><br><p>  Before upgrading to <code>3.0</code> it is recommended to consistently upgrade to version <code>2.6</code> without skipping.  That is, <code>2.2-&gt;2.4-&gt;2.6</code> . <br>  The latest version is recommended at least <code>2.6.5</code> . <br>  The installation for <code>ubuntu</code> pretty standard. <br>  Add the 3rd version repository: </p><br><pre> <code class="bash hljs">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://repo.mongodb.org/apt/ubuntu "</span></span>$(lsb_release -sc)<span class="hljs-string"><span class="hljs-string">"/mongodb-org/3.0 multiverse"</span></span> | sudo tee /etc/apt/sources.list.d/mongodb-org-3.0.list</code> </pre> <br><p>  For <code>Ubuntu 15.04</code> </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://repo.mongodb.org/apt/ubuntu trusty/mongodb-org/3.0 multiverse"</span></span> | sudo tee /etc/apt/sources.list.d/mongodb-org-3.0.list</code> </pre> <br><p>  Install: </p><br><pre> <code class="bash hljs">apt-get update apt-get install -y mongodb-org</code> </pre> <br><p>  For each component, specify the version during installation. </p><br><pre> <code class="bash hljs">apt-get install -y mongodb-org=3.0.2 mongodb-org-server=3.0.2 mongodb-org-shell=3.0.2 mongodb-org-mongos=3.0.2 mongodb-org-tools=3.0.2</code> </pre> <br><p>  Thereafter: </p><br><pre> <code class="bash hljs">service mongod stop service mongod start</code> </pre> <br><p>  <code>mongodb</code> version of <code>mongodb</code> : </p><br><pre> <code class="bash hljs">root@user-pc:~<span class="hljs-comment"><span class="hljs-comment"># mongo MongoDB shell version: 3.0.2 connecting to: test &gt; db.version() 3.0.2 &gt;</span></span></code> </pre> <br><p>  If version <code>3</code> then everything went fine and now you can change the storage.  The default is <code>MMAPv1</code> . </p><br><p>  To change to <code>/etc/mongo.conf</code> we set the option: </p><br><pre> <code class="bash hljs">storageEngine = wiredTiger</code> </pre> <br><p>  Read more about the possible options associated with the new storage <a href="http://docs.mongodb.org/manual/reference/program/mongod/">here.</a> <br>  And we see that the <code>/var/lib/mongodb</code> empty, otherwise <code>mongodb</code> will not start, of course, before this, all databases need to be made <code>mongodump</code> </p><br><pre> <code class="bash hljs">service mongod restart</code> </pre> <br><p>  Check the version of the engine for storage: </p><br><pre> <code class="bash hljs">root@user-pc:/etc<span class="hljs-comment"><span class="hljs-comment"># mongo MongoDB shell version: 3.0.2 connecting to: test &gt; db.serverStatus()</span></span></code> </pre> <br><p>  We are looking for <code>storageEngine</code> if <code>wiredTiger</code> then everything is fine. </p><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"storageEngine"</span></span> : { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"wiredTiger"</span></span> }</code> </pre> <br><p>  Now you need to import the database, including <code>admin</code> </p><br><pre> <code class="bash hljs">mongorestore --port 27017 -d admin</code> </pre> <br><h3><a name="13"></a>  <font color="blue">New in PyMongo</font> </h3><br><p>  Together with the new version of the database, a new version of the driver for <code>Python</code> <code>PyMongo</code> , and some obsolete methods have been removed there and after </p><br><pre> <code class="bash hljs">pip install -U pymongo</code> </pre> <br><p>  Even without updating the database itself, not everything will work as before.  From what was immediately noticed: </p><br><ol><li>  For universalization and unification, methods <code>update_one, insert_many, find_one_and_delete</code> more detail in the <a href="">specification</a> </li><li>  Also, only one connector to the <code>MongoClient</code> database was left for unification; options such as <code>'slave_okay': True</code> removed from it <code>'slave_okay': True</code> .  <code>ReplicaSetConnection</code> and <code>MasterSlaveConnection</code> now removed.  <code>MongoReplicaSetClient</code> left for some time for compatibility. </li></ol><br><p>  Usage example: </p><br><pre> <code class="bash hljs">&gt;&gt;&gt; <span class="hljs-comment"><span class="hljs-comment"># Connect to one standalone, mongos, or replica set member. &gt;&gt;&gt; client = MongoClient('mongodb://server') &gt;&gt;&gt; &gt;&gt;&gt; # Connect to a replica set. &gt;&gt;&gt; client = MongoClient('mongodb://member1,member2/?replicaSet=my_rs') &gt;&gt;&gt; &gt;&gt;&gt; # Load-balance among mongoses. &gt;&gt;&gt; client = MongoClient('mongodb://mongos1,mongos2')</span></span></code> </pre> <br><ol><li>  Removed <code>copy_database</code> method </li><li>  Removed <code>end_request()</code> method instead recommended to use <code>close()</code> </li><li>  Part of the community expected native support for asynchronous programming and <code>asyncio</code> from <code>python3</code> , but unfortunately, alas.  For <code>tornado</code> there is a good <a href="https://motor.readthedocs.org/en/stable/">motor</a> driver. And for <code>asyncio</code> , unfortunately, only the experimental <a href="https://bitbucket.org/mrdon/asyncio-mongo/src">asyncio-mongo</a> driver <a href="https://bitbucket.org/mrdon/asyncio-mongo/src">remains</a> underdeveloped and lacks <code>GridFS</code> support <code>GridFS</code> </li></ol><br>  In the aggregation framework, the cursor is now immediately returned, and not the <code>result</code> . <br><br><h3><a name="2"></a>  <font color="green">Comparison and logical queries</font> </h3><br><p>  <em><font color="blue"><code>$eq</code> comparison operator</font></em> <br>  <code>$eq</code> <code>db.test.find({ field: &lt;value&gt; })</code> equivalent to <code>db.test.find({ field: &lt;value&gt; })</code> </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, item: { name: <span class="hljs-string"><span class="hljs-string">"ab"</span></span>, code: <span class="hljs-string"><span class="hljs-string">"123"</span></span> }, qty: <span class="hljs-number"><span class="hljs-number">15</span></span>, tags: [ <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"C"</span></span> ] } { _id: <span class="hljs-number"><span class="hljs-number">2</span></span>, item: { name: <span class="hljs-string"><span class="hljs-string">"cd"</span></span>, code: <span class="hljs-string"><span class="hljs-string">"123"</span></span> }, qty: <span class="hljs-number"><span class="hljs-number">20</span></span>, tags: [ <span class="hljs-string"><span class="hljs-string">"B"</span></span> ] } db.test.find( { qty: { $eq: <span class="hljs-number"><span class="hljs-number">20</span></span> } } ) <span class="hljs-comment"><span class="hljs-comment"># db.test.find( { qty: 20 } ) db.test.find( { tags: { $eq: [ "A", "B" ] } } ) # : db.test.find( { tags: [ "A", "B" ] } )</span></span></code> </pre> <br><p>  <em><font color="blue">$ gt more than</font></em> <br>  <code>$gt</code> selects those documents where the field value is greater than <code>(&gt;)</code> specified value. </p><br><pre> <code class="bash hljs">db.test.find( { qty: { <span class="hljs-variable"><span class="hljs-variable">$gt</span></span>: 10 } } )</code> </pre> <br><p>  <em><font color="blue">$ gte is greater than or equal to</font></em> <br>  <code>$gte</code> selects those documents where the field value is greater than or equal to <code>(&gt;=)</code> specified value. </p><br><pre> <code class="bash hljs">db.test.find( { qty: { <span class="hljs-variable"><span class="hljs-variable">$gte</span></span>: 10 } } )</code> </pre> <br><p>  <em><font color="blue">$ lt less than</font></em> <br>  <code>$lt</code> selects those documents where the field value is less than <code>(&lt;)</code> specified </p><br><pre> <code class="bash hljs">db.test.find( { qty: { <span class="hljs-variable"><span class="hljs-variable">$lt</span></span>: 10 } } )</code> </pre> <br><p>  <em><font color="blue">$ lte is less than or equal to</font></em> <br>  <code>$lte</code> selects those documents where the field value is less than or equal to <code>(&lt;=)</code> specified </p><br><pre> <code class="bash hljs">db.test.find( { qty: { <span class="hljs-variable"><span class="hljs-variable">$lte</span></span>: 10 } } )</code> </pre> <br><p>  If the seller‚Äôs profit is less than <code>100</code> , then the bonus is canceled. </p><br><pre> <code class="bash hljs">db.test.update({ <span class="hljs-string"><span class="hljs-string">"vendor.profit"</span></span>: { <span class="hljs-variable"><span class="hljs-variable">$lte</span></span>: 100 } }, { <span class="hljs-variable"><span class="hljs-variable">$set</span></span>: { premium: 0 } })</code> </pre> <br><p>  <em><font color="blue">$ ne is not equal</font></em> <br>  <code>$ne</code> selects documents where the field value is not equal <code>(! =)</code> specified value. </p><br><pre> <code class="bash hljs">db.test.find( { qty: { <span class="hljs-variable"><span class="hljs-variable">$ne</span></span>: 10 } } )</code> </pre> <br><p>  <em><font color="blue">$ in entry check</font></em> </p><br><pre> <code class="bash hljs">{ _id: 1, qty: 10, tags: [ <span class="hljs-string"><span class="hljs-string">"name"</span></span>, <span class="hljs-string"><span class="hljs-string">"lastname"</span></span> ], } db.test.find({ tags: { <span class="hljs-variable"><span class="hljs-variable">$in</span></span>: [<span class="hljs-string"><span class="hljs-string">"name"</span></span>, <span class="hljs-string"><span class="hljs-string">"lastname"</span></span>] } } )</code> </pre> <br><p>  Regular expression example </p><br><pre> <code class="bash hljs">db.test.find( { tags: { <span class="hljs-variable"><span class="hljs-variable">$in</span></span>: [ /^be/, /^st/ ] } } )</code> </pre> <br><p>  <em><font color="blue">$ nin check for not entering</font></em> <br>  Same as <code>$in</code> but on the contrary, it checks that some value is missing in the array. </p><br><pre> <code class="python hljs">db.test.find( { qty: { $nin: [ <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span> ] } } )</code> </pre> <br><p>  <em><font color="blue">$ or operator or</font></em> <br>  The classical <code></code> operator takes several values ‚Äã‚Äãand checks that at least one of them matches the condition. </p><br><pre> <code class="python hljs">db.test.find( { $<span class="hljs-keyword"><span class="hljs-keyword">or</span></span>: [ { quantity: { $lt: <span class="hljs-number"><span class="hljs-number">10</span></span> } }, { price: <span class="hljs-number"><span class="hljs-number">10</span></span> } ] } )</code> </pre> <br><p>  For this request it is proposed to compile two indices: </p><br><pre> <code class="python hljs">db.test.createIndex( { quantity: <span class="hljs-number"><span class="hljs-number">1</span></span> } ) db.test.createIndex( { price: <span class="hljs-number"><span class="hljs-number">1</span></span> } )</code> </pre> <br><p>  If <code>$or</code> used together with the <code>$text</code> operator intended for full-text search, then the index must be. </p><br><p>  <em><font color="blue">$ and operator "and"</font></em> <br>  The operator <code></code> checks the presence of all listed values ‚Äã‚Äãin the desired documents. </p><br><pre> <code class="python hljs">db.test.find( { $<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>: [ { price:<span class="hljs-number"><span class="hljs-number">10</span></span> }, { check: true } } ]</code> </pre> <br><p>  Example with <code>$or</code> : </p><br><pre> <code class="python hljs">db.test.find( { $<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> : [ { $<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> : [ { price : <span class="hljs-number"><span class="hljs-number">50</span></span> }, { price : <span class="hljs-number"><span class="hljs-number">80</span></span> } ] }, { $<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> : [ { sale : true }, { qty : { $lt : <span class="hljs-number"><span class="hljs-number">20</span></span> } } ] } ] } )</code> </pre> <br><p>  <em><font color="blue">$ not negation operator</font></em> <br>  Verifies that there are no documents in the sample that match the condition. </p><br><pre> <code class="python hljs">db.test.find( { price: { $<span class="hljs-keyword"><span class="hljs-keyword">not</span></span>: { $gt: <span class="hljs-number"><span class="hljs-number">10</span></span> } } } )</code> </pre> <br><p>  Example with regular expression: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> no_docs <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> db.test.find( { <span class="hljs-string"><span class="hljs-string">"item"</span></span>: { <span class="hljs-string"><span class="hljs-string">"$not"</span></span>: re.compile(<span class="hljs-string"><span class="hljs-string">"^p.*"</span></span>) } } ): <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> no_docs</code> </pre> <br><p>  <em><font color="blue">$ nor operator not or</font></em> </p><br><pre> <code class="javascript hljs">db.test.find( { <span class="hljs-attr"><span class="hljs-attr">$nor</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">price</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">qty</span></span>: { <span class="hljs-attr"><span class="hljs-attr">$lt</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">sale</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ] } )</code> </pre> <br><p>  This query in the test collection will find those documents in which: </p><br><ul><li>  The value of the field `price` is not equal to 10 </li><li>  The value of the field `qty` at least 20 </li><li>  `Sale` value is not` true` </li></ul><br><p>  <em><font color="blue">$ exists checking the field for existence</font></em> <br>  <code>$exists</code> retrieves those documents in which a particular key is present or missing. <br>  If we specify <code>false</code> as the parameter in <code>$exists</code> , the query will return those documents in which the <code>qty</code> key is not defined. </p><br><pre> <code class="python hljs">db.test.find( { qty: { $exists: true } } )</code> </pre> <br><p>  <em><font color="blue">$ type <code>BSON</code> type check</font></em> </p><br><pre> <code class="python hljs">db.test.find( { field: { $type: <span class="hljs-number"><span class="hljs-number">-1</span></span> } } );</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Possible types:</b> <div class="spoiler_text"><table border="1"><tbody><tr><td>  <strong>Type of</strong> </td><td>  <strong>room</strong> </td><td>  <strong>Annotations</strong> </td></tr><tr><td>  Double </td><td>  one </td><td></td></tr><tr><td>  String </td><td>  2 </td><td></td></tr><tr><td>  Object </td><td>  3 </td><td></td></tr><tr><td>  Array </td><td>  four </td><td></td></tr><tr><td>  Binary data </td><td>  five </td><td></td></tr><tr><td>  Undefined </td><td>  6 </td><td>  Deprecated. </td></tr><tr><td>  Object id </td><td>  7 </td><td></td></tr><tr><td>  Boolean </td><td>  eight </td><td></td></tr><tr><td>  Date </td><td>  9 </td><td></td></tr><tr><td>  Null </td><td>  ten </td><td></td></tr><tr><td>  Regular Expression </td><td>  eleven </td><td></td></tr><tr><td>  Javascript </td><td>  13 </td><td></td></tr><tr><td>  Symbol </td><td>  14 </td><td></td></tr><tr><td>  Javascript (with scope) </td><td>  15 </td><td></td></tr><tr><td>  32-bit integer </td><td>  sixteen </td><td></td></tr><tr><td>  Timestamp </td><td>  17 </td><td></td></tr><tr><td>  64-bit integer </td><td>  18 </td><td></td></tr><tr><td>  Min key </td><td>  255 </td><td>  Query with -1. </td></tr><tr><td>  Max key </td><td>  127 </td><td></td></tr></tbody></table></div></div><br><p>  <em><font color="blue">$ mod</font></em> <br>  The <code>$mod</code> operator is used to select fields whose values ‚Äã‚Äãare divided by the first argument and the remainder of the division is equal to the second. <br>  For example, there are documents: </p><br><pre> <code class="bash hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"aa123"</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span> : 0 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 2, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"bb123"</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span> : 7 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 3, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"cc123"</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span> : 15 }</code> </pre> <br><p>  Request: </p><br><pre> <code class="python hljs">db.test.find( { qty: { $mod: [ <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ] } } )</code> </pre> <br><p>  Return the following documents: </p><br><pre> <code class="bash hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"aa123"</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span> : 0 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 3, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"cc123"</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span> : 15 }</code> </pre> <br><p>  Analogue from <code>SQL</code> </p><br><pre> <code class="bash hljs">select * from t <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> qty % 5 = 0;</code> </pre> <br><p>  With version <code>2.6</code> forbidden to transmit only one item, an error will be returned.  Also, if you pass more than three arguments, it will also give an error; in previous versions, redundant arguments were simply ignored. <br>  <em><font color="blue">$ all select matching all</font></em> <br>  Makes a sample of more than one array element. </p><br><pre> <code class="python hljs">db.test.find( { tags: { $all: [ <span class="hljs-string"><span class="hljs-string">"python"</span></span>, <span class="hljs-string"><span class="hljs-string">"mongodb"</span></span>, <span class="hljs-string"><span class="hljs-string">"javascript"</span></span> ] } } )</code> </pre> <br><p>  <em><font color="blue">$ elemMatch</font></em> <br>  Used when you want to compare two or more attributes belonging to the same subdocument. <br>  Checks that there is an element in the array that meets all conditions. </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, results: [ <span class="hljs-number"><span class="hljs-number">82</span></span>, <span class="hljs-number"><span class="hljs-number">85</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span> ] } { _id: <span class="hljs-number"><span class="hljs-number">2</span></span>, results: [ <span class="hljs-number"><span class="hljs-number">75</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span> ] } db.test.find( { results: { $elemMatch: { $gte: <span class="hljs-number"><span class="hljs-number">80</span></span>, $lt: <span class="hljs-number"><span class="hljs-number">85</span></span> } } } )</code> </pre> <br><p>  We get the result: </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, results: [ <span class="hljs-number"><span class="hljs-number">82</span></span>, <span class="hljs-number"><span class="hljs-number">85</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span> ] }</code> </pre> <br><p>  Another example: </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, results: [{ product: <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, score: <span class="hljs-number"><span class="hljs-number">10</span></span> }, { product: <span class="hljs-string"><span class="hljs-string">"xyz"</span></span>, score: <span class="hljs-number"><span class="hljs-number">5</span></span>}] } { _id: <span class="hljs-number"><span class="hljs-number">2</span></span>, results: [{ product: <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, score: <span class="hljs-number"><span class="hljs-number">8</span></span> }, { product: <span class="hljs-string"><span class="hljs-string">"xyz"</span></span>, score: <span class="hljs-number"><span class="hljs-number">7</span></span>}] } { _id: <span class="hljs-number"><span class="hljs-number">3</span></span>, results: [{ product: <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, score: <span class="hljs-number"><span class="hljs-number">7</span></span> }, { product: <span class="hljs-string"><span class="hljs-string">"xyz"</span></span>, score: <span class="hljs-number"><span class="hljs-number">8</span></span>}] } &gt;db.test.find( { results: { $elemMatch: { product: <span class="hljs-string"><span class="hljs-string">"xyz"</span></span>, score: { $gte: <span class="hljs-number"><span class="hljs-number">8</span></span> } } } } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"results"</span></span>: [{ <span class="hljs-string"><span class="hljs-string">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span> }, { <span class="hljs-string"><span class="hljs-string">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"xyz"</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> } ] }</code> </pre> <br><p>  <em><font color="blue">$ size searches by array length</font></em> <br>  The <code>$size</code> operator finds documents in which the number of elements in the array is equal to the value of <code>$size</code> .  For example, retrieve all the documents in which there are two elements in the laguages ‚Äã‚Äãarray: </p><br><pre> <code class="python hljs">db.persons.find ({languages: {$size:<span class="hljs-number"><span class="hljs-number">2</span></span>}})</code> </pre> <br><p>  Such a request would correspond, for example, to the following document: </p><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Alex"</span></span>, <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-string"><span class="hljs-string">"32"</span></span>, languages: [<span class="hljs-string"><span class="hljs-string">"python"</span></span>, <span class="hljs-string"><span class="hljs-string">"mongodb"</span></span>]}</code> </pre> <br><p>  <em><font color="blue">$ positional operator</font></em> <br>  <code>$</code> can be used in different cases.  When we do not know by what index the value lies in the array but we want to use it, then we use the "positional operator" <br>  For example, there are documents: </p><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"semester"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"grades"</span></span> : [ <span class="hljs-number"><span class="hljs-number">85</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span> ] } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"semester"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"grades"</span></span> : [ <span class="hljs-number"><span class="hljs-number">79</span></span>, <span class="hljs-number"><span class="hljs-number">85</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span> ] }</code> </pre> <br><p>  And we want to see after the search for them only one value corresponding to the request, not the entire document, but we don‚Äôt know in advance what value is there. </p><br><pre> <code class="python hljs">&gt;db.test.find( { semester: <span class="hljs-number"><span class="hljs-number">1</span></span>, grades: { $gte: <span class="hljs-number"><span class="hljs-number">85</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"grades.$"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"grades"</span></span> : [ <span class="hljs-number"><span class="hljs-number">85</span></span> ] }</code> </pre> <br><p>  Example for update: </p><br><pre> <code class="python hljs">db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">22</span></span> } , { $set: { <span class="hljs-string"><span class="hljs-string">"array.$.name"</span></span> : <span class="hljs-string"><span class="hljs-string">"alex"</span></span> } } )</code> </pre> <br><p>  <em><font color="blue">$ slice finds range</font></em> <br>  <code>$slice</code> - finds the range of values ‚Äã‚Äãstored in the array. <br>  Find the first 10 events: </p><br><pre> <code class="python hljs">db.test.find( { }, { <span class="hljs-string"><span class="hljs-string">"events"</span></span> : { $slice: <span class="hljs-number"><span class="hljs-number">10</span></span> } } )</code> </pre> <br><p>  Find the last 10 events: </p><br><pre> <code class="python hljs">db.test.find( { }, { <span class="hljs-string"><span class="hljs-string">"events"</span></span> : { $slice: <span class="hljs-number"><span class="hljs-number">-10</span></span> } } )</code> </pre> <br><h3><a name="3"></a>  <font color="green">Full-text search in Mongodb, regexp, indexes, etc.</font> </h3><br><p>  On Habr√© there was a good <a href="http://habrahabr.ru/post/174457/">publication <code>   </code> mongodb`, but since that time new operators and new features have been added.</a> <a href="http://habrahabr.ru/post/174457/"><br></a>  <a href="http://habrahabr.ru/post/174457/">Text search does not work without indexes, so let's talk about them.</a> <a href="http://habrahabr.ru/post/174457/"><br></a>  <a href="http://habrahabr.ru/post/174457/">A simple index is created by any text field or array.</a> <br></p><pre> <code class="python hljs">db.test.createIndex( { title: <span class="hljs-string"><span class="hljs-string">"text"</span></span>, content: <span class="hljs-string"><span class="hljs-string">"text"</span></span> } )</code> </pre> <br><p>  You can use the field name or wildcard specifier: </p><br><pre> <code class="python hljs">db.text.createIndex( { <span class="hljs-string"><span class="hljs-string">"$**"</span></span>: <span class="hljs-string"><span class="hljs-string">"text"</span></span> } )</code> </pre> <br><p>  When creating an index for full-text search, you must consider the language, if it is not English. </p><br><pre> <code class="python hljs">db.test.createIndex( { content : <span class="hljs-string"><span class="hljs-string">"text"</span></span> }, { default_language: <span class="hljs-string"><span class="hljs-string">"russian"</span></span> } )</code> </pre> <br><p>  Starting from version <code>2.6</code> , it became possible to set a text index for many languages ‚Äã‚Äãat once. </p><br><div class="spoiler">  <b class="spoiler_title">Built-in languages ‚Äã‚Äãwith abbreviations for which you can build an index.</b> <div class="spoiler_text"><ul><li>  da or danish </li><li>  nl or dutch </li><li>  en or english </li><li>  fi or finnish </li><li>  fr or french </li><li>  de or german </li><li>  hu or hungarian </li><li>  it or italian </li><li>  nb or norwegian </li><li>  pt or portuguese </li><li>  ro or romanian </li><li>  ru or russian </li><li>  es or spanish </li><li>  sv or swedish </li><li>  tr or turkish </li></ul></div></div><br><p>  <code>MongoDB</code> will use the language specified in the document when building the index.  The language specified in the document overrides the default language.  The language in the inline document overrides all others for the index. </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, language: <span class="hljs-string"><span class="hljs-string">"portuguese"</span></span>, original: <span class="hljs-string"><span class="hljs-string">"A sorte protege os audazes."</span></span>, translation: [ { language: <span class="hljs-string"><span class="hljs-string">"english"</span></span>, quote: <span class="hljs-string"><span class="hljs-string">"Fortune favors the bold."</span></span> }, { language: <span class="hljs-string"><span class="hljs-string">"russian"</span></span>, quote: <span class="hljs-string"><span class="hljs-string">"  ."</span></span> } ] }</code> </pre> <br><p>  Also, it is possible to specify a field with language using the parameter <code>language_override</code> . <br>  For example, for documents: </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">2</span></span>, idioma: <span class="hljs-string"><span class="hljs-string">"english"</span></span>, quote: <span class="hljs-string"><span class="hljs-string">"Fortune favors the bold."</span></span> } { _id: <span class="hljs-number"><span class="hljs-number">3</span></span>, idioma: <span class="hljs-string"><span class="hljs-string">"russian"</span></span>, quote: <span class="hljs-string"><span class="hljs-string">"  ."</span></span> }</code> </pre> <br><p>  The index will look like this: </p><br><pre> <code class="python hljs">db.text.createIndex( { quote : <span class="hljs-string"><span class="hljs-string">"text"</span></span> }, { language_override: <span class="hljs-string"><span class="hljs-string">"idioma"</span></span> } )</code> </pre> <br><p>  The index can be assigned a special name <code>{ name: "name" }</code> , for example: </p><br><pre> <code class="python hljs">db.text.createIndex( { content: <span class="hljs-string"><span class="hljs-string">"text"</span></span>, <span class="hljs-string"><span class="hljs-string">"users.title"</span></span>: <span class="hljs-string"><span class="hljs-string">"text"</span></span> }, { name: <span class="hljs-string"><span class="hljs-string">"text_Index"</span></span> } )</code> </pre> <br><p>  The name is convenient to use to remove indexes: </p><br><pre> <code class="python hljs">db.text.dropIndex(<span class="hljs-string"><span class="hljs-string">"text_Index"</span></span>)</code> </pre> <br><p>  Also, for a text index, you can set the value, the weight of the field to search. <br>  For example, set the weight for the following fields: <code>content - 10</code> , <code>keywords - 5</code> , and <code>title - 1</code> . </p><br><pre> <code class="python hljs">db.test.createIndex( { content: <span class="hljs-string"><span class="hljs-string">"text"</span></span>, tags: <span class="hljs-string"><span class="hljs-string">"text"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"text"</span></span> }, { weights: { content: <span class="hljs-number"><span class="hljs-number">10</span></span>, tags: <span class="hljs-number"><span class="hljs-number">5</span></span>, }, name: <span class="hljs-string"><span class="hljs-string">"TextIndex"</span></span>} )</code> </pre> <br><p>  Through the index, you can limit the number of records in the issue: </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, dept: <span class="hljs-string"><span class="hljs-string">"one"</span></span>, content: <span class="hljs-string"><span class="hljs-string">"red"</span></span> } { _id: <span class="hljs-number"><span class="hljs-number">3</span></span>, dept: <span class="hljs-string"><span class="hljs-string">"one"</span></span>, content: <span class="hljs-string"><span class="hljs-string">"red"</span></span> } { _id: <span class="hljs-number"><span class="hljs-number">2</span></span>, dept: <span class="hljs-string"><span class="hljs-string">"two"</span></span>, content: <span class="hljs-string"><span class="hljs-string">"gren"</span></span> } db.test.createIndex( { dept: <span class="hljs-number"><span class="hljs-number">1</span></span>, content: <span class="hljs-string"><span class="hljs-string">"text"</span></span> } ) db.test.find( { dept: <span class="hljs-string"><span class="hljs-string">"one"</span></span>, $text: { $search: <span class="hljs-string"><span class="hljs-string">"green"</span></span> } } )</code> </pre> <br><p>  The output will be only one document instead of two, since we have limited the index. <br>  Sample index for <code>Python</code> : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#PyMongo db.text.ensure_index( [ ('descr', "text" ), ( 'title.ru', "text" ) ], default_language="russian", name="full_text")</span></span></code> </pre> <br><h5>  Text search </h5><br><p>  Immediately after the appearance of the text search in mongodb, it was carried out using <code>runCommand</code> for example: </p><br><pre> <code class="python hljs">db.collection.runCommand( <span class="hljs-string"><span class="hljs-string">"text"</span></span>, { search: <span class="hljs-string"><span class="hljs-string">""</span></span> } )</code> </pre> <br><p>  but, starting with version <code>2.6</code> , a new <em><font color="blue">$ text</font></em> operator has appeared <br>  Search for one word: </p><br><pre> <code class="python hljs">db.articles.find( { $text: { $search: <span class="hljs-string"><span class="hljs-string">"coffee"</span></span> } } )</code> </pre> <br><p>  Search for multiple words: </p><br><pre> <code class="python hljs">db.articles.find( { $text: { $search: <span class="hljs-string"><span class="hljs-string">"bake coffee cake"</span></span> } } )</code> </pre> <br><p>  Search by phrase: </p><br><pre> <code class="python hljs">db.articles.find( { $text: { $search: <span class="hljs-string"><span class="hljs-string">"\"coffee cake\""</span></span> } } )</code> </pre> <br><p>  Excluding a field from a search in <em><font color="blue">-</font></em> </p><br><pre> <code class="python hljs">db.articles.find( { $text: { $search: <span class="hljs-string"><span class="hljs-string">"bake coffee -cake"</span></span> } } )</code> </pre> <br><p>  Also with <code>mongodb 2.6</code> , another <em><font color="blue">$ meta</font></em> operator appeared, showing the accuracy of the result match with the query. </p><br><pre> <code class="python hljs">db.text.insert([ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"  "</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"    -"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"  "</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"   "</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"  "</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">",    "</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">",    "</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"   "</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"  "</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">" "</span></span> }, ]) db.text.createIndex( { descr : <span class="hljs-string"><span class="hljs-string">"text"</span></span> }, { default_language: <span class="hljs-string"><span class="hljs-string">"russian"</span></span> } ) db.text.find( { $text: { $search: <span class="hljs-string"><span class="hljs-string">""</span></span> } }, { score: { $meta: <span class="hljs-string"><span class="hljs-string">"textScore"</span></span> } }).sort( { score: { $meta: <span class="hljs-string"><span class="hljs-string">"textScore"</span></span> } } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span> : <span class="hljs-number"><span class="hljs-number">0.75</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span> : <span class="hljs-number"><span class="hljs-number">0.6666666666666666</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span> : <span class="hljs-number"><span class="hljs-number">0.6666666666666666</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span> : <span class="hljs-number"><span class="hljs-number">0.6666666666666666</span></span> }</code> </pre> <br><p>  Here <code>{ score: { $meta: "textScore" } }</code> we create a new field, its value contains the result and then it already participates in sorting. <br>  <em><font color="blue">$ Regex search</font></em> <br>  <code>MongoDB</code> uses <code>Perl</code> compatible regular expressions. </p><br><pre> <code class="python hljs">db.test.insert([ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc123"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc123"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> : <span class="hljs-string"><span class="hljs-string">"eee789"</span></span> } ]) db.test.find( { sku: { $regex: /^ABC/i } } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"sku"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc123"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Single line description."</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"sku"</span></span> : <span class="hljs-string"><span class="hljs-string">"abc123"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Single line description."</span></span> }</code> </pre> <br><p>  <code>i</code> - Case insensitivity. <br>  <code>PostgreSQL</code> </p><br><pre> <code class="bash hljs">select title from article <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> title ~ <span class="hljs-string"><span class="hljs-string">'^a'</span></span> <span class="hljs-string"><span class="hljs-string">'abc'</span></span></code> </pre> <br><h3><a name="4"></a>  <font color="green">Atomic operators (modifying data)</font> </h3><br><p>  As a rule, all these modifiers are used for update operations in <code>db.test.update()</code> and <code>db.test.findAndModify()</code> </p><br><p>  <em><font color="blue">$ inc increment</font></em> <br>  Increases or decreases the field by the specified value. </p><br><pre> <code class="python hljs">db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $inc: { qty: <span class="hljs-number"><span class="hljs-number">-2</span></span>, <span class="hljs-string"><span class="hljs-string">"orders"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } } )</code> </pre> <br><p>  <em><font color="blue">$ mul multiplicative increment</font></em> <br>  Multiplies the field value by the specified amount. </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">5</span></span>, item: <span class="hljs-string"><span class="hljs-string">"mac"</span></span>, price: <span class="hljs-number"><span class="hljs-number">10</span></span> } db.test.update({ _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $mul: { price: <span class="hljs-number"><span class="hljs-number">2</span></span> } } ) { _id: <span class="hljs-number"><span class="hljs-number">5</span></span>, item: <span class="hljs-string"><span class="hljs-string">"mac"</span></span>, price : <span class="hljs-number"><span class="hljs-number">20</span></span> }</code> </pre> <br><p>  <em><font color="blue">$ rename rename field</font></em> </p><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"alex"</span></span> } db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $rename: { <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'alias'</span></span>} } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"alex"</span></span> }</code> </pre> <br><p>  <em><font color="blue">$ set changes field values</font></em> <br>  This is probably the main modifying operator used with <code>update</code> .  Often he is remembered as unpretentious transactions in the context of mongodb. </p><br><pre> <code class="python hljs">db.test.save({ <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, tags:<span class="hljs-string"><span class="hljs-string">""</span></span> }) db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">8</span></span> }, { $set: { qty: <span class="hljs-number"><span class="hljs-number">100</span></span>, tags: [ <span class="hljs-string"><span class="hljs-string">"linux"</span></span>, <span class="hljs-string"><span class="hljs-string">"ubuntu"</span></span>] } }) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"tags"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"linux"</span></span>, <span class="hljs-string"><span class="hljs-string">"ubuntu"</span></span> ] }</code> </pre> <br><p>  <em><font color="blue">$ setOnInsert adds fields to a new document.</font></em> <br>  In the <code>update</code> third argument is the <code>{ upsert: true }</code> option, which means that if the document for the change is not found, then we create a new one.  And the <code>$setOnInsert</code> option tells us which fields to insert there. </p><br><pre> <code class="python hljs">&gt;db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">7</span></span> }, { $set: { item: <span class="hljs-string"><span class="hljs-string">"windows"</span></span> }, $setOnInsert: { os: <span class="hljs-string"><span class="hljs-string">'bad'</span></span> } }, { upsert: true } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span> : <span class="hljs-string"><span class="hljs-string">"windows"</span></span>, <span class="hljs-string"><span class="hljs-string">"os"</span></span> : <span class="hljs-string"><span class="hljs-string">"bad"</span></span> }</code> </pre> <br><p>  The field for which we execute <code>$set</code> will also appear in the newly created document. <br>  <em><font color="blue">$ unset deletes the key</font></em> </p><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">"qty"</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"tags"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"linux"</span></span>, <span class="hljs-string"><span class="hljs-string">"ubuntu"</span></span> ] } db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">8</span></span> }, { $unset: { qty: <span class="hljs-string"><span class="hljs-string">""</span></span>, tags: <span class="hljs-string"><span class="hljs-string">""</span></span> } } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">8</span></span> }</code> </pre> <br><p>  <em><font color="blue">$ min updates if less</font></em> <br>  <code>$min</code> updates a field; if the specified value is less than the current field value, <code>$min</code> can compare values ‚Äã‚Äãof different types. </p><br><pre> <code class="python hljs">&gt; db.test.save({ _id: <span class="hljs-number"><span class="hljs-number">9</span></span>, high: <span class="hljs-number"><span class="hljs-number">800</span></span>, low: <span class="hljs-number"><span class="hljs-number">200</span></span> }) &gt; db.test.update( { _id:<span class="hljs-number"><span class="hljs-number">9</span></span> }, { $min: { low: <span class="hljs-number"><span class="hljs-number">150</span></span> } } ) &gt;db.test.findOne({_id:<span class="hljs-number"><span class="hljs-number">9</span></span>}) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-string"><span class="hljs-string">"high"</span></span> : <span class="hljs-number"><span class="hljs-number">800</span></span>, <span class="hljs-string"><span class="hljs-string">"low"</span></span> : <span class="hljs-number"><span class="hljs-number">150</span></span> }</code> </pre> <br><p>  <em><font color="blue">$ max updates if more</font></em> <br>  <code>$max</code> updates the field if the specified value is greater than the current field value. </p><br><pre> <code class="python hljs">&gt; db.test.save({ _id: <span class="hljs-number"><span class="hljs-number">9</span></span>, high: <span class="hljs-number"><span class="hljs-number">800</span></span>, low: <span class="hljs-number"><span class="hljs-number">200</span></span> }) &gt; db.test.update( { _id:<span class="hljs-number"><span class="hljs-number">9</span></span> }, { $max: { high: <span class="hljs-number"><span class="hljs-number">900</span></span> } } ) &gt; db.test.findOne({_id:<span class="hljs-number"><span class="hljs-number">9</span></span>}) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-string"><span class="hljs-string">"high"</span></span> : <span class="hljs-number"><span class="hljs-number">900</span></span>, <span class="hljs-string"><span class="hljs-string">"low"</span></span> : <span class="hljs-number"><span class="hljs-number">200</span></span> }</code> </pre> <br><p>  <em><font color="blue">$ currentDate sets the current date</font></em> <br>  Sets the field value to the current date. </p><br><pre> <code class="python hljs">&gt; db.test.save({ _id:<span class="hljs-number"><span class="hljs-number">11</span></span>, status: <span class="hljs-string"><span class="hljs-string">"init"</span></span>, date: ISODate(<span class="hljs-string"><span class="hljs-string">"2015-05-05T01:11:11.111Z"</span></span>) }) &gt; db.test.update( { _id:<span class="hljs-number"><span class="hljs-number">12</span></span> }, { $currentDate: { date: true } } ) &gt; db.test.findOne({_id:<span class="hljs-number"><span class="hljs-number">12</span></span>}) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">"status"</span></span> : <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-string"><span class="hljs-string">"date"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2015-05-10T21:07:31.138Z"</span></span>) }</code> </pre> <br><h5>  Array changes </h5><br><p>  <em><font color="blue">$ addToSet adds value if none</font></em> <br>  Adds a value to an array, if it is not there yet, and if it is, it does nothing. </p><br><pre> <code class="python hljs">db.test.save({ _id:<span class="hljs-number"><span class="hljs-number">1</span></span>, array: [<span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-string"><span class="hljs-string">"b"</span></span>] }) db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $addToSet: {array: [ <span class="hljs-string"><span class="hljs-string">"c"</span></span>, <span class="hljs-string"><span class="hljs-string">"d"</span></span> ] } } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"array"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-string"><span class="hljs-string">"b"</span></span>, [ <span class="hljs-string"><span class="hljs-string">"c"</span></span>, <span class="hljs-string"><span class="hljs-string">"d"</span></span> ] ] } db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $addToSet: {array: <span class="hljs-string"><span class="hljs-string">"e"</span></span> } } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"array"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-string"><span class="hljs-string">"b"</span></span>, [ <span class="hljs-string"><span class="hljs-string">"c"</span></span>, <span class="hljs-string"><span class="hljs-string">"d"</span></span> ], <span class="hljs-string"><span class="hljs-string">"e"</span></span> ] }</code> </pre> <br><p>  <em><font color="blue">$ pop deletes 1st or last</font></em> <br>  Removes the first or last element of an array.  If -1 is specified, it will delete the first element, if it is 1, then the last one. </p><br><pre> <code class="python hljs">&gt; db.test.save({ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, scores: [ <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span> ] }) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"scores"</span></span> : [ <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span> ] } &gt; db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $pop: { scores: <span class="hljs-number"><span class="hljs-number">-1</span></span> } } ) &gt; db.test.findOne({_id:<span class="hljs-number"><span class="hljs-number">1</span></span>}) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"scores"</span></span> : [ <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span> ] } &gt; db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $pop: { scores: <span class="hljs-number"><span class="hljs-number">1</span></span> } } ) &gt; db.test.findOne({_id:<span class="hljs-number"><span class="hljs-number">1</span></span>}) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"scores"</span></span> : [ <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span> ] }</code> </pre> <br><p>  <em><font color="blue">$ pullAll removes all specified</font></em> <br>  Removes all the specified elements from the array. </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, scores: [ <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ] } db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $pullAll: { scores: [ <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> ] } } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"scores"</span></span> : [ <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> ] }</code> </pre> <br><p>  <em><font color="blue">$ pull removes as requested</font></em> </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, votes: [ <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span> ] } &gt; db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $pull: { votes: { $gte: <span class="hljs-number"><span class="hljs-number">6</span></span> } } } ) { _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, votes: [ <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> ] }</code> </pre> <br><p>  <em><font color="blue">$ push adds values</font></em> <br>  Adds values ‚Äã‚Äãto an array. </p><br><pre> <code class="python hljs">db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $push: { scores: <span class="hljs-number"><span class="hljs-number">100</span></span>} } )</code> </pre> <br><p>  <code>$pushAll</code> - considered obsolete </p><br><h5>  Modifiers for $ push </h5><br><p>  <em><font color="blue">$ each at once a lot</font></em> <br>  Adds each of the listed elements to the array. <br>  For example, if we do this: <code>{ $push: { scores: [ 2, 10 ] } }</code> <br>  Then the output will be the following array: <code>"scores" : [7, 8, 9, 90, 92, 85, [ 2, 10 ] ]</code> <br>  that is, one more element was added which is an array. <br>  And if in <code>$each</code> , then each element of the list is added as an element of the array: </p><br><pre> <code class="python hljs">&gt; db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $push: {scores: { $each: [ <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">92</span></span>, <span class="hljs-number"><span class="hljs-number">85</span></span> ] } } } ) {<span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"scores"</span></span> : [<span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">92</span></span>, <span class="hljs-number"><span class="hljs-number">85</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span> ] }</code> </pre> <br><p>  <em><font color="blue">$ slice limits the number of elements when using $ push</font></em> <br>  Limits the number of elements in an array when inserted using <code>$push</code> .  Be sure to use <code>$each</code> if you try to use without it, it will return an error. </p><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"scores"</span></span> : [ <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span> ] } &gt; db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $push: { scores: { $each: [<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>], $slice: <span class="hljs-number"><span class="hljs-number">-5</span></span> } } } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"scores"</span></span> : [ <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span> ] }</code> </pre> <br><p>  <code>$slice</code> cut the first element <code>20</code> .  if we indicated not <code>-5</code> but <code>5</code> he would have thrown off the last element <code>70</code> . </p><br><p>  <em><font color="blue">$ sort sorting array elements</font></em> <br>  Sorts the elements of the array according to the specified field.  Also be sure to use with the <code>$each</code> operator.  If you just need to sort without an insert, you can leave <code>$each</code> empty. </p><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"tests"</span></span> : [ <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span> ] } &gt; db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">2</span></span> }, { $push: { tests: { $each: [<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>], $sort: <span class="hljs-number"><span class="hljs-number">1</span></span> } } }) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"tests"</span></span> : [ <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span> ] }</code> </pre> <br><p>  Another example: </p><br><pre> <code class="python hljs">db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $push: { field: { $each: [ ], $sort: { score: <span class="hljs-number"><span class="hljs-number">1</span></span> } } } }) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"field"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span> : <span class="hljs-number"><span class="hljs-number">5</span></span> }, { <span class="hljs-string"><span class="hljs-string">"id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span> }, { <span class="hljs-string"><span class="hljs-string">"id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span> : <span class="hljs-number"><span class="hljs-number">7</span></span> }, ] }</code> </pre> <br><p>  <em><font color="blue">$ position indicates insertion position</font></em> <br>  Specifies from which element of the array to insert values. </p><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"scores"</span></span> : [ <span class="hljs-number"><span class="hljs-number">100</span></span> ] } db.test.update({ _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, {$push: { scores: { $each: [<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>], $position: <span class="hljs-number"><span class="hljs-number">0</span></span> } } }) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"scores"</span></span> : [ <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span> ] }</code> </pre> <br><p>  <em><font color="blue">$ bit updates bit by bit</font></em> <br>  Performs a bitwise field update.  The operator supports bitwise <code>and</code> , <code>or</code> and <code>xor</code> . </p><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"expdata"</span></span> : <span class="hljs-number"><span class="hljs-number">13</span></span> } &gt; db.bit.update({_id:<span class="hljs-number"><span class="hljs-number">1</span></span>}, {$bit:{expdata:{<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>:NumberInt(<span class="hljs-number"><span class="hljs-number">10</span></span>)} } } ) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"expdata"</span></span> : <span class="hljs-number"><span class="hljs-number">8</span></span> }</code> </pre> <br><p>  <em><font color="blue">$ isolated - atomization</font></em> <br>  Blocks a document for reading and writing while it is being processed, for example, an update operation. <br>  Using <code>$isolated</code> when deleting: </p><br><pre> <code class="python hljs">db.test.remove( { temp: { $lt: <span class="hljs-number"><span class="hljs-number">10</span></span> }, $isolated: <span class="hljs-number"><span class="hljs-number">1</span></span> } )</code> </pre> <br><p>  Using <code>$isolated</code> when updating: </p><br><pre> <code class="python hljs">db.test.update( {status: <span class="hljs-string"><span class="hljs-string">"init"</span></span> , $isolated: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $inc: { count : <span class="hljs-number"><span class="hljs-number">1</span></span> }}, {multi: true } )</code> </pre> <br><p>  <i>$ isolated does not work with shard Clusters</i> <br>  Since version <code>2.2</code> : <code>$isolated</code> operator replaced <code>$atomic</code> </p><br><h3><a name="5"></a>  <font color="green">About transactions in mongodb, a unique index, a two-phase commit</font> </h3><br><p>  Naturally, such transactions as in classic <code>SQL</code> solutions like <code>PostgreeSQL</code> in <code>MongoDB</code> are not and probably cannot be.  And if it does, it will be, rather, a relational database with full normalization and integrity control. <br>  Therefore, when speaking of transactions in <code>mongoDB</code> , <code>mongoDB</code> , as a rule, mean atomic operations like <code>$set</code> , used in <code>update()</code> and <code>findAndModify()</code> in combination with a unique index.  As well as a two-phase commit that is common among relational databases, if you need to secure transactions within several databases. </p><br><h3><a name="51"></a>  <font color="blue">Unique index</font> </h3><br><p>  The unique index in <code>mongodb</code> is the reason for rejecting all documents that contain duplicate values ‚Äã‚Äãfor indexed fields. </p><br><pre> <code class="python hljs">db.test.createIndex( { <span class="hljs-string"><span class="hljs-string">"user_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { unique: true } )</code> </pre> <br><p>  There is a collection, let's call it <code>test</code> , in this collection there are no documents whose <code>name</code> field would have the value <code>Nik</code> .  Suppose that several clients simultaneously try to update this document with the <code>{ upsert: true }</code> parameter (means that if by condition there is no such document to be updated, then it needs to be created). <br>  Example: </p><br><pre> <code class="python hljs">db.test.update( { name: <span class="hljs-string"><span class="hljs-string">"Nik"</span></span> }, { name: <span class="hljs-string"><span class="hljs-string">"Nik"</span></span>, vote: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { upsert: true } )</code> </pre> <br><p>    <code>update()</code>        ,       ,      ,       . </p><br><p>           ,      .         .       ,          . </p><br><p>   <code>unique</code>  <code>false</code>   <code>MongoDB</code> </p><br><h3><a name="52"></a> <font color="blue"> </font> </h3><br><p>    ,        <code>A</code>   <code>B</code> . <br>       : </p><br><ul><li>  `accounts`          . </li><li>   `transactions`       ,     . </li></ul><br><p> <em><font color="blue">  accounts  transactions</font></em> <br>    <code>accounts</code>      <code></code>  <code></code> </p><br><pre> <code class="python hljs">db.accounts.insert( [ { _id: <span class="hljs-string"><span class="hljs-string">"A"</span></span>, balance: <span class="hljs-number"><span class="hljs-number">1000</span></span>, pendingTransactions: [] }, { _id: <span class="hljs-string"><span class="hljs-string">"B"</span></span>, balance: <span class="hljs-number"><span class="hljs-number">1000</span></span>, pendingTransactions: [] } ] )</code> </pre> <br><p>   <code>transactions</code>          . </p><br><pre> <code class="python hljs">db.transactions.insert({ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, source: <span class="hljs-string"><span class="hljs-string">"A"</span></span>, destination: <span class="hljs-string"><span class="hljs-string">"B"</span></span>, value: <span class="hljs-number"><span class="hljs-number">100</span></span>, state: <span class="hljs-string"><span class="hljs-string">"initial"</span></span>, lastModified: new Date()})</code> </pre> <br><p>      : </p><br><ul><li>  <code>source</code>  <code>destination</code>           . </li><li>  <code>value</code> ,         . </li><li>  <code>state</code>      .     <code>initial</code> , <code>pending</code> , <code>applied</code> , <code>done</code> , <code>canceling</code> ,  <code>canceled</code> . </li><li> <code>lastModified</code>        . </li></ul><br><p> <em><font color="blue">1)    </font></em> <br>    ,   <code>initial</code> .     <code>t</code> </p><br><pre> <code class="bash hljs">&gt; var t = db.transactions.findOne( { state: <span class="hljs-string"><span class="hljs-string">"initial"</span></span> } ) &gt; t { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"source"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"destination"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span> : 100, <span class="hljs-string"><span class="hljs-string">"state"</span></span> : <span class="hljs-string"><span class="hljs-string">"initial"</span></span>, <span class="hljs-string"><span class="hljs-string">"lastModified"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2015-05-26T16:35:54.637Z"</span></span>) }</code> </pre> <br><p> <em><font color="blue">2)      pending</font></em> <br>      <code>initial</code>  <code>pending</code>    . </p><br><pre> <code class="python hljs">&gt; db.transactions.update( { _id: t._id, state: <span class="hljs-string"><span class="hljs-string">"initial"</span></span> }, { $set: { state: <span class="hljs-string"><span class="hljs-string">"pending"</span></span> }, $currentDate: { lastModified: true } } ) &gt; db.transactions.find() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"destination"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"state"</span></span> : <span class="hljs-string"><span class="hljs-string">"pending"</span></span>, <span class="hljs-string"><span class="hljs-string">"lastModified"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2015-05-26T17:02:19.002Z"</span></span>) } &gt;</code> </pre> <br><p> <em><font color="blue">3)   </font></em> <br>      ,    ,   <code>value</code>   ,    <code>pendingTransactions</code>  <code>_id</code>  (     ). </p><br><pre> <code class="python hljs">&gt; db.accounts.update( { _id: t.source, pendingTransactions: { $ne: t._id } }, { $inc: { balance: -t.value }, $push: { pendingTransactions: t._id } } ) &gt; db.accounts.update( { _id: t.destination, pendingTransactions: { $ne: t._id } }, { $inc: { balance: t.value }, $push: { pendingTransactions: t._id } } ) &gt; db.accounts.find() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"balance"</span></span> : <span class="hljs-number"><span class="hljs-number">900</span></span>, <span class="hljs-string"><span class="hljs-string">"pendingTransactions"</span></span> : [ <span class="hljs-number"><span class="hljs-number">1</span></span> ] } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"balance"</span></span> : <span class="hljs-number"><span class="hljs-number">1100</span></span>, <span class="hljs-string"><span class="hljs-string">"pendingTransactions"</span></span> : [ <span class="hljs-number"><span class="hljs-number">1</span></span> ] }</code> </pre> <br><p> <em><font color="blue">4)     applied</font></em> <br>           . </p><br><pre> <code class="python hljs">&gt; db.transactions.update( { _id: t._id, state: <span class="hljs-string"><span class="hljs-string">"pending"</span></span> }, { $set: { state: <span class="hljs-string"><span class="hljs-string">"applied"</span></span> }, $currentDate: { lastModified: true } } ) &gt; db.transactions.find() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"destination"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"state"</span></span> : <span class="hljs-string"><span class="hljs-string">"applied"</span></span>, <span class="hljs-string"><span class="hljs-string">"lastModified"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2015-05-26T17:13:15.517Z"</span></span>) }</code> </pre> <br><p> <em><font color="blue">5)  _id    </font></em> <br>         <code>pendingTransactions</code> : <code>_id</code>       <code>pendingTransactions</code> . </p><br><pre> <code class="python hljs">&gt; db.accounts.update( { _id: t.source, pendingTransactions: t._id }, { $pull: { pendingTransactions: t._id } } ) &gt; db.accounts.update( { _id: t.destination, pendingTransactions: t._id }, { $pull: { pendingTransactions: t._id } } ) &gt; db.accounts.find() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"balance"</span></span> : <span class="hljs-number"><span class="hljs-number">900</span></span>, <span class="hljs-string"><span class="hljs-string">"pendingTransactions"</span></span> : [ ] } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"balance"</span></span> : <span class="hljs-number"><span class="hljs-number">1100</span></span>, <span class="hljs-string"><span class="hljs-string">"pendingTransactions"</span></span> : [ ] }</code> </pre><br><p> <em><font color="blue">6)     done</font></em> <br>     . </p><br><pre> <code class="python hljs">&gt; db.transactions.update( { _id: t._id, state: <span class="hljs-string"><span class="hljs-string">"applied"</span></span> }, { $set: { state: <span class="hljs-string"><span class="hljs-string">"done"</span></span> }, $currentDate: { lastModified: true } } ) &gt; db.transactions.find() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"destination"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"state"</span></span> : <span class="hljs-string"><span class="hljs-string">"done"</span></span>, <span class="hljs-string"><span class="hljs-string">"lastModified"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2015-05-26T17:22:22.194Z"</span></span>) }</code> </pre> <br><h5>    </h5><br><p>         .         . <br> <em><font color="blue">1)    canceling</font></em> <br>   ,    ,    <code>canceling</code> . </p><br><pre> <code class="python hljs">db.transactions.update( { _id: t._id, state: <span class="hljs-string"><span class="hljs-string">"pending"</span></span> }, {$set: { state: <span class="hljs-string"><span class="hljs-string">"canceling"</span></span> }, $currentDate: { lastModified: true }} ) &gt; db.transactions.find() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"destination"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"state"</span></span> : <span class="hljs-string"><span class="hljs-string">"canceling"</span></span>, <span class="hljs-string"><span class="hljs-string">"lastModified"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2015-05-26T18:29:28.018Z"</span></span>) }</code> </pre> <br><p> <em><font color="blue">2)     </font></em> <br>        . </p><br><pre> <code class="python hljs">&gt; db.accounts.update( { _id: t.destination, pendingTransactions: t._id }, { $inc: { balance: -t.value }, $pull: { pendingTransactions: t._id } } ) &gt; db.accounts.update( { _id: t.source, pendingTransactions: t._id }, { $inc: { balance: t.value}, $pull: { pendingTransactions: t._id } } ) &gt; db.accounts.find() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"balance"</span></span> : <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">"pendingTransactions"</span></span> : [ <span class="hljs-number"><span class="hljs-number">1</span></span> ] } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"balance"</span></span> : <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">"pendingTransactions"</span></span> : [ <span class="hljs-number"><span class="hljs-number">1</span></span> ] } &gt;</code> </pre> <br><p> <em><font color="blue">3)    cancelled</font></em> <br>      . </p><br><pre> <code class="python hljs">db.transactions.update( { _id: t._id, state: <span class="hljs-string"><span class="hljs-string">"canceling"</span></span> }, { $set: { state: <span class="hljs-string"><span class="hljs-string">"cancelled"</span></span> }, $currentDate: { lastModified: true } } ) &gt; db.transactions.find() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span> : <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"destination"</span></span> : <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"state"</span></span> : <span class="hljs-string"><span class="hljs-string">"cancelled"</span></span>, <span class="hljs-string"><span class="hljs-string">"lastModified"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2015-05-26T19:14:11.830Z"</span></span>) }</code> </pre> <br><h5>      </h5><br><p>    ,             .            . <br>     <code>findAndModify()</code> ,            : </p><br><pre> <code class="python hljs">t = db.transactions.findAndModify({ query: { state: <span class="hljs-string"><span class="hljs-string">"initial"</span></span>, application: { $exists: false } }, update: {$set: { state: <span class="hljs-string"><span class="hljs-string">"pending"</span></span>, application: <span class="hljs-string"><span class="hljs-string">"App1"</span></span>}, $currentDate:{ lastModified: true }}, new: true })</code> </pre> <br><h3><a name="6"></a> <font color="green">6.    JOIN-</font> </h3><br><p>    <code>JOIN</code> -  <code>mongo</code>    , -       .       <code>stackoverflow</code> ,   ,   . </p><br><p> ,  ,   ,      ,    . </p><br><p>         -    ,       ,  <code>{ type: 'news' }</code> . </p><br><p>         ,      ,      . </p><br><p>  ,            ,       <code>aggregation framework</code> .          <code>pipeline</code> . ,    ,          , , ,   .. </p><br><p> ,      ,           . </p><br><pre> <code class="python hljs">db.test.insert([ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>:[<span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span>] }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>:<span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>:[<span class="hljs-string"><span class="hljs-string">"user"</span></span>] } ])</code> </pre> <br><p>          . </p><br><pre> <code class="python hljs">db.test.insert([ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"blogs"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span>: <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"blogs"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span>: <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"blogs"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span>: <span class="hljs-string"><span class="hljs-string">"ccc"</span></span> } ])</code> </pre> <br><p>        ,         .        ,     . </p><br><p>      ,  ,  ,    "". </p><br><pre> <code class="python hljs">users = [doc._id <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> doc <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> db.test.find({<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'group'</span></span>: {<span class="hljs-string"><span class="hljs-string">'$all'</span></span>: [<span class="hljs-string"><span class="hljs-string">'author'</span></span>]}})] articles = db.test.find({<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"blogs"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: {<span class="hljs-string"><span class="hljs-string">'$in'</span></span>: users})</code> </pre> <br><p>   c   SQL        : </p><br><pre> <code class="python hljs">SELECT blogs.* FROM blogs, user, usergroup, group WHERE blogs.user = user.id AND usergroup.user = user.id AND usergroup.group = group.id AND group.name = <span class="hljs-string"><span class="hljs-string">'author'</span></span>;</code> </pre> <br><p>          user,      d  jsonb.     ‚Äî         : </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> blogs.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> blogs, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> blogs.user = user.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> user.group ? <span class="hljs-string"><span class="hljs-string">'author'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> blogs.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d-&gt;<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">'blogs'</span></span>) blogs, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d-&gt;<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">'user'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> blogs.d-&gt;<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = user.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> user.d-&gt;<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> ? <span class="hljs-string"><span class="hljs-string">'author'</span></span>;</code> </pre> <br><p>          pipe. </p><br><pre> <code class="python hljs">db.test.aggregate([ { $match: { $<span class="hljs-keyword"><span class="hljs-keyword">or</span></span>: [ {type: <span class="hljs-string"><span class="hljs-string">"blogs"</span></span>}, {type: <span class="hljs-string"><span class="hljs-string">"user"</span></span>} ] } }, { $project: { a: <span class="hljs-number"><span class="hljs-number">1</span></span>, blogs: { $cond: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>: { type: <span class="hljs-string"><span class="hljs-string">'$blogs'</span></span>}, then: {_id:<span class="hljs-string"><span class="hljs-string">"$_id"</span></span>, user:<span class="hljs-string"><span class="hljs-string">"$user"</span></span>, article:<span class="hljs-string"><span class="hljs-string">"$article"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: null } }, user: { $cond: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>: { type: <span class="hljs-string"><span class="hljs-string">'$user'</span></span> }, then: { _id:<span class="hljs-string"><span class="hljs-string">"$_id"</span></span>, group:<span class="hljs-string"><span class="hljs-string">"$group"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: null } } } }, { $group : { _id : { a: <span class="hljs-string"><span class="hljs-string">"$a"</span></span> }, user: { $push: <span class="hljs-string"><span class="hljs-string">"$user"</span></span> }, blog: { $push: <span class="hljs-string"><span class="hljs-string">"$blogs"</span></span> }, } }, { $unwind : <span class="hljs-string"><span class="hljs-string">"$blog"</span></span> }, { $unwind : <span class="hljs-string"><span class="hljs-string">"$user"</span></span> }, { $project:{ user: <span class="hljs-string"><span class="hljs-string">"$user"</span></span>, article: <span class="hljs-string"><span class="hljs-string">"$blog"</span></span>, matches: { $eq:[ <span class="hljs-string"><span class="hljs-string">"$user._id"</span></span>, <span class="hljs-string"><span class="hljs-string">"$blog.user"</span></span> ] } } }, { $match: { matches: true } } ])</code> </pre> <br><p>       .    7 . <br>  ,    <code>mongodb</code>    <code>pipeline</code>   .       , ,    ,      ,    ,             . </p><br><table border="1"><thead><tr><th> SQL Terms, Functions, and Concepts </th><th> MongoDB Aggregation Operators </th></tr></thead><tbody><tr><td>  <font color="goldenrod">WHERE</font> </td><td> <font color="YellowGreen">$match</font> </td></tr><tr><td> <font color="goldenrod">GROUP BY</font> </td><td> <font color="YellowGreen">$group</font> </td></tr><tr><td> <font color="goldenrod">HAVING</font> </td><td> <font color="YellowGreen">$match</font> </td></tr><tr><td>  <font color="goldenrod">SELECT</font> </td><td> <font color="YellowGreen">$project</font> </td></tr><tr><td> <font color="goldenrod">ORDER BY</font> </td><td> <font color="YellowGreen">$sort</font> </td></tr><tr><td> <font color="goldenrod">LIMIT</font> </td><td> <font color="YellowGreen">$limit</font> </td></tr><tr><td> <font color="goldenrod">SUM()</font> </td><td> <font color="YellowGreen">$sum</font> </td></tr><tr><td> <font color="goldenrod">COUNT()</font> </td><td> <font color="YellowGreen">$sum</font> </td></tr><tr><td> <font color="goldenrod">join</font> </td><td>    <font color="YellowGreen">$unwind</font> </td></tr></tbody></table><br><p>         . </p><br><pre> <code class="python hljs">&gt; db.ag.aggregate([ { $match: {$<span class="hljs-keyword"><span class="hljs-keyword">or</span></span>:[{type:<span class="hljs-string"><span class="hljs-string">"blogs"</span></span>},{type:<span class="hljs-string"><span class="hljs-string">"user"</span></span>}]} } ]) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span> ] } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"user"</span></span> ] } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"blogs"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"blogs"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"blogs"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"ccc"</span></span> }</code> </pre> <br><p>     <code>$match</code>   <code>find()</code> ,     ,      . <br>  c  <code>$project</code>    ,    <code>blogs</code>  <code>users</code> .       <code>2.6</code>  <code>$cond</code>       .          <code>blogs</code>  <code>users</code> ,     . </p><br><pre> <code class="python hljs">db.test.aggregate([ { $match: {$<span class="hljs-keyword"><span class="hljs-keyword">or</span></span>:[ { type:<span class="hljs-string"><span class="hljs-string">"blogs"</span></span>}, { type: <span class="hljs-string"><span class="hljs-string">"user"</span></span>} ] } }, { $project: { a: <span class="hljs-number"><span class="hljs-number">1</span></span>, blogs: { $cond: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>: {type: <span class="hljs-string"><span class="hljs-string">'$blogs'</span></span>}, then: {_id:<span class="hljs-string"><span class="hljs-string">"$_id"</span></span>, user:<span class="hljs-string"><span class="hljs-string">"$user"</span></span>, article:<span class="hljs-string"><span class="hljs-string">"$article"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: null } }, user: { $cond: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>: { type: <span class="hljs-string"><span class="hljs-string">'$user'</span></span>}, then: {_id:<span class="hljs-string"><span class="hljs-string">"$_id"</span></span>, group:<span class="hljs-string"><span class="hljs-string">"$group"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: null } } } } ]) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"blogs"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span> }, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span> ] } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"blogs"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span> }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"user"</span></span> ] } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-string"><span class="hljs-string">"blogs"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span>: <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }, <span class="hljs-string"><span class="hljs-string">"blogs"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span>: <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> }, <span class="hljs-string"><span class="hljs-string">"blogs"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span>: <span class="hljs-string"><span class="hljs-string">"ccc"</span></span> } }</code> </pre> <br><p>     : </p><br><pre> <code class="python hljs">...{ $group : { _id : { a: <span class="hljs-string"><span class="hljs-string">"$a"</span></span> }, user: { $push: <span class="hljs-string"><span class="hljs-string">"$user"</span></span> }, blog: { $push: <span class="hljs-string"><span class="hljs-string">"$blogs"</span></span> }, } }... { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span> ] }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"user"</span></span> ] }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> } ], <span class="hljs-string"><span class="hljs-string">"blog"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"vasya"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span>: <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span>: <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span>: <span class="hljs-string"><span class="hljs-string">"ccc"</span></span>} ] }</code> </pre> <br><div class="spoiler"> <b class="spoiler_title">      $unwind</b> <div class="spoiler_text"><pre> <code class="python hljs">....{ $unwind : <span class="hljs-string"><span class="hljs-string">"$blog"</span></span> }, { $unwind : <span class="hljs-string"><span class="hljs-string">"$user"</span></span> } .... { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span>:null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span>:null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"user"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span>:null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span>: null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>}} { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"user"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"user"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span>: <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"user"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> } } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> }, <span class="hljs-string"><span class="hljs-string">"blog"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> } }</code> </pre> </div></div><br><p>     ,     <code>$eq:[ "$user._id", "$blog.user" ]</code>        <code>"user" : { "_id" : 2 }</code>  <code>"blog" : { "user" : "vasya" }</code>            . </p><br><pre> <code class="python hljs">...{ $project:{ user:<span class="hljs-string"><span class="hljs-string">"$user"</span></span>, article:<span class="hljs-string"><span class="hljs-string">"$blog"</span></span>, matches:{ $eq:[ <span class="hljs-string"><span class="hljs-string">"$user._id"</span></span>, <span class="hljs-string"><span class="hljs-string">"$blog.user"</span></span> ] } } } .....</code> </pre> <br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> }, <span class="hljs-string"><span class="hljs-string">"matches"</span></span> : false } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> }, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> }, <span class="hljs-string"><span class="hljs-string">"matches"</span></span> : false } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> }, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"aaa"</span></span> }, <span class="hljs-string"><span class="hljs-string">"matches"</span></span> : false } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"gomer"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> }, <span class="hljs-string"><span class="hljs-string">"matches"</span></span> : false } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"user"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> }, <span class="hljs-string"><span class="hljs-string">"matches"</span></span> : true } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> }, <span class="hljs-string"><span class="hljs-string">"matches"</span></span> : false } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> }, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> }, <span class="hljs-string"><span class="hljs-string">"matches"</span></span> : false } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"a"</span></span> : null }, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> }, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"article"</span></span> : <span class="hljs-string"><span class="hljs-string">"bbb"</span></span> }, <span class="hljs-string"><span class="hljs-string">"matches"</span></span> : false } Type <span class="hljs-string"><span class="hljs-string">"it"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more</code> </pre> </div></div><br><p>   : </p><br><pre> <code class="python hljs">{ $match: { matches:true } }</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><p> { "_id": { "a": null }, "user": { "_id": "gomer", "group": [ "user", "author" ] }, "article": { "_id": 1, "user": "gomer", "article": "aaa" }, "matches": true } <br> { "_id": { "a": null }, "user": { "_id": "vasya", "group": [ "user" ] }, "article": { "_id": 2, "user": "vasya", "article": "bbb" }, "matches": true } <br> { "_id": { "a": null }, "user": { "_id": "gomer", "group": [ "user", "author" ] }, "article": { "_id": 3, "user": "gomer", "article": "ccc" }, "matches": true } </p></div></div><br><p>     ,    . <br>      ,               . </p><br><p> ,                  <code>pipeline</code> . </p><br><h3><a name="7"></a> <font color="green">7. </font> </h3><br><p>     , ,      .       : </p><br><ul><li>      ,          . </li><li>  ,           . </li></ul><br><h3><a name="71"></a> <font color="blue">,   Mongodb</font> </h3><br><p>  ,      ‚Äî    .   ,      ,     ,    . </p><br><img src="https://habrastorage.org/files/eda/77e/ded/eda77eded16d42f783cf05019e2b81cc.png"><br><p>    . <br>   : </p><br><pre> <code class="python hljs">{ _id:<span class="hljs-number"><span class="hljs-number">1</span></span>, type:<span class="hljs-string"><span class="hljs-string">"blog"</span></span>, title:{ru:<span class="hljs-string"><span class="hljs-string">"O MongoDB"</span></span>, en:<span class="hljs-string"><span class="hljs-string">""</span></span>}, comments: [ { _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, title: <span class="hljs-string"><span class="hljs-string">"one"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"Alex"</span></span>, parent: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, child: [<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>]}, { _id: <span class="hljs-number"><span class="hljs-number">2</span></span>, title: <span class="hljs-string"><span class="hljs-string">"two"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"Serg"</span></span>, parent: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { _id: <span class="hljs-number"><span class="hljs-number">3</span></span>, title: <span class="hljs-string"><span class="hljs-string">"two"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"Andrey"</span></span>, parent: <span class="hljs-number"><span class="hljs-number">1</span></span> } ] }</code> </pre> <br><p>  : </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, type: <span class="hljs-string"><span class="hljs-string">"comment"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"one"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"Alex"</span></span>, parent: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, child: [ <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> ] }, { _id: <span class="hljs-number"><span class="hljs-number">2</span></span>, type: <span class="hljs-string"><span class="hljs-string">"comment"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"two"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"Serg"</span></span>, parent: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { _id: <span class="hljs-number"><span class="hljs-number">3</span></span>, type: <span class="hljs-string"><span class="hljs-string">"comment"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"two"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"Andrey"</span></span>, parent: <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><p>            . <br>  ,       . <br>           ,        ,       "" . </p><br><p>       . <br>       : </p><br><pre> <code class="python hljs">db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $pull: { child: <span class="hljs-number"><span class="hljs-number">2</span></span> } } ) db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $pullAll: { child: [ <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> ] } } )</code> </pre> <br><p>      : </p><br><pre> <code class="python hljs">db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $push: { child: <span class="hljs-number"><span class="hljs-number">2</span></span> } } } ) db.test.update( { _id: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { $push: { child: { $each: [ <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> ] } } } )</code> </pre> <br><p>     : </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(docs)</span></span></span><span class="hljs-function">:</span></span> tree = { doc[<span class="hljs-string"><span class="hljs-string">"_id"</span></span>]: doc <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> doc <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> docs } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> doc <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> docs: doc[<span class="hljs-string"><span class="hljs-string">'child'</span></span>] = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> doc <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> docs: parent = doc[<span class="hljs-string"><span class="hljs-string">"parent"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> parent != <span class="hljs-string"><span class="hljs-string">"root"</span></span>: tree[parent][<span class="hljs-string"><span class="hljs-string">"child"</span></span>].append(doc) docs={<span class="hljs-string"><span class="hljs-string">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, <span class="hljs-string"><span class="hljs-string">"child"</span></span>: [doc <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> doc <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> doc[<span class="hljs-string"><span class="hljs-string">'parent'</span></span>] == <span class="hljs-string"><span class="hljs-string">"root"</span></span> ]} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> docs { _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, type: <span class="hljs-string"><span class="hljs-string">"comment"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"one"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"Alex"</span></span>, parent: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, child: [ { _id: <span class="hljs-number"><span class="hljs-number">2</span></span>, type: <span class="hljs-string"><span class="hljs-string">"comment"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"two"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"Serg"</span></span>, parent: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { _id: <span class="hljs-number"><span class="hljs-number">3</span></span>, type: <span class="hljs-string"><span class="hljs-string">"comment"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"two"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"Andrey"</span></span>, parent: <span class="hljs-number"><span class="hljs-number">1</span></span> } ] }</code> </pre> <br><p>   ,           ,  ,      <code>_id</code>     : </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> db = connect() ctr = db.test.find({<span class="hljs-string"><span class="hljs-string">'type'</span></span>:<span class="hljs-string"><span class="hljs-string">'goods'</span></span>, <span class="hljs-string"><span class="hljs-string">'class'</span></span>:cls}).count() childs = db.test.find_one({<span class="hljs-string"><span class="hljs-string">'_id'</span></span>:cls}) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> childs[<span class="hljs-string"><span class="hljs-string">'child'</span></span>]: ctr += count(res) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ctr</code> </pre> <br><p>    ,  <code>_id</code> ,           : </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">path</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( id )</span></span></span><span class="hljs-function">:</span></span> p = [] parent = db.test.find_one( {<span class="hljs-string"><span class="hljs-string">"_id"</span></span>: id }, { <span class="hljs-string"><span class="hljs-string">"parent"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"alias"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: path.append( ( parent[<span class="hljs-string"><span class="hljs-string">'alias'</span></span>], parent[<span class="hljs-string"><span class="hljs-string">'title'</span></span>] ) ) p += path( parent[<span class="hljs-string"><span class="hljs-string">'parent'</span></span>] ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( path(<span class="hljs-string"><span class="hljs-string">"123"</span></span>) ) &gt;&gt;&gt;[ (<span class="hljs-string"><span class="hljs-string">"one"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>), (<span class="hljs-string"><span class="hljs-string">"two"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>) ]</code> </pre> <br><h3><a name="72"></a> <font color="blue">, </font> </h3><br><p>        ,        <code>{ tags : { ru: ", " } }</code> ,          .          <code>{ tags : [ "", "" ] }</code> . <br>      ,    . <br>    , ,  ,    : </p><br><pre> <code class="python hljs">{ _id: <span class="hljs-number"><span class="hljs-number">1</span></span>, title: <span class="hljs-string"><span class="hljs-string">" "</span></span>, tags: [ <span class="hljs-string"><span class="hljs-string">"php"</span></span>, <span class="hljs-string"><span class="hljs-string">"python"</span></span> ] } db.test.find({ tags: { $<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: [<span class="hljs-string"><span class="hljs-string">"php"</span></span>, <span class="hljs-string"><span class="hljs-string">"python"</span></span> ] } } )</code> </pre> <br><p>    : </p><br><ul><li>  , ,          `python, javascript`. </li><li> ,   ,      , , ¬´¬ª. </li><li>  ,      , ,   . </li><li>        . </li><li>  ,         . </li><li>   ,   ,   ,  , 5  . </li><li>   ,        `+2`  . </li><li>        . </li><li>    `10`   . </li><li>   ,  ,    (  ). </li></ul><br><pre> <code class="python hljs">dt = ( datetime.today() + timedelta( days = <span class="hljs-number"><span class="hljs-number">-5</span></span> ) ) db.test.aggregate([ { $match: { //       type: <span class="hljs-string"><span class="hljs-string">"news"</span></span>, date: { $gt: dt }, //   . vate: { $gte: <span class="hljs-number"><span class="hljs-number">2</span></span> }, //   . user: { $<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: [ <span class="hljs-string"><span class="hljs-string">"alex"</span></span>, <span class="hljs-string"><span class="hljs-string">"pavel"</span></span> ] } $<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>: [ //      . { pub: true }, { accept: true }, //       . { tags: { $<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: [<span class="hljs-string"><span class="hljs-string">"php"</span></span>, <span class="hljs-string"><span class="hljs-string">"python"</span></span> ] } } , //        . { tags: { $nin: [<span class="hljs-string"><span class="hljs-string">""</span></span>] } } ] }, //      . { $sort: {<span class="hljs-string"><span class="hljs-string">'primary'</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>, view: <span class="hljs-number"><span class="hljs-number">-1</span></span>}}, //   ,    <span class="hljs-number"><span class="hljs-number">5</span></span> { $limit:<span class="hljs-number"><span class="hljs-number">3</span></span>}, //    <span class="hljs-number"><span class="hljs-number">1</span></span>    ,   . { $group: { <span class="hljs-string"><span class="hljs-string">'_id'</span></span>:<span class="hljs-string"><span class="hljs-string">'$user'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span>: {<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$_id'</span></span>}, <span class="hljs-string"><span class="hljs-string">'type'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$type'</span></span>}, <span class="hljs-string"><span class="hljs-string">'title'</span></span>: {<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$title'</span></span>}, <span class="hljs-string"><span class="hljs-string">'content'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$content'</span></span>}, <span class="hljs-string"><span class="hljs-string">'count'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$count_comm'</span></span>}, <span class="hljs-string"><span class="hljs-string">'last_comm'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$last_comm'</span></span>}, <span class="hljs-string"><span class="hljs-string">'vote'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$vote'</span></span>}, <span class="hljs-string"><span class="hljs-string">'tags'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$tags'</span></span>} } }, //       . { $project :{ <span class="hljs-string"><span class="hljs-string">'_id'</span></span>:<span class="hljs-string"><span class="hljs-string">'$id'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'content'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'count'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'last_comm'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'tags'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'vote'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> } } ])</code> </pre> <br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="python hljs">db.test.aggregate([ { $match: { type: <span class="hljs-string"><span class="hljs-string">"news"</span></span>, date: { $gt: dt }, vate: { $gte: <span class="hljs-number"><span class="hljs-number">2</span></span> }, user: { $<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: [ <span class="hljs-string"><span class="hljs-string">"alex"</span></span>, <span class="hljs-string"><span class="hljs-string">"pavel"</span></span> ] } $<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>: [ { pub: true }, { accept: true }, { tags: { $<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: [<span class="hljs-string"><span class="hljs-string">"php"</span></span>, <span class="hljs-string"><span class="hljs-string">"python"</span></span> ] } } , { tags: { $nin: [<span class="hljs-string"><span class="hljs-string">""</span></span>] } } ] }, { $sort: {<span class="hljs-string"><span class="hljs-string">'primary'</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>, view: <span class="hljs-number"><span class="hljs-number">-1</span></span>}}, { $limit:<span class="hljs-number"><span class="hljs-number">3</span></span>}, { $group: {<span class="hljs-string"><span class="hljs-string">'_id'</span></span>:<span class="hljs-string"><span class="hljs-string">'$user'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span>: {<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$_id'</span></span>}, <span class="hljs-string"><span class="hljs-string">'type'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$type'</span></span>}, <span class="hljs-string"><span class="hljs-string">'title'</span></span>: {<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$title'</span></span>}, <span class="hljs-string"><span class="hljs-string">'content'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$content'</span></span>}, <span class="hljs-string"><span class="hljs-string">'count'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$count_comm'</span></span>}, <span class="hljs-string"><span class="hljs-string">'last_comm'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$last_comm'</span></span>}, <span class="hljs-string"><span class="hljs-string">'vote'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$vote'</span></span>}, <span class="hljs-string"><span class="hljs-string">'tags'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$first'</span></span>:<span class="hljs-string"><span class="hljs-string">'$tags'</span></span>} } }, { $project :{ <span class="hljs-string"><span class="hljs-string">'_id'</span></span>:<span class="hljs-string"><span class="hljs-string">'$id'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'content'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'count'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'last_comm'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'tags'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'vote'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> } } ])</code> </pre> </div></div><br><p>  ,    ‚Äî               . </p><br><h3><a name="73"></a> <font color="blue">-commerce     Mongodb</font> </h3><br><p> ,       -    ‚Äî  - .       ,          ,  , ,    , ,   . </p><br><p>  , -    ,   .     . </p><br><p>    , ,  ,     -. </p><br><ol><li>      (            ) </li><li>      . </li></ol><br><p>   ,        ,     ,         ‚Äî  .       ,     ,        . </p><br><p>                         (). </p><br><p>       : </p><br><ol><li>       ,             . </li><li>     . </li></ol><br><p>     ,         ,     .    : </p><br><pre> <code class="python hljs">cursor = db.test.find({ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"filters"</span></span>, <span class="hljs-string"><span class="hljs-string">"category"</span></span>: <span class="hljs-string"><span class="hljs-string">"id_category"</span></span> })</code> </pre> <br><p>     , ,    ,      ,     . </p><br><p>  =&gt;  <br> =&gt; 15.6 , 17   . </p><br><img src="https://habrastorage.org/files/343/713/af0/343713af0a4e47588b02aee8bb545469.png"><br><p>    ,         .        .         .,     . <br>      ‚Äî   ,     ,    ‚Äî           . </p><br><img src="https://habrastorage.org/files/6af/70b/37a/6af70b37a5ce41af9d27ec59a164aa16.png"><br><p>           .             ,    . </p><br><p>     ,          ,      .      . </p><br><img src="https://habrastorage.org/files/bec/a7b/61f/beca7b61f10d423386fda03f5b966e02.png"><br><p>          ,     .   _id        . <br>  <code>$addToSet</code>       . </p><br><pre> <code class="python hljs">db.test.aggregate([ //         id  { <span class="hljs-string"><span class="hljs-string">'$match'</span></span>: { type : <span class="hljs-string"><span class="hljs-string">"goods_attr"</span></span>, category: id_category } }, //       ,    { <span class="hljs-string"><span class="hljs-string">'$project'</span></span>: { <span class="hljs-string"><span class="hljs-string">"title"</span></span> : <span class="hljs-string"><span class="hljs-string">"$title.ru"</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">"$attr.ru"</span></span>, <span class="hljs-string"><span class="hljs-string">'category'</span></span>: <span class="hljs-string"><span class="hljs-string">"$category"</span></span>, <span class="hljs-string"><span class="hljs-string">'_id'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> } }, { <span class="hljs-string"><span class="hljs-string">'$group'</span></span> : { <span class="hljs-string"><span class="hljs-string">'_id'</span></span>: { <span class="hljs-string"><span class="hljs-string">'category'</span></span> :<span class="hljs-string"><span class="hljs-string">"$category"</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>: <span class="hljs-string"><span class="hljs-string">"$title"</span></span>} , <span class="hljs-string"><span class="hljs-string">'filters'</span></span>: { <span class="hljs-string"><span class="hljs-string">'$addToSet'</span></span>: <span class="hljs-string"><span class="hljs-string">"$value"</span></span> } } }, { <span class="hljs-string"><span class="hljs-string">'$group'</span></span> : { <span class="hljs-string"><span class="hljs-string">'_id'</span></span> :<span class="hljs-string"><span class="hljs-string">"$_id.category"</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>:{ <span class="hljs-string"><span class="hljs-string">'$addToSet'</span></span>: { <span class="hljs-string"><span class="hljs-string">'title'</span></span>: <span class="hljs-string"><span class="hljs-string">"$_id.title"</span></span>, <span class="hljs-string"><span class="hljs-string">'filters'</span></span>: <span class="hljs-string"><span class="hljs-string">"$filters"</span></span> } } } } ])</code> </pre> <br><p>   group     : </p><br><pre> <code class="python hljs">...{ <span class="hljs-string"><span class="hljs-string">'$group'</span></span> : { <span class="hljs-string"><span class="hljs-string">'_id'</span></span>: { <span class="hljs-string"><span class="hljs-string">'category'</span></span> :<span class="hljs-string"><span class="hljs-string">"$category"</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>: <span class="hljs-string"><span class="hljs-string">"$title"</span></span>} , <span class="hljs-string"><span class="hljs-string">'filters'</span></span>: { <span class="hljs-string"><span class="hljs-string">'$addToSet'</span></span>: <span class="hljs-string"><span class="hljs-string">"$value"</span></span> } } }.... { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: { <span class="hljs-string"><span class="hljs-string">"category"</span></span>: <span class="hljs-string"><span class="hljs-string">"id"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span> }, <span class="hljs-string"><span class="hljs-string">"filters"</span></span>: [ <span class="hljs-string"><span class="hljs-string">""</span></span> ] } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"category"</span></span> : <span class="hljs-string"><span class="hljs-string">"id"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span> }, <span class="hljs-string"><span class="hljs-string">"filters"</span></span> : [ <span class="hljs-string"><span class="hljs-string">" "</span></span> ] } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : { <span class="hljs-string"><span class="hljs-string">"category"</span></span> : <span class="hljs-string"><span class="hljs-string">"id"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> : <span class="hljs-string"><span class="hljs-string">" "</span></span> }, <span class="hljs-string"><span class="hljs-string">"filters"</span></span> : [ <span class="hljs-string"><span class="hljs-string">""</span></span> ] }</code> </pre> <br><p>   group     . </p><br><pre> <code class="python hljs">...{ <span class="hljs-string"><span class="hljs-string">'$group'</span></span> : { <span class="hljs-string"><span class="hljs-string">'_id'</span></span>:<span class="hljs-string"><span class="hljs-string">"$_id.category"</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>:{<span class="hljs-string"><span class="hljs-string">'$addToSet'</span></span>: {<span class="hljs-string"><span class="hljs-string">'title'</span></span>: <span class="hljs-string"><span class="hljs-string">"$_id.title"</span></span>, <span class="hljs-string"><span class="hljs-string">'filters'</span></span>: <span class="hljs-string"><span class="hljs-string">"$filters"</span></span> }} } ...} { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"id_category"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"title"</span></span> : <span class="hljs-string"><span class="hljs-string">"   "</span></span>, <span class="hljs-string"><span class="hljs-string">"filters"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span> ] }, { <span class="hljs-string"><span class="hljs-string">"title"</span></span> : <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"filters"</span></span> : [ <span class="hljs-string"><span class="hljs-string">""</span></span> ] }, { <span class="hljs-string"><span class="hljs-string">"title"</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"filters"</span></span> : [ <span class="hljs-string"><span class="hljs-string">" "</span></span> ] }, { <span class="hljs-string"><span class="hljs-string">"title"</span></span> : <span class="hljs-string"><span class="hljs-string">"   "</span></span>, <span class="hljs-string"><span class="hljs-string">"filters"</span></span> : [ <span class="hljs-string"><span class="hljs-string">""</span></span> ] } ] }</code> </pre> <br><p> ,      ,     .     ,    ,    <code>owner_id</code>  _id     . </p><br><pre> <code class="python hljs">db.test.aggregate([ { <span class="hljs-string"><span class="hljs-string">'$match'</span></span> : { <span class="hljs-string"><span class="hljs-string">'type'</span></span> : <span class="hljs-string"><span class="hljs-string">"goods_attr"</span></span>, <span class="hljs-string"><span class="hljs-string">"category'':"</span></span>id<span class="hljs-string"><span class="hljs-string">", '$or': [ {'title': '', 'attr': ' '}, {'title': '   ', 'attr_val': '  '} ] } }, { '$group': {'_id': "</span></span>$owner_id<span class="hljs-string"><span class="hljs-string">", "</span></span>att<span class="hljs-string"><span class="hljs-string">r": { '$push': "</span></span>$title<span class="hljs-string"><span class="hljs-string">" }}}, { '$match': {"</span></span>att<span class="hljs-string"><span class="hljs-string">r": {'$all': [ '', '   ' ] }}}, { '$project': {"</span></span>_id<span class="hljs-string"><span class="hljs-string">":1 } } ])</span></span></code> </pre> <br><p>     _id    . </p><br><h3><a name="8"></a> <font color="green">   Python</font> </h3><br><p>                 . </p><br><p>   ,     ,  ,     ( ‚Äî   )   . ,         ,           . </p><br><p>       ERP . ,         ,      - .     ,    ,         . </p><br><p>         <code>python</code> ,    ,      . </p><br><p>   <code>exec</code> </p><br><pre> <code class="python hljs">src = <span class="hljs-string"><span class="hljs-string">''' result = 0 for i in xrange(100): result += i '''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-string"><span class="hljs-string">'__'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> src, <span class="hljs-string"><span class="hljs-string">'Prohibited to use symbols "__"'</span></span> pr = compile(src, <span class="hljs-string"><span class="hljs-string">'&lt;string&gt;'</span></span>, mode=<span class="hljs-string"><span class="hljs-string">'exec'</span></span>) glob = { <span class="hljs-string"><span class="hljs-string">'__builtins__'</span></span>:{ <span class="hljs-string"><span class="hljs-string">'xrange'</span></span>:xrange } } exec(pr, glob) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> glob[<span class="hljs-string"><span class="hljs-string">'result'</span></span>]</code> </pre> <br><p>   <code>eval</code> (  ) </p><br><pre> <code class="python hljs">src = <span class="hljs-string"><span class="hljs-string">'max(5,7,3)'</span></span> glob = { <span class="hljs-string"><span class="hljs-string">'__builtins__'</span></span>:{ <span class="hljs-string"><span class="hljs-string">'max'</span></span>:max } } <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-string"><span class="hljs-string">'__'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> src, <span class="hljs-string"><span class="hljs-string">'Prohibited to use symbols "__"'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( eval(src, glob) )</code> </pre> <br><p>  ‚Äî : <br> <code>assert '__' not in src, 'Prohibited to use symbols "__"'</code> </p> <br><ul><li>     ,  : <code>__class__, __base__</code> <br>        python  <br><pre> <code class="python hljs">glob = { <span class="hljs-string"><span class="hljs-string">'__builtins__'</span></span>:{ <span class="hljs-string"><span class="hljs-string">'xrange'</span></span>:xrange } }</code> </pre> <br><p>       (import, type...)  / . </p><br></li></ul><p></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/259219/">https://habr.com/ru/post/259219/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259209/index.html">Comparison of PHP7 and Hack type systems</a></li>
<li><a href="../259211/index.html">Delays are a stumbling block to the Internet of Things</a></li>
<li><a href="../259213/index.html">We write a simple code analyzer on Roslyn</a></li>
<li><a href="../259215/index.html">Application KolibriOS. Part 2: Core Exposure for Iron Developers</a></li>
<li><a href="../259217/index.html">Screen with an infinite number of pixels</a></li>
<li><a href="../259223/index.html">jQuery is considered harmful</a></li>
<li><a href="../259225/index.html">Gulp.watch: catch errors correctly</a></li>
<li><a href="../259227/index.html">Network warrior. Demand study</a></li>
<li><a href="../259229/index.html">Some aspects of pricing policy in the field of information recovery services</a></li>
<li><a href="../259231/index.html">‚ÄúWhen will there be courses in JavaScript ?!‚Äù or a second year at the Academy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>