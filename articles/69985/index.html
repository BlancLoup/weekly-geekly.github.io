<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Generate music based on a given style</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post I want to talk about a very simple way of generating music in a given style using context-dependent grammar. 

 Introduction 
 We will wo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Generate music based on a given style</h1><div class="post__text post__text-html js-mediator-article"><table><tbody><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/5ba/e68/29b/5bae6829b2120c9b1066173269258f84.png"></td><td>  In this post I want to talk about a very simple way of generating music in a given style using context-dependent grammar. </td></tr></tbody></table><br><a name="habracut"></a><br><h1>  Introduction </h1><br>  We will work with files in <a href="http://ru.wikipedia.org/wiki/MIDI">MIDI</a> format.  Yes, habrayuzer, I sob with you, but it is in this format that the instruments, notes, and duration are already originally written in the melody.  But from <a href="http://ru.wikipedia.org/wiki/MP3">MP3</a> you will not get them any more (by a trivial method at least), and we would like to ... <br><br>  But let's not despair, there are a lot of high-quality MIDI files on the Internet.  I can recommend the <a href="http://www.hamienet.com/">HamieNET.com</a> service.  It allows you not only to download the MIDI file, but also to merge the melody converted into MP3 right away, as well as merge the XML file obtained from MIDI, display the tracks contained in the file, allow you to listen to them one by one, etc.  There is also an online service for converting your MIDI to MP3.  However, if you do not pay money, you can convert only one melody per day. <br><br><h1>  Demonstration of work </h1><br>  This is the original Nightwish melody - Ever Dream: <br>  <a href="http://www.mediafire.com/%3Fdzmuqm5vj2f">reference</a> <a href="http://fileland.ru/file_id-246309">mirror</a> <br>  And this is what happened as a result of the algorithm: <br>  <a href="http://www.mediafire.com/%3Fizzyywnydd2">reference</a> <a href="http://fileland.ru/file_id-246310">mirror</a> <br>  This is just a restart of the program, without changing anything, the melody is slightly different: <br>  <a href="http://www.mediafire.com/%3Fmhdzxmoiwhv">reference</a> <a href="http://fileland.ru/file_id-246311">mirror</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the first variant, of course, the jambs are sometimes heard, in the second one more and more smoothly. <br><br><h1>  Algorithm Description </h1><br>  The algorithm is based on constructing a <a href="http://en.wikipedia.org/wiki/Context-sensitive_grammar">context-dependent grammar</a> based on the original melody, and then generating a new melody based on this grammar from a given initial sequence. <br><br>  In order to create a melody, we need some rules: for example, which notes can go after the current sequence of notes.  Plus, building a new melody based on an existing one is that we don‚Äôt have to invent these rules ourselves, but we simply take them for a given melody. <br><br>  All these rules form a grammar.  It is context-sensitive because both the left and the right parts of the rule can be surrounded by a context of <a href="http://en.wikipedia.org/wiki/Terminal_symbol">terminal and non-terminal characters</a> .  Most likely now it is not clear what they are talking about at all and what terrible words these are.  But let's consider an example and everything will immediately fall into place. <br><br>  Take the usual line: ABCDEFGIKFHLEFJ.  And we will begin to build a grammar for it, starting, say, with the symbol F (in general, this must be done for each character). <br><br>  We need to write a rule that would indicate to us which letter should be put if we suddenly met the symbol F. It is written this way: F ‚Äã‚Äã-&gt; <em>something</em> .  As we see, we cannot create such a rule, since we cannot determine just by one letter what should follow: after F, both G and H or J can go. Therefore, we add context to our letter F, context is characters surrounding F. Let's take one letter before F. We get EF and KF.  The context for the letter F here is the letter E and K. We have just expanded the context by one character, so this method of constructing a grammar is called the method of dynamically expanding context. <br><br>  See if we can create a rule now.  After KF comes H, and there are no other options.  We obtained the first final rule: KF -&gt; H (reads ‚ÄúKF <em>produces</em> H).  Now, if, for example, at the end of the line we meet KF and we need to extend the line by one character, we will boldly write H. <br><br>  But we still have a problem: after EF, both G and J can go. Therefore, we must expand the context by another symbol: DEF and LEF.  And finally we got the final rules: <br>  KF -&gt; H <br>  DEF -&gt; G <br>  LEF -&gt; J <br><br>  These are the rules for the letter F, depending on its context, we choose one of the three rules. <br><br>  The process of generating a new line is as follows: an initial sequence is given, for example, ADEF.  We start to take letters from the end.  F - there is no rule with such a left side, expanding the context - EF, again not, expanding - DEF, there is such a rule, we put G, we get ADEFG.  We start all over again: take the letter G, etc.  as many times as we need. <br><br>  It will be convenient to represent the grammar as a tree.  For the letter F, the tree will look like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/940/670/820/940670820b7e50c439dffbdc91f2adaf.png"><br>  In the nodes are the left parts of the rules, next to the nodes are written the right parts of the rules - possible products.  The numbers to the left of the tree indicate at which contextual level the nodes are located. <br><br>  Now we are faced with the following problem: if we generate a new sequence strictly according to specified rules, then we will get <u>exactly the</u> original string (melody), and we want to create a <u>new one</u> .  Therefore, in some cases, we should not reach the final rule, but take an intermediate one.  This means that sometimes, having met such a sequence: ADEF, we will not expand the context to the final rule DEF -&gt; G, but stop at F and randomly or use some other method to choose any product (H, G, J) at the node F in the tree.  Or we‚Äôll focus on EF and choose G or J products. Ie.  we randomly select the context level in the tree and the output at that level. <br><br>  Well, now imagine that each letter is not a letter, but a chord, but in relation to a MIDI file it would be more accurate to say that it is a set of events (which include turning on / off notes, changing channels, etc.), and here already our algorithm is ready for the melody. <br><br><h1>  More about MIDI </h1><br>  Having come across an online service that allows you to convert MIDI to XML, I realized that it would work much more conveniently with it.  We also need to do one more thing.  There are several MIDI file formats.  Format 0 contains 1 track, formats 1 and 2 contain several tracks.  Most often, MIDI comes in format 1, where each instrument has its own track: guitars on one track, violin on another, etc.  This will add some difficulty in constructing grammar.  You will need to follow what is happening on the other track.  Therefore, we simply convert format 1 to format 0, so that all the tools are in a heap on one track, and after that we will also overtake in XML.  All of these tools are available <a href="http://en.nemidi.com/">here</a> . <br><br>  In the end, we get something like this: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;?</font> <font color="#800000">xml</font> <font color="#ff0000">version</font> <font color="#0000ff">="1.0"</font> <font color="#ff0000">encoding</font> <font color="#0000ff">="ISO-8859-1"</font> ? <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;!</font> <font color="#800000">DOCTYPE</font> <font color="#ff0000">MIDIFile</font> <font color="#ff0000">PUBLIC</font> &lt;br&gt; <font color="#0000ff">"-//Recordare//DTD MusicXML 0.9 MIDI//EN"</font> &lt;br&gt; <font color="#0000ff">"http://www.musicxml.org/dtds/midixml.dtd"</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">MIDIFile</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Format</font> <font color="#0000ff">&gt;</font> 0 <font color="#0000ff">&lt;/</font> <font color="#800000">Format</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">TrackCount</font> <font color="#0000ff">&gt;</font> 1 <font color="#0000ff">&lt;/</font> <font color="#800000">TrackCount</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">TicksPerBeat</font> <font color="#0000ff">&gt;</font> 384 <font color="#0000ff">&lt;/</font> <font color="#800000">TicksPerBeat</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">TimestampType</font> <font color="#0000ff">&gt;</font> Absolute <font color="#0000ff">&lt;/</font> <font color="#800000">TimestampType</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Track</font> <font color="#ff0000">Number</font> <font color="#0000ff">="0"</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> 0 <font color="#0000ff">&lt;/</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">ControlChange</font> <font color="#ff0000">Channel</font> <font color="#0000ff">="2"</font> <font color="#ff0000">Control</font> <font color="#0000ff">="91"</font> <font color="#ff0000">Value</font> <font color="#0000ff">="46"</font> <font color="#0000ff">/&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;/</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> 0 <font color="#0000ff">&lt;/</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">ProgramChange</font> <font color="#ff0000">Channel</font> <font color="#0000ff">="2"</font> <font color="#ff0000">Number</font> <font color="#0000ff">="49"</font> <font color="#0000ff">/&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;/</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> 0 <font color="#0000ff">&lt;/</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">ControlChange</font> <font color="#ff0000">Channel</font> <font color="#0000ff">="2"</font> <font color="#ff0000">Control</font> <font color="#0000ff">="0"</font> <font color="#ff0000">Value</font> <font color="#0000ff">="0"</font> <font color="#0000ff">/&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;/</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt;...&lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> 24908 <font color="#0000ff">&lt;/</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">NoteOff</font> <font color="#ff0000">Channel</font> <font color="#0000ff">="11"</font> <font color="#ff0000">Note</font> <font color="#0000ff">="41"</font> <font color="#ff0000">Velocity</font> <font color="#0000ff">="127"</font> <font color="#0000ff">/&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;/</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> 24912 <font color="#0000ff">&lt;/</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">NoteOn</font> <font color="#ff0000">Channel</font> <font color="#0000ff">="11"</font> <font color="#ff0000">Note</font> <font color="#0000ff">="41"</font> <font color="#ff0000">Velocity</font> <font color="#0000ff">="127"</font> <font color="#0000ff">/&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;/</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> 24956 <font color="#0000ff">&lt;/</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">NoteOff</font> <font color="#ff0000">Channel</font> <font color="#0000ff">="11"</font> <font color="#ff0000">Note</font> <font color="#0000ff">="41"</font> <font color="#ff0000">Velocity</font> <font color="#0000ff">="127"</font> <font color="#0000ff">/&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;/</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> 24960 <font color="#0000ff">&lt;/</font> <font color="#800000">Absolute</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;</font> <font color="#800000">NoteOn</font> <font color="#ff0000">Channel</font> <font color="#0000ff">="11"</font> <font color="#ff0000">Note</font> <font color="#0000ff">="41"</font> <font color="#ff0000">Velocity</font> <font color="#0000ff">="127"</font> <font color="#0000ff">/&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;/</font> <font color="#800000">Event</font> <font color="#0000ff">&gt;</font> &lt;br&gt;...&lt;br&gt; <font color="#0000ff">&lt;/</font> <font color="#800000">Track</font> <font color="#0000ff">&gt;</font> &lt;br&gt; <font color="#0000ff">&lt;/</font> <font color="#800000">MIDIFile</font> <font color="#0000ff">&gt;</font></font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Here we can see the tempo of the melody 384. Initially, the channel settings for each instrument are set, but we will be more interested in the NoteOn and NoteOff events - turning the note on and off.  They contain the channel on which the note plays, the note number itself and its speed.  We also see the absolute time for each event.  You can generate XML with absolute and relative time.  Absolute time is the time elapsed from the very beginning of the track, relative time elapsed since the last event.  It is more convenient for us to take the absolute, because  according to it, we can easily group events that occurred at the same time.  I will call these groups ‚Äúchords‚Äù. <br><br><h1>  shkodim </h1><br>  We describe the class "chord": <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> Chord&lt;br&gt;  {&lt;br&gt; <font color="#008000">//   ""</font> &lt;br&gt; <font color="#0000ff">public</font> <font color="#0000ff">int</font> Delay { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; }&lt;br&gt; <font color="#008000">//</font> &lt;br&gt; <font color="#0000ff">public</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">string</font> &gt; Events { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; }&lt;br&gt;&lt;br&gt; <font color="#0000ff">public</font> Chord()&lt;br&gt;    {&lt;br&gt;      Events = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">string</font> &gt;();&lt;br&gt;    }&lt;br&gt;  }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  At the same time, we will write a class for comparing ‚Äûchords‚Äú: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> ChordComparer : IEqualityComparer&lt;Chord&gt;&lt;br&gt;  {&lt;br&gt; <font color="#0000ff">public</font> <font color="#0000ff">bool</font> Equals(Chord x, Chord y)&lt;br&gt;    {&lt;br&gt; <font color="#0000ff">if</font> (x.Delay != y.Delay)&lt;br&gt; <font color="#0000ff">return</font> <font color="#0000ff">false</font> ;&lt;br&gt; <font color="#0000ff">if</font> (x.Events.Count != y.Events.Count)&lt;br&gt; <font color="#0000ff">return</font> <font color="#0000ff">false</font> ;&lt;br&gt; <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> ev <font color="#0000ff">in</font> x.Events)&lt;br&gt; <font color="#0000ff">if</font> (!y.Events.Contains(ev))&lt;br&gt; <font color="#0000ff">return</font> <font color="#0000ff">false</font> ;&lt;br&gt; <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> ev <font color="#0000ff">in</font> y.Events)&lt;br&gt; <font color="#0000ff">if</font> (!x.Events.Contains(ev))&lt;br&gt; <font color="#0000ff">return</font> <font color="#0000ff">false</font> ;&lt;br&gt; <font color="#0000ff">return</font> <font color="#0000ff">true</font> ;&lt;br&gt;    }&lt;br&gt;&lt;br&gt; <font color="#0000ff">public</font> <font color="#0000ff">int</font> GetHashCode(Chord obj)&lt;br&gt;    {&lt;br&gt; <font color="#0000ff">int</font> hash = obj.Delay.GetHashCode();&lt;br&gt;      obj.Events.ForEach(ev =&gt; hash += ev.GetHashCode());&lt;br&gt; <font color="#0000ff">return</font> hash;&lt;br&gt;    }&lt;br&gt;  }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  And a class for comparing sequences of "chords": <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> ListComparer : IEqualityComparer&lt; <font color="#2B91AF">List</font> &lt;Chord&gt;&gt;&lt;br&gt;  {&lt;br&gt; <font color="#0000ff">private</font> ChordComparer cc = <font color="#0000ff">new</font> ChordComparer();&lt;br&gt;&lt;br&gt; <font color="#0000ff">public</font> <font color="#0000ff">bool</font> Equals( <font color="#2B91AF">List</font> &lt;Chord&gt; x, <font color="#2B91AF">List</font> &lt;Chord&gt; y)&lt;br&gt;    {&lt;br&gt; <font color="#0000ff">if</font> (x.Count != y.Count)&lt;br&gt; <font color="#0000ff">return</font> <font color="#0000ff">false</font> ;&lt;br&gt; <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; x.Count; i++)&lt;br&gt; <font color="#0000ff">if</font> (!cc.Equals(x[i], y[i]))&lt;br&gt; <font color="#0000ff">return</font> <font color="#0000ff">false</font> ;&lt;br&gt; <font color="#0000ff">return</font> <font color="#0000ff">true</font> ;&lt;br&gt;    }&lt;br&gt;&lt;br&gt; <font color="#0000ff">public</font> <font color="#0000ff">int</font> GetHashCode( <font color="#2B91AF">List</font> &lt;Chord&gt; obj)&lt;br&gt;    {&lt;br&gt; <font color="#0000ff">int</font> hash = 0;&lt;br&gt;      obj.ForEach(ch =&gt; ch.Events.ForEach(ev =&gt; hash += ev.GetHashCode()));&lt;br&gt;      obj.ForEach(ch =&gt; hash += ch.Delay.GetHashCode());&lt;br&gt; <font color="#0000ff">return</font> hash;&lt;br&gt;    }&lt;br&gt;  }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Tree node class: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//  ,    </font> &lt;br&gt; <font color="#0000ff">public</font> <font color="#0000ff">class</font> Node&lt;br&gt;  {&lt;br&gt; <font color="#008000">//  -   </font> &lt;br&gt; <font color="#0000ff">public</font> <font color="#2B91AF">List</font> &lt;Chord&gt; Value { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; }&lt;br&gt; <font color="#008000">//  -,  -  ,  -  ,    null</font> &lt;br&gt; <font color="#0000ff">public</font> <font color="#2B91AF">List</font> &lt;KeyValuePair&lt;Chord, Node&gt;&gt; Nodes { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; }&lt;br&gt;&lt;br&gt; <font color="#008000">//    </font> &lt;br&gt; <font color="#0000ff">public</font> Chord GetProduction( <font color="#2B91AF">List</font> &lt;Chord&gt; seq)&lt;br&gt;    {&lt;br&gt; <font color="#008000">//        ,    </font> &lt;br&gt; <font color="#0000ff">if</font> (Nodes.Count == 1 &amp;&amp; Nodes[0].Value == <font color="#0000ff">null</font> )&lt;br&gt;      {&lt;br&gt; <font color="#0000ff">return</font> Nodes.First().Key;&lt;br&gt;      }&lt;br&gt; <font color="#0000ff">else</font> &lt;br&gt;      {&lt;br&gt; <font color="#008000">//      </font> &lt;br&gt; <font color="#2B91AF">List</font> &lt;Node&gt; path = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;Node&gt;();&lt;br&gt;        ListComparer lc = <font color="#0000ff">new</font> ListComparer();&lt;br&gt;        path.Add( <font color="#0000ff">this</font> );&lt;br&gt; <font color="#008000">//      "",     ,</font> &lt;br&gt; <font color="#008000">//    </font> &lt;br&gt; <font color="#0000ff">if</font> (seq.Count == 1)&lt;br&gt;        {&lt;br&gt; <font color="#0000ff">if</font> (Nodes.Count != 0)&lt;br&gt;          {&lt;br&gt; <font color="#0000ff">return</font> Nodes[Helper.rand.Next(Nodes.Count)].Key;&lt;br&gt;          }&lt;br&gt; <font color="#008000">//  ,   ,   "",   </font> &lt;br&gt; <font color="#008000">//</font> &lt;br&gt; <font color="#0000ff">else</font> &lt;br&gt;          {&lt;br&gt; <font color="#0000ff">int</font> t = Helper.rand.Next(-10, 11);&lt;br&gt; <font color="#0000ff">int</font> index = 0, i;&lt;br&gt; <font color="#0000ff">for</font> (i = 0; i &lt; Helper.listchords.Count; i++)&lt;br&gt; <font color="#0000ff">if</font> ((index = Helper.listchords[i].IndexOf(seq.Last())) != -1) <font color="#0000ff">break</font> ;&lt;br&gt; <font color="#0000ff">return</font> Helper.listchords[i][ <font color="#2B91AF">Math</font> .Max(0, <font color="#2B91AF">Math</font> .Min(index + t, Helper.listchords[i].Count - 2))];&lt;br&gt;          }&lt;br&gt;        }&lt;br&gt; <font color="#0000ff">else</font> &lt;br&gt;        {&lt;br&gt; <font color="#008000">// </font> &lt;br&gt; <font color="#2B91AF">List</font> &lt;Chord&gt; extseq = seq.GetRange(seq.Count - 2, 2);&lt;br&gt; <font color="#008000">//      </font> &lt;br&gt; <font color="#2B91AF">List</font> &lt;Node&gt; nodes = Nodes&lt;br&gt;            .Where(node =&gt; node.Value != <font color="#0000ff">null</font> &amp;&amp; lc.Equals(node.Value.Value, extseq))&lt;br&gt;            .Select(node =&gt; node.Value)&lt;br&gt;            .Distinct()&lt;br&gt;            .ToList();&lt;br&gt; <font color="#008000">// ,        ""</font> &lt;br&gt; <font color="#0000ff">if</font> (nodes.Count == 0)&lt;br&gt;          {&lt;br&gt; <font color="#0000ff">if</font> (Nodes.Count != 0)&lt;br&gt;            {&lt;br&gt; <font color="#0000ff">return</font> Nodes[Helper.rand.Next(Nodes.Count)].Key;&lt;br&gt;            }&lt;br&gt; <font color="#0000ff">else</font> &lt;br&gt;            {&lt;br&gt; <font color="#0000ff">int</font> t = Helper.rand.Next(-10, 11);&lt;br&gt; <font color="#0000ff">int</font> index=0, i;&lt;br&gt; <font color="#0000ff">for</font> (i = 0; i &lt; Helper.listchords.Count; i++)&lt;br&gt; <font color="#0000ff">if</font> ((index = Helper.listchords[i].IndexOf(seq.Last())) != -1) <font color="#0000ff">break</font> ;&lt;br&gt; <font color="#0000ff">return</font> Helper.listchords[i][ <font color="#2B91AF">Math</font> .Max(0, <font color="#2B91AF">Math</font> .Min(index + t, Helper.listchords[i].Count - 2))];&lt;br&gt;            }&lt;br&gt;          }&lt;br&gt; <font color="#008000">//</font> &lt;br&gt; <font color="#0000ff">else</font> &lt;br&gt;          {&lt;br&gt; <font color="#008000">//  </font> &lt;br&gt;            Node rule = nodes.First();&lt;br&gt; <font color="#008000">//   ,  </font> &lt;br&gt;            rule.GetProduction(seq, <font color="#0000ff">ref</font> path, 3);&lt;br&gt; <font color="#008000">//  60%    </font> &lt;br&gt; <font color="#0000ff">if</font> (Helper.rand.NextDouble() &lt;= 0.6)&lt;br&gt;            {&lt;br&gt; <font color="#0000ff">return</font> path.Last().Nodes[0].Key;&lt;br&gt;            }&lt;br&gt; <font color="#008000">//         ,</font> &lt;br&gt; <font color="#008000">//      </font> &lt;br&gt; <font color="#0000ff">else</font> &lt;br&gt;            {&lt;br&gt;              Node p = path[Helper.rand.Next(path.Count)];&lt;br&gt; <font color="#0000ff">return</font> p.Nodes[Helper.rand.Next(p.Nodes.Count)].Key;&lt;br&gt;            }&lt;br&gt;          }&lt;br&gt;        }&lt;br&gt;      }&lt;br&gt;    }&lt;br&gt;&lt;br&gt; <font color="#008000">//      , c -  </font> &lt;br&gt; <font color="#0000ff">private</font> <font color="#0000ff">void</font> GetProduction( <font color="#2B91AF">List</font> &lt;Chord&gt; seq, <font color="#0000ff">ref</font> <font color="#2B91AF">List</font> &lt;Node&gt; path, <font color="#0000ff">int</font> c)&lt;br&gt;    {&lt;br&gt; <font color="#008000">//   </font> &lt;br&gt;      path.Add( <font color="#0000ff">this</font> );&lt;br&gt; <font color="#008000">//     ,    </font> &lt;br&gt;    }&lt;br&gt;  }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The whole project can be merged <a href="http://www.mediafire.com/%3Fg4tln2nmd0m">here</a> ( <a href="http://fileland.ru/file_id-246312">mirror</a> ). <br><br>  An important role here is played by how you organize random.  At first I did a random with a Poisson distribution with a mathematical expectation equal to the number of the last node, but the melody was very messy, so I left a simpler option. <br><br>  Post written after reading <a href="http://ksuseer1.ist.psu.edu/viewdoc/summary%3Fdoi%3D10.1.1.115.3247">this</a> article. <br></div><p>Source: <a href="https://habr.com/ru/post/69985/">https://habr.com/ru/post/69985/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../69976/index.html">A formula editor appeared in Google Docs.</a></li>
<li><a href="../69977/index.html">Google translate</a></li>
<li><a href="../69981/index.html">"Hello, I am a technical writer"</a></li>
<li><a href="../69982/index.html">Something terrible is happening in the world of advertising</a></li>
<li><a href="../69983/index.html">MySQL calendar data types: usage features</a></li>
<li><a href="../69987/index.html">Another reason to start using Chrome</a></li>
<li><a href="../69988/index.html">Replacing the sounds in Half-Life 2 voice</a></li>
<li><a href="../69989/index.html">L-Systems - the mathematical beauty of plants</a></li>
<li><a href="../69992/index.html">Vedomosti. Registration is not for everyone</a></li>
<li><a href="../69993/index.html">The domestic auto industry has grown to supercars!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>