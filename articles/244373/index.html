<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Raising the ‚Äúvirtualka‚Äù chroot with ubuntu to build packages</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings. 

 The other day, tired of assembling packages, I went on ssh to different machines and decided to pick up a couple of myself. I'll tell yo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Raising the ‚Äúvirtualka‚Äù chroot with ubuntu to build packages</h1><div class="post__text post__text-html js-mediator-article">  Greetings. <br><br>  The other day, tired of assembling packages, I went on ssh to different machines and decided to pick up a couple of myself.  I'll tell you about the rakes that I collected on the road and about the crutches that I made. <br><br>  All actions were performed on Arch linux, but the steps for setting up chroot virtual machines and schroot should be very similar. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Everything described below, of course, is scattered throughout the network.  But there are many trials and mistakes along the way. <br><a name="habracut"></a><br><h4>  Bootstrap </h4><br>  So, everything begins, one might say, trite, there is a description of the bootstrap process in <a href="http://habrahabr.ru/post/147522/">this article.</a> <br>  For myself, I put 2 virtuals - precise and trusty: <br><pre><code class="bash hljs">yaourt -S --nocnofirm --asdeps ubuntu-keyring gnupg1 <span class="hljs-comment"><span class="hljs-comment">#  ,   yaourt -S --nocnofirm debootstrap schroot for distr in trusty precise do sudo debootstrap --include=vim,language-pack-ru,language-pack-ru-base,devscripts,subversion,git --arch amd64 $distr /home/ubuntu_$distr http://mirror.yandex.ru/ubuntu/ done</span></span></code> </pre> <br><br><h5>  After some time, when the bags arrive </h5><br>  We have unconfigured weights, unconfigured locale, time zone ... the whole range of colors. <br>  Adjust the weights: <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> distr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> trusty precise <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> sudo sh -c <span class="hljs-string"><span class="hljs-string">"cat &gt; /home/ubuntu_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$distr</span></span></span><span class="hljs-string">/etc/apt/sources.list &lt;&lt;EOF deb http://mirror.yandex.ru/ubuntu </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$distr</span></span></span><span class="hljs-string"> main restricted universe multiverse deb http://mirror.yandex.ru/ubuntu </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$distr</span></span></span><span class="hljs-string">-updates main restricted universe multiverse deb http://mirror.yandex.ru/ubuntu </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$distr</span></span></span><span class="hljs-string">-security main restricted universe multiverse EOF"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  We will return to the locale and time zone a little later. <br><br><h4>  The following rake ... </h4>  Carefully groin at the groin level: schroot configuration <br>  In short, this thing allows you to chroot into a directory without superuser rights, automatically mounting and copying into the child OS what is specified in the config (with reservations).  My example config is /etc/schroot/chroot.d/ubuntu.conf <br><pre> <code class="hljs pgsql">[ubuntu-trusty] description=Ubuntu <span class="hljs-number"><span class="hljs-number">14.04</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=directory directory=/home/ubuntu_trusty users=clown,monkey,mrsam root-users=clown aliases=trusty,<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> profile=ubuntu [ubuntu-precise] description=Ubuntu <span class="hljs-number"><span class="hljs-number">12.04</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=directory directory=/home/ubuntu_precise users=clown,monkey,mrsam root-users=clown aliases=precise profile=ubuntu</code> </pre> <br>  What you should pay attention to in <a href="">man schroot.conf</a> : the item ‚ÄúPlain and directory chroots‚Äù (shot my knee for a very long time, I wanted to howl) <br>  If you select ‚Äútype = directory‚Äù, then the auto-point from the file ($ profile - the parameter ‚Äúprofile = ubuntu‚Äù in the config) is executed / etc / schroot / $ profile / fstab, all files from / etc / schroot / $ profile / copyfiles are copied and also all the ‚Äúdatabases‚Äù from / etc / schroot / $ profile / nssdatabases are updated.  This circumstance even <a href="https://bugs.launchpad.net/ubuntu/%2Bsource/schroot/%2Bbug/1093973">complained about</a> the launch pad. <br>  The default is "profile = default", and / etc / schroot / default / nssdatabases contains these lines <br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> databases <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> the chroot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the host <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>. # # &lt;<span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>&gt; passwd shadow <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> gshadow services protocols networks hosts</code> </pre><br>  Each time this bastard frayed my groups and users, which had a very negative effect on the chroot installation even vim, which was required by the crontab group.  And also the networks item <a href="https://bbs.archlinux.org/viewtopic.php%3Fid%3D100039">kills the network</a> (for my distribution, it‚Äôs not at all a fact that it‚Äôs everywhere, especially if the parent OS is ubuntu too), such things. <br>  Just in case, my files / etc / schroot / ubuntu / * <br><pre> <code class="hljs pgsql">$ cat copyfiles # Files <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> the chroot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the host <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>. # # &lt;source <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> destination&gt; /etc/resolv.conf $ cat fstab # fstab: static file <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> information <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> chroots. # Note that the mount <span class="hljs-type"><span class="hljs-type">point</span></span> will be prefixed <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the chroot <span class="hljs-type"><span class="hljs-type">path</span></span> # (CHROOT_PATH) # # &lt;file <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>&gt; &lt;mount <span class="hljs-type"><span class="hljs-type">point</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">options</span></span>&gt; &lt;dump&gt; &lt;pass&gt; /proc /proc <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> rw,bind <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> /sys /sys <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> rw,bind <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> /dev /dev <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> rw,bind <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> /dev/pts /dev/pts <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> rw,bind <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> /home /home <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> rw,bind <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> /tmp /tmp <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> rw,bind <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> # It may be desirable <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> have <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> /run, especially <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you wish # <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> run additional services <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the chroot. However, note that this # may potentially cause undesirable behaviour <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> upgrades, such <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> # killing services <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> the host. #/run /run <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> rw,bind <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> #/run/<span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> /run/<span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> rw,bind <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> #/dev/shm /dev/shm <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> rw,bind <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> #/run/shm /run/shm <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> rw,bind <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> $ cat nssdatabases # <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> databases <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> the chroot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the host <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>. # # &lt;<span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>&gt; protocols hosts</code> </pre> <br><br><h4>  Little tricks </h4><br>  To have the same encoding everywhere, you need to do: <br><pre> <code class="hljs bash"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> distr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> trusty precise <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> sudo cp /etc/locale.gen /home/ubuntu_<span class="hljs-variable"><span class="hljs-variable">$distr</span></span>/var/lib/locales/supported.d/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> <span class="hljs-comment"><span class="hljs-comment">#  etc  home   ,  ln -f done</span></span></code> </pre> <br><br>  You can link together some configuration files that you would like to always have in the same form, for example: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> ln -f /home/ubuntu_trusty/etc/bash.bashrc /home/ubuntu_precise/etc/bash.bashrc</code> </pre> <br>  And in order to avoid problems when updating packages, it is necessary <a href="https://github.com/docker/docker/issues/1724">to prevent some packages from</a> doing this: <br><pre> <code class="hljs matlab">apt-mark <span class="hljs-built_in"><span class="hljs-built_in">hold</span></span> initscripts udev plymouth mountall</code> </pre> <br>  Yes, in each of the chroot ... <br><br>  And finally, we will regenerate encodings and tzdata: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> locale-gen sudo dpkg-reconfigure tzdata</code> </pre> <br><br>  Thanks for attention.  I hope, will reduce the time to raise the environment for the assembly. </div><p>Source: <a href="https://habr.com/ru/post/244373/">https://habr.com/ru/post/244373/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244361/index.html">Protothread and cooperative multitasking</a></li>
<li><a href="../244363/index.html">Wind of Change: ARM Server Expansion Continues</a></li>
<li><a href="../244365/index.html">Integration of a computer information system into a business</a></li>
<li><a href="../244367/index.html">SSLR: Screen Space Local Reflections in AAA Games</a></li>
<li><a href="../244371/index.html">Unsuccessful experience in restoring pre-installed Windows 8.1 on an HP Pavilion laptop</a></li>
<li><a href="../244375/index.html">IBM invites to the IBM SolutionsConnect 2014 conference</a></li>
<li><a href="../244379/index.html">Interview with Rudi Hein: bestseller developer shares the secrets of the success of their applications</a></li>
<li><a href="../244381/index.html">The first experience in game development. Errors and conclusions</a></li>
<li><a href="../244383/index.html">IPv6 at gunpoint</a></li>
<li><a href="../244385/index.html">Mikrotik. Failover. Load balancing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>