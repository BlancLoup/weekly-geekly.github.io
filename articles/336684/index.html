<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Quick Python performance test for computing tasks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Motivation 
 Recently a new version 0.34 of the Numba JIT compiler compiling library for Python has been released. And there cheers! the long-awaited ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Quick Python performance test for computing tasks</h1><div class="post__text post__text-html js-mediator-article"><h2>  Motivation </h2><br>  Recently a new version 0.34 of the <a href="http://numba.pydata.org/">Numba</a> JIT compiler compiling library for Python has been released.  And there cheers!  the long-awaited semantics of annotations and a set of methods for organizing parallel computing appeared.  The basis was taken from <a href="">Intel Parallel Accelerator</a> technology. <br><br>  In this article I want to share the results of the first testing of the speed of calculations based on this library for some modern machine with a quad-core processor. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  Currently, Python is very actively used in scientific computing, and in the field of Machine Learning in general is almost one of the standards.  But if you look a little deeper, almost everywhere Python is used as a wrapper over lower level libraries, written mostly in C / C ++.  Is it really possible to write fast and parallel code in pure Python? <br><br>  Consider a very simple task.  Let us be given two sets of <i>N</i> points in three-dimensional space: <i>p</i> and <i>q</i> .  It is necessary to calculate a special matrix based on pairwise distances between all points: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>R</mi><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mo>+</mo><mtext>&amp;#xA0;</mtext><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>p</mi><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2212;</mo><mi>q</mi><mo stretchy=&quot;false&quot;>(</mo><mi>j</mi><mo stretchy=&quot;false&quot;>)</mo><mtext>&amp;#xA0;</mtext><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mn>2</mn></msub></mrow></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="33.744ex" height="2.78ex" viewBox="0 -832 14528.5 1197.1" role="img" focusable="false" style="vertical-align: -0.848ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-52" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-28" x="759" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-69" x="1149" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-2C" x="1494" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-6A" x="1939" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-29" x="2352" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-3D" x="3019" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-66" x="4325" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-72" x="4876" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-61" x="5327" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-63" x="5857" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-31" x="6290" y="0"></use><g transform="translate(6791,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-31" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-2B" x="722" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-7C" x="1973" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-70" x="2251" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-28" x="2755" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-69" x="3144" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-29" x="3490" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-2212" x="4102" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-71" x="5102" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-28" x="5563" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMATHI-6A" x="5952" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-29" x="6365" y="0"></use><g transform="translate(7004,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-7C" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/336684/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgrIdYqeQlCedqpSwrSlO_49feqRw#MJMAIN-32" x="393" y="-404"></use></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>R</mi><mo stretchy="false">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mn>1</mn><mo>+</mo><mtext>&nbsp;</mtext><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>p</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>‚àí</mo><mi>q</mi><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo><mtext>&nbsp;</mtext><msub><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mn>2</mn></msub></mrow></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> R (i, j) = \ frac {1} {1+ \ | p (i) - q (j) \ | _2} </script></p><br>  For all tests, we take <i>N</i> = 5000. The calculation time is averaged for 10 starts. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  C ++ implementation </h3><br>  As a starting point, take the following implementation in C ++: <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">vector</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;Point3D&gt; &amp; p, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">vector</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;Point3D&gt; &amp; q, Matrix &amp; R)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> rx, ry, rz; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> omp parallel for for (int i = 0; i &lt; p.size(); i++) { for (int j = 0; j &lt; q.size(); j++) { rx = p[i].x - q[j].x; ry = p[i].y - q[j].y; rz = p[i].z - q[j].z; R(i, j) = 1 / (1 + sqrt(rx * rx + ry * ry + rz * rz)); } } }</span></span></code> </pre> <br>  An external cycle on <i>p</i> points is performed in parallel using <a href="http://www.openmp.org/">OpenMP</a> technology. <br><br>  Execution time: 44 ms. <br><br><h3>  Pure python </h3><br>  Let's start the speed test with pure Python code: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_R</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, q)</span></span></span><span class="hljs-function">:</span></span> R = np.empty((p.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>], q.shape[<span class="hljs-number"><span class="hljs-number">1</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(p.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>]): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(q.shape[<span class="hljs-number"><span class="hljs-number">1</span></span>]): rx = p[i, <span class="hljs-number"><span class="hljs-number">0</span></span>] - q[<span class="hljs-number"><span class="hljs-number">0</span></span>, j] ry = p[i, <span class="hljs-number"><span class="hljs-number">1</span></span>] - q[<span class="hljs-number"><span class="hljs-number">1</span></span>, j] rz = p[i, <span class="hljs-number"><span class="hljs-number">2</span></span>] - q[<span class="hljs-number"><span class="hljs-number">2</span></span>, j] R[i, j] = <span class="hljs-number"><span class="hljs-number">1</span></span> / (<span class="hljs-number"><span class="hljs-number">1</span></span> + math.sqrt(rx * rx + ry * ry + rz * rz)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> R</code> </pre><br>  Execution time: 52 861 ms, slower than the base implementation more than 1000 times. <br><br>  Python is an interpreted language, Python uses <a href="https://wiki.python.org/moin/GlobalInterpreterLock">GIL</a> internally, which makes parallelization at the level of the code itself impossible.  This is all very slow.  Now we start all this accelerate. <br><br><h3>  Python + NumPy + SciPy </h3><br>  The problem of Python slowness for numerical problems has been recognized for a very long time.  And the answer to this problem was the <a href="http://www.numpy.org/">NumPy</a> library.  The ideology of NumPy is in many ways close to MatLab, which is a recognized tool for scientific calculations. <br><br>  We stop thinking iteratively, we begin to think of matrices and vectors as atomic objects for computation.  And all operations with matrices and vectors at the lower level are already performed by the high-performance libraries of the linear algebra Intel MKL or ATLAS. <br><br>  The implementation on NumPy looks like this: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_R_numpy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, q)</span></span></span><span class="hljs-function">:</span></span> Rx = p[:, <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>] - q[<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>] Ry = p[:, <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>] - q[<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>] Rz = p[:, <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>] - q[<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>] R = <span class="hljs-number"><span class="hljs-number">1</span></span> / (<span class="hljs-number"><span class="hljs-number">1</span></span> + np.sqrt(Rx * Rx + Ry * Ry + Rz * Rz)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> R</code> </pre><br>  In this implementation, there is no cycle at all! <br><br>  Execution time: 839 ms, which is slower than the base implementation about 19 times. <br><br>  Moreover, NumPy and SciPy have a huge number of built-in functions.  The implementation of this task on SciPy looks like this: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_R_scipy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, q)</span></span></span><span class="hljs-function">:</span></span> D = spd.cdist(p, qT) R = <span class="hljs-number"><span class="hljs-number">1</span></span> / (<span class="hljs-number"><span class="hljs-number">1</span></span> + D) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> R</code> </pre><br>  Execution time: 353 ms, which is 8 times slower than the base implementation. <br><br>  For most tasks, this is a perfectly acceptable time.  The price of this is to switch the way of thinking; now it is necessary to collect code from the basic operations of linear algebra.  Sometimes it looks very beautiful, but sometimes you have to invent different tricks. <br><br>  But what about parallelism?  Here it is implicit.  We hope that at a low level all operations with matrices and vectors are implemented efficiently and in parallel. <br><br>  And what to do if our code does not fit into linear algebra, or do we want explicit parallelization? <br><br><h3>  Python + Cython </h3><br>  Here comes the time of <a href="http://cython.readthedocs.io/">Cython</a> .  Cython is a special language that allows you to embed code in the C-image language inside normal Python code.  Cython then converts this code to .c files that are compiled into python modules.  These modules are transparent enough to be called in other parts of Python code.  The implementation on Cython looks like this: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@cython.wraparound(False) @cython.nonecheck(False) @cython.boundscheck(False) def get_R_cython_mp(py_p, py_q): py_R = np.empty((py_p.shape[0], py_q.shape[1])) cdef int nP = py_p.shape[0] cdef int nQ = py_q.shape[1] cdef double[:, :] p = py_p cdef double[:, :] q = py_q cdef double[:, :] R = py_R cdef int i, j cdef double rx, ry, rz with nogil: for i in prange(nP): for j in xrange(nQ): rx = p[i, 0] - q[0, j] ry = p[i, 1] - q[1, j] rz = p[i, 2] - q[2, j] R[i, j] = 1 / (1 + sqrt(rx * rx + ry * ry + rz * rz)) return py_R</span></span></code> </pre><br>  What's going on here?  The function accepts python numpy objects as input, then they are converted into Cython typed C-structures, and then gil is disabled and the outer loop is executed in parallel using a special 'prange' construct. <br><br>  Runtime: 76 ms, which is 1.75 times slower than the base implementation. <br><br>  Well, we are almost close to the base implementation, we started writing explicit parallel code.  But the price for this was less readable code, we left pure Python. <br><br>  In general, most numerical calculations are written this way.  Most of the NumPy, and some places critical in speed are placed in separate modules and implemented in cython. <br><br><h3>  Python + Numba </h3><br>  We have come a long way.  We started with pure Python, then went the way of matrix computing magic, then plunged into special language extensions.  It's time to go back to where we started.  So, the implementation in Python + Numba: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@jit(float64[:, :](float64[:, :], float64[:, :]), nopython=True, parallel=True) def get_R_numba_mp(p, q): R = np.empty((p.shape[0], q.shape[1])) for i in prange(p.shape[0]): for j in range(q.shape[1]): rx = p[i, 0] - q[0, j] ry = p[i, 1] - q[1, j] rz = p[i, 2] - q[2, j] R[i, j] = 1 / (1 + math.sqrt(rx * rx + ry * ry + rz * rz)) return R</span></span></code> </pre><br>  Execution time: 46 ms, which practically coincides with the base implementation! <br><br>  And all that needed to be done for this with the source slow Python code: <br><br><ul><li>  add annotation with types and parallel execution type </li><li>  replace 'range' with 'prange' to run the outer loop in parallel </li></ul><br>  Numba is a very interesting project.  This is an optimized JIT compiler for Python based on LLVM.  It is completely transparent for use, no separate modules are needed.  All you need to do is add a few annotations to speed-critical methods. <br><br>  In summary, the execution times are as follows: <br><table><tbody><tr><td>  C ++ </td><td>  Python </td><td>  Numpy </td><td>  Scipy </td><td>  Cython </td><td>  Numba </td></tr><tr><td>  44 ms </td><td>  52,861 ms </td><td>  839 ms </td><td>  353 ms </td><td>  76 ms </td><td>  46 ms </td></tr></tbody></table></div><p>Source: <a href="https://habr.com/ru/post/336684/">https://habr.com/ru/post/336684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336674/index.html">Why blockchain is not such a bad technology</a></li>
<li><a href="../336676/index.html">Where did the need for Threat Intelligence come from?</a></li>
<li><a href="../336678/index.html">How we created the ATOL Online cash desk service</a></li>
<li><a href="../336680/index.html">Work with complex software: how to migrate the cash program and not "break" the store</a></li>
<li><a href="../336682/index.html">How to evaluate a job offer</a></li>
<li><a href="../336686/index.html">Boot from GPT disk from BIOS</a></li>
<li><a href="../336688/index.html">Ad render v.2.0. Book One. Overview</a></li>
<li><a href="../336690/index.html">RailsClub 2017: Interview with Nick Sutterer. Rails dies (Ruby doesn't)</a></li>
<li><a href="../336692/index.html">Animation in WPF and Blend SDK</a></li>
<li><a href="../336694/index.html">The practice of forming requirements in IT projects from A to Z. Part 1. Introduction</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>