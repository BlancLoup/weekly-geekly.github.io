<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Clock on FPGA Lattice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, DmitrySpb79 wrote articles on the creation of electronic watches. In them, he considered the sources of exact time , as well as the ele...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Clock on FPGA Lattice</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/449/593/095/449593095ef3426682e99f9b3b4c067f.png" align="left">  Some time ago, DmitrySpb79 wrote articles on the creation of electronic watches.  In them, he considered the <a href="http://geektimes.ru/post/260556/">sources of exact time</a> , as well as the <a href="https://geektimes.ru/post/261258/">element base for the creation of electronic clocks</a> .  Arduino, STM, Raspberry PI, ESP8266 were mentioned, but <a href="https://geektimes.ru/post/261258/">FPGAs were</a> completely <a href="https://geektimes.ru/post/261258/">forgotten</a> . <br><br>  Let's fill this little gap.  We find out how easy it is to make a clock on the FPGA and what hardware resources will be required for this.  Besides, they gave me a FPGA chip of a very small volume - 64 macro cells.  This is the Lattice FPGA LC4064v with which I have never worked before.  I think it will be interesting! <br><br>  Goals: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  try to fit the logic of the clock in a small FPGA (64 macro cells); </li><li>  master the static or dynamic LED display on the FPGA for time display; </li><li>  collect a bunch of rakes related to the independent development of schemes and get a new experience; </li><li>  master the new development and programming environment for FPGAs from Lattice, assess the complexity of the transition </li></ul><br>  I expect several very pleasant evenings dedicated to the development of FPGA! <br><br clear="left"><a name="habracut"></a><br><br><h4>  <b>Manufacturer FPGA Lattice?</b> </h4><br><img src="https://habrastorage.org/files/639/8f2/495/6398f24953524f05a00da1d39f23a335.png" align="right">  <a href="http://www.latticesemi.com/">Lattice Semiconductor Corporation</a> is an American chip maker.  The company is located in Oregon and produces high-performance FPGAs.  There is information that microcircuits are popular in industrial developments because of the openness of documentation and protocols.  A wide <a href="http://www.latticesemi.com/Products.aspx">list of products</a> and their appointments suggests that they make a series of FPGAs for automation, automotive, creating compact, portable, cost-effective devices.  Also, there are FPGA series of large volumes (up to 100k and more macrocells). <br clear="right"><br><br><h4>  <b>Where to find FPGA Lattice?</b> </h4><br><img src="https://habrastorage.org/files/af7/ee2/bf2/af7ee2bf2c7a4106891ef64b19e14eac.jpg" align="left">  Unfortunately, I have not yet been able to find a store where I could buy FPGAs with a volume of 1‚Äì4 thousand macrocells and a price of one or two thousand rubles.  However, I found a fee to meet my requirements - <a href="http://www.latticestore.com/products/tabid/417/categoryid/59/productid/25000/default.aspx">Programmable Logic IC Development Tools MachXO3LF StarterKit</a> .  The number of cells is 6900, there is already a programmer ( <a href="https://www.youtube.com/watch%3Fv%3DtCq98g_AMPA">FTDI</a> ) on the board, <a href="https://www.youtube.com/watch%3Fv%3DRWNzZ8jf5eE">8 LEDs</a> .  The price of $ 25, however, the cost of delivery, at checkout in the Lattice Store, was $ 45.  Well, there will be money - I will search on <a href="http://www.digikey.ru/">digikey</a> or <a href="http://ru.mouser.com/">mouser</a> and at the same time master them.  However, there was still a purchase option in the Motherland, in the <a href="http://www.elitan.ru/price/index.php%3Ffind%3DLCMXO3LF-6900C-S-EVN%26delay%3D-1%26mfg%3Dall%26seenform%3Dy">Elitan</a> store, at a price of 2992 rubles.  On Ebay / Aliexpress, the choice is not big yet, but we managed to find a chip without a 5,000-cell <a href="http://www.ebay.com/itm/1PCS-LFXP2-5E-5QN208C-IC-FPGA-146-I-O-208PQFP-ALTERA-NEW-GOOD-QUALITY-Q3-/301724765208">board</a> - <a href="http://www.ebay.com/itm/1PCS-LFXP2-5E-5QN208C-IC-FPGA-146-I-O-208PQFP-ALTERA-NEW-GOOD-QUALITY-Q3-/301724765208">LFXP2-5E-5QN208C</a> . <br><br>  When disassembling old electronics, CPLD of small sizes (32, 64 cells) are periodically caught.  One such microcircuit was presented to me by my friend.  FPGA chip LC4064V ( <a href="http://www.mouser.com/ds/2/225/ispMACH4000VBCZFamilyDataSheet-760658.pdf">pdf</a> ) - a representative of <a href="http://www.latticesemi.com/en/Products/FPGAandCPLD/ispMACH4000VBCZ.aspx">the ispMACH 4000V / B / C / Z Family family</a> .  My version works on 3.3V voltage, at frequencies up to 400 MHz!  The TQFP package contains as many as 32 I / O lines, of which two are used for clock inputs.  The lines are tolerant to 5 V in the modes LVCMOS3.3, LVTTL and PCI.  All conclusions can be "pulled" pull-up, pull-down, or can hang in the air.  Also, you can work in open-drain mode. <br clear="right"><br><br><h4>  <b>Lattice Development Environment</b> </h4><br>  For small FPGAs that need LC4064v is needed: <a href="http://www.latticesemi.com/ispleverclassic">ispLEVER Classic</a> . <br>  For firmware, you need to install: <a href="http://www.latticesemi.com/en/Products/DesignSoftwareAndIP/ProgrammingAndConfigurationSw/Programmer.aspx">Diamond Programmer</a> . <br>  For larger FPGAs: <a href="http://www.latticesemi.com/en/Products/DesignSoftwareAndIP/ProgrammingAndConfigurationSw/Programmer.aspx">Lattice Diamond</a> . <br><br>  To activate the programs, you need to <a href="https://www.latticesemi.com/Accounts/AccountRegister.aspx">register on</a> e <a href="https://www.latticesemi.com/Accounts/AccountRegister.aspx">site</a> , specify your MAC address and download license keys. <br><br>  To create a general idea of ‚Äã‚Äãhow to develop projects in the Lattice Diamond environment, I recommend reading <a href="https://www.youtube.com/watch%3Fv%3DSmdEP_ZsBgM">this video</a> . <br><br><h4>  <b>How to "flash" Lattice?</b> </h4><br>  LPT programmers are almost gone.  And there is no time and desire to assemble a programmer (there is a desire to do a project).  As in the case of Altera, I decided to find and buy a ready-made Chinese clone of the programmer, on Ebay or Aliexpress sites.  However, if the programmer for Altera is within <a href="http://www.ebay.com/itm/altera-Mini-Usb-Blaster-Cable-For-CPLD-FPGA-NIOS-JTAG-Altera-Programmer-/200943750380%3Fhash%3Ditem2ec92e4cec:g:XSQAAOxylYZR5OwR">300 rubles</a> , then for Lattice the price is already about <a href="http://ru.aliexpress.com/item/LATTICE-USB-download-cable-to-download-the-software-to-send-complete-accessories/32315769632.html%3Fspm%3D2114.30010708.3.10.OZ5Pgu%26ws_ab_test%3Dsearchweb201556_2,searchweb201644_1_10001_10002_10005_301_10006_10012_10003_10004_401_62_10007,searchweb201560_8,searchweb1451318400_6150,searchweb1451318411_6452%26btsid%3D0fc102c3-0472-43f0-9df3-2e85ffc906f7">2000 rubles</a> .  For the seemingly identical products, differing only by the sticker.  But if you carefully search, you can find it cheaper - <a href="http://ru.aliexpress.com/item/Lattice-CPLD-FPGA-USB-downloader-ispDOWNLOAD-Cables-Enterprise-Edition/32266168665.html">1300 rubles</a> !  I take two at once: myself and my friend.  Upon arrival, one programmer <a href="http://www.youtube.com/watch%3Fv%3Dq4A2FLf90mg">refused to work</a> .  He began to communicate with the seller, he assured that they all checked.  As a result, I repaired it myself by disappearing the ground on the USB connector. <br><br>  Compared with the programmer for Altera, to make sure that they are different, and not "only the USB ID is different." <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/837/615/4db/8376154db3334864a8d9fedb53413030.png"></div><br><br>  A few more photos: <a href="">1</a> , <a href="">2</a> , <a href="">3</a> .  Chip is really more, so it is quite obvious that the programmer turns out more expensive. <br><br>  To check the chip in haste I make a board with LEDs and a button.  I solder the microcircuit on the adapter board. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/98d/491/2d2/98d4912d28b541a69bf129a8d5f7bdc4.jpg"></div><br>  As a generator, I did not find anything simpler than the <a href="">FPGA of Altera Cyclone</a> :) I shared the clock frequency of 50 MHz to 2 Hz and brought it back.  This signal applied to the clock input LC4064v.  Made the simplest 4-bit counter, and brought his bits out and connected to the LEDs. <br><br>  I'm flashing it - it works! <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/9u3KdgT889M%3Ffeature%3Doembed&amp;xid=17259,1500003,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi8sTFUmSPzP4sUZ7xkHJxWigCrOg" frameborder="0" allowfullscreen=""></iframe><br>  Now, when it became clear that the FPGA works and is programmable, you can invent a <s>problem</s> for yourself and solve it heroically! <br><br><h4>  <b>What problem to solve?</b> </h4><br>  In fact, the idea to make a watch did not come immediately.  The number of cells, equal to 64, makes you think about the task that you can assign them.  I remember the old days when there was a strictly defined MK available, which I could program, and I tried to fit the solved problem into it.  Programming the FPGA assumes the opposite: solving the problem and choosing the FPGA of the desired size based on the results of the synthesis.  But here we turn everything upside down, and limit ourselves to size.  This will force us to work hard both in the choice of the task and in its implementation.  Some kind of extreme programming in limited conditions. <br><br>  What to do?  Electronic synthesizer?  Not enough cells: only a MIDI command receiver takes more than one hundred.  Need something simple!  For example, decoder audio I2S flow and output it through the DAC on the resistors?  As it is very specific, simple and not very spectacular.  There are many lines - you can hang seven-segment indicators (7x4 = 28 even statically!).  And what to portray?  You can make either a frequency counter (a great option, because the chip works right up to 400 MHz) or a clock.  It was decided to choose a watch. <br><br><h4>  <b>Parts for assembling watches</b> </h4><br>  For hours we will need a seven-segment indicator of four digits.  At first I wanted to buy a new indicator in the store, and then I remembered that I already had a time indicator, which has been in the box for about ten years already.  I once gave it a long time ago to regenerator from the <a href="http://radiokot.ru/forum">RadioKot</a> forum.  The scheme of turning on my indicator has the following scary look: <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/d3d/96c/0a5/d3d96c0a5d394baf9e04b7049dcc4a4f.png"></a> </div><br><br>  As part of ridding the boxes of stale components, as well as bullying FPGAs (and ourselves), it was decided to use this seemingly incomprehensible indicator.  In fact, everything is quite simple: from above we apply the control voltage to the indicators.  As a rule, one wire goes to two segments at once.  And which of the two segments will work is determined by the bus that we connected to the common wire at the moment.  The scheme, in general, corresponds to the classical <a href="">dynamic indication scheme</a> with the difference that we have only two indicators.  To test the operation of all indicators, I brought a logical unit to all outputs, and I brought the signal to transistors in turn. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/cuoWVnmru7I%3Ffeature%3Doembed&amp;xid=17259,1500003,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhievYZUAeuW8Z7kcKpzcjO19Hu3lA" frameborder="0" allowfullscreen=""></iframe><br>  According to the test results, it turned out that we, in principle, can display a number on any indicator.  However, in the leftmost indicator is missing one segment.  This will not allow to display all possible digits on it, but the most important thing is the number "zero".  This fact is confirmed by <a href="">this picture</a> .  Therefore, zero in dozens of hours will be extinguished. <br><br>  We also need a "clock generator" - a generator at a frequency of 32768 Hz.  Why such a frequency?  Because if you take a 15-bit binary counter and apply this frequency to it, then we will get 1 Hz (2 ^ 15 = 32768) at the output.  That is an interval of one second.  I want to note another important point in choosing the frequency of the generator.  In order to divide the frequency by 32768, a 15-bit binary counter is required, and it will at least take 15 cells in the FPGA, which will immediately take up almost a quarter of the resources.  The counter for the 50 MHz oscillator will require 30 bits to divide by the second interval.  At such costs, the cells on the logic of the clock may not be enough. <br><br>  While there is no quartz clock, again Altera Cyclone will act as a frequency generator, in which I integerly divided the frequency 50 MHz to 32768 Hz. <br><br>  For frequency division, I use my Verilog module.  It is very simple to work with it: at clk we give the original frequency, from s_out we get the result.  The division factor set parameter DIV.  In my case, 50000000 Hz is the input clock frequency, and 32768 Hz is the frequency that needs to be received. <br><br><pre><code class="hljs lisp">frqdivmod #(.DIV(<span class="hljs-number"><span class="hljs-number">50000000/32768</span></span>)) divider(.clk(<span class="hljs-name"><span class="hljs-name">clk50M</span></span>), .s_out(<span class="hljs-name"><span class="hljs-name">clk32768</span></span>))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Code module frequency divider by integer (Verilog)</b> <div class="spoiler_text"><pre> <code class="hljs ruby"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frqdivmod</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clk</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s_out</span></span></span><span class="hljs-class">);</span></span> parameter DIV=<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> calculated parameters parameter WITH = ($clog2(DIV)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>) ? $clog2(DIV) : <span class="hljs-number"><span class="hljs-number">1</span></span>; input wire clk; output wire s_out; reg clk_n; reg [(WITH-<span class="hljs-number"><span class="hljs-number">1</span></span>)<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>] pos_cnt; reg [(WITH-<span class="hljs-number"><span class="hljs-number">1</span></span>)<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>] neg_cnt; wire [(WITH-<span class="hljs-number"><span class="hljs-number">1</span></span>)<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>] div_value = DIV[(WITH-<span class="hljs-number"><span class="hljs-number">1</span></span>)<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>]; initial <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> clk_n &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b0; pos_cnt &lt;= {(WITH){1'</span></span>b<span class="hljs-number"><span class="hljs-number">0</span></span>}}; neg_cnt &lt;= {(WITH){<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b0}}; end assign s_out = (DIV==1) ? clk : clk_n; always @ (posedge clk) begin pos_cnt &lt;= (pos_cnt + 1'</span></span>b1) % div_value; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> always @ (negedge clk) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> neg_cnt &lt;= (neg_cnt + <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b1) % div_value; end always @(clk, pos_cnt, neg_cnt) begin //pos_cnt in sens list addd for resolve warning "variable is read inside the Always Construct but isn'</span></span>t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the Always Construct<span class="hljs-string"><span class="hljs-string">'s Event Control" if ((DIV%2) == 1'</span></span>b<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> clk_n &lt;= ( pos_cnt &gt;= (DIV/<span class="hljs-number"><span class="hljs-number">2</span></span>)) ? <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b1 : 1'</span></span>b<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> clk_n &lt;= (( pos_cnt &gt; (DIV/<span class="hljs-number"><span class="hljs-number">2</span></span>)) <span class="hljs-params"><span class="hljs-params">||</span></span> ( neg_cnt &gt; (DIV/<span class="hljs-number"><span class="hljs-number">2</span></span>))) ? <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b1 : 1'</span></span>b<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endmodule</code> </pre> <br></div></div><br><h4>  <b>We set hardware logic</b> </h4><br>  The first iteration of creating a clock is the creation of a binary counter circuit with asynchronous reset (click on the picture to open the circuit on the site <a href="http://www.falstad.com/">http://www.falstad.com/</a> where you can adjust it as you like) <br><br> <a href="http://www.falstad.com/circuit/circuitjs.html%3Fcct%3D%24%2B1%2B0.000005%2B10.200277308269968%2B50%2B5%2B50%250A156%2B80%2B208%2B128%2B208%2B0%2B0%250A156%2B208%2B208%2B240%2B208%2B0%2B5%250A156%2B336%2B208%2B368%2B208%2B0%2B0%250A156%2B464%2B208%2B480%2B208%2B0%2B0%250Aw%2B176%2B208%2B176%2B240%2B0%250Aw%2B176%2B240%2B208%2B240%2B0%250Aw%2B304%2B208%2B304%2B240%2B0%250Aw%2B304%2B240%2B336%2B240%2B0%250Aw%2B432%2B208%2B432%2B240%2B0%250Aw%2B432%2B240%2B464%2B240%2B0%250Aw%2B464%2B208%2B448%2B208%2B0%250Aw%2B448%2B208%2B448%2B272%2B0%250Aw%2B448%2B272%2B464%2B272%2B0%250Aw%2B448%2B272%2B448%2B320%2B0%250Aw%2B448%2B320%2B320%2B320%2B0%250Aw%2B320%2B320%2B320%2B272%2B0%250Aw%2B320%2B272%2B336%2B272%2B0%250Aw%2B320%2B272%2B320%2B208%2B0%250Aw%2B320%2B208%2B336%2B208%2B0%250Aw%2B208%2B208%2B192%2B208%2B0%250Aw%2B192%2B208%2B192%2B272%2B0%250Aw%2B192%2B272%2B208%2B272%2B0%250Aw%2B192%2B272%2B192%2B320%2B0%250Aw%2B192%2B320%2B320%2B320%2B0%250Aw%2B80%2B208%2B64%2B208%2B0%250Aw%2B64%2B208%2B64%2B272%2B0%250Aw%2B64%2B272%2B80%2B272%2B0%250Aw%2B64%2B272%2B64%2B320%2B0%250Aw%2B64%2B320%2B192%2B320%2B0%250AR%2B80%2B240%2B32%2B240%2B1%2B2%2B200%2B2.5%2B2.5%2B0%2B0.5%250AR%2B64%2B320%2B32%2B320%2B0%2B0%2B40%2B5%2B0%2B0%2B0.5%250Aw%2B560%2B208%2B560%2B48%2B0%250Aw%2B432%2B208%2B432%2B80%2B0%250Aw%2B304%2B208%2B304%2B112%2B0%250Aw%2B176%2B208%2B176%2B144%2B0%250AM%2B560%2B48%2B592%2B48%2B2%2B2.5%250AM%2B432%2B80%2B592%2B80%2B2%2B2.5%250AM%2B304%2B112%2B592%2B112%2B2%2B2.5%250AM%2B176%2B144%2B592%2B144%2B2%2B2.5%250A197%2B640%2B64%2B800%2B64%2B0%250Aw%2B576%2B144%2B576%2B160%2B0%250Aw%2B576%2B160%2B640%2B160%2B0%250Aw%2B576%2B144%2B176%2B144%2B0%250Aw%2B640%2B128%2B576%2B128%2B0%250Aw%2B576%2B128%2B576%2B112%2B0%250Aw%2B576%2B112%2B304%2B112%2B0%250Aw%2B640%2B96%2B576%2B96%2B0%250Aw%2B576%2B96%2B576%2B80%2B0%250Aw%2B576%2B80%2B432%2B80%2B0%250Aw%2B640%2B64%2B576%2B64%2B0%250Aw%2B576%2B64%2B576%2B48%2B0%250Aw%2B576%2B48%2B560%2B48%2B0%250A157%2B816%2B64%2B928%2B64%2B0%250Aw%2B768%2B64%2B816%2B64%2B0%250Aw%2B768%2B96%2B816%2B96%2B0%250Aw%2B768%2B128%2B816%2B128%2B0%250Aw%2B768%2B160%2B816%2B160%2B0%250Aw%2B768%2B192%2B880%2B192%2B0%250Aw%2B768%2B224%2B912%2B224%2B0%250Aw%2B912%2B224%2B912%2B192%2B0%250Aw%2B768%2B256%2B944%2B256%2B0%250Aw%2B944%2B256%2B944%2B192%2B0%250Ao%2B35%2B64%2B0%2B38%2B5%2B0.00009765625%2B0%2B-1%250Ao%2B36%2B64%2B0%2B38%2B5%2B0.00009765625%2B0%2B-1%250Ao%2B37%2B64%2B0%2B38%2B5%2B0.00009765625%2B0%2B-1%250Ao%2B38%2B64%2B0%2B38%2B5%2B0.00009765625%2B0%2B-1%250A"><img src="https://habrastorage.org/files/08e/676/1af/08e6761af73c4bc09d9a8b03f909a72e.gif" alt="image123"></a> <br><br>  When the counter reaches the value "10" (b1010) - we must reset it.  The same signal will be used as a clock for the next digit counter. <br><br> <a href="http://www.falstad.com/circuit/circuitjs.html%3Fcct%3D%24%2B1%2B0.000005%2B4.252108200006278%2B50%2B5%2B50%250A156%2B80%2B208%2B128%2B208%2B2%2B0%250A156%2B240%2B208%2B272%2B208%2B2%2B0%250A156%2B400%2B208%2B432%2B208%2B2%2B5%250A156%2B560%2B208%2B576%2B208%2B2%2B0%250Aw%2B208%2B208%2B208%2B240%2B0%250Aw%2B208%2B240%2B240%2B240%2B0%250Aw%2B368%2B240%2B400%2B240%2B0%250Aw%2B528%2B240%2B560%2B240%2B0%250Aw%2B560%2B208%2B544%2B208%2B0%250Aw%2B544%2B272%2B560%2B272%2B0%250Aw%2B384%2B272%2B400%2B272%2B0%250Aw%2B384%2B208%2B400%2B208%2B0%250Aw%2B240%2B208%2B224%2B208%2B0%250Aw%2B80%2B208%2B64%2B208%2B0%250Aw%2B64%2B208%2B64%2B272%2B0%250Aw%2B64%2B272%2B80%2B272%2B0%250Aw%2B64%2B272%2B64%2B320%2B0%250AR%2B80%2B240%2B32%2B240%2B1%2B2%2B200%2B2.5%2B2.5%2B0%2B0.5%250AR%2B64%2B320%2B32%2B320%2B0%2B0%2B40%2B5%2B0%2B0%2B0.5%250Aw%2B496%2B208%2B496%2B80%2B0%250Aw%2B336%2B208%2B336%2B112%2B0%250Aw%2B208%2B208%2B208%2B144%2B0%250AM%2B656%2B48%2B688%2B48%2B2%2B2.5%250AM%2B528%2B80%2B688%2B80%2B2%2B2.5%250AM%2B400%2B112%2B688%2B112%2B2%2B2.5%250AM%2B272%2B144%2B688%2B144%2B2%2B2.5%250A197%2B736%2B64%2B896%2B64%2B0%250Aw%2B672%2B144%2B672%2B160%2B0%250Aw%2B672%2B160%2B736%2B160%2B0%250Aw%2B672%2B144%2B272%2B144%2B0%250Aw%2B736%2B128%2B672%2B128%2B0%250Aw%2B672%2B128%2B672%2B112%2B0%250Aw%2B672%2B112%2B400%2B112%2B0%250Aw%2B736%2B96%2B672%2B96%2B0%250Aw%2B672%2B96%2B672%2B80%2B0%250Aw%2B672%2B80%2B528%2B80%2B0%250Aw%2B736%2B64%2B672%2B64%2B0%250Aw%2B672%2B64%2B672%2B48%2B0%250Aw%2B672%2B48%2B656%2B48%2B0%250A157%2B912%2B64%2B1024%2B64%2B0%250Aw%2B864%2B96%2B912%2B96%2B0%250Aw%2B864%2B128%2B912%2B128%2B0%250Aw%2B864%2B160%2B912%2B160%2B0%250Aw%2B864%2B192%2B976%2B192%2B0%250Aw%2B864%2B224%2B1008%2B224%2B0%250Aw%2B1008%2B224%2B1008%2B192%2B0%250Aw%2B864%2B256%2B1040%2B256%2B0%250Aw%2B1040%2B256%2B1040%2B192%2B0%250A150%2B368%2B432%2B496%2B432%2B0%2B2%2B0%250A150%2B800%2B448%2B928%2B448%2B0%2B2%2B0%250A150%2B704%2B432%2B784%2B432%2B0%2B2%2B0%250Aw%2B224%2B272%2B240%2B272%2B0%250Aw%2B224%2B208%2B224%2B272%2B0%250Aw%2B384%2B208%2B384%2B272%2B0%250Aw%2B544%2B208%2B544%2B272%2B0%250Aw%2B224%2B272%2B224%2B320%2B0%250Aw%2B224%2B320%2B64%2B320%2B0%250Aw%2B384%2B272%2B384%2B320%2B0%250Aw%2B384%2B320%2B224%2B320%2B0%250Aw%2B544%2B272%2B544%2B320%2B0%250Aw%2B544%2B320%2B384%2B320%2B0%250Aw%2B176%2B208%2B208%2B208%2B0%250Aw%2B272%2B144%2B208%2B144%2B0%250Aw%2B400%2B112%2B336%2B112%2B0%250Aw%2B528%2B80%2B496%2B80%2B0%250Aw%2B368%2B240%2B368%2B208%2B0%250Aw%2B368%2B208%2B336%2B208%2B0%250Aw%2B864%2B64%2B912%2B64%2B0%250Aw%2B656%2B208%2B656%2B48%2B0%250Aw%2B528%2B240%2B528%2B208%2B0%250Aw%2B528%2B208%2B496%2B208%2B0%250Aw%2B368%2B448%2B176%2B448%2B0%250Aw%2B176%2B448%2B176%2B272%2B0%250Aw%2B368%2B416%2B368%2B240%2B0%250Aw%2B704%2B416%2B704%2B208%2B0%250Aw%2B704%2B208%2B656%2B208%2B0%250Aw%2B704%2B448%2B544%2B448%2B0%250Aw%2B544%2B448%2B544%2B336%2B0%250Aw%2B544%2B336%2B496%2B336%2B0%250Aw%2B496%2B336%2B496%2B272%2B0%250Aw%2B784%2B432%2B800%2B432%2B0%250Aw%2B496%2B432%2B496%2B464%2B0%250Aw%2B496%2B464%2B800%2B464%2B0%250Aw%2B176%2B240%2B192%2B240%2B0%250Aw%2B192%2B240%2B192%2B576%2B0%250Aw%2B336%2B240%2B352%2B240%2B0%250Aw%2B352%2B240%2B352%2B576%2B0%250Aw%2B352%2B576%2B192%2B576%2B0%250Aw%2B496%2B240%2B512%2B240%2B0%250Aw%2B512%2B240%2B512%2B576%2B0%250Aw%2B512%2B576%2B352%2B576%2B0%250Aw%2B656%2B240%2B672%2B240%2B0%250Aw%2B672%2B240%2B672%2B576%2B0%250Aw%2B672%2B576%2B512%2B576%2B0%250Aw%2B1008%2B576%2B672%2B576%2B0%250Ar%2B928%2B448%2B976%2B448%2B0%2B100%250Ac%2B992%2B448%2B992%2B512%2B0%2B0.00001%2B2.8823090184623055e-9%250Aw%2B976%2B448%2B992%2B448%2B0%250Ag%2B992%2B512%2B992%2B528%2B0%250Aw%2B1008%2B576%2B1040%2B576%2B0%250Aw%2B1040%2B576%2B1040%2B448%2B0%250Aw%2B1040%2B448%2B992%2B448%2B0%250Ao%2B22%2B64%2B0%2B38%2B5%2B0.00009765625%2B0%2B-1%250Ao%2B23%2B64%2B0%2B38%2B5%2B0.00009765625%2B0%2B-1%250Ao%2B24%2B64%2B0%2B38%2B5%2B0.00009765625%2B0%2B-1%250Ao%2B25%2B64%2B0%2B38%2B5%2B0.00009765625%2B0%2B-1%250A"><img src="https://habrastorage.org/files/cdf/91f/b94/cdf91fb943f44f7b95d452842e74bc9b.gif" alt="image321"></a> <br><br>  RC string is used to increase the period of the signal to reach "10".  If this signal is too short, then some triggers may not have time to reset, or change their value.  But the use of asynchronous reset in the FPGA can lead to a number of problems.  In order to increase the signal period, we use analog circuitry, although we are developing a digital circuit.  If we want to apply this approach in the FPGA, then we will need to output this signal to the outside of the chip - to the external output, install a chain there, and then send it back - to another input of the FPGA. <br><br><div class="spoiler">  <b class="spoiler_title">Verilog module defining an asynchronous reset counter</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">// counter module cntr #(parameter width=<span class="hljs-number"><span class="hljs-number">4</span></span>) (clk, res, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> wire clk, res; output reg [width<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>; initial <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> &lt;= {width{<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b0}}; always @(posedge clk or posedge res) begin if (res) begin out &lt;= 0; end else begin out &lt;= out + 1'</span></span>b1; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endmodule</code> </pre> <br></div></div><br>  As an experiment, I still made a watch on counters with asynchronous reset.  At the same time, I did not output or use any RC chains.  My goal was to find out if you really shouldn‚Äôt use asynchronous logic, or "oh well and so it‚Äôs okay."  Up to some stage the clock regularly counted time <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/mK-86iha1VY%3Ffeature%3Doembed&amp;xid=17259,1500003,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjiXRLqTFVZ-tYL9u-DTNS4PIg9wA" frameborder="0" allowfullscreen=""></iframe><br>  But at that moment, when I decided to add a flashing second in the clock, everything suddenly broke down. <br><br>  When developing on FPGA it is strongly recommended to use synchronous logic.  In the case of a clock and a counter, the current value of the counter must be stored in a register, and the next value of the register we must calculate the combinational circuit.  The next value will be unequivocally calculated (we hope so) before the next clock, but will be loaded into the register on the front of the clock pulse.  That is, no "needles" of the dump will not slip.  Based on the current values ‚Äã‚Äãof the registers, we always uniquely determine the value on the next clock cycle. <br><br><pre> <code class="hljs ruby">reg [<span class="hljs-number"><span class="hljs-number">3</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>] s;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">9</span></span> - <span class="hljs-number"><span class="hljs-number">4</span></span>bit --  /<span class="hljs-regexp"><span class="hljs-regexp">/      wire s_cy = (s == 4'd9); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    : wire [3:0] next_s = (s_cy) ? 4'd0 : (s + 1'b1); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  +1,  0,   9 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       always @(posedge clk1Hz) begin s &lt;= next_s; end</span></span></code> </pre> <br>  To output the register value to a seven-segment indicator, we need a converter module from binary to seven-segment code: <br><br><div class="spoiler">  <b class="spoiler_title">Verilog module bcd2seg0_9</b> <div class="spoiler_text"><pre> <code class="hljs vhdl">//bin <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>seg module bcd2seg0_9(sin, sout); input wire [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] sin; output wire [<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] sout; reg [<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] SEG_buf; always @ (sin) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(sin) <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0111111</span></span>; <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h1</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0000110</span></span>; <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h2</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1011011</span></span>; <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h3</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1001111</span></span>; <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h4</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1100110</span></span>; <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h5</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1101101</span></span>; <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h6</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1111101</span></span>; <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h7</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0000111</span></span>; <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h8</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1111111</span></span>; <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h9</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1101111</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: SEG_buf &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0000000</span></span>; endcase <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> assign sout = SEG_buf; endmodule</code> </pre> <br></div></div><br>  To save resources, we describe options only for numbers from 0 to 9. For the experiment, try an alternative converter module: <br><br><div class="spoiler">  <b class="spoiler_title">Verilog module bcd2seg0_9 (2)</b> <div class="spoiler_text"><pre> <code class="hljs lua">//bin to <span class="hljs-number"><span class="hljs-number">7</span></span>seg module bcd2seg(<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>, sout); <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> wire [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> wire [<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] sout; assign sout = (<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>==<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h0) ? 7'</span></span>b0111111 : (<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>==<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h1) ? 7'</span></span>b0000110 : (<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>==<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h2) ? 7'</span></span>b1011011 : (<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>==<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h3) ? 7'</span></span>b1001111 : (<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>==<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h4) ? 7'</span></span>b1100110 : (<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>==<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h5) ? 7'</span></span>b1101101 : (<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>==<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h6) ? 7'</span></span>b1111101 : (<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>==<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h7) ? 7'</span></span>b0000111 : (<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>==<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h8) ? 7'</span></span>b1111111 : (<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>==<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h9) ? 7'</span></span>b1101111 : <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0000000; endmodule</span></span></code> </pre> <br></div></div><br>  But the amount of resources expended has not changed.  We are happy for a smart synthesizer. <br><br>  Then simply create registers for seconds (units, tens), minutes (units, tens), hours (units, tens).  For each set the calculation of the next value.  But we make the change in the seconds value at every second pulse, while the change in the value of tens of seconds only happens when the units overflow.  Accordingly, units of minutes only change when tens and units of seconds are overflowed.  And so on. <br><br>  At the same time, the synthesis showed that everything is fine, but the device cells are no longer enough.  Oops.  In order to rectify the situation, it was decided to simplify the second register.  It is not output anyway, so we change two binary decimal counters by one binary from 0 to 59. And running a little ahead, I made it one bit more, but I reduced the counter of the common clock quartz frequency divider.  Therefore, the count goes from 0 to 119, but with a frequency of 2 Hz (see below, part about setting the time). <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">//clk - general clock 32768 reg [13:0] clk_div; initial clk_div </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">14</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag">; //??    </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Lattice</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">always</span></span></span></span><span class="xml"><span class="hljs-tag"> @(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">posedge</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">clk</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">clk_div</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clk_div</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag">; // , ,  </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">6:0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec</span></span></span></span><span class="xml"><span class="hljs-tag">;// </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0..119</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3:0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m</span></span></span></span><span class="xml"><span class="hljs-tag"> ;// </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0..9</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3:0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mm</span></span></span></span><span class="xml"><span class="hljs-tag"> ;// </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0..5</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3:0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> ;// </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0..9</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3:0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hh</span></span></span></span><span class="xml"><span class="hljs-tag"> ;// </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0..2</span></span></span></span><span class="xml"><span class="hljs-tag"> //    </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec_cy</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(sec</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">7</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d119</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">6:0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_sec</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(sec_cy)</span></span></span></span><span class="xml"><span class="hljs-tag"> ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m_cy</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(m</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d9</span></span></span></span><span class="xml"><span class="hljs-tag">);// &amp;&amp; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec_cy</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3:0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_m</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(m_cy)</span></span></span></span><span class="xml"><span class="hljs-tag"> ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag">);//(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m_cy</span></span></span></span><span class="xml"><span class="hljs-tag">) ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ss_cy</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mm_cy</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">((mm</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">3</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d5</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp;&amp;(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d9</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2:0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_mm</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(mm_cy)</span></span></span></span><span class="xml"><span class="hljs-tag"> ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mm</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h_cy</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(h</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d9</span></span></span></span><span class="xml"><span class="hljs-tag">)||((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hh</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d2</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp;&amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d3</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3:0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_h</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(h_cy)</span></span></span></span><span class="xml"><span class="hljs-tag"> ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hh_cy</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">((hh</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">2</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d2</span></span></span></span><span class="xml"><span class="hljs-tag">) &amp;&amp; (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d3</span></span></span></span><span class="xml"><span class="hljs-tag">)); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1:0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_hh</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(hh_cy)</span></span></span></span><span class="xml"><span class="hljs-tag"> ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hh</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag">); //     </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">wire</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">timer_clk</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clk_div[13];</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">always</span></span></span></span><span class="xml"><span class="hljs-tag"> @(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">posedge</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">timer_clk</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">begin</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">next_sec;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec_cy</span></span></span></span><span class="xml"><span class="hljs-tag">) ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_m</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mm</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m_cy</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec_cy</span></span></span></span><span class="xml"><span class="hljs-tag">) ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_mm</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mm</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mm_cy</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m_cy</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec_cy</span></span></span></span><span class="xml"><span class="hljs-tag">) ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_h</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hh</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(h_cy&amp;mm_cy&amp;&amp;m_cy&amp;&amp;sec_cy)</span></span></span></span><span class="xml"><span class="hljs-tag"> ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_hh</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hh</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span></span></span></span></code> </pre> <br><h4>  <b>Conclusion on seven-segment indicators</b> </h4><br>  Each register HH: MM we output to seven-segment indicators.  But before that, we transform it into a seven-segment code. <br><br><pre> <code class="hljs pgsql">//      wire [<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] s_m; wire [<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] s_mm; wire [<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] s_h; wire [<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] s_hh; //       bcd2seg0_9 sseg_m( .sin(m), .sout(s_m)); bcd2seg0_5 sseg_mm(.sin(mm), .sout(s_mm)); bcd2seg0_9 sseg_h( .sin(h), .sout(s_h)); bcd2seg0_2 sseg_hh(.sin(hh), .sout(s_hh));</code> </pre> <br>  But we have a dynamic display.  Moreover, during the output, not separate seven-segment blocks are switched, but separate elements of indicators.  Therefore, let‚Äôs go down to the level of each indicator element: <br><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//    wire a1,b1,c1,d1,e1,f1,g1; wire a2,b2,c2,d2,e2,f2,g2; wire a3,b3,c3,d3,e3,f3,g3; wire a4,b4,c4,d4,e4,f4,g4; //      assign {g4, f4, e4, d4, c4, b4, a4} = s_m; assign {g3, f3, e3, d3, c3, b3, a3} = s_mm; assign {g2, f2, e2, d2, c2, b2, a2} = s_h; assign {g1, f1, e1, d1, c1, b1, a1} = s_hh;</span></span></code> </pre> <br>  Next, based on the indicator scheme, we understand that there are two lines on the minus.  We will switch them in turn: <br><br><pre> <code class="hljs lisp">wire led_line1 = (<span class="hljs-name"><span class="hljs-name">clk_div</span></span>[<span class="hljs-number"><span class="hljs-number">7</span></span>])<span class="hljs-comment"><span class="hljs-comment">; //8-    32768    wire led_line2 = (~led_gnd1);//   256 </span></span></code> </pre> <br>  We assign to the combined lines of the segments, the corresponding values, depending on which line is currently active: <br><br><pre> <code class="hljs ruby">wire h_show = !(hh==<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     assign led6 = (led_line1&amp;&amp;(b1&amp;&amp;h_show)) <span class="hljs-params"><span class="hljs-params">||</span></span> (led_line2&amp;&amp;(b1&amp;&amp;h_show)); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> b1 assign led7 = (led_line1&amp;&amp;(a1&amp;&amp;h_show)) <span class="hljs-params"><span class="hljs-params">||</span></span> (led_line2&amp;&amp;(g1&amp;&amp;h_show)); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> a1/g1 assign led8 = (led_line1&amp;&amp;(d1&amp;&amp;h_show)) <span class="hljs-params"><span class="hljs-params">||</span></span> (led_line2&amp;&amp;(e1&amp;&amp;h_show)); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> d1/e1 assign led9 = (led_line1&amp;&amp;e2) <span class="hljs-params"><span class="hljs-params">||</span></span> (led_line2&amp;&amp;(c1&amp;&amp;h_show)); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> e2/c1 assign led1<span class="hljs-number"><span class="hljs-number">0</span></span> = (led_line1&amp;&amp;g2) <span class="hljs-params"><span class="hljs-params">||</span></span> (led_line2&amp;&amp;b2); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> g2/b2 assign led12 = (led_line1&amp;&amp;d2) <span class="hljs-params"><span class="hljs-params">||</span></span> (led_line2&amp;&amp;c2); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> d2/c2 assign led13 = (led_line1&amp;&amp;f2) <span class="hljs-params"><span class="hljs-params">||</span></span> (led_line2&amp;&amp;a2); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> f2/a2 assign led15 = (led_line1&amp;&amp;a3) <span class="hljs-params"><span class="hljs-params">||</span></span> (led_line2&amp;&amp;f3); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> a3/f3 assign led16 = (led_line1&amp;&amp;b3) <span class="hljs-params"><span class="hljs-params">||</span></span> (led_line2&amp;&amp;g3); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> b3/g3 assign led17 = (led_line1&amp;&amp;c3) <span class="hljs-params"><span class="hljs-params">||</span></span> (led_line2&amp;&amp;d3); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> c3/d3 assign led18 = (led_line1&amp;&amp;e4) <span class="hljs-params"><span class="hljs-params">||</span></span> ((led_line2)&amp;&amp;e3); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> e3/e4 !! assign led19 = (led_line1&amp;&amp;g4) <span class="hljs-params"><span class="hljs-params">||</span></span> ((led_line2)&amp;&amp;b4); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> g4/b4 assign led2<span class="hljs-number"><span class="hljs-number">0</span></span> = (led_line1&amp;&amp;d4) <span class="hljs-params"><span class="hljs-params">||</span></span> ((led_line2)&amp;&amp;c4); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> d4/c4 assign led21 = (led_line1&amp;&amp;f4) <span class="hljs-params"><span class="hljs-params">||</span></span> ((led_line2)&amp;&amp;a4); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> f4/a4</code> </pre> <br><h4>  <b>Fight for resources</b> </h4><br>  And here it turns out that there are not enough resources again!  In the process of fighting for resources, the following steps were taken: <br><br>  Altered the encoder from bcd to a seven-segment code.  Normal encoder converts numbers from 0 to 15 into hexadecimal format.  The clock uses a decimal system for display, so only numbers from 0 to 9 were left in the encoder, that is, the input is 4 bits and the output of 10 seven-bit words.  But for tens of minutes (from 0 to 5), a 3-bit encoder is sufficient.  That is, 6 options.  A similar picture for dozens of hours.  Only there are generally 3 digits - from 0 to 2. And this is already 2 bits for the input of the encoder and only 3 options for the output.  All of this probably should have reduced the complexity of the synthesis.  So it happened!  The number of cells used decreased from 63 to 59. <br><br>  Reduced the digit capacity of the registers of tens of minutes and hours.  This will reduce the number of cells by the number of bits, plus it will simplify the schemes of adders. <br><br><pre> <code class="hljs ruby">reg [<span class="hljs-number"><span class="hljs-number">6</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>] sec;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">119</span></span> - <span class="hljs-number"><span class="hljs-number">7</span></span>bit reg [<span class="hljs-number"><span class="hljs-number">3</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>] m ;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">9</span></span> - <span class="hljs-number"><span class="hljs-number">4</span></span>bit reg [<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>] mm ;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">5</span></span> - <span class="hljs-number"><span class="hljs-number">3</span></span>bit reg [<span class="hljs-number"><span class="hljs-number">3</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>] h ;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">9</span></span> - <span class="hljs-number"><span class="hljs-number">4</span></span>bit reg [<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>] hh ;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">2</span></span>bit</code> </pre> <br>  In total, at the start of the optimization, 63 out of 64 cells were occupied, which called into question the possibility of implementing not only possible additional functions, but also basic ones (such as setting the time).  Now 56 macrocells are occupied and 8 are free.  The percentage was 98%, it was 87%.  For such a small volume it is very good: about 10%! <br><br><h4>  <b>Time setting</b> </h4><br>  Now that the resources have become easier, let's set the time.  It was decided to make 3 buttons: "hours", "minutes", "seconds".  When you press and hold the "clock" button, their value should increase.  The same conditions for the "minutes" button.  It is easy to do this: we simply allow the new value to be written to the register at each tick if the button is pressed (and not only when the low-order overflows). <br><br>  When you press the "seconds" button - another logic: the second counter should be reset and the seconds count should be stopped. <br><br>  In order to make the time setting more comfortable, the speed of the increase had to be increased, and for this the frequency of the final clock generator was chosen not 1 Hz, but 2 Hz (I wrote about this above).  It also saved one cell on a frequency divider, which took one bit less. <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">input wire btn_HH, btn_MM, btn_SS; // , ,  wire timer_clk = clk_div[13]; always @(posedge timer_clk) begin sec </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">=</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">btn_SS</span></span></span></span><span class="xml"><span class="hljs-tag">) ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_sec</span></span></span></span><span class="xml"><span class="hljs-tag">; //</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reset</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">seconds</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec_cy</span></span></span></span><span class="xml"><span class="hljs-tag">)||(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">btn_MM</span></span></span></span><span class="xml"><span class="hljs-tag">) ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_m</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mm</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m_cy</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec_cy</span></span></span></span><span class="xml"><span class="hljs-tag">)||(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">btn_MM</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m_cy</span></span></span></span><span class="xml"><span class="hljs-tag">) ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_mm</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mm</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mm_cy</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">m_cy</span></span></span></span><span class="xml"><span class="hljs-tag">&amp;&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sec_cy</span></span></span></span><span class="xml"><span class="hljs-tag">)||(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">btn_HH</span></span></span></span><span class="xml"><span class="hljs-tag">) ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_h</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hh</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(h_cy&amp;mm_cy&amp;&amp;m_cy&amp;&amp;sec_cy)||(btn_HH&amp;&amp;h_cy)</span></span></span></span><span class="xml"><span class="hljs-tag"> ? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">next_hh</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hh</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span></span></span></span></code> </pre> <br>  As you can see, twice a second, we check for an overflow signal or a sign of pressing a button.  In both cases, hours or minutes increase.  And the seconds value is assigned a zero, while the "seconds" button is held down. <br><br><h4>  <b>Second indicator</b> </h4><br>  For the second indicator, we no longer have any bits from the register of the frequency divider 32768. Because the minimum frequency there is 2 Hz, and it is necessary to flash once a second.  But twice a second, the binary counter of seconds increases.  So just take the zero bit from this counter: <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">assign</span></span> led_second_tick = sec[<span class="hljs-number"><span class="hljs-number">0</span></span>];</code> </pre> <br><h4>  <b>Energy consumption and energy saving</b> </h4><br>  The release of cells allowed us to add functionality.  One idea is to make a power supply with a backup battery.  In the presence of the main power supply, the watch can work in full mode, and in case of switching to backup power supply, it can go into the economy mode: turn off the display and only do time counting. <br><br>  In order to determine the feasibility of this functionality, you need to determine the current in the normal mode and the current that the device will consume in the power saving mode.  You can roughly calculate that with a current of approximately 10 mA per segment and no more than 12 simultaneously operating segments, we only get from the display - 120 mA.  Plus FPGA itself consumes energy.  According to the documentation - it should be about 10 mA. <br><br>  Measurements indicate that the entire device consumes 125 mA.  This is close to the calculations.  I add additional conditions to logic and one more input signal.  This is a signal to put the device into an economical mode.  We will take the control signal from the power source, from the part of the circuit that receives energy from the network.  That the user saw that the device works, being in the economical mode, we will add a blinking second LED.  The frequency will be the same, but the filling is not 50%, as in normal mode, but we will make a very short flash.  To do this, take part of the bits from the counter-frequency divider.  On implementation of this logic only one cell left. <br><br><pre> <code class="hljs ruby">input wire btn_SAFE; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    wire SAFE_MODE = ~btn_SAFE; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-number"><span class="hljs-number">1</span></span>  ,   ,  /<span class="hljs-regexp"><span class="hljs-regexp">/   wire led_line1 = (clk_div[7])&amp;&amp;(SAFE_MODE==0); wire led_line2 = (~led_gnd1) &amp;&amp;(SAFE_MODE==0); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     assign led_second_tick = (sec[0]&amp;&amp;(!SAFE_MODE))||(sec[0]&amp;&amp;(clk_div[13:6]==10'd0)&amp;&amp;(SAFE_MODE));</span></span></code> </pre> <br>  The current in power saving mode was 18.5 mA.  In principle, it is not so little.  However, if you find an applied FPGA on the manufacturer's website, then it is classified there as "architectures to offer a SuperFast ‚Ñ¢ CPLD solution with low power".  Super fast is up to 400 MHz.  I suspect that such a current for the sake of speed.  But in the lineup there are slower and at the same time economical options: ispMACH 4064ZE, Operating Power Supply Current Vcc = 1.8V with a current of <a href="http://www.latticestore.com/products/tabid/417/categoryid/12/productid/360/searchid/1/default.aspx%3Fsearchvalue%3Dlc4064z*">80 microamps</a> . <br><br><h4>  <b>We complete the generator</b> </h4><br>  To create a generator, initially decided to try to use <a href="">logical elements of the FPGA</a> .  It would be very original and economical.  However, "something went wrong" and this option did not work.  And even on Cyclone, and even in the case of creating iron buffers.  I think, of course, you can make this scheme work by playing with the feedback parameters.  In general, you need to make an external generator.  Searched for schemes.  The selected transistor circuit worked, but the parameters of the received signal did not allow using it as a generator.  As a result, I decided to assemble a proven generator circuit - on a TTL chip.  But on the KR1533LA3 <a href="">this scheme</a> did not work.  As a result, a generator was launched based on this scheme: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9c6/520/fa7/9c6520fa7ad546a1878aa21f07cac086.gif"></div><br>  There remains one problem: the KR1533LA3 chip should work at a voltage of 5V + - 10%, that is, from 4.5 to 5.5, and the FPGA works from 3.3 volts.  However, the operation of the chip is essentially in analog mode.  I took a chance, launched from 3.3 volts - it works!  Put the clock to be like. <br><br>  An experiment on the run-down of the <s>rotor of the turbines of</s> the generator frequency showed that the clock was "running."  For three hours, it is already 20 seconds. When testing at the initial stage, Cyclone was used as a generator with a frequency division of 50 MHz.  At the same time, no tangible deviations were observed during the hours.  And then in 6 hours everything ‚Äúruns away‚Äù for 2-3 minutes!  Letting the clock down every day is unacceptable.  Therefore, I returned to the scheme <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4d4/b91/b18/4d4b91b187e6214b3e6ccf9e2f304e62.gif" alt="image"></div><br>  The analysis of such circuits suggested me that the type of the microcircuit has some meaning.  In all such schemes, CMOS is used, and in my case there was a TTL chip.  To test this hypothesis, I went to the store and purchased several chips of the 561st series.  Among them was the K561LA9 chip.  The study of the documentation showed that this chip can work on voltages in the range of 3..18 volts, which removes the question of the correctness of its power supply.  The scheme started immediately, but not at 32768 Hz, but at some higher harmonic.  The 100K resistor had to be increased to 300K.  Put the clock to be like.  For two days, the clock ran ahead for about 30 seconds.  This is also not small, but already better than +3 minutes in 6 hours.  Now you can pick up capacitors in the generator circuit for more installation more accurate course.  And think about how to build a frequency meter that can measure this frequency deviation.  Otherwise, the accuracy setting of the stroke may be delayed.  Using the FPGA Cyclone and the 50 MHz generator, I sketched a frequency meter with a measurement time of 1 and 10 seconds, I read the data using SignalTap.  In the generator put the capacitors on the power, picked up the capacitor and trimmer capacitor stroke frequency.  The frequency of the drove in 32768 plus minus measurement accuracy.  For the day of the course, visible to the eye deviations are not detected.  On this with all the generator. <br><br>  Reading MRB 1178 showed that with watch quartz, you can achieve an accuracy of up to 2 seconds per month.  I believe that such an accuracy value is quite enough for simple clocks. <br><br><h4>  <b>Power Supply</b> </h4><br>  According to the calculations and measurements, the device consumes quite a bit: 120 mA.  To power the device was originally planned from the mains 220 volts.  Therefore, high efficiency values ‚Äã‚Äãfrom the converter 220 -&gt; 3.3 volts - were not required.  At such currents, the linear stabilizer will lead to an increase in consumption, but at the same time it will provide excellent reliability, due to its simplicity.  In general, I agree that it is necessary to save energy and even picked up suitable components.  But we have a simple clock and I am ready to pay for the overuse of electricity. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b8e/456/8d9/b8e4568d93634ecfbd7c9afeb297b9f6.jpg"></div><br>  The signal that there is voltage in the network will be taken from the output of the stabilizer.  If it is not there - extinguish the indicators! <br><br><h4>  <b>Housing</b> </h4><br>  Corps chose small.  I had to try to fit everything in it.  Some racks for mounting the wrap had to bite.  The power supply will have to use an external one.  The buttons for setting the hours, minutes and reset of seconds are displayed on the case. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/c19/270/b83/c19270b83dec4760a614c58826ed89a4.jpg"></a> </div><br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/91e/6ef/3a7/91e6ef3a7e574880ad878d099af81f3f.jpg"></a> </div><br><br><h4>  <b>List of rakes collected</b> </h4><br><ol><li>  Proper nutrition.  At first, the FPGA was programmed, but after flashing and connecting the board with LEDs, problems started.  The programmer has stopped "seeing" and defining the chip.  The problem was solved by installing filtering capacitors along each power supply line of the microcircuit. </li><li>  Asynchronous logic.  Asynchronous reset counters are a typical solution for clocks on discrete counters.  The use of asynchronous logic on the FPGA is strongly discouraged due to the unpredictability of work.  Reliable solutions for FPGA - is a synchronous logic. </li><li>  Absence of automatic reset immediately after the FPGA firmware.  After programming, the microcircuit stops working for some time, and then it starts working again.  However, at the same time, apparently, the current values ‚Äã‚Äãof the triggers are not reset.  In this case, the clock begins to display on the screen some nonsense.  In some cases, it may seem that everything is normal.  This can be misleading and make you think that something is not so programmed.  No, just need to turn off and turn on the power of the chip, so that all registers are reset.  There is no reset input on the FPGA JTAG inputs, so an automatic reset after programming does not occur. </li><li>  No preset of register values.  When programming Lattice microcircuits, it is necessary to take into account that Initial constructions for registers will not be synthesized. ,        ,  initial   .             .     ,       N,     .   ,   ,         (  )   ‚Äî  . </li><li>    .     ,  ,    ,   ,    .      ‚Äî   .        .           .       ,     .      , ..   400 .          ‚Äî   315. , -            .       pull-up,    ?     ,      .    .     pull-down  .  ""      .    .  ‚Ä¶     <a href="http://we.easyelectronics.ru/warning_guano/flyus-gel-tt.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TT flux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !!!</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accuracy of hours. </font><font style="vertical-align: inherit;">The generator on an hour quartz + TTL microcircuit stably runs away for a day for 3 minutes. </font><font style="vertical-align: inherit;">A more accurate generator was able to make a CMOS chip. </font><font style="vertical-align: inherit;">In general, the question of designing quartz oscillators is very extensive, and is beyond the scope of the article. </font><font style="vertical-align: inherit;">See [6, 7, 8]</font></font></li></ol><br><h4>  <b>findings</b> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As a result of the work done, I came to the following positive conclusions: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lattice FPGAs and their development environment are quite suitable for work; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the use of universal HDL-languages, such as Verilog, allows you to change the FPGA manufacturer without any problems; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Most of the problems that I encountered while developing the project were not related to the fact that the basis of the project is the FPGA (except for the moments with reset after firmware and register initialization); </font></font></li><li>   ,  64...500 ,     ,     <em></em>  ,      <em></em>  ,    ; </li><li>  :    64     .  32       . ,     .       64   .  RTC ‚Äî    DS1302, DS1307, DS3231,    . ,  ,     GPS      LCD ,   ~240 [9]. </li></ul><br> <em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I had a great time studying the new FPGA, learned a lot of new things, attached a donated microcircuit, an LED screen and assembled a watch for the dacha. </font><font style="vertical-align: inherit;">I wish you interesting projects and great mood! </font></font></em> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The source code of the project on GitHub: </font></font><br> <a href="https://github.com/UA3MQJ/fpga_simple_clock"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/UA3MQJ/fpga_simple_clock</font></font></a> <br><br><h4>  <b>Links</b> </h4><br><ol><li> <a href="https://habrahabr.ru/post/125364/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FPGA clock with Quartus II and some Verilog</font></font></a> </li><li> <a href="http://icdevices.ru/fpga/clock_on_fpga.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FPGA Clock</font></font></a> </li><li> <a href="http://www.latticesemi.com/Products.aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lattice products</font></font></a> </li><li> <a href="http://we.easyelectronics.ru/warning_guano/flyus-gel-tt.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we.easyelectronics.ru - TT Flux-gel (Caution, shit!)</font></font></a> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MRB 1178. Electronic clock on MOS integrated circuits. </font><font style="vertical-align: inherit;">Right</font></font> allowance.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - M .: Radio and communication, 1993. - 48 p.: Il .- (Mass radio library; Issue. 1178). </font></font></li><li> <a href="http://digteh.ru/WLL/KvGen.php"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Features of quartz oscillator frequency stabilization</font></font></a> </li><li> <a href="http://www.vecon.ru/prompub/290/5/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quartz generators</font></font></a> </li><li> <a href="http://www.vecon.ru/prompub/290/5/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QUARTZ RESONATORS</font></font></a> </li><li> <a href="http://marsohod.org/projects/plata1/115-spaceclock"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Watch </font><font style="vertical-align: inherit;">GPS + LCD display WH0802</font></font></a> </li><li> <a href="https://habrahabr.ru/post/274843/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúStupid‚Äù watches on FPGA</font></font></a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/275863/">https://habr.com/ru/post/275863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275851/index.html">Explaining the inexplicable</a></li>
<li><a href="../275853/index.html">What is wrong with the security of the Internet of Things: How Shodan became a ‚Äúsearch engine for sleeping children‚Äù</a></li>
<li><a href="../275855/index.html">Introducing the free Wolfram Programming Lab for learning the Wolfram Language</a></li>
<li><a href="../275859/index.html">First steps in Xenko</a></li>
<li><a href="../275861/index.html">"Hello World!" In C array int main []</a></li>
<li><a href="../275865/index.html">Classes, sets, groups, systems</a></li>
<li><a href="../275867/index.html">Which countries and programming languages ‚Äã‚Äãare more likely to win the game for CodeBattle programmers?</a></li>
<li><a href="../275869/index.html">Congratulations to students on their professional holiday</a></li>
<li><a href="../275871/index.html">Applications in EDS. Part 3: Context-role model of the document, the rights and the optimal interface for working with documents</a></li>
<li><a href="../275873/index.html">AUTO_CLOSE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>