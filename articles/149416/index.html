<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Forwarding a video card in Xen, from under Ubuntu</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 Having read an article about a successful video card in a virtual machine, I decided that when I had two video adapters, I would do the s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Forwarding a video card in Xen, from under Ubuntu</h1><div class="post__text post__text-html js-mediator-article"><h3>  Prehistory </h3><br>  Having read an article about a <a href="http://habrahabr.ru/post/137327">successful video card</a> in a virtual machine, I decided that when I had two video adapters, I would do the same.  Once the second adapter appeared, and decided to play around with the <s>tambourine</s> video cards, it took half a day to study various documentation, but in the end everything grew together, so that all who are interested in learning how to repeat, and what happened - I invite you to the cat. <br><a name="habracut"></a><br><h3>  Hardware </h3><br>  ASRock 990FX Extreme3 ‚Äã‚Äãmotherboard <br>  AMD FX-8120 8x4.0 GHz processor <br>  RAM 2x4 GB 1600 MHz <br>  Video Card Gigabyte Radeon HD 5450 Silent 1024Mb 64bit <br>  HIS Radeon HD 6670 1GB GDDR5 Video Card <br>  SATA3 SSD for the main system <br>  USB 3.0 HDD for the machine into which we will forward the video card <br><br>  USB HDD because there is more space, and the speed of USB 3.0 is enough. <br><br><h3>  Software part </h3><br>  Ubuntu 12.10 x64 main system (kernel 3,6-rc1) <br>  We will forward in Windows 7/8 x64 - it does not matter, both were checked. <br>  Virtualization of the latest Xen 4.1, which is in the repository (this morning came an update that allows you to run Xen on processors with the architecture of Bulldozer, before that it was hopelessly falling at the start). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Training </h3><br>  I myself am a fan of the most simple examples, so I will be very brief and simple. <br>  And another note - the instruction is suitable for the AMD platform, for Intel there are some differences with hardware virtualization, since there is no corresponding hardware - I can not check it. <br><br>  First you need to look in the BIOS, the AMD 89x and AMD 99x chipsets must support <a href="https://secure.wikimedia.org/wikipedia/ru/wiki/IOMMU">IOMMU</a> , if there is such an option in the BIOS and it is disabled, be sure to turn it on, otherwise it will not work. <br><br>  Next, install Xen and the necessary components: <br><br><pre><code class="bash hljs">$ sudo apt-get install xen-hypervisor-4.1-amd64 xen-tools xenwatch qemu-utils qemu-common</code> </pre> <br>  It'll be enough. <br>  We will tweak the /etc/xen/xend-config.sxp configuration file in <i>order</i> for the network to work.  Uncomment the line: <br><br><pre>  # (network-script network-bridge) </pre><br>  Next you need to correct the kernel boot commands.  Open <i>/ etc / default / grub</i> , look for <i>GRUB_CMDLINE_LINUX</i> , bring it to the form: <br><br> <code>GRUB_CMDLINE_LINUX="max_loop=64 iommu=pt iommu=1 amd_iommu=fullflush xen-pciback.hide=(04:00.0)(04:00.1)"</code> <br>  Thus, we increase the number of LOOP devices, enable IOMMU support for AMD, and disable the second video card, reserving it for Windows. <br><br>  Read more about the video card.  You need to see where the card is inserted, for example, how it looks from me: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre>  $ lspci
 00: 00.0 Host bridge: Advanced Micro Devices [AMD] nee ATI RD890 PCI to PCI bridge (external gfx0 port B) (rev 02)
 00: 00.2 IOMMU: Advanced Micro Devices [AMD] nee ATI RD990 I / O Memory Management Unit (IOMMU)
 00: 02.0 PCI bridge: Advanced Micro Devices [AMD] nee ATI RD890 PCI to PCI bridge (PCI express gpp port B)
 00: 05.0 PCI bridge: Advanced Micro Devices [AMD] nee ATI RD890 PCI to PCI bridge (PCI express gpp port E)
 00: 0a.0 PCI bridge: Advanced Micro Devices [AMD] nee ATI RD890 PCI to PCI bridge (external gfx1 port A)
 00: 0b.0 PCI bridge: Advanced Micro Devices [AMD] nee ATI RD890 PCI to PCI bridge (NB-SB link)
 00: 11.0 SATA controller: Advanced Micro Devices [AMD] nee ATI SB7x0 / SB8x0 / SB9x0 SATA Controller [AHCI mode] (rev 40)
 00: 12.0 USB controller: Advanced Micro Devices [AMD] nee ATI SB7x0 / SB8x0 / SB9x0 USB OHCI0 Controller
 00: 12.2 USB controller: Advanced Micro Devices [AMD] nee ATI SB7x0 / SB8x0 / SB9x0 USB EHCI Controller
 00: 13.0 USB controller: Advanced Micro Devices [AMD] nee ATI SB7x0 / SB8x0 / SB9x0 USB OHCI0 Controller
 00: 13.2 USB controller: Advanced Micro Devices [AMD] nee ATI SB7x0 / SB8x0 / SB9x0 USB EHCI Controller
 00: 14.0 SMBus: Advanced Micro Devices [AMD] nee ATI SBx00 SMBus Controller (rev 42)
 00: 14.1 IDE interface: Advanced Micro Devices [AMD] nee ATI SB7x0 / SB8x0 / SB9x0 IDE Controller (rev 40)
 00: 14.2 Audio Device: Advanced Micro Devices [AMD] nee ATI SBx00 Azalia (Intel HDA) (rev 40)
 00: 14.3 ISA bridge: Advanced Micro Devices [AMD] nee ATI SB7x0 / SB8x0 / SB9x0 LPC host controller (rev 40)
 00: 14.4 PCI bridge: Advanced Micro Devices [AMD] nee ATI SBx00 PCI to PCI Bridge (rev 40)
 00: 14.5 USB controller: Advanced Micro Devices [AMD] nee ATI SB7x0 / SB8x0 / SB9x0 USB OHCI2 Controller
 00: 16.0 USB controller: Advanced Micro Devices [AMD] nee ATI SB7x0 / SB8x0 / SB9x0 USB OHCI0 Controller
 00: 16.2 USB controller: Advanced Micro Devices [AMD] nee ATI SB7x0 / SB8x0 / SB9x0 USB EHCI Controller
 00: 18.0 Host bridge: Advanced Micro Devices [AMD] Family 15h Processor Function 0
 00: 18.1 Host bridge: Advanced Micro Devices [AMD] Family 15h Processor Function 1
 00: 18.2 Host bridge: Advanced Micro Devices [AMD] Family 15h Processor Function 2
 00: 18.3 Host bridge: Advanced Micro Devices [AMD] Family 15h Processor Function 3
 00: 18.4 Host bridge: Advanced Micro Devices [AMD] Family 15h Processor Function 4
 00: 18.5 Host bridge: Advanced Micro Devices [AMD] Family 15h Processor Function 5
 01: 00.0 VGA compatible controller: Advanced Micro Devices [AMD] nee ATI Cedar PRO [Radeon HD 5450 / Radeon HD 6350]
 01: 00.1 Audio Device: Advanced Micro Devices [AMD] nee ATI Cedar HDMI Audio [Radeon HD 5400/6300 Series]
 02: 00.0 USB controller: Etron Technology, Inc.  EJ168 USB 3.0 Host Controller (rev 01)
 03: 00.0 Ethernet controller: Broadcom Corporation NetLink BCM57781 Gigabit Ethernet PCIe (rev 10)
 04: 00.0 VGA compatible controller: Advanced Micro Devices [AMD] nee ATI Turks [Radeon HD 6670]
 04: 00.1 Audio device: Advanced Micro Devices [AMD] nee ATI Turks / Whistler HDMI Audio [Radeon HD 6000 Series] </pre></div></div><br>  We are interested in the lines: <br><br><pre>  01: 00.0 VGA compatible controller: Advanced Micro Devices [AMD] nee ATI Cedar PRO [Radeon HD 5450 / Radeon HD 6350]
 01: 00.1 Audio Device: Advanced Micro Devices [AMD] nee ATI Cedar HDMI Audio [Radeon HD 5400/6300 Series]
 ...
 04: 00.0 VGA compatible controller: Advanced Micro Devices [AMD] nee ATI Turks [Radeon HD 6670]
 04: 00.1 Audio device: Advanced Micro Devices [AMD] nee ATI Turks / Whistler HDMI Audio [Radeon HD 6000 Series] </pre><br>  The first two correspond to the video card, which we leave Ubuntu, and the last two will give Windows.  Two - because the video card is visible as a video and audio device at the same time, so you need to carry / carry them together.  At the beginning of the line are the digits to be entered in the kernel boot options.  They will hide from Ubuntu a second video card. <br><br>  Actually, the preparation is completed if you have successfully booted by selecting the kernel from the ‚ÄúXen 4.1-amd64‚Äù subsection at boot time.  If you want the subsection to be the first in the list - rename the file. <br><br><pre>  /etc/grub.d/20_linux_xen </pre>  at <pre>  /etc/grub.d/09_linux_xen </pre><br><h3>  Install and configure a virtual machine </h3><br>  To install, you need a hard disk image.  Create: <br><br><pre> <code class="bash hljs">$ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/zero of=/media/Windows/HDD bs=1G count=90</code> </pre><br>  A 90 GB disk file will be created in the <i>/ media / Windows</i> directory, where the virtual machine will reside. <br><br>  Create the following configuration file config.cfg in the same directory: <br><blockquote>  kernel = "/usr/lib/xen-4.1/boot/hvmloader" <br>  builder = 'hvm' <br>  vif = ['type = ioemu, bridge = eth0, ip = assigned-ip, mac = 22: 61: 34: 00: 00: 01'] <br>  address = 'assigned-ip' <br>  netmask = '255.255.255.XXX' <br>  memory = 1024 <br>  shadow_memory = 8 <br>  name = "windows" <br>  cdrom = 'file: /media/Archive/Windows.iso' <br>  disk = ['file: / media / Windows / HDD, hdc, w', 'file: /media/Archive/Windows.iso,hdb: cdrom, r'] <br>  device_model = '/usr/lib/xen-4.1/bin/qemu-dm' <br><br>  # boot on floppy (a), hard disk ¬© or CD-ROM (d) <br>  # default: hard disk, cd-rom, floppy <br>  #### boot it must be dc to install windows <br>  boot = "dc" <br>  #boot = "c" <br><br>  vnc = 1 # use vnc to insall and setup windows after that you can disable this <br>  vncconsole = 0 <br>  vncpasswd = '' <br>  vncviewer = 1 <br>  vncunused = 1 <br>  vnclisten = '127.0.0.1' <br>  vcpus = 2 <br>  stdvga = 0 <br>  serial = 'pty' <br>  usbdevice = 'tablet' <br>  on_reboot = 'restart' <br>  on_crash = 'restart' <br><br>  #pci = ['04: 00.0', '04: 00.1'] <br></blockquote><br>  <i>/media/Archive/Windows.iso</i> - path to the image of the installation DVD with Windows <br>  <i>vnclisten = '127.0.0.1'</i> - we are listening to the local computer, from which we will enter the virtual machine <br>  <i>memory = 1024</i> - RAM for the machine in MB <br>  <i>vcpus = 2</i> - the number of processor cores <br>  <i>name = "windows"</i> - the name of the so-called domain of the virtual machine, it will be possible to distinguish it from the others. <br>  <i>pci = ['04: 00.0', '04: 00.1']</i> - we connect our reserved video card, but for now leave the line commented out <br><br>  We try to run, if we have something. <br><br><pre> <code class="bash hljs">$ sudo xm create /media/Windows/config.cfg Using config file <span class="hljs-string"><span class="hljs-string">"/media/Windows/config.cfg"</span></span>. Started domain windows (id=12)</code> </pre><br>  The output should be similar.  Let's look at all the operating systems running under the hypervisor: <br><br><pre>  $ sudo xm list
 Name ID Mem VCPUs State Time (s)
 Domain-0 0 7007 8 r ----- 6881.3
 windows 12 1024 2 -b ---- 32.1
</pre><br>  Connect to the machine via VNC, for example, through Remina, which is the default in the latest versions of Ubuntu. <br><br><img src="https://habrastorage.org/storage2/cc0/728/de9/cc0728de9a897af911f4a4455841250d.png"><br><br>  Save to save time in the future. <br>  Immediately after connecting, we see the Windows installer.  After a reboot, Remina may break the connection - just reconnect.  After installation (everything is banal), install fresh drivers for your video card, and turn off Windows. <br>  Edit the configuration file, uncomment the last line with the video card, start the virtual machine again.  If the picture is frozen, and on the second monitor (it is optimal to have two monitors at hand - one for each OS) for a long time there is nothing - do the reset: <br><br><pre> <code class="bash hljs">$ sudo xm reset windows</code> </pre><br>  And we start again, it should work. <br><br><img src="https://habrastorage.org/storage2/eb5/947/edd/eb5947edd3ed0bb209da4457b37d2521.png"><br><br>  There was no sound - in the same way he forwarded one of the usb hubs with a USB sound card - and it worked. <br>  Windows 8 did not want to check performance indices, while Windows 7 showed 7.1 for 3D and 7.1 for 2D.  Games, of course, work) <br><br> <a href=""><img src="https://habrastorage.org/storage2/0d3/64f/a1b/0d364fa1b70068229f96cc38eaa45ee1.png"></a> <br><br>  For convenience, you can save the domain of the virtual machine, and do not specify the path to the configuration permanently: <br><br><pre> <code class="bash hljs">$ sudo xm create /media/Windows/config.cfg $ sudo xm start windows $ sudo xm shutdown -w windows $ sudo xm start windows</code> </pre><br><br>  Sources of inspiration and information: <br>  <a href="http://help.ubuntu.ru/wiki/xen">http://help.ubuntu.ru/wiki/xen</a> <br>  <a href="http://umvirt.ru/node/69">http://umvirt.ru/node/69</a> <br>  <a href="http://www.virtualmin.com/documentation/cloudmin/windows">http://www.virtualmin.com/documentation/cloudmin/windows</a> <br>  <a href="http://wiki.prgmr.com/mediawiki/index.php/Appendix_B:_The_Structure_of_the_Xen_Config_File">http://wiki.prgmr.com/mediawiki/index.php/Appendix_B:_The_Structure_of_the_Xen_Config_File</a> <br><br>  <b>UPD:</b> <br>  I am writing from under Windows, put another assembly, she agreed to issue an assessment of the system: <br><br><img src="https://habrastorage.org/storage2/89d/c51/15f/89dc5115fb232e72e5a01770fca3f506.png"><br><br>  Gave the kernel and 2 GB of RAM. <br>  The system is empty, the drivers are stock (date on video driver 06/19/2012 version 8.97.10.6). </div><p>Source: <a href="https://habr.com/ru/post/149416/">https://habr.com/ru/post/149416/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149410/index.html">The growth of version numbers of popular browsers</a></li>
<li><a href="../149411/index.html">NASA Earthly Problems and Stupid YouTube Content ID</a></li>
<li><a href="../149412/index.html">Google lowers the sites of pirates in search results</a></li>
<li><a href="../149413/index.html">We put the CPU-Fan from LGA775 on socket 1155</a></li>
<li><a href="../149415/index.html">Now Google Translate for Android translates from photos</a></li>
<li><a href="../149417/index.html">Microsoft is already thinking about Windows 9 and choosing the name of the Windows 8 interface.</a></li>
<li><a href="../149418/index.html">Wi-Fi: unobvious nuances (for example, home Wi-Fi) [part 1]</a></li>
<li><a href="../149419/index.html">The digest of interesting news and materials from the world of ayti for the last week ‚Ññ17 (August 4 - 10, 2012)</a></li>
<li><a href="../149420/index.html">Learning to write multi-threaded and multi-process applications in Python</a></li>
<li><a href="../149421/index.html">RAID from USB flash drives</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>