<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microservice Architecture, Spring Cloud and Docker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. In this article, I will briefly discuss the details of the implementation of the microservice architecture using the tools provided by Sprin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microservice Architecture, Spring Cloud and Docker</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr.  In this article, I will briefly discuss the details of the implementation of the microservice architecture using the tools provided by Spring Cloud using the simple concept concept of the application as an example. </p><br><img src="https://habrastorage.org/files/718/f8d/522/718f8d5221eb4ccc8e7e102621d89988.png"><br><p>  The code is available for review <a href="http://github.com/sqshq/PiggyMetrics">on githaba</a> .  Images are published on dokhekhabe, the entire zoo starts as a team. <a name="habracut"></a><br><br>  I took the old forgotten project as a basis, the backend of which was a monolith.  The application allows you to organize personal finances: make regular incomes and expenses, keep track of savings, read statistics and forecasts. <br><br></p><br><img src="https://habrastorage.org/files/29a/231/da5/29a231da59384d2e8a03ea0214c848c5.gif">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Functional Services </h1><br><p>  Let's try to decompose the monolith into several basic microservices, each of which will be responsible for a specific business task. </p><br><div style="text-align:center;"><img width="880" src="https://habrastorage.org/files/cad/d35/87f/cadd3587f56b4cc38bb8cbcc2e743c09.png"></div><br><br><h3>  Account service </h3><br><p>  Implements logic and validation to preserve income, expenses, savings and account settings. </p><br><table><thead><tr><th>  Method </th><th>  Way </th><th>  Description </th><th>  User is authorized </th><th>  Available from UI </th></tr></thead><tbody><tr><td>  Get </td><td>  / accounts / {account} </td><td>  Get account details </td><td></td><td></td></tr><tr><td>  Get </td><td>  / accounts / current </td><td>  Get current account details </td><td>  √ó </td><td>  √ó </td></tr><tr><td>  Get </td><td>  / accounts / demo </td><td>  Get demo account details </td><td></td><td>  √ó </td></tr><tr><td>  PUT </td><td>  / accounts / current </td><td>  Save current account details </td><td>  √ó </td><td>  √ó </td></tr><tr><td>  POST </td><td>  / accounts / </td><td>  Register a new account </td><td></td><td>  √ó </td></tr></tbody></table><br><h3>  Statistics service </h3><br><p>  Calculates the basic statistical parameters of the account, brings their values ‚Äã‚Äãto the base currency and period, saves the data in a form convenient for subsequent analysis.  The obtained time series will be used to display statistics and indicators for the past time and extrapolation to the user for the simplest predictions for the future. </p><br><table><thead><tr><th>  Method </th><th>  Way </th><th>  Description </th><th>  User is authorized </th><th>  Available from UI </th></tr></thead><tbody><tr><td>  Get </td><td>  / statistics / {account} </td><td>  Get statistics for the specified account </td><td></td><td></td></tr><tr><td>  Get </td><td>  / statistics / current </td><td>  Get current account statistics </td><td>  √ó </td><td>  √ó </td></tr><tr><td>  Get </td><td>  / statistics / demo </td><td>  Get demo account statistics </td><td></td><td>  √ó </td></tr><tr><td>  PUT </td><td>  / statistics / {account} </td><td>  Create / update date point for <br>  specified account </td><td></td><td></td></tr></tbody></table><br><h3>  Notification service </h3><br><p>  Stores notification settings (frequency of reminders, frequency of backups).  According to the schedule, it sends out e-mail messages, pre-collecting and aggregating the necessary data from the first two services, if required. </p><br><table><thead><tr><th>  Method </th><th>  Way </th><th>  Description </th><th>  User is authorized </th><th>  Available from UI </th></tr></thead><tbody><tr><td>  Get </td><td>  / notifications / settings / current </td><td>  Get notification settings <br>  for current account </td><td>  √ó </td><td>  √ó </td></tr><tr><td>  PUT </td><td>  / notifications / settings / current </td><td>  Save notification settings <br>  for current account </td><td>  √ó </td><td>  √ó </td></tr></tbody></table><br><h4>  Notes </h4><br><ul><li>  All microservices have their own database, respectively, any data access can be obtained only through the application API. </li><li>  In this project, for simplicity, I used only MongoDB as the main database for each of the services.  In practice, it may be useful to use an approach called <a href="http://martinfowler.com/bliki/PolyglotPersistence.html">Polyglot persistence</a> ‚Äî choosing the storage that is most suitable for the tasks of a particular service. </li><li>  Communication between services is also significantly simplified: only synchronous rest-requests are used.  A common practice is to combine different modes of interaction.  For example, synchronous GET requests for information and asynchronous requests using a queue server for create / update operations.  Which, by the way, brings us into the world of <a href="http://martinfowler.com/articles/microservice-trade-offs.html">eventual consistency</a> - one of the important aspects of distributed systems that we have to live with. </li></ul><br><h1>  Infrastructure services </h1><br><p>  To ensure collaboration of the services described above, we will use a set of basic patterns and practices of Microservice architecture.  Many of them are implemented in <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> (in particular, through integration with <a href="https://github.com/Netflix">Netflix OSS</a> products) <a href="https://github.com/Netflix">‚Äîin</a> fact, these are dependencies that extend Spring Boot capabilities in one direction or another.  Below is a brief overview of each of the components. <br><br></p><br><div style="text-align:center;"><img width="880" src="https://habrastorage.org/files/b8b/6c0/2ef/b8b6c02ef49f4814b5d266f2580f9da7.png"></div><br><h2>  Config server </h2><br><p> <a href="http://cloud.spring.io/spring-cloud-config/spring-cloud-config.html">Spring Cloud Config</a> is a horizontally scalable configuration storage for a distributed system.  As a data source, Git, Subversion, and simple files stored locally are currently supported.  By default, Spring Cloud Config gives files that match the name of the application requesting Spring (but you can pick up properties for a specific Spring profile and from a specific branch of the version control system). <br><br>  In practice, loading configurations from version control systems is of most interest, but here for simplicity we will use local files.  Place the <code>shared</code> directory in the application class, which will store the configuration files for all applications in the cluster.  For example, if the Notification service requests a configuration, the Config server will respond to it with the contents of the file <code>shared/notification-service.yml</code> , combined with <code>shared/application.yml</code> (which is common to all). <br><br>  On the client side, no configuration files are now required, except for <code>bootstrap.yml</code> with the application name and the Config server address: <br><br></p><br><pre> <code class="hljs lua">spring: application: name: notification-service cloud: <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>: uri: http://<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>:<span class="hljs-number"><span class="hljs-number">8888</span></span> fail-fast: <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  Spring Cloud Config allows you to change your configuration dynamically.  For example, the <a href="">EmailService bean</a> , annotated with <code>@RefreshScope</code> , can start sending out the modified text of an e-mail message without reassembly. <br><br>  To do this, edit the Config server configuration file, and then execute the following request to the <code>Notification service</code> : </p><br><pre> <code class="bash hljs">`curl -H <span class="hljs-string"><span class="hljs-string">"Authorization: Bearer #token#"</span></span> -XPOST http://127.0.0.1:8000/notifications/refresh`</code> </pre> <br><p>  This process <a href="http://cloud.spring.io/spring-cloud-config/spring-cloud-config.html">can be automated by</a> using configuration downloads from version control systems by setting up a webbook from Github, Gitlub, or Bitbucket. <br><br>  Notes </p><br><ul><li>  Unfortunately, there are significant limitations on dynamic configuration updates.  <code>@RefreshScope</code> does not work for <code>@Configuration</code> classes and methods annotated with <code>@Scheduled</code> </li><li>  The <code>fail-fast</code> property, mentioned in <code>bootstrap.yml</code> means that the application will stop downloading immediately if there is no connection to the Config Server.  This is useful to us while simultaneously starting the entire infrastructure. </li><li>  Advanced security settings are beyond the scope of this concept proof application.  Spring Security provides ample opportunities for the implementation of security mechanisms.  Using the JCE keystore to encrypt microservice passwords and information in configuration files is <a href="http://cloud.spring.io/spring-cloud-config/spring-cloud-config.html">described in</a> detail <a href="http://cloud.spring.io/spring-cloud-config/spring-cloud-config.html">in the documentation</a> . </li></ul><br><br><h2>  Auth server </h2><br><p>  Responsibilities for authorization are completely taken out in a separate application that issues OAuth2 tokens for access to backend resources.  Auth server is used both for user authorization and for secure communication service within the perimeter. <br><br>  In fact, only one of the possible approaches is described here.  Spring Cloud and Spring Security allow you to quite flexibly configure the configuration for your needs (for example, it makes sense to authorize on the API Gateway side, and send a request with user data already filled in to the infrastructure). <br><br>  In this project, I use the <code>Password credential</code> grant type for user authorization and the <code>Client credentials</code> grant type for authorization between services. <br><br>  Spring Cloud Security provides convenient annotations and autoconfiguration, which makes it quite easy to implement the described functionality from both the client and the authorization server. <br><br>  On the client side, this is no different from traditional authorization using sessions.  From the request, you can get the <code>Principal</code> object, check roles and other parameters using the <code>@PreAuthorize</code> annotation. </p><br><p>  In addition, each OAuth2 application has a <code>scope</code> : <code>server</code> for backend services, <code>ui</code> for browser.  So we can restrict access to some endpoints from the outside: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@PreAuthorize</span></span>(<span class="hljs-string"><span class="hljs-string">"#oauth2.hasScope('server')"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(value = <span class="hljs-string"><span class="hljs-string">"accounts/{name}"</span></span>, method = RequestMethod.GET) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;DataPoint&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStatisticsByAccountName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> statisticsService.findByAccountName(name); }</code> </pre> <br><br><h2>  API Gateway </h2><br><p>  All three main services that we discussed above provide some API for the external user.  In industrial systems built on the Microservice architecture, the number of components is growing rapidly - <a href="http://highscalability.com/amazon-architecture">it</a> is <a href="http://highscalability.com/amazon-architecture">said</a> that about 150 services are involved in the rendering of the page in Amazon. <br><br>  Hypothetically, the client application could request each of the services independently.  But this approach immediately comes across a lot of restrictions - the need to know the address of each endpoint, to make a request for each piece of information separately and independently merge the result.  In addition, not all non-backend applications can support web-friendly protocols, and so forth. <br><br>  To solve this kind of problem, use API Gateway - a single entry point.  It is used to receive external requests and route to the necessary internal infrastructure services, the return of static content, authentication, stress testing, canary deployment, service migration, dynamic traffic management.  In Netflix, if a <a href="http://techblog.netflix.com/2013/01/optimizing-netflix-api.html">blog post is</a> about optimizing its API due to asynchronous aggregation of content from different microservices. <br><br>  Netflix has implemented its API Gateway - <a href="http://techblog.netflix.com/2013/06/announcing-zuul-edge-service-in-cloud.html">Zuul implementation</a> .  Spring Cloud is natively integrated with it and is enabled by adding one dependency and annotation <code>@EnableZuulProxy</code> to the Spring Boot application.  In this project, Zuul is used for the most basic tasks - returning statics (web application) and routing requests. <br><br>  An example of prefix routing for the Notification service: </p><br><pre> <code class="hljs lua">zuul: routes: notification-service: <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>: /notifications/** serviceId: notification-service stripPrefix: <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre><br><p>  Now every request whose uri starts with <code>/notifications</code> will be sent to the corresponding service. <br><br></p><br><h2>  Service discovery </h2><br><p>  Another widely known pattern for distributed systems.  Service discovery allows you to automatically determine network addresses for available application instances, which can be dynamically changed for reasons of scaling, crashes and updates. <br><br>  The key link here is the registry service.  In this project I use Netflix Eureka (but there is also Consul, Zookeeper, Etcd and others).  Eureka is an example of client-side discovery of a pattern, which means the client must request the addresses of the available instances and balance between them independently. <br><br>  To turn the Spring Boot application into the Registry server, just add a dependency on the <code>spring-cloud-starter-eureka-server</code> and the <code>@EnableEurekaServer</code> annotation.  On the client side, the <code>spring-cloud-starter-eureka</code> , the <code>@EnableDiscoveryClient</code> annotation and the application name (serviceId) in <code>bootstrap.yml</code> : </p><br><pre> <code class="hljs pgsql">spring: application: <span class="hljs-type"><span class="hljs-type">name</span></span>: notification-service</code> </pre> <br><p>  Now the application instance will be registered at Eureka at startup, providing meta-data (such as host, port, etc.).  Eureka will receive HARTBIT messages, and if they are not present during the configured time, the instance will be deleted from the registry.  In addition, Eureka provides dashboards on which registered applications with the number of instances and other technical information are visible: <code>http://localhost:8761</code> <br><br></p><br><img src="https://habrastorage.org/files/e14/31a/ecb/e1431aecb5c24f6cb130e5e04b498e9e.png"><br><br><h2>  Client balancer, Fuse and Http client </h2><br><p>  The following set of tools was also developed in Netflix and natively integrated into Spring Cloud.  All of them work together and are used in microservices that need to communicate with the outside world or the internal infrastructure. <br><br></p><br><h3>  Ribbon </h3><br><p>  Ribbon is a client-side balancer.  Compared to the traditional one, requests here go directly to the right address, which eliminates the extra node when calling.  Out of the box, it is integrated with the Service Discovery mechanism, which provides a dynamic list of available instances for balancing between them. <br><br></p><br><h3>  Hystrix </h3><br><p>  Hystrix is ‚Äã‚Äãthe implementation of the <a href="http://martinfowler.com/bliki/CircuitBreaker.html">Circuit Breaker</a> pattern - a fuse that gives control over delays and errors when making calls over the network.  The basic idea is to stop the cascade failure in a distributed system consisting of a large number of components.  This allows you to give an error as quickly as possible, without delaying the request to the hung service (letting it recover). <br><br>  In addition to controlling the opening of the circuit, Hystrix allows you to determine the fallback method that will be called when an unsuccessful call.  Thus, it is possible to give a default response, an error message, etc. <br><br>  For each request, Hystrix generates a set of metrics (such as execution speed, result), which allows analyzing the overall state of the system.  Below will be considered monitoring based on these metrics. <br><br></p><br><h3>  Feign </h3><br><p>  Feign is a simple and flexible http client that is natively integrated with Ribbon and Hystrix.  Simply put, having a <code>spring-cloud-starter-feign</code> and activating a client with the <code>@EnableFeignClients</code> annotation, you get a complete set of balancer, fuse and client, ready for battle with a reasonable default configuration. <br><br>  Here is an example from the Account Service: <br><br></p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@FeignClient</span></span>(name = <span class="hljs-string"><span class="hljs-string">"statistics-service"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatisticsServiceClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(method = RequestMethod.PUT, value = <span class="hljs-string"><span class="hljs-string">"/statistics/{accountName}"</span></span>, consumes = MediaType.APPLICATION_JSON_UTF8_VALUE) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateStatistics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"accountName"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String accountName, Account account)</span></span>; }</code> </pre> <br><br><ul><li>  All you need is to declare the interface. </li><li>  As usual, we simply specify the name of the service (thanks to the Service Discovery mechanism), but of course you can also refer to an arbitrary url. </li><li>  <code>@RequestMapping</code> along with the contents can be left unified for <code>@FeignClient</code> and <code>@Controller</code> in Spring MVC <br><br></li></ul><br><h2>  Dashboard </h2><br><p>  The metrics that Hystrix generates can be given out by including the <code>spring-boot-starter-actuator</code> dependency in the classspace.  Among other <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html">interesting things</a> , a special endpoint - <code>/hystrix.stream</code> will be set.  This stream can be visualized using the Hystrix dashboard, which we will discuss in detail below.  To enable Hystrix Dashboard, you need the <code>spring-cloud-starter-hystrix-dashboard</code> <code>@EnableHystrixDashboard</code> and the <code>@EnableHystrixDashboard</code> annotation.  Hystrix Dashboard can be set on a stream of any microservice to see a lively picture of what is happening in this particular service. <br><br>  However, in our case there are several services, and it would be great to see all their metrics in one place.  For this there is a special solution.  Each of our services will push its streams to AMQP broker (RabbitMQ), from where the stream aggregator, Turbine, will convert them, exposing a single endpoint for Hystrix Dashboard. <br><br>  Consider the behavior of the system under load: The Account service calls Statistics Service, and it responds with a varying simulation delay.  The request time threshold is set to 1 second. <br></p><br><img width="380" src="https://habrastorage.org/files/a7f/5c0/a59/a7f5c0a59ab149fa98db7b7818d80fb5.png"><br><table><thead><tr><th><img width="212" src="https://habrastorage.org/getpro/habr/post_images/3cd/79a/5a6/3cd79a5a64def54d0acb9fba3d00d6cc.gif"></th><th><img width="212" src="https://habrastorage.org/getpro/habr/post_images/c37/d13/696/c37d13696393f2b7813ec2e4baa0542c.gif"></th><th><img width="212" src="https://habrastorage.org/getpro/habr/post_images/372/08b/0a0/37208b0a0bd59d80fde2f43911bc46ad.gif"></th><th><img width="212" src="https://habrastorage.org/getpro/habr/post_images/c62/d5c/ade/c62d5caded572fd0de89d8724f0c4361.gif"></th></tr></thead><tbody><tr><td> <code> 0 </code> </td> <td> <code> 500 </code> </td> <td> <code> 800 </code> </td> <td> <code> 1100 </code> </td> </tr><tr><td>  The system works without errors.  Capacity about 22 s / s.  A small number of active threads in the Statistics service.  Average response time - <br>  50 ms </td><td>  The number of active threads increases.  The purple digit shows the number of rejected requests, respectively, of the order of 30-40% of errors, but the chain is still closed. </td><td>  Half-open state: the percentage of errors is more than 50%, the fuse opens the circuit.  After a certain timeout, the circuit closes, but not for long again. </td><td>  100% of requests with errors.  The circuit is constantly open, attempts to skip the request after a timeout change nothing - each individual request is too slow. </td></tr></tbody></table><br><br><h1>  Log Analysis </h1><br><p>  In an infrastructure consisting of a large number of moving parts (each of which can have several copies), it is very important to use a system of centralized collection, processing and analysis of logs.  Elasticsearch, Logstash and Kibana make up a stack, with which you can effectively solve this problem. <br><br>  The ELK Docker configuration ready for launch with a Curator and shipper templates <a href="https://github.com/sqshq/ELK-docker">is available on the github</a> .  It is this configuration, with a little customization and scaling, that works successfully in production on my current project for analyzing logs, network activity and monitoring server performance. <br><br> <a href="https://github.com/sqshq/ELK-docker"><img src="https://habrastorage.org/files/09f/684/2da/09f6842da1f14c4e862d0d6b80c4a24c.png"></a> <br>  <i>Picture from the official Elastic website, just for example</i> <br><br></p><br><h1>  Infrastructure Automation </h1><br><p>  Deploying a microservice system with a large number of moving parts and interconnectedness is obviously a more complex task than deploying a monolithic application.  Without an automated infrastructure, the whole story will turn into endless pain and waste of time.  This is a topic for a completely separate conversation, I will only show the simplest continuous delivery work implemented in this project on free versions of services: <br><br></p><br><img width="880" src="https://habrastorage.org/files/587/ab3/e5c/587ab3e5c89544ada99528178ee8e69f.png"><br><br><p>  The last stage is figuratively, there is no project for the project. <br>  To the root of the repository there is a <a href="">.travis.yml</a> file with instructions for the CI server - what to do after a successful build.  In this configuration, for every successful push in Github, Travis CI will collect docker images, tag them and launch them in the Docker Hub.  Now it turns out that we always have ready-to-deploy containers marked with the <code>latest</code> tag, as well as containers with old versions, versions from any branches. <br><br></p><br><h2>  Launch </h2><br><p>  If you've read this far, it may be interesting for you to do it yourself.  I want to note that the infrastructure consists of 8 Spring Boot applications, 4 MongoDB instances and one RabbitMQ.  Make sure that 3-4 GB of memory is available in the system.  You can always start to restrict yourself with the most necessary functionality - to abandon the Statistics service, Notification Service and Monitoring. <br><br></p><br><h4>  Before you start </h4><br><ul><li>  Install Docker and Docker Compose </li><li>  Export environment variables: <code>CONFIG_SERVICE_PASSWORD</code> , <code>NOTIFICATION_SERVICE_PASSWORD</code> , <code>STATISTICS_SERVICE_PASSWORD</code> , <code>ACCOUNT_SERVICE_PASSWORD</code> , <code>MONGODB_PASSWORD</code> </li></ul><br><h4>  Production mode </h4><br><p>  In this mode, all pre-compiled images are downloaded from the central repository (in this case, Docker Hub), ports are forwarded outside the docker only for API Gateway, Service Discovery, Monitoring and RabbitMQ management.  All you need is the docker-compose file and the <code>docker-compose up -d</code> . </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs mel">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> services: rabbitmq: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: rabbitmq:<span class="hljs-number"><span class="hljs-number">3</span></span>-management restart: always ports: - <span class="hljs-number"><span class="hljs-number">15672</span></span>:<span class="hljs-number"><span class="hljs-number">15672</span></span> logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> config: environment: CONFIG_SERVICE_PASSWORD: $CONFIG_SERVICE_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-config restart: always logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> registry: environment: CONFIG_SERVICE_PASSWORD: $CONFIG_SERVICE_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-registry restart: always ports: - <span class="hljs-number"><span class="hljs-number">8761</span></span>:<span class="hljs-number"><span class="hljs-number">8761</span></span> logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> gateway: environment: CONFIG_SERVICE_PASSWORD: $CONFIG_SERVICE_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-gateway restart: always ports: - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">4000</span></span> logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> auth-service: environment: CONFIG_SERVICE_PASSWORD: $CONFIG_SERVICE_PASSWORD NOTIFICATION_SERVICE_PASSWORD: $NOTIFICATION_SERVICE_PASSWORD STATISTICS_SERVICE_PASSWORD: $STATISTICS_SERVICE_PASSWORD ACCOUNT_SERVICE_PASSWORD: $ACCOUNT_SERVICE_PASSWORD MONGODB_PASSWORD: $MONGODB_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-auth-service restart: always logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> auth-mongodb: environment: MONGODB_PASSWORD: $MONGODB_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-mongodb restart: always logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> account-service: environment: CONFIG_SERVICE_PASSWORD: $CONFIG_SERVICE_PASSWORD ACCOUNT_SERVICE_PASSWORD: $ACCOUNT_SERVICE_PASSWORD MONGODB_PASSWORD: $MONGODB_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-account-service restart: always logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> account-mongodb: environment: INIT_DUMP: account-service-dump.js MONGODB_PASSWORD: $MONGODB_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-mongodb restart: always logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> statistics-service: environment: CONFIG_SERVICE_PASSWORD: $CONFIG_SERVICE_PASSWORD MONGODB_PASSWORD: $MONGODB_PASSWORD STATISTICS_SERVICE_PASSWORD: $STATISTICS_SERVICE_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-statistics-service restart: always logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> statistics-mongodb: environment: MONGODB_PASSWORD: $MONGODB_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-mongodb restart: always logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> notification-service: environment: CONFIG_SERVICE_PASSWORD: $CONFIG_SERVICE_PASSWORD MONGODB_PASSWORD: $MONGODB_PASSWORD NOTIFICATION_SERVICE_PASSWORD: $NOTIFICATION_SERVICE_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-notification-service restart: always logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> notification-mongodb: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-mongodb restart: always environment: MONGODB_PASSWORD: $MONGODB_PASSWORD logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span> monitoring: environment: CONFIG_SERVICE_PASSWORD: $CONFIG_SERVICE_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sqshq/piggymetrics-monitoring restart: always ports: - <span class="hljs-number"><span class="hljs-number">9000</span></span>:<span class="hljs-number"><span class="hljs-number">8080</span></span> - <span class="hljs-number"><span class="hljs-number">8989</span></span>:<span class="hljs-number"><span class="hljs-number">8989</span></span> logging: options: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-string"><span class="hljs-string">"10m"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span></code> </pre> </div></div><br><h4>  Development mode </h4><br><p>  In the development mode it is supposed to build images, and not to take them from the repository.  All containers are exposed outside for easy debug.  This configuration is inherited from the above, overwriting and extending the indicated points.  Run by <code>docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d</code> </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.dev.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'2'</span></span> services: rabbitmq: ports: - <span class="hljs-number"><span class="hljs-number">5672</span></span>:<span class="hljs-number"><span class="hljs-number">5672</span></span> config: build: config ports: - <span class="hljs-number"><span class="hljs-number">8888</span></span>:<span class="hljs-number"><span class="hljs-number">8888</span></span> registry: build: registry gateway: build: gateway auth-service: build: auth-service ports: - <span class="hljs-number"><span class="hljs-number">5000</span></span>:<span class="hljs-number"><span class="hljs-number">5000</span></span> auth-mongodb: build: mongodb ports: - <span class="hljs-number"><span class="hljs-number">25000</span></span>:<span class="hljs-number"><span class="hljs-number">27017</span></span> account-service: build: account-service ports: - <span class="hljs-number"><span class="hljs-number">6000</span></span>:<span class="hljs-number"><span class="hljs-number">6000</span></span> account-mongodb: build: mongodb ports: - <span class="hljs-number"><span class="hljs-number">26000</span></span>:<span class="hljs-number"><span class="hljs-number">27017</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statistics</span></span>-service: build: <span class="hljs-keyword"><span class="hljs-keyword">statistics</span></span>-service ports: - <span class="hljs-number"><span class="hljs-number">7000</span></span>:<span class="hljs-number"><span class="hljs-number">7000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statistics</span></span>-mongodb: build: mongodb ports: - <span class="hljs-number"><span class="hljs-number">27000</span></span>:<span class="hljs-number"><span class="hljs-number">27017</span></span> notification-service: build: notification-service ports: - <span class="hljs-number"><span class="hljs-number">8000</span></span>:<span class="hljs-number"><span class="hljs-number">8000</span></span> notification-mongodb: build: mongodb ports: - <span class="hljs-number"><span class="hljs-number">28000</span></span>:<span class="hljs-number"><span class="hljs-number">27017</span></span> monitoring: build: monitoring</code> </pre> </div></div><br><h4>  Notes </h4><br><p>  All Spring Boot applications in this project need an available Config Server to start.  Thanks to the <code>fail-fast</code> option in the <code>bootstrap.yml</code> each application and the restart option: always in the docker, the containers can be started simultaneously (they will automatically continue their attempts to start until the Config Server rises). <br><br>  The Service Discovery mechanism also takes some time to start full-fledged work.  The service is not available for a call, as long as he himself, Eureka and the client do not have the same meta-information locally - this requires 3 heartbeats.  By default, the time interval between Hartbits is 30 seconds. <br><br></p><br><h2>  Related Links </h2><br><ul><li>  <a href="http://martinfowler.com/articles/microservices.html">Articles on</a> Martin Fowler <a href="http://martinfowler.com/articles/microservices.html">microservices</a> </li><li>  Sam Neuman <a href="http://shop.oreilly.com/product/0636920033158.do">Building Microservices</a> - a book covering in detail all the basic concepts of microservice architecture </li><li>  A whole <a href="https://www.nginx.com/microservices-soa/">brochure</a> describing the differences between Microservices and SOA </li><li>  A series of <a href="https://www.nginx.com/blog/introduction-to-microservices/">articles on microservices</a> on the NGINX blog by Chris Richardson, founder of CloudFoundry </li><li>  Very cool and detailed report by Kirill Tolkachev <a href="https://habr.com/users/tolkkv/" class="user_link">tolkkv</a> and Alexander Tarasov <a href="https://habr.com/users/aatarasoff/" class="user_link">aatarasoff</a> from the Alpha Laboratory, in <a href="https://vk.com/videos-46597293%3Fsection%3Dall%26z%3Dvideo-46597293_171607640%252Fclub46597293%252Calbum-46597293%252Fpl_-46597293">two</a> <a href="https://vk.com/videos-46597293%3Fsection%3Dall%26z%3Dvideo-46597293_171607646%252Fclub46597293%252Calbum-46597293%252Fpl_-46597293">parts</a> .  On microservices, Spring Boot, Spring Cloud, tools Netflix OSS, Apache Thrift and much more. <br><br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/280786/">https://habr.com/ru/post/280786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280770/index.html">The digest of interesting materials for the mobile developer # 147 (March 28 - April 3)</a></li>
<li><a href="../280774/index.html">Behavior Analysis with Apache Spark</a></li>
<li><a href="../280776/index.html">IBM is working to strengthen information protection of "connected" cars</a></li>
<li><a href="../280782/index.html">Java programmer cheat sheet 8. Libraries for working with Json (Gson, Fastjson, LoganSquare, Jackson, JsonPath and others)</a></li>
<li><a href="../280784/index.html">Java Programmer Cheat Sheet 6. List of useful links for a Java programmer</a></li>
<li><a href="../280788/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ205 (March 28 - April 3, 2016)</a></li>
<li><a href="../280790/index.html">Installing Rust on Windows</a></li>
<li><a href="../280792/index.html">Delta Sync Crypto Drives</a></li>
<li><a href="../280794/index.html">Product Design Digest March 2016</a></li>
<li><a href="../280796/index.html">WPS Pixie Dust Attack - Hacking a Wi-Fi network in 5 minutes. Vulnerability description</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>