<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Approximate search methods for nearest neighbors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite often, programmers and experts in the field of data science are faced with the task of finding similar user profiles or selecting similar music....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Approximate search methods for nearest neighbors</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/59/d2/33/59d2336dddf63086290537.jpeg"></p><br><p>  Quite often, programmers and experts in the field of data science are faced with the task of finding similar user profiles or selecting similar music.  Solutions can be reduced to the transformation of objects into a vector shape and finding the closest ones. </p><br><p>  We also faced with the need to find the nearest neighbors in the problem of face recognition.  There we form vector representations of faces with the help of a neural network and look for the nearest vectors of already known people.  Initially, we chose Annoy for the search, as a well-known and proven algorithm, including that used in Spotify.  But we quickly realized that with his appetites from memory, we either do not fit in RAM, or we lose a lot of accuracy.  This led to a little research.  The results of which will be discussed below. </p><a name="habracut"></a><br><p>  To dilute theory with practice, the article will contain some code where we look for the nearest neighbors for words.  Get their vector representations using the popular word2vec.  This algorithm produces close vectors for semantically similar words.  In word2vec CBOW, vector representations are obtained as a by-product of learning a small neural network that predicts a word from its surroundings.  It is curious that with vectors it is possible to turn arithmetic operations like king + (woman - man) = queen. </p><br><p><img src="https://habrastorage.org/web/6e3/227/6d1/6e32276d15a64134a637990ba8f17f19.png" alt="word embeddings"></p><br><p>  Let's see how to work with this in the code. </p><br><pre><code class="python hljs">model = gensim.models.KeyedVectors.load_word2vec_format(<span class="hljs-string"><span class="hljs-string">'./GoogleNews-vectors-negative300.bin'</span></span>, binary=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) start = time.time() pprint.pprint(model.wv.most_similar(positive=[<span class="hljs-string"><span class="hljs-string">'king'</span></span>])) print(<span class="hljs-string"><span class="hljs-string">'time:'</span></span>, time.time() - start) print(<span class="hljs-string"><span class="hljs-string">'king + (woman - man) = '</span></span>, model.wv.most_similar(positive=[<span class="hljs-string"><span class="hljs-string">'woman'</span></span>, <span class="hljs-string"><span class="hljs-string">'king'</span></span>], negative=[<span class="hljs-string"><span class="hljs-string">'man'</span></span>])[<span class="hljs-number"><span class="hljs-number">0</span></span>]) print(<span class="hljs-string"><span class="hljs-string">'Japan + (Moscow - Russia) = '</span></span>, model.wv.most_similar(positive=[<span class="hljs-string"><span class="hljs-string">'Moscow'</span></span>, <span class="hljs-string"><span class="hljs-string">'Japan'</span></span>], negative=[<span class="hljs-string"><span class="hljs-string">'Russia'</span></span>])[<span class="hljs-number"><span class="hljs-number">0</span></span>])</code> </pre> <br><p>  We get: </p><br><pre> <code class="hljs python"> [(<span class="hljs-string"><span class="hljs-string">u'kings'</span></span>, <span class="hljs-number"><span class="hljs-number">0.7138045430183411</span></span>), (<span class="hljs-string"><span class="hljs-string">u'queen'</span></span>, <span class="hljs-number"><span class="hljs-number">0.6510956883430481</span></span>), (<span class="hljs-string"><span class="hljs-string">u'monarch'</span></span>, <span class="hljs-number"><span class="hljs-number">0.6413194537162781</span></span>), (<span class="hljs-string"><span class="hljs-string">u'crown_prince'</span></span>, <span class="hljs-number"><span class="hljs-number">0.6204219460487366</span></span>), (<span class="hljs-string"><span class="hljs-string">u'prince'</span></span>, <span class="hljs-number"><span class="hljs-number">0.6159993410110474</span></span>), (<span class="hljs-string"><span class="hljs-string">u'sultan'</span></span>, <span class="hljs-number"><span class="hljs-number">0.5864823460578918</span></span>), (<span class="hljs-string"><span class="hljs-string">u'ruler'</span></span>, <span class="hljs-number"><span class="hljs-number">0.5797567367553711</span></span>), (<span class="hljs-string"><span class="hljs-string">u'princes'</span></span>, <span class="hljs-number"><span class="hljs-number">0.5646552443504333</span></span>), (<span class="hljs-string"><span class="hljs-string">u'Prince_Paras'</span></span>, <span class="hljs-number"><span class="hljs-number">0.5432944297790527</span></span>), (<span class="hljs-string"><span class="hljs-string">u'throne'</span></span>, <span class="hljs-number"><span class="hljs-number">0.5422105193138123</span></span>)] time: <span class="hljs-number"><span class="hljs-number">0.236690998077</span></span> king + (woman - man) = (<span class="hljs-string"><span class="hljs-string">u'queen'</span></span>, <span class="hljs-number"><span class="hljs-number">0.7118192911148071</span></span>) Japan + (Moscow - Russia) = (<span class="hljs-string"><span class="hljs-string">u'Tokyo'</span></span>, <span class="hljs-number"><span class="hljs-number">0.8696038722991943</span></span>)</code> </pre> <br><p>  In the example above, a library was used to work with the text gensim and word2vec <a href="https://drive.google.com/file/d/0B7XkCwpI5KDYNlNUTTlSS21pQmM/edit%3Fusp%3Dsharing">model</a> (1.5 GB) from Google, which has 3 million words and short phrases.  The code output shows that queens, monarchs and princes are close to the king.  We also made sure that arithmetic with vectors works.  However, a quarter of a second per request is not very attractive, and in fact, in gensim, a relatively good implementation of bruteforce search (with calculation of distances to all known objects).  Next, we will look at methods that can reduce this time hundreds of times with only a small loss in accuracy. </p><br><p>  But let's start with a simple idea: let's try to narrow the search space by dividing it into two halves with a plane.  And during the search, we will consider distances only to those neighbors who were on the same side of the plane as the query. </p><br><pre> <code class="python hljs">nbrs = NearestNeighbors(algorithm=<span class="hljs-string"><span class="hljs-string">'brute'</span></span>, metric=<span class="hljs-string"><span class="hljs-string">'cosine'</span></span>) nbrs.fit(model.wv.syn0norm) king_vec = model.wv[<span class="hljs-string"><span class="hljs-string">'king'</span></span>][np.newaxis, :] <span class="hljs-comment"><span class="hljs-comment">#              start = time.time() idxs = nbrs.kneighbors(king_vec, return_distance=False, n_neighbors=10)[0] print('full search time:', time.time() - start) print([model.wv.index2word[idx] for idx in idxs]) #  2          vec1_idx = random.randint(0, model.wv.syn0norm.shape[0]) vec2_idx = random.randint(0, model.wv.syn0norm.shape[0]) plane = model.wv.syn0norm[vec1_idx] - model.wv.syn0norm[vec2_idx] #     -,   . #             scalar = model.wv.syn0norm.dot(np.transpose(plane)) #                   if king_vec.dot(plane) &gt; 0: mask = scalar &gt; 0 else: mask = scalar &lt; 0 print('elements in mask:', mask.sum()) half_nbrs = NearestNeighbors(algorithm='brute', metric='cosine') half_nbrs.fit(model.wv.syn0norm[mask]) half_index2word = list(compress(model.wv.index2word, mask)) start = time.time() idxs = half_nbrs.kneighbors(king_vec, return_distance=False, n_neighbors=10)[0] print('half search time:', time.time() - start) print([half_index2word[idx] for idx in idxs])</span></span></code> </pre> <br><p>  We get: </p><br><pre> <code class="hljs python"> full search time: <span class="hljs-number"><span class="hljs-number">20.3163180351</span></span> [<span class="hljs-string"><span class="hljs-string">u'king'</span></span>, <span class="hljs-string"><span class="hljs-string">u'kings'</span></span>, <span class="hljs-string"><span class="hljs-string">u'queen'</span></span>, <span class="hljs-string"><span class="hljs-string">u'monarch'</span></span>, <span class="hljs-string"><span class="hljs-string">u'crown_prince'</span></span>, <span class="hljs-string"><span class="hljs-string">u'prince'</span></span>, <span class="hljs-string"><span class="hljs-string">u'sultan'</span></span>, <span class="hljs-string"><span class="hljs-string">u'ruler'</span></span>, <span class="hljs-string"><span class="hljs-string">u'princes'</span></span>, <span class="hljs-string"><span class="hljs-string">u'Prince_Paras'</span></span>] elements <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> mask: <span class="hljs-number"><span class="hljs-number">1961204</span></span> half search time: <span class="hljs-number"><span class="hljs-number">9.15824007988</span></span> [<span class="hljs-string"><span class="hljs-string">u'king'</span></span>, <span class="hljs-string"><span class="hljs-string">u'kings'</span></span>, <span class="hljs-string"><span class="hljs-string">u'queen'</span></span>, <span class="hljs-string"><span class="hljs-string">u'monarch'</span></span>, <span class="hljs-string"><span class="hljs-string">u'crown_prince'</span></span>, <span class="hljs-string"><span class="hljs-string">u'prince'</span></span>, <span class="hljs-string"><span class="hljs-string">u'sultan'</span></span>, <span class="hljs-string"><span class="hljs-string">u'ruler'</span></span>, <span class="hljs-string"><span class="hljs-string">u'princes'</span></span>, <span class="hljs-string"><span class="hljs-string">u'Prince_Paras'</span></span>]</code> </pre> <br><p>  So we reduced the computation by half, losing only accuracy next to the plane.  Some of the algorithms that we look at next use similar tricks. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/fac/35b/079/fac35b0795c1451096316062d96ba4a2.png"></div><br><h2 id="1-hnsw">  1. HNSW </h2><br><p>  In 2011, one of the best search algorithms for the nearest neighbors of Navigable Small World (NSW) was published.  In 2016, his successor Hierarchical Navigable Small World (HNSW) appeared. </p><br><p>  Let's start with the parent NSW algorithm.  It is based on the ‚Äúsmall world‚Äù column.  These graphs have a curious and useful feature for us: a pair of vertices is not likely to be adjacent, but they can be achieved in a relatively small number of steps ( <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.581ex" height="2.419ex" viewBox="0 -780.1 2403 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6C" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6F" x="548" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-67" x="1034" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-4E" x="1514" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>g</mi><mrow class="MJX-TeXAtom-ORD"><mi>N</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-1"> \ log {N} </script>  average).  Such graphs are quite common.  For example, the brain's neural networks, groups in social networks and the WordNet semantic network are SW columns.  In our case, the vertices are vectors, and the edges connect them with the nearest.  The graph also presents edges connecting the vertices at a great distance. </p><br><p>  To search for neighbors, we go around the graph in search of vertices with the minimum distance to the query.  We start from a random vertex, count the distance from the unvisited vertices of the "friends" (vertices connected to the current edge) to the query, and go to the vertex with the smallest distance.  Long edges give the graph properties of the close world and allow you to quickly move to the area close to the request objects, and short - eagerly search for the nearest neighbors. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/bb7/6bc/891/bb76bc89159c4a12b105071367f76c57.png" title="NSW traverse"></div><br><p>  As we go round the graph, we update a small list of our nearest neighbors and stop if the list has not been updated at the next iteration. </p><br><div class="spoiler">  <b class="spoiler_title">Pseudocode</b> <div class="spoiler_text"><pre> <code class="hljs vhdl">K-NNSearch(object q, <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>: m, k) <span class="hljs-number"><span class="hljs-number">1</span></span> TreeSet [object] tempRes, candidates, visitedSet, result <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i‚Üê<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; m; i++) do: <span class="hljs-number"><span class="hljs-number">3</span></span> put random entry point <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> candidates <span class="hljs-number"><span class="hljs-number">4</span></span> tempRes‚Üê<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> repeat: <span class="hljs-number"><span class="hljs-number">6</span></span> get element c closest from candidates <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> q <span class="hljs-number"><span class="hljs-number">7</span></span> remove c from candidates <span class="hljs-number"><span class="hljs-number">8</span></span> //check stop condition: <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> further than k-th element from result <span class="hljs-number"><span class="hljs-number">10</span></span> than break repeat <span class="hljs-number"><span class="hljs-number">11</span></span> //update list <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> candidates: <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> every element e from friends <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> c do: <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> visitedSet than <span class="hljs-number"><span class="hljs-number">14</span></span> add e <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> visitedSet, candidates, tempRes <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> repeat <span class="hljs-number"><span class="hljs-number">17</span></span> //aggregate the results: <span class="hljs-number"><span class="hljs-number">18</span></span> add objects from tempRes <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> result <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> best k elements from result</code> </pre> </div></div><br><pre> <code class="python hljs">index = nmslib.init(space=<span class="hljs-string"><span class="hljs-string">'cosinesimil'</span></span>, method=<span class="hljs-string"><span class="hljs-string">'sw-graph'</span></span>) nmslib.addDataPointBatch(index, np.arange(model.wv.syn0.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>], dtype=np.int32), model.wv.syn0) index.createIndex({}, print_progress=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) start = time.time() items = nmslib.knnQuery(index, <span class="hljs-number"><span class="hljs-number">10</span></span>, king_vec.tolist()) print(time.time() - start) print([model.wv.index2word[idx] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> idx <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> items])</code> </pre> <br><p>  We get: </p><br><pre> <code class="hljs python"> <span class="hljs-number"><span class="hljs-number">0.000545024871826</span></span> [<span class="hljs-string"><span class="hljs-string">u'king'</span></span>, <span class="hljs-string"><span class="hljs-string">u'kings'</span></span>, <span class="hljs-string"><span class="hljs-string">u'queen'</span></span>, <span class="hljs-string"><span class="hljs-string">u'monarch'</span></span>, <span class="hljs-string"><span class="hljs-string">u'crown_prince'</span></span>, <span class="hljs-string"><span class="hljs-string">u'prince'</span></span>, <span class="hljs-string"><span class="hljs-string">u'sultan'</span></span>, <span class="hljs-string"><span class="hljs-string">u'ruler'</span></span>, <span class="hljs-string"><span class="hljs-string">u'princes'</span></span>, <span class="hljs-string"><span class="hljs-string">u'royal'</span></span>]</code> </pre> <br><p>  Consider the development of the idea described above in the Hierarchical Navigable Small World (HNSW) algorithm.  It is in many ways similar to NSW, but now we are dealing with a hierarchy of graphs: on the zero layer all objects are represented, and as the layer increases, their subsampling is less and less.  In this case, all the objects on the layer <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi><mo>+</mo><mn>1</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.398ex" height="2.057ex" viewBox="0 -728.2 2323.9 885.9" role="img" focusable="false" style="vertical-align: -0.366ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6E" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2B" x="822" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31" x="1823" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi><mo>+</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-2"> n + 1 </script>  there is on the layer <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.455ex" viewBox="0 -520.7 600.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6E" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-3"> n </script>  . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/6a0/19a/10e/6a019a10e3fd47359f68062ca9388586.png" title="HNSW traverse"></div><br><p>  When searching, a start occurs from a random vertex in the graph of the upper layer; there we quickly find vertices (candidates) close to the query and resume searching from them on the previous layer. </p><br><div class="spoiler">  <b class="spoiler_title">Pseudocode</b> <div class="spoiler_text"><pre> <code class="hljs sql">SearchAtLayer (object q, <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>] enterPoints, <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>: M, ef, layer) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>] visitedSet <span class="hljs-number"><span class="hljs-number">2</span></span> priority_queue [<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>] candidates (closer - <span class="hljs-keyword"><span class="hljs-keyword">first</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> (further - <span class="hljs-keyword"><span class="hljs-keyword">first</span></span>) <span class="hljs-number"><span class="hljs-number">3</span></span> candidates, visitedSet, <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> ‚Üê enterPoints <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> c =candidates.top() <span class="hljs-number"><span class="hljs-number">6</span></span> candidates.pop() <span class="hljs-number"><span class="hljs-number">7</span></span> //<span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> condition: <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> d(c,q)&gt;d(result.top(),q) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> break <span class="hljs-number"><span class="hljs-number">10</span></span> //<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> candidates: <span class="hljs-number"><span class="hljs-number">11</span></span> for_each <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> c.friends(layer) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> visitedSet <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> visitedSet <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> d(e, q)&lt; d(result.top(),q) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> result.size()&lt;ef <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> candidates, <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result.size()&gt;ef <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: <span class="hljs-number"><span class="hljs-number">17</span></span> result.pop() <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> best k elements <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> K-NNSearch (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">query</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>: ef) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>] tempRes, enterPoints=[enterpoint] <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=maxLayer downto <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> tempRes=SearchAtLayer (<span class="hljs-keyword"><span class="hljs-keyword">query</span></span>, enterPoints, M, <span class="hljs-number"><span class="hljs-number">1</span></span>, i) <span class="hljs-number"><span class="hljs-number">4</span></span> enterPoints =closest elements <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tempRes <span class="hljs-number"><span class="hljs-number">5</span></span> tempRes=SearchAtLayer (<span class="hljs-keyword"><span class="hljs-keyword">query</span></span>, enterPoints, M, ef, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> best K <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> tempRes</code> </pre> </div></div><br><h3 id="11-pros--cons">  1.1.  Pros &amp; Cons </h3><br><p>  + Algorithm is easy to understand. </p><br><p>  + It shows state-of-the-art results. </p><br><p>  + There is an effective implementation in the nmslib library. </p><br><p>  + Small additional memory costs for storing graph edges </p><br><p>  - The algorithm does not support the compression of vector representations, which we consider below </p><br><pre> <code class="python hljs">index = nmslib.init(space=<span class="hljs-string"><span class="hljs-string">'cosinesimil'</span></span>, method=<span class="hljs-string"><span class="hljs-string">'hnsw'</span></span>) nmslib.addDataPointBatch(index, np.arange(model.wv.syn0.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>], dtype=np.int32), model.wv.syn0) index.createIndex({}, print_progress=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) start = time.time() items = nmslib.knnQuery(index, <span class="hljs-number"><span class="hljs-number">10</span></span>, king_vec.tolist()) print(time.time() - start) print([model.wv.index2word[idx] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> idx <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> items])</code> </pre> <br><p>  We get: </p><br><pre> <code class="hljs python"> <span class="hljs-number"><span class="hljs-number">0.000469923019409</span></span> [<span class="hljs-string"><span class="hljs-string">u'king'</span></span>, <span class="hljs-string"><span class="hljs-string">u'kings'</span></span>, <span class="hljs-string"><span class="hljs-string">u'queen'</span></span>, <span class="hljs-string"><span class="hljs-string">u'monarch'</span></span>, <span class="hljs-string"><span class="hljs-string">u'crown_prince'</span></span>, <span class="hljs-string"><span class="hljs-string">u'prince'</span></span>, <span class="hljs-string"><span class="hljs-string">u'sultan'</span></span>, <span class="hljs-string"><span class="hljs-string">u'ruler'</span></span>, <span class="hljs-string"><span class="hljs-string">u'princes'</span></span>, <span class="hljs-string"><span class="hljs-string">u'Prince_Paras'</span></span>]</code> </pre> <br><h2 id="2-faiss">  2. FAISS </h2><br><p>  In March 2017, Facebook presented its solution for ANN - the <a href="https://github.com/facebookresearch/faiss">FAISS</a> library.  It combines many methods and algorithms.  In the algorithm, which we consider below, the distances to the groups of vectors will be approached by the distance to the reference point next to them.  So we can find out the distance from the request to a small number of reference points, and then brute-force to calculate the distance to the vectors belonging to the reference point, which is the closest to the request.  Let us analyze this algorithm in parts. </p><br><h3 id="21-adc--asymmetric-distance-computation">  2.1.  ADC - asymmetric distance computation </h3><br><p>  Let us consider the following idea in more detail: distances to groups of vectors can be approximated by distances to reference points near them.  Anchor points divide space into areas.  FAISS uses the well-known <a href="https://en.wikipedia.org/wiki/K-means_clustering">k-means</a> clustering algorithm to search for control points, and the resulting centroids are mapped to vectors. </p><br><pre> (0.1, 0.2) ‚Üí 1
 (0.5, -0.2) ‚Üí 2
 (0.1, 0.1) ‚Üí 1
 (0.6, -0.1) ‚Üí 2
</pre><br><p>  Collection vectors are approximated by their centroids. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>y</mi><mtext>&amp;#xA0;</mtext><mi>a</mi><mi>p</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><msub><mi>q</mi><mi>c</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>y</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.757ex" height="2.66ex" viewBox="0 -832 5923 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-61" x="747" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-70" x="1277" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-70" x="1780" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="2284" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6F" x="2735" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-78" x="3221" y="0"></use><g transform="translate(3793,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-63" x="631" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="4646" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="5036" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="5533" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>y</mi><mtext>&nbsp;</mtext><mi>a</mi><mi>p</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><msub><mi>q</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-4"> y \ approx q_c (y) </script>  where <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>q</mi><mi>c</mi></msub><mo>:</mo><mtext>&amp;#xA0;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>R</mi></mrow><mi>d</mi></msup><mtext>&amp;#xA0;</mtext><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi><msub><mi>C</mi><mn>1</mn></msub><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mtext>&amp;#xA0;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>R</mi></mrow><mi>d</mi></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="47.253ex" height="2.901ex" viewBox="0 -987.6 20344.8 1249" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-63" x="631" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-3A" x="1130" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6D" x="1937" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-61" x="2815" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-74" x="3345" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-68" x="3706" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-62" x="4283" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-62" x="4712" y="0"></use><g transform="translate(5142,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-52" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-64" x="1074" y="581"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="6621" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-69" x="7073" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-67" x="7418" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-68" x="7899" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-74" x="8475" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-61" x="8837" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="9366" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="9818" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6F" x="10269" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-77" x="10755" y="0"></use><g transform="translate(11471,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-43" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31" x="1011" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-73" x="12891" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-75" x="13360" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-62" x="13933" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-73" x="14362" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-65" x="14832" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-74" x="15298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6D" x="15910" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-61" x="16788" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-74" x="17318" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-68" x="17679" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-62" x="18256" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-62" x="18685" y="0"></use><g transform="translate(19115,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-52" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-64" x="1074" y="581"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>q</mi><mi>c</mi></msub><mo>:</mo><mtext>&nbsp;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><msup><mrow class="MJX-TeXAtom-ORD"><mi>R</mi></mrow><mi>d</mi></msup><mtext>&nbsp;</mtext><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi><msub><mi>C</mi><mn>1</mn></msub><mtext>&nbsp;</mtext><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>e</mi><mi>t</mi><mtext>&nbsp;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><msup><mrow class="MJX-TeXAtom-ORD"><mi>R</mi></mrow><mi>d</mi></msup></math></span></span><script type="math/tex" id="MathJax-Element-5"> q_c: \ mathbb {R} ^ d \ rightarrow C_1 \ subset \ mathbb {R} ^ d </script>  and <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>C</mi><mn>1</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.716ex" height="2.298ex" viewBox="0 -780.1 1169.4 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-43" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31" x="1011" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>C</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-6"> C_1 </script>  - A lot of centroids.  Then the distance from the query <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.455ex" viewBox="0 -520.7 572.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-78" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>x</mi></math></span></span><script type="math/tex" id="MathJax-Element-7"> x </script>  before <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>y</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.155ex" height="1.817ex" viewBox="0 -520.7 497.5 782.1" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>y</mi></math></span></span><script type="math/tex" id="MathJax-Element-8"> y </script>  can be approached <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>d</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy=&quot;false&quot;>)</mo><mtext>&amp;#xA0;</mtext><mi>a</mi><mi>p</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>d</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo>,</mo><msub><mi>q</mi><mi>c</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>y</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.534ex" height="2.66ex" viewBox="0 -832 10563.4 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-64" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="523" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-78" x="913" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2C" x="1485" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="1930" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="2428" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-61" x="3067" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-70" x="3597" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-70" x="4100" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="4604" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6F" x="5055" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-78" x="5541" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-64" x="6113" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="6637" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-78" x="7026" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2C" x="7599" y="0"></use><g transform="translate(8044,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-63" x="631" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="8897" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="9286" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="9784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="10173" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>d</mi><mo stretchy="false">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false">)</mo><mtext>&nbsp;</mtext><mi>a</mi><mi>p</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>d</mi><mo stretchy="false">(</mo><mi>x</mi><mo>,</mo><msub><mi>q</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-9"> d (x, y) \ approx d (x, q_c (y)) </script>  .  This method of calculating the distance is called asymmetric.  In simple words: we divided the space into regions and said that the distance from the query to a group of vectors falling into one region is approximately equal to the distance to the centroid that forms this region. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/d5a/593/cf5/d5a593cf5fe34146b3091822feb42fd4.png" title="ADC"></div><br><p>  Efficiently store and quickly get vectors belonging to the centroid, helps a simple trick called inverted file. </p><br><h3 id="22-ivf--inverted-file">  2.2.  IVF - inverted file </h3><br><p>  In IVF, we invert the assignment.  Now centroids are matched with lists of vectors. </p><br><pre> 1 ‚Üí [(0.1, 0.2), (0.1, 0.1)]
 2 ‚Üí [(0.5, -0.2), (0.6, -0.1)]
</pre><br><div style="text-align:center;"><img src="https://habrastorage.org/web/5b6/8dc/ffc/5b68dcffc06d42fd9989fe2b84775685.jpg"></div><br><p>  So we can quickly find candidates, considering the distance to the centroids, and then take a ready list for the nearest one. </p><br><h3 id="23-pq--product-quantizer">  2.3.  PQ - product quantizer </h3><br><p>  The last component that we touch on in the article is called the product quantizer.  It provides lossy vector compression and is used when vector representations do not fit into memory.  Suppose that our vectors have a dimension of 128 and we want to encode them with 64 bits (only 0.5 bits per component), then we will have to do quantization with the number of centroids equal to <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-10-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>=</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>64</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.348ex" height="2.419ex" viewBox="0 -935.7 3163.9 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-3D" x="799" y="0"></use><g transform="translate(1855,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-36"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-34" x="500" y="0"></use></g></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><mo>=</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>64</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-10"> k = 2 ^ {64} </script>  .  This is not a trivial task. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-11-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mi>k</mi><mi>n</mi><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.207ex" height="2.66ex" viewBox="0 -832 3533.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-69" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6B" x="1498" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6E" x="2020" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-64" x="2620" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="3144" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>i</mi><mi>k</mi><mi>n</mi><mi>d</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-11"> O (iknd) </script>  which also requires a huge training set. </p><br><p>  Simplify the task by breaking the vector into <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-12-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>m</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.04ex" height="1.455ex" viewBox="0 -520.7 878.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6D" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>m</mi></math></span></span><script type="math/tex" id="MathJax-Element-12"> m </script>  parts <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-13-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>y</mi><mn>1</mn></msub><mo>,</mo><msub><mi>y</mi><mn>2</mn></msub><mo>,</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>,</mo><msub><mi>y</mi><mi>m</mi></msub><mtext>&amp;#xA0;</mtext><mi>i</mi><mi>n</mi><mtext>&amp;#xA0;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>R</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>d</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>m</mi></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="29.328ex" height="3.021ex" viewBox="0 -1039.5 12627.3 1300.8" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31" x="693" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2C" x="944" y="0"></use><g transform="translate(1389,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32" x="693" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2C" x="2333" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2E" x="2779" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2E" x="3224" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2E" x="3669" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2C" x="4114" y="0"></use><g transform="translate(4559,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6D" x="693" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-69" x="6021" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6E" x="6367" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6D" x="7217" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-61" x="8096" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-74" x="8625" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-68" x="8987" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-62" x="9563" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-62" x="9993" y="0"></use><g transform="translate(10422,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-52" x="0" y="0"></use><g transform="translate(759,410)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2F" x="523" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6D" x="1024" y="0"></use></g></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>y</mi><mn>1</mn></msub><mo>,</mo><msub><mi>y</mi><mn>2</mn></msub><mo>,</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>,</mo><msub><mi>y</mi><mi>m</mi></msub><mtext>&nbsp;</mtext><mi>i</mi><mi>n</mi><mtext>&nbsp;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><msup><mrow class="MJX-TeXAtom-ORD"><mi>R</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>d</mi><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mi>m</mi></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-13"> y_1, y_2, ..., y_m \ in \ mathbb {R} ^ {d / m} </script>  , and by tradition we find 256 centroids for each of the parts.  That is, the vector can be rewritten as a set of centroid indices ‚Äî for example, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-14-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><mn>134</mn><mo>,</mo><mn>20</mn><mo>,</mo><mn>244</mn><mo>,</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>,</mo><mn>12</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.671ex" height="2.66ex" viewBox="0 -832 8900.2 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="0" y="0"></use><g transform="translate(389,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-33" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-34" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2C" x="1891" y="0"></use><g transform="translate(2336,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-30" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2C" x="3337" y="0"></use><g transform="translate(3782,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-34" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-34" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2C" x="5283" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2E" x="5729" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2E" x="6174" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2E" x="6619" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2C" x="7064" y="0"></use><g transform="translate(7509,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="8510" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">(</mo><mn>134</mn><mo>,</mo><mn>20</mn><mo>,</mo><mn>244</mn><mo>,</mo><mo>.</mo><mo>.</mo><mo>.</mo><mo>,</mo><mn>12</mn><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-14"> (134, 20, 244, ..., 12) </script>  , and occupies this economy <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-15-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>m</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.04ex" height="1.455ex" viewBox="0 -520.7 878.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6D" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>m</mi></math></span></span><script type="math/tex" id="MathJax-Element-15"> m </script>  byte. </p><br><p>  This kind of coding will be applied to residual vectors <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-16-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi><mo stretchy=&quot;false&quot;>(</mo><mi>y</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>y</mi><mo>&amp;#x2212;</mo><msub><mi>q</mi><mi>c</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>y</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.054ex" height="2.66ex" viewBox="0 -832 6912 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="451" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="841" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="1338" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-3D" x="2005" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="3062" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2212" x="3781" y="0"></use><g transform="translate(4782,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-63" x="631" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="5635" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="6025" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="6522" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>r</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mi>y</mi><mo>‚àí</mo><msub><mi>q</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-16"> r (y) = y - q_c (y) </script>  , <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-17-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi><mo stretchy=&quot;false&quot;>(</mo><mi>y</mi><mo stretchy=&quot;false&quot;>)</mo><mtext>&amp;#xA0;</mtext><mi>a</mi><mi>p</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><msub><mi>q</mi><mi>r</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>r</mi><mo stretchy=&quot;false&quot;>(</mo><mi>y</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="19.502ex" height="2.66ex" viewBox="0 -832 8396.8 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="451" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="841" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="1338" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-61" x="1978" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-70" x="2507" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-70" x="3011" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="3514" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6F" x="3966" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-78" x="4451" y="0"></use><g transform="translate(5024,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="631" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="5889" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="6279" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="6730" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="7120" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="7617" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="8007" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>r</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mtext>&nbsp;</mtext><mi>a</mi><mi>p</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><msub><mi>q</mi><mi>r</mi></msub><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-17"> r (y) \ approx q_r (r (y)) </script>  , and then <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-18-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>y</mi><mtext>&amp;#xA0;</mtext><mi>a</mi><mi>p</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><msub><mi>q</mi><mi>c</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>y</mi><mo stretchy=&quot;false&quot;>)</mo><mo>+</mo><msub><mi>q</mi><mi>r</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>y</mi><mo>&amp;#x2212;</mo><msub><mi>q</mi><mi>c</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>y</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="29.359ex" height="2.66ex" viewBox="0 -832 12640.7 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-61" x="747" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-70" x="1277" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-70" x="1780" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="2284" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6F" x="2735" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-78" x="3221" y="0"></use><g transform="translate(3793,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-63" x="631" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="4646" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="5036" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="5533" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2B" x="6145" y="0"></use><g transform="translate(7145,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-72" x="631" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="8011" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="8401" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2212" x="9120" y="0"></use><g transform="translate(10121,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-63" x="631" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-28" x="10974" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-79" x="11364" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="11861" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-29" x="12251" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>y</mi><mtext>&nbsp;</mtext><mi>a</mi><mi>p</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><msub><mi>q</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>q</mi><mi>r</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo>‚àí</mo><msub><mi>q</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-18"> y \ approx q_c (y) + q_r (y - q_c (y)) </script></p><br><h3 id="24-poisk">  2.4.  Search </h3><br><p>  And now we will collect all this in one scheme. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/a50/9af/834/a509af834e2e4de8ae1ea2a06aa5105d.jpg" title="IVFADCPQ"></div><br><p>  For request <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-19-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.455ex" viewBox="0 -520.7 572.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-78" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>x</mi></math></span></span><script type="math/tex" id="MathJax-Element-19"> x </script>  we find <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-20-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>w</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.664ex" height="1.455ex" viewBox="0 -520.7 716.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-77" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>w</mi></math></span></span><script type="math/tex" id="MathJax-Element-20"> w </script>  nearest centroids, collect lists of vectors corresponding to these centroids, and calculate distances to them using residual vectors, and then choose <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-21-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.211ex" height="2.057ex" viewBox="0 -780.1 521.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMATHI-6B" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi></math></span></span><script type="math/tex" id="MathJax-Element-21"> k </script>  closest. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> faiss index = faiss.index_factory(model.wv.syn0norm.shape[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'IVF16384,Flat'</span></span>) index.verbose = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> train = model.wv.syn0norm[np.random.binomial(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1.</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span>, size=model.wv.syn0norm.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>]).astype(bool)] index.train(train) index.add(model.wv.syn0norm) index.nprobe = <span class="hljs-number"><span class="hljs-number">100</span></span> start = time.time() distances, items = index.search(king_vec, <span class="hljs-number"><span class="hljs-number">10</span></span>) print(time.time() - start) print([model.wv.index2word[idx] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> idx <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> items[<span class="hljs-number"><span class="hljs-number">0</span></span>]])</code> </pre> <br><p>  We get: </p><br><pre> <code class="hljs python"> <span class="hljs-number"><span class="hljs-number">0.0048999786377</span></span> [<span class="hljs-string"><span class="hljs-string">u'king'</span></span>, <span class="hljs-string"><span class="hljs-string">u'kings'</span></span>, <span class="hljs-string"><span class="hljs-string">u'queen'</span></span>, <span class="hljs-string"><span class="hljs-string">u'monarch'</span></span>, <span class="hljs-string"><span class="hljs-string">u'crown_prince'</span></span>, <span class="hljs-string"><span class="hljs-string">u'prince'</span></span>, <span class="hljs-string"><span class="hljs-string">u'sultan'</span></span>, <span class="hljs-string"><span class="hljs-string">u'ruler'</span></span>, <span class="hljs-string"><span class="hljs-string">u'princes'</span></span>, <span class="hljs-string"><span class="hljs-string">u'Prince_Paras'</span></span>]</code> </pre> <br><h3 id="25-pros--cons">  2.5.  Pros &amp; Cons </h3><br><p>  + Compression support </p><br><p>  + Low storage overhead </p><br><p>  + GPU Calculation Capability * </p><br><p>  - Five times slower than HNSW on CPU </p><br><p>  * We could not quickly start a GPU implementation out of the box and decided not to waste time on it. </p><br><h2 id="3-annoy">  3. ANNOY </h2><br><p>  The idea of ‚Äã‚Äãdividing space by planes is well implemented in <a href="https://github.com/spotify/annoy">Annoy</a> .  The algorithm is beautifully described by the author in the <a href="https://erikbern.com/2015/10/01/nearest-neighbors-and-vector-models-part-2-how-to-search-in-high-dimensional-spaces.html">blog</a> , I recommend to read, if you want to understand the details.  I will try to summarize the essence.  In the algorithm, we recursively divide the space by planes, forming a binary tree.  In each node of the tree is stored the vector that defines the current plane.  When searching, we start from the root and select a child node based on the position of the query relative to the plane.  So we go down to the leafy elements of the tree, in which the vectors that are on the same side of a group of planes are stored (this is a small piece of space), they are very likely to be the desired nearest neighbors.  Let's look at the advantages and disadvantages of Annoy compared to other algorithms. </p><br><h3 id="31-pros--cons">  3.1.  Pros &amp; Cons </h3><br><p>  + Algorithm is easy to understand. </p><br><p>  - It requires a lot of memory </p><br><p>  - Loses in speed </p><br><h2 id="4-sravnenie-algoritmov">  4. Comparison of algorithms </h2><br><p>  Each of the algorithms has a set of parameters, whether it is the maximum number of friends for a vertex (in NSW, HNSW) or the number of centroids (in FAISS).  These parameters affect the amount of memory consumed, the quality and speed of the search.  The author Annoy implemented tests for a group of ANN algorithms in the <a href="https://github.com/erikbern/ann-benchmarks">ann-benchmarks</a> repository on various parameters.  They estimate the accuracy of the search for the ten nearest neighbors in datasets obtained using the GloVe and SIFT algorithms. </p><br><p>  GloVe is another way to get vector representations of words, it surpasses word2vec in all indicators when training on a body of the same size.  Dataset is composed of 1.2 million vector word representations, trained on 2 billion tweets.  <a href="https://en.wikipedia.org/wiki/Scale-invariant_feature_transform">SIFT</a> is an old algorithm for obtaining key points of an image and their vector representations that are resistant to transformations.  It was used for object recognition, and an important part of this recognition was the search for similar vector representations.  There are several variations of datasets, we are interested in SIFT 1M, containing a million vectors. </p><br><p>  Below are graphs reflecting the relationship between the speed of the algorithms and the accuracy of the search for the ten nearest neighbors.  Algorithms are represented by groups of points, each of the points is the start of a test on a set of parameters. </p><br><p><img src="https://habrastorage.org/web/c39/746/e91/c39746e918764579b369c31d8c7fe7c5.png" alt="glove"><br><img src="https://habrastorage.org/web/989/8b6/a08/9898b6a0887b443398448a098922763c.png" alt="sift"><br>  It is clear that HNSW is confidently leading.  However, there are no FAISS on the charts.  Facebook independently compared HNSW and FAISS in different configurations, the results are shown in the table. </p><br><table><thead><tr><th>  Method </th><th>  search time </th><th>  1-r @ 1 </th><th>  index size </th><th>  index build time </th></tr></thead><tbody><tr><td>  Flat-cpu </td><td>  9.100 s </td><td>  1.0000 </td><td>  512 MB </td><td>  0 s </td></tr><tr><td>  nmslib (hnsw) </td><td>  0.081 s </td><td>  0.8195 </td><td>  512 + 796 MB </td><td>  173 s </td></tr><tr><td>  IVF16384, Flat </td><td>  0.538 s </td><td>  0.8980 </td><td>  512 + 8 MB </td><td>  240 s </td></tr><tr><td>  IVF16384, Flat (Titan X) </td><td>  0.059 s </td><td>  0.8145 </td><td>  512 + 8 MB </td><td>  5 s </td></tr><tr><td>  Flat-GPU (Titan X) </td><td>  0.753 s </td><td>  0.9935 </td><td>  512 MB </td><td>  0 s </td></tr></tbody></table><br><p>  In the table, the FAISS methods are uncompressed, in particular <code>IVF16384,Flat</code> .  This means that IVFADC is used with 16,384 centroids.  Memory costs are indicated for the case with a million vectors of dimension 128 in float32.  HNSW is five times faster in computing on a CPU, but deposited on the edges of a graph ( <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-22-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>32</mn><mo>&amp;#x2217;</mo><mn>2</mn><mo>&amp;#x2217;</mo><mn>4</mn><mo>&amp;#x2217;</mo><mn>1000000</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><msup><mn>1024</mn><mn>2</mn></msup><mo>=</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>$</mo></mrow><mn>24</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="32.824ex" height="2.901ex" viewBox="0 -935.7 14132.3 1249" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-33"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2217" x="1223" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32" x="1945" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2217" x="2668" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-34" x="3391" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2217" x="4114" y="0"></use><g transform="translate(4836,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-30" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-30" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-30" x="2502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-30" x="3003" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2F" x="8340" y="0"></use><g transform="translate(8840,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-34" x="1501" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32" x="2831" y="572"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-3D" x="11574" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-24" x="12630" y="0"></use><g transform="translate(13131,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-34" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>32</mn><mo>‚àó</mo><mn>2</mn><mo>‚àó</mo><mn>4</mn><mo>‚àó</mo><mn>1000000</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><msup><mn>1024</mn><mn>2</mn></msup><mo>=</mo><mrow class="MJX-TeXAtom-ORD"><mo>$</mo></mrow><mn>24</mn></math></span></span><script type="math/tex" id="MathJax-Element-22"> 32 * 2 * 4 * 1000000/1024 ^ 2 = $ 24</script>  ) more memory required than centroids ( <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-23-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>16384</mn><mo>&amp;#x2217;</mo><mn>128</mn><mo>&amp;#x2217;</mo><mn>4</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><msup><mn>1024</mn><mn>2</mn></msup><mo>=</mo><mn>8</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="25.979ex" height="2.901ex" viewBox="0 -935.7 11185.4 1249" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-36" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-33" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-38" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-34" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2217" x="2724" y="0"></use><g transform="translate(3447,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-38" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2217" x="5171" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-34" x="5893" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-2F" x="6394" y="0"></use><g transform="translate(6894,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-34" x="1501" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-32" x="2831" y="572"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-3D" x="9628" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/338360/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgWr3eMLSu6FnipgEPZR-hPIKmWbA#MJMAIN-38" x="10684" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>16384</mn><mo>‚àó</mo><mn>128</mn><mo>‚àó</mo><mn>4</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><msup><mn>1024</mn><mn>2</mn></msup><mo>=</mo><mn>8</mn></math></span></span><script type="math/tex" id="MathJax-Element-23"> 16384 * 128 * 4/1024 ^ 2 = 8 </script>  ). </p><br><h2 id="5-zaklyuchenie">  5. Conclusion </h2><br><p>  We considered a number of algorithms used to quickly find the nearest neighbors.  Annoy lost both by memory and by speed, but the idea is good and can help in solving related problems.  For example, the isolation forest anomalies search algorithm, which is convenient for cleaning, is very similar in its idea.  FAISS is an excellent solution with memory limitations, it is quite possible to fit a billion vector representations into 60 GB of RAM with it, using IVF16384, PQ64.  However, if the memory is not a bottleneck, then you should choose HNSW. </p><br><p>  PS The most interesting were publications about algorithms in FAISS.  There, for example, you can read about optimizing for the GPU, about the improved quantization method (Optimized Product Quantization) and about a more clever way to build an index (inverted multi-index). </p><br><p>  PPS For ourselves, we have chosen HNSW. </p><br><h2 id="6-literatura">  6. Literature </h2><br><ul><li>  <a href="http://www.iiis.org/CDs2011/CD2011IDI/ICTA_2011/Abstract.asp%3Fmyurl%3DCT175ON.pdf">Approximate Nearest Neighbor Search Small World Approach</a> </li><li>  <a href="http://www.sciencedirect.com/science/article/pii/S0306437913001300">Algorithm based on navigable small world graphs</a> </li><li>  <a href="https://arxiv.org/pdf/1603.09320.pdf">Hierarchical Navigable Small World graphs</a> </li><li>  <a href="https://lear.inrialpes.fr/pubs/2011/JDS11/jegou_searching_with_quantization.pdf">Product quantization for nearest neighbor search</a> </li><li>  <a href="https://arxiv.org/pdf/1102.3828.pdf">SEARCHING IN ONE BILLION VECTORS: RE-RANK WITH SOURCE CODING</a> </li><li>  <a href="https://nlp.stanford.edu/pubs/glove.pdf">GloVe: Global Vectors for Word Representation</a> </li><li>  <a href="http://www.cs.ubc.ca/~lowe/papers/iccv99.pdf">Object Recognition from Local Scale-Invariant Features</a> </li><li>  <a href="https://cs.nju.edu.cn/zhouzh/zhouzh.files/publication/icdm08b.pdf">Isolation forest</a> </li><li>  <a href="https://arxiv.org/pdf/1702.08734.pdf">Billion-scale similarity search with GPUs</a> </li><li>  <a href="http://ieeexplore.ieee.org/abstract/document/6678503/">Optimized Product Quantization</a> </li><li>  <a href="http://ieeexplore.ieee.org/abstract/document/6248038/">The inverted multi-index</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/338360/">https://habr.com/ru/post/338360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338350/index.html">How I created a profitable global SaaS project, from design to sales</a></li>
<li><a href="../338352/index.html">Work with Talend Open Studio on the example of parsing a CSV file</a></li>
<li><a href="../338354/index.html">The category "Indie" appeared in the App Store. But it's not about that.</a></li>
<li><a href="../338356/index.html">The art of creating process diagrams</a></li>
<li><a href="../338358/index.html">Alien among his own: how to recruit to become part of the IT community</a></li>
<li><a href="../338362/index.html">Create an ‚Äúexternal outline‚Äù of an ecosystem with independent developers: the results of the Skyeng API contest</a></li>
<li><a href="../338366/index.html">ECMAScript 6. Regular expressions with Unicode support</a></li>
<li><a href="../338374/index.html">As I wrote a book on almost sotsinzhiniringu</a></li>
<li><a href="../338378/index.html">Computer forensics (forsensik): a selection of useful links</a></li>
<li><a href="../338380/index.html">Abstraction of the network layer using "strategies"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>