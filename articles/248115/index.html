<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The sound on the chip AY-3-8910 (or Yamaha YM2149F) comes from the ZX Spectrum on the PC via USB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About a year has passed since the successful connection of the YM2149F music synthesizer to the LPT port of the computer . LPT is nice, but time does ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The sound on the chip AY-3-8910 (or Yamaha YM2149F) comes from the ZX Spectrum on the PC via USB</h1><div class="post__text post__text-html js-mediator-article">  About a year has passed since the successful <a href="http://habrahabr.ru/post/218763/">connection of the YM2149F music synthesizer to the LPT port of the computer</a> .  LPT is nice, but time does not stand still, and finding a computer or laptop with an LPT port is becoming more and more difficult.  Yes, and the author himself (that is, I) got tired of climbing every time under the table where the sistemnik is standing, and poking the LPT board onto something else, for example, a programmer (I have a Willem LPT programmer, but not the point).  Therefore, this time we will connect the YM2149F chip to USB.  And of course, to meet the requirements of the era, we will do it on a penny old <b>PIC16F628</b> microcontroller. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ddf/e26/79f/ddfe2679f73a551a4d45e9d45b75e18e.jpg" alt="image"><br><br>  In short, YM2149F (or its functional analogue <a href="https://ru.wikipedia.org/wiki/AY-3-8910">AY-3-8910</a> ) is a three-part audio synthesizer chip, used in old computers like Atari ST, Amstrad CPC, ZX Spectrum, MSX and some others for playing music.  In Russia, the chip has gained a certain fame due to the installation in various clones of the ZX Spectrum.  During the procession of the ZX Spectrum in the former USSR, musicians have written thousands of melodies for this sound programmable generator.  And now you can completely find people who create music for this chip.  At the end of the article there will be links to a huge archive of chip tyuns for YM / AY for hundreds of hours of continuous listening. <br><a name="habracut"></a><br><h4>  Demo </h4><br>  Like last time, before the start, I immediately give a link to listen to the final result: <a href="https://soundcloud.com/tronix286">https://soundcloud.com/tronix286</a> The latest entries were made just from this device.  I recorded it as a player that writes a maximum of 128Kb / s MP3, so in reality the device sounds ‚Äúbrighter‚Äù.  But you can get a general idea of ‚Äã‚Äãthe sound. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Iron </h4><br>  Why such a weird choice of controller?  Why not AVR / ARM / iCore i7 / FTDI at the worst?  Partially the answer to this question is given at the beginning of the topic: retro synthesizer - retro microcontroller!  Moreover, AY-3-8910 and Microchip, one may say, have common roots.  In general, it was a series of strange circumstances.  Firstly, I stumbled across the Internet on a library that implements a software (software) USB 1.1 stack for PIC16F628 microcontrollers ‚Äî this is the library: <a href="http://code.google.com/p/16fusb/">16FUSB</a> .  Secondly, I had a couple of PIC16F628A lying and gathering dust for a long time, which I did not know where to go.  Thirdly, on the computer there was already configured software (MPLABX, MPASM) and there is a programmer for the PIC.  Well, unlike the <a href="https://ru.wikipedia.org/wiki/V-USB">V-USB</a> software stack on the AVR, known to many, there are few or even no projects on PICs without hardware USB.  And this means that historical injustice must be restored. <br><br>  Here is a typical wiring diagram from the 16fusb library site: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8c2/d9d/c64/8c2d9dc646b180b18ed29333ba89b8cc.png" alt="image"><br><br>  Included with the 16fusb library is a good example called ‚Äúdirect-io‚Äù.  The meaning is simple - send via USB bytes and it is ‚Äúdisplayed‚Äù on the eight legs of the microcontroller.  You can also send an additional two control signals, that is, two more bits (or two legs).  And in the opposite direction, that is, from the controller to the host (computer). <br><img src="https://habrastorage.org/getpro/habr/post_images/84b/333/9b5/84b3339b5ca265f8a8dc50c8bb2330a1.jpg" alt="image"><br><br>  The YM2149F is controlled using an eight-bit data bus D0-D7 and three control signals BC1, BDIR and RESET.  BC1 and BDIR control the selection of the register address and its value, as well as transfer the microchip to the inactive state.  The RESET signal is used to reset all registers to the original value.  Thus, reading from the PIC to the computer is not necessary;  only need the ability to send commands to YM.  And we need another third control signal, which means another MK leg. <br><br>  The following was done in its firmware for controlling the YM2149F specifically: <br><ul><li>  everything related to the reading of signals from the PIC to the host (computer) has been thrown out to increase the processing speed of USB requests; </li><li>  The state of the directions of the I / O ports is rigidly specified during the initialization of the MK and does not change in the procedures for issuing a byte to its feet. </li><li>  64 byte circular buffer is organized.  When decoding a request from a host, the bytes are added to the buffer.  When there is free time, data from the buffer is output to YM. </li><li>  optimized speed of issuing bytes per foot MK.  Partly due to the strictly specified I / O directions, partly due to the prominence of the previous state of the control bits. </li><li>  Fixed a bug with PIC looping through several thousand packets (deployed the RxLoop loop in the isr.asm file, instead of goto RxLoop, a check for the end of the packet is inserted) </li><li>  something else I don't remember </li></ul><br><br>  As mentioned above, there is a need for another control signal - RESET, and there are no free legs anymore.  Therefore, a quartz oscillator is used for clocking the PIC, and not a quartz, thereby releasing one leg of the MK (RA6) necessary to control the RESET signal.  The RA5 leg sticking in the air in this family only works as an input and cannot be used to control the output signal.  It would be possible to shift the functionality of catching the end of the USB package (EOP) from the RB2 leg, but this is not so simple - unlike the RB2 leg, the RA5 leg shares the functionality with MCLR and VPP for programming and the input is organized as a Schmitt trigger.  He just does not have enough voltage after the diodes to work.  On the other hand, for clocking the YM2149F assembled generator on the 74HC02 chip and 3.579545 MHz quartz.  It would be possible to try to use the second free half of the chip for assembling a similar generator and for the PIC, but two things stopped: 1) I don‚Äôt have 24 MHz quartz (and there was a quartz oscillator from some ancient mother) 2) I don‚Äôt know how 74HC02 will behave if it has different frequencies from ‚Äúdifferent sides‚Äù, and one of them is quite high (24 MHz is still a very large frequency).  Another option is how to free the RA6 leg for quartz: Signals BC1 and BDIR accept only such values: <br><br><pre><code class="bash hljs">BC1 BDIR 0 0 0 1 1 1</code> </pre> <br>  And never BC1 = 1, BDIR = 0. This can be used as a RESET by adding the NOT and NOR logic from the half of the 74HC02 chip and inverting the output signal using a transistor.  Of course, to issue BC = 1 and BDIR = 0 you need to tweak the firmware a little. <br><br>  And yet, the leg of RA4, which controls the BDIR signal, is open-collector, so you definitely need to pull it up to power - in the diagram it is a 10K resistor R5. <br><br><h4>  Soft </h4><br>  On the computer side, as the music player, an excellent cross-platform player chip tunes <a href="http://zxtune.bitbucket.org/">ZX Tune</a> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2fb/a36/626/2fba36626d702c3cbb7f6034843ee503.png" alt="image"><br><br>  It does not directly support USB, but if it finds one of the dlportio.dll / inpout32.dll / inpoutx64.dll libraries in its directory, it allows it to switch to the YM-LPT audio output settings ( <a href="http://habrahabr.ru/post/218763/">for the past project</a> ), and then use the __stdcall function void DlPortWritePortUchar (unsigned short port, unsigned char val);  for issuing bytes YM2149.  Port 0x378 data, Port 0x37a transmission of control signals (D1 - ~ BDIR, D2 - BC1, D3 - ~ RESET).  Thus, it is possible to write a small stub library with a single DlPortWritePortUchar function in which to redirect the byte output to a USB device, which was done.  I just took the source code of the <a href="http://www.highrez.co.uk/Downloads/InpOut32/">inpout32</a> library <a href="http://www.highrez.co.uk/Downloads/InpOut32/">as</a> a basis and wrote a stub function to redirect the output of bytes to this device.  As a result, it is enough to put this stub library <b>inpout32.dll</b> or <b>inpoutx64.dll</b> , depending on the player version used (x86 / x64), in the same directory as the <b>ZX Tune</b> player, run it and in the sound settings move the <b>aylpt</b> device to the top ( as in the screenshot above). <br><br><h4>  Download for free and without SMS </h4><br>  Drivers for Win XP, Win 7 (x32 / x64) can be downloaded here: <a href="">16FUSB_driver-libusb-win32-1.2.6.0.zip</a> <br><br>  Device layout: <a href="">ym-usb_scheme_1.0.rar</a> <br>  Compiled firmware (.hex) and compiled DLL stubs: <a href="">ym-usb_firmware_and_DLLs_v1.2.rar</a> <br>  Source codes of the firmware: <a href="">ym-usb_PIC16F628A_source_v1.2.rar</a> <br>  Source code of the stub library: <a href="">inpout32-64_DLL_source_v1.2.rar</a> <br>  General Instruments AY-3-8910 / 8912 Programmable Sound Generator (PSG) data Manual: <a href="">http://bulba.untergrund.net/AY-3-8910.rar</a> <br>  The topic on the forum ZX.PK.ru, from which the device was "born": <a href="http://zx-pk.ru/showthread.php%3Ft%3D22202">http://zx-pk.ru/showthread.php?t=22202</a> <br><br>  Huge archive of tracker music: <a href="http://www.exotica.org.uk/wiki/Modland">Modland</a> ( <a href="">FTP</a> ) <br>  ZX music online: <a href="http://zxtunes.com/">http://zxtunes.com/</a> <br><br>  All good! </div><p>Source: <a href="https://habr.com/ru/post/248115/">https://habr.com/ru/post/248115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248101/index.html">Simple bot for Skype on C ++ Qt (ActiveX)</a></li>
<li><a href="../248103/index.html">How to make QML friends with someone else's OpenGL context. Part II: Loading QML</a></li>
<li><a href="../248105/index.html">Internet test drive "Mechatronics and Robotics". Need help from the Community</a></li>
<li><a href="../248111/index.html">We write fast and economical JavaScript code</a></li>
<li><a href="../248113/index.html">Krita: Green coordinates or how to make a kangaroo from a dragon</a></li>
<li><a href="../248117/index.html">evalidate: secure processing of custom expressions</a></li>
<li><a href="../248119/index.html">3D to D</a></li>
<li><a href="../248121/index.html">Apple has blocked developer accounts in Crimea</a></li>
<li><a href="../248129/index.html">Art Feature Engineering in Machine Learning</a></li>
<li><a href="../248131/index.html">International isolation made Cuba an island of hackers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>