<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>One-page store on Phalcon PHP + AngularJS. Bug work</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Hello! Not so long ago, I wrote a publication ‚ÄúOne-page store with a basket on the Phalcon + AngularJS + Zurb Foundation‚Äù , which had a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>One-page store on Phalcon PHP + AngularJS. Bug work</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/161/b1b/36c/161b1b36cb354d1aac993ba0a66aef56.png" alt="image"><br><br><h5>  Introduction </h5><br>  Hello!  Not so long ago, I wrote a publication <a href="http://habrahabr.ru/post/245665/">‚ÄúOne-page store with a basket on the Phalcon + AngularJS + Zurb Foundation‚Äù</a> , which had an ambiguous effect to say the least.  Or rather, I received many negative comments, some were objective and constructive, some were not, and they made me think about why it happened, because I wanted to make a useful manual that would be useful to me and others who are starting to write on AngularJS. <br><br><h5>  Confession </h5><br>  Yes, the manual was useful for me, for me old, the one who was denied work in the local web studio in 2009, and to this day he has never worked in a team, has never worked in a hired job, but relied only for myself, and the main criterion for the effectiveness of project implementation was one - the main thing that works.  But this is me - old, after writing that article, and many comments, for the first time I decided to try to do everything according to the rules of good form, at least for the sake of interest. <br><a name="habracut"></a><br><h4>  <b>Bibliography</b> </h4><br>  Usually, the list of references is given at the end, but on the other hand, as the article is written, questions will arise as to why such an implementation was chosen.  And in order not to leave you without answers to your questions, I will indicate in brackets [?] The source from which it was taken.  So, here is the literature on which I relied, correcting my mistakes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Comments on the article <a href="http://habrahabr.ru/post/245665/">One-page store with a basket on the Phalcon + AngularJS + Zurb Foundation</a> </li><li>  <a href="http://habrahabr.ru/post/235873/">Bold AngularJS for Team Development [1/2]</a> </li><li>  <a href="http://habrahabr.ru/post/237279/">Bold AngularJS for team development [2/2]</a> </li><li>  <a href="http://mutablethought.com/2013/04/25/angular-js-ng-repeat-no-longer-allowing-duplicates/">angular js: ng-repeat no longer allowing duplicates</a> </li><li>  <a href="http://learn.ionicframework.com/formulas/localstorage/">Using local storage</a> </li><li>  <a href="http-not-sending-x-requested-with-header/">AngularJS $ http not sending X-Requested-With header</a> </li><li>  <a href="http://plnkr.co/edit/ZpkgRhEAoUGlnXjbLb8b%3Fp%3Dpreview">ngRoute preloader example</a> </li></ol><br><br><h4>  <b>Bug work</b> </h4><br><br>  In the course of the one-page food delivery project, the following shortcomings were unintentionally made: <br><br><ul><li>  Downloading all the products on one page at once using php </li><li>  The lack of a uniform style of writing code </li><li>  Using Logic in AngularJS Controllers <a href="http://habrahabr.ru/post/245665/">[1]</a> by <a href="https://habrahabr.ru/users/eugeneoz/" class="user_link">EugeneOZ</a> </li><li>  Storing the recycle bin in the js object, which was reset after reloading the page <a href="http://habrahabr.ru/post/245665/">[1]</a> by <a href="https://habrahabr.ru/users/hvostt/" class="user_link">hVostt</a> </li><li>  Adding to cart through the insertion of inline PHP scripts <a href="http://habrahabr.ru/post/245665/">[1]</a> from <a href="https://habrahabr.ru/users/steppefox/" class="user_link">steppefox</a> </li><li>  Responsiveness of the interface in the course of loading new categories </li></ul><br><br>  In this article I want to share how I was looking for a solution, and what came of it.  Now let's go through each item. <br><br><h4>  <b>Downloading all the products on one page at once using php</b> </h4><br>  The products in the store turned out to be slightly more than calculated, and considering our Kamchatka Internet, we calculated: <br>  100 products (images), each picture 100-300 kb, in the end, only the goods ate up the precious traffic of our clients in the amount of 10 mb, plus almost 10 mb weighed the site itself (pictures, styles, scripts).  Now I was able to optimize everything, and the site weighs 3.9 mb during the first download, and no more than 1 mb in the next, as the browser caches everything you need. <br><br>  This optimization was achieved by compressing large background images without losing quality, as well as sprites for icons and small graphics, as well as blocks that did not play an important role on the page (reviews, partners, certificates, why we open the reverse form) were removed. links replaced by jivosite).  All the same, the download speed for the site with food is much more important than our laurels and awards, which nobody needs. <br><br>  And of course, the optimization was due to the refusal to render all the goods on the page at once using php, and was replaced by ajax loading json data by clicking on the link like / #! / Menu / 7, but I finally had a chance to learn how angularjs routing works, to my shame, I had never worked with js routing before. <br><br>  And it turned out not as difficult as I expected, in fact I had only one route: <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">config</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$routeProvider, $locationProvider</span></span></span><span class="hljs-function">) </span></span>{ $routeProvider .when(<span class="hljs-string"><span class="hljs-string">'/menu/:id'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">templateUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'/app/views/products.html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">controller</span></span>: ProductsController}); $locationProvider.hashPrefix(<span class="hljs-string"><span class="hljs-string">'!'</span></span>); $locationProvider.html5Mode(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } angular.module(<span class="hljs-string"><span class="hljs-string">'rollShop'</span></span>).config(config);</code> </pre> <br><br>  He then loaded json data from the server and rendered it in a template: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"large-12 columns"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-view</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  In general, I heard that to index this approach, the server should return html instead of json, but then it is not clear how to avoid inline inserts of PHP scripts?  This question has remained a mystery to me.  And this approach has created another problem, if the user clicking on the link / #! / Menu / 7 presses the button ‚ÄúRefresh page‚Äù, then <s>his eyes will be filled with blood from the type of json data</s> he will see instead of the normal page just json data.  And here the Phalcon PHP Framework comes to help us, in fact, it was possible without him, but since I work with him, I do everything in his style.  To correct this error, I decided that I would give json data only with ajax requests, and with normal requests I will redirect the user via the link / #! / Menu / $ id. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">menuAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($id != <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;request-&gt;isAjax() == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   $category = Category::findFirst($id); //    $sub_category = Category::find("pid = '" . $id . "'"); if (count($sub_category) &gt; 0) { $products['category'] = $category-&gt;name; foreach ($sub_category as $key =&gt; $val) { $products['subcategory'][$key] = array( 'name' =&gt; $val-&gt;name, 'products' =&gt; Products::find("category = '" . $val-&gt;id . "'")-&gt;toArray() ); } } else { $products = array( 'category' =&gt; $category-&gt;name, 'products' =&gt; Products::find("category = '" . $category-&gt;id . "'")-&gt;toArray() ); } $this-&gt;response-&gt;setContent(json_encode($products)); return $this-&gt;response-&gt;send(); } else { $this-&gt;response-&gt;redirect('/#!/menu/' . $id); return false; } } else { return false; } }</span></span></code> </pre><br><br>  Check for AJAX request in Phalcon, using the condition: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;request-&gt;isAjax() == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//This is Ajax }</span></span></code> </pre><br><br>  But there is a problem, by default AngularJS does not send a special <b>X-Requested-With</b> header to the server [6], which means that without the help of AngularJS, this function will not work, so I had to add one line to the Angular script. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = angular.module(<span class="hljs-string"><span class="hljs-string">'rollShop'</span></span>, [<span class="hljs-string"><span class="hljs-string">'ngRoute'</span></span>, <span class="hljs-string"><span class="hljs-string">'mm.foundation'</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$httpProvider</span></span></span><span class="hljs-function">) </span></span>{ $httpProvider.defaults.headers.common[<span class="hljs-string"><span class="hljs-string">"X-Requested-With"</span></span>] = <span class="hljs-string"><span class="hljs-string">'XMLHttpRequest'</span></span>; }</code> </pre><br><br>  Now everything works, and the user will never see bare JSON. <br><br>  By the way, for indexing, I thought I could make a check on the bot, and give the bot pure html, without js code, without buttons, just the goods.  True, I don‚Äôt know if it will work or if it‚Äôs correct, can someone tell me in the comments. <br><br><h4>  <b>Add to cart through the insertion of inline PHP scripts</b> </h4><br>  Due to the correction of the previous bug, the bug was automatically corrected with the insertion of inline PHP scripts into the js function.  Let's compare how the goods were added to the cart before, and how it became now. <br><br>  <b>To (fu):</b> <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"add-cart"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"num&lt;?=$p['id']?&gt; value="</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span><span class="hljs-tag">" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">min</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">max</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"50"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"addCart(&lt;?=$p['id']?&gt;, num&lt;?=$p['id']?&gt;, '&lt;?=$p['title']?&gt;', &lt;?=$p['price']?&gt;)"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><pre> <code class="javascript hljs">$scope.addCart = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, num, title, price</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nums = num || <span class="hljs-number"><span class="hljs-number">1</span></span>; $scope.carts.push({ <span class="hljs-attr"><span class="hljs-attr">id</span></span> : id, <span class="hljs-attr"><span class="hljs-attr">num</span></span> : nums, <span class="hljs-attr"><span class="hljs-attr">title</span></span> : title, <span class="hljs-attr"><span class="hljs-attr">price</span></span> : price }); };</code> </pre><br><br>  <b>After:</b> <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"add-cart"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"item.quality"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">min</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">max</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"50"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"addCart(item)"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><pre> <code class="javascript hljs">$scope.addCart = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ CartsService.addCart(item); };</code> </pre><br><br>  Honestly, I like this approach much more, although the customer will not appreciate it, and will not pay more, but somehow it became proud of itself, and it was pleasant to my soul. <br><br><h4>  <b>The lack of a uniform style of writing code</b> </h4><br>  While correcting the previous two shortcomings, I automatically had to correct two more - ‚Äúuse of logic in controllers‚Äù, as you see, now the service does everything, and ‚Äúthe lack of a single style of writing code‚Äù. <br><br>  This is my eternal problem, but again, if you look from the point of view of economics, and the ‚Äúmost important thing - it works‚Äù approach, everything is quite effective here, not bothering with the style guides, I saved a lot of my time, and time, as you know, money.  By the way, the budgets of my clients range from 50 to 100 thousand rubles, and they don't care how the code is written.  But these are all excuses, because I want to correct the situation and make the code beautiful, readable and logical, in which two articles on Habr√© [2] and [3] helped me. <br><br>  As a result, I got 2 controllers, 3 factories, 1 view and one common app.js.  It looks like this now: <br><br><img src="https://habrastorage.org/files/c81/be3/e5a/c81be3e5aa6e4ac58117b95aa88b8359.png"><br><br>  Actually, as recommended to do in those stylgaydah.  And now let's look at the controllers, and can compare with the previous article. <br><br>  ProductsController.js <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductsController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$scope, $routeParams, ProductsService, CartsService</span></span></span><span class="hljs-function">) </span></span>{ $scope.items = <span class="hljs-string"><span class="hljs-string">''</span></span>; ProductsService.getData($routeParams.id).success(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">)</span></span>{ $scope.items = data; }); $scope.addCart = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ CartsService.addCart(item); }; } angular.module(<span class="hljs-string"><span class="hljs-string">'rollShop'</span></span>).controller(<span class="hljs-string"><span class="hljs-string">'ProductsController'</span></span>, ProductsController);</code> </pre><br><br>  CartsController.js <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CartController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$scope, CartsService</span></span></span><span class="hljs-function">) </span></span>{ $scope.carts = CartsService.getItemsCart(); $scope.total = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CartsService.summary($scope.delivery) }; $scope.removeItem = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">carts, item</span></span></span><span class="hljs-function">) </span></span>{ CartsService.removeItem(carts, item); }; } angular.module(<span class="hljs-string"><span class="hljs-string">'rollShop'</span></span>).controller(<span class="hljs-string"><span class="hljs-string">'CartController'</span></span>, CartController);</code> </pre><br><br>  Everything is cool, as it seems to me, even most like more than what was before, more precisely, what was happening earlier in my controllers. <br><br><h4>  <b>Storing the recycle bin in the js object, which was reset after reloading the page</b> </h4><br>  The next drawback, to which readers first of all paid attention, is the storage of the goods in the js object in the basket.  Why I chose this approach, I explained in the last article, because the store is one-page.  In any case, it is easy to implement storage in localStorage, and I think it will come in handy later. <br><br>  I started looking for a convenient module for AngularJS that would work with localStorage, but at the same time it should be simple and easy.  I found several implementation options, but they were complex and large in my opinion, unfortunately I don‚Äôt remember the links now, and then I came across the option that was just for me [5]. <br><br><pre> <code class="javascript hljs">angular.module(<span class="hljs-string"><span class="hljs-string">'ionic.utils'</span></span>, []) .factory(<span class="hljs-string"><span class="hljs-string">'$localstorage'</span></span>, [<span class="hljs-string"><span class="hljs-string">'$window'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$window</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">set</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, value</span></span></span><span class="hljs-function">) </span></span>{ $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.localStorage[key] = value; }, <span class="hljs-attr"><span class="hljs-attr">get</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, defaultValue</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.localStorage[key] || defaultValue; }, <span class="hljs-attr"><span class="hljs-attr">setObject</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, value</span></span></span><span class="hljs-function">) </span></span>{ $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.localStorage[key] = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(value); }, <span class="hljs-attr"><span class="hljs-attr">getObject</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse($<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.localStorage[key] || <span class="hljs-string"><span class="hljs-string">'{}'</span></span>); } } }]);</code> </pre><br><br>  True use of it in this form did not give 100% proper operation.  When adding one product to the cart, everything was fine, but as soon as the second different product or product from another category got there, ng-repeat stopped displaying the goods in the basket, and an <a href="https://docs.angularjs.org/error/ngRepeat/dupes%3Fp0%3Ditem%2520in%2520carts%26p1%3Dobject:6">error occurred</a> in the console: <br><br><blockquote>  Duplicates in a repeater are not allowed.  Use 'track by' expression to specify unique keys. </blockquote><br><br>  The solution to this error, I found in the source [4].  The problem was due to adding to the $$ hashKey array, I never figured out what it was, where it came from, and why, but I had to get rid of it so that everything worked, and the final version of the factory working with localStorage looks like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LocalStorageFactory</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$window</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">set</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, value</span></span></span><span class="hljs-function">) </span></span>{ $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.localStorage[key] = value; }, <span class="hljs-attr"><span class="hljs-attr">get</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, defaultValue</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.localStorage[key] || defaultValue; }, <span class="hljs-attr"><span class="hljs-attr">setObject</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, value</span></span></span><span class="hljs-function">) </span></span>{ $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.localStorage[key] = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(value, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, val</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (key == <span class="hljs-string"><span class="hljs-string">'$$hashKey'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val; }); }, <span class="hljs-attr"><span class="hljs-attr">getObject</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse($<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.localStorage[key] || <span class="hljs-string"><span class="hljs-string">'{}'</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">remove</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key</span></span></span><span class="hljs-function">)</span></span>{ $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.localStorage.removeItem(key); }, <span class="hljs-attr"><span class="hljs-attr">clear</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.localStorage.clear(); } } } angular.module(<span class="hljs-string"><span class="hljs-string">'rollShop'</span></span>).factory(<span class="hljs-string"><span class="hljs-string">'LocalStorageFactory'</span></span>, LocalStorageFactory);</code> </pre><br><br>  I think the code is small, and it will not be difficult to find 2 differences; checking for $$ hashKey helped me fix the duplicate error.  Now the basket service worked properly and well, remembering positions, recalculating the sum, etc.  I give the code below: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CartsService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LocalStorageFactory</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> CartsService = {}; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> CartData; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(LocalStorageFactory.getObject(<span class="hljs-string"><span class="hljs-string">'carts'</span></span>).length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { CartData = LocalStorageFactory.getObject(<span class="hljs-string"><span class="hljs-string">'carts'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CartData = []; } CartsService.addCart = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ CartData.push({ <span class="hljs-attr"><span class="hljs-attr">id</span></span>: item.id, <span class="hljs-attr"><span class="hljs-attr">num</span></span>: item.quality || <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">title</span></span>: item.title, <span class="hljs-attr"><span class="hljs-attr">price</span></span>: item.price }); CartsService.update(); }; CartsService.update = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(LocalStorageFactory.getObject(<span class="hljs-string"><span class="hljs-string">'carts'</span></span>).length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { LocalStorageFactory.remove(<span class="hljs-string"><span class="hljs-string">'carts'</span></span>); } LocalStorageFactory.setObject(<span class="hljs-string"><span class="hljs-string">'carts'</span></span>,CartData); }; CartsService.getItemsCart = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CartData; }; CartsService.removeItem = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">items, id</span></span></span><span class="hljs-function">) </span></span>{ items.splice(id, <span class="hljs-number"><span class="hljs-number">1</span></span>); CartsService.update(); }; CartsService.summary = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> total = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> delivery = <span class="hljs-number"><span class="hljs-number">0</span></span>; angular.forEach(CartsService.getItemsCart(), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ total += item.num * item.price; }); <span class="hljs-comment"><span class="hljs-comment">//      return total + delivery; }; return CartsService; } angular.module('rollShop').factory('CartsService', CartsService);</span></span></code> </pre><br><br>  Not perfect, but still better than it was. <br><br><h4>  <b>Responsiveness of the interface in the course of loading new categories</b> </h4><br>  JSON data coming from the server weighs no more than 10 kb, plus the server upload time, plus js response time, generally in the case of the great Kamchatka Internet with a huge ping, it makes sense to show the user a preloader on every request, and this is anyway good . <br><br>  Of course, this can be given to the controller, but I wanted a more universal solution, and again at the same time, a simple and easy one.  At first, I thought of using the nProgress lite plugin for AngularJS, but still decided to make it even easier, and found an example [7]. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$rootScope, $timeout</span></span></span><span class="hljs-function">) </span></span>{ $rootScope.layout = {}; $rootScope.layout.loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; $rootScope.$on(<span class="hljs-string"><span class="hljs-string">'$routeChangeStart'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $timeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ $rootScope.layout.loading = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }); }); $rootScope.$on(<span class="hljs-string"><span class="hljs-string">'$routeChangeSuccess'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $timeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ $rootScope.layout.loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }, <span class="hljs-number"><span class="hljs-number">500</span></span>); }); $rootScope.$on(<span class="hljs-string"><span class="hljs-string">'$routeChangeError'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $timeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ $rootScope.layout.loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }, <span class="hljs-number"><span class="hljs-number">500</span></span>); }); } angular.module(<span class="hljs-string"><span class="hljs-string">'rollShop'</span></span>).run(run);</code> </pre><br><br>  Now when one of the events comes (I think everything is clear from the name of the event), the preloader is shown / hiding. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"large-12 columns"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-hide</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!layout.loading"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  ,  gif ,    ,     --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Now the client will not click on the category 5 times, not knowing whether to load it or not. <br><br><h4>  <b>Conclusion</b> </h4><br>  I tried to correct the shortcomings made during the development, but the main goal was to accustom myself to the competent use of technology, even despite the lack of a command.  Honestly, I got a lot of pleasure, although I didn‚Äôt spend too much time working, and didn‚Äôt receive any compensation for it.  For myself, I concluded that I will do all subsequent projects with a more competent approach, because such an approach makes us appreciate not only the money received for the project, but also the knowledge and experience gained while working on it.  Experience and knowledge give pride in their work, improve the quality of work, love for what you do.  And all this will not leave you without money in your pocket. </div><p>Source: <a href="https://habr.com/ru/post/246733/">https://habr.com/ru/post/246733/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246721/index.html">DriverPack on the threshold of 2015: statistics</a></li>
<li><a href="../246723/index.html">Rzborda, or How to Make an Internet-Controlled Typewriter</a></li>
<li><a href="../246725/index.html">Brand management mistakes</a></li>
<li><a href="../246727/index.html">Massage and IT</a></li>
<li><a href="../246729/index.html">Earnings in the system of mobile motivation AppBonus. Organizational model of the platform and its use</a></li>
<li><a href="../246735/index.html">How an online store uses video to increase sales</a></li>
<li><a href="../246737/index.html">Play and control sounds in Unity 3D (Sound complete event, Play in edit mode)</a></li>
<li><a href="../246739/index.html">Product Design Digest, December 2014</a></li>
<li><a href="../246745/index.html">Top10 non-standard IT security events 2014</a></li>
<li><a href="../246747/index.html">Whence there is a complex number</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>