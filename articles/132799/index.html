<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Classic" friendly url in ASP.NET MVC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Speech in the topic will go about how to make links like www.site.com/helloworld in an ASP.NET MVC application. I hear outraged cries of ‚Äúwhy is this ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Classic" friendly url in ASP.NET MVC</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/892/d0f/66c/892d0f66ca82502f9972427d36e9d0c7.png" alt="image" align="right"><br>  Speech in the topic will go about how to make links like <a href="https://habr.com/ru/post/132799/">www.site.com/helloworld</a> in an ASP.NET MVC application.  I hear outraged cries of ‚Äúwhy is this necessary?‚Äù And ‚Äúwhy are you not comfortable with normal human routing?‚Äù And I have an answer for this. <br><br>  The fact is that our project moves to MVC with Web Forms, and contextual advertising has long been paid.  Routing is a wonderful thing, however, given that the site is not only about landing pages, we cannot tweak it so cleverly that the usual MVC / Controller / Action links and our incredibly friendly URLs continue to work.  The reason is simple: default routing ( <code>"{controller}/{action}/{id}", new { controller = "Default", action = "Index", id = UrlParameter.Optional }</code> ) assumes default values, therefore when accessing <a href="https://habr.com/ru/post/132799/">www.site.com/helloworld</a> will try to throw us on the helloworld controller in the Action Index. <br>  Sadness <br>  Have to do something.  Moreover, the option of creating a controller for each link clearly does not suit us - their darkness, and in general this is pornography, right? <br><br>  We will go another way.  ¬© <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Concept </h4><br>  We will hang the handler on the routing, which will check the reference to the frugality - for this we use regular expressions. <br>  If the link MVC-shnaya - just continue without making any extra gestures. <br>  If the link does not look like a typical MVC link, we will try to look for a correspondence in the database - which controller and action to use. <br>  If we don‚Äôt find anything, we‚Äôll try to use standard routing and default values.  Here already 404, so 404. <br><br><br><h4>  Model </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/d4e/4dd/07d/d4e4dd07d24d30f8e4cdd25881bf8c6d.png" alt="image"><br><br>  That's so simple and straightforward.  ContentID is a foreign key here, but if you want, you can use VARCHAR (MAX) and write content right here.  We have such an implementation due to the fact that the content is divided into pieces (the main content, title, meta tag description ...) - SEO, you know. <br><br><br><h4>  Implementation </h4><br>  The basis of the implementation is this: <br><pre> <code class="cs hljs">routes.MapRoute( <span class="hljs-string"><span class="hljs-string">"Default"</span></span>, <span class="hljs-string"><span class="hljs-string">"{controller}/{action}/{id}"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { controller = <span class="hljs-string"><span class="hljs-string">"Default"</span></span>, action = <span class="hljs-string"><span class="hljs-string">"Index"</span></span>, id = UrlParameter.Optional } ).RouteHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FriendlyUrlRouteHandler();</code> </pre><br>  We attach a handler (the successor of MvcRouteHandler) to our router, which handles ready-made values.  That is, first the routing mechanism will deal with the link, fill in the default values, then we will enter into the case and, if necessary, replace the values ‚Äã‚Äãwith ours. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FriendlyUrlRouteHandler</span></span> : <span class="hljs-title"><span class="hljs-title">MvcRouteHandler</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Regex TypicalLink = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex(<span class="hljs-string"><span class="hljs-string">"^.+/.+(/.*)?"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> IHttpHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHttpHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestContext requestContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Path  www.site.com/helloworld?id=1   /helloworld //      var url = requestContext.HttpContext.Request.Path.TrimStart('/'); if (!string.IsNullOrEmpty(url) &amp;&amp; !TypicalLink.IsMatch(url)) { PageItem page = RedirectManager.GetPageByFriendlyUrl(url); if (page != null) { FillRequest(page.ControllerName, page.ActionName ?? "GetStatic", page.ID.ToString(), requestContext); } } return base.GetHttpHandler(requestContext); } /// &lt;summary&gt;  request-   ,    &lt;/summary&gt; private static void FillRequest(string controller, string action, string id, RequestContext requestContext) { if (requestContext == null) { throw new ArgumentNullException("requestContext"); } requestContext.RouteData.Values["controller"] = controller; requestContext.RouteData.Values["action"] = action; requestContext.RouteData.Values["id"] = id; } }</span></span></code> </pre><br><br>  I use the record ID as a parameter, and when loading the page I use a view that consists of a join of several tables.  If you do not need such problems, you can simply pass as a ContentID parameter, rather than the id of the entire entry. <br><br>  The default action is GetStatic, which is defined as virtual in our base class for controllers.  In a specific controller, it takes the text of the page from the database, and generates a page, taking into account the features and layouts of the section. <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BaseController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public virtual ActionResult GetStatic(int id) { return HttpNotFound(); } }</span></span></code> </pre><br><br>  And finally the redirect mechanism itself.  Frankly, I do not remember why I took it to a separate class.  On the other hand, why not. <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RedirectManager</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> PageItem </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPageByFriendlyUrl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> friendlyUrl</span></span></span><span class="hljs-function">)</span></span> { PageItem page = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlCommand()) { cmd.Connection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnection(<span class="hljs-comment"><span class="hljs-comment">/*YourConnectionString*/</span></span>); cmd.CommandText = <span class="hljs-string"><span class="hljs-string">"select * from FriendlyUrl where FriendlyUrl = @FriendlyUrl"</span></span>; cmd.Parameters.Add(<span class="hljs-string"><span class="hljs-string">"@FriendlyUrl"</span></span>, SqlDbType.NVarChar).Value = friendlyUrl.TrimEnd(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); cmd.Connection.Open(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reader = cmd.ExecuteReader(CommandBehavior.CloseConnection)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reader.Read()) { page = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PageItem { ID = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) reader[<span class="hljs-string"><span class="hljs-string">"Id"</span></span>], ControllerName = (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) reader[<span class="hljs-string"><span class="hljs-string">"ControllerName"</span></span>], ActionName = (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) reader[<span class="hljs-string"><span class="hljs-string">"ActionName"</span></span>], FriendlyUrl = (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) reader[<span class="hljs-string"><span class="hljs-string">"FriendlyUrl"</span></span>], }; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> page; } } }</code> </pre><br><br><br><h4>  Result </h4><br>  In the end, we got exactly what we wanted.  After filling in the database, we earned a redirect to the correct pages, and nothing changes in the address bar, and we get 200 OK without additional dancings. <br><br>  Of course, the situation is quite atypical - in most cases, standard routing is more than enough: you can make a controller, for example, Static, which also takes data from the database from a URL.  But if contextual advertising has already been paid for, or there is simply a wild desire to make links in which not a single extra slash, the described version, in my opinion, is very useful. <br><br>  In the end, we set the task, and successfully coped with it. <br>  In my opinion, this is good. </div><p>Source: <a href="https://habr.com/ru/post/132799/">https://habr.com/ru/post/132799/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132793/index.html">New free online courses from Stanford</a></li>
<li><a href="../132794/index.html">Five ways to speed up Facebook API requests in practice</a></li>
<li><a href="../132795/index.html">Another ardent greetings to the masters of the pirate</a></li>
<li><a href="../132796/index.html">Introducing Evernote Clearly: reading from the screen is now convenient</a></li>
<li><a href="../132798/index.html">Quality Monitor - Increase Development Pleasure</a></li>
<li><a href="../132800/index.html">Fakeroot, XCode and PackageMaker</a></li>
<li><a href="../132801/index.html">BrandMaker at Commerzbank - working with corporate style</a></li>
<li><a href="../132802/index.html">Personal messages in MODx Revolution</a></li>
<li><a href="../132803/index.html">In Sheremetyevo via Skype</a></li>
<li><a href="../132804/index.html">Questions for Nikon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>