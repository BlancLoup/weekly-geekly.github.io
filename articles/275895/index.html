<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Can Kingdom and Reliable Systems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, you can read about the High Level Protocol - Can Kingdom , which in turn lies on top of ISO 11898 CAN . The article will consist of t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Can Kingdom and Reliable Systems</h1><div class="post__text post__text-html js-mediator-article">  In this article, you can read about the High Level Protocol - <b>Can Kingdom</b> , which in turn lies on top of <b>ISO 11898 CAN</b> .  The article will consist of two parts: <br><br>  1. Can Kingdom and reliable systems (general concepts, examples) <br>  2. Assembled system with Can Kingdom.  A kingdom without a king. <br><br>  A lot can be found about CAN Open materials in any language, this is due to the widespread use of this protocol, but CAN Kingdom is simpler at some points (both in implementation and in understanding).  In this article I wanted to share with you as well as general information about CAN Kingdom (I did not find anything in Russian on the Internet), as well as an example of the system I collected based on it. <br><a name="habracut"></a><br><h4>  Part 1 </h4><br><h5>  Introduction </h5><br>  ISO 11898 CAN is a low-level protocol.  Any system requires a high level protocol that will make it as reliable as possible.  Of course, the reliability of the system depends on the devices it contains, as well as on the situations arising from it.  For example, the hydraulic oil of the sawmill overheats.  If it moves on a flat hard surface, the obvious solution to the problem is simply to stop, but if the car drives over marshy ground, then stopping will cause it to start sucking into the ground.  Or another example, a plane can safely turn off engines if it is on the ground, but not in the air.  It is obvious that you can easily bring many more examples, such as propellers, processes, automated production, etc., all these systems are suitable for using the CAN protocol, but have very specific limitations and requirements for a high-level protocol.  CAN Kingdom is designed to solve this problem, giving the system developer the opportunity to optimize the high-level protocol of his system, while still using the standard product. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Four fundamental fundamentals of CAN Kingdom: <br><br><ul><li>  Clear separation between module and system level </li><li>  Any relationships in the system are predefined. </li><li>  Provision of ‚Äúbuilding blocks‚Äù for customization of high level protocol </li><li>  Postpone the decision as far as possible </li></ul><br>  The separation between the module and the system level is the key to system reliability.  Separation can be made based on the fact that any relationships in the system are predetermined.  Relationship determination is the heart of the system.  Any module that interacts with another does this according to a well-thought-out set of rules developed by a system developer. <br>  CAN Kingdom allows you to do this using the "building blocks" that are in each module.  This system architecture gives me the opportunity to rule anytime, even during direct work.  This is reminiscent of an ancient kingdom: the King makes laws for his kingdom, and the Mayors of each of the cities monitor their local implementation.  Mayors are solely responsible to the king, who controls their loyalty.  The king may change laws from time to time to maintain the stability and effectiveness of the kingdom during times of crisis.  This is CAN Kingdom, the strongest tool in the hands of a system developer. <br><br>  To avoid ambiguity, CAN Kingdom uses specific semantics, which will be outlined below. <br><br><h5>  System and modules </h5><br>  How to organize and manage a reliable system is highly dependent on the system itself and on its structure.  The structure of the system, in turn, depends on the state of the various modules at the current time.  A reliable system must always be safe, but in most cases it is impossible to have an absolutely safe system while it is working.  An airplane can be considered safe when standing on the runway, without crew, and with systems turned off.  But every step on the road to takeoff increases the risk.  Security and opportunity are conflicting requirements and the final system must be a compromise between them.  It is therefore very important to distinguish between the responsibility of the system and the responsibility of the module.  In CAN Kingdom, the developer of the module is focused on solving local problems and on the opportunity to provide a choice when a controversial situation occurs.  The system developer must organize the system and make this choice. <br><br>  The basic architecture of the CAN Kingdom system is one watch module, the Capital, with the watch program, the King.  This is the property of the system developer, the Founder of the Kingdom.  He is solely responsible for the behavior of the system.  The developer of the module, the founder of the city, is solely responsible for its module, the City, and for the program of this city, Mera.  The King and each Mayor has a library of common procedures, royal documents with which the king can distribute governing messages, and documents of the mayor with which the mayor can respond.  A simple system is depicted in Figure 1. <br><br><img src="https://habrastorage.org/files/a68/3aa/1f9/a683aa1f9681445e92f3ce155127a99c.png"><br><br>  There are four main nodes, the Capital with the King, 2 sensor nodes, City 1 and City 2, and the last node, City 3, using information from the sensors.  Programs (nodes) are divided into parts.  Each node has at least 3 parts, the Royal documents and documents of the Mayor, for managing the system, and the third part for the main program.  CAN message records are located in separate folders, providing the ability to control data flow at the system level. <br><br>  We summarize: there is the <b>Capital</b> in which the program is located which controls the system - the <b>King</b> , the <b>King</b> controls the <b>Cities</b> (modules), through the programs written for this - <b>Mayors</b> .  <b>CAN messages</b> are stored in special <b>folders</b> .  Which can be divided into 3 parts: Royal, Mayors and Specials.  <b>Folders are</b> created by the founder of the city (the developer of the module).  <b>Envelope</b> - CAN message.  <b>Page</b> - a special byte, which allows you to understand exactly which Royal or Mayor document came. <br><br><h5>  Control messages </h5><br>  The royal documents are a set of control messages each, of which configures the module for work in the system.  They all have one CAN Id, default 00h.  The first data byte in the message is the address of one of the system elements, or a group of elements.  Address 00h is transmitted to all nodes.  The next byte is the page number to identify the various commands. <br>  Form royal page x: <br><br>  Document Name: Royal Document <br>  Document list: 0.1 Capital / .0 City <br>  Document number: 0 Capital / 0 City <br>  Document Type: Transfer (Capital) <br>  Receiving (City) <br><br>  Description of the page. <br>  Page number: <br>  Number of lines: 8 <br>  Description of data: <br>  Description of lines. <br>  Line 0: City or group address <br>  Line 1: xxxxxxxxx (Page x) <br>  Line 2: rrrrrrrr Commands <br>  Line 3: rrrrrrrr <br>  Line 4: rrrrrrrr <br>  Line 5: rrrrrrrr <br>  Line 6: rrrrrrrr <br>  Line 7: rrrrrrrr <br><br>  The royal document is a set of messages, transmitted by the king, and messages received by the Mayor.  Each Mayor has one message to send as an answer.  The CAN Id for this message is the node number plus the ‚Äúbase number‚Äù, which is assigned by the King in time for the boot sequence. <br><br>  Form of Mayor's Page 0: <br><br>  Document Name: Mayor Document <br>  Document list: 0.1 <br>  Document number: 1.1 <br>  Document Type: Transfer <br>  Description of the page. <br>  Page Number: 0 <br>  Number of lines: 8 <br>  Data Description: Identification of the city, EAN-13 code <br>  Description of lines. <br>  Line 0: RRRRRRRR reserved R = 0 <br>  Line 1: xxxxxxxxx (Page x) <br>  Line 2: rrrrrrrr Reply <br>  Line 3: rrrrrrrr <br>  Line 4: rrrrrrrr <br>  Line 5: rrrrrrrr <br>  Line 6: rrrrrrrr <br>  Line 7: rrrrrrrr <br><br><h5>  Membership Agreement </h5><br>  The founder of the Kingdom (System Developer) can only be responsible for his system if he has approved all Cities.  No other modules should be connected.  There are 2 ways to check members: by polling their IDs, and by monitoring the bus traffic.  Each City in CAN Kingdom has a unique EAN or UPC number.  It tells the manufacturer, product number and serial number of the City. <br><br>  When the Mayor receives the Royal Page, he will, as soon as possible, respond with the requested Page from his (Mayor's) documents.  Page 0 contains the EAN / UPC code, Page 1 - the serial number.  I will not paint the pages themselves; they can be found in the documentation. <br>  The King, using Page 1, requests from the Mayor Document Page 0 as an answer, each City must respond with its EAN / UPC code.  Taking the Base number from each Envelope (message), the King receives the address of each City and from the received Page the product number.  Then he can verify the correctness of the association of the address and the equipment.  A new request for Page 1 of the Mayor will give the King a serial number, and after saving it, he will be able to track any replacements of the Cities, as well as download specific system settings as needed. <br><br><h5>  Bus Access Control </h5><br>  The basic access control to the CAN bus is bitwise arbitrage.  Even if CAN Kingdom supports time scheduling and garland access, bit-wise arbitration is justified by the basic mode, allowing fast unplanned alarms and using as a backup mode if the schedule or chain has collapsed.  The reliability of the CAN system largely depends on the correctness of the priority of each individual message.  The system developer has a complete understanding of the entire system as a whole and is responsible for setting priorities.  In the CAN Kingdom system, each City has only one CAN Id initially, the Envelope to receive the Letter of the King.  He receives a transferred Envelope, for the Mayor's Page on the first Royal Page (setting of the base and physical number), and for all the others on the second Royal Page (number of envelopes). <br><br>  To control access to the bus in the system of reaction to events, it is not enough to have only the correct message priorities.  It is also necessary to associate the maximum repetition period of messages. <br><br>  We will not go into details about the time at CanKingdom, but it is worth noting that the King can set the maximum re-send time for each Envelope.  This does not solve the problem of "muttering idiot", but allows you to calculate the maximum delay time and properly configure any message. <br><br>  Purely event-based communication or communication based on local non-synchronized clocks will lead from time to time to situations in which messages will be lost at 100% bus load.  One way to find out if Cities are alive is a message-garland.  One message will cause another to be sent.  This behavior is configured by the Royal Page 5 page. With this page, the King orders the Mayor to allow the Page from one Document to respond to another Page of another Document.  This technique can be used not only in scheduling messages, but also to confirm applications, trigger events at other Nodes, and so on.  The function can be controlled by turning on / off the Folder and the link can be removed by removing the Document from the actual Folder. <br><br>  You can often hear that CAN cannot be used for a reliable system built on event processing.  This is not entirely true.  Standard 11898 only defines the behavior of the CAN controller.  Bitwise checking solves bus collisions (bus collisions collisions or bus problems) at a predictable time.  Nothing forbids anyone to use CAN in time planning systems.  CAN provides the ability to create a single synchronized clock in the Kingdom, and send messages according to the time schedule.  This topic is not discussed here, and you can read more about it in the CAN Kingdom specification, which can be downloaded from the <a href="http://www.cankingdom.org/">official site</a> . <br><br><h5>  Boot sequence: </h5><br>  For the safe operation of the <b>Postal system</b> (communication system) in the Kingdom <br>  It is important that any city act in a consonant and safe way when it is connected to the Postal System. <br><br>  The city can break the link in two most likely ways: <br><br>  1. Using a different transmission speed, different from the speed of the Postal System; <br>  2. Transmission of Letters (CAN Messages) in the Envelope (CAN Id) intended for transfer to another City. <br><br>  In order to avoid similar incidents, the City must remain silent until the Postman (CAN controller) receives a valid Letter.  If the Mayor knows the Kingdom Base Number, he announces his presence, otherwise he will wait until the King polls him. <br><br>  The following launch procedure is described for CAN Kingdom Cities: <br><br>  1. The mayor performs internal tests. <br>  2. The Mayor sets the transmission rate of the Mail system to 125 kbps, and the ‚ÄúSilence‚Äù mode (without confirmations and without error messages) at 200 ms and waits for a Standard Letter with an envelope 2031Std containing a Page in which all 8 Lines contain AAhex. <br>  2a.  If such a letter is received within 200 ms, the Mayor saves to the register settings and switches to the ‚ÄúOnly Listen‚Äù mode, waiting for the Royal Letter. <br>  2b.  If such a letter is NOT received during this period, the Mayor sets up the Post Office in the settings of the registers according to the intended Kingdom and place, keeping the ‚Äúsilence‚Äù mode and waiting for the correct letter. <br>  When the Letter is received correctly: <br>  3a.  If the Base Number is known, the Mayor sets the Post Office to the ‚ÄúCommunication‚Äù Mode and sends his Letter with page 0 <br>  2b.  If the Base Number is NOT known, the Mayor switches to the Listen Only mode and waits for a letter from the King. <br><br><h5>  Envelope customization </h5><br>  After successfully setting up the base and physical numbers, the system developer must set up Envelopes, linking the folders between cities.  In fact, every folder in the city is its interface.  For example, the switch on the wall has 1 interface - toggle Light.  And the PLC will have more than 10 of them. The system developer must specify that, say, Interface Switch No. 1 should receive messages from Interface No. 10 of the PLC.  The rest of the messages The switch should filter and ignore.  This is how the system is configured in Can Kingdom using the 2nd royal page. <br><br>  In addition, do not forget about the priority of messages.  It depends on CAN Id, i.e.  The situation might look like this: <br><br>  Device #A, TX (transmit) Folder X - assigned to id N <br>  Device #B, RX (recieve) Folder Y - assigned to id N and id M <br>  Device #C, TX (transmit) Folder Z - assigned to id M <br>  at the same time N &lt;M, then if Device A and Device C simultaneously send their envelopes, then Device #B will first receive an Envelope from A and then from C. <br><br>  There is one more important aspect.  TX Folder can only have 1 Can ID.  RX Folder in turn may have several. <br><br>  System Developer (King) actually designates who will hear whom.  And what device interfaces (Cities) will work in the system, receive and send messages. <br><br><h5>  Control during operation </h5><br>  With page 0, the King informs the Mayors that the settings have been completed and that they should transport the respective cities to work.  It can also be used to freeze the work of a City or a group of Cities in operation mode, stop sending any letters, reloads, etc.  Thus, the King is not only the activity of each city, but also their connections.  Sometimes it is important during extreme conditions.  Parts of the Kingdom should be disconnected from the bus, but still remain active, freeing the channel for other parts.  When a city is frozen, the Mayor must be able to handle all types of Royal Letters.  A city can have more than one ‚ÄúFreeze‚Äù, ‚ÄúWork‚Äù, or ‚ÄúReboot‚Äù mode, which can be selected using Page 0. The King can send this message either to one City or to the Cities group, or to all Cities. <br><br>  Be that as it may, Page 0 is the King‚Äôs main tool in the administration of the Kingdom in the Operating Mode, he is free to use other Pages.  Cities can be added or deleted during operation, depending on how the System Developer has given them similar behavior.  If the Base Number is known a priori, the Mayor will report about himself as soon as he sees a valid message on the bus, otherwise he (the number) will be appointed by the King.  Accordingly, the King can decide when and how the City will be added to the Kingdom. <br><br><h4>  findings </h4><br>  CAN Kingdom is designed to create stable and reliable systems based on the CAN protocol.  By separating the system and module, the System Developer can fully control and be responsible for the final system.  The system can be reconfigured with control messages.  This feature can be used not only for the elegant degradation of the system in case of failures, but also for the modernization of the system at the development stage or after the ‚Äúbirth‚Äù.  Common problems of various systems, such as membership agreement, bus control and operation mode monitoring can be solved using CAN Kingdom. </div><p>Source: <a href="https://habr.com/ru/post/275895/">https://habr.com/ru/post/275895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275883/index.html">Alexey Ragozin and Artyom Panasyuk on distributed load testing on jug.msk.ru</a></li>
<li><a href="../275885/index.html">Video of the best reports of the JPoint 2015 Java Conference - Part 2</a></li>
<li><a href="../275887/index.html">Microsoft has posted on Github CNTK toolkit for deep learning</a></li>
<li><a href="../275889/index.html">Exchange Sorting Network with Batcher Merge</a></li>
<li><a href="../275891/index.html">The book "Creating microservices"</a></li>
<li><a href="../275897/index.html">Top your questions to our person</a></li>
<li><a href="../275899/index.html">ABAP: Handsome # 2</a></li>
<li><a href="../275901/index.html">Advanced Oracle Troubleshoot Session - PGA / UGA Memory Fragmentation</a></li>
<li><a href="../275905/index.html">How Stripe turned into PayPal Mobile Era</a></li>
<li><a href="../275907/index.html">Project Updates Hosting Cafe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>