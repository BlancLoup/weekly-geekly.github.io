<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JaCarta PKI and OpenVPN for Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article describes how to configure two-factor authentication using smart cards and JaCarta PKI USB tokens based on Open.PN's X.509 digital certif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JaCarta PKI and OpenVPN for Windows</h1><div class="post__text post__text-html js-mediator-article">  This article describes how to configure two-factor authentication using smart cards and <b>JaCarta PKI</b> USB tokens based on Open.PN's X.509 digital certificates. <br><br>  This solution allows you to opt out of user password authentication.  The implementation of this solution is a fundamental reduction in the influence of the human factor on the security of the system. <br><a name="habracut"></a><br><h2>  About OpenVPN </h2><br>  <b>OpenVPN</b> is a free open source implementation of VPN technology for creating encrypted point-to-point channels or server-to-client clients between computers.  It allows you to establish connections between computers behind a NAT-firewall, without the need to change their settings. <br><br><h2>  About JaCarta PKI </h2><br>  <a href="https://www.aladdin-rd.ru/catalog/jacarta/pki/">JaCarta PKI</a> is a line of PKI tokens manufactured by <a href="https://www.aladdin-rd.ru/company/">Aladdin RD</a> for strict user authentication in corporate systems, secure storage of key containers of software SKZI and digital certificates. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img width="300" hspace="5" src="https://habrastorage.org/web/53f/707/d01/53f707d0163d42f0a9895cca12e72d2f.png"></div><br><h2>  Setting progress </h2><br><h3>  Demo stand description </h3><br><ul><li>  <b>Server - Microsoft Windows Server 2012, OpenVPN.</b> </li><li>  <b>Client - Microsoft Windows 8.1</b> with the installed <b>JaCarta Single Client</b> driver version 2.9 or higher, <b>OpenVPN</b> . </li></ul><br>  <i>This instruction describes the process of setting up the simplest scenario of a VPN connection between a client and a server.</i>  <i>The construction of complex networks in this manual is not considered.</i> <br><br>  <b><a href="https://www.aladdin-rd.ru/catalog/jacarta_unifiedclient/">JaCarta Single Client</a></b> software is a software package designed to work with all models of tokens and JaCarta smart cards and eToken. <br><br><h3>  Server Tuning </h3><br>  To be able to authenticate with <b>OpenVPN</b> using a digital certificate, it is necessary that the client and server have digital certificates issued by a trusted certificate authority.  The client must trust the server certificate, and the server must trust the client certificate. <br><br>  <i>Violating the trust in a server or client certificate will make it impossible to establish a VPN connection.</i> <br><br>  Consider the process of issuing keys and certificates using the tools offered by <b>OpenVPN</b> itself. <br><br>  Go to the easy-rsa directory, which is in the <b>OpenVPN</b> installation directory, and run init-config.bat.  As a result of the work, a vars.bat file will be created, which must be edited to adapt to your environment: <br><br>  set HOME =% ProgramFiles% \ OpenVPN \ easy-rsa - set the working directory <br>  set KEY_CONFIG = openssl-1.0.0.cnf - set the Openssl configuration file <br>  set KEY_DIR = keys - set the directory for storing keys <br>  set KEY_SIZE = 1024 - set the key size <br>  set KEY_COUNTRY = US - specify the country <br>  set KEY_PROVINCE = CA - specify the area <br>  set KEY_CITY = SanFrancisco - select a city <br>  set KEY_ORG = OpenVPN - enter the name of the organization <br>  set KEY_EMAIL=mail@host.domain - enter e-mail <br>  set KEY_CN = changeme - specify the common name (common name) <br>  set KEY_NAME = changeme - enter a name <br>  set KEY_OU = changeme - specify the organization unit <br><br>  Leave the following sections unchanged: <br><br>  set PKCS11_MODULE_PATH = changeme - path to the pkcs module # 11 <br>  set PKCS11_PIN = 1234 - PIN code for the smart card <br><br>  You need to generate keys for TLS.  Create empty files to store indexes and serial numbers.  To do this, run (runs once): <br><br><ul><li>  vars.bat; <br></li><li>  clean-all.bat. </li></ul><br>  Generate the Trust Center key (run once).  Run: <br><br><ul><li>  vars.bat; <br></li><li>  build-ca.bat. </li></ul><br>  In the dialog, specify the name of the desired Certification Authority. <br><br>  Generate a file for Diffie Hellman keys (only for the server, runs once). <br><br>  Run: <br><br><ul><li>  vars.bat; <br></li><li>  build-dh.bat. </li></ul><br>  Generate a private key and server certificate. <br><br>  Run: <br><br><ul><li>  vars.bat; <br></li><li>  build-key-server.bat &lt;machine name&gt;. </li></ul><br>  As a result, a key and certificate with the name of the machine (server) will be generated. <br><br>  Now you need to create keys and certificates for client machines.  Generate a PKCS # 12 file for each client machine. <br><br>  To do this, run: <br><br><ul><li>  vars.bat; <br></li><li>  build-key-pkcs12.bat &lt;machine name&gt;. </li></ul><br>  As a result, a PKCS # 12 file with the name of the client machine will be generated.  It will need to be generated for each machine. <br><br>  Edit your server configuration file, set the correct network settings. <br><br>  Please note that you need to correctly specify the paths to the key and certificate files.  Extract from the configuration file: <br><br>  # Any X509 key management system can be used. <br>  # OpenVPN can also use a PKCS # 12 formatted key file <br>  # (see ‚Äúpkcs12‚Äù directive in man page). <br>  ca C: \ PATH_K_CERTIFICATE_AIDENT_CENTER_CONTOR \ ca.crt <br>  cert C: \ PATH_K_SERTIFICATU_SERVER \ server.crt <br>  key C: \ PATH_K_KEY_SERVER \ server.key <br><br>  # Diffie hellman parameters. <br>  # Generate your own with: <br>  # openssl dhparam -out dh2048.pem 2048 <br>  dh C: \ PAT_K_FIt_Diffie-Hellman \ dh1024.pem <br><br><h3>  Client Setup </h3><br>  Install the JaCarta Single Client and JaCarta SecurLogon software from the official website of Aladdin RD. <br><br>  <a href="https://www.aladdin-rd.ru/catalog/jacarta_securlogon/">JaCarta SecurLogon</a> is a software solution that provides a simple and fast transition from regular passwords to two-factor authentication when logging into Microsoft Windows and accessing network resources using the JaCarta token. <br><br>  Select the ‚ÄúPKI‚Äù tab and initialize the token. <br><br>  <i>Key initialization will delete all data on it.</i>  <i>If the key has the information you need, including keys and certificates for other systems, do not initialize the key.</i> <br><br>  Using the JaCarta Single Client PC, import the PKCS # 12 file previously generated for the client to the token.  The keys and certificate will appear on the token, they can be seen in the ‚ÄúJaCarta Single Client‚Äù window.  Install the certificate from the token in the personal storage of the computer. <br><br>  Copy the sha1 fingerprint of the personal certificate, it will be required for further configuration. <br><br><div style="text-align:center;"><img width="400" hspace="5" src="https://habrastorage.org/web/8d6/a8e/119/8d6a8e119cde4b3e8a23a84d875c6466.png"></div><br><br>  You will also need the Certificate of the Certificate Authority obtained during server setup.  Install the certificate in the Trusted Root Certificate Authorities Store, and save it locally. <br><br>  Edit your client configuration file, set the correct network settings. <br><br>  In the cryptoapicert field, enter the thumbprint of the user's certificate. <br><br>  In the ca field, specify the path to the Certificate Authority certificate. <br><br>  Extract from the configuration file: <br><br>  # SSL / TLS parms. <br>  # See the server config file for more <br>  # description.  It's best to use <br>  # a separate .crt / .key file pair <br>  # for each client.  A single ca <br>  # file can be used for all clients. <br>  cryptoapicert "THUMB: 81 0d d6 b7 ....  PRINTING CLIENT CERTIFICATE ¬ª <br>  ca C: \ WAY TO CERTIFICATE CERTIFICATE CENTER \ ca.crt <br><br><h3>  Check </h3><br>  Run OpenVPN on the server and client. <br><br>  If the configuration is correct, you will be asked to enter a PIN to the token, and the VPN connection will be established successfully. <br><br><h3>  Other ways to get keys and certificates </h3><br>  The most popular way to generate keys and issue certificates is to use the Certification Authority, for example, based on the Microsoft Certification Authority.  To configure OpenVPN, this method of generating keys and issuing a certificate is also suitable. <br><br>  For the server, generate keys and a server authentication certificate on the Trust Center, export them to a PKCS # 12 file. <br><br>  In the settings of the server side of OpenVPN, instead of cert and key, you must specify pkcs12: <br><br>  ca C: \ PATH_K_CERTIFICATE_AIDENT_CENTER_CONTOR \ ca.crt <br>  pkcs12 C: \ PATH_K_CERTIFICATU_SERVER \ server.p12 <br><br>  The ca root certificate must be a Certificate Authority certificate. <br><br>  Setting up templates for issuing keys and certificates for a token is described in the instructions for the JaCarta Single Client and JaCarta SecurLogon.  For the client, generate keys and a client authentication certificate on the Trust Center.  In this case, importing the pkcs # 12 file to the token is not required.  The rest of the client side settings are done in the same way. </div><p>Source: <a href="https://habr.com/ru/post/329880/">https://habr.com/ru/post/329880/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329870/index.html">Kotlin and Swift. New era in mobile development?</a></li>
<li><a href="../329872/index.html">Deploying and maintaining Redmine, the right way</a></li>
<li><a href="../329874/index.html">Fifth generation of HPE MSA storage: twice the performance for the same price</a></li>
<li><a href="../329876/index.html">Limit the speed of processing requests in nginx</a></li>
<li><a href="../329878/index.html">The largest Git repository in the world</a></li>
<li><a href="../329882/index.html">9 reasons that prevent you from becoming a timlid</a></li>
<li><a href="../329884/index.html">Machine intelligence in a Gboard keyboard</a></li>
<li><a href="../329886/index.html">Delegates and Lambda Expressions in C # .Net - Cheat Sheet or Briefly</a></li>
<li><a href="../329888/index.html">ACM ICPC 2017: Final Results</a></li>
<li><a href="../329890/index.html">PHDays VII: Confrontation Chronicles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>