<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WannaCry: analysis, indicators of compromise and recommendations for prevention</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last Friday, right at the end of the day, when all the administrators and security experts gathered at their homes and dachas, the world spread around...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WannaCry: analysis, indicators of compromise and recommendations for prevention</h1><div class="post__text post__text-html js-mediator-article">  Last Friday, right at the end of the day, when all the administrators and security experts gathered at their homes and dachas, the world spread around the news of the beginning of the unprecedented attack of WannaCry.  After a couple of days, we can already say that it is not for nothing that the name of this attack is associated with Keith Urban‚Äôs song ‚ÄúTonight I Wanna Cry‚Äù (‚ÄúToday I want to cry‚Äù).  Its scale turned out to be quite sinister - at the time of writing, the number of victims <a href="https://intel.malwaretech.com/botnet/wcrypt/%3Ft%3D24h%26bid%3Dall">exceeded</a> 230 thousand and this number can grow when many return from weekends and holidays and turn on their home and work computers.  We, in our division of Cisco Talos, <a href="http://blog.talosintelligence.com/2017/05/wannacry.html">published</a> our study of this malicious program on Friday and now we would like to share some key points with Habr users. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/009/a32/ee4/009a32ee4a2ead56dda7f838bef7d8fc.png" alt="Wanncry"></div><a name="habracut"></a><br>  WannyCry is a crypto-worm, the distinguishing feature of which is the self-propagation function, which is usually absent in the classical cryptographer.  This means that for infection you <b>do not need to click anywhere</b> , press anything and open anything.  It is enough to have a Windows-based computer that is simply vulnerable, unpatched, and connected to the Internet (including through other computers, for example, on a local network) to become a victim of WannaCry.  After infecting the computer, the victim sees an offer to pay a certain amount of money (different variations of WannaCry require different amounts - from 300 to 600 dollars) for returning access to the files.  The offer is displayed in different languages, including Russian.  An interesting point is that the ransom report is not just a text file, a picture or an HTA file, as usual with cryptographers, but an executable file. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/96b/2e3/cdc/96b2e3cdc501473b52d3399cc8851a12.jpg" alt="WannaCry buyout requirement"></div><br>  Pay attention to this point - <b>no reaction is required from the user</b> !  What made this possible?  Everything is simple - the authors of WannaCry took advantage of the leak from ShadowBrokers, as a result of which the world has become aware of many previously unknown vulnerabilities and methods of conducting attacks.  Among them was the <a href="">ETERNALBLUE</a> vulnerability and the related backdoor DOUBLEPULSAR.  The first allowed through the vulnerable SMB to get remote access to a computer and quietly install software on it.  This is how the WannyCry cryptographer is installed.  Back in March, Microsoft <a href="https://support.microsoft.com/en-us/help/4012598/title">released a</a> corresponding patch for this vulnerability, but, as experience shows, many administrators for various reasons did not bother to install it on their computers.  The ETERNALBLUE vulnerability is present on all versions of Windows, excluding Windows 10. Given the presence in the world of a large number of Windows operating systems not supported by the company (Windows XP, Windows 8, Windows Server 2003) and the scale of the attack, Microsoft took an unprecedented step and <a href="https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/">released</a> patches for these OS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Please note that if you have the appropriate patch installed or the use of this vulnerability is blocked (for example, using IPS), this does not mean that you are not affected by WannaCry.  The cipher also can be launched in this case, but this will require the user‚Äôs reaction, which is usual for the work of classic ransomware lockers.  Installing the Microsoft patch only blocks remote infection and distribution of malicious code. <br><br>  The WannaCry malware scans for vulnerable computers by scanning server port 445 (Server Message Block / SMB) open from the outside.  Therefore, a good idea (if your processes allow it) would be to block access to this port (and also to 139th) from the Internet on your firewall or router.  For Cisco routers, the corresponding ACL might look like this: <br><br>  access-list 110 deny tcp any any eq 445 <br>  access-list 110 deny tcp any any eq 139 <br><br>  However, blocking these ports from the outside does not mean complete protection against internal infection.  If any of your users bring a home laptop containing WannaCry and connect it to an internal local network (we already received requests from some customers who had the CEOs with their infected computers come to work on weekends, calling there too carpet ‚Äùand IT staff), then WannaCry will start looking for new victims within the organization. <br><br>  Our analysis shows that, together with the ETERNALBLUE vulnerability, the DOUBLEPULSAR backdoor from ShadowBrokers Leak is also valid, which allows you to get remote access and execute arbitrary code on a previously compromised machine.  Usually, after successful exploitation of the ETERNALBLUE vulnerability, the DOUBLEPULSAR backdoor is installed and a cryptographer is installed with it.  If it is not possible to successfully run ETERNALBLUE, but there is a copy of DOUBLEPULSAR on the attacked node, the code for the cryptographer is installed through it. <br><br><img src="https://habrastorage.org/web/d75/e29/e5e/d75e29e5e2e14b1499cfa9596d7b0d1a.png" alt="WannaCry Analysis in Cisco AMP Threat Grid"><br><br>  After successfully installing and encrypting files, WannaCry tries to connect to the Tor network nodes to transmit traffic through it and attempt to hide its true ‚Äúmasters‚Äù.  The following IP addresses of Tor nodes were discovered by Cisco Talos specialists, but this is not the final list.  Our colleagues from other companies have different addresses for their Tor nodes.  At the same time, their analysis shows that most of them have an old history and have already been used in various malicious activities.  In addition, it is worth remembering that these addresses will not be used permanently - their lifespan for the current version of WannaCry will be several weeks.  Therefore, it is worthwhile to regularly monitor information about this threat and update the relevant indicators of compromise. <br><br>  Despite the fact that only a couple of days have passed since the outbreak of the epidemic and several hundred thousand computers have already suffered, the attackers managed to release several new versions of their malicious creation, mainly in the part of the cipher operator.  The current version of WannaCry contains the ‚Äúkill switch‚Äù function, that is, checking for the presence of a specific domain on the Internet, upon detection of which the malicious code was not installed on the victim‚Äôs computer.  This domain - iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea [.] Com (new domains may use other domains) was identified by one of the researchers and registered by him for the "interception" of malware management.  As the analysis of appeals to this domain using the Cisco OpenDNS Investigate service showed, over 200 thousand computers were saved from infection in the past two days. <br><br><img src="https://habrastorage.org/web/2d7/52e/e16/2d752ee163b5412e80733fb31f988cff.png" alt="Analyzing a call to a kill switch domain using Cisco OpenDNS Investigate"><br><br>  No modifications of WannaCry have been discovered without the kill switch function (although attempts have been made, but so far unsuccessful), but this does not mean that it cannot be.  In any case, the story is not over.  On Monday, many people will turn on their computers after holidays and weekends, and the number of victims of this malware may increase.  Moreover, our analysis shows that the architecture of WannaCry is modular and can be used to deliver and use other malicious modules. <br><br>  It is worth noting that at the time of writing this note, it was not yet possible to find a way to decrypt encrypted files.  This means that in case of a user infection and lack of a backup copy of his data, the probability of returning access to his files is low (even in the case of a ransom payment, which does not guarantee the receipt of a key for decryption).  For encryption, the 2048 Mbit RSA key is used, and the files with the following extensions fall under the distribution: <br><br>  .der, .pfx, .key, .crt, .csr, .p12, .pem, .odt, .sxw, .stw, .3ds, .max, .3dm, .ods, .sxc, .stc, .dif , .slk, .wb2, .odp, .sxd, .std, .sxm, .sqlite3, .sqlitedb, .sql, .accdb, .mdb, .dbf, .odb, .mdf, .ldf, .cpp,. pas, .asm, .cmd, .bat, .vbs, .sch, .jsp, .php, .asp, .java, .jar, .class, .mp3, .wav, .swf, .fla, .wmv, .mpg, .vob, .mpeg, .asf, .avi, .mov, .mp4, .mkv, .flv, .wma, .mid, .m3u, .m4u, .svg, .psd, .tiff, .tif , .raw, .gif, .png, .bmp, .jpg, .jpeg, .iso, .backup, .zip, .rar, .tgz, .tar, .bak, .ARC, .vmdk, .vdi,. sldm, .sldx, .sti, .sxi, .dwg, .pdf, .wk1, .wks, .rtf, .csv, .txt, .msg, .pst, .ppsx, .ppsm, .pps, .pot, .pptm, .pptx, .ppt, .xltm, .xltx, .xlc, .xlm, .xlt, .xlw, .xlsb, .xlsm, .xlsx, .xls, .dotm, .dot, .docm, .docx .doc <br><br>  As you can see, Office files Excel, Word, PowerPoint, Open Office, music and video files, archives, e-mail and mail archives / databases, MS SQL database files, MS Access, MS Visio graphic files, Photoshop, as well as virtual machines and others. <br><br>  Now it is too early to put an end to the story with WannaCry and ahead we have a more detailed analysis of this malicious program.  In the meantime, we can make a number of recommendations on how to protect against it: <br><br><ol><li>  Install at least the MS17-010 patch covering the SMB ETERNALBLUE vulnerability.  It is better to upgrade all your computers with Windows.  In industrial networks, where the installation of patches has its own characteristics, it is worth checking with the manufacturer of its automated process control system whether the installation of this patch will affect the operation of the system and the process.  It is also possible to completely <a href="https://support.microsoft.com/en-us/help/2696547/how-to-enable-and-disable-smbv1,-smbv2,-and-smbv3-in-windows-vista,-windows-server-2008,-windows-7,-windows-server-2008-r2,-windows-8,-and-windows-server-2012">block</a> support for the SMB protocol if this is permissible in a specific network and for specific IT processes and applications. </li><li>  Block external connections from the Internet using SMB / NetBIOS protocols ‚Äî to do this, you need to close 137th, 139th and 445th TCP ports, as well as 137th and 138th UDP ports. </li><li>  Enable backup systems (even copying important files to a regular USB flash drive or an external hard disk in manual mode will already be superfluous). </li><li>  Use current, supported OS versions for which security updates are issued. </li><li>  Use personal computer protection tools - from traditional antiviruses with regularly updated signature databases to next generation protection tools (EDR, STAP, BDS, etc. names). </li><li>  Monitor and block traffic to Tor nodes, which are often used by encryptors and other malicious programs. </li><li>  Use the services of Threat Intelligence, which will allow you to be aware of the dynamically changing threat landscape and constantly update your protection tools with new indicators of compromise. </li></ol><br>  For those users who use Cisco cybersecurity solutions, we can say that all our solutions can deal with this threat: <br><br><ul><li>  Advanced Malware Protection (AMP), especially AMP for Endpoints, is ideal for detecting and preventing this malicious program. </li><li>  Cloud Web Security (CWS) and Web Security Appliance (WSA) detect access to the malicious "kill switch" domains. </li><li>  Cisco Firepower NGIPS has relevant signatures to detect and block this threat. </li><li>  Cisco Firepower NGFW (as well as the Cisco ASA) can block access to 139th and 445th TCP ports, and also has a regularly updated list of Tor nodes to track interaction with this network and block outgoing connections. </li><li>  AMP Threat Grid helped analyze the malicious behavior of WannaCry, and can also do this for new modifications of this malicious program. </li><li>  OpenDNS Umbrella helps recognize the interaction with the domains associated with this threat.  You can use the free version of <a href="https://www.opendns.com/home-internet-security/">OpenDNS Home</a> , which will increase the level of protection for home users. </li><li> Stealthwatch detects network activity associated with scanning vulnerable nodes, spreading malicious code over the network, as well as interaction with command servers (C2 or CnC), including the Tor network. </li><li>  The Identity Service Engine (ISE) can monitor unpatched nodes on the local network and block their access or localize them by redirecting them to the quarantine subnet.  Also, ISE integration with the Qualys security scanner (TC-NAC) allows you to identify nodes vulnerable to ETERNALBLUE and also quarantine them. </li></ul><br>  Snort users should be aware that the rules 42329-42332, 42340 and 41978, which are available as part of the service pack on <a href="http://snort.org/">Snort.org,</a> help the fight against this threat.  IPS Signature Pack S982 has been prepared for Cisco Legacy IPS users, in which 7958-0 and 7958-1 are fighting WannaCry. <br><br>  Additionally, we want to indicate the indicators of compromise for WannaCry, which we identified as part of our analysis: <br><br>  <b>File Names</b> : <br>  d5e0e8694ddc0548d8e6b87c83d50f4ab85c1debadb106d6a6a794c3e746f4fa b.wnry <br>  055c7760512c98c8d51e4427227fe2a7ea3b34ee63178fe78631fa8aa6d15622 c.wnry <br>  402751fa49e0cb68fe052cb3db87b05e71c1d950984d339940cf6b29409f2a7c r.wnry <br>  e18fdd912dfe5b45776e68d578c3af3547886cf1353d7086c8bee037436dff4b s.wnry <br>  4a468603fdcb7a2eb5770705898cf9ef37aade532a7964642ecd705a74794b79 taskdl.exe <br>  2ca2d550e603d74dedda03156023135b38da3630cb014e3d00b1263358c5f00d taskse.exe <br>  97ebce49b14c46bebc9ec2448d00e1e397123b256e2be9eba5140688e7bc0ae6 t.wnry <br>  b9c5d4339809e0ad9a00d4d3dd26fdf44a32819a54abf846bb9b560d81391c25 u.wnry <br><br>  <b>Observed IPs</b> : <br>  188 [.] 166 [.] 23 [.] 127: 443 - Tor Exit Node <br>  193 [.] 23 [.] 244 [.] 244: 443 - Tor Exit Node <br>  2 [.] 3 [.] 69 [.] 209: 9001 - Tor Exit Node <br>  146 [.] 0 [.] 32 [.] 144: 9001 - Tor Exit Node <br>  50 [.] 7 [.] 161 [.] 218: 9001 - Tor Exit Node <br>  128.31.0 [.] 39 - Tor Exit Node <br>  213.61.66 [.] 116 - Tor Exit Node <br>  212.47.232 [.] 237 - Tor Exit Node <br>  81.30.158 [.] 223 - Tor Exit Node <br>  79.172.193 [.] 32 - Tor Exit Node <br><br>  <b>Tor C2</b> : <br>  xxlvbrloxvriy2c5.onion <br>  cwwnhwhlz52maqm7.onion <br>  gx7ekbenv2riucmf.onion <br>  57g7spgrzlojinas.onion <br>  76jdd2ir2embyv47.onion <br><br>  <b>The list of observed within the framework of WannaCry hashes</b> : <br>  ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa <br>  c365ddaa345cfcaff3d629505572a484cff5221933d68e4a52130b8bb7badaf9 <br>  09a46b3e1be080745a6d8d88d6b5bd351b1c7586ae0dc94d0c238ee36421cafa <br>  0a73291ab5607aef7db23863cf8e72f55bcb3c273bb47f00edf011515aeb5894 <br>  428f22a9afd2797ede7c0583d34a052c32693cbb55f567a60298587b6e675c6f <br>  5c1f4f69c45cff9725d9969f9ffcf79d07bd0f624e06cfa5bcbacd2211046ed6 <br>  62d828ee000e44f670ba322644c2351fe31af5b88a98f2b2ce27e423dcf1d1b1 <br>  72af12d8139a80f317e851a60027fdf208871ed334c12637f49d819ab4b033dd <br>  85ce324b8f78021ecfc9b811c748f19b82e61bb093ff64f2eab457f9ef19b186 <br>  a1d9cd6f189beff28a0a49b10f8fe4510128471f004b3e4283ddc7f78594906b <br>  a93ee7ea13238bd038bcbec635f39619db566145498fe6e0ea60e6e76d614bd3 <br>  b43b234012b8233b3df6adb7c0a3b2b13cc2354dd6de27e092873bf58af2693c <br>  eb47cd6a937221411bb8daf35900a9897fb234160087089a064066a65f42bcd4 <br>  24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c <br>  2c2d8bc91564050cf073745f1b117f4ffdd6470e87166abdfcd10ecdff040a2e <br>  7a828afd2abf153d840938090d498072b7e507c7021e4cdd8c6baf727cafc545 <br>  a897345b68191fd36f8cefb52e6a77acb2367432abb648b9ae0a9d708406de5b <br>  fb0b6044347e972e21b6c376e37e1115dab494a2c6b9fb28b92b1e45b45d0ebc <br>  9588f2ef06b7e1c8509f32d8eddfa18041a9cc15b1c90d6da484a39f8dcdf967 <br>  b43b234012b8233b3df6adb7c0a3b2b13cc2354dd6de27e092873bf58af2693c <br>  4186675cb6706f9d51167fb0f14cd3f8fcfb0065093f62b10a15f7d9a6c8d982 <br>  09a46b3e1be080745a6d8d88d6b5bd351b1c7586ae0dc94d0c238ee36421cafa <br><br>  <b>Additional Information:</b> <br><ul><li>  A more comprehensive analysis of WannaCry (in English) <a href="http://blog.talosintelligence.com/2017/05/wannacry.html">on the Cisco Talos blog</a> . </li><li>  Identify the ETERNALBLUE vulnerability <a href="">on the Cisco website</a> . </li><li>  <a href="https://tools.cisco.com/security/center/content/CiscoSecurityResponse/cisco-sr-20170515">The impact of</a> WannaCry on Cisco products. </li></ul><br><br>  UPDATE: As new information on this malware appears, we will make changes to this text. </div><p>Source: <a href="https://habr.com/ru/post/328598/">https://habr.com/ru/post/328598/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328586/index.html">Algorithmic problems in bioinformatics. Lecture in Yandex</a></li>
<li><a href="../328588/index.html">"The letter of the law": A little about the protection of personal data</a></li>
<li><a href="../328590/index.html">IBM has opened access to a new 16-qubit quantum processor</a></li>
<li><a href="../328592/index.html">The digest of interesting materials for the mobile # 203 developer (May 9-14)</a></li>
<li><a href="../328596/index.html">Geolocation in the smartphone - a new way to search for witnesses to road incidents</a></li>
<li><a href="../328600/index.html">Unusual application of the bot for Telegram and Telegram security check</a></li>
<li><a href="../328602/index.html">Digest: IaaS provider operation, SSL certificates, data center and our ‚ÄúFriday format‚Äù</a></li>
<li><a href="../328604/index.html">Migrating users and their privileges to MySQL</a></li>
<li><a href="../328606/index.html">Analysis of Wana Decrypt0r 2.0 cipher</a></li>
<li><a href="../328608/index.html">Python PID Controller Model</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>