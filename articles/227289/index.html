<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic import of users' full names from Active Directory to Lightsquid</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many who manage the Squid proxy server in the enterprise have a need to periodically show employees use statistics on the Internet to management. In a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic import of users' full names from Active Directory to Lightsquid</h1><div class="post__text post__text-html js-mediator-article">  Many who manage the Squid proxy server in the enterprise have a need to periodically show employees use statistics on the Internet to management.  In addition to Squid, a log analyzer such as SARG, Lightsquid, etc. is installed to present statistics.  At the same time, the organization often has a directory service (it is assumed to be Active Directory), in which all employees have accounts and authorization in the proxy server is based on the accounts.  Naturally, for management, when it looks at a report, it is more convenient to identify an employee by his first and last name.  Surprisingly, in many forums and IT-portals this task is offered to be solved manually, scoring the names and surnames in the log analyzer configuration files.  This solution has a drawback - when enrolling / firing any employee, you will have to edit configs. <br>  This article describes the method of automatically extracting data about the names and surnames of employees from ActiveDirectory and inserting them into Lightsquid reports. <a name="habracut"></a><br><br><h5>  Objective: to ensure the output of reports via Lightsquid for each Active Directory user logging in to the Internet, indicating his first and last name (looking ahead, I will say that in AD this field corresponds to the "display name" field; in LDAP queries it is referred to by the displayName variable ) </h5><br><br><h5>  Initial data: </h5><br><ul><li>  - The configured and correctly working Squid 3.3.8 with authorization of ntlm </li><li>  -The following lines are present in the Squid config: <br><pre><code class="bash hljs">logfile_rotate N debug_options rotate=M</code> </pre> <br>  where N and M are the maximum number of log files Squid can create <br>  logfile_rotate - for access.log, debug_options - for cache.log </li><li>  -Customized and correctly working Apache 2.4.7 </li><li>  - The configured and correctly working Lightsquid 1.8 () </li><li>  -in the Lightsquid config there is a variable $ lang = "ru" </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Decision: </h5><br>  First, I will describe the mechanism for transferring data about the full name to Lightsquid from Active Directory, then I will give its implementation. <br><br>  Information about the name is presented in AD in the properties of the domain user, in the field "Display Name".  To get information from AD, you need to interact with it through LDAP requests.  In this case, you can interact only on behalf of an authorized domain user.  Since Lightsquid is written in Perl, the Net :: LDAP module is required to complete these requests.  And for automatic output of information from AD in the report, it is necessary to replace the simple receipt of a login from squid with an LDAP request. <br><br>  First, you need to create an account with the most limited rights in AD, which will be used to perform LDAP queries.  To do this, start the Active Directory Users and Computers snap-in and create a new user.  Give it a name expressing its purpose.  For example, LightSquidAgent.  Then create a new GPO and enter its properties (or properties of an existing object).  Next Computer Configuration-&gt; Windows Configuration-&gt; Security Settings-&gt; Local Policies-&gt; User Rights Assignment.  In the "Deny access to a computer from the network" parameter, enter LightSquidAgent.  In the "Reject local login" setting, also enter LightSquidAgent. <br><br>  Now install the Net :: LDAP module in Perl.  Run bash or a similar command shell and execute <pre> <code class="bash hljs">perl -MCPAN -e shell</code> </pre>  .  After entering the cpan interpreter, we execute <pre> <code class="bash hljs">install Net::LDAP</code> </pre>  .  Next, the installer will display the question of whether we want to allow it to perform auto-configuration.  Just hit Enter.  At the end you should see <pre> <code class="bash hljs">LDAP module was installed successfully</code> </pre>  . <br><br>  After that, you can edit the code that generates reports.  Go to the folder with the installed LightSquid, go to the folder ip2name and open the file ip2name.squidauth.  It should look like this: <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#contributor: esl #specialy for squid with turned on user authentication #simple version sub StartIp2Name() { } sub Ip2Name($$$) { # $Lhost,$user,$Ltimestamp my $Lhost=shift; my $user =shift; $user =URLDecode($user); #decode user name return $user if ($user ne "-"); return $Lhost; } sub StopIp2Name() { } #warning !!! 1;</span></span></code> </pre><br><h6>  UPD: The recommendations of the author Lightsquid about caching user names. </h6><br><h6>  UPD2: Fixed bug with hang script when recognizing unauthorized users </h6><br><h6>  UPD3: Fixed bug with script hangup when a domain controller is unavailable and if it is impossible to log in under the LightSquidAgent account </h6><br>  In the file header, you need to register the namespace in which the functions we need are and declare 3 new variables: <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#contributor: esl #specialy for squid with turned on user authentication #simple version use strict; use warnings; use Net::LDAP; use Encode; my $ldap; my $message; my %hDisplayName;</span></span></code> </pre><br><br><h5>  We replace the empty definition of StartIp2Name with ours, in which the connection to the domain controller is established </h5><br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartIp2Name</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $server = "ldap://ourserver.domain.com"; $ldap = Net::LDAP-&gt;new( $server ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $ldap); $message = $ldap-&gt;<span class="hljs-keyword"><span class="hljs-keyword">bind</span></span>(<span class="hljs-string"><span class="hljs-string">q(domain\LightSquidAgent)</span></span>, <span class="hljs-string"><span class="hljs-string">password =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"passwd"</span></span>); }</code> </pre><br><br><h5>  Replacing the definition of the Ip2Name function, our version of the function will take from the domain controller the full name of employees </h5><br><h6>  In the branch of the conditional operator, duplicate logins will be skipped; only one LDAP request will be made for each user. </h6><br>  Instead <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ip2Name</span></span></span></span>($$$) { # $Lhost,$user,$Ltimestamp <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $Lhost=<span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $user =<span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; $user =URLDecode($user); <span class="hljs-comment"><span class="hljs-comment">#decode user name return $user if ($user ne "-"); return $Lhost; }</span></span></code> </pre><br>  we insert <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ip2Name</span></span></span></span>($$$) { # $Lhost,$user,$Ltimestamp <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $Lhost=<span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $user =<span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; $user =URLDecode($user); <span class="hljs-comment"><span class="hljs-comment">#decode user name return $Lhost if ($user eq "-"); return $user if (!defined $ldap); return $user if ($message-&gt;code()); if (!defined $hDisplayName{$user}) { my $result = $ldap-&gt;search( base =&gt; "dc=domain,dc=com", filter =&gt; "(&amp;(objectCategory=person)(objectClass=user)(sAMAccountName=" . $user . "))", ); my $first_entry = $result-&gt;entry(0); if (!defined $first_entry) { return $Lhost; } my $pure_displayName = $first_entry-&gt;get_value("displayName"); $pure_displayName =~ s/ /_/g; Encode::from_to($pure_displayName, 'utf-8', 'windows-1251'); $hDisplayName{$user}=$pure_displayName; } return $hDisplayName{$user}; }</span></span></code> </pre><br><br><h5>  Last: In the StopIp2Name function, we disconnect from the domain controller </h5><br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StopIp2Name</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $ldap); $message = $ldap-&gt;unbind; }</code> </pre><br><br>  Objective criticism is welcome. </div><p>Source: <a href="https://habr.com/ru/post/227289/">https://habr.com/ru/post/227289/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../227279/index.html">Who and why is ‚Äúspying‚Äù on Yandex?</a></li>
<li><a href="../227281/index.html">GoogleDocs integration with Redmine</a></li>
<li><a href="../227283/index.html">Swift hackathon based on WWDC 2014 from CocoaHeads Moscow</a></li>
<li><a href="../227285/index.html">Own WebGL engine. Article number 2. Matrix</a></li>
<li><a href="../227287/index.html">Installing Google Chromium and Flash on a Linux ARM device</a></li>
<li><a href="../227293/index.html">Overview of the most interesting materials on data analysis and machine learning ‚Ññ2 (June 16 - 23, 2014)</a></li>
<li><a href="../227295/index.html">Call the nodes of the network: where to get inspiration?</a></li>
<li><a href="../227303/index.html">Laser message from space</a></li>
<li><a href="../227305/index.html">Detailed comparison of popular SMS / Voice services for mailings and authorizations</a></li>
<li><a href="../227313/index.html">46 easy tips for your online store success</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>