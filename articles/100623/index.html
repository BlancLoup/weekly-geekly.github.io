<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Callbacks and C ++ Exceptions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 As is known, many C-libraries use callbacks to provide any functionality. This is, for example, the expat library for implementing the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Callbacks and C ++ Exceptions</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  As is known, many C-libraries use callbacks to provide any functionality.  This is, for example, the expat library for implementing the SAX model.  Callback or callback is used to be able to execute custom code on the side of the library.  While this code does not have side effects - everything is fine, but as soon as C ++ appears in the arena, everything, as always, becomes nontrivial. <br><br><a name="habracut"></a><br>  So, C ++ code can generate exceptions for which C code is not prepared. After all, the callback function is executed in the context of the library.  And if the exit from such a function is performed by generating an exception, it will go further, destroying the stack. <br>  The obvious solution, the one that I met most often when I first began to deal with this issue, is to completely reject the exceptions in such callbacks.  But this, of course, is not our case. <br><br><h3>  Happening </h3><br>  I knowingly gave expat an example.  The problem of exceptions arose when using this library.  The task was as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  There is some code that used to use the xml library written in C ++ and this code actively applied exceptions; </li><li>  There is a need to replace the xml library with another one without rewriting the rest of the code. </li></ul><br>  I began to develop a wrapper over expat, which was exactly the same as the interface of the previous library.  It was in the process of solving this problem that this idea was born. <br><br><h3>  Idea </h3><br>  It is necessary to somehow postpone the throwing of the exception until the execution returns to the C ++ code.  The only way is to save the exception somewhere and throw it again in a safe place.  But there are a number of difficulties associated with the implementation. <br><br><h3>  Implementation </h3><br><h4>  Class exception_storage </h4><br>  First you need to implement a storage for the thrown exceptions, it will look so simple: <br><blockquote><code><font color="black"><font color="#0000ff">class</font> exception_storage <br> { <br> <font color="#0000ff">public</font> : <br> <font color="#0000ff">inline</font> ~exception_storage() {} <br> <font color="#0000ff">inline</font> exception_storage() {} <br> <br> <font color="#0000ff">void</font> rethrow() <font color="#0000ff">const</font> ; <br> <br> <font color="#0000ff">inline</font> <font color="#0000ff">void</font> store(clone_base <font color="#0000ff">const</font> &amp; exc); <br> <font color="#0000ff">inline</font> <font color="#0000ff">bool</font> thrown() <font color="#0000ff">const</font> ; <br> <font color="#0000ff">private</font> : <br> std::auto_ptr&lt; <font color="#0000ff">const</font> clone_base&gt; storedExc_; <br> }; <br></font> <br></code> </blockquote><br>  The clone_base class is boost :: exception_detail :: clone_base very well suited for our purpose. <br>  The implementation is also not difficult: <br><br><blockquote> <code><font color="black"><font color="#0000ff">inline</font> <br> <font color="#0000ff">void</font> exception_storage::store(clone_base <font color="#0000ff">const</font> &amp; exc) <br> { <br> storedExc_.reset(exc.clone()); <br> } <br> <font color="#0000ff">inline</font> <br> <font color="#0000ff">bool</font> exception_storage::thrown() <font color="#0000ff">const</font> <br> { <br> <font color="#0000ff">return</font> storedExc_.get() != 0; <br> } <br> <font color="#0000ff">inline <br> void</font> exception_storage::rethrow() <br> { <br> <font color="#0000ff">class</font> exception_releaser <br> { <br> <font color="#0000ff">public</font> : <br> <font color="#0000ff">inline</font> <br> exception_releaser(std::auto_ptr&lt; <font color="#0000ff">const</font> clone_base&gt; &amp; excRef) <br> : excRef_(excRef) <br> {} <br> <font color="#0000ff">inline</font> <br> ~exception_releaser() <br> { <br> excRef_.reset(); <br> } <br> <font color="#0000ff">private</font> : <br> std::auto_ptr&lt; <font color="#0000ff">const</font> clone_base&gt; &amp; excRef_; <br> }; <br> <br> <font color="#0000ff">if</font> (thrown()) <br> { <br> <font color="#0000ff">volatile</font> exception_releaser dummy(storedExc_); <br> storedExc_-&gt;rethrow(); <br> } <br> } <br></font> <br></code> </blockquote><br>  Three methods, store ‚Äî serves to save the current exception using clone_base :: clone, rethrow re-generates the last exception, if it happened, thrown indicates whether there was an exception at all.  The clone_base :: clone function is purely virtual, and being able to use it for any exceptions gives boost :: enable_current_exception, which kills two birds with one stone: allows direct exceptions not to know that it should be cloned and save information about the type behind the abstract interface clone_base . <br>  Separately, I want to talk about the implementation of the rethrow method.  It calls the virtual function rethrow (and it is this function that has the notion of what we are generating for the exception).  The class exception_releaser clears the memory of the stored exception when it is thrown.  The exception is generated during generation, therefore the object pointed to by the storedExc_ becomes unnecessary.  In addition, it allowed me to save on the boolean flag to indicate the need for generation. <br><br><h4>  Exception filter </h4><br>  The most tricky thing in this whole system, in my opinion, is the exception filter.  A great library boost :: mpl will help us a lot in its implementation.  Consider it in more detail. <br><br>  Obviously, to write an exception to the repository, you must first catch it.  The filter is designed to solve this particular problem.  Take a hypothetical callback: <br><br><blockquote> <code><font color="black"><font color="#0000ff">void</font> callback( <font color="#0000ff">void</font> *userData, <font color="#0000ff">char const</font> *libText); <br></font> <br></code> </blockquote><br>  How to make exceptions not fly out of this function? <br>  The first solution is to intercept everything.  But here we stumble upon an annoying limitation of language.  There is no portable way to get information about the type of exception in the catch (...) block.  It was then that the idea came to me that we could make it a feature.  To enable the library user to set which exceptions to catch in these callbacks. <br>  I started by implementing an exception filter that is extensible to compile-time.  It looks like this: <br><br><blockquote> <code><font color="black"><font color="#0000ff">template</font> &lt; <font color="#0000ff">typename</font> List, <font color="#0000ff">size_t</font> i = boost::mpl::size&lt;List&gt;::value - 1&gt; <br> <font color="#0000ff">class</font> exception_filter <br> { <br> <font color="#0000ff">typedef typename</font> boost::mpl::at_c&lt;List, i&gt;::type exception_type; <br> <font color="#0000ff">public</font> : <br> <font color="#0000ff">static</font> <font color="#0000ff">inline</font> <font color="#0000ff">void</font> try_(exception_storage &amp; storage) <br> { <br> <font color="#0000ff">try</font> <br> { <br> exception_filter&lt;List, i - 1&gt;::try_(storage); <br> } <br> <font color="#0000ff">catch</font> (exception_type <font color="#0000ff">const</font> &amp; e) <br> { <br> storage.store(boost::enable_current_exception(e)); <br> } <br> } <br> }; <br> <font color="#0000ff">template</font> &lt; <font color="#0000ff">typename</font> List&gt; <br> <font color="#0000ff">class</font> exception_filter&lt;List, 0&gt; <br> { <br> <font color="#0000ff">typedef typename</font> boost::mpl::at_c&lt;List, 0&gt;::type exception_type; <br> <font color="#0000ff">public</font> : <br> <font color="#0000ff">static</font> <font color="#0000ff">inline</font> <font color="#0000ff">void</font> try_(exception_storage &amp; storage) <br> { <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">throw</font> ; <br> } <br> <font color="#0000ff">catch</font> (exception_type <font color="#0000ff">const</font> &amp; e) <br> { <br> storage.store(boost::enable_current_exception(e)); <br> } <br> } <br> }; <br></font> <br></code> </blockquote><br>  This is a recursively instantiable template that uses boost :: mpl :: vector as the List parameter.  In the vector, you can specify the types of exceptions that you want to catch.  When instantiated, the template expands to something like this (pseudocode): <br><br><blockquote> <code><font color="black"><font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">throw</font> ; <br> } <br> <font color="#0000ff">catch</font> (exception_type_1) <br> { <br> } <br> } <br> <font color="#0000ff">catch</font> (exception_type_2) <br> { <br> } <br> } <br> <font color="#0000ff">catch</font> (exception_type_N) <br> { <br> } <br></font> <br></code> </blockquote><br>  Where N is the number of types in mpl :: vector. <br>  If the exception is known by the filter, it is stored in exception_storage using boost :: enable_current_exception.  The template is controlled by the smart_filter function.  In addition, it catches all other exceptions that were not specified in the type list. <br><br><blockquote> <code><font color="black"><font color="#0000ff">template &lt;typename</font> List&gt; <br> <font color="#0000ff">inline</font> <font color="#0000ff">void</font> smart_filter(exception_storage &amp; storage) <br> { <br> <font color="#0000ff">try</font> <br> { <br> exception_filter&lt;List&gt;::try_(storage); <br> } <br> <font color="#0000ff">catch</font> (...) <br> { <br> storage.store(boost::enable_current_exception(std::runtime_error("unexpected"))); <br> } <br> } <br></font> <br></code> </blockquote><br><h3>  Total </h3><br>  Now it is time to combine this in a wrapper class above the C library.  I will show it schematically, to demonstrate the idea: <br><br><blockquote> <code><font color="black"><font color="#0000ff">template</font> &lt; <font color="#0000ff">typename</font> List&gt; <br> <font color="#0000ff">class</font> MyLib <br> { <br> <font color="#0000ff">public</font> : <br> MyLib() <br> { <br> pureCLibRegisterCallback(&amp;MyLib::callback); <br> pureCLibSetUserData( <font color="#0000ff">this</font> ); <br> } <br> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> doIt() <br> { <br> pureCLibDoIt(); <br> storage_.rethrow(); <br> } <br> <font color="#0000ff">protected</font> : <br> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> callback( <font color="#0000ff">char</font> <font color="#0000ff">const</font> *) = 0; <br> <font color="#0000ff">private</font> : <br> <font color="#0000ff">static</font> <font color="#0000ff">void</font> callback( <font color="#0000ff">void</font> * userData, <font color="#0000ff">char</font> <font color="#0000ff">const</font> * libText) <br> { <br> <font color="#0000ff">if</font> (MyLib&lt;List&gt; * this_ = <font color="#0000ff">static_cast</font> &lt;MyLib&lt;List&gt;*&gt;(userData)) <br> { <br> <font color="#0000ff">try</font> <br> { <br> this_-&gt;callback(libText); <br> } <br> <font color="#0000ff">catch</font> (...) <br> { <br> smart_filter&lt;List&gt;(this_-&gt;storage_); <br> } <br> } <br> } <br> exception_storage storage_; <br> }; <br></font> <br></code> </blockquote><br>  That's all.  Now I will give a small example of use. <br><br><blockquote> <code><font color="black"><font color="#0000ff">struct</font> MyClass <br> : <font color="#0000ff">public</font> MyLib &lt; <br> boost::mpl::vector <br> &lt; <br> std::runtime_error, <br> std::logic_error, <br> std::exception <br> &gt; <br> &gt; <br> { <br> <font color="#0000ff">private</font> : <br> <font color="#0000ff">void</font> callback( <font color="#0000ff">char</font> <font color="#0000ff">const</font> * text) <br> { <br> <font color="#0000ff">throw</font> std::runtime_error(text); <br> } <br> }; <br> <font color="#0000ff">int</font> main() <br> { <br> MyClass my; <br> <br> <font color="#0000ff">try</font> <br> { <br> my.doIt(); <br> } <br> <font color="#0000ff">catch</font> (std::exception <font color="#0000ff">const</font> &amp; e) <br> { <br> std::cout &lt;&lt; e.what() &lt;&lt; std::endl; <br> } <br> <font color="#0000ff">return</font> 0; <br> } <br></font> <br></code> </blockquote><br>  This implementation is intended for single-threaded environments. <br><br></div><p>Source: <a href="https://habr.com/ru/post/100623/">https://habr.com/ru/post/100623/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../100614/index.html">Drivers for fiscal registrars now in standard 1C configuration</a></li>
<li><a href="../100617/index.html">Nokia N8 - terms, price, updates, where it will be sold</a></li>
<li><a href="../100619/index.html">At the Black Hat conference, software for decrypting calls in GSM networks is presented.</a></li>
<li><a href="../100620/index.html">We catch bots that follow links in tweets</a></li>
<li><a href="../100621/index.html">REG.RU congratulates on the Day of the sysadmin and makes a gift!</a></li>
<li><a href="../100626/index.html">Cloud tracking service provider launched</a></li>
<li><a href="../100627/index.html">Linux IC for Hyper-V v2.1 out of Beta</a></li>
<li><a href="../100628/index.html">Making your Chrome plugins multilanguage</a></li>
<li><a href="../100629/index.html">Google translate in action</a></li>
<li><a href="../100632/index.html">Drag & Drop CMS alpha version</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>