<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to debug Android core without UART, JTAG and others</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite often, the developers of kernels for Android devices are faced with the fact that the kernel assembled from source code simply simply does not w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to debug Android core without UART, JTAG and others</h1><div class="post__text post__text-html js-mediator-article">  Quite often, the developers of kernels for Android devices are faced with the fact that the kernel assembled from source code simply simply does not work.  And at the same time, often the developer who assembled the kernel does not have any special tools for debugging.  In this situation, it is quite difficult to do anything without kmsg logs.  Of course, in the Linux kernel, there are already several ways to copy the contents of the kmsg buffer into a special area of ‚Äã‚Äãmemory, but if you are interested in learning about one more method, then I ask for a cat. <br><a name="habracut"></a><br>  Recently, I already described one of the capabilities of <a href="https://habrahabr.ru/post/310886/">the LLCON module</a> , which consisted in displaying kmsg logs on an Android device display.  Now it is time to describe a similar mechanism for copying kmsg logs, since  Displaying logs on the screen is not very convenient for finding all sorts of errors. <br><br>  To begin with, it is worth noting that in most cases, the Android device‚Äôs RAM is not cleared when the SoC is restarted.  This feature uses a mechanism that ensures the appearance of the / proc / last_kmsg file.  But sometimes for a forced SoC restart, you have to hold the Power button for a long time, which entails either a complete or partial change in the contents of the RAM.  In this case, I recommend to connect the device to the PC via a USB cable, so that the contents of the RAM does not change (at least on my device it works). <br><br>  Therefore, at the very first start, the test core should reserve a certain area of ‚Äã‚ÄãRAM for duplicating the contents of the kmsg buffer into it.  I usually allocate 1 MiB of memory for this case, and I use 0x7f200000 as the physical address, since  2 GiB SDRAM is installed on my device. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Those.  On my Android device, to add this functionality, I add an additional parameter to the kernel command line: <br><br><pre><code class="hljs go">llcondmp=<span class="hljs-number"><span class="hljs-number">0x7f</span></span>200000,<span class="hljs-number"><span class="hljs-number">0x100000</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Example of adding the llcondmp parameter to BoardConfig</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">BOARD_KERNEL_CMDLINE := androidboot.hardware=qcom BOARD_KERNEL_CMDLINE += androidboot.selinux=permissive BOARD_KERNEL_CMDLINE += msm_rtb.<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>=<span class="hljs-number"><span class="hljs-number">0x37</span></span> BOARD_KERNEL_CMDLINE += user_debug=<span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> ignore_loglevel BOARD_KERNEL_CMDLINE += llcondmp=<span class="hljs-number"><span class="hljs-number">0x7f200000</span></span>,<span class="hljs-number"><span class="hljs-number">0x100000</span></span></code> </pre> </div></div><br>  The test core, in which there is an LLCON module, should start this parameter at startup and reserve the specified area of ‚Äã‚ÄãRAM.  This will enable a mechanism that will duplicate the kmsg logs in this specially prepared memory area.  Moreover, this duplication will be performed inside the call to the printk function (that is, instantly and transparently).  This circumstance allows you to get kmsg logs even with an emergency restart of the SoC device under test. <br><br>  After restarting the SoC, you need to somehow read the contents of this memory area.  For this, the bootloader must load something stable working, which may well be <a href="https://en.wikipedia.org/wiki/TWRP">TWRP</a> , based on the sink core.  But this TWRP should be able to back up the same area in RAM so that its contents remain intact.  Those.  You must first make and flash a special version of TWRP. <br><br>  In order for the core used in TWRP to reserve a section 0x7f200000 ... 0x7f2FFFFF in RAM, you need to edit the DeviceTree of this core.  The editing process of DeviceTree itself requires writing a separate article, so I‚Äôll just give the change in the dts file itself: <br><br><pre> <code class="hljs ruby">/dts-v1/; <span class="hljs-regexp"><span class="hljs-regexp">/memreserve/</span></span> <span class="hljs-number"><span class="hljs-number">0x7f200000</span></span> <span class="hljs-number"><span class="hljs-number">0x100000</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">/*   */</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>/ <span class="hljs-string"><span class="hljs-string">"msm8226-v2.dtsi"</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>/ <span class="hljs-string"><span class="hljs-string">"msm8226-qrd.dtsi"</span></span></code> </pre> <br>  But the TWRP redesign is not complete.  You need to add the viewmem utility to ramdisk, which allows you to flush the contents of physical memory to disk.  Sources of this utility can be downloaded here: <a href="https://github.com/jsr-d10/android_device_jsr_d10f/tree/cm-11.0/viewmem">viewmem</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Where can I get a ready binar viewmem</b> <div class="spoiler_text">  If you don‚Äôt want to bother with assembling TWRP from source, then I advise you to add the source viewmem to the same project that is used to build the test core.  And the ready-made binary file viewmem can be simply embedded into the desired TWRP image. </div></div><br>  After preparing a special version of the TWRP, you need to pour it into the device.  And for testing custom kernels, I advise you to upload this TWRP to the ‚Äúboot‚Äù section, since  it is on its contents that the bootloader transfers control by default.  I will not begin to describe methods of filling in images of sections here, so that they would not get out of the subject of this publication at all. <br><br>  First of all, it‚Äôs worth trying out the work of the special version of TWRP installed in the device.  You can even test the viewmem utility (see the usage example below).  I also note that in order to restart this TWRP, select the ‚ÄúSystem‚Äù item in the ‚ÄúRestart‚Äù menu section, since  TWRP is in the "boot" section. <br><br>  Now we have a special TWRP and test core with the LLCON module, which either hangs or causes the SoC to rebuild.  And this is quite enough to find the reasons for this behavior of the test core.  I recommend to upload the image of the tested kernel to the ‚Äúrecovery‚Äù section.  Therefore, to start testing the problem kernel, select the ‚ÄúRecovery‚Äù item in the ‚ÄúRestart‚Äù menu.  This will mean that when the device is rebooted, the bootloader will transfer control to the contents of the ‚Äúrecovery‚Äù section.  Next, you should wait for an error to occur in the tested core.  If the error itself causes the SoC restart, then nothing needs to be done, since  the previously prepared TWRP should automatically load.  If the error causes a hang, then hold down the Power button and wait for a hard restart (most importantly, do not forget about the USB cable). <br><br>  After booting into TWRP, first of all you need to copy kmsg logs from memory to disk using ADB connection: <br><br><pre> <code class="bash hljs">adb shell viewmem 0x7f200000 0x100000 &gt; /sdcard/kmsg_llcon.txt <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br>  Now you need to copy the kmsg_llcon.txt file from the SD card and start exploring its contents. <br><br>  I have already used this debugging method three times: <br><br><ul><li>  creation of a custom kernel version 3.4 for the <a href="http://www.devicespecifications.com/en/model/b67a2c25">Innos D10F device</a> (2014); </li><li>  creation of a custom kernel version 3.4 for the <a href="http://www.devicespecifications.com/en/model/6f1b2d0b">Innos D9</a> device (2015); </li><li>  Creating a custom kernel version 3.10 for the <a href="http://www.devicespecifications.com/en/model/b67a2c25">Innos D10F device</a> (current project). </li></ul><br>  So when developing Android cores, you can completely do without UART, <a href="https://software.intel.com/ru-ru/articles/android-intel-atom-jtag">JTAG</a> , <a href="http://infocenter.arm.com/help/index.jsp%3Ftopic%3D/com.arm.doc.dui0203j/Cacfgdig.html">EmbeddedICE DCC</a> and other tools used for debugging. <br><br>  Note: look for the source code of the LLCON module in my last publication " <a href="https://habrahabr.ru/post/310886/">Replace the boot-animation of Android devices with the flashing Linux kernel logs</a> ". </div><p>Source: <a href="https://habr.com/ru/post/311264/">https://habr.com/ru/post/311264/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311252/index.html">Applicants for the Nobel Prize 2016</a></li>
<li><a href="../311254/index.html">‚ÄúGoing onto the stage is my way of keeping up with the technologies‚Äù: interview with Baruh Sadogursky from JFrog</a></li>
<li><a href="../311256/index.html">Using a single IoC Container as part of an HTTP request between the Web API and the OWIN Middleware</a></li>
<li><a href="../311258/index.html">Raising the stakes: Who should get a share in your startup and which one?</a></li>
<li><a href="../311262/index.html">JSON serializer on fast templates</a></li>
<li><a href="../311266/index.html">In search of mutual understanding - 2: ‚ÄúBad advice‚Äù for my IT colleagues</a></li>
<li><a href="../311268/index.html">[systemd / udev] ppp: correct autostart of the system wide daemon</a></li>
<li><a href="../311270/index.html">Boilerplate for WordPress</a></li>
<li><a href="../311278/index.html">Three steps that will increase the noise of the digital converter</a></li>
<li><a href="../311280/index.html">Pro release and development of True Image 2017 - all hardcore features are in place</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>