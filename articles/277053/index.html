<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What does DEFAULT TRACE conceal in itself?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The first job is often remembered ... Mediocre office, Monique 943N and Pentium D heater underfoot. As Boris appeared out of nowhere (no ... not Boris...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What does DEFAULT TRACE conceal in itself?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c20/dff/841/c20dff841cb74ee68676f2499f76dc45.jpg"><br><br>  The first job is often remembered ... Mediocre office, Monique <i>943N</i> and <i>Pentium D</i> heater underfoot.  As Boris appeared out of nowhere (no ... not Boris "Razor") with a ruler in his hands and insistently asked not to hurt the server. <br><br>  It was in those days when I first met the profiler.  User traces turned out to be very useful when debugging applications and searching for slow queries.  Then for myself I discovered <i>DMV</i> and <i>XEvents</i> ... and I began to use the profiler less often.  The reason for this act is simple - traces are very resource-intensive. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, this functionality should not be given prematurely to anathema.  Starting with the <i>2005</i> version, when installing <i>SQL Server</i> , a lightweight system trail is created by default, which stores a lot of useful information. <br><a name="habracut"></a><br>  It is located in the folder where <i>SQL Server is</i> installed and consists of five files with a <i>trc</i> extension.  Each time you start the server, a new file is automatically created for tracing, and the oldest is overwritten.  The recording of new events always goes to the most recent file, the size of which is limited to 20 MB.  When the size is exceeded, a new file is created by the machine.  Change this behavior is impossible. <br><br>  It is only allowed to disable or enable this functionality: <br><br><pre><code class="html hljs xml">EXEC sys.sp_configure 'show advanced options', 1 GO RECONFIGURE WITH OVERRIDE GO EXEC sys.sp_configure 'default trace enabled', 0 GO RECONFIGURE WITH OVERRIDE GO</code> </pre> <br>  You can check that the default tracing is enabled by the following query: <br><br><pre> <code class="html hljs xml">SELECT name, value FROM sys.configurations WHERE configuration_id = 1568</code> </pre><br>  Path to default trail: <br><br><pre> <code class="html hljs xml">SELECT [path], start_time, last_event_time, event_count FROM sys.traces WHERE is_default = 1</code> </pre><br>  And now we start the most interesting ... Let's see what kind of events can be stored in the default trace: <br><br><pre> <code class="html hljs xml">SELECT e.trace_event_id, e.name, c.category_id, c.name FROM sys.trace_categories c JOIN sys.trace_events e ON c.category_id = e.category_id</code> </pre><br><pre> <code class="html hljs xml">trace_event_id name category_id name -------------- -------------------------- ----------- ----------------------------------- 196 CLR 20 Assembly Load 92 Database 2 Data File Auto Grow 93 Database 2 Log File Auto Grow 94 Database 2 Data File Auto Shrink 95 Database 2 Log File Auto Shrink 79 Errors and Warnings 3 Missing Column Statistics 80 Errors and Warnings 3 Missing Join Predicate 67 Errors and Warnings 3 Execution Warnings 69 Errors and Warnings 3 Sort Warnings 55 Errors and Warnings 3 Hash Warning 21 Errors and Warnings 3 EventLog 22 Errors and Warnings 3 ErrorLog 213 Errors and Warnings 3 Database Suspect Data Page 214 Errors and Warnings 3 CPU threshold exceeded 46 Objects 5 Object:Created 47 Objects 5 Object:Deleted 164 Objects 5 Object:Altered ...</code> </pre><br>  And let's take a look at small examples of the practical benefits of information from the default trace. <br><br>  <b>1. Auto Grow Events</b> <br><br>  I hope it is no secret that to perform any transaction requires a certain disk space.  In the data file or log.  We will not elaborate ... but generally, if there is not enough space, then the file will automatically grow.  At this point, the file is locked and <i>SQL Server</i> will wait until the disk subsystem performs the necessary operations to allocate disk space. <br><br>  By default, <i>SQL Server</i> initializes the new disk space with zeros.  For data files, this behavior can be disabled by using <a href="https://habrahabr.ru/post/270699/"><i>Instant File Initialization</i></a> .  But for log files, initialization will still occur and it is definitely slow.  Therefore, it is recommended to keep track of <i>Auto Grow</i> events on an ongoing basis: <br><br><pre> <code class="html hljs xml">SELECT StartTime , Duration = Duration / 1000 , DatabaseName = DB_NAME(DatabaseID) , [FileName] , GrowType = CASE WHEN EventClass = 92 THEN 'DATA' ELSE 'LOG' END FROM sys.traces i CROSS APPLY sys.fn_trace_gettable([path], DEFAULT) t WHERE t.EventClass IN ( 92, -- Data File Auto Grow 93 -- Log File Auto Grow ) AND i.is_default = 1</code> </pre><br>  And if their number increases dramatically: <br><br><pre> <code class="html hljs xml">StartTime Duration DatabaseName FileName GrowType -------------------- ----------- ---------------------- -------------------------- -------- 2016-01-16 02:52:48 36 tempdb templog LOG 2016-01-16 02:52:49 50 tempdb tempdev DATA 2016-01-16 02:52:50 216 tempdb tempdev DATA 2016-01-16 02:52:51 43 tempdb tempdev DATA 2016-01-16 02:52:52 760 tempdb tempdev DATA 2016-01-16 02:52:54 270 tempdb tempdev DATA 2016-01-16 02:52:55 273 tempdb tempdev DATA 2016-01-16 02:52:56 286 tempdb tempdev DATA 2016-01-16 02:52:58 206 tempdb tempdev DATA 2016-01-16 02:52:59 513 tempdb tempdev DATA 2016-01-16 02:53:01 363 tempdb tempdev DATA 2016-01-16 02:53:03 300 tempdb tempdev DATA 2016-01-16 02:53:05 303 tempdb tempdev DATA 2016-01-16 02:53:08 200 tempdb tempdev DATA 2016-01-16 02:53:10 60 tempdb tempdev DATA 2016-01-16 02:53:12 350 tempdb tempdev DATA 2016-01-16 02:53:15 370 tempdb tempdev DATA 2016-01-16 02:53:17 243 tempdb tempdev DATA 2016-01-16 02:53:21 446 tempdb tempdev DATA 2016-01-16 02:53:25 163 tempdb tempdev DATA 2016-01-16 02:53:30 286 tempdb tempdev DATA 2016-01-16 02:53:36 426 tempdb tempdev DATA 2016-01-16 02:53:42 376 tempdb tempdev DATA 2016-01-16 02:53:49 120 tempdb tempdev DATA 2016-01-16 02:53:58 200 tempdb tempdev DATA 2016-01-16 02:54:06 186 tempdb tempdev DATA 2016-01-16 02:54:17 43 tempdb tempdev DATA 2016-01-16 02:54:27 6 tempdb tempdev DATA 2016-01-16 02:54:42 3 tempdb tempdev DATA 2016-01-16 02:55:04 30 tempdb tempdev DATA 2016-01-16 14:19:47 63 AdventureWorks2012 AdventureWorks2012_Log LOG 2016-01-16 14:19:47 20 AdventureWorks2012 AdventureWorks2012_Log LOG 2016-01-16 16:51:32 100 tempdb tempdev DATA 2016-02-16 17:31:02 66 tempdb templog LOG ...</code> </pre><br>  This can cause not only file fragmentation on the disk, but also significant delays in the execution of queries: <br><br><pre> <code class="html hljs xml">SELECT GrowType = CASE WHEN EventClass = 92 THEN 'DATA' ELSE 'LOG' END , GrowCount = COUNT(1) , Duration = SUM(Duration) / 1000 FROM sys.traces i CROSS APPLY sys.fn_trace_gettable([path], DEFAULT) t WHERE t.EventClass IN (92, 93) AND i.is_default = 1 AND t.DatabaseID = DB_ID('tempdb') GROUP BY EventClass</code> </pre><br><pre> <code class="sql hljs">GrowType GrowCount Duration <span class="hljs-comment"><span class="hljs-comment">-------- ----------- -------------------- DATA 36 7296 LOG 2 102</span></span></code> </pre><br>  Let's look at the settings of the problem database: <br><br><pre> <code class="html hljs xml">USE tempdb GO SELECT d.type_desc , d.name , d.physical_name , current_size_mb = ROUND(d.size * 8. / 1000, 0) , initial_size_mb = ROUND(m.size * 8. / 1000, 0) , auto_grow = CASE WHEN d.is_percent_growth = 1 THEN CAST(d.growth AS VARCHAR(10)) + '%' ELSE CAST(ROUND(d.growth * 8. / 1000, 0) AS VARCHAR(10)) + 'MB' END FROM sys.database_files d JOIN sys.master_files m ON d.[file_id] = m.[file_id] WHERE m.database_id = DB_ID('tempdb')</code> </pre><br>  The initial database size is 8 MB for the data file and 1 MB for the log: <br><br><pre> <code class="html hljs xml">type name physical_name current_size_mb initial_size_mb auto_grow ----- ---------- ------------------------------ ------------------ ------------------ --------- ROWS tempdev D:\SQL_2012\DATA\tempdb.mdf 258.000000 8.000000 10% LOG templog D:\SQL_2012\DATA\templog.ldf 3.000000 1.000000 1MB</code> </pre><br>  ... which is clearly not enough when compared with the current size.  Moreover, it must be remembered that with each restart of <i>SQL Server,</i> <i>tempdb is</i> recreated.  In the bottom line, with the next start we will again get a 9 MB file, delays in executing requests and a new batch of messages in the default trace. <br><br>  What is the way out of this situation?  Keep track of file sizes and reserve free space for them: <br><br><pre> <code class="html hljs xml">SELECT s.[file_id] , s.name , size = CAST(s.size * 8. / 1024 AS DECIMAL(18,2)) , space_used = CAST(t.space_used * 8. / 1024 AS DECIMAL(18,2)) , free_space = CAST((s.size - t.space_used) * 8. / 1024 AS DECIMAL(18,2)) , used_percent = CAST(t.space_used * 100. / s.size AS DECIMAL(18,2)) , s.max_size , s.growth , s.is_percent_growth FROM sys.database_files s CROSS APPLY ( SELECT space_used = FILEPROPERTY(s.name, 'SpaceUsed') ) t</code> </pre><br>  <b>2. Auto Shrink Events</b> <br><br>  Recently I wrote that the <a href="https://habrahabr.ru/post/275873/"><i>AUTO_CLOSE option</i></a> decreases performance.  So <i>AUTO_SHRINK gets</i> even worse ... Every 30 minutes, <i>SQL Server</i> tries to truncate free space in the database files.  This process is quite resource-intensive and can lead to disk file fragmentation.  When files are truncated, high index fragmentation occurs, which increases logical reads and reduces query performance. <br><br>  Imagine a simple situation ... Delete the data from the table - truncating the file.  We inserted new data - there was not enough space and <i>SQL Server</i> had to increase the file size.  Delete the data and again everything in a new way ... <br><br><pre> <code class="html hljs xml">SELECT StartTime , EndTime , Duration = Duration / 1000 , DatabaseName = DB_NAME(DatabaseID) , [FileName] , GrowType = CASE WHEN EventClass = 94 THEN 'DATA' ELSE 'LOG' END , NTDomainName , ApplicationName , LoginName , TextData , IsSystem FROM sys.traces i CROSS APPLY sys.fn_trace_gettable([path], DEFAULT) t WHERE t.EventClass IN ( 94, -- Data File Auto Shrink 95 -- Log File Auto Shrink ) AND i.is_default = 1</code> </pre><br><pre> <code class="html hljs xml">StartTime Duration DatabaseName FileName GrowType ------------------- ----------- ------------------------- ------------------------ -------- 2016-02-10 11:57:54 116 AdventureWorks2012 AdventureWorks2012_Log LOG 2016-02-10 14:58:21 113 AdventureWorks2012 AdventureWorks2012_Log LOG 2016-02-10 19:30:02 113 AdventureWorks2012 AdventureWorks2012_Log LOG 2016-02-10 21:00:26 16 AdventureWorks2012 AdventureWorks2012_Log LOG</code> </pre><br>  Definitely advise this option to disable: <br><br><pre> <code class="html hljs xml">SELECT 'ALTER DATABASE ' + QUOTENAME(name) + ' SET AUTO_SHRINK OFF WITH NO_WAIT;' FROM sys.databases WHERE is_auto_shrink_on = 1</code> </pre><br>  <b>3. DBCC Events</b> <br><br>  Another utility of default tracing is the ability to track who and when launched the <i>DBCC</i> commands.  You shouldn't usually blame <i>DBCC CHECKDB</i> , but if someone in production is crazy about performing: <br><br><pre> <code class="html hljs xml">DBCC SHRINKDATABASE DBCC FREEPROCCACHE DBCC DROPCLEANBUFFERS</code> </pre><br>  then you can easily trace it: <br><br><pre> <code class="html hljs xml">SELECT t.TextData, t.ApplicationName, t.LoginName, t.StartTime FROM sys.traces i CROSS APPLY sys.fn_trace_gettable([path], DEFAULT) t WHERE i.is_default = 1 AND t.EventClass = 116 -- Audit DBCC Event AND t.ApplicationName IS NOT NULL</code> </pre><br>  and with whom to conduct a preventive conversation about the benefits of standing in a corner on buckwheat: <br><br><pre> <code class="html hljs xml">TextData ApplicationName LoginName StartTime ----------------------- ------------------ ----------- ----------------------- DBCC SHRINKDATABASE(1) SSMS - Query PC\IgorS 2016-02-10 20:03:46.307 DBCC FREEPROCCACHE SSMS - Query PC\IgorS 2016-02-10 20:03:43.430 DBCC DROPCLEANBUFFERS SSMS - Query PC\IgorS 2016-02-10 20:03:44.767</code> </pre><br>  <b>4. Errors and Warnings Events</b> <br><br>  In a situation where <i>SQL Server</i> does not have enough free memory that is required to execute a query, the processing of the results of some statements will occur in <i>tempdb</i> .  The same behavior will be when the optimizer has made an incorrect estimate of the expected number of rows. <br><br>  Let's try to write a request that will call <i>spills</i> in <i>tempdb</i> : <br><br><pre> <code class="html hljs xml">SELECT * FROM Sales.SalesOrderHeader WHERE DueDate &gt; ShipDate ORDER BY OrderDate DESC</code> </pre><br><img src="https://habrastorage.org/files/f20/326/b8d/f20326b8dc134c298e206ab2b5bd4e2e.png"><br><br>  Thanks to the message from the default we can track such requests: <br><br><pre> <code class="html hljs xml">SELECT TOP(10) EventName = e.name , t.TextData , t.ApplicationName , t.LoginName , t.StartTime , DatabaseName = DB_NAME(t.DatabaseID) FROM sys.traces i CROSS APPLY sys.fn_trace_gettable([path], DEFAULT) t JOIN sys.trace_events e ON e.trace_event_id = t.EventClass WHERE i.is_default = 1 AND e.category_id = 3 ORDER BY t.StartTime DESC</code> </pre><br><pre> <code class="html hljs xml">EventName ApplicationName LoginName StartTime DatabaseName ------------------ ----------------- ------------- ----------------------- --------------------- Sort Warnings SSMS - Query PC\SergeyS 2016-02-11 13:06:44.867 AdventureWorks2012</code> </pre><br>  Find their execution plan and try to optimize the query: <br><br><pre> <code class="html hljs xml">USE AdventureWorks2012 GO SELECT TOP(5) p.query_plan , e.[text] , qyery_cost = p.query_plan.value( '(/*:ShowPlanXML/*:BatchSequence/*:Batch/*:Statements/*:StmtSimple/@StatementSubTreeCost)[1]', 'FLOAT' ) , s.last_execution_time , last_exec_ms = s.last_worker_time / 1000 , s.execution_count FROM sys.dm_exec_query_stats s CROSS APPLY sys.dm_exec_query_plan(s.plan_handle) p CROSS APPLY sys.dm_exec_sql_text(s.plan_handle) e WHERE e.[text] NOT LIKE '%sys%' AND s.last_execution_time &gt;= DATEADD(MS, -2500, '2016-02-10 19:41:45.983') AND e.[dbid] = DB_ID() ORDER BY s.last_execution_time</code> </pre><br><pre> <code class="html hljs xml">query_plan text qyery_cost execution_time last_exec_ms ----------------- -------------------------------- ----------- ------------------- -------------- <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ShowPlanXML</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SELECT</span></span></span><span class="hljs-tag"> * </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">FROM</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Sales.SalesOrde...</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span><span class="hljs-tag">,</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">10126</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">2016-02-11</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">13:06:44</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">1538</span></span></span></span></code> </pre><br>  By the way, the current execution plans are not available through the <i>DMV</i> .  They can be obtained only at the <i>Post Query Execution Showplan stage</i> , through the corresponding <i>Trace event</i> , or by using the <i>SET STATISTICS XML ON</i> command.  Starting with <i>SQL Server 2012</i> , a new <i>XEvent has been</i> added specifically for this purpose - <i>post_query_execution_showplan</i> . <br><br>  I am personally pleased that you can track all sorts of warnings: <br><br><pre> <code class="html hljs xml">SELECT DISTINCT d.SalesOrderID, d.UnitPrice, h.OrderDate FROM Sales.SalesOrderHeader h JOIN Sales.SalesOrderDetail d ON h.SalesOrderID = d.SalesOrderID WHERE h.DueDate &gt; h.ShipDate</code> </pre><br><img src="https://habrastorage.org/files/dd3/4e2/e43/dd34e2e43c3b49de837e99fc0b8c2d2a.png"><br><br><pre> <code class="html hljs xml">EventName ApplicationName LoginName StartTime DatabaseName ---------------- ----------------- ------------- ----------------------- --------------------- Hash Warning SSMS - Query PC\SergeyS 2016-02-11 13:14:44.433 AdventureWorks2012</code> </pre><br>  For example, when you mistakenly forgot to specify the fields for which the connection is: <br><br><pre> <code class="html hljs xml">SELECT * FROM Sales.Currency c, Sales.CountryRegionCurrency r --WHERE c.CurrencyCode = r.CurrencyCode</code> </pre><br><img src="https://habrastorage.org/files/f8f/1d6/202/f8f1d62028cb4914b5669e9173b24e7a.png"><br><br><pre> <code class="html hljs xml">EventName ApplicationName LoginName StartTime DatabaseName ----------------------- ----------------- ------------- ------------------- --------------------- Missing Join Predicate SSMS - Query PC\SergeyS 2016-02-11 13:18:20 AdventureWorks2012</code> </pre><br>  or, when there is no statistics on the column that is filtered: <br><br><pre> <code class="html hljs xml">SELECT DatabaseLogID FROM dbo.DatabaseLog WHERE PostTime = '2012-03-14 13:14:18.847'</code> </pre><br><img src="https://habrastorage.org/files/214/d00/4dd/214d004dd08741369f7b03da4b035682.png"><br><br><pre> <code class="html hljs xml">EventName TextData DatabaseName --------------------------- ------------------------------------------ -------------------- Missing Column Statistics NO STATS:([dbo].[DatabaseLog].[PostTime]) AdventureWorks2012</code> </pre><br>  <b>5. Object Events</b> <br><br>  In the default trace, you can track the creation and deletion of objects: <br><br><pre> <code class="html hljs xml">USE [master] GO IF DB_ID('test') IS NOT NULL DROP DATABASE [test] GO CREATE DATABASE [test] GO USE [test] GO CREATE TABLE dbo.tbl (ID INT) GO ALTER TABLE dbo.tbl ADD Col VARCHAR(20) GO CREATE UNIQUE CLUSTERED INDEX ix ON dbo.tbl (ID) GO USE [master] GO IF DB_ID('test') IS NOT NULL DROP DATABASE [test] GO</code> </pre><br><pre> <code class="html hljs xml">SELECT EventType = e.name , t.DatabaseName , t.ApplicationName , t.LoginName , t.StartTime , t.ObjectName , ObjectType = CASE t.ObjectType WHEN 8259 THEN 'Check Constraint' WHEN 8260 THEN 'Default Constraint' WHEN 8262 THEN 'Foreign Key' WHEN 8272 THEN 'Stored Procedure' WHEN 8274 THEN 'Rule' WHEN 8275 THEN 'System Table' WHEN 8276 THEN 'Server Trigger' WHEN 8277 THEN 'Table' WHEN 8278 THEN 'View' WHEN 8280 THEN 'Extended Stored Procedure' WHEN 16724 THEN 'CLR Trigger' WHEN 16964 THEN 'Database' WHEN 17222 THEN 'FullText Catalog' WHEN 17232 THEN 'CLR Stored Procedure' WHEN 17235 THEN 'Schema' WHEN 17985 THEN 'CLR Aggregate Function' WHEN 17993 THEN 'Inline Table-valued SQL Function' WHEN 18000 THEN 'Partition Function' WHEN 18004 THEN 'Table-valued SQL Function' WHEN 19280 THEN 'Primary Key' WHEN 19539 THEN 'SQL Login' WHEN 19543 THEN 'Windows Login' WHEN 20038 THEN 'Scalar SQL Function' WHEN 20051 THEN 'Synonym' WHEN 20821 THEN 'Unique Constraint' WHEN 21075 THEN 'Server' WHEN 21076 THEN 'Transact-SQL Trigger' WHEN 21313 THEN 'Assembly' WHEN 21318 THEN 'CLR Scalar Function' WHEN 21321 THEN 'Inline scalar SQL Function' WHEN 21328 THEN 'Partition Scheme' WHEN 21333 THEN 'User' WHEN 21572 THEN 'Database Trigger' WHEN 21574 THEN 'CLR Table-valued Function' WHEN 21587 THEN 'Statistics' WHEN 21825 THEN 'User' WHEN 21827 THEN 'User' WHEN 21831 THEN 'User' WHEN 21843 THEN 'User' WHEN 21847 THEN 'User' WHEN 22601 THEN 'Index' WHEN 22611 THEN 'XMLSchema' WHEN 22868 THEN 'Type' END FROM sys.traces i CROSS APPLY sys.fn_trace_gettable([path], DEFAULT) t JOIN sys.trace_events e ON t.EventClass = e.trace_event_id WHERE e.name IN ('Object:Created', 'Object:Deleted', 'Object:Altered') AND t.ObjectType != 21587 AND t.DatabaseID != 2 AND i.is_default = 1 AND t.EventSubClass = 1</code> </pre><br><pre> <code class="html hljs xml">EventType DatabaseName ApplicationName StartTime ObjectName ObjectType ---------------- -------------- ---------------- ----------------------- ------------- ------------ Object:Created test SSMS - Query 2016-02-11 13:36:46.727 NULL Database Object:Created test SSMS - Query 2016-02-11 13:36:46.760 tbl Table Object:Altered test SSMS - Query 2016-02-11 13:36:46.803 tbl Table Object:Created test SSMS - Query 2016-02-11 13:36:46.837 ix Index Object:Deleted test SSMS - Query 2016-02-11 13:36:56.347 NULL Database</code> </pre><br>  <b>6. Server Events</b> <br><br>  Also, through the default trace, there is an opportunity to keep track of who made backups and restores the bases when it was done: <br><br><pre> <code class="html hljs xml">SELECT CASE WHEN t.EventSubClass = 1 THEN 'BACKUP' ELSE 'RESTORE' END, t.TextData, t.ApplicationName, t.LoginName, t.StartTime FROM sys.traces i CROSS APPLY sys.fn_trace_gettable([path], DEFAULT) t WHERE i.is_default = 1 AND t.EventClass = 115 -- Audit Backup/Restore Event</code> </pre><br><pre> <code class="html hljs xml">TextData ApplicationName LoginName StartTime -------------------- ------------------------------- ----------- ------------------------- BACKUP DATABASE SSMS - Query PC\SergeyS 2016-01-21 13:05:26.390 RESTORE DATABASE dbForge Studio for SQL Server PC\SergeyS 2016-01-22 12:46:45.717 BACKUP DATABASE SQLCMD sa 2016-01-24 10:16:40.317</code> </pre><br>  Or track the memory usage of <i>SQL Server</i> nd: <br><br><pre> <code class="html hljs xml">SELECT t.StartTime , [Type] = CASE WHEN EventSubClass = 1 THEN 'UP' ELSE 'DOWN' END , t.IntegerData FROM sys.traces i CROSS APPLY sys.fn_trace_gettable([path], DEFAULT) t WHERE t.EventClass = 81 -- Server Memory Change AND i.is_default = 1</code> </pre><br><pre> <code class="html hljs xml">StartTime Type IntegerData ------------------------ ----- ----------- 2016-02-10 02:52:42.887 UP 191 2016-02-10 02:53:00.640 UP 371 2016-02-10 02:53:34.917 UP 734 2016-02-10 02:53:52.140 UP 916 2016-02-10 10:05:00.027 DOWN 736 2016-02-10 10:17:17.417 UP 921 2016-02-10 11:52:14.930 DOWN 735 2016-02-10 12:00:32.577 DOWN 553 2016-02-10 13:06:11.540 UP 751 2016-02-10 15:11:10.487 UP 936 2016-02-10 15:15:26.107 DOWN 714</code> </pre><br>  <b>Small afterword</b> <br><br>  Default tracing is powerful enough to track server status.  Of course, it has many drawbacks, for example, the mentioned 20 MB limit and the statement from <i>Microsoft</i> that this functionality has been deprecated since <i>SQL Server 2008</i> .  But nevertheless, sometimes the default trace can be very useful at the stage of initial diagnostics of problems with <i>SQL Server</i> .  I hope my examples could show it clearly. <br><br>  Everything was tested on <i>Microsoft SQL Server 2012 (SP3) (KB3072779) - 11.0.6020.0 (X64)</i> . <br><br>  If you want to share this article with an English-speaking audience: <br>  <a href="http://www.codeproject.com/Articles/1085631/Hidden-gems-of-DEFAULT-TRACE-in-SQL-Server">Hidden gems of DEFAULT TRACE in SQL Server</a> </div><p>Source: <a href="https://habr.com/ru/post/277053/">https://habr.com/ru/post/277053/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277043/index.html">Ariadna. Why do I need another geocoder for OSM?</a></li>
<li><a href="../277045/index.html">Announcement WordPress Meetup # 2</a></li>
<li><a href="../277047/index.html">Application developers do not care about user safety, which leads to data leakage (with java-code examples)</a></li>
<li><a href="../277049/index.html">Test the training of visual attention</a></li>
<li><a href="../277051/index.html">Report from Tarantool Meetup January 28</a></li>
<li><a href="../277055/index.html">Getting rid of Visual Basic</a></li>
<li><a href="../277057/index.html">Golden App 2016 mobile app competition has started</a></li>
<li><a href="../277067/index.html">Reverse engineering and slowdown "Kazakov"</a></li>
<li><a href="../277069/index.html">Neurorevolution in heads and villages</a></li>
<li><a href="../277077/index.html">Near-architecture arguments or the results of a single dispute</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>