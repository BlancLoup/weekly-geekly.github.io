<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Custom authentication in symfony 2.0 projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of this article is to talk about the organization of non-standard authentication for projects based on Symfony 2.0. 

 Why this may be nee...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Custom authentication in symfony 2.0 projects</h1><div class="post__text post__text-html js-mediator-article">  The purpose of this article is to talk about the organization of non-standard authentication for projects based on Symfony 2.0. <br><br><h4>  Why this may be needed? </h4><br>  This may be necessary in the case when it is difficult to organize access to user accounts via ORM, or authorization is carried out using external resources, such as social networks. <br><a name="habracut"></a><br><br><h4>  Task </h4><br>  For me, the task looked like this: I had a project on Symfony 1.4 and, with the release of the second version, ‚Äúmy hands itched‚Äù to translate it to 2.0, without changing the foundation of the system, i.e.  database and the principle of access to it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The data in my project is stored in MongoDB, and access was carried out through its own simplest wrapper, which was able to bind classes to the necessary collections.  Attaching a wrapper to symfony 2 was easy. <br><br>  The task in terms of user authorization was initially limited to obtaining data from MongoDB.  The task of improvement is to implement the possibility of authorization for social network accounts. <br><br><h4>  A bit of theory </h4><br>  Before you start working on your own security extensions for Symfony 2.0, you need to understand how the framework works in general, and the Security component in particular. <br><br>  I think that everyone who was interested in the second version of the framework is aware that incoming requests are treated as events or events, and are consistently received for processing by listeners.  In the course of this processing, the answer appears (the same response), returned to the client. <br><br>  In general, everything happens like this: <br><ol><li>  the kernel receives the request; </li><li>  the request is processed by the security system; </li><li>  the request processes the ‚Äúrouter‚Äù, the requested controller is determined; </li><li>  Action and related response preparation processes are performed. </li><li>  the generated response passes its part of the path through the handlers, where the last adjustments are made. </li></ol><br>  We are interested in stage 2 and, in part, 3. <br><br>  How the security system works is a separate song.  The process looks like this: <br><ol><li>  The general security listener receives the request event and distributes it to the ‚Äúchild‚Äù authentication listeners. </li><li>  listeners form a token and try to authorize it with an AuthenticationManager; </li><li>  AuthenticationManager selects the appropriate authentication provider and returns it token for verification. </li><li>  The authentication provider returns to the manager, and then, in turn, the listener is an authorized (or unauthorized) token.  At this stage, UserProvider is activated, which works with user data. </li><li>  The listener, depending on the result returned by the AuthenticationManager and its own code, either ‚Äúslips‚Äù the authorized token SecurityContex, or forms a response (Response), or does both.  If the listener generates a response, the request event will not go to the ‚Äúrouter‚Äù for processing and there will be no call to the controller. </li><li>  then authorization takes place, I did not understand this and subsequent stages, but the principle is generally similar to authentication, as I understood it. </li></ol><br>  In comparison with 1.x, where all the described processes occurred directly in the Actions, the scheme seems to be overloaded, unnecessarily complex.  However, this structure gives us the opportunity not to do all the work of organizing security in our application, allowing you to change only the necessary part, and entrust the rest of the work to the framework. <br><br><h4>  Step 0 - we study the documentation. </h4><br>  Whatever you want to get from the security system of symfony 2.0, before you get down to business you need to update the relevant documentation.  Do not do without the chapters of the <a href="http://symfony.com/doc/current/book/index.html">Books</a> <a href="http://symfony.com/doc/current/book/security.html">Security</a> and <a href="http://symfony.com/doc/current/book/service_container.html">Service Container</a> .  If you want to read in your own language, you can study this <a href="http://habrahabr.ru/blogs/symfony/128159/">article</a> . <br><br>  In fact, if you do not want to receive information about users from ‚Äústrange‚Äù sources, then it‚Äôs not necessary to read further.  Working with the base through Doctrine is beautifully described in the listed articles. <br><br><h4>  Step 1 - its own user base. </h4><br>  Symfony 2.0 out of the box has a fairly large set of authorization tools.  There is, as the simplest option with authorization for a username / password pair, and more exotic options, such as authorization by certificates. <br><br>  First of all, I need to organize the most common authorization by login and password, but take data from my own database on MongoDB and through my own wrapper. <br><br>  In fact, this is the easiest part of the task.  First we need a class that implements the UserInterface interface. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Models</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Mh</span></span>\<span class="hljs-title"><span class="hljs-title">Mongo</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>\<span class="hljs-title"><span class="hljs-title">Base</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">AdvancedUserInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">UserInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRoles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;credentials; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;passw; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSalt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;salt; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUsername</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;uname; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eraseCredentials</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserInterface $user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getUsername() === $user-&gt;getUsername(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;uname; } }</code> </pre> <br><br>  The class is very simple, in this case, all the functionality for accessing the document data from MongoDB is mapped to the parent class, consideration of which is not the topic of this article.  The implementation of the UserInterface interface provides the framework's security system with the ability to retrieve some of the necessary user data and compare user objects with each other. <br><br>  It is worth paying attention to the getRoles method, in the article above, this method returns the entities Role, we have the same output array with simple strings, which is acceptable for the system.  If we consider roles as groups that may contain a variable set of rights, then we need to return objects compatible with RoleInterface, in our case, the role is a set of rights, so we have enough string values. <br><br>  Next, you need a class that implements the UserProviderInterface interface, which allows you to get objects of the above class. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Mh</span></span>\<span class="hljs-title"><span class="hljs-title">Mongo</span></span>\<span class="hljs-title"><span class="hljs-title">MongoBundle</span></span>\<span class="hljs-title"><span class="hljs-title">ConnectionManager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">MyBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Models</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">UserInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">UserProviderInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">Exception</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">UsernameNotFoundException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">UnsupportedUserException</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserProviderInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $collection; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $db; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $field; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $logger; <span class="hljs-comment"><span class="hljs-comment">//  ,  ,      //  ,          // . public function __construct(array $params, ConnectionManager $cm, LoggerInterface $logger) { //         $this-&gt;db = $cm-&gt;getConnection($params['confname']); $this-&gt;collection = $this-&gt;db-&gt;selectCollection($params['collection']); //       ,   $this-&gt;field = $params['field']; if (!$this-&gt;field || !$this-&gt;collection) { throw new Exception("Invalid parameters"); } //     logger',   DI $this-&gt;logger = $logger; } //        , //    . public function loadUserByUsername($uname) { //      . $this-&gt;logger-&gt;debug("user load request. name: $uname"); //         User //   . $user = $this-&gt;collection-&gt;findOne(array($this-&gt;field =&gt; $uname)); //  . ,    . if (!isset($user-&gt;uname) || $user-&gt;uname !== $uname) { throw new UsernameNotFoundException(sprintf('User "%s" does not exist.', $uname)); } //     return $user; } //       . //        . public function refreshUser(UserInterface $user) { if (!($user instanceof User)) throw new UnsupportedUserException(sprintf('Instances of "%s" are not supported.', get_class($user))); $this-&gt;logger-&gt;info("refresh from mongo"); $_user = $this-&gt;collection-&gt;findOne(array('_id' =&gt; $user-&gt;_id)); if ($_user &amp;&amp; $_user instanceof User) $this-&gt;logger-&gt;info("roles: " .implode(', ',$_user-&gt;roles)); else throw new UsernameNotFoundException(sprintf('User "%s" does not exist.', $user-&gt;uname)); return $_user; } //    . public function supportsClass($class) { $this-&gt;logger-&gt;debug("support checking: $class"); if ($class == 'MyBundle\Models\User') return true; return false; } }</span></span></code> </pre> <br><br>  Now you need to register the provider as a service and ‚Äúteach‚Äù the security component to use it. <br><br>  In the services.yml of our bundle we will add data about the service and parameters for it: <br><br><pre> parameters:
   my.users:
     confname: default
     collection: user
     field: uname<font></font>
<font></font>
 services:
   my.users.prov:
     class: MyBundle \ Security \ UserProvider
     arguments: [% my.users%, @ mongo.manager, @ monolog.logger]
</pre><br><br>  In the security.yml application, we write: <br><br><pre> security:
     encoders:
         Symfony \ Component \ Security \ Core \ User \ User: plaintext
         # for ease of launch, you can store an unencrypted password in the database		
         MyBundle \ Models \ User: plaintext<font></font>
<font></font>
     providers:
	 # now declare a new user source (you can assign any name)
	 # and write in it the name of the service that will give the data 
         about users
         mongobase:
           id: my.userprov
 ...
</pre><br><br>  There is one feature that is not explicitly mentioned anywhere (or I did not pay attention).  If more than one user provider is declared in security.yml, the first one will be used for authentication, if not the other provider is specified directly. <br><br>  Actually after that we can already start to login using data from MongoDB.  In my case, the database already has data from a previous version of the project.  How to make an entry point, described in the above articles, I think it makes no sense to write about it again. <br><br><h4>  Step 2 - OAuth Authentication </h4><br>  As an innovation in the new version of the project, I decided to add the ability to authorize users for account registration in social.  networks.  As an example, I will talk about authentication and registration through all the beloved "beloved" soc.  VKontakte network. <br><br>  Creating your own authentication method in Symfiny 2.0 can be considered documented.  There is an <a href="http://symfony.com/doc/2.0/cookbook/security/custom_authentication_provider.html">official article</a> telling about the implementation of authentication using WSSE.  Starting work on the functionality I needed, I was guided by this article.  Principles of work with soc.  I gained a network from this <a href="http://habrahabr.ru/blogs/webdev_for_dummies/126717/">article</a> on Habr√©. <br><br>  Now a little analysis of the information received.  The authentication described for the example in the official article is not very similar to what I need.  The process of authenticating a user with a Vkontakte account is rather similar to the usual (based on login / password) authentication, however, we have neither a login nor a password.  After thinking about it, I decided to examine the source code of symfony, in particular, how the regular authorization is arranged through the form (form_login). <br><br>  It turns out that the built-in AuthenticationListeners and AuthenticationProviders inherit from abstract classes that take on most of the chores associated with directly managing authentication in Symfony, working with a user session, etc. We can also use these classes to facilitate our work . <br><br>  Let's get started <br><br>  As in the official article, let's start with Token: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Social</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Token</span></span>\<span class="hljs-title"><span class="hljs-title">AbstractToken</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Token</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractToken</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      . public $social; public $hash; public $add; //   ,    function __construct(array $roles = array()) { parent::__construct($roles); //    ,    //          . parent::setAuthenticated(count($roles) &gt; 0); } // ,    TokenInterface public function getCredentials() { } //         , //      .     ‚Äú‚Äù //     . public function serialize() { $pser = parent::serialize(); return serialize(array($this-&gt;social, $this-&gt;hash, $this-&gt;add, $pser)); } public function unserialize($serialized) { list($this-&gt;social, $this-&gt;hash, $this-&gt;add, $pser) = unserialize($serialized); parent::unserialize($pser); } }</span></span></code> </pre><br><br>  The token class, as in the case of the user class, is very simple.  Next, we need a Listener, which will create the Token's of the class just described. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Social</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>; <span class="hljs-comment"><span class="hljs-comment">//       AbstractAuthenticationListener, //     ‚Äú‚Äù   , //       use Symfony\Component\HttpFoundation\Response; use Symfony\Component\HttpKernel\Event\GetResponseEvent; use Symfony\Component\Security\Http\Firewall\ListenerInterface; use Symfony\Component\Security\Core\Exception\AuthenticationException; use Symfony\Component\Security\Core\SecurityContextInterface; use Symfony\Component\Security\Core\Authentication\AuthenticationManagerInterface; use Symfony\Component\Security\Core\Authentication\Token\TokenInterface; use Symfony\Component\Security\Http\Firewall\AbstractAuthenticationListener; use Symfony\Component\HttpFoundation\Request; use Symfony\Component\Security\Http\Session\SessionAuthenticationStrategyInterface; use Symfony\Component\Security\Http\HttpUtils; use Symfony\Component\HttpKernel\Log\LoggerInterface; use Symfony\Component\DependencyInjection\ContainerInterface; use Symfony\Component\EventDispatcher\EventDispatcherInterface; use Symfony\Component\Form\Extension\Csrf\CsrfProvider\CsrfProviderInterface; class AuthenticationListener extends AbstractAuthenticationListener { //      ‚Äú‚Äù  .  protected $social; //    ,  //   public function __construct(SecurityContextInterface $securityContext, AuthenticationManagerInterface $authenticationManager, SessionAuthenticationStrategyInterface $sessionStrategy, HttpUtils $httpUtils, $providerKey, array $options = array(), AuthenticationSuccessHandlerInterface $successHandler = null, AuthenticationFailureHandlerInterface $failureHandler = null, LoggerInterface $logger = null, EventDispatcherInterface $dispatcher = null, array $social = array()) { parent::__construct($securityContext, $authenticationManager, $sessionStrategy, $httpUtils, $providerKey, array_merge(array( 'intention' =&gt; 'authenticate', ), $options), $successHandler, $failureHandler, $logger, $dispatcher); $this-&gt;social = $social; } //  attemptAuthentication   ,   //    ,    Token' public function attemptAuthentication(Request $request) { //      ,     //     if ($request-&gt;get('uid') &amp;&amp; $request-&gt;get('hash') &amp;&amp; $request-&gt;cookies-&gt;get("vk_app_{$this-&gt;social['vk']['id']}")) { $this-&gt;logger-&gt;debug("vk auth handled"); //     $uid = $request-&gt;get('uid'); $fn = $request-&gt;get('first_name'); $ln = $request-&gt;get('last_name'); $hash = $request-&gt;get('hash'); $this-&gt;logger-&gt;info("user $fn $ln [$uid] // $hash"); $avatars = array( 'sav' =&gt; $request-&gt;get('photo'), 'srav' =&gt; $request-&gt;get('photo_rec'), ); //   token     //   .  ‚Ä¶ $token = new Token(); $token-&gt;setUser("vk{$uid}"); // ‚Ä¶     token' ... $token-&gt;social = 'vk'; $token-&gt;hash = $hash; $token-&gt;add = array( 'uid' =&gt; $uid, 'avatar' =&gt; $avatars, 'name' =&gt; "$fn $ln", ); // ‚Ä¶     ,     return $this-&gt;authenticationManager-&gt;authenticate($token); } //        -   . } }</span></span></code> </pre><br><br>  In essence, the role of a listener is to extract from the request the data necessary to authenticate the user.  AbstractAuthenticationListener, gives us the opportunity to restrict ourselves to writing only the code for checking and parsing the request, providing ready-made functionality for filtering requests by URI, managing redirections, and other routines, also part of the AuthenticationListener ‚Äúduty‚Äù. <br><br>  After implementing the Listenr, we will need an AuthenticationProvider, which will directly check Token and ‚Äúannounce‚Äù the successful authentication. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Social</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Mh</span></span>\<span class="hljs-title"><span class="hljs-title">Mongo</span></span>\<span class="hljs-title"><span class="hljs-title">MongoBundle</span></span>\<span class="hljs-title"><span class="hljs-title">ConnectionManager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">MyBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Models</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Provider</span></span>\<span class="hljs-title"><span class="hljs-title">AuthenticationProviderInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">UserProviderInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">AuthenticationException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">NonceExpiredException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Token</span></span>\<span class="hljs-title"><span class="hljs-title">TokenInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">UsernameNotFoundException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpKernel</span></span>\<span class="hljs-title"><span class="hljs-title">Log</span></span>\<span class="hljs-title"><span class="hljs-title">LoggerInterface</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    AuthenticationProvider'     // ,     UserAuthenticationProvider, //            . class Provider implements AuthenticationProviderInterface { protected $userProvider; protected $logger; //     .  protected $social; //       MongoDB  //    protected $mongo; //   ,     //  . public function __construct(UserProviderInterface $userProvider, array $social, ConnectionManager $cm, LoggerInterface $logger) { $this-&gt;userProvider = $userProvider; $this-&gt;social = $social; $this-&gt;mongo = $cm; $this-&gt;logger = $logger; } //    public function authenticate(TokenInterface $token) { $user = null; //      UserProvider'a //      ,      try { $user = $this-&gt;userProvider-&gt;loadUserByUsername($token-&gt;getUsername()); } catch (UsernameNotFoundException $ex) { $this-&gt;logger-&gt;debug("user ".$token-&gt;getUsername()." not yet registred"); } try { //    hash' if ($this-&gt;checkHash($token)) { $this-&gt;logger-&gt;info("hash is valid"); //  ,    hash,   //    -  ‚Äú‚Äù if (!$user) { $this-&gt;logger-&gt;info("register new user"); $user = new User(array( 'uname' =&gt; $token-&gt;getUsername(), 'social' =&gt; $token-&gt;social, 'fullname' =&gt; $token-&gt;add['name'], 'avatar' =&gt; $token-&gt;add['avatar'], 'suid' =&gt; $token-&gt;add['uid'], 'roles' =&gt; array('ROLE_EXTUSER', strtoupper($token-&gt;social) ), )); $user-&gt;save($this-&gt;mongo); } //    . ,   Token //      $authenticatedToken = new Token($user-&gt;getRoles()); $authenticatedToken-&gt;social = $token-&gt;social; $authenticatedToken-&gt;hash = $token-&gt;hash; $authenticatedToken-&gt;add = $token-&gt;add; $authenticatedToken-&gt;setUser($user); //        return $authenticatedToken; } else { $this-&gt;logger-&gt;debug("hash is invalid."); } } catch (\Exception $ex) { $this-&gt;logger-&gt;err("auth internal exception: $ex"); } //   -     -  //  . throw new AuthenticationException('The Social authentication failed.'); } //   hesh',      //  . protected function checkHash(Token $token) { if ($token-&gt;social == 'vk') { return ($token-&gt;hash === md5( $this-&gt;social['vk']['id'] . $token-&gt;add['uid'] . $this-&gt;social['vk']['key'] )); } return false; } //  ,    token'  provider' public function supports(TokenInterface $token) { return $token instanceof Token; } }</span></span></code> </pre> <br><br>  After completing the work on AuthenticationProvider, it remains only to teach the framework to use the classes we have written.  Unlike UserProvider, this is a rather voluminous and not ‚Äútransparent‚Äù part of the work. <br><br>  Official documentation reports that to use our code with the Symfony security system, you will need to write an implementation of the SecurityFactoryInterface.  So do. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyBundle</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">ContainerBuilder</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">Reference</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">DefinitionDecorator</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Config</span></span>\<span class="hljs-title"><span class="hljs-title">Definition</span></span>\<span class="hljs-title"><span class="hljs-title">Builder</span></span>\<span class="hljs-title"><span class="hljs-title">NodeDefinition</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">SecurityBundle</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Factory</span></span>\<span class="hljs-title"><span class="hljs-title">SecurityFactoryInterface</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   Symfony   AbstractFactory     . //    ,      ,   //    AuthenticationProvider' class SocialAuthFactory implements SecurityFactoryInterface { //      firewall'    //  .     form_login. protected $options = array( 'check_path' =&gt; '/login_check', 'login_path' =&gt; '/login', 'use_forward' =&gt; false, 'always_use_default_target_path' =&gt; false, 'default_target_path' =&gt; '/', 'target_path_parameter' =&gt; '_target_path', 'use_referer' =&gt; false, 'failure_path' =&gt; null, 'failure_forward' =&gt; false, ); //  ,       firewall  listener  // provider. //      , id firewall'  // ,       . public function create(ContainerBuilder $container, $id, $config, $userProvider, $defaultEntryPoint) { //      ,     //   . //      ‚Äú‚Äù   // (  )    . //  id    AuthenticationProvider' $providerId = 'security.authentication.provider.social.'.$id; //    -    my.socialauth.prov //  (0)         //   $container -&gt;setDefinition($providerId, new DefinitionDecorator('my.socialauth.prov')) -&gt;replaceArgument(0, new Reference($userProvider)) ; //  listener'    ,    provider' $listenerId = 'security.authentication.listener.social.'.$id; $container -&gt;setDefinition($listenerId, new DefinitionDecorator('my.socialauth.listener')) -&gt;replaceArgument(4, $id) -&gt;replaceArgument(5, array_intersect_key($config, $this-&gt;options)); //   id  . return array($providerId, $listenerId, $defaultEntryPoint); } //  ,       //   .      login_form. public function getPosition() { return 'form'; } //      ,      //     . public function getKey() { return 'mysocial'; } //   ,      // AbstractFactory public function addConfiguration(NodeDefinition $node) { $builder = $node-&gt;children(); $builder -&gt;scalarNode('provider')-&gt;end() ; foreach ($this-&gt;options as $name =&gt; $default) { if (is_bool($default)) { $builder-&gt;booleanNode($name)-&gt;defaultValue($default); } else { $builder-&gt;scalarNode($name)-&gt;defaultValue($default); } } } }</span></span></code> </pre> <br><br>  After creating the Factory, all that remains is to add the configuration. <br><br>  Let's start with security.yml.  There you need to add a link to the configuration file of your factory ... <br><br><pre>  security:<font></font>
<font></font>
     factories:
         - "% kernel.root_dir% / .. / src / MyBundle / Resources / config / socialauth_factory.yml"
 ... </pre><br><br>  ... next, create and populate the referenced file, the syntax is the same as the usual services.yml syntax. <br><br><pre> services:
     security.authentication.factory.mysocial:
         class: MyBundle \ DependencyInjection \ Security \ Factory \ SocialFactory
         tags:
             - {name: security.listener.factory}
</pre><br><br>  Now it is necessary to supplement the services.yml itself with the services we refer to in our Factory: <br><br><pre>  parameters:
   my.users:
     confname: default
     collection: user
     field: uname<font></font>
<font></font>
   my.social:
     id: __YOUR_APP_ID__
     key: __YOUR_APP_PRIVATE_KEY__<font></font>
<font></font>
 services:
   my.users.prov:
     class: MyBundle \ Security \ UserProvider
     arguments: [% my.users%, @ mongo.manager, @ monolog.logger]<font></font>
<font></font>
   # service for the listener we declare as the heir to the AbstractListener service
   # the arguments specified here will be passed to the constructor after the arguments   
   # prescribed in the parent service
   my.socialauth.listener:
     class: MyBundle \ Social \ Authentication \ Listener
     parent: security.authentication.listener.abstract
     arguments: [% my.social%]<font></font>
    <font></font>
   # in the service for provider, we leave the first argument without real value.
   # The value will be transferred from the decorator created in Factory.
   my.socialauth.prov:  
     class: MyBundle \ Social \ Authentication \ Provider
     arguments: ['',% my.social%, @ mongo.manager, @ monolog.logger]
</pre><br><br>  The last thing to do is to include our subsystem in the application configuration.  To do this, again rule security.yml, and in it, the firewalls block: <br><br><pre>  ...   
     firewalls:
         myauth:
             pattern: ^ /
             # add our firewall to the block to the general form_login, 
             # Recall that he has almost the same settings.
             mysocial:  
                 check_path: / login / socialauth
                 login_path: / login / in
             # our classes will work on equal terms with boxed classes and symfony,
             # so that they do not interfere with each other, we will do different check_path
             form_login:
                 check_path: / login / auth
                 login_path: / login / in
	      # we allow to log in 2 ways, the output is for 
             # Both types to the user by standard means.
             logout:
                 path: / login / out
                 target: /
                 invalidate_session: true
             anonymous: ~
 ... </pre><br><br>  That's all.  By adding a link to the login form template via VKontakte, we will be able to log in using this social.  network. <br><br><h4>  Results </h4><br>  The symfony 2.0 security system from the beginning may seem complicated and confusing.  In general, it is really complicated and confusing, but if you compare the security organization in the second and first versions, you can see one trend. <br><br>  The security system is organized in such a way that typical tasks can be solved at the framework configuration level.  We do not need to program to verify the login / password (except for drawing a form), we don‚Äôt even need an action to check.  Same for logout.  The complexity of the implementation of individual elements is primarily due to the need to embed them in a flexible security architecture. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/134005/">https://habr.com/ru/post/134005/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134000/index.html">Tablets in the office: a change of mood in the headquarters of the CIO</a></li>
<li><a href="../134001/index.html">FINANCE.UA: our financial ports and information services</a></li>
<li><a href="../134002/index.html">New HP DL980 Servers</a></li>
<li><a href="../134003/index.html">Google developer dispels "full hardware acceleration" myths in Ice Cream Sandwich</a></li>
<li><a href="../134004/index.html">Evernote Windows Update: Favorites Bar</a></li>
<li><a href="../134006/index.html">Several problems in the development of Android applications and their solutions</a></li>
<li><a href="../134007/index.html">Warranty software in the English-speaking contract (Part 1)</a></li>
<li><a href="../134008/index.html">One year to the project "100 Brands"</a></li>
<li><a href="../134009/index.html">Google Algorithm Updates - Inside Search</a></li>
<li><a href="../134010/index.html">Yandex.Music has run out of rights to a part of musical compositions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>