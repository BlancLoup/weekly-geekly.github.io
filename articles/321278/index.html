<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Local multiplayer in Unity using Unet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Today I would like to tell you about one of the ways how to create a local multiplayer in Unity. This solution is suitable for showcases, dough...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Local multiplayer in Unity using Unet</h1><div class="post__text post__text-html js-mediator-article">  Hello!  Today I would like to tell you about one of the ways how to create a local multiplayer in Unity.  This solution is suitable for showcases, dough features or local multiplayer.  For example, if you want to see what the player is doing, but you don‚Äôt want to say that you spend extra resources on an android and take a screencast using ADB, then you can simply raise the server on some kind of machine as a copy of the application that runs on the phone and send there information about the actions of the player. <br><br><img src="https://habrastorage.org/files/7c1/2f5/fc0/7c12f5fc0e94454aa31b4b14c48d344d.jpg"><a name="habracut"></a><br>  I will briefly describe how this can be done with HLAPI on Unet, but not through NetworkingManager, but a bit more low-level.  By a good tradition I will attach an example of my own implementation of such a client-server interaction.  I ask you not to judge an example strictly, as I understand perfectly well that the architecture of this solution is worthless and creates a lot of problems in the future.  My goal was as quickly as possible (over the weekend) to write a system in which you can show the principle of working with the network.  Also I will say what problems I had to face.  In this example implementation, it is assumed that the server is also a Unity application. <br><br>  On the Internet, the most frequent example of how to make multiplayer is chat, but I love games, and it seemed boring to make chat.  Therefore, I decided to make out how to make multiplayer using the example of daggers.  Assume that all the logic of the game, determining the winner, changing moves, etc., are written, and we have to tie the server.  In the simplest case, we need to process 2 messages in tic-tac-toe.  Determining the order of the course (distribution of aydishnikov) and the capture of the cell. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/fba/81d/746/fba81d7466ef4bf49f23bd7712750943.png"><br><br>  In general, the game in this example works very simply.  There are 2 scenes.  Boot and gameplay.  When loading the gameplay scene, we generate a field on which players play.  There is also a check of the victory conditions, there are classes responsible for the work of the UI, as well as the order of moves and the overall logic of the game, but we are not particularly interested.  The main classes that are responsible for the grid are Server, Client, NetManager and a separate file for NetMessages messages and the enum MyMsgType defined in it.  They are a wrapper over Unet tools.  From the point of view of Unet, the main classes that we will use are NetworkClient, NetworkServer, MessageBase and MsgType.  What are these classes? <br><br>  The simplest classes are MessageBase and MsgType.  The first is an abstract class from which all our messages must be inherited in order to forward them between the client and the server.  MsgType is just a class that stores constants that are responsible for a certain set of messages embedded in Unet. <br><br><img src="https://habrastorage.org/files/a48/b40/95d/a48b4095d79245528ebd11a4be24b9f2.png"><br><br>  NetworkServer is a singleton that provides the ability to handle communication with remote clients.  Under the hood, he uses an instance of NetworkServerSimple and is essentially a convenient wrapper over it.  First we need to start the server on a specific port.  To do this, call the <i>Listen (int serverPort)</i> method ‚Äî this method starts the server on the serverPort port.  (I recall that all ports in the range from 0 to 1023 are system ports and should not be used as a parameter of this method) <br><br>  Excellent server is running and listening to some port.  Now we need him to respond to messages.  To do this, register the handler using the <i>RegisterHandler</i> method <i>(short msgType, Networking.NetworkMessageDelegate handler)</i> .  This method accepts a message type and a delegate.  The delegate, in turn, must accept the NetworkMessage input parameter.  Suppose we want to, at the moment when a player joins him on the server, the gameplay scene starts to load, as well as aydishniki players.  Then you need to register the handler for the corresponding message, as well as implement the method that we will pass as a delegate for registration. <br><br>  It looks like this: <br><br><div class="spoiler">  <b class="spoiler_title">An example of handler and delegate registration</b> <div class="spoiler_text"><pre><code class="cs hljs">NetworkServer.RegisterHandler(MsgType.Connect, OnConnect); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConnect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetworkMessage msg</span></span></span><span class="hljs-function">)</span></span> { Debug.Log(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Concat(<span class="hljs-string"><span class="hljs-string">"Connected: "</span></span>, msg.conn.address)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connId = msg.conn.connectionId; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NetworkServer.connections.Count &gt; Constants.PLAYERS_COUNT) { SendPlayerID(connId, <span class="hljs-number"><span class="hljs-number">-1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = Random.Range(<span class="hljs-number"><span class="hljs-number">0</span></span>, Constants.PLAYERS_IDS.Length); SendPlayerID(connId, Constants.PLAYERS_IDS[index]); _CurrentUser.PlayerID = Constants.PLAYERS_IDS[(index + <span class="hljs-number"><span class="hljs-number">1</span></span>) % Constants.PLAYERS_COUNT]; SceneManager.LoadScene(<span class="hljs-number"><span class="hljs-number">1</span></span>); } }</code> </pre> <br></div></div><br>  Now the OnConnect method will be called at each connection of some user.  It should be clarified that in this implementation, the IDs determine the order of the move, so when the first connection, IDs for the client and server are selected.  Other clients automatically get an id equal to -1, which means that this client is a spectator. <br><br>  Simple server is.  Now customers would not interfere.  To do this, we use the NetworkClient class.  In order to join the server, simply call the <i>Connect</i> method <i>(string serverIp, int serverPort)</i> .  As a port, we set the port that our server listens to, set localhost as an ip if we test our application on the same machine, or ip a computer on the local network that we use as a server (you can find it in the network settings, or in the console using the ipconfig command on the computer that will act as the server). <br><br>  Great, we can connect.  Earlier it was said that the server is distributed by aydishniki.  So we first need to send a message about the ID, as well as register the handler of this message on the client.  As mentioned earlier, all messages must be inherited from MessageBase.  First we define them (I prefer to do this in a separate file): <br><br><div class="spoiler">  <b class="spoiler_title">Message and its type</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PlayerIDMessage</span></span> : <span class="hljs-title"><span class="hljs-title">MessageBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PlayerID; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> MyMsgType : <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> { PlayerID = MsgType.Highest + <span class="hljs-number"><span class="hljs-number">1</span></span>, }</code> </pre><br></div></div><br>  To send this message, call the <i>Send</i> method <i>(short msgType, Networking.MessageBase msg)</i> on the client, which will send the msg message of ‚Äútype‚Äù msgType to the server, or on the server one of the methods depending on the <i>SendToAll</i> target <i>(short msgType, Networking.MessageBase msg)</i> or <i>SendToClient (int connectionId, short msgType, Networking.MessageBase msg)</i> , where connectionId is the id of a specific client. <br><br>  To read our custom messages that came to us from another application, we use <i>reader.ReadMessage ()</i> .  For example: <br><br><div class="spoiler">  <b class="spoiler_title">Processing client came IT</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPlayerID</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetworkMessage msg</span></span></span><span class="hljs-function">)</span></span> { PlayerIDMessage message = msg.reader.ReadMessage&lt;PlayerIDMessage&gt;(); _CurrentUser.PlayerID = message.PlayerID; SceneManager.LoadScene(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br></div></div><br>  In principle, everything.  Further use depends on the specifics.  We create the messages we need depending on the gameplay and send them.  In the tic-tac-toe, I also identified another message that is responsible for capturing the point.  The full implementation of the project can be found <a href="https://github.com/Nox7atra/Simple-Unity-Client-Server">here</a> . <br><br>  What else you want to say, and what you had to spend time on, is a couple of things that you may not be obvious if you have not worked with networks. <br><br>  <b>1.</b> Check that the unit editor is not blocked by your firewall for communication using TCP and UDP protocols.  Once I spent some time on it, despite the fact that I got to the firewall and set the required port as an exception, but I did not check that the editor is unlocked. <br><br>  <b>2.</b> Send value-type or serializable reference-type in messages, as well as don‚Äôt pass MonoBehavior heirs.  It is also important to understand that the reference-type in this case will transmit a copy of the object, and not the object itself, and it must be processed accordingly. <br><br>  In the case when we are talking about a local network and previously known hardware, there are not many problems arising in the case of a ‚Äúreal‚Äù multiplayer.  Virtually no need to think about delays, fluctuations, packet loss and so on.  Therefore, such a solution can be useful, although these problems can be solved with such an approach to a certain extent.  Compared to the higher level of abstraction in Unet, via NetworkManager, NetworkBehavior, etc., it provides more understandable and obvious flexibility (in my opinion) if clients need to load different scenes, etc., and say the server is used , as streaming, and shows what is displayed on the player's device, taking its position and rotation + duplicating what is happening on its side.  In other cases, when you need a solution faster and you can work with the network, Unet provides the ability to write at the transport level. <br><br>  I would also like to clarify the decision on the githab (not in terms of tools, but in terms of approach to architecture) in my opinion, this is an example of how not to do it.  Not to mention the architecture of the game itself, the problem is that the logic on the client and on the server is considered independently.  When implementing an adequate multiplayer with a client-server architecture, it is better when the game state is stored on the server and replicated to the clients, and the clients send commands that change the game state on the server.  This of course also depends on many factors, but on average this approach. <br><br>  I will duplicate here the <a href="https://github.com/Nox7atra/Simple-Unity-Client-Server">link to the solution</a> . <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/321278/">https://habr.com/ru/post/321278/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321266/index.html">Standard exchange 1C-Bitrix on BASH: Detailed parsing of the script of incremental unloading</a></li>
<li><a href="../321268/index.html">Let's Encrypt and Express. To each server - on the green lock</a></li>
<li><a href="../321270/index.html">How to evaluate big tasks</a></li>
<li><a href="../321274/index.html">Features of the distributed storage architecture in Dropbox</a></li>
<li><a href="../321276/index.html">As we did not go to Y Combinator, ‚Äú... the profit plan is simple - here the drugs are legal, $ 70 cant ...‚Äù</a></li>
<li><a href="../321280/index.html">The history of the development of TWIME - the new high-speed interface of the Moscow Exchange</a></li>
<li><a href="../321282/index.html">Riot loafers, or again about the accounting of working time</a></li>
<li><a href="../321286/index.html">Password recovery D-Link DPH-400S or the story of a small hack</a></li>
<li><a href="../321288/index.html">Undocumented features of Windows: breakpoints for registry keys</a></li>
<li><a href="../321290/index.html">The brilliance and poverty of test automation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>