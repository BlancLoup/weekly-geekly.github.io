<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience of using the Puniverse Quasar library for actors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the past, in 2017, there was a small project that almost ideally fell on the ideology of the actors , decided to experiment and try to use their im...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience of using the Puniverse Quasar library for actors</h1><div class="post__text post__text-html js-mediator-article">  In the past, in 2017, there was a small project that almost ideally fell on the ideology of the <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25BE%25D0%25B4%25D0%25B5%25D0%25BB%25D1%258C_%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BE%25D1%2580%25D0%25BE%25D0%25B2">actors</a> , decided to experiment and try to use their implementation from the Parallel Universe.  There was not much needed from the actors themselves - know yourself to keep the state and communicate with others, sometimes change by timer and do not fall. <br><br>  The library seems to be quite mature, almost 3,000 stars on a <a href="https://github.com/puniverse/quasar">githaba</a> , more than 300 forks, a couple of <a href="https://habrahabr.ru/post/313070/">recommendations</a> on <a href="https://habrahabr.ru/company/luxoft/blog/280784/">Habr√©</a> ... Why not?  Our project started in February 2017, wrote on Kotlin. <br><br><img src="https://habrastorage.org/webt/jy/vr/rw/jyvrrwijqh_u6sy4lblol3rcyqi.png"><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Briefly about the library </h2><br>  ‚Üí <a href="http://www.paralleluniverse.co/">Developer</a> <br>  ‚Üí <a href="http://docs.paralleluniverse.co/quasar/">Documentation</a> <br>  ‚Üí <a href="https://github.com/puniverse/quasar">GitHub</a> <br><br>  The main purpose of the library is lightweight streams (fibers), over which Go-like channels, Erlang-like actors, all sorts of reactive buns and other similar things ‚Äúfor asynchronous programming in Java and Kotlin‚Äù are implemented.  Developed since 2013. <br><br><h2>  Build Setup </h2><br>  Since  The project on the cotlin, the assembly will be on the gradle.  An important point: for the work of lightweight streams, manipulations with Java byte-code (instrumentation), which are usually done with the help of a java-agent, are necessary.  This quasar agent kindly provides.  In practice, this means that: <br><br><img src="https://habrastorage.org/webt/dn/ch/1h/dnch1hlvwt0s8xxs2ntbs2xraxw.jpeg"><br><br>  First we need to add the quasar configuration: <br><br><pre><code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">configurations</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">quasar</span></span> }</code> </pre> <br>  Connect the dependencies: <br><br><pre> <code class="hljs perl">dependencies { compile(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-stdlib-jre8:$kotlin_version"</span></span>) //   compile(<span class="hljs-string"><span class="hljs-string">"co.paralleluniverse:quasar-core:$quasar_version:jdk8"</span></span>) //   quasar  compile(<span class="hljs-string"><span class="hljs-string">"co.paralleluniverse:quasar-actors:$quasar_version"</span></span>) //   compile(<span class="hljs-string"><span class="hljs-string">"co.paralleluniverse:quasar-kotlin:$quasar_version"</span></span>) //     quasar <span class="hljs-string"><span class="hljs-string">"co.paralleluniverse:quasar-core:$quasar_version:jdk8"</span></span> //  java- //...   }</code> </pre> <br>  We say that all gradle tasks should be run with a java-agent: <br><br><pre> <code class="hljs pgsql">tasks.withType(JavaForkOptions) { //uncomment <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> there are problems <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> fibers //systemProperty <span class="hljs-string"><span class="hljs-string">'co.paralleluniverse.fibers.verifyInstrumentation'</span></span>, <span class="hljs-string"><span class="hljs-string">'true'</span></span> jvmArgs "-javaagent:${(++configurations.quasar.iterator())}" }</code> </pre> <br>  The co.paralleluniverse.fibers.verifyInstrumentation <code>co.paralleluniverse.fibers.verifyInstrumentation</code> is responsible for checking in runtime correctness of bytecode manipulations.  Of course, if this check is enabled, then everything starts to slow down :) <br><br>  For the release, I also wrote a function for generating bat / sh files that launch the application with a java-agent.  Nothing particularly interesting, just create a file and put the desired launch line there, with the correct version of quasar: <br><br><pre> <code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRunScript</span></span></span></span>(<span class="hljs-type"><span class="hljs-type">String</span></span> scriptPath, <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">File</span></span>(scriptPath) file.createNewFile() file.setExecutable(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preamble</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-string"><span class="hljs-string">"@echo off"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">==</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sh</span></span></span><span class="hljs-class">") </span></span>{ preamble = <span class="hljs-string"><span class="hljs-string">"#!/bin/bash"</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deps</span></span></span><span class="hljs-function"> </span></span>= configurations.quasar.files.collect { <span class="hljs-string"><span class="hljs-string">"-Xbootclasspath/a:\"libs/${it.name}\""</span></span> }.join(<span class="hljs-string"><span class="hljs-string">" "</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flags</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-string"><span class="hljs-string">"-Dco.paralleluniverse.fibers.detectRunawayFibers=false"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">quasarAgent</span></span></span><span class="hljs-function"> </span></span>= configurations.quasar.files.find { it.name.contains(<span class="hljs-string"><span class="hljs-string">"quasar-core"</span></span>) }.name file.text = <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"$preamble java -classpath "</span></span>.<span class="hljs-comment"><span class="hljs-comment">/*.jar" -javaagent:"libs/$quasarAgent" $deps $flags -jar ${project.name}.jar """ }</span></span></code> </pre> <br>  And task release, which creates a separate folder with everything you need: <br><br><pre> <code class="hljs pgsql">task <span class="hljs-keyword"><span class="hljs-keyword">release</span></span>(dependsOn: [<span class="hljs-string"><span class="hljs-string">'build'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> = "Build" def targetDir = "$buildDir/release" doLast { <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> "$buildDir/libs/${project.name}.jar" <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> targetDir } <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> { //   quasar,  javaagent    <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>(configurations.quasar.files) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> "$targetDir/libs" }    <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> { //   ,            <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>("src/main/resources/application.yml")      <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> targetDir    } //   createRunScript("$targetDir/${project.name}.bat", "bat") createRunScript("$targetDir/${project.name}.sh", "sh") } }</code> </pre> <br>  See more example <a href="https://gist.github.com/ov7a/9e203ba27755d35c0557bb87bee40cd4">in my gist</a> or <a href="https://github.com/puniverse/quasar-gradle-template/blob/master/build.gradle">in the official example</a> for gradle.  Theoretically, it seems like there is a possibility to change the byte code at the compilation stage and not use the java-agent.  For this quasar has <a href="http://docs.paralleluniverse.co/quasar/">ant-task</a> .  However, even with the car of crutches and electrical tape, I could not adjust it. <br><br><h2>  Use of actors </h2><br>  Let us turn to the actors.  In my understanding, the basis of the actors is a constant exchange of messages.  However, out of the box, Quasar represents only the universal <code>co.paralleluniverse.kotlin.Actor</code> with the <code>receive</code> method.  For a permanent exchange, we had to implement a small layer: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicActor</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Actor</span></span></span></span>() { <span class="hljs-meta"><span class="hljs-meta">@Suspendable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Any? <span class="hljs-meta"><span class="hljs-meta">@Suspendable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doRun</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { receive { onReceive(it!!) } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(incomingMessage: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">RequestMessage</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;, result: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { RequestReplyHelper.reply(incomingMessage, result) } }</code> </pre> <br>  Which in fact only makes the eternal cycle of receiving messages. <br><br>  In addition, with the transition to Kotlin 1.1, the library started having problems that have not been resolved so far (I quote a piece of their code): <br><br><pre> <code class="hljs pgsql">// TODO Was "(Any) -&gt; Any?" but <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span> the compiler would <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> the base Java <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> even complain about ambiguity! Investigate <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> possibly report <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> protected fun receive(proc: (<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>?) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>?) { receive(<span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, proc) }</code> </pre> <br>  Because of this, our <code>BasicActor</code> had to make a wrapper for <code>receive</code> .  Well, for clarity, the <code>reply</code> method and the extenstion <code>ask</code> method were made: <br><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Suspendable</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function"> ActorRef</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;Any&gt;</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">RequestMessage</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span>: T { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RequestReplyHelper.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, message) }</code> </pre> <br>  Please note that in order to send a question message, it must necessarily be inherited from <code>RequestMessage</code> .  This slightly limits the messages that can be exchanged in the question-answer format. <br><br>  The <code>@Suspendable</code> annotation is very important - when using quasar, it must be hung up on all methods that apply to other actors or lightweight streams, otherwise you will get the <code>SuspendExecution</code> exception in <code>SuspendExecution</code> , and there will be no sense from ‚Äúlightness‚Äù.  From the point of view of the library's developers, it is obvious that this is necessary for the java-agent, but from the programmer-user‚Äôs point of view, this is inconvenient (it is possible to do this <a href="http://docs.paralleluniverse.co/quasar/">automatically</a> , but it will be far from free). <br><br>  Further, the implementation of the actor comes down to redefining the <code>onReceive</code> method, which can be done quite simply with <code>when</code> , doing something depending on the type of message: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (message) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> SomeMessage -&gt; { <span class="hljs-comment"><span class="hljs-comment">// Do stuff val someotherActor = ActorRegistry.getActor("other actor") someotherActor.send(replyOrSomeCommand) } is SomeOtherMessage -&gt; { process(message.parameter) //  smart-cast val replyFromGuru = guruActor.ask(Question("Does 42 equals 7*6?")) doSomething() } else -&gt; throw UnknownMessageTypeException(message) }</span></span></code> </pre> <br>  In order to get a reference to the actor, you need to refer to the static method <code>ActorRegistry.getActor</code> , which returns a reference to the actor by a string identifier. <br><br>  It remains only to run the actors.  To do this, you must first create an actor, then register, and finally run: <br><br><pre> <code class="hljs lisp">val myActor = MySuperDuperActor() val actorRef = spawn(<span class="hljs-name"><span class="hljs-name">register</span></span>(<span class="hljs-name"><span class="hljs-name">MY_ACTOR_ID</span></span>, myActor))</code> </pre> <br>  (Why it was impossible to do it at once with one method is unclear). <br><br><h2>  Some problems </h2><br>  What do you think will happen if the actor falls with the exception? <br><br>  And nothing.  Well, the actor fell.  Now he will not accept messages, but so what.  Great default behavior! <br><br>  In this regard, the observer actor had to be implemented, who monitors the state of the actors and drops the entire application if something went wrong (there were no requirements for fault tolerance, so they could afford it): <br><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WatcherActor</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BasicActor</span></span></span></span>(), ILogging <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Logging&lt;WatcherActor&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleLifecycleMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lcm: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LifecycleMessage</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Any? { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> onReceive(lcm) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Any? = <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (message) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> ExitMessage -&gt; { log.fatal(<span class="hljs-string"><span class="hljs-string">"Actor </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.actor.name}</span></span></span><span class="hljs-string"> got an unhandled exception. Terminating the app. Reason: "</span></span>, message.getCause()) exit(-<span class="hljs-number"><span class="hljs-number">2</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; { log.fatal(<span class="hljs-string"><span class="hljs-string">"Got unknown message for WatcherActor: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$message</span></span></span><span class="hljs-string">. Terminating the app"</span></span>) exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>) } } }</code> </pre> <br>  But for this you have to run the actors with reference to the observer: <br><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Suspendable</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerAndWatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actorId: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, actorObject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Actor</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;*, *&gt;)</span></span></span></span>: ActorRef&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> ref = spawn(register(actorId, actorObject)) watcherActor.link(ref) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ref }</code> </pre> <br>  In general, according to impressions, many moments were inconvenient or not obvious.  Perhaps, ‚Äúwe just do not know how to cook‚Äù Quasar, but after Akka some moments look wildly.  For example, a method for implementing a query by the type of ask from Akka, which is buried somewhere in the utilities and still requires linking the types of the message-question and the message-answer (although on the other hand, this is a good feature that reduces the number of potential errors). <br><br>  Another serious problem arose with the completion of the actor.  What are the standard methods for this?  Maybe destroy, unspawn or unregister?  And no.  Only crutches: <br><br><pre> <code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T : Actor&lt;Any?, Any?&gt;</span></span></span><span class="hljs-function">&gt; T.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">finish</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ref().send(ExitMessage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ref(), <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.unregister() }</code> </pre> <br>  There is, of course, <code>ActorRegistry.clear()</code> , which removes ALL actors, but if you get into his gut, you can see the following: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Debug.isUnitTest()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"Must only be called in unit tests"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (registry <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> LocalActorRegistry) ((LocalActorRegistry) registry).clear(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnsupportedOperationException(); }</code> </pre> <br>  Yeah, only in unit tests can be called.  And how do they define it? <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isUnitTest = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; StackTraceElement[] stack = Thread.currentThread().getStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (StackTraceElement ste : stack) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ste.getClassName().startsWith(<span class="hljs-string"><span class="hljs-string">"org.junit"</span></span>) || ste.getClassName().startsWith(<span class="hljs-string"><span class="hljs-string">"junit.framework"</span></span>) || ste.getClassName().contains(<span class="hljs-string"><span class="hljs-string">"JUnitTestClassExecuter"</span></span>)) { isUnitTest = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } unitTest = isUnitTest;</code> </pre> <br>  Those.  if you suddenly use no junit - goodbye. <br><br>  Wait a minute, wait, here is the <code>ActorRegistry.shutdown()</code> method, it will surely cause the closure of every actor!  We look at the implementation of the abstract method in <code>LocalActorRegistry</code> : <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shutdown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre> <br><br>  One more thing, the library can mysteriously fall with some NPE for no apparent reason / explanation: <br><br>  <a href="https://github.com/puniverse/quasar/issues/182">https://github.com/puniverse/quasar/issues/182</a> <br><br>  In addition, if you use third-party libraries, problems may arise with them.  For example, in one of the dependencies, we had a library that communicated with iron (not very high-quality), in which was <code>Thread.sleep()</code> .  Quasar didn‚Äôt like it very much, and he spat on the logs with exceptions: they say, <code>Thread.sleep()</code> blocks the stream and this will have a bad effect on performance (see details <a href="http://docs.paralleluniverse.co/quasar/">here</a> ).  At the same time, there are no specific recipes for how to fix it (except for stupidly disabling the logging of such errors with the system flag) or at least ‚Äúunderstand and forgive‚Äù only for third-party libraries. <br><br>  And finally, Kotlin support leaves much to be desired - for example, checking the java-agent will swear at some of its methods (although the application itself can continue to work without visible problems): <br><br>  <a href="https://github.com/puniverse/quasar/issues/238">https://github.com/puniverse/quasar/issues/238</a> <br>  <a href="https://github.com/puniverse/quasar/issues/288">https://github.com/puniverse/quasar/issues/288</a> <br><br>  In general, the work had to be debugged by logs - and that was pretty sad. <br><br><h2>  Conclusion </h2><br>  In general, the impressions of the library are neutral.  According to impressions, the actors in it are implemented at the level of ‚Äúdemonstrating an idea‚Äù - it seems to work, but there are problems that usually come up during the first combat use.  Although the library <s>has</s> potential. <br><br>  We are still ‚Äúvery lucky‚Äù: an attentive reader might have noticed that the last release was in December 2016 (according to the documentation) or in July 2017 (according to the github).  And in the company's blog, the last entry is generally in July 2016 (with the intriguing title <a href="http://blog.paralleluniverse.co/2016/07/23/correctness-and-complexity/">Why Writing Correct Software Is Hard</a> ).  In general, the library is more dead than alive, so it‚Äôs better not to use it in production. <br><br>  <b>PS</b> Here the attentive reader may also ask - what, then, did Akka not use?  In principle, there were no criminal problems with it (although the chain of Kotlin-Java-Scala was actually obtained), but since  the project was not critical, we decided to try the ‚Äúnative‚Äù solution. </div><p>Source: <a href="https://habr.com/ru/post/350182/">https://habr.com/ru/post/350182/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350172/index.html">Unreal Engine Tutorial: Cel Shading</a></li>
<li><a href="../350174/index.html">Collaboration Visual Studio Code and Anaconda</a></li>
<li><a href="../350176/index.html">Who needs an architect?</a></li>
<li><a href="../350178/index.html">The obvious benefit: how and why to use the service approach beyond IT (Part 3)</a></li>
<li><a href="../350180/index.html">The Internet of Things: From Designing a Backend to Energy Absorption</a></li>
<li><a href="../350184/index.html">Crash Course on Docker: Learn to swim with big fish</a></li>
<li><a href="../350186/index.html">What I miss from Rust in C</a></li>
<li><a href="../350188/index.html">ASP.NET Core: Attack Prevention Mechanisms 2.0</a></li>
<li><a href="../350192/index.html">Deep learning in the cloud: optical computers will replace the GPU</a></li>
<li><a href="../350194/index.html">Antivirus usability on the phone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>