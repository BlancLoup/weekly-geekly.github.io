<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Collect and Filter Logon Events with Log Parser</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear community! 
 IT infrastructure is always in dynamics. Thousands of changes occur every minute. Many of them are required to register. Syst...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Collect and Filter Logon Events with Log Parser</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/dp/g3/zn/dpg3znf436w5an1xralwuv4keds.jpeg"><br><br><h4>  Hello, dear community! </h4><br>  IT infrastructure is always in dynamics.  Thousands of changes occur every minute.  Many of them are required to register.  System audit is an integral part of the information security of organizations.  Change control helps prevent serious accidents later on. <br><br>  In the article, I want to talk about my experience in tracking the events of users' logon (and logout) on the organization‚Äôs servers, describe in detail the details that arose in the course of performing the task of analyzing audit logs, and also bring the solution of this task step by step. <br><a name="habracut"></a><br><h4>  The goals we pursue are: </h4><br><ul><li>  Control of daily connections of users to the organization‚Äôs servers, including terminal ones. </li><li>  Registration of an event, both from domain users, and from local. </li><li>  Monitoring user activity (arrival / departure). </li><li>  Control of connections of IT departments to IB servers. </li></ul><br>  First you need to enable auditing and record logging events in Windows.  As a domain controller, we are provided with Windows Server 2008 R2.  By enabling auditing, you will need to extract, filter, and analyze events defined by the audit policy.  In addition, it is assumed to be sent to the third system for analysis, for example, to the DLP.  Alternatively, we will consider the possibility of generating a report in Excel. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Log analysis is a routine operation of the system administrator.  In this case, the volume of recorded events in the domain is such that it is difficult in itself.  Audit is included in Group Policy. <br><br>  Login events are generated by: <br><br>  1. domain controllers in the process of checking domain accounts; <br>  2. local computers when working with local accounts. <br><br>  If both categories of policies (user accounts and auditing) are enabled, then logins using the domain account will generate login or logout events on the workstation or server and a logon event on the domain controller.  Thus, the audit on domain machines will need to be configured through the GPO snap-in on the controller, the local audit - through the local security policy using the MMC snap-in. <br><br><h4>  Audit setup and infrastructure preparation: </h4><br>  Consider this stage in detail.  To reduce the amount of information we see only successful events of entry and exit.  It makes sense to increase the size of the Windows security log.  The default is 128 megabytes. <br><br>  To configure local policy: <br><br><img src="https://habrastorage.org/webt/dz/id/-h/dzid-hqp2mdojhb6ncwgak74fso.png" alt="image"><br><br>  Open the editor politician - Start, in the search bar, write gpedit.msc and press Enter. <br>  Open the following path: <b>Local Computer Policy ‚Üí Computer Configuration ‚Üí Windows Settings ‚Üí Security Settings ‚Üí Local Policies ‚Üí Audit Policy.</b> <br><br>  Double click on the group policy setting <b>Audit logon events</b> (login audit) and <b>Audit account logon events</b> (audit login events).  In the properties window, set the Success-checkbox to write to the log of successful logins.  I do not recommend setting the <b>Failure</b> checkbox to avoid overflow.  To apply the policy you need to type in the console gpupdate / force <br><br>  To configure group policy: <br><br>  Create a new GPO (group policy) with the name "Audit AD".  Go to the edit section and expand the <b>Computer Configuration ‚Üí Policies ‚Üí Windows Settings ‚Üí Security Settings ‚Üí Advanced Audit Configuration</b> branch.  This group policy branch contains advanced audit policies that can be activated on a Windows-based OS to track various events.  In Windows 7 and Windows Server 2008 R2, the number of events that can be audited is increased to 53. These 53 audit policies (so-called granular audit policies) are in the Security Settings \ Advanced Audit Policy branch <br><br>  Configuration and grouped into ten categories: <br><br>  Include: <br><br><img src="https://habrastorage.org/webt/os/yn/4g/osyn4gphwazezut-mx7-w6_intm.png" alt="image"><br><br><ul><li>  Account Logon - auditing credential verification, Kerberos authentication services, Kerberos ticket operations, and other login events; </li><li>  Logon / Logoff - auditing interactive and network login attempts on computers and domain servers, as well as account lockouts. </li></ul><br>  After the changes, run gpupdate / force. <br><br>  Immediately specify the types of events that our future script will analyze: <br><br><ol><li>  Remote access - remote access via RDP session. </li><li>  Interactive - local user login from the console. </li><li>  Computer unlocked - unlocking a locked station. </li><li>  Logoff - logout </li></ol><br>  In Windows 2008, the successful login event has the ID of Event ID 4624, and the logoff is the Event ID 4672. You need to select a tool that allows you to analyze a huge number of records.  It would seem that everything can be written using standard tools.  However, requests for Powershell view <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-eventlog <span class="hljs-keyword"><span class="hljs-keyword">security</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> {$_.EventId -eq <span class="hljs-number"><span class="hljs-number">4624</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($_.TimeGenerated.TimeOfDay -gt <span class="hljs-string"><span class="hljs-string">'08:00:00'</span></span> )}</code> </pre> <br>  show themselves well only on a stand with a two-user domain controller.  In production environments, collecting logs from the server took 20 minutes each.  The search for the solution led to the LOG PARSER utility, previously reviewed on Habr√©. <br><br>  Data processing speed increased several times, the full run with the formation of a report from one PC was reduced to 10 seconds.  The utility uses a lot of command line options, so we will call cmd from powershell to get rid of escaping a heap of special characters.  For writing requests, you can use the GUI - Log Parser Lizard.  It is not free, but the trial period of 65 days is enough.  Below is the request itself.  In addition to the ones that interest us, we will also write out other options for entering the system, in case of further use. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> eventid, timegenerated, extract_token(Strings, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LogonName, extract_token(Strings, <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LogonIP, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> extract_token(Strings, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'2'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'interactive'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'3'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'network'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'4'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'batch'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'service'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'7'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'unlocked workstation'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'8'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'network logon using a cleartext password'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'9'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'impersonated logons'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'10'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'remote access'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> extract_token(Strings, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LogonType, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> extract_token(Strings, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'SERVER$'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'logon'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> extract_token(Strings, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> \\<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>\c$\<span class="hljs-keyword"><span class="hljs-keyword">AUDIT</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>\report(<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>).csv <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> \\<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (EventID <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">4624</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> extract_token(Strings, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'10'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (EventID <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">4624</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> extract_token(Strings, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'2'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (EventID <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">4624</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> extract_token(Strings, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'7'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> EventID <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">4647</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO_DATE</span></span>( TimeGenerated ) = TO_LOCALTIME( SYSTEM_DATE() ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> Timegenerated <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br>  Next, I give a general description of the logic: <br><br><ol><li>  Manually create a list of hosts with a locally configured audit, or specify the domain controller from which we are taking logs. </li><li>  The script walks the list of host names in a loop, connects to each of them, starts the Remote registry service and, using the parser, executes an SQL audit.sql query to collect system security logs.  The query is modified for each new host with a primitive regular expression at each iteration.  The received data is saved in csv-files. </li><li>  From the CSV files, a report is generated in the Excel file (for beauty and convenience of searching) and the body of the letter in HTML format. </li><li>  A mail message is created separately for each report file and sent to the third system. </li></ol><br><h4>  Preparing a platform for the test script: </h4><br>  For the script to work correctly, the following conditions must be met: <br>  Create a directory on the server / workstation from which the script runs.  We place the script files in the : \ audit \ directory.  The list of hosts and the script are in the same directory. <br><br>  We install additional software on the <a href="https://technet.microsoft.com/ru-ru/scriptcenter/dd919274.aspx">MS Log Parser 2.2</a> server and Windows powershell 3.0 as part of the <a href="https://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34595">management framework</a> .  You can check the Powershell version by typing $ Host.version in the PS console. <br><br>  We fill in the list of servers for which we are interested in the list.txt for auditing in the : \ audit \ directory by workstation names.  Customize the audit policy.  Make sure it works. <br><br>  We check whether the remote registry service is running (the script attempts to start and put the service into automatic mode if it has the appropriate permissions).  On servers 2008/2012, this service is running by default. <br><br>  Check for administrator rights to connect to the system and collect logs. <br>  We check the ability to run unsigned powershell scripts on a remote machine (sign the script or bypass / disable the restriction policy). <br><br>  Attention to the launch parameters of unsigned scripts - execution policy on the server: <br>  You can bypass the ban by signing the script, or disable the policy itself at startup.  For example: <br><br><pre> <code class="hljs tex">powershell.exe -executionpolicy bypass -file :<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">audit</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">new</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">run</span></span></span></span>_v5.ps1</code> </pre> <br>  Here is the entire listing of the script: <br><br><pre> <code class="hljs scala"><span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">ChildItem</span></span> -<span class="hljs-type"><span class="hljs-type">Filter</span></span> report*|<span class="hljs-type"><span class="hljs-type">Remove</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> -<span class="hljs-type"><span class="hljs-type">Force</span></span> $date= get-date -uformat %<span class="hljs-type"><span class="hljs-type">Y</span></span>-%m-%d cd <span class="hljs-symbol"><span class="hljs-symbol">'C</span></span>:\<span class="hljs-type"><span class="hljs-type">Program</span></span> <span class="hljs-type"><span class="hljs-type">Files</span></span> (x86)\<span class="hljs-type"><span class="hljs-type">Log</span></span> <span class="hljs-type"><span class="hljs-type">Parser</span></span> <span class="hljs-number"><span class="hljs-number">2.2</span></span>\' $datadir=<span class="hljs-string"><span class="hljs-string">"C:\AUDIT\new\" $datafile=$datadir+"</span></span>audit.<span class="hljs-string"><span class="hljs-string">sql" </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$list</span></span></span><span class="hljs-string">=gc </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$datadir</span></span></span><span class="hljs-string">\"list.txt"</span></span> $data=gc $datafile $command=<span class="hljs-string"><span class="hljs-string">"LogParser.exe -i:EVT -o:CSV file:\\127.0.0.1\c$\audit\new\audit.sql"</span></span> $<span class="hljs-type"><span class="hljs-type">MLdir</span></span>= [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">Path</span></span>]::<span class="hljs-type"><span class="hljs-type">GetDirectoryName</span></span>($datadir) function send_email { $mailmessage = <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> system.net.mail.mailmessage $mailmessage.from = ($emailfrom) $mailmessage.<span class="hljs-type"><span class="hljs-type">To</span></span>.add($emailto) $mailmessage.<span class="hljs-type"><span class="hljs-type">Subject</span></span> = $emailsubject $mailmessage.<span class="hljs-type"><span class="hljs-type">Body</span></span> = $emailbody $attachment = <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> <span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Net</span></span>.<span class="hljs-type"><span class="hljs-type">Mail</span></span>.<span class="hljs-type"><span class="hljs-type">Attachment</span></span>($emailattachment, <span class="hljs-symbol"><span class="hljs-symbol">'text</span></span>/plain') $mailmessage.<span class="hljs-type"><span class="hljs-type">Attachments</span></span>.<span class="hljs-type"><span class="hljs-type">Add</span></span>($attachment) #$<span class="hljs-type"><span class="hljs-type">SMTPClient</span></span>.<span class="hljs-type"><span class="hljs-type">EnableSsl</span></span> = $<span class="hljs-literal"><span class="hljs-literal">true</span></span> $mailmessage.<span class="hljs-type"><span class="hljs-type">IsBodyHTML</span></span> = $<span class="hljs-literal"><span class="hljs-literal">true</span></span> $<span class="hljs-type"><span class="hljs-type">SMTPClient</span></span> = <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> <span class="hljs-type"><span class="hljs-type">Net</span></span>.<span class="hljs-type"><span class="hljs-type">Mail</span></span>.<span class="hljs-type"><span class="hljs-type">SmtpClient</span></span>($<span class="hljs-type"><span class="hljs-type">SmtpServer</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>) #$<span class="hljs-type"><span class="hljs-type">SMTPClient</span></span>.<span class="hljs-type"><span class="hljs-type">Credentials</span></span> = <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> <span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Net</span></span>.<span class="hljs-type"><span class="hljs-type">NetworkCredential</span></span>(<span class="hljs-string"><span class="hljs-string">"$SMTPAuthUsername"</span></span>, <span class="hljs-string"><span class="hljs-string">"$SMTPAuthPassword"</span></span>) $<span class="hljs-type"><span class="hljs-type">SMTPClient</span></span>.<span class="hljs-type"><span class="hljs-type">Send</span></span>($mailmessage) } foreach ($<span class="hljs-type"><span class="hljs-type">SERVER</span></span> in $list) { <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Service</span></span> -<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-type"><span class="hljs-type">RemoteRegistry</span></span> -<span class="hljs-type"><span class="hljs-type">ComputerName</span></span> $<span class="hljs-type"><span class="hljs-type">SERVER</span></span> | set-service -startuptype auto <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Service</span></span> -<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-type"><span class="hljs-type">RemoteRegistry</span></span> -<span class="hljs-type"><span class="hljs-type">ComputerName</span></span> $<span class="hljs-type"><span class="hljs-type">SERVER</span></span> | <span class="hljs-type"><span class="hljs-type">Start</span></span>-service $pattern=<span class="hljs-string"><span class="hljs-string">"FROM"</span></span>+<span class="hljs-string"><span class="hljs-string">" "</span></span>+<span class="hljs-string"><span class="hljs-string">"\\$SERVER"</span></span>+<span class="hljs-string"><span class="hljs-string">"\Security"</span></span> $pattern2=<span class="hljs-string"><span class="hljs-string">"report"</span></span>+<span class="hljs-string"><span class="hljs-string">"("</span></span>+$<span class="hljs-type"><span class="hljs-type">SERVER</span></span>+<span class="hljs-string"><span class="hljs-string">")"</span></span>+<span class="hljs-string"><span class="hljs-string">"."</span></span>+<span class="hljs-string"><span class="hljs-string">"csv"</span></span> $data -replace <span class="hljs-string"><span class="hljs-string">"FROM\s+\\\\.+"</span></span>, <span class="hljs-string"><span class="hljs-string">"$pattern"</span></span> -replace <span class="hljs-string"><span class="hljs-string">"report.+"</span></span>, <span class="hljs-string"><span class="hljs-string">"$pattern2"</span></span>|set-content $datafile &lt;# #<span class="hljs-type"><span class="hljs-type">IF</span></span> <span class="hljs-type"><span class="hljs-type">WE</span></span> <span class="hljs-type"><span class="hljs-type">USE</span></span> <span class="hljs-type"><span class="hljs-type">IP</span></span> <span class="hljs-type"><span class="hljs-type">LIST</span></span> $data -replace <span class="hljs-string"><span class="hljs-string">"FROM\s+\\\\([0-9]{1,3}[\.]){3}[0-9]{1,3}"</span></span>, <span class="hljs-string"><span class="hljs-string">"$pattern"</span></span> -replace <span class="hljs-string"><span class="hljs-string">"report.+"</span></span>, <span class="hljs-string"><span class="hljs-string">"$pattern2"</span></span>|set-content $datafile #&gt; cmd /c $command } cd $datadir foreach ($file in <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">ChildItem</span></span> $datadir -<span class="hljs-type"><span class="hljs-type">Filter</span></span> report*) { #creating excel doc# $excel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">-comobject</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">excel</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">application</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$excel</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visible</span></span></span><span class="hljs-class"> </span></span>= $<span class="hljs-literal"><span class="hljs-literal">false</span></span> $workbook = $excel.workbooks.add() $workbook.workSheets.item(<span class="hljs-number"><span class="hljs-number">3</span></span>).delete() $workbook.<span class="hljs-type"><span class="hljs-type">WorkSheets</span></span>.item(<span class="hljs-number"><span class="hljs-number">2</span></span>).delete() $workbook.<span class="hljs-type"><span class="hljs-type">WorkSheets</span></span>.item(<span class="hljs-number"><span class="hljs-number">1</span></span>).<span class="hljs-type"><span class="hljs-type">Name</span></span> = <span class="hljs-string"><span class="hljs-string">"Audit"</span></span> $sheet = $workbook.<span class="hljs-type"><span class="hljs-type">WorkSheets</span></span>.<span class="hljs-type"><span class="hljs-type">Item</span></span>(<span class="hljs-string"><span class="hljs-string">"Audit"</span></span>) $x = <span class="hljs-number"><span class="hljs-number">2</span></span> $colorIndex = <span class="hljs-string"><span class="hljs-string">"microsoft.office.interop.excel.xlColorIndex"</span></span> -as [<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$borderWeight</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-string"><span class="hljs-string">"microsoft.office.interop.excel.xlBorderWeight"</span></span> -as [<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$chartType</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-string"><span class="hljs-string">"microsoft.office.interop.excel.xlChartType"</span></span> -as [<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">For</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">$b = 1 ; $b -le 5 ; $b++</span></span></span><span class="hljs-class">) </span></span>{ $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,$b).font.bold = $<span class="hljs-literal"><span class="hljs-literal">true</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,$b).borders.<span class="hljs-type"><span class="hljs-type">ColorIndex</span></span> = $colorIndex::xlColorIndexAutomatic $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,$b).borders.weight = $borderWeight::xlMedium } $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) = <span class="hljs-string"><span class="hljs-string">"EventID"</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) = <span class="hljs-string"><span class="hljs-string">"TimeGenerated"</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) = <span class="hljs-string"><span class="hljs-string">"LogonName"</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>) = <span class="hljs-string"><span class="hljs-string">"LogonIP"</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>) = <span class="hljs-string"><span class="hljs-string">"LogonType"</span></span> $sheet.cells.item(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) = <span class="hljs-string"><span class="hljs-string">"Type"</span></span> <span class="hljs-type"><span class="hljs-type">Foreach</span></span> ($row in $data=<span class="hljs-type"><span class="hljs-type">Import</span></span>-<span class="hljs-type"><span class="hljs-type">Csv</span></span> $file -<span class="hljs-type"><span class="hljs-type">Delimiter</span></span> ',' -<span class="hljs-type"><span class="hljs-type">Header</span></span> <span class="hljs-type"><span class="hljs-type">EventID</span></span>, <span class="hljs-type"><span class="hljs-type">TimeGenerated</span></span>, <span class="hljs-type"><span class="hljs-type">LogonName</span></span>, <span class="hljs-type"><span class="hljs-type">LogonIP</span></span>, <span class="hljs-type"><span class="hljs-type">LogonType</span></span>, <span class="hljs-type"><span class="hljs-type">Tipe</span></span>) { $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">1</span></span>) = $row.<span class="hljs-type"><span class="hljs-type">EventID</span></span> $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">2</span></span>) = $row.<span class="hljs-type"><span class="hljs-type">TimeGenerated</span></span> $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">3</span></span>) = $row.<span class="hljs-type"><span class="hljs-type">LogonName</span></span> $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">4</span></span>) = $row.<span class="hljs-type"><span class="hljs-type">LogonIP</span></span> $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">5</span></span>) = $row.<span class="hljs-type"><span class="hljs-type">LogonType</span></span> $sheet.cells.item($x,<span class="hljs-number"><span class="hljs-number">6</span></span>) = $row.<span class="hljs-type"><span class="hljs-type">Tipe</span></span> $x++ } $range = $sheet.usedRange $range.<span class="hljs-type"><span class="hljs-type">EntireColumn</span></span>.<span class="hljs-type"><span class="hljs-type">AutoFit</span></span>() | <span class="hljs-type"><span class="hljs-type">Out</span></span>-<span class="hljs-type"><span class="hljs-type">Null</span></span> $<span class="hljs-type"><span class="hljs-type">Excel</span></span>.<span class="hljs-type"><span class="hljs-type">ActiveWorkbook</span></span>.<span class="hljs-type"><span class="hljs-type">SaveAs</span></span>($<span class="hljs-type"><span class="hljs-type">MLdir</span></span> +'\'+<span class="hljs-symbol"><span class="hljs-symbol">'Audi</span></span>t'+ $file.basename.trim(<span class="hljs-string"><span class="hljs-string">"report"</span></span>)+ $date +'.xlsx') <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($workbook -ne $<span class="hljs-literal"><span class="hljs-literal">null</span></span>) { $sheet = $<span class="hljs-literal"><span class="hljs-literal">null</span></span> $range = $<span class="hljs-literal"><span class="hljs-literal">null</span></span> $workbook.<span class="hljs-type"><span class="hljs-type">Close</span></span>($<span class="hljs-literal"><span class="hljs-literal">false</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($excel -ne $<span class="hljs-literal"><span class="hljs-literal">null</span></span>) { $excel.<span class="hljs-type"><span class="hljs-type">Quit</span></span>() $excel = $<span class="hljs-literal"><span class="hljs-literal">null</span></span> [<span class="hljs-type"><span class="hljs-type">GC</span></span>]::<span class="hljs-type"><span class="hljs-type">Collect</span></span>() [<span class="hljs-type"><span class="hljs-type">GC</span></span>]::<span class="hljs-type"><span class="hljs-type">WaitForPendingFinalizers</span></span>() } $emailbody= <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>-csv $file|<span class="hljs-type"><span class="hljs-type">ConvertTo</span></span>-<span class="hljs-type"><span class="hljs-type">Html</span></span> $<span class="hljs-type"><span class="hljs-type">EmailFrom</span></span> = <span class="hljs-string"><span class="hljs-string">"audit@vda.vdg.aero"</span></span> $<span class="hljs-type"><span class="hljs-type">EmailTo</span></span> = foreach ($a in (<span class="hljs-type"><span class="hljs-type">Import</span></span>-<span class="hljs-type"><span class="hljs-type">Csv</span></span> -<span class="hljs-type"><span class="hljs-type">Path</span></span> $file).logonname){$a+<span class="hljs-string"><span class="hljs-string">"@"</span></span>+<span class="hljs-string"><span class="hljs-string">"tst.com"</span></span>} $<span class="hljs-type"><span class="hljs-type">EmailSubject</span></span> = <span class="hljs-string"><span class="hljs-string">"LOGON"</span></span> $<span class="hljs-type"><span class="hljs-type">SMTPServer</span></span> = <span class="hljs-string"><span class="hljs-string">"10.60.34.131"</span></span> #$<span class="hljs-type"><span class="hljs-type">SMTPAuthUsername</span></span> = <span class="hljs-string"><span class="hljs-string">"username"</span></span> #$<span class="hljs-type"><span class="hljs-type">SMTPAuthPassword</span></span> = <span class="hljs-string"><span class="hljs-string">"password"</span></span> $emailattachment = <span class="hljs-string"><span class="hljs-string">"$datadir"</span></span>+<span class="hljs-string"><span class="hljs-string">"$file"</span></span> #$$filexls send_email }</code> </pre> <br>  For full-fledged reports in Excel, we install Excel on the station / server with which the script works. <br><br>  We add a script to the Windows scheduler for daily execution.  The optimal time is the end of the day - the search for events is conducted in the last 24 hours. <br><br>  Event search is possible, starting with Windows 7, Windows server 2008. <br>  Earlier Windows have other event codes (code value is 4096 less). <br><br><h4>  Notes and conclusion: </h4><br>  Once again, summarize the actions performed: <br><br><ol><li>  Configured local and domain audit policies on the servers you need and collected a list of servers. </li><li>  We chose a machine to run the script, installed the necessary software (PS 3.0, LOG PARSER, Excel). </li><li>  Wrote a request for LOG PARSER. </li><li>  We wrote a script that runs this query in a loop for the list ,. </li><li>  Wrote the rest of the script, processing the results. </li><li>  Set up a daily scheduler. </li></ol><br>  Previously generated reports are in the directory until the next script execution.  The list of users who made the connection is automatically added to the recipients of the letter.  This is done for correct processing when sending a report to the analysis system.  In general, thanks to LOG PARSER, it turned out quite powerful, and, perhaps, the only means of automating this task.  Surprisingly, such a useful utility with extensive capabilities is not widely distributed.  The disadvantages of the utility include weak documentation.  Requests are performed by trial and error.  I wish you successful experiments! </div><p>Source: <a href="https://habr.com/ru/post/345022/">https://habr.com/ru/post/345022/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345012/index.html">Task with an asterisk: how we recoded the FIAS in KLADR</a></li>
<li><a href="../345014/index.html">How to manage sections in Oracle DB and not go crazy</a></li>
<li><a href="../345016/index.html">Polymer, fight for performance</a></li>
<li><a href="../345018/index.html">Tutorial on the Unreal Engine. Part 7: Sound</a></li>
<li><a href="../345020/index.html">How I hacked 40 sites in 7 minutes (transfer)</a></li>
<li><a href="../345024/index.html">How to read a large file using PHP (without crashing a server)</a></li>
<li><a href="../345026/index.html">How we created an online service for learning English: from startup to flourish</a></li>
<li><a href="../345028/index.html">Magically vanishing JS framework</a></li>
<li><a href="../345030/index.html">Building maintenance: what will happen if you go wisely once</a></li>
<li><a href="../345032/index.html">Modeling enterprise assets using projection modeling</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>