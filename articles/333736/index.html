<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to move from KLADR to FIAS and do not break anything</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="GNIVTS FTS informs that since the beginning of 2018 KLADR will cease to exist and will not be able to download it. 

 Disclaimer: 
 If you do not unde...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to move from KLADR to FIAS and do not break anything</h1><div class="post__text post__text-html js-mediator-article">  GNIVTS FTS <a href="http://fias.nalog.ru/NewsViewPage.aspx%3Fid%3D10020">informs</a> that since the beginning of 2018 KLADR will cease to exist and will not be able to download it. <br><br><blockquote>  <strong>Disclaimer:</strong> <br>  If you do not understand at all what these sets of letters mean, do not worry.  Below we describe the realities of working with addresses in Russia.  If you are not interested, read about <a href="https://habrahabr.ru/company/hflabs/blog/314786/">topographical quibbles</a> . </blockquote><br>  Correct addresses are needed for companies that love their customers.  Familiar banks, insurance and online stores, which now use the KLADR directory, ask us what to do next.  Therefore, we wore out and wrote a step-by-step guide on the transition <s>from one letter to another</s> from KLADR to FIAS. <br><br><img src="https://habrastorage.org/web/415/854/cf8/415854cf8c8440f69c0404f4872fe5c6.jpg"><br><a name="habracut"></a><br><h2>  Why are address classifiers needed? </h2><br>  Companies need customer addresses to send letters, specify in contracts and agreements.  But it is not enough just to send a letter: it is desirable that it be received and read.  Therefore, the addresses must be correct and understandable. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>  What do you think, what state body is most interested in receiving letters from him?  Right!  Tax.  Therefore, the Federal Tax Service of Russia has been developing and supporting the departmental all-Russian address classifiers for many years.  And since there are no more complete directories, they have been used everywhere. <br><br>  First there was KLADR, and there were 6 levels in it: <br></p><blockquote>  Region ‚Üí District ‚Üí City ‚Üí Town ‚Üí Street ‚Üí House with buildings and buildings </blockquote><br><p>  Since 2012, a new classifier, FIAS, has been commissioned.  We wrote about the main differences three years ago in the article <a href="https://habrahabr.ru/company/hflabs/blog/230823/">‚ÄúFIAS or KLADR: we choose the reference book of addresses‚Äù</a> .  In the FTS, the development of a new classifier approached more thoroughly and tried to take into account all the <s>mistakes of</s> KLADR.  From the interesting added date of the beginning and end of the recording, entered a fixed ID for each house (it is assumed that it will not change). <br><br>  Both classifiers are still being updated, but compatibility is becoming more difficult to maintain.  Last year, new levels began to be added to FIAS.  For example, planning structures are all kinds of country partnerships and microdistricts, in the classifier there are already more than 81,000. Finally, the Federal Tax Service made a logical decision to stop supporting KLADR and remove it at the end of 2017. </p><br><br><h2>  How addresses are stored in FIAS and KLADR </h2><br>  We have seen many ways to store addresses in the KLADR structure.  Basically they boil down to two options: <br><br><ol><li>  Code KLADR to the street + house part of the form <i>"house 1 building 3 apartment 33</i> ", as parts of the houses in the classifier are stored as ranges </li><li>  Address in the form of text - one field or divided by structure KLADR. </li></ol><br>  Since there is no part of houses in FIAS, we recommend storing the address as: <br><br><ol><li>  FIAS code to the street + house + apartment to identify the address ( <a href="https://habrahabr.ru/company/hflabs/blog/301014/">detailed recommendations</a> ). <br></li><li>  Address in one line in FIAS format.  It is better to keep the original address.  FIAS is still a tax reference book, and not everything is there. </li></ol><br><p>  That is, the task of migration is reduced to translating the code or text address in the KLADR format into the FIAS code. <br></p><blockquote>  Classification codes look like this: <br><br><ul><li>  <b>KLADR</b> : SS + PPP + YYY + PPP + UUUU + DDDD; </li><li>  <b>FIAS</b> : SS + PPP + YYY + PPP + SSSS + UUUU + DDDD (or ZZZZ) + OOOO. </li></ul></blockquote><br>  It looks scary, consider an example: Leningrad region, Vsevolozhsk district, the village of Kudrovo, md New Okkervil.  The address really exists, here <a href="https://yandex.ru/maps/-/CBQg4OWnTB">it is on Yandex.Maps</a> .  At first glance, the classification code of KLADR and FIAS looks the same for it: <i>470050000550023</i> .  We decompose it into components. <br><table><tbody><tr><td>  <b>No</b> </td><td>  <b>Level</b> </td><td>  <b>Example</b> </td><td>  <b>FIAS code</b> </td><td>  <b>code KLADR</b> </td></tr><tr><td>  one </td><td>  Region </td><td>  Leningrad region </td><td>  <i>SS</i> : 47 </td><td>  <i>SS</i> : 47 </td></tr><tr><td>  2 </td><td>  Autonomous District </td><td></td><td></td><td></td></tr><tr><td>  3 </td><td>  Area </td><td>  Vsevolozhsk district </td><td>  <i>PPP</i> : 005 </td><td>  <i>PPP</i> : 005 </td></tr><tr><td>  four </td><td>  City </td><td></td><td>  <i>YYY</i> : 000 </td><td>  <i>YYY</i> : 000 </td></tr><tr><td>  five </td><td>  Urban territory </td><td></td><td></td><td></td></tr><tr><td>  6 </td><td>  Locality </td><td>  village Kudrovo </td><td>  <i>SPT</i> : 055 </td><td>  <i>SPT</i> : 055 </td></tr><tr><td>  65 </td><td>  Planning structure </td><td>  md New Okkervil </td><td>  <i>SCCS</i> : 0023 </td><td></td></tr><tr><td>  7 </td><td>  The outside </td><td></td><td>  <i>Woooo</i> </td><td>  <i>WOW</i> : 0023 </td></tr><tr><td>  75 </td><td>  Land plot </td><td></td><td>  <i></i> </td><td></td></tr><tr><td>  eight </td><td>  Building, structure, object under construction </td><td></td><td>  <i>DDDD</i> </td><td>  <i>DDDD</i> </td></tr><tr><td>  9 </td><td>  The room within the building </td><td></td><td>  <i>OOOO</i> </td><td></td></tr><tr><td>  90 </td><td>  Additional territory </td><td></td><td></td><td></td></tr><tr><td>  91 </td><td>  Subordinate additional areas </td><td></td><td></td><td></td></tr></tbody></table>  <i><font color="grey">We spread the address on the FIAS and KLADR levels</font></i> <br><br>  It is clear from the example that even in simple situations there is a misunderstanding between classifiers.  But there is another very important point. <br><br>  The classification code reflects the current address structure, and it may change.  For example, at Okkervil the area will change and all code will become invalid, we will not find it any more. <br><br>  To get rid of this, a FIAS <b>identification code was</b> added to <b>FIAS</b> .  This is a global identifier for each object: city, street, district, etc. It looks like a set of letters and numbers, which is formed according to the GUID standard (Globally Unique Identifier).  A typical GUID in FIAS looks like this: <i>f77948dc-7bc8-42cb-979e-2c958d162d63</i> . <br><br><h2>  KLADR code ‚Üí FIAS identification code </h2><br>  If your address is stored as KLADR street code + house part (‚Äúhouse 1 building 3 apartment 44‚Äù), then everything is relatively simple for it. <br><br><img src="https://habrastorage.org/web/19c/c20/e68/19cc20e68f6d4ab99b7af85d4537aabd.png"><br>  <i><font color="grey">The ADDROBJ table stores all address objects with their identifiers.</font></i> <br><br>  For the work, you will need the table ADDROBJ from the FIAS download in xml or dbf format.  It stores all objects (cities, streets, etc.) in a row with unique GUIDs. <br><blockquote>  We will use the following columns: <br><br><ul><li>  KLADR code (PlainCode); </li><li>  name and type of text (FormalName and ShortName); </li><li>  the relevance of the object (CurrStatus); </li><li>  zip code (PostalCode); </li><li>  own and parent identifier of FIAS (AoGuid and ParentGuid); </li><li>  level (AoLevel). </li></ul></blockquote><br>  Example: <i>Moscow, Alexander Solzhenitsyn st</i> .  KLADR code: <i><i>77000000000151900</i></i> . <br><br><p>  <b>Step 1.</b> Select from the code KLADR code to the street, that is, take the first 15 digits: <i><font color="green">770000000001519</font> 00</i> . <br></p><ul><li>  If KLADR is less than 15 digits, we take 11 and add zeros - this is the code to the settlement: <i><font color="green">77000000000</font> <font color="red">0000</font></i> ; </li><li>  Less than 11 digits - we take 8: <i><font color="green">77000000</font> <font color="red">000000000</font></i> ; </li><li>  Less than 8 - we take 5: <i><font color="green">77000</font> <font color="red">000000000000</font></i> ; </li><li>  Less than 5 - take 2 digits of the region code: <i><font color="green">77 <font color="red">000000000000000</font></font> .</i> <br></li></ul><br><p>  <b>Step 2.</b> We are looking for the KLADR code in the PlainCode field.  If one record is found, then save the value of the AoGuid field and skip the next item.  But according to our code <font color="green">770000000001519</font> there are three records, we need additional verification. <br><br>  <b>Step 3.</b> Find the current entry.  A field value of CurrStatus = 0 means that the entry is current.  Select it and save the value of the AoGuid field.  FIAS identification code found! <br></p><ul><li>  Alexander Solzhenitsyn, CurrStatus = 2; </li><li>  Communist B., CurrStatus = 1; </li><li>  Alexander Solzhenitsyn, CurrStatus = 0, AuGuid = <font color="green">f77948dc-7bc8-42cb-979e-2c958d162d63</font> . </li></ul><br>  <b>As a bonus,</b> let's collect a text address from the AoGuid found: <br><p></p><ul><li>  we take PostalCode is a zip code: <font color="green"><i>109004</i></font> </li><li>  add ShortName and FormalName: <font color="green"><i>109004, ul.</i></font>  <font color="green"><i>Alexandra Solzhenitsyn</i></font> </li><li>  if the object is a region (field AoLevel = 1), then the address is ready.  But in our case, AoLevel = 7 is the street.  Therefore, we look for the parent element in the ParentGuid field and repeat the previous item; </li><li>  for Aleksandr Solzhenitsyn Street, the parent record immediately has the level of the region - this is Moscow.  Save ShortName and FormalName and collect the address: <font color="green"><i>109004, Moscow, st.</i></font>  <font color="green"><i>Alexandra Solzhenitsyn</i></font> </li></ul><br><p>  But you can do even easier and use the ready-made service.  DaData.ru is able to suggest addresses in specific regions, districts, cities and localities.  Understands the names (" <i>Peterhof</i> "), the KLADR codes (" <i>7800000800000</i> ") and FIAS (" <i>8f238984-812b-4bb1-850b-49749fb5c56d</i> "). </p><br><h2>  Line address KLADR ‚Üí FIAS code </h2><br>  The easiest option is to use <a href="https://dadata.ru/clean/%3Futm_source%3Dhabr%26utm_medium%3Dcpc%26utm_campaign%3Dkladr_fias">DaData.ru</a> .  The service will do everything for you automatically.  But you can have fun yourself. <br><br><h3>  <font color="grey">Single line addresses</font> </h3><br><p>  If your addresses are stored in one line, like this: <br>  <i>Mr. Moscow, Bolshaya Kommunisticheskaya Street, Building 3,</i> congratulations, this is the most interesting task.  You need to write your own address parser, which will divide the string in KLADR format into parts, look for each of its components in FIAS, taking into account typos, abbreviations, historical names and determine the FIAS-code from them.  It is easier to do this with a ready-made address parser.  <a href="https://habrahabr.ru/company/hflabs/blog/240633/">How to choose an algorithm for the address filter</a> , we told earlier. <br><br></p><h3>  <font color="grey">Addresses on KLADR</font> </h3><br>  If your addresses are stored in KLADR, the task is a little easier. <br><table><tbody><tr><td>  <b>Type of region</b> </td><td>  <b>Name of the region</b> </td><td>  <b>Street type</b> </td><td>  <b>Street name</b> </td><td>  <b>House type</b> </td><td>  <b>House number</b> </td></tr><tr><td>  g </td><td>  Moscow </td><td>  the outside </td><td>  Communist B. </td><td>  house </td><td>  3 </td></tr></tbody></table>  <i><font color="grey">Something like this looks like the address spread out on KLADR</font></i> <br><br>  The FIAS code can be collected using the same ADDROBJ table.  But in this case you need to move through the levels from larger to smaller. <br><br><p>  <b>Step 1.</b> We take the name of the region and look for it in the FormalName field of the ADDROBJ table. <br><br>  <i>FormalName = <b>Moscow</b> ‚Üí</i> <i><br></i>  <i>AoGuid = <b>0c5b2444-70a0-4932-980c-b4dc0d3f02b5</b></i> </p><br><p>  <b>Step 2.</b> Go further down the levels and look for FormalName with a fixed parent - found by AoGuid in the previous step.  In our case, the ‚Äúcity‚Äù and ‚Äúsettlement‚Äù levels are empty, and the next non-empty level is the street. <br><br>  <i>ParentGuid = <b>0c5b2444-70a0-4932-980c-b4dc0d3f02b5</b> ,</i> <i><br></i>  <i>FormalName = Communist B. ‚Üí AoGuid = <b>f77948dc-7bc8-42cb-979e-2c958d162d63</b></i> </p><br><p>  <b>Step 3.</b> If you reach the street, you can find a house.  To do this, look at the HOUSE table for a house number with a fixed street AoGuid.  FIAS is not full of houses, so do not be discouraged if the desired number is not found. <br><br>  <i>AoGuid = <b>f77948dc-7bc8-42cb-979e-2c958d162d63</b> ,</i> <i><br></i>  <i>house number <b>3</b> ‚Üí</i> <i><br></i>  <i>HouseGuid = <b>bce8be1f-f2f7-4cce-836e-08daac0b931e</b></i> </p><br><h3>  <font color="grey">Underwater rocks</font> </h3><br>  Can something go wrong?  Of course.  For example, the name can easily find several objects.  "Moscow, Tverskaya" - is it about the square or about the street?  Then you need to compare types, but not everything is so simple. <br><table><tbody><tr><td>  <b>LEVEL</b> </td><td>  <b>SCNAME</b> </td><td>  <b>SOCRNAME</b> </td><td>  <b>KOD_T_ST</b> </td></tr><tr><td>  7 </td><td>  tract </td><td>  Tract </td><td>  727 </td></tr><tr><td>  7 </td><td>  dumb </td><td>  Dead end </td><td>  728 </td></tr><tr><td>  7 </td><td>  street </td><td>  The outside </td><td>  729 </td></tr><tr><td>  7 </td><td>  uch-to </td><td>  Plot </td><td>  730 </td></tr><tr><td>  7 </td><td>  f / x </td><td>  Farm </td><td>  789 </td></tr><tr><td>  7 </td><td>  farm </td><td>  Farm </td><td>  769 </td></tr><tr><td>  7 </td><td>  x </td><td>  The farm </td><td>  758 </td></tr><tr><td>  7 </td><td>  sh </td><td>  Highway </td><td>  731 </td></tr></tbody></table>  <i><font color="grey">The SOCRBASE table stores the full and abbreviated object types.</font></i> <br><br>  The KLADR type can be abbreviated and complete: ‚Äúul‚Äù - ‚ÄúStreet‚Äù, ‚Äúx‚Äù - ‚ÄúKhutor‚Äù.  Only abbreviated type is stored in FIAS explicitly (in the field ShortName).  A full type into an abbreviated type can be turned using the SOCRBASE table, for each level it stores the correspondence of abbreviated and full types. <br><br>  ¬ß ¬ß ¬ß <br><br>  And finally, the good news for those who are too lazy to bother with all of the above.  In the near future, we plan to release FIAS in the KLADR format for those who do not have time to switch to the FIAS format by the end of the year.  Follow the news :-) <br><br>  PS Thank you for the invaluable help in creating this article by my colleagues on HFLabs, <a href="https://habrahabr.ru/users/mehanizm/">Mikhail Berezin</a> , Elena Rastorguev and <a href="https://habrahabr.ru/users/nalgeon/">Anton Zhiyanov</a> . </div><p>Source: <a href="https://habr.com/ru/post/333736/">https://habr.com/ru/post/333736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333724/index.html">Currency exchange: fix the course for offline online. VTB24 experience</a></li>
<li><a href="../333728/index.html">Wolfram Summer School 2017: the story of the participant</a></li>
<li><a href="../333730/index.html">Step-by-step manual how to bring in equipment on which there is no notification of FSB</a></li>
<li><a href="../333732/index.html">IT Infrastructure Audit - How to Be a Newbie</a></li>
<li><a href="../333734/index.html">The selected UI framework is a mischief. Architectural Requirements - Profit</a></li>
<li><a href="../333738/index.html">XBRL: just about the complex - Chapter 3. Anatomy of taxonomy</a></li>
<li><a href="../333742/index.html">Visual Tcl. GUI Development for Command Line Utilities (Continued)</a></li>
<li><a href="../333744/index.html">Localization can be automated: the experience of using Lokalise in combat conditions</a></li>
<li><a href="../333746/index.html">How to please the viewer and not lose money: make up a procurement plan with the help of ML</a></li>
<li><a href="../333748/index.html">ICO: Basic Jurisdictions and Issues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>