<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authorization on the site through the social networking API with integration into Spring Security</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I decided to implement authorization (registration) and user identification on the portal being developed using the Social Networks REST API (Social N...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authorization on the site through the social networking API with integration into Spring Security</h1><div class="post__text post__text-html js-mediator-article">  I decided to implement authorization (registration) and user identification on the portal being developed using the Social Networks REST API (Social Networks Developer Tool) - the topic is far from being innovative, it is actively used and very convenient to use.  I would not like to list all the conveniences and advantages of using such functionality on my websites, but I note that I am very happy not to remember the passwords for each website (even if I have a couple of standard ones used), not to participate in tedious registrations with email forwarding and confirmations, as well as once again not to encounter captcha. <br><a name="habracut"></a><br>  The functionality of the API data is quite primitive, the technology is simple, and the implementation is quite the same type and simple.  But when you get acquainted with the technology, the documentation and API examples of this or that social network are not enough.  In addition, as written in the topic, the language used is Java, which automatically reduces the amount of useful information.  And there are not so many descriptions in runet.  You can take the path of least resistance and use third-party RESTful products, but a) it does not provide a complete understanding of the process;  b) reduces the switching properties of the required process;  c) often, the study of a third-party product may be more difficult to develop its implementation.  Although the convenience of using such a third-party product can greatly facilitate development.  However, I personally in this review put emphasis on maximally controlling all processes, even to the detriment of universality (we ‚Äúscrew‚Äù specific functionality to a specific site, and only a few make this a universal product ‚Äúfor all occasions‚Äù).  In addition, I am interested not only in implementing user authorization, but also in implementing the project security system provided by the Spring Security 3 framework. <br><br>  Used set of platforms and tools: <em>Spring Core 3.1</em> , <em>Spring MVC 3.1</em> , <em>Spring Security 3.1</em> , <em>Hibernate 4.1</em> .  The implementation project is foreign, so the set of social networks being implemented is standard ‚Äúfor them‚Äù - <em>Facebook</em> , <em>Twitter</em> , <em>Google+</em> , <em>LinkedIn</em> . <br><br>  I want to note that in the Spring package there is a ready project out of the box - <em>Spring Social</em> (today release 1.0.2), which is wonderfully encapsulated in the Spring framework of the product and intended for use with other Spring products.  Surely this would be a professional decision, but our task is to control everything and make the process as transparent as possible for understanding.  Not so smooth with Social itself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  1. Model. </h4><br>  I went in a somewhat risky and controversial way, combining in a user object both <em>POJO</em> , <em>UserDetails</em> , and <em>Entity</em> .  From the point of view of programming, this is wrong, but a) is very convenient;  and b) it saves the creation of several layers, saving us from doing separate POJO + Entity, separate UserDetails and separate DTO, which actually duplicates the content. <br><br>  The proposed model building scheme is as follows: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/799/678/17d/79967817de8f230538f8cc639b9272ee.png" alt="image"><br>  I singled out two layers (AuthUser and DataUser) in order not to interfere with each other the authorization logic with the business logic of the project: the visitor, and the administrator, and whoever is - authorize in the same way, but have their own set of properties.  For example, I have Jobseekers and Employers in the project, they come to the site in the same way, but have a completely different model structure. <br><br>  As for the separation of the structure inside the layers, it is obvious - the set of received fields from Facebook, Twitter, etc., and especially with standard authorization, is so different that creating one terribly stretched structure for everything is just silly and from the point of view of building a database - redundantly.  As for scalability, when adding a new service provider, working with such a structure would be extremely inconvenient. <br><br>  Listings of some of the listed objects, as well as used enum classes. <br><br><h6>  AuthUser.java: </h6><br><pre><code class="java hljs">@ Entity @ Table(name = <span class="hljs-string"><span class="hljs-string">"auth_user"</span></span>) @ Inheritance(strategy = InheritanceType.JOINED) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthUser</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDetails</span></span></span><span class="hljs-class"> </span></span>{ @ Id @ Column(name = <span class="hljs-string"><span class="hljs-string">"id"</span></span>) @ GeneratedValue(strategy = GenerationType.AUTO) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; @ Column(name = <span class="hljs-string"><span class="hljs-string">"identification_name"</span></span>, length = <span class="hljs-number"><span class="hljs-number">64</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String identificationName; @ Enumerated(EnumType.STRING) @ Column(name = <span class="hljs-string"><span class="hljs-string">"type"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AuthorityType type; @ Column(name = <span class="hljs-string"><span class="hljs-string">"binary_authorities"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long binaryAuthorities; @ Column(name = <span class="hljs-string"><span class="hljs-string">"enabled"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, columnDefinition = <span class="hljs-string"><span class="hljs-string">"tinyint"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Boolean enabled; @ Transient <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Set&lt;Authority&gt; authorities; @ OneToOne(fetch = FetchType.LAZY, orphanRemoval = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) @ Cascade({CascadeType.ALL}) @ JoinColumn(name=<span class="hljs-string"><span class="hljs-string">"user_id"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> User user; @ Override <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() { authorities = EnumSet.noneOf(Authority.class); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Authority authority : Authority.values()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((binaryAuthorities &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; authority.ordinal())) != <span class="hljs-number"><span class="hljs-number">0</span></span>) authorities.add(authority); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> authorities; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAuthority</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Set&lt;Authority&gt; authorities)</span></span></span><span class="hljs-function"> </span></span>{ binaryAuthorities = <span class="hljs-number"><span class="hljs-number">0L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Authority authority : authorities) binaryAuthorities |= <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; authority.ordinal(); } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> type.name(); } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUsername</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> identificationName; } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAccountNonExpired</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAccountNonLocked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isCredentialsNonExpired</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//getters/setters }</span></span></code> </pre> <br><h6>  AuthorityType.java: </h6><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> AuthorityType implements Serializable { SIMPLE, FACEBOOK, TWITTER, GOOGLE, LINKEDIN; }</code> </pre> <br><h6>  Authority.java: </h6><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Authority implements GrantedAuthority { NEW_CUSTOMER, CUSTOMER, ADMINISTRATOR; @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAuthority</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> toString(); } }</code> </pre> <br><h6>  FacebookAuthUser.java: </h6><br><pre> <code class="java hljs">@ Entity @ Table(name = <span class="hljs-string"><span class="hljs-string">"facebook_auth_user"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FacebookAuthUser</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthUser</span></span></span><span class="hljs-class"> </span></span>{ @ Column(name = <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>, length = <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String firstName; @ Column(name = <span class="hljs-string"><span class="hljs-string">"last_name"</span></span>, length = <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String lastName; @ Column(name = <span class="hljs-string"><span class="hljs-string">"email"</span></span>, length = <span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String email; @ Column(name = <span class="hljs-string"><span class="hljs-string">"token"</span></span>, length = <span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String token; <span class="hljs-comment"><span class="hljs-comment">//any number of available properties //getters/setters }</span></span></code> </pre> <br><h6>  TwitterAuthUser.java: </h6><br><pre> <code class="java hljs">@ Entity @ Table(name = <span class="hljs-string"><span class="hljs-string">"twitter_auth_user"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TwitterAuthUser</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthUser</span></span></span><span class="hljs-class"> </span></span>{ @ Column(name = <span class="hljs-string"><span class="hljs-string">"screen_name"</span></span>, length = <span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String screenName; @ Column(name = <span class="hljs-string"><span class="hljs-string">"oauth_token"</span></span>, length = <span class="hljs-number"><span class="hljs-number">80</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String oauthToken; @ Column(name = <span class="hljs-string"><span class="hljs-string">"oauth_token_secret"</span></span>, length = <span class="hljs-number"><span class="hljs-number">80</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String oauthTokenSecret; <span class="hljs-comment"><span class="hljs-comment">//any number of available properties //getters/setters }</span></span></code> </pre> <br><h6>  SimpleAuthUser.java: </h6><br><pre> <code class="java hljs">@ Entity @ Table(name = <span class="hljs-string"><span class="hljs-string">"simple_auth_user"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleAuthUser</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthUser</span></span></span><span class="hljs-class"> </span></span>{ @ Column(name = <span class="hljs-string"><span class="hljs-string">"password"</span></span>, length = <span class="hljs-number"><span class="hljs-number">40</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String password; @ Column(name = <span class="hljs-string"><span class="hljs-string">"uuid"</span></span>, length = <span class="hljs-number"><span class="hljs-number">36</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String uuid; @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> password; } <span class="hljs-comment"><span class="hljs-comment">//getters/setters }</span></span></code> </pre> <br>  As you can see, the slightest ‚Äúchemistry‚Äù has not done: <br><ul><li>  There is no wish to make another structure (table) for storing user roles, and it‚Äôs foolish to deprive yourself of the opportunity to endow a user with several roles by changing the set of roles to one.  Therefore, in the database I store the binary representation of the role set, and Spring Security I feed the set.  The main thing is not to forget, when reading from the base, to make a transformation.  Ideologically, the translation mechanism is incorrectly kept in the POJO, we must leave it in the controller or the DAO, but we will consider this to be the cost of publication. </li><li>  The type field (enum AuthorityType) - it does not carry a special need, it is more likely to visualize the data in the database, plus it is easier to use <em>user.getType ()</em> in the view than to investigate belonging to one of the classes - <em>user instanseof TwitterAuthUser</em> , although this is completely unprincipled. </li><li>  The UserDetails interface requires the implementation of a number of methods.  In particular, identificationName (and <em>getUsername ()</em> ) is a field where identifiers are stored: for Facebook it is <em>FacebookID</em> , for Twitter it is <em>TwitterID</em> , for standard authorization it is a nickname or email.  The <em>getPassword ()</em> method in my case returns the same type, then it will be used by Spring Security to create a hash for cookies in the <em>RememberMe</em> mechanism.  In order to increase the project's sekyur in each of the classes, you can override this method by assigning it with really secular data, as I did in the <em>SimpleAuthUser</em> class.  For others, it can be tokens or secret tokens.  What to do next with the methods and potentially corresponding properties <em>isAccountNonExpired</em> , <em>isAccountNonLocked</em> , <em>isCredentialsNonExpired</em> - decide as necessary to use such data, in this review I do not use them, drowning out <em>return true</em> . <br></li></ul><br>  As can be seen in the diagram and in the code, I decided to use a <em>lazy</em> dependency between objects of different layers, even though they correlate as ‚Äúone-to-one‚Äù.  There are two goals: 1) AuthUser is often twitched by the framework in the controller and view, and there is little desire to drag the dependent structure everywhere, especially since it can be very extensive and massive (in my project, the Jobseeker tables only have EAGER dependencies of pieces 5- 6, not counting LAZY - these are telephones, and the address, and professions, and others), therefore, in my opinion, reinsurance will not hurt.  2) we must not forget that these layers belong to different layers of logic: AuthUser is twitching with the Spring Security framework, and at the same time changes can occur in DataUser, but I don‚Äôt want to be engaged in constant monitoring and updating.  I agree that this decision is controversial, and does not pretend to be final.  Perhaps, it is necessary to connect vice versa, thus the listed problems disappear, and it will always be possible to pull an authorization bin from business logic.  This remains at the discretion of the developers. <br><br>  As for the DataUser class and the dependent ones, these are simple POJO classes, the DataUser itself contains properties common to all (say, id, firstName, lastName, email, location), and the rest are expanded by adding specific properties (listing impractical). . <br><br><h4>  2. The controller. </h4><br>  In principle, in the terminology of <em>authentication</em> and <em>authorization</em> there is not much difference - authorization is authorization, and, different network providers are inclined to these terms in their own way.  However, in my report I clearly distinguish 2 concepts - registration and directly authorization or input (both are based on authorization from a social network provider).  Say, when participating in a forum, or submitting a comment, you just need to log in - be it in the first entry, or in the 100th.  I am pursuing the separation of registration and simple authorization by the need to create a user model when submitting an application for registration.  And although it could be implemented more simply - at the entrance we check if there is such a person or not - and create a user structure in the case of the first entrance.  But a) there is a standard registration and it is logical to make a visual separation ‚Äúthere is one, and here there is another‚Äù (the notorious <em>usability</em> );  b) no matter how annoying, but the social networking APIs are not unanimous in providing information about their customers - say, the <em>Facebook API</em> provides email, first name, last name, gender, location;  <em>Twitter API</em> - gives a screen_name, which may not be the "first name", does not give email (their position clearly distinguishes between real and virtual);  <em>The Google+ API</em> provides a first name, last name, email, but nothing about the location;  <em>LinkedIn API</em> - name, surname, gender, location, but does not give email.  Since my project is very closely tied to the personal data of the visitor (a project for a recruitment company), along with the registration I point out the need to fill in some fields (initially, except for Facebook users, everyone had to specify at least something, now it‚Äôs simplified and only Twitter users, although I do not exclude a complete refusal, and filling in the fields when there is a need - for example, when trying to get into the "zone", where such information will already be simply necessary).  Therefore, my implementation is somewhat bloated, although it only helps to understand the authorization mechanism more. <br><br>  I want to remind you that for work (or testing) you need to create your own application in each of the social networks, and use its settings for work.  For Facebook, it's <a href="https://developers.facebook.com/apps">developers.facebook.com/apps</a> , for Twitter ‚Äî <a href="https://dev.twitter.com/apps">dev.twitter.com/apps</a> , for Google+ ‚Äî <a href="https://code.google.com/apis/console">code.google.com/apis/console</a> , for LinkedIn ‚Äî <a href="https://www.linkedin.com/secure/developer">www.linkedin.com/secure/developer</a> .  When creating an application, there are 3 important parameters that each provider has - a key (or API key, Consumer key, Client ID), a secret key (App Secret, Consumer secret, Client secret, Secret key) and a redirect address (they say, until recently time, some of the providers did not work redirect to localhost, but today it‚Äôs checked - everyone works with an address like <a href="http://localhost/">http: // localhost: 8080 / myproject</a> ).  There you can also configure other settings, including the application logo, however, LinkedIn requires that the link to the picture be SSL (an incomprehensible wish). <br><br>  Facebook and Google+ have long been using the new <em>OAuth 2</em> protocol, Twitter and LinkedIn still remain on the older <em>OAuth</em> protocol (Google+ also supported the first version of OAuth until April 20, 2012).  At my discretion (although I can‚Äôt imagine a different opinion), working with OAuth 2 is immeasurably easier and more convenient, though, despite the fact that it is quite popular, it is still not approved as a standard.  The principle of operation is quite primitive (the most popular scheme): <br><img src="http://img535.imageshack.us/img535/2254/pic2k.png" alt="image"><br>  So, a user on a web page clicks on one of the registration buttons: <br><img src="http://img41.imageshack.us/img41/321/pic3yd.png" alt="image"><br>  (moreover, I don‚Äôt leave any ‚Äúextra‚Äù functionality on the page, only a button with an address like <a href="http://www.myproject.com/registration/facebook">www.myproject.com/registration/facebook</a> , etc.), the request goes to the controller (for Facebook): <br><pre> <code class="java hljs">@ RequestMapping(value = <span class="hljs-string"><span class="hljs-string">"/registrate/facebook"</span></span>, method = RequestMethod.POST) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelAndView </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">facebookRegistration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModelAndView(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RedirectView(FACEBOOK_URL + <span class="hljs-string"><span class="hljs-string">"?client_id="</span></span> + FACEBOOK_API_KEY + + <span class="hljs-string"><span class="hljs-string">"&amp;redirect_uri="</span></span> + FACEBOOK_URL_CALLBACK_REGISTRATION + + <span class="hljs-string"><span class="hljs-string">"&amp;scope=email,user_location&amp;state=registration"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); }</code> </pre> <br>  The parameters for the scope can be found at <a href="http://developers.facebook.com/docs/authentication/permissions">developers.facebook.com/docs/authentication/permissions</a> (for Twitter - <a href="https://dev.twitter.com/docs/platform-objects/users">dev.twitter.com/docs/platform-objects/users</a> , Google+ - <a href="https://developers.google.com/accounts/docs/OAuth2Login">developers.google.com/accounts/docs/OAuth2Login# userinfocall</a> , LinkedIn - <a href="https://developer.linkedin.com/documents/profile-fields">developer.linkedin.com/documents/profile-fields</a> ), I just brought a couple here.  Domain redirect_uri must match the registered address of the application.  state is a ‚Äúfree‚Äù parameter, I use it as a semaphore for further actions - registration, signin, autosignin. <br><br>  Then the user will ‚Äúredirect‚Äù to the Facebook authorization home page, where he will allow the application to use his data, and, if the permissions are beyond the base ones, they will be listed in the authorization window. <br><br>  After authorization, our controller with mapping <em>FACEBOOK_IRL_CALLBACK_REGISTRATION</em> receives a call (for any decision of the client - authorize, cancel, return).  Spring MVC allows us to immediately filter requests by mepping (in this case, the mapping of my project is shown): <br><pre> <code class="java hljs">@ RequestMapping(value = <span class="hljs-string"><span class="hljs-string">"/callback/facebook"</span></span>, method = RequestMethod.GET) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FacebookController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExternalController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constants</span></span></span><span class="hljs-class"> </span></span>{ @ RequestMapping(value = <span class="hljs-string"><span class="hljs-string">"/registration"</span></span>, params = <span class="hljs-string"><span class="hljs-string">"code"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelAndView </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registrationAccessCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@ RequestParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"code"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String code, HttpServletRequest request) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String authRequest = Utils.sendHttpRequest(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, FACEBOOK_URL_ACCESS_TOKEN, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{<span class="hljs-string"><span class="hljs-string">"client_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"redirect_uri"</span></span>, <span class="hljs-string"><span class="hljs-string">"client_secret"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{FACEBOOK_API_KEY, FACEBOOK_URL_CALLBACK_REGISTRATION, FACEBOOK_API_SECRET, code}); String token = Utils.parseURLQuery(authRequest).get(<span class="hljs-string"><span class="hljs-string">"access_token"</span></span>); String tokenRequest = Utils.sendHttpRequest(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, FACEBOOK_URL_ME, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{<span class="hljs-string"><span class="hljs-string">"access_token"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{token}) Map&lt;String, Json&gt; userInfoResponse = Json.read(tokenRequest).asJsonMap(); String email = userInfoResponse.get(<span class="hljs-string"><span class="hljs-string">"email"</span></span>).asString().toLowerCase(); String id = userInfoResponse.get(<span class="hljs-string"><span class="hljs-string">"id"</span></span>).asString(); <span class="hljs-comment"><span class="hljs-comment">//verifying ... is new? is email in DB? //creating objects Customer customer = new Customer(); customer.setEmail(email); //... customerer = (Customerer) userDAO.put(customer); FacebookAuthUser user = new FacebookAuthUser(); user.setFirstName(firstName); //... user.setIdentificationName(id); user.setToken(token); user.setType(AuthenticationType.FACEBOOK); user.setEnabled(true); user.setAuthority(EnumSet.of(Authority.CUSTOMER)); user.setUser(customer); authenticationDAO.put(user); return new ModelAndView(new RedirectView("/registrate.complete", true, true, false)); } @ RequestMapping(value = "/registration", params = "error_reason") public ModelAndView registrationError(@ RequestParam("error_description") String errorDescription, HttpServletRequest request, HttpServletResponse response) { //return client to registration page with errorDescription return new ModelAndView(new RedirectView("/registrate", true, true, false)); } //will signin and signinError }</span></span></code> </pre> <br>  For convenience and unitary use of a pair of static methods of the Utils class used in this listing: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendHttpRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String methodName, String url, String[] names, String[] values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> HttpException, IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.length != values.length) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!methodName.equalsIgnoreCase(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>) &amp;&amp; !methodName.equalsIgnoreCase(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; HttpMethod method; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodName.equalsIgnoreCase(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>)) { String[] parameters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[names.length]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; names.length; i++) parameters[i] = names[i] + <span class="hljs-string"><span class="hljs-string">"="</span></span> + values[i]; method = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GetMethod(url + <span class="hljs-string"><span class="hljs-string">"?"</span></span> + StringUtils.join(parameters, <span class="hljs-string"><span class="hljs-string">"&amp;"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { method = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PostMethod(url); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; names.length; i++) ((PostMethod) method).addParameter(names[i], values[i]); method.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient().executeMethod(method); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getStringFromStream(method.getResponseBodyAsStream()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Map&lt;String, String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseURLQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String query)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, String&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;String,String&gt;(); String params[] = query.split(<span class="hljs-string"><span class="hljs-string">"&amp;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String param : params) { String temp[] = param.split(<span class="hljs-string"><span class="hljs-string">"="</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { result.put(temp[<span class="hljs-number"><span class="hljs-number">0</span></span>], URLDecoder.decode(temp[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (UnsupportedEncodingException exception) { exception.printStackTrace(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  Constants: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String FACEBOOK_API_KEY = <span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXX"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String FACEBOOK_API_SECRET = <span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String FACEBOOK_URL = <span class="hljs-string"><span class="hljs-string">"https://www.facebook.com/dialog/oauth"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String FACEBOOK_URL_ACCESS_TOKEN = <span class="hljs-string"><span class="hljs-string">"https://graph.facebook.com/oauth/access_token"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String FACEBOOK_URL_ME = <span class="hljs-string"><span class="hljs-string">"https://graph.facebook.com/me"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String FACEBOOK_URL_CALLBACK_REGISTRATION = SITE_ADDRESS + <span class="hljs-string"><span class="hljs-string">"/callback/facebook/registration"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String FACEBOOK_URL_CALLBACK_SIGNIN = SITE_ADDRESS + <span class="hljs-string"><span class="hljs-string">"/callback/facebook/signin"</span></span>;</code> </pre> <br>  <em>JSON</em> libraries can be used by everyone at their discretion, I used the mjson library ( <a href="http://sharegov.blogspot.com/2011/06/json-library.html">http://sharegov.blogspot.com/2011/06/json-library.html</a> ) - small, convenient and without serialization. <br><br>  As you can see, the process is simple and should not cause any special questions.  I also want to note that Facebook provides the location parameter, values ‚Äã‚Äãfrom which you can ‚Äúslip‚Äù the <em>Google Maps API</em> (at <a href="http://maps.googleapis.com/maps/api/geocode/json">http://maps.googleapis.com/maps/api/geocode/json</a> ) and pull out geolocation in a convenient form (by standards Google Maps).  Clearly, it can only be a case if the client in his Facebook account has indicated not only the country of the location. <br><br>  Signing up on Google+ is similar, with the only difference being that the <em>callback URL</em> in their system must exactly match the one specified in the application settings.  Thus, all redirects will only get on one mapping.  To separate processes, it is convenient to use the returned <em>state</em> parameter: <br><pre> <code class="java hljs">@ RequestMapping(value = <span class="hljs-string"><span class="hljs-string">"/callback/google"</span></span>, method = RequestMethod.GET) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GoogleController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExternalController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constants</span></span></span><span class="hljs-class"> </span></span>{ @ RequestMapping(value = {<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>}, params = <span class="hljs-string"><span class="hljs-string">"code"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelAndView </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">googleProxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@ RequestParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"code"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String code, @ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestParam</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"state"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String state, HttpServletRequest request, HttpServletResponse response) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ... } @ RequestMapping(value = {<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>}, params = <span class="hljs-string"><span class="hljs-string">"error"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelAndView </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">googleErrorProxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"error"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String error, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestParam</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"state"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String state, HttpServletRequest request) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ... } }</code> </pre> <br>  The remaining actions, with the exception of addresses and return parameters, are identical. <br><br>  The situation is different with <em>OAuth</em> authorization (Twitter and LinkedIn).  I went through the whole authorization chain, but this is very inconvenient due to the formation of a request with tokens - they need to be specially ‚Äúglued‚Äù together to package base64, add parameters with time and other manipulations.  And what is most surprising is that the sections for developers of these social networks do not reflect these processes.  Although this is a standard, so the calculation goes to the standard approach.  In any case, authorization in this way, implemented "manually", is of no interest for developing your application.  I advise you to use third-party free libraries that facilitate this task.  For example, there is a library specifically for Twitter - <em>twitter4j.jar</em> .  I used the <em>scribe-java</em> library ( <a href="http://github.com/fernandezpablo85/scribe-java">http://github.com/fernandezpablo85/scribe-java</a> ), which is distributed under the <em>MIT license</em> .  The package has work with <em>Digg API</em> , <em>Facebook API</em> , <em>Flickr API</em> , <em>Freelancer API</em> , <em>Google API</em> , <em>LinkedIn API</em> , <em>Skyrock API</em> , <em>Tumblr API</em> , <em>Twitter API</em> , <em>Vkontakte API</em> , <em>Yahoo API</em> and a dozen more 2 others. <br><br>  The registration process for Twitter using the <em>scribe</em> library will look like this.  Client request authorization controller from the registration page: <br><pre> <code class="java hljs">@ RequestMapping(value = <span class="hljs-string"><span class="hljs-string">"/registrate/twitter"</span></span>, params = <span class="hljs-string"><span class="hljs-string">"action"</span></span>, method = RequestMethod.POST) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelAndView </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">twitterRegistrationJobseeker</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpServletRequest request)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ OAuthService service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceBuilder().provider(TwitterApi.class) .apiKey(TWITTER_CONSUMER_KEY).apiSecret(TWITTER_CONSUMER_SECRET) .callback(TWITTER_URL_CALLBACK_REGISTRATION).build(); Token requestToken = service.getRequestToken(); request.getSession().setAttribute(<span class="hljs-string"><span class="hljs-string">"twitter"</span></span>, service); request.getSession().setAttribute(<span class="hljs-string"><span class="hljs-string">"request_token"</span></span>, requestToken); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModelAndView(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RedirectView(service.getAuthorizationUrl(requestToken), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); }</code> </pre> <br>  Twitter callback controller: <br><pre> <code class="java hljs">@ RequestMapping(value = <span class="hljs-string"><span class="hljs-string">"/callback/twitter"</span></span>, method = RequestMethod.GET) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TwitterController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExternalController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constants</span></span></span><span class="hljs-class"> </span></span>{ @ RequestMapping(value = <span class="hljs-string"><span class="hljs-string">"/registration"</span></span>, params = <span class="hljs-string"><span class="hljs-string">"oauth_verifier"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelAndView </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registrationAccessCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@ RequestParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"oauth_verifier"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String verifier, HttpServletRequest request, HttpServletResponse response) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ OAuthService service = (OAuthService) request.getSession().getAttribute(<span class="hljs-string"><span class="hljs-string">"twitter"</span></span>); Token accessToken = service.getAccessToken((Token) request.getSession().getAttribute(<span class="hljs-string"><span class="hljs-string">"request_token"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Verifier(verifier)); OAuthRequest oauthRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OAuthRequest(Verb.GET, TWITTER_URL_CREDENTIALS); service.signRequest(accessToken, oauthRequest); Map&lt;String, Json&gt; userInfoResponse = Json.read(oauthRequest.send().getBody()).asJsonMap(); String twitterId = userInfoResponse.get(<span class="hljs-string"><span class="hljs-string">"id"</span></span>).asString(); <span class="hljs-comment"><span class="hljs-comment">//verifying ... Customer customer = new Customer(); customer.setFirstName((String) request.getSession().getAttribute("pageValueFirstName")); //... customer = (Customer) userDAO.put(customer); TwitterAuthUser user = new TwitterAuthUser(); user.setAuthority(EnumSet.of(Authority.CUSTOMER)); user.setIdentificationName(twitterId); //... user.setOauthToken(accessToken.getToken()); user.setOauthTokenSecret(accessToken.getSecret()); user.setType(AuthenticationType.TWITTER); user.setUser(customer); authenticationDAO.put(user); return new ModelAndView(new RedirectView("/registrate.complete", true, true, false)); } @ RequestMapping(value = "/registration", params = "denied") public ModelAndView registrationError(HttpServletRequest request) { //response does not contain the error text return new ModelAndView(new RedirectView("/registrate", true, true, false)); } //will signin and signinError }</span></span></code> </pre> <br>  Again, everything is very simple and affordable.  Registration through the LinkedIn API is done in exactly the same way. <br><br>  The last is registration in the standard way.  Standard - that‚Äôs standard, I‚Äôm not going to give the code, I‚Äôll only clarify that as a result we create a SimpleAuthUser object inherited from AuthUser: <br><pre> <code class="java hljs"> SimpleAuthUser user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleAuthUser(); user.setAuthority(EnumSet.of(Authority.NEW_CUSTOMER)); user.setEnabled(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); user.setIdentificationName(email); user.setPassword(passwordEncoder.encodePassword(password, email)); user.setType(AuthenticationType.SIMPLE); user.setUser(customer); user.setUuid(uuid); authenticationDAO.put(user);</code> </pre> <br>  It is for this case that authority <em>NEW_CUSTOMER was needed</em> - a registered user needs confirmation of registration (standard practice), and therefore a) has a different role;  b) Spring Security is not allowed to authorize (enabled = false). <br><br><h4>  Authorization on the site </h4><br>  Simple springovsky <em>application-context-security.xml</em> : <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security:global-method-security</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">secured-annotations</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"enabled"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">jsr250-annotations</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"enabled"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pre-post-annotations</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"enabled"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">proxy-target-class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security:http</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">auto-config</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">use-expressions</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security:intercept-url</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/**"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">access</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"permitAll"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security:form-login</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/signin"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security:logout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invalidate-session</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">logout-success-url</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">logout-url</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/signout"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security:remember-me</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">services-ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rememberMeService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"someRememberMeKey"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security:http</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security:authentication-manager</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alias</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"authenticationManager"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security:authentication-provider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"authenticationProvider"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security:authentication-manager</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"authenticationProvider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myproject.security.CustomAuthenticationProvider"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rememberMeService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myproject.security.RememberMeService"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"key"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"someRememberMeKey"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userDetailsService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userDetailsService"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userDetailsService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myproject.security.CustomUserDetailsManager"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"passwordEncoder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.security.authentication.encoding.ShaPasswordEncoder"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br><h6>  CustomUserDetailsManager.java: </h6><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomUserDetailsManager</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDetailsService</span></span></span><span class="hljs-class"> </span></span>{ @ Resource <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AuthenticationDAO authenticationDAO; @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> UserDetails </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadUserByUsername</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String username)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> UsernameNotFoundException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> authenticationDAO.findAuthUser(username); } }</code> </pre> <br><h6>  CustomUserAuthentication.java: </h6><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomUserAuthentication</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Authentication</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Object details; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserDetails user; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> authenticated; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Collection&lt;? extends GrantedAuthority&gt; authorities; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomUserAuthentication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserDetails user, Object details)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = user.getUsername(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.details = details; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.user = user; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.authorities = user.getAuthorities(); authenticated = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name; } @ Override <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> authorities; } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCredentials</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user.getPassword(); } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDetails</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> details; } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPrincipal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user; } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAuthenticated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> authenticated; } @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAuthenticated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> authenticated)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IllegalArgumentException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.authenticated = authenticated; } }</code> </pre> <br><h6>  CustomAuthenticationProvider.java </h6>  (the class is completely stupid, but Spring Security needs to feed the heir of the <em>AuthenticationProvider</em> interface, but the closest one within the meaning of <em>PreAuthenticatedAuthenticationProvider is</em> not suitable): <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomAuthenticationProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthenticationProvider</span></span></span><span class="hljs-class"> </span></span>{ @ <span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Authentication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authenticate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication authentication)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AuthenticationException </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   .  return authentication; } @ Override public boolean supports(Class&lt;?&gt; authentication) { return PreAuthenticatedAuthenticationToken.class.isAssignableFrom(authentication); } public Authentication trust(UserDetails user) { Authentication authentication = SecurityContextHolder.getContext().getAuthentication(); Authentication trustedAuthentication = new CustomUserAuthentication(user, authentication.getDetails()); authentication = authenticate(trustedAuthentication); SecurityContextHolder.getContext().setAuthentication(authentication); return authentication; } }</span></span></code> </pre> <br>  And, perhaps, the ‚Äúbottleneck‚Äù of the organization of security is the implementation of the <em>Remember</em> Me mechanism.  In principle, everything is already organized in such a way that the work of the <em>RememberMe</em> service fully complies with the implementation of <em>TokenBasedRememberMeServices</em> , with one clarification: all the data for automatic client authorization are in our database, however there may be a situation when a user has registered on the site and then deleted the account on used social network.    ‚Äì   ,    ,         .      RememberMe      .  API      ,    ¬´¬ª    RememberMe,      .  ,  -    ( <em>AbstractRememberMeServices</em>      <em>final</em> ),     .    ,    ,           .     <em>AbstractRememberMeServices</em>     <em>TokenBasedRememberMeServices</em> ,      <em>public Authentication autoLogin(HttpServletRequest request, HttpServletResponse response)</em> ‚Äì     ,         ¬´¬ª : <br><pre> <code class="java hljs">Class&lt;? extends ExternalController&gt; controller = externalControllers.get(user.getPassword()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (controller != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !controller.newInstance().checkAccount(user)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;</code> </pre> <br>  ,     : <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Class&lt;? extends ExternalController&gt;&gt; externalControllers; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomRememberMeService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ externalControllers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;String, Class&lt;? extends ExternalController&gt;&gt;(){{ put(AuthenticationType.FACEBOOK.name(), FacebookController.class); put(AuthenticationType.TWITTER.name(), TwitterController.class); put(AuthenticationType.GOOGLE.name(), GoogleController.class); put(AuthenticationType.LINKEDIN.name(), LinkedinController.class); }}; }</code> </pre> <br> (        RememberMe   ). <br><br>        <a href="http://static.springsource.org/spring-security/site/docs/3.1.x/reference/ns-config.html">REMEMBER_ME_FILTER</a>  ,          autoLogin,    .          , ,    .     ‚Äì   ,  ,   ,   ¬´¬ª. <br><br>       <em>ExternalController</em>   <em>checkAccount(user)</em> .   callback-   <em>ExternalController</em> : <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExternalController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkAccount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserDetails user)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception</span></span>; }</code> </pre> <br>       .  ,  Facebook : <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> heckAccount(UserDetails user) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> Exception { FacebookAuthUser facebookUser = (FacebookAuthUser) user; String authRequest = Utils.sendHttpRequest(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, FACEBOOK_URL_ME, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{<span class="hljs-string"><span class="hljs-string">"access_token"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{facebookUser.getToken()}); Map&lt;String, Json&gt; tokenInfoResponse = Json.read(authRequest).asJsonMap(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tokenInfoResponse.get(<span class="hljs-string"><span class="hljs-string">"error"</span></span>) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; tokenInfoResponse.get(<span class="hljs-string"><span class="hljs-string">"id"</span></span>).asString().equalsIgnoreCase(facebookUser.getIdentificationName()); }</code> </pre> <br>   Twitter: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkAccount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserDetails user)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ TwitterAuthUser twitterUser = (TwitterAuthUser) user; OAuthService service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceBuilder().provider(TwitterApi.class).apiKey(TWITTER_CONSUMER_KEY).apiSecret(TWITTER_CONSUMER_SECRET).build(); OAuthRequest oauthRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OAuthRequest(Verb.GET, TWITTER_URL_CREDENTIALS); service.signRequest(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Token(twitterUser.getOauthToken(), twitterUser.getOauthTokenSecret()), oauthRequest); String response = oauthRequest.send().getBody(); Map&lt;String, Json&gt; info = Json.read(request).asJsonMap(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.get(<span class="hljs-string"><span class="hljs-string">"id"</span></span>).asString().equalsIgnoreCase(twitterUser.getIdentificationName()); }</code> </pre> <br>  etc. <br><br>      (login, sign in)   .    ,  ¬´¬ª       : <br><img src="http://img43.imageshack.us/img43/5977/pic4x.png" alt="image"><br><br> ,      ‚Äì ¬´signin¬ª  ¬´autosignin¬ª,    ,    ¬´ ¬ª.        ,   , <em>callback URL</em>    <em>scope</em>  <em>permission</em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- we need to get only the client ID and its tokens. After appropriate checks in the controller's methods, I advise you to overwrite the tokens in the database. And although, for example, Facebook during my tests did not change the client token, and Google+ does it every time. I don‚Äôt know how often a ‚Äúchange‚Äù happens, so I rewrite after each </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">access_token</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> receipt </font><font style="vertical-align: inherit;">(in fact, with each non-automatic authorization from the provider). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And the most important point is the immediate authorization of the user in Spring Security (after checking, of course, for compliance and obtaining rights from the provider API), using the example of the Facebook controller:</font></font><br><pre> <code class="java hljs">@ RequestMapping(value = <span class="hljs-string"><span class="hljs-string">"/signin"</span></span>, params = <span class="hljs-string"><span class="hljs-string">"code"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelAndView </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">signInAccessCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@ RequestParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"code"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String code, @ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestParam</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"state"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String state, HttpServletRequest request, HttpServletResponse response) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String accessRequest = Utils.sendHttpRequest(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, FACEBOOK_URL_ACCESS_TOKEN, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{<span class="hljs-string"><span class="hljs-string">"client_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"redirect_uri"</span></span>, <span class="hljs-string"><span class="hljs-string">"client_secret"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{FACEBOOK_API_KEY, FACEBOOK_URL_CALLBACK_SIGNIN, FACEBOOK_API_SECRET, code}); String token = Utils.parseURLQuery(accessRequest).get(<span class="hljs-string"><span class="hljs-string">"access_token"</span></span>); Map&lt;String, Json&gt; userInfoResponse = Json.read(Utils.sendHttpRequest(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, FACEBOOK_URL_ME, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{<span class="hljs-string"><span class="hljs-string">"access_token"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{token})).asJsonMap(); FacebookAuthUser user = (FacebookAuthUser) authenticationDAO.findAuthUser(userInfoResponse.get(<span class="hljs-string"><span class="hljs-string">"id"</span></span>).asString(), AuthenticationType.FACEBOOK); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//-    ... return new ModelAndView(new RedirectView("/signin", true, true, false)); } else { if (!token.equals(user.getToken())) { user.setToken(token); user = (FacebookAuthUser) authenticationDAO.put(user); } Authentication authentication = customAuthenticationProvider.trust(user); if (state.equalsIgnoreCase("autosignin")) customRememberMeService.onLoginSuccess(request, response, authentication); else customRememberMeService.logout(request, response, authentication); //  RememberMe return new ModelAndView(new RedirectView("/signin.complete", true, true, false)); } }</span></span></code> </pre> <br>         . ,   ,   <em>logout</em>   <em>RememberMe</em>   (    ). ,    "/logout"      .       Spring Security . <br><br>     ¬´¬ª    :    (   ,     ..)   : <br><pre> <code class="java hljs">Authentication authentication = customAuthenticationProvider.trust(user); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (autosignin) customRememberMeService.onLoginSuccess(request, response, authentication); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> customRememberMeService.logout(request, response, authentication);</code> </pre> <br>     . ,  , ‚Äì  ,     RememberMe     , ,      TokenBasedRememberMeServices. <br><br>        Spring Security,    ,     <em>@Secured(¬´CUSTOM_ROLE¬ª)</em> ,      (     ,     ).   Spring Security    ‚Äì     <em>@PreAuthorize</em> , <em>@PostFilter</em> : <em>@PreAuthorize(¬´hasRole('ADMINISTRATOR')¬ª), @PreAuthorize(¬´hasRole({'CUSTOMER', 'ADMINISTRATOR'})¬ª)</em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. You only need to specify this in the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">security: global-method-security</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter in the Spring Security config </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Similarly, you can take advantage of the benefits and capabilities of Spring Security in a view (in </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSP</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font> For example: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%@</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">taglib</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">prefix</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"core"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uri</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://java.sun.com/jsp/jstl/core"</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%@</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">taglib</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">prefix</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sec"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uri</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/security/tags"</span></span></span><span class="hljs-tag"> %&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sec:authorize</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">access</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"isAuthenticated()"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userBox"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span>Welcome, <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sec:authentication</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">property</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"principal.user.firstName"</span></span></span><span class="hljs-tag">/&gt;</span></span>!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sec:authorize</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>          ,        (      ). <br><br>    <em>jsp-</em>  jsp- (      ,   -  ¬´ ‚Äì ,  ‚Äî ¬ª,   ,   /  ‚Äì ;    ,       ,    ‚Äì , , ,   ): <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%@</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">page</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">import</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.security.core.context.SecurityContextHolder"</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%@</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">page</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">import</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myproject.auth.AuthUser"</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Object</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">principal</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AuthUser</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">authUser</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">null;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> (!(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">principal</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">instanceof</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">String</span></span></span><span class="hljs-tag">)) </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">authUser</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">(AuthUser)</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">principal</span></span></span><span class="hljs-tag">; %&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> &lt;%= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">authUser</span></span></span><span class="hljs-tag"> == </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">null</span></span></span><span class="hljs-tag"> ? "" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">\</span></span></span><span class="hljs-tag">"</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">disabled</span></span></span><span class="hljs-tag">\"" %&gt;</span></span> name="your_name" value="<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">authUser</span></span></span><span class="hljs-tag"> == </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">null</span></span></span><span class="hljs-tag"> ? "" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">authUser.getUser</span></span></span><span class="hljs-tag">()</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.getFirstName</span></span></span><span class="hljs-tag">()%&gt;</span></span>"/&gt; ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">authUser</span></span></span><span class="hljs-tag"> == </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">null)</span></span></span><span class="hljs-tag"> { %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"recaptcha_widget"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"recaptchaContainer"</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } %&gt;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The given page code only reflects the possibility of using the context of security, but does not pretend to any meaningfulness of the page logic. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I want to focus on the ‚Äúbottleneck‚Äù caused by a lazy dependency between the authentication object and its parameters (the principal object): without any modifications, both pages of the page code will cause a Runtime Exception when opened, since the user field (the getUser () method call) will contain default object with all fields filled in as null. Using the </font><em><font style="vertical-align: inherit;">OpenSessionInView</font></em><font style="vertical-align: inherit;"> pattern</font></font><em><font style="vertical-align: inherit;"></font></em>          ,    HTTP  .         ,     , -       ‚Äì            ,      EAGER-.     authenticationDAO    <em>sessionFactory.getCurrentSession()</em>    : <em>SessionFactoryUtils.openSession(sessionFactory)</em> . ,        ,             . ,       ,       <em>OpenSessionInView</em> ,    . <br><br>     ,       ,       ,        . </div><p>Source: <a href="https://habr.com/ru/post/145695/">https://habr.com/ru/post/145695/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145688/index.html">Startup: what not to do or learn from the mistakes of others</a></li>
<li><a href="../145689/index.html">Dirty stress test nginx vs apache</a></li>
<li><a href="../145690/index.html">Twitter introduces trend personalization</a></li>
<li><a href="../145693/index.html">T (ether) allows you to edit virtual objects in the real world</a></li>
<li><a href="../145694/index.html">A simple implementation of the now playing section for Icecast2 using JSON</a></li>
<li><a href="../145697/index.html">The second practical task from unity3dstudent.com</a></li>
<li><a href="../145699/index.html">Proposed a new HTTP status code for censorship.</a></li>
<li><a href="../145700/index.html">OVH opened a large data center in America</a></li>
<li><a href="../145701/index.html">How to record screencasts</a></li>
<li><a href="../145702/index.html">New office Zynga</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>