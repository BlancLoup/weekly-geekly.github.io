<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience of transferring a virtual machine from someone else‚Äôs XEN hosting to your KVM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I was assigned the task of transferring a site from external hosting to a client server. The peculiarity was that the virtual server was well configur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience of transferring a virtual machine from someone else‚Äôs XEN hosting to your KVM</h1><div class="post__text post__text-html js-mediator-article">  I was assigned the task of transferring a site from external hosting to a client server.  The peculiarity was that the virtual server was well configured, and really did not want to reinstall and configure the operating system, database and all environment packages. <br><br>  The site was spinning in the cloud of a famous provider on a virtual machine with the XEN hypervisor.  I was hoping that the support would meet and give the image of a virtual machine, but the miracle did not happen: the refusal was cold and courteous, probably, as usual.  As a result, an approximate transfer scheme was born: make a disk image, transfer it to your server, create a virtual machine, specify the resulting image as the source. <br><br>  Experienced experts already guess what I had to face in the process of executing the plan.  For the rest I cite details and ways to solve the arisen difficulties <br><a name="habracut"></a><br><h4>  1. Connecting to your server </h4><br>  Since making a disk image on this disk itself is rather troublesome, it was necessary to connect a file system that is different from the one used.  The first thing that came to mind was to mount the home folder of your server in the file system on the virtual machine using sshfs.  I bring the commands for the Debian distribution: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> # apt-get install sshfs
 # mkdir / mnt / vasya
 # sshfs vasya@pupkin.ru: / home / vasya / mnt / vasya
 Password: Cheburashka 2014
</pre><br><br><h4>  2. Translation of FS in read-only </h4><br>  In order for the file system not to lose its integrity, it was necessary to transfer it to write protection mode (read-only).  To do this, Linux provides the ability to remount the FS: <code>mount -o ro,remount /</code> .  The command naturally did not work, the kernel blocked the execution of the command with a <code>mount: / is busy</code> error <code>mount: / is busy</code> .  After some googling, there was a reason: many files were opened by demons.  On the server, I had to stop ntp, apache2, mysql, rsyslogd (maybe I missed something, but you can see the list of running processes using the htop or top command). <br><br><pre> # invoke-rc.d ntp stop
 # invoke-rc.d apache2 stop
 # invoke-rc.d mysql stop
 # invoke-rc.d rsyslogd stop
 # mount -o ro, remount /
 # touch / test
 touch: cant touch `/ test ': Read-only file system
</pre><br><br><h4>  3. Image creation and transfer </h4><br>  To create an image, I used the dd program.  I also used the data pipeline and sent them through the gzip compression program to a file located in a folder that is mounted on a remote server. <br><br><pre> # dd if = / dev / xvda bs = 64K |  gzip -c&gt; /mnt/vasya/xvda.raw.gz
</pre><br><br>  After an hour and a half I had the file /home/vasya/xvda.raw.gz on my server with the image I needed.  The compression ratio turned out to be quite good: 8.5 / 12. <br><br><h4>  4. Connecting the image to the new virtual machine </h4><br>  On local hardware I use Proxmox VE 3.1.  I created a virtual machine with the following configuration: <br><br><pre> balloon: 256
 bootdisk: virtio0
 cores: 2
 ide2: nfs-da: iso / debian-7.2.0-amd64-netinst.iso, media = cdrom, size = 222M
 memory: 768
 name: pupkin
 net0: virtio = 26: 95: 81: 17: D9: 14, bridge = vmbr0
 ostype: l26
 sockets: 1
 virtio0: nfs-da: 143 / vm-143-disk-1.raw, format = raw
</pre><br><br>  I, of course, unzipped the image file of the virtual machine and put it in the right place with the necessary access rights (/ mnt / nfs is a section configured as a Proxmox VE storage, 143 is the identifier of the new virtual machine): <br><br><pre> # zcat /home/vasya/xvda.raw.gz&gt; /mnt/nfs/images/143/vm-143-disk-1.raw
 # chown nobody: nogroup /mnt/nfs/images/143/vm-143-disk-1.raw
</pre><br><br>  Due to my inexperience, I was looking forward to the victory, but this was not the case: the Grub bootloader dropped out into its console.  Moreover, attempts to boot manually were doomed to failure: the resulting image lacked the initrd environment initializer, and the kernel was highly specialized and did not contain drivers for virtio devices (network and hard disk).  Experienced specialists can add me and explain how Linux booting is configured in XEN, I didn‚Äôt have a case before, I already had a new plan: I need to put a linux kernel, its drivers and an initrd from a running virtual machine with a similar operating system. <br><br><h4>  5. Bootloader fix </h4><br>  I had a working virtual machine, to which I added a new disk, and then deleted its image from the file system and replaced it with a symlink for a broken image.  Previously, I, of course, turned off the virtual 143, so that the image does not accidentally open 2 processes simultaneously. <br><br><pre> # rm /mnt/nfs/images/200/vm-200-disk-2.raw
 # ln -s /mnt/nfs/images/143/vm-143-disk-1.raw /mnt/nfs/images/200/vm-200-disk-2.raw
</pre><br><br>  I downloaded the virtual 200, mounted the FS of the broken image and copied the linux kernel, the working bootloader and the device drivers there. <br><br><pre> # mkdir / mnt / vdb1
 # mount / dev / vdb1 / mnt / vdb1
 # cp /boot/vmlinuz-3.2.0-4-amd64 /mnt/vdb1/boot/vmlinuz-3.2.0-4-amd64 
 # cp /boot/initrd.img-3.2.0-4-amd64 /mnt/vdb1/boot/initrd.img-3.2.0-4-amd64
 # cp /boot/System.map-3.2.0-4-amd64 /mnt/vdb1/boot/System.map-3.2.0-4-amd64
 # cp -r /lib/modules/3.2.0-4-amd64 / mnt / vdb1 / lib / modules
</pre><br><br>  I turned off 200, turned on 143 and entered the Grub manual boot commands: <br><br><pre> grub&gt; root (hd0, msdos1)
 grub&gt; linux /boot/vmlinuz-3.2.0-4-amd64 root = / dev / vda1
 grub&gt; initrd /boot/initrd.img-3.2.0-4-amd64
 grub&gt; boot
</pre><br><br>  The system booted and even successfully started mysql and apache2.  Of course, I had to fix <code>/etc/network/interfaces</code> so that the system went to the local network and was able to communicate with the router and the Internet. <br><br>  On a fully working machine, there were no further problems: I started the grub installation and installed the linux kernel from the repository to finally straighten the bootloader and follow the debian-way: <br><br><pre> # grub-install / dev / vda
 # apt-get update
 # apt-get install linux-image-2.6.32-5-486
 # reboot
</pre><br><br><h4>  Conclusion </h4><br>  As a result of all the manipulations, I got a virtual machine, almost identical to the original, but working in the Proxmox VE environment with the KVM hypervisor and not requiring a special bootloader.  The image is scheduled to be transferred to the client to run in a VMware ESX cluster. </div><p>Source: <a href="https://habr.com/ru/post/222975/">https://habr.com/ru/post/222975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222961/index.html">Intel¬Æ License Manager Configuration</a></li>
<li><a href="../222963/index.html">Unit Test Definition</a></li>
<li><a href="../222965/index.html">What is wrong with the Habrahabr design</a></li>
<li><a href="../222967/index.html">The first Omsk geo-hakaton</a></li>
<li><a href="../222969/index.html">Say a word about poor junior</a></li>
<li><a href="../222977/index.html">Creating reports about testing Android applications using Spoon and Emma</a></li>
<li><a href="../222979/index.html">Another Pattern Matching in C #</a></li>
<li><a href="../222983/index.html">Mega-Tutorial Flask, Part 5: User Login</a></li>
<li><a href="../222985/index.html">IBM System / 360 - The story of the failure, not so</a></li>
<li><a href="../222989/index.html">Deep DRM injection or what awaits Firefox after Brendan Ike leaves</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>