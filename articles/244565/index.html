<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The slowest x86 instruction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Everyone knows and loves the x86 assembler. Most of its instructions are performed by a modern processor in units or fractions of nanoseconds. Some op...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The slowest x86 instruction</h1><div class="post__text post__text-html js-mediator-article">  Everyone knows and loves the x86 assembler.  Most of its instructions are performed by a modern processor in units or fractions of nanoseconds.  Some operations that are decoded into a long sequence of microcode, or awaiting memory access can run much longer ‚Äî up to hundreds of nanoseconds.  This post is about champions.  The hit parade of four instructions under the cut, but for those who are too lazy to read the entire text, I will write here that the main villain is [memory] ++ under certain conditions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cbb/533/4fe/cbb5334fe348cabb33ef746f50c07704.jpg" alt="image"><br><br>  The KDV is taken from the document by Agner Foh, which, along with two documents from Intel (optimization guide and architecture software development manual), contains many useful and interesting topics. <br><a name="habracut"></a><br>  To begin with, there are commands that are expected to be executed within microseconds.  For example, IN, OUT or RSM (return from SMM).  VMEXIT has greatly accelerated in recent years, and microsecond fractions last on microprocessors.  There is MWAIT, which by definition is executed as long as possible.  In general, there are many ‚Äúheavy‚Äù instructions in ring 0, consisting entirely of microcode ‚Äî WRMSR, CPUID, setting control registers, etc.  The examples I give below can be performed with the privileges of ring 3, that is, in any ordinary program.  Even C programming is not necessary - virtual machines of some popular languages ‚Äã‚Äãare able to generate code containing these operations.  These are not some special processor commands, but ordinary instructions, sometimes under special conditions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since they are executed for a long time, any sane profiler will detect them with the usual time profiling, if, of course, they are found in a fairly ‚Äúhot‚Äù code.  There are also separate performance counters (PMU registers) that respond exclusively to such cases, with their help you can find these operations in a large program, even if they do not take a lot of absolute time (just why?).  The most popular tools for this are <a href="http://habrahabr.ru/company/intel/blog/162521/">Vtune</a> and Linux perf.  You can also use <a href="http://www.intel.com/software/pcm">PCM</a> , but it will not show where the instruction is. <br><br>  <b>Villain number four.</b>  The x86 command (in fact, x87), which can run for almost 700 clock cycles - FYl2X.  Calculates the binary logarithm multiplied by the second operand.  There is no analogue in SSE, so it is still found in nature.  There is no special counter. <br><br>  <b>Villain number three.</b>  Perhaps a slightly artificial example, but often used.  Fortunately, mostly in the drivers. <br>  The MFENCE command (or its subsets - LFENCE, SFENCE. By the way, LFENCE + SFENCE! = MFENCE).  If a long memory operation or PCIe write was performed before MFENCE, for example, an operation with non-temporal (MOVNTI, MOVNTPS, MASKMOVDQU, etc.) or operand located in the write through / write combined memory area, then the ‚Äúfence‚Äù itself It will take almost a microsecond or longer.  A performance counter for this situation exists, but is not in the processor core, but in ‚Äúuncore‚Äù, it is easier to work with it through PCM. <br><br>  <b>Villain number two.</b>  Here is a very simple code. <br><pre> double fptest = 3000000000.0f;  // Same with float.
 // TSC1
 int inttest = 2 + fptest;
 // TSC2
 time = TSC2 - TSC1;
</pre><br>  What do you think about what time will be?  (It doesn't matter if this code is compiled into x87 or scalar SSE).  This single instruction will be executed in 1-2 microseconds.  This is the so-called denormal operation, a special case that is handled by a long microcode sequence.  It is caught easily, the PMU register - the performance counter is called FP_ASSIST.ALL.  By the way, it is clear that measuring the difference in TSC when executing one (or even several dozen) instructions is almost always meaningless.  This case is an exception, we measure a long microcode. <br><br>  <b>The main villain.</b> <br><pre> static unsigned char array [128];
 for (int i = 0; i &lt;64; i ++) if ((int) (array + i)% 64 == 63) break;
 lock = (unsigned int *) (array + i);
 for (i = 0; i &lt;1024; i) * (lock) ++;  // prime
 // TSC1
    asm volatile (
     "lock xaddl% 1, (% 0) \ n"
     : // no output
     : "r" (lock), "r" (1));
    // or in Windows, just InterlockedIncrement (lock);
 // TSC2
 time = TSC2 - TSC1;
</pre><br>  Well, and the bonus - unlike other participants of the parade hit, this code will force all other cores to also stop for a smoke break for a period of several thousand cycles. <br>  This is also caught with Vtune, perf, PCM, etc.  using the LOCK_CYCLES.SPLIT_LOCK_UC_LOCK_DURATION counter.  The example may seem far-fetched, but over the past year I have encountered this problem with my clients twice.  In one of the cases, LOCK_CYCLES.SPLIT_LOCK_UC_LOCK_DURATION went off scale during initialization of a huge program written in .net.  I didn‚Äôt figure out then, rantatime or the client‚Äôs code put the mutex so badly, but the performance dropped seriously - another independent program running on a different core slowed down thirty times. <br><br>  Does anyone know even a slower instruction?  (REP MOV not offer). </div><p>Source: <a href="https://habr.com/ru/post/244565/">https://habr.com/ru/post/244565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244553/index.html">How we select2 in helper wrapped</a></li>
<li><a href="../244557/index.html">A tale about how tech support Veeam introduced gamification</a></li>
<li><a href="../244559/index.html">Brief history of hacking. A story from the head of information security at Yandex</a></li>
<li><a href="../244561/index.html">Do it yourself search on the site</a></li>
<li><a href="../244563/index.html">"Mathematics is one of the forms of art": post to the centenary of the birth of Martin Gardner</a></li>
<li><a href="../244571/index.html">Consulo: ~ 1000 kommitov, or as the autumn passed</a></li>
<li><a href="../244573/index.html">Eggs.Variant - Part I</a></li>
<li><a href="../244575/index.html">Swift Error Handling - Sword and Magic</a></li>
<li><a href="../244577/index.html">What the team leader should know and how we made up the program for the second day of the Go conference</a></li>
<li><a href="../244579/index.html">Review of the most interesting materials on data analysis and machine learning ‚Ññ24 (November 24 - 30, 2014)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>