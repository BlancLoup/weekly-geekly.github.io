<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dramophon: Portable Digital Drum Set</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear habrovchane. While the next article on STM32F microcontrollers is in the process of writing, I decided to share with you my old p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dramophon: Portable Digital Drum Set</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear habrovchane.  While the next article on STM32F microcontrollers is in the process of writing, I decided to share with you my old project compiled on AVRs.  Honestly, I was not too drawn back to the topic of AVR, but because  I recently dug up old materials on my projects, I decided that it would be better to share them with the public.  The project is very simple, and the result, in my opinion, is quite interesting, which makes this device a good start for beginners.  In general, if anyone wants to repeat - welcome under the cut, we begin to make a digital portable drum set. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  The name for the device turned out quite loud, but in fact it is just a fun toy.  Although, we used it with friends as a drummer several times while playing the guitar. <br>  What are we collecting?  We are assembling a device that has 8 touch buttons, by clicking on which it reproduces the drum sample recorded in memory. <br>  This is how the device looks like: <br><br><img src="https://habrastorage.org/storage1/7564ca32/0a44ff32/9bed4786/7e98b240.jpg" alt="image"><br><br>  And this is how it works (in the video of the drama before being placed in the case). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/zs22p48rFD8%3Ffeature%3Doembed&amp;xid=17259,15700021,15700043,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhgbrlsOB4PQP0nN-c--wZFTQT23Vw" frameborder="0" allowfullscreen=""></iframe><br><br>  Structurally, the device consists of the actual drum card, on which the controlling controller is located, a flash memory mikruha, a slot for an SD card, a 12-bit DAC and an amplifier, sensor boards connected to the main board with an SPI interface and a speaker.  All this electronics is assembled in the case of the old column Genius, which fits perfectly. <br><br><img src="http://www.24au.ru/photo/52/262210.jpg" alt="image"><br><br>  In general, I advise you to adopt this case - if you assemble a device that should output a more or less loud sound, and you think in which case to stuff it - look at the old speakers, it is quite possible that they will suit you. <br>  In my scheme, there was also a display, but apart from the test message, I didn‚Äôt display anything on it, so we‚Äôll discard them. <br>  How to assemble a touch keyboard, I already told in the relevant <a href="http://habrahabr.ru/blogs/DIY/111679/">article</a> .  We turn to the circuitry of the main board. <br><br><h4>  Circuitry </h4><br>  The scheme of the device is very simple.  Four-watt amplifier, assembled on a TDA1904 chip, fully according to the scheme recommended in the datasheet.  Capacitor C14 cuts off the unnecessary DC component of the voltage, the low-pass filter on R2 and C16 restores the waveform after the DAC (the so-called interpolating filter). <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/0f8/bb2/e68/0f8bb2e68927013f13fe5bb3fea04507.jpg" alt="image"><br><br>  The digital part consists of an ATMega32 microcontroller, an AT25FD161 flash chip, an SD card and a 12-bit DAC7611 DAC.  All peripherals, including the external touch keyboard, are connected via the SPI bus. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/276/cd5/bcb/276cd5bcb2f85443000e0d3a76c9082d.jpg" alt="image"><br><br>  Since the project is old, one of my first, I can not say that the choice of components is perfect.  The plans were originally Napoleonic, so I took ‚Äúmore‚Äù for mega, and stuck the display - in fact, in the form in which it is now assembled, it would be quite enough ATMega88.  Since the mega and DAC are powered by 5V, and the card and flash drive require 3.3, the levels are consistent with the dividers.  This is not a very good solution, now I would not do that, but would use a special converter so as not to overwhelm the signal fronts (and best of all, I would build the entire schematics on 3.3V elements), but this is now) <br>  As for the SD-card, when connecting it, I used the information from the following <a href="http://elm-chan.org/docs/mmc/mmc_e.html">site</a> : <br>  I must say, there are a large number of interesting projects and useful documentation on it, if you started working with AVR, be sure to look there. <br>  The device is powered by a 9V battery, the amplifier is powered directly from it, the digital schematics is powered by 3.3 and 5V linear stabilizers. <br><br><img src="https://habrastorage.org/storage1/a284bbb5/ed591759/56f04227/ec4291e5.jpg"><br><br>  Here, in principle, is all that concerns the circuit part.  Since the project is more than two years old, I could have missed something, or the scheme could turn out to be an older version of what I had in hardware, but I conveyed the main idea.  You will not be difficult if you want to repeat and improve what I suggested. <br><br><h4>  Software implementation </h4><br><br>  How does all this work? <br>  If we omit the question of how I originally conceived it (display, etc., aha), then we get the following: I didn‚Äôt play the samples directly from the card, because  I was afraid that I didn‚Äôt have enough time to read the data (SPI-mode SDbk is rather slow), so I used the card to transfer the samples to the USB flash drive once, then disconnect it from the device and no longer connect it. <br>  The device every few milliseconds polls the keyboard on the SPI, having received data from it, finds out which buttons are pressed.  Since he does not have ‚Äúpolyphony‚Äù, the priority is given to the last pressed.  After that, the timer turns on, and with a sampling frequency of 16 kHz, the sample corresponding to the button begins to be read from the flash drive and output to the DAC. <br>  The program principles of working with the card are stated on the already mentioned site.  In short, the card can work in two modes: SPI and standard.  By default, the standard mode is enabled, and by SPI it can accept only one command - to switch the mode.  Standard mode does not impose additional restrictions on speed, allows the use of a bus of 4 conductors, instead of one, but requires a CRC calculation, which without a hardware calculator will make this mode on mega even slower than SPI.  Therefore, a card is given a command to change modes (in this command, the CRC is checked, but it can be pre-calculated and output with hard code), after which it can communicate with the same commands, but without CRC, with standard SPI signals.  Library for working with the card can be found <a href="http://www.procyonengineering.com/embedded/avr/avrlib/">here</a> .  Again, who is engaged in AVR - add this link to your favorites, this is a huge library that includes peripheral drivers (cards, displays, etc.), protocol implementations, and much more.  In order not to waste forces on the file system, the samples recoded in 16 bits x 16 kHz were folded raw, starting from the first byte of the card.  This is easily accomplished with <a href="http://ru.wikipedia.org/wiki/WinHex">WinHEX</a> , an excellent hex editor that allows low-level writing to physical media.  In the same form, the samples are overwritten on the flash memory chip as well.  For convenience, the duration of all samples is the same and amounts to 8000 samples (half a second at a sampling frequency of 16KHz) <br>  Working with a DAC and a flash drive is also not difficult: the DAC simply needs to send 12 bits of data, the most significant bit forward, and then jerk with LD, meaning a transfer from the input register to the internal one.  Since the mega works with bytes, you should add 12 bits to 16 zeros. <br>  A flash drive accepts commands to read, erase and write.  After the read / write commands, data can be received / sent by the stream, since  the address counter in it is auto-incremented. <br>  I would gladly share the program code with you, as I usually do, but alas, the source code was lost during hard formatting, apparently, it looked through and did not save ... But I think it will not be difficult for you to start a 16 KHz timer and issue it in the interrupt on the DAC, the value read from the flash drive) <br><br><h4>  Conclusion </h4><br><br>  I must say that it is rather funny after a few years to write an article about your old projects developed during the training.  Every now and then, thoughts arise, ‚ÄúOh, well, I am so, because it could have been done differently, it would have been better!‚Äù.  Not to mention that the element base also does not stand still, and developing a similar device on the same STM32F1xx will not be able to take care of either an external DAC (there is a built-in!) Or level coordination (powered by 3.3V, like with a card ), nor about communication with the card (STMka can communicate with them in normal mode, with CRC).  However, whatever this project was, it served as an excellent training in the development of devices.  Therefore, I recommend to all beginners: after you master the flashing LEDs, choose a project that will be of interest to you and try to implement it.  Any - even though I described the drama, at least one of the hundreds of other projects on the AVR, lit on the Internet, and even better - completely your own.  Let it end up being not the way it was originally conceived, and in consequence you will seem simple and crooked - but it will give you a very rewarding experience. <br>  Good luck in the development! <br><br>  PS <br>  Links from the article: <br><ul><li>  The site of a certain developer of devices on AVR, many projects and useful information - in particular - the use of SD cards: <a href="http://elm-chan.org/docs/mmc/mmc_e.html">http://elm-chan.org/docs/mmc/mmc_e.html</a> </li><li>  Huge library of peripheral drivers and other AVR pluses: <a href="http://www.procyonengineering.com/embedded/avr/avrlib/">http://www.procyonengineering.com/embedded/avr/avrlib/</a> </li><li>  WinHEX Hex Editor Information: <a href="http://ru.wikipedia.org/wiki/WinHex">http://ru.wikipedia.org/wiki/WinHex</a> </li><li>  Datasheet on TDA1904, which shows a typical wiring diagram and describes the purpose of all the details: <a href="http://www.datasheetcatalog.org/datasheet/stmicroelectronics/1445.pdf">http://www.datasheetcatalog.org/datasheet/stmicroelectronics/1445.pdf</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/124112/">https://habr.com/ru/post/124112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124105/index.html">Powershell - logging to file</a></li>
<li><a href="../124107/index.html">Moscow GTUG - reboot</a></li>
<li><a href="../124108/index.html">Generation of analytical surfaces on the example of maps. Part 3</a></li>
<li><a href="../124110/index.html">Writing automated tests to test the desktop user interface</a></li>
<li><a href="../124111/index.html">Beta Flash Player 11 (including 64-bit) and Air 3 (with Molehill 3D) have been released</a></li>
<li><a href="../124113/index.html">Equality in Ruby</a></li>
<li><a href="../124116/index.html">The final version of Small Basic 1.0 has been released!</a></li>
<li><a href="../124120/index.html">E-music website CjClub.ru introduced support for Creative Commons licenses</a></li>
<li><a href="../124124/index.html">They said ... i.e. tweeted "Let's go!"</a></li>
<li><a href="../124125/index.html">inmile.com - second launch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>