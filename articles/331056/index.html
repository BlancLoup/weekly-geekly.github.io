<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fear and Loathing in MiddleWare</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We were close to javascript when we beat php. I remember saying something like: Something is spinning in my head. Maybe you better lead the project. 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fear and Loathing in MiddleWare</h1><div class="post__text post__text-html js-mediator-article">  <i>We were close to javascript when we beat php.</i>  <i>I remember saying something like: Something is spinning in my head.</i>  <i>Maybe you better lead the project.</i> <i><br><br><img src="https://habrastorage.org/web/f3a/c8b/50a/f3ac8b50ab5048cc88db169d9b327e24.jpg"><br><br></i>  <i>Suddenly, there was a terrible boom around us ... And the whole WEB was teeming with these articles about LAMP ...</i> <i><br></i>  <i>It seemed that they were written for any needs.</i>  <i>They grew and absorbed tasks for which previously used perl, bash and even C. There is no sense in talking about these articles, I thought.</i>  <i>Everybody knows it.</i> <i>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </i>  <i>We had a fifth IE, some Netscape, Opera, and a whole sea of ‚Äã‚Äãdisparate cgi modules on perl.</i>  <i>Not that it was a necessary technology stack.</i>  <i>But if you started collecting crap, it becomes difficult to stop.</i>  <i>The only thing that caused me fear was <a href="https://habrahabr.ru/post/57000/">a student using PHP</a> .</i>  <i>There is nothing more helpless, irresponsible and spoiled than that.</i>  <i>I knew that sooner or later we will move on to this rubbish.</i> <br><a name="habracut"></a><br><h2>  In the beginning <s>it was</s> not </h2><br>  Once JS between browsers differed as a horse from a traffic jam, and XMLHttpRequest was possible only through ActiveX.  There was no way out.  That the dynamic web has been cut down.  IE 6 seemed to be a revolution.  But if you wanted cross-platform - your path ran through the volumetric MiddleWare.  A large number of articles on php, tools and related new libraries did their job. <br><br>  <i>Damn php, you begin to behave like a country drunk from old Irish novels, a complete loss of basic motor functions, blurred vision, a wooden tongue, a brain in horror.</i>  <i>An interesting condition when you see everything, but can not control anything.</i>  <i>You come to the task, clearly knowing where the data is, where the logic is and where the presentation is.</i>  <i>But on the spot everything goes wrong.</i>  <i>You are confused by an evil noodles code, and you think: what's the matter, what's going on? ...</i> <br><br>  Gradually, the titanic plates between browsers began to converge.  Everywhere XMLHttpRequest appeared and dreams of a dynamic WEB with a clear division across fronts became a reality. <br><br>  <i>Of course, I fell victim to the craze.</i>  <i>An ordinary street slacker, who studied everything that fell under the arm.</i>  <i>Ideas about a common language for web development were in the air.</i>  <i>Wait, you see these changes in a new guise, man.</i> <i><br></i>  <i>- Let's see Node.js.</i> <i><br></i>  <i>- What?</i>  <i>Not!</i> <i><br></i>  <i>- You can not stop here.</i>  <i>This is a fat middle.</i> <i><br></i>  <i>- Sit down.</i> <i><br></i>  <i>What kind of nonsense they rod, I do not know how much you need to write in JavaScript to find similarities between Front, Middle and BackEnd?</i>  <i>This is the wrong option.</i>  <i>Too fat for the chosen target.</i> <i><br></i> <br><br>  But, I left such thoughts.  It has been realized that a nail can be hammered with a screwdriver, but if you sometimes reach the hammer, the process will seriously accelerate. <br><br>  <i>I felt a monstrous protest against the whole situation.</i> <br><br>  There are also DBMS, such as PostgreSQL, which allow incredibly to operate with data through embedded functions.  Business logic inside the base!  Real BackEnd.  Do not like the business logic in the database and it does not belong there?  And such direct data streams like? <br><br><img src="https://habrastorage.org/web/cb9/e04/d76/cb9e04d762a64b8facab92a2861ec5b0.gif"><br>  Let's try to figure out the thorny movement of data on the "direct" flows of the smoker. <br><br>  The first thing we encounter is a constant data distillation in the middle, for any reason.  In addition, this data may not be completely final and only be required for the calculation of subsequent requests.  For data processing cycles are used.  Procedural loops are not optimized for multithreading. <br><br>  The multiplicity of requests in one session to the DBMS leads to the inevitable apotheosis of the demise of speed - multipass through the database tables. <br><br><img src="https://habrastorage.org/web/65f/20b/830/65f20b8300df4bf4830419287259be1d.jpg"><br><br>  To eliminate these factors, the logic has to be transferred closer to the data, i.e.  in the DBMS! <br>  And this is the most optimal way to bring the speed to new values! <br><br><h2>  Becoming an idea </h2><br>  Over time, browsers have learned the full dynamic generation of the interface.  Achivka clear separation of data fronts and presentation.  There was a full-fledged opportunity to drive mainly data from server to client.  There was only one question: What to do with the middle layer?  How to minimize it exclusively to the transport function with elements of simple routing of requests for server-side collections. <br><br>  <i>These naive developers believed that one could gain spiritual peace and understanding by studying one of the strongholds of the old Middle, and the result was the generation of a thick layer, who did not understand the main mistake of the IT industry as old as the world.</i>  <i>Overlooking the belief that Someone or Something may have a <a href="http://lurkmore.to/%25D0%25A4%25D0%25B0%25D1%2582%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BD%25D0%25B5%25D0%25B4%25D0%25BE%25D1%2581%25D1%2582%25D0%25B0%25D1%2582%25D0%25BE%25D0%25BA">fatal flaw</a> .</i> <i><br></i>  <i>By that time, nginx began to work, and there were no questions left with what to prepare the proposed idea.</i>  <i>It was no longer an idea.</i>  <i>Now it was a programmer contest with laziness.</i>  <i>The idea itself, to try to somehow describe the architecture in the traditional way, through apache, seemed absurd.</i> <i><br></i> <br>  In 2010, the <a href="https://github.com/FRiCKLE/ngx_postgres">ngx_postgres</a> module arrived on github.  Setting requests in the configuration file and issuing in JSON / CSV / SOMETHING. <br>  Simple SQL code was enough for configuration.  Complicated it was possible to wrap in a function that was then called from the config. <br><br>  But this module could not load the http request body into the DBMS.  That imposes serious restrictions on the data sent to the server.  The URL is clearly only suitable for filtering the request. <br>  The serialization of the output data was carried out by means of the module itself.  That, from the height of my couch, seemed to be a meaningless translation of RAM - PostgreSQL was able to serialize. <br>  There was a thought to correct, rewrite.  I began to dig in the code of this module. <br><br>  <i>After a sleepless night of searching for many, ngx_postgres would suffice.</i>  <i>We needed something stronger.</i> <i><br></i>  <i>Madam, sir, baby, or <a href="https://github.com/AntonRiab/ngx_pgcopy">whatever</a> ... there is an option, here, hold <a href="https://github.com/AntonRiab/ngx_pgcopy">ngx_pgcopy</a> .</i> <i><br></i> <br><img src="https://habrastorage.org/web/c5e/0aa/3ef/c5e0aa3ef56b4a659dd2ef64f3720e42.gif"><br><br><h2>  NGX_PGCOPY </h2><br>  After the experiment, experiments and analysis of analyzes, the idea arose to rewrite everything practical from scratch.  To speed up the loading, <a href="https://www.postgresql.org/docs/current/static/sql-copy.html">COPY</a> queries were selected, which translate the data into the database an order of magnitude faster than the inserts and contain their own parser.  Unfortunately, due to the paucity of describing this type of query, it is difficult to say how the DBMS will conduct with particularly massive calls to this method. <br><br>  <i>The world is mad in any direction and at any time, you come across it constantly.</i>  <i>But there was an amazing, universal sense of the correctness of all that we did.</i> <i><br></i> <br>  Together with COPY-requests, we automatically received serialization in CSV in both directions, which eliminated the need for data conversion concerns. <br><br>  Let's start with a primitive, sending and receiving the entire table in CSV by URL: <br> <code>http://some.server/csv/some_table</code> <br> <br>  CSV part <b>import.export.nginx.conf</b> <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">pgcopy_server</span></span> db_pub <span class="hljs-string"><span class="hljs-string">"host=127.0.0.1 dbname=testdb user=testuser password=123"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> ~/csv/(?&lt;table&gt;[<span class="hljs-number"><span class="hljs-number">0</span></span>-9A-Za-z_]+) { <span class="hljs-attribute"><span class="hljs-attribute">pgcopy_query</span></span> PUT db_pub <span class="hljs-string"><span class="hljs-string">"COPY </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$table</span></span></span><span class="hljs-string"> FROM STDIN WITH DELIMITER as ';' null as '';"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pgcopy_query</span></span> GET db_pub <span class="hljs-string"><span class="hljs-string">"COPY </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$table</span></span></span><span class="hljs-string"> TO STDOUT WITH DELIMITER ';';"</span></span>; }</code> </pre><br><img src="https://habrastorage.org/web/b3e/22b/8a5/b3e22b8a57ca4e5ba6bf7834e031a458.jpg"><br><br>  Currently PostgreSQL cannot in JSON and XML via COPY STDIN.  I hope that the day of humility with the tabs in the code-style of the elephant will come, and I, or one thread, will find time and fasten this functionality to COPY methods.  Moreover, in the DBMS processing of these formats is already present. <br><br>  <b>But!</b>  <b>Method of application here and now is still there!</b>  We configure nginx to client_body_in_file_only on with subsequent use of the $ request_body_file variable in the request and passing it to the pg_read_binary_file function ... <br>  Of course, this will have to be wrapped in the COPY method, since  Will work only with my moped, due to the full body_rejecta of ngx_postgres.  I have not yet met other mopeds, and ngx_pgcopy has not yet matured for additional functionality. <br><br>  Consider how it looks for json / xml in <b>import.export.nginx.conf</b> <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">client_body_in_file_only</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">client_body_temp_path</span></span> /var/lib/postgresql/<span class="hljs-number"><span class="hljs-number">9</span></span>.<span class="hljs-number"><span class="hljs-number">6</span></span>/main/import; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> ~/json/(?&lt;table&gt;[<span class="hljs-number"><span class="hljs-number">0</span></span>-9A-Za-z_]+) { <span class="hljs-attribute"><span class="hljs-attribute">pgcopy_query</span></span> PUT db_pub <span class="hljs-string"><span class="hljs-string">"COPY (SELECT * FROM import_json_to_simple_data('</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request_body_file</span></span></span><span class="hljs-string">')) TO STDOUT;"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pgcopy_query</span></span> GET db_pub <span class="hljs-string"><span class="hljs-string">"COPY (SELECT '['||array_to_string(array_agg(row_to_json(simple_data)), ',')||']' FROM simple_data) TO STDOUT;"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> ~/xml/(?&lt;table&gt;[<span class="hljs-number"><span class="hljs-number">0</span></span>-9A-Za-z_]+) { <span class="hljs-attribute"><span class="hljs-attribute">pgcopy_query</span></span> PUT db_pub <span class="hljs-string"><span class="hljs-string">"COPY (SELECT import_xml_to_simple_data('</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request_body_file</span></span></span><span class="hljs-string">') TO STDOUT;"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pgcopy_query</span></span> GET db_pub <span class="hljs-string"><span class="hljs-string">"COPY (SELECT table_to_xml('</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$table</span></span></span><span class="hljs-string">', false, false, '')) TO STDOUT;"</span></span>; }</code> </pre><br>  Yes, client_body_temp_path will have to be put in the base directory, and the user will be given ALTER SUPERUSER.  Otherwise, Postgres will send our desires beyond the horizon. <br>  The export presented in the GET methods uses the built-in functions included in the standard Postgres delivery.  All COPYs are output to STDOUT, in case we want to notify the client about the results of these actions.  Import to a fixed table (simple_data) looks a bit more bulky than export, therefore it is in the user-defined DBMS procedure. <br><br>  Part of <b>1.import.export.sql</b> for importing into a fixed table <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> import_json_to_simple_data(filename <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> simple_data <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> json_populate_recordset(<span class="hljs-literal"><span class="hljs-literal">null</span></span>::simple_data, convert_from(pg_read_binary_file(filename), <span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>)::<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$ LANGUAGE plpgsql; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> import_xml_to_simple_data(filename <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> simple_data <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (xpath(<span class="hljs-string"><span class="hljs-string">'//s_id/text()'</span></span>, myTempTable.myXmlColumn))[<span class="hljs-number"><span class="hljs-number">1</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> s_id, (xpath(<span class="hljs-string"><span class="hljs-string">'//data0/text()'</span></span>, myTempTable.myXmlColumn))[<span class="hljs-number"><span class="hljs-number">1</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> data0 <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unnest</span></span>(xpath(<span class="hljs-string"><span class="hljs-string">'/*/*'</span></span>, XMLPARSE(<span class="hljs-keyword"><span class="hljs-keyword">DOCUMENT</span></span> convert_from(pg_read_binary_file(filename), <span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>)))) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> myTempTable(myXmlColumn); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$ LANGUAGE plpgsql;</code> </pre><br>  The import function with a flexible table selection for JSON is not much different from the one above.  But such flexibility for XML generates a more monstrous division. <br><div class="spoiler">  <b class="spoiler_title">Part of 1.import.export.sql for importing into an arbitrary table.</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> import_vt_json(filename <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, target_table <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>( <span class="hljs-string"><span class="hljs-string">'INSERT INTO %I SELECT * FROM json_populate_recordset(null::%I, convert_from(pg_read_binary_file(%L), ''UTF-8'')::json)'</span></span>, target_table, target_table, filename); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$ LANGUAGE plpgsql; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> import_vt_xml(filename <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, target_table <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> columns_name <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> columns_name := ( <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> xml_file <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unnest</span></span>(xpath( <span class="hljs-string"><span class="hljs-string">'/*/*'</span></span>, XMLPARSE(<span class="hljs-keyword"><span class="hljs-keyword">DOCUMENT</span></span> convert_from(pg_read_binary_file(filename), <span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>)))) <span class="hljs-comment"><span class="hljs-comment">--read tags from file ), columns_name AS ( SELECT DISTINCT ( xpath('name()', unnest(xpath('//*/*', myTempTable.myXmlColumn))))[1]::text AS cn FROM xml_file AS myTempTable(myXmlColumn) --get target table cols name and type ), target_table_cols AS ( -- SELECT a.attname, t.typname, a.attnum, cn.cn FROM pg_attribute a LEFT JOIN pg_class c ON c.oid = a.attrelid LEFT JOIN pg_type t ON t.oid = a.atttypid LEFT JOIN columns_name AS cn ON cn.cn=a.attname WHERE a.attnum &gt; 0 AND c.relname = target_table --'log_data' ORDER BY a.attnum --prepare cols to output from xpath ), xpath_type_str AS ( SELECT CASE WHEN ttca.cn IS NULL THEN 'NULL AS '||ttca.attname ELSE '((xpath(''/*/'||attname||'/text()'', myTempTable.myXmlColumn))[1]::text)::' ||typname||' AS '||attname END AS xsc FROM target_table_cols AS ttca ) SELECT array_to_string(array_agg(xsc), ',') FROM xpath_type_str ); EXECUTE format('INSERT INTO %s SELECT %s FROM unnest(xpath( ''/*/*'', XMLPARSE(DOCUMENT convert_from(pg_read_binary_file(%L), ''UTF-8'')))) AS myTempTable(myXmlColumn)', target_table, columns_name, filename); END; $$ LANGUAGE plpgsql;</span></span></code> </pre><br></div></div><br>  In the examples given, the name table_name in the imported file does not affect the target destination table specified in nginx.  The use of the xml hierarchy of the document table_name / rows / cols is due exclusively to symmetry with the built-in <a href="https://www.postgresql.org/docs/current/static/functions-xml.html">table_to_xml</a> function. <br><br>  The data sets themselves ... <br><div class="spoiler">  <b class="spoiler_title">simple_data_table.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> simple_data ( s_id <span class="hljs-built_in"><span class="hljs-built_in">SERIAL</span></span>, data0 <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> );</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">data.csv</b> <div class="spoiler_text"> <code>0;zero <br> 1;one <br></code> </div></div><br><div class="spoiler">  <b class="spoiler_title">data.json</b> <div class="spoiler_text"><pre> <code class="hljs json">[ {<span class="hljs-attr"><span class="hljs-attr">"s_id"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data0"</span></span>: <span class="hljs-string"><span class="hljs-string">"five"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">"s_id"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data0"</span></span>: <span class="hljs-string"><span class="hljs-string">"six"</span></span>} ]</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">data.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">simple_data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">row</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s_id</span></span></span><span class="hljs-tag">&gt;</span></span>3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s_id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data0</span></span></span><span class="hljs-tag">&gt;</span></span>three<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data0</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">row</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">row</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s_id</span></span></span><span class="hljs-tag">&gt;</span></span>4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s_id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data0</span></span></span><span class="hljs-tag">&gt;</span></span>four<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data0</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">row</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">simple_data</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br>  We have drifted away here, so let's return to the sources of pure COPY ... <br><br>  <i>Okay.</i>  <i>This is probably the only way.</i>  <i>Just let's make sure I understood everything correctly.</i>  <i>Do you want to send data between the server and the client without processing filling it into a table?</i> <br><br><img src="https://habrastorage.org/web/b59/74d/14e/b5974d14e3494f4a91d6c74439bc7230.jpg"><br><br>  <i>I think I caught fear.</i> <i><br></i>  <i>Nonsense.</i>  <i>We came to find MidleWare dream.</i> <i><br></i>  <i>And now, when we are right in her whirlwind, do you want to leave?</i> <i><br></i>  <i>You have to understand, man, we found the main nerve.</i> <i><br></i> <br><br>  Yes, it's almost like that!  This is a rejection of CRUD. <br>  Of course, many will be indignant as some type in a couple of sentences crosses out the results of the work of the California minds, styling a short little article for the dialogues of a drug-addicted film.  However, all is not lost.  There is an option to transfer the data modifier along with the data itself.  That still leads away from the usual RESTful architecture. <br><br>  In addition, sometimes, and when and more often, theoretical studies are broken on the rocks of reality.  Such rocks are still the same unfortunate multipass.  In fact, if you allow a change in a number of positions of a user document, then it is likely that these changes will include several types of methods.  As a result, to send a single document to the database, you will need to conduct several separate http requests.  And each http request will generate its own modification of the database and its passage through the tables.  Therefore, a qualitative breakthrough requires fundamental changes to abandon the classical understanding of CRUD methods.  Progress requires sacrifice. <br><br>  Here I had suspicions that a more interesting solution could be found.  You just need to experiment and think a bit ... <br><br><h2>  Point of entry </h2><br>  <i>By the time I asked this question,</i> <i><br></i>  <i>No one who could answer him was not there yet.</i> <i><br></i>  <i>Yes, yes, I'm starting again ...</i> <i><br></i> <br>  We send data to the middle layer, which sends it to the database without processing. <br>  The DBMS parses them and puts them in a table that performs the role of a log / log.  Registration of all input data. <br><br>  <b>The key point, here it is!</b>  <b>Journaling / logging data flow out of the box!</b>  And then it's up to triggers.  In them, on the basis of the business logic, we decide: to update, add or do something else.  Screwing the data modifier is optional, but can be a nice bonus. <br><br>  This leads us to the adequacy of using HTTP methods GET and PUT.  Let's try to model how to apply it.  To begin with we will be defined with a difference between magazines and a broad gull.  We distinguish the key difference through the priority between the value of the route of change and the final value.  The first criterion belongs to the logs, the second - to the logs. <br><br>  Despite the priority of the final goal in the logs, the route is still necessary.  Which leads us to the separation of such tables into two parts: the result and the journal itself. <br><br><img src="https://habrastorage.org/web/8ca/a41/57b/8caa4157bd984b7698cd77d7670fb7a4.gif"><br><br>  What is it possible to pull?  Logs: the route of the car, the movement of material values, etc.  Logs: stock balance, last comment, and other recent instantaneous data states. <br><br>  Code from 2.jrl.log.sql: <br><br><div class="spoiler">  <b class="spoiler_title">Tables</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> rst_data ( <span class="hljs-comment"><span class="hljs-comment">--Output/result table 1/2 s_id SERIAL, data0 TEXT, --Operating Data data1 TEXT, --Operating Data ); --Service variable with prefix s_, ingoring input value, it will be setting from trigers CREATE TABLE jrl_data ( --Input/journal table 2/2 s_id SERIAL, --Service variable, Current ID of record s_cusr TEXT, --Service variable, User name who created the record s_tmc TEXT, --Service variable, Time when the record was created p_trid INTEGER, --Service variable, Target ID/Parent in RST_(result) table, -- if exists for modification data0 TEXT, data1 TEXT, ); CREATE TABLE log_data ( --Input/output log table 1/1 s_id SERIAL, s_cusr TEXT, s_tmc TEXT, pc_trid INTEGER, --Service variable, Target ID(ParentIN/ChilrdenSAVE) -- in CURRENT table, if exists for modification data0 TEXT, data1 TEXT, );</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Magazine Trigger</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> trg_4_jrl() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> update_result <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; target_tb TEXT :='rst_'||substring(TG_TABLE_NAME from 5); <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-comment"><span class="hljs-comment">--key::text,value::text DROP TABLE IF EXISTS not_null_values; CREATE TEMP TABLE not_null_values AS SELECT key,value from each(hstore(NEW)) AS tmp0 INNER JOIN information_schema.columns ON information_schema.columns.column_name=tmp0.key WHERE tmp0.key NOT LIKE 's_%' AND tmp0.key &lt;&gt; 'p_trid' AND tmp0.value IS NOT NULL AND information_schema.columns.table_schema = TG_TABLE_SCHEMA AND information_schema.columns.table_name = TG_TABLE_NAME; IF NEW.p_trid IS NOT NULL THEN EXECUTE (WITH keys AS ( SELECT ( string_agg((select key||'=$1.'||key from not_null_values), ',')) AS key) SELECT format('UPDATE %s SET %s WHERE %s.s_id=$1.p_trid', target_tb, keys.key, target_tb) FROM keys) USING NEW; END IF; GET DIAGNOSTICS update_result = ROW_COUNT; IF NEW.p_trid IS NULL OR update_result=0 THEN IF NEW.p_trid IS NOT NULL AND update_result=0 THEN NEW.p_trid=NULL; END IF; EXECUTE format('INSERT INTO %s (%s) VALUES (%s) RETURNING s_id', target_tb, (SELECT string_agg(key, ',') from not_null_values), (SELECT string_agg('$1.'||key, ',') from not_null_values)) USING NEW; END IF; RETURN NEW; END; $$ LANGUAGE plpgsql;</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Trigger for logs</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> trg_4_log() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> NEW.pc_trid <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> str_arg <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'s_%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ekey, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'s_%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'t.'</span></span>||<span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> TG_TABLE_NAME||<span class="hljs-string"><span class="hljs-string">'.'</span></span>||<span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> tkey, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'s_%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'$1.'</span></span>||<span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, isc.ordinal_position <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span>(hstore(<span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> tmp0 <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> information_schema.columns <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> isc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> isc.column_name=tmp0.key <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> isc.table_schema = TG_TABLE_SCHEMA <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> isc.table_name = TG_TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> isc.ordinal_position) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>(<span class="hljs-string"><span class="hljs-string">'WITH upd AS (UPDATE %s SET pc_trid=%L WHERE s_id=%L) SELECT %s FROM (VALUES(%s)) AS t(%s) LEFT JOIN %s ON t.pc_trid=%s.s_id'</span></span>, TG_TABLE_NAME, NEW.s_id, NEW.pc_trid, string_agg(tkey, <span class="hljs-string"><span class="hljs-string">','</span></span>), string_agg(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-string"><span class="hljs-string">','</span></span>), string_agg(ekey, <span class="hljs-string"><span class="hljs-string">','</span></span>), TG_TABLE_NAME, TG_TABLE_NAME) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> str_arg ) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span>; NEW.pc_trid=NULL; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; RETURN NEW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$ LANGUAGE plpgsql;</code> </pre></div></div><br>  The given examples do not know how to clean the cells, because  for this you need to fasten utility values.  And they are highly dependent on the method of import.  In some cases, it can be any type with completely arbitrary content.  In others, only the type of the target column with a probable sign to exit the range. <br><br>  Triggers are called <b>in the order of text sorting</b> by name.  I recommend using trg_N_ prefixes.  From trg_0 to trg_4 to be considered as service ones, serving only the integrity of the common logic and incoming filtering.  And from 5 to 9 use for applied calculations.  Nine triggers <a href="http://lurkmore.to/640K">will be enough for everyone</a> ! <br><br>  It is also worth saying that they need to be installed on BEFORE INSERT.  As in the case of AFTER, the NEW service variable will be put in the table before it is modified by the trigger.  In principle, if integrity is not critical to some extent, such a solution can be a good accelerator for user requests passing through the log.  This will not affect the values ‚Äã‚Äãof the resulting table. <br><br>  Also, with AFTER, we will not be able to return an error if the user does not have permission to change.  But the correct FrondEnd and should not carry out operations prohibited by the server.  Accordingly, such behavior is more likely characteristic of hacking, which will be peacefully recorded in the journal. <br><br><h2>  Filtering and routing </h2><br><img src="https://habrastorage.org/web/4d5/d58/b26/4d5d58b268354222a5d8a6b0202c21f8.jpg"><br><br>  Routing URLs using standard nginx tools.  In the same way we filter the request from injections.  After doubling the problem, the code similar to the result of asymmetric encryption is pushed into the directive map nginx.conf to get a digestible and secure SQL query.  Which, further, we filter the data. <br><br>  There are some difficulties.  They are caused by the lack of regularization in nginx for multiple replacements like <b>sed s / bad / good / g</b> .  As a result, we ... <br><br>  <i>We fall right into the thick of this fucking terrarium.</i>  <i>And after all, someone has the mind to write these damn expressions!</i>  <i>A little more and they will tear the brain to shreds.</i> <br><br>  up to 4 equivalency filters by URL <br> <code>http://some.server/csv/table_name/*?col1=value&amp;col2=value&amp;col3=value&amp;col4=value</code> <br>  <b>Horrowshow part of filters.nginx.conf</b> <br><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">#  SQL map $args $fst0 { default ""; "~*(?&lt;tmp00&gt;[a-zA-Z0-9_]+=)(?&lt;tmp01&gt;[a-zA-Z0-9_+-.,:]+)(:?&amp;(?&lt;tmp10&gt;[a-zA-Z0-9_]+=)(?&lt;tmp11&gt;[a-zA-Z0-9_+-.,:]+))?(:?&amp;(?&lt;tmp20&gt;[a-zA-Z0-9_]+=)(?&lt;tmp21&gt;[a-zA-Z0-9_+-.,:]+))?(:?&amp;(?&lt;tmp30&gt;[a-zA-Z0-9_]+=)(?&lt;tmp31&gt;[a-zA-Z0-9_+-.,:]+))?(:?&amp;(?&lt;tmp40&gt;[a-zA-Z0-9_]+=)(?&lt;tmp41&gt;[a-zA-Z0-9_+-.,:]+))?" "$tmp00'$tmp01' AND $tmp10'$tmp11' AND $tmp20'$tmp21' AND $tmp30'$tmp31' AND $tmp40'$tmp41'"; } #   map $fst0 $fst1 { default ""; "~(?&lt;tmp0&gt;(:?[a-zA-Z0-9_]+='[a-zA-Z0-9_+-.,:]+'(?: AND )?)+)(:?( AND '')++)?" "$tmp0"; } map $fst1 $fst2 { default ""; "~(?&lt;tmp0&gt;[a-zA-Z0-9_+-=,.'' ]+)(?= AND *$)" "$tmp0"; } #   ,  WHERE map $fst2 $fst3 { default ""; "~(?&lt;tmp&gt;.+)" "WHERE $tmp"; } server { location ~/csv/(?&lt;table&gt;result_[a-z0-9]*)/(?&lt;columns&gt;\*|[a-zA-Z0-9,_]+) { pgcopy_query GET db_pub "COPY (select $columns FROM $table $fst3) TO STDOUT WITH DELIMITER ';';"; } }</span></span></code> </pre><br>  With Cyrillic filtering in the URL, via the nginx config, all is not smooth either - we need native conversion from one variable from base64 to another, with human-readable text.  At the moment, there is no such directive.  Which is quite strange, because in the source code for nginx, transcoding functions are present. <br>  As a thread, I will definitely gather my thoughts and liquidate this omission, as well as the problem with sed, if the nginx inc team does not solve this. <br><br>  It would be possible to give the url a string with arguments in the DBMS, for the internal generation of a dynamic query in a direct function call or a call through the table log trigger.  But since such data is already logged in nginx-access.log, these initiatives are redundant.  And given the fact that such actions can increase the load on the base scheduler, they are also harmful. <br><br><h2>  Sm <s>oke</s> all FAQ </h2><br>  <b>- Modules for nginx have been successfully written for a long time.</b>  <b>Why fanfare?</b> <br>  Most of the existing analogues are highly specialized solutions.  The article presents a reasonable compromise of speed and flexibility! <br><br>  <b>- Work through the disk (client_body_in_file_only) - slowly!</b> <br>  Yes, RAM Drive will come with you and its prophet is the file system cache. <br><br>  <b>- What about user rights?</b> <br>  Login with plain http is forwarded to postgres.  There you solve with built-in tools.  In general, a full BackEnd. <br><br>  <b>- What about encryption?</b> <br>  Module ssl through nginx config.  At the current stage, it may not take off due to the ngx_pgcopy code dampness. <br>  Connecting nginx with postgres, when paging servers, paranoids can be thrown through ssh. <br><br>  <b>- Fuck JS symbols in the reflection of the points at the beginning?</b>  <b>Where is javascript?</b> <br>  JS goes to FrontEnd.  And this is a completely different movie. <br><br>  <b>- Is there life on the client with JS disabled?</b> <br>  As you may have noticed earlier, in the examples, Postgres may be in xml.  Those.  getting output HTML is no problem.  Both with the use of spaghetti code, and through the xsl scheme. <br>  <i>It's horrible.</i>  <i>However, everything will be fine.</i>  <i>You do everything right.</i> <br><br>  <b>- How to resize images, pack archivists and read the path of leptons on the GPU?</b> <br><br><img src="https://habrastorage.org/web/1c0/891/fd8/1c0891fd8a804bd7b417b28f50eb779a.jpg"><br><br>  <b>And so that is easier.</b> <br><br>  <i>Maybe I'd better chat with this guy, I thought.</i> <i><br></i>  <i>Do not come to FastCGI!</i> <i><br></i>  <i>They are just waiting for this from us.</i> <i><br></i>  <i>Lure us into this box</i> <i><br></i>  <i>Let go to the basement.</i>  <i>There.</i> <i><br></i> <br>  We say ngix <b>client_body_in_file_only on</b> , take in the armful $ request_body_file and plperlu, with access to the command line.  And adapt that thread from: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> foo(filename <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`/bin/echo -n "hello world!"`</span></span>; $$ LANGUAGE plperlu;</code> </pre><br>  <b>- It looks like a CGI.</b>  <b>And CGI is not safe!</b> <br><br>  Security depends more on your literacy than on the technology used.  Yes.  After screwing in environment variables, this is compatible with CGI.  Moreover, it can be used for a smooth transition from CGI with minimal restructuring of scripts.  Accordingly, the method is suitable for evacuating most PHP solutions. <br><br>  You can also dream up about distributed computing (thanks to clustering PostgreSQL) and the freedom to choose approaches to asynchrony.  But to do this, I certainly will not. <br><br><h2>  Links </h2><br>  ‚Üí <a href="https://github.com/AntonRiab/ngx_pgcopy">ngx_pgcopy</a> <br>  ‚Üí <a href="https://www.postgresql.org/docs/current/static/sql-copy.html">PostgreSQL COPY request</a> <br>  ‚Üí <a href="https://github.com/AntonRiab/slim_middle_samples">slim_middle_samples</a> ( <b>examples from article</b> + build demo) <br><br><h2>  WARRNING </h2><br>  The module is still in development, so stability problems are possible.  In view of the keep alive connection that I had not yet realized towards the backend, this creature, for the time being, is still valid for the role of a supersonic fighter.  Module README to you in reading. <br><br>  Ps.  In fact, CRUD is implemented without any problems through stored procedures, or the log for a method is not applicable to logs.  I also forgot to add the DELETE method to the module. <br><br><hr><br>  The article used frames and quotes from the movie ‚ÄúFear and Loathing in Las Vegas‚Äù 1998.  The materials are used exclusively for non-commercial purposes and as part of the promotion of cultural, educational and scientific development of society. </div><p>Source: <a href="https://habr.com/ru/post/331056/">https://habr.com/ru/post/331056/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331046/index.html">Android Excellence on Google Play</a></li>
<li><a href="../331048/index.html">Go without global variables</a></li>
<li><a href="../331050/index.html">The easiest guide to iconography</a></li>
<li><a href="../331052/index.html">From b2b applications to mass service around the world</a></li>
<li><a href="../331054/index.html">Data Science meetup at Avito office June 24</a></li>
<li><a href="../331058/index.html">First, Storiframes, Then Wireframes</a></li>
<li><a href="../331060/index.html">Typical probability distributions: data scientist cheat sheet</a></li>
<li><a href="../331062/index.html">For IT ishnikov. If you have tired eyes, redness, irritation. Maybe this article is for you.</a></li>
<li><a href="../331064/index.html">RESTful API: we do everything wrong</a></li>
<li><a href="../331066/index.html">Edge computing will replace cloud computing?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>