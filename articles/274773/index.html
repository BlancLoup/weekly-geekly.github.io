<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Steam CEG from Valve and what it eats. Everything is complicated - just</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good hour, % USERNAME% ! In my previous article, " Steam CEG from Valve and what it eats. Introduction, " only an abstract understanding and working p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Steam CEG from Valve and what it eats. Everything is complicated - just</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/55b/f02/837/55bf02837e1a8ccbc11ff9ed772e42a0.gif" alt="image"><br><br>  Good hour, <i>% USERNAME%</i> !  In my previous article, " <i><a href="http://habrahabr.ru/post/274741/">Steam CEG from Valve and what it eats. Introduction,</a></i> " only an abstract understanding and working principles of the CEG technology were given.  This article will be on the absolute minimum theory and the overwhelming majority of the practice.  Today and now we will consider whether it is possible to ‚Äúwean‚Äù the coveted executable file from this protection. <a name="habracut"></a><br><br><h5>  <b>Step I. The choice of the "victim" and its analysis</b> </h5><br>  The presence of a CEG, and any version, can be easily detected by the presence in the header of the <i>.version</i> section <i>file</i> and the first four bytes in it ( <i>78 56 34 12</i> ): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/33c/a77/6fe/33ca776fea853e75e06bf92a63c8c2e5.png" alt="image"><br><br>  Knowing this information knowingly and having slightly searched in the Steam library, my choice fell on HD reissue of the legendary <i><b>Age of Mythology</b></i> with the ‚Äú <a href="http://store.steampowered.com/app/266840/"><i>Extended Edition</i></a> ‚Äù prefix.  After successful completion of the download, after waiting a couple of seconds until CEG signs the executable file, open it in our debugger, in my case in <a href="http://x64dbg.com/">x64dbg</a> .  Oh yeah, it‚Äôs worth noting that Comrade CEG uses some anti-debugging tools, so we‚Äôll use the <a href="">ScyllaHide</a> plugin with the following settings: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3f8/ac6/4ef/3f8ac64efedf6d70ed06158ca1c62691.jpg" alt="image"><br><br>  So, opening the executable file, we see that it is not covered by third-party packers, so we can safely move on to the second step. <br><br><h5>  <b>Step II.</b>  <b>Debriefing</b> </h5><br>  Absolutely in any version of CEG there is one function that produces a general calculation of the desired values.  It looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5f7/a90/939/5f7a9093942c8c07629a7d1147c0e4c6.png" alt="image"><br><br>  Knowing this, set bryak either on instructions. <br> <code>mov eax, dword ptr ds:[ecx] <br></code>  , <br>  either on the following: <br> <code>mov dword ptr ds:[ecx],eax <br></code>  : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f0d/72e/6b4/f0d72e6b4be6b7f359d8427f03a3cd1f.png" alt="image"><br><br>  Press " <i>Run</i> " ( <i>F9</i> ) and see that the breakpoint worked!  ‚ÄúAnd what did it give us?‚Äù - you ask, I answer: the exact value of EAX in the buffer.  This can be seen by looking in the right column opposite the " <i>CPU</i> " tab: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/44b/899/35f/44b89935f9e5aa803d3f8e88f59a9d54.jpg" alt="image"><br><br>  As can be seen from the image, we obtained the value <b>EDB88320</b> .  Copy it to the clipboard and move on.  Press " <i>Step Over</i> " ( <i>F8</i> ) twice and find ourselves inside one of the functions used by CEG.  And at this stage it is worth saying a few words about the existing types of such functions.  Actually, all of them can be three types: <br><br>  <b>1</b> .  <i>Functions with a constant value</i> ( <i>Constant</i> ) - return a constant value, which will always be the same.  Patch like: <br> <code>mov eax, &lt;&gt; ret <br></code>  ; <br>  <b>2</b>  <i>Functions with a random value</i> ( <i>Random</i> ) - return any integer value.  Patch like: <br> <code>mov eax, &lt;&gt; ret <br></code>  ( <i>used only on the latest CEG versions</i> ); <br>  <b>3</b>  <i>Protecting functions</i> ( <i>Protect</i> ) are a pointer that lead to a true function. They are patched as: <br> <code>jmp &lt;&gt; <br></code>  . <br><br>  Now let's go back to our game.  We are inside the desired function and we have the correct value in the buffer.  Now we have to define the look of our function.  Scrolling a couple of instructions down, we will see that the instruction is used. <br> <code>lea eax, dword ptr ds[esi+ebx] <br></code>  : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/867/a8c/0ed/867a8c0edd7c89e76828bfc8ef7b4ee1.png" alt="image"><br><br>  And this can mean only one thing - we are dealing with a function that returns a constant value.  In general, it should be remembered that if values ‚Äã‚Äãlike: <b>EDB88320</b> , <b>60</b> , <b>11</b> , <b>5</b> , <b>3f</b> , etc. appear in the <i>EAX</i> buffer, then it will be immediately clear that the function that uses this value will be constant.  Why?  Because these are ‚Äúwell-known‚Äù constant CEG values, they will be the <u>same</u> on any version of CEG.  Therefore, we move to the very beginning of the function and adjust it, changing it to <br> <code>mov eax, EDB88320 <br> ret <br></code>  : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/379/840/136/3798401364ea768059c29695c63f9429.png" alt="image"><br><br>  So what next?  And then we repeat everything again (of course, having the same breakpoint on the function that calculates the values) until the game starts (Profit!), Which means that we passed all the CEG checks.  Everything ?!  Well, let's see.  Save the file with the done patches and try to run it on another PC (to which the game was already knowingly downloaded).  And then ... bummer.  The game does not want to run!  Oh yeah, we forgot about one more important detail!  The fact is that CEG, as mentioned in the first article, uses so-called file checks.  Opening the debugger again, we can easily detect these checks by the presence of the characteristic features of the wonderful <i>WinAPI</i> : <i><b>GetFileInformationByHandle</b></i> , <b><i>CreateFileW</i></b> , <b><i>OpenFileById</i></b> , <b><i>StringFromGUID2</i></b> , <b><i>RegOpenKeyExW</i></b> , <b><i>SystemFunction036</i></b> and <b><i>lstrcmpiW</i></b> .  In our game there is only one such check, you can find it immediately by driving <i>GetFileInformationByHandle</i> into the search for " <i>References</i> ": <br><br><img src="https://habrastorage.org/getpro/habr/post_images/890/76d/c8c/89076dc8c29ab1c8a0e6fedb8c3f9494.png" alt="image"><br><br>  Go to the beginning and look for the function that calls this check ( <i>right click -&gt; Find references -&gt; To Selected Address (es)</i> , or use the keyboard shortcut <i>CTRL + R</i> ).  It will look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/518/3b8/cc6/5183b8cc6f32bee2fcf977e51fd940c6.png" alt="image"><br><br>  Well, let's do it!  Although this can be done in a more sophisticated way, we will proceed more simply by using <br> <code>mov eax, 1 ret <br></code> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b23/1c4/a71/b231c4a712a1b820e961ad5a4b7784b2.png" alt="image"><br><br>  Saving the result of the work done and testing the second time and oh Gods, the game started on another Steam account and on another PC! <br><br><h5>  <b>Step III.</b>  <b>Full decoupling of the game from Steam (Yarr! Edition)</b> </h5><br>  Of course, after the pleasure, I wanted more extreme sports.  And what if I just want to play with a friend on LAN without any Steam there as in bearded times?  Well, no question.  To do this, I downloaded a great Steam emulator with partial support for the overlay (!) Called <a href="http://cs.rin.ru/forum/viewtopic.php%3Ff%3D29%26t%3D62935">SmartSteamEmu</a> .  Having set it up, I launched the game without Steam enabled.  And what I see is that a <i>* .STEAMSTART</i> file was created and the game hung in the processes.  Thinking about thirty seconds, the game still started and worked properly.  But why?  We kind of did everything, right?  Yes, it is, but we forgot about one little touch.  The fact is that this event file is created when the Steam process is not running and is essentially the last micro-check.  Well, open the debugger for the third time and look for all the functions with <i>CreateFileA</i> .  Feel free to set breakpoints on all functions (in this case there are only two).  When starting the game, the breakpoint worked: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6a3/4b9/d1e/6a34b9d1e9413ed440844dd552d95eb2.png" alt="image"><br><br>  <i>STEAMSTART</i> , we see you!  So, in order to end this misunderstanding, simply change the top JE to JNZ or JMP: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ed9/7f6/cb8/ed97f6cb86328c5758c5ee1ed6e957f0.png" alt="image"><br><br>  Save the patch, try again to run the game without Steam, <s>fingers crossed</s> .  And voila - the game started in seconds!  We did this to you, <i>CEG</i> , forgive us. <br><br><h5>  <b>Actually, the conclusion</b> </h5><br>  Any CEG in <i>Age of Mythology: Extended Edition</i> was easy.  In this game, there was no <i>Protect</i> or <i>Random</i> functions, only one <i>Constant</i> , which greatly simplified the task.  Also in this game there were no minor checks, in the form of good old <i>CRC</i> or the latest checks <i>ID of the processor</i> or the <i>serial number of the hard disk</i> . <br>  In the future, I hope, I will be able to master these two new checks and write a new article, but for now - see you soon! </div><p>Source: <a href="https://habr.com/ru/post/274773/">https://habr.com/ru/post/274773/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274759/index.html">Well tuned emacs</a></li>
<li><a href="../27476/index.html">Microsoft Remote Desktop Connection Client for Mac.</a></li>
<li><a href="../274765/index.html">Software Internet gateway for not a small company (Shorewall, buns). Part 4</a></li>
<li><a href="../274767/index.html">ProDBG switches to Rust</a></li>
<li><a href="../274771/index.html">Details of the test-first, which is so lacking</a></li>
<li><a href="../274775/index.html">Automatically launching Libre / OpenOffice in listening mode from Python</a></li>
<li><a href="../274779/index.html">Work with PGP digital signatures using the Bouncy Castle Cryptography Library in Java</a></li>
<li><a href="../27478/index.html">Slax - pocket operating system</a></li>
<li><a href="../274781/index.html">IBM gives developers access to a number of their services, helping to combat cybercrime</a></li>
<li><a href="../274783/index.html">Microsoft stops supporting Windows 8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>