<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Performance tuning and troubleshooting databases these days</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unfortunately, now the role of specialists in performance tuning and troubleshooting of databases is cut only to the last ‚Äî troubleshooting'a: almost ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Performance tuning and troubleshooting databases these days</h1><div class="post__text post__text-html js-mediator-article">  Unfortunately, now the role of specialists in performance tuning and troubleshooting of databases is cut only to the last ‚Äî troubleshooting'a: almost always, specialists are turned to only when problems have reached a critical point, and they need to be solved ‚Äújust yesterday‚Äù.  And even that is good if they address, but do not delay the problem by buying an even more expensive and powerful hardware without a detailed performance audit and load tests.  After all, quite often there are disappointments: purchased equipment worth 2-5 times more expensive, and only 30-40% won in performance, the entire increase from which in a few months is eaten either by an increase in the number of users, or by exponential growth of data, coupled with the complication of logic. <br><br>  And now, at a time when the number of architects, testers and DevOps engineers is actively growing, while Java Core developers are optimizing even work <a href="https://www.infoq.com/news/2016/02/compact-strings-Java-JDK9">with strings</a> , it is time for database optimizers to come slowly but surely.  With each release, DBMS become so smarter and more complicated that the study of both documented and undocumented nuances and optimizations requires a huge amount of time.  A huge number of articles are published every month and major Oracle conferences are held.  Sorry for the banal analogy, but in this situation, when database administrators become similar to the pilots of airplanes with countless toggle switches, buttons, light bulbs and screens, it is already indecent to load them with the subtleties of performance optimization. <br><a name="habracut"></a><br>  Of course, DBAs, like pilots, in most cases can quite easily solve obvious and simple problems when they are either easily diagnosable or visible in various ‚Äútops‚Äù (Top events, top SQL, top segments ...).  And that is easy to find in MOS or Google, even if they do not know the solution.  It is much more difficult when even the symptoms are hidden behind the complexity of the system and need to be extracted among the vast amount of diagnostic information collected by the Oracle DBMS itself. <br><br>  One of the simplest and most striking examples of this is the analysis of filter and access predictions: in large and loaded systems, it is often the case that such a problem is easily overlooked.  the load is fairly evenly spread over different requests (with joins on different tables, with slight differences in conditions, etc.), and the top segments do not show anything special, they say, "well, yes, these tables need data most often and more of them" .  In such cases, you can start the analysis with the statistics from SYS.COL_USAGE $: <a href="">col_usage.sql</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs">col owner format a30 col oname format a30 heading "Object name" col cname format a30 heading "Column name" accept owner_mask prompt "Enter owner mask: "; accept tab_name prompt "Enter tab_name mask: "; accept col_name prompt "Enter col_name mask: "; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> a.username <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> owner ,o.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> oname ,c.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> cname ,u.equality_preds <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> equality_preds ,u.equijoin_preds <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> equijoin_preds ,u.nonequijoin_preds <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> nonequijoin_preds ,u.range_preds <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> range_preds ,u.like_preds <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> like_preds ,u.null_preds <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> null_preds ,to_char(u.timestamp, <span class="hljs-string"><span class="hljs-string">'yyyy-mm-dd hh24:mi:ss'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.col_usage$ u , sys.obj$ o , sys.col$ c , all_users a <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> a.user_id = o.owner<span class="hljs-comment"><span class="hljs-comment"># AND u.obj# = o.obj# AND u.obj# = c.obj# AND u.intcol# = c.col# AND a.username like upper('&amp;owner_mask') AND o.name like upper('&amp;tab_name') AND c.name like upper('&amp;col_name') ORDER BY a.username, o.name, c.name ; col owner clear; col oname clear; col cname clear; undef tab_name col_name owner_mask;</span></span></code> </pre> <br>  However, for the full analysis of this information is not enough, because  it does not show combinations of predicates.  In this case, an analysis of v $ active_session_history and v $ sql_plan can help us: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> ash <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sql_id ,plan_hash_value ,table_name ,<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> ,ACCESS_PREDICATES ,FILTER_PREDICATES ,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) cnt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> h.sql_id ,h.SQL_PLAN_HASH_VALUE plan_hash_value ,<span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(p.OPERATION ,<span class="hljs-string"><span class="hljs-string">'TABLE ACCESS'</span></span>,p.OBJECT_OWNER||<span class="hljs-string"><span class="hljs-string">'.'</span></span>||p.OBJECT_NAME ,(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> i.TABLE_OWNER||<span class="hljs-string"><span class="hljs-string">'.'</span></span>||i.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dba_indexes i <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> i.OWNER=p.OBJECT_OWNER <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> i.index_name=p.OBJECT_NAME) ) table_name ,OBJECT_ALIAS <span class="hljs-keyword"><span class="hljs-keyword">ALIAS</span></span> ,p.ACCESS_PREDICATES ,p.FILTER_PREDICATES <span class="hljs-comment"><span class="hljs-comment">-- ,         : -- ,h.sql_plan_operation -- ,h.sql_plan_options -- ,decode(h.session_state,'ON CPU','ON CPU',h.event) event -- ,h.current_obj# from v$active_session_history h ,v$sql_plan p where h.sql_opname='SELECT' and h.IN_SQL_EXECUTION='Y' and h.sql_plan_operation in ('INDEX','TABLE ACCESS') and p.SQL_ID = h.sql_id and p.CHILD_NUMBER = h.SQL_CHILD_NUMBER and p.ID = h.SQL_PLAN_LINE_ID --     3 : -- and h.sample_time &gt;= systimestamp - interval '3' hour ) --       : -- where table_name='&amp;OWNER.&amp;TABNAME' group by sql_id ,plan_hash_value ,table_name ,alias ,ACCESS_PREDICATES ,FILTER_PREDICATES ) ,agg_by_alias as ( select table_name ,regexp_substr(ALIAS,'^[^@]+') ALIAS ,listagg(ACCESS_PREDICATES,' ') within group(order by ACCESS_PREDICATES) ACCESS_PREDICATES ,listagg(FILTER_PREDICATES,' ') within group(order by FILTER_PREDICATES) FILTER_PREDICATES ,sum(cnt) cnt from ash group by sql_id ,plan_hash_value ,table_name ,alias ) ,agg as ( select table_name ,'ALIAS' alias ,replace(access_predicates,'"'||alias||'".','"ALIAS".') access_predicates ,replace(filter_predicates,'"'||alias||'".','"ALIAS".') filter_predicates ,sum(cnt) cnt from agg_by_alias group by table_name ,replace(access_predicates,'"'||alias||'".','"ALIAS".') ,replace(filter_predicates,'"'||alias||'".','"ALIAS".') ) ,cols as ( select table_name ,cols ,access_predicates ,filter_predicates ,sum(cnt)over(partition by table_name,cols) total_by_cols ,cnt from agg ,xmltable( 'string-join(for $c in /ROWSET/ROW/COL order by $c return $c,",")' passing xmltype( cursor( (select distinct nvl( regexp_substr( access_predicates||' '||filter_predicates ,'("'||alias||'"\.|[^.]|^)"([A-Z0-9#_$]+)"([^.]|$)' ,1 ,level ,'i',2 ),' ') col from dual connect by level&lt;=regexp_count( access_predicates||' '||filter_predicates ,'("'||alias||'"\.|[^.]|^)"([A-Z0-9#_$]+)"([^.]|$)' ) ) )) columns cols varchar2(400) path '.' )(+) order by total_by_cols desc, table_name, cnt desc ) select table_name ,cols ,sum(cnt)over(partition by table_name,cols) total_by_cols ,access_predicates ,filter_predicates ,cnt from cols where rownum&lt;=50 order by total_by_cols desc, table_name, cnt desc;</span></span></code> </pre><br>  As can be seen from the query itself, it displays the top 50 search columns and the predicates themselves by the number of times ASH hits in the last 3 hours.  Despite the fact that ASH stores only every second snapshots, the sample on the loaded bases is very representative.  There are several points to clarify: <br><br><ul><li>  The cols field displays the search columns themselves, and total_by_cols shows the sum of entries in the context of these columns. </li><li>  I think it is quite obvious that this information is in itself an insufficient problem marker, since  for example, several one-time fulkans can easily spoil the statistics, so you will have to consider the queries themselves and their frequency (v $ sqlstats, dba_hist_sqlstat) </li><li>  Grouping by OBJECT_ALIAS within SQL_ID, plan_hash_value is important for combining index and table predicates by object, since  when accessing a table via an index, the predicates will be split into different lines of the plan: <br><img src="https://habrastorage.org/webt/ww/p8/uo/wwp8uovm0hfvpyn5_2n0srldszs.png" alt="image"><br></li></ul><br>  Depending on the need, this script can be easily modified to collect additional information in other sections, for example, taking into account sectioning or expectations.  And having already analyzed this information together with the analysis of the statistics of the table and its indices, the general data scheme and business logic, you can pass recommendations to developers or architects for choosing a solution, for example: options for denormalizing or changing the partitioning scheme or indexes. <br><br>  It is also quite often forgotten to analyze SQL * net traffic, and there are also many subtleties, for example: fetch-size, SQLNET.COMPRESSION, extended datatypes, which allow reducing the number of roundtripes, etc., but this is a topic for a separate article. <br><br>  In conclusion, I would like to say that now that users are becoming less tolerant of delays, performance optimization is becoming a competitive advantage. </div><p>Source: <a href="https://habr.com/ru/post/451676/">https://habr.com/ru/post/451676/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451640/index.html">"Game of Thrones": building an infographic about murders, sex, traveling around V√§ster√•s and much more</a></li>
<li><a href="../451650/index.html">Part I. Ask your mother: How to communicate with customers and confirm the correctness of their business ideas, if everyone is lying around?</a></li>
<li><a href="../451658/index.html">Non fiction. What to read?</a></li>
<li><a href="../451666/index.html">We do the countdown timer in Google tables</a></li>
<li><a href="../451668/index.html">ACPI: Adding devices without recompiling the kernel</a></li>
<li><a href="../45168/index.html">How I bought a laptop on ebay.</a></li>
<li><a href="../451688/index.html">From programmer to businessmen</a></li>
<li><a href="../45169/index.html">Search music q00p</a></li>
<li><a href="../451690/index.html">Reading for owls</a></li>
<li><a href="../451694/index.html">‚ÄúPay attention‚Äù # 4: Digest of articles on grocery thinking, behavioral psychology and productivity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>