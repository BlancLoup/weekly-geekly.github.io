<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How strong is the friendship between Java and C inside Dalvik VM?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I tried to describe in great detail my steps when exploring android code and its execution in Dalvik VM. I was very interested to know...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How strong is the friendship between Java and C inside Dalvik VM?</h1><div class="post__text post__text-html js-mediator-article"><img src="http://img151.imageshack.us/img151/2696/shoveln.png" align="right">  In this article I tried to describe in great detail my steps when exploring android code and its execution in Dalvik VM.  I was very interested to know the answers to the questions: <br><br><ul><li>  How does the code generated by C look like?  (from the position of ARM) </li><li>  What does the code generated by java look like? </li><li>  How and where does the code run? </li></ul><br>  Therefore, this article is divided into 3 parts. <br><br>  It seems to me to pose such questions and study them - an important point in the subsequent writing of the code, because the android has already stepped on its heels and not knowing it as well as one of its favorite tools (for example C) is no longer correct. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  Before that, I practically didn‚Äôt analyze virtual machines, and now I‚Äôm interested in Dalvik VM.  Therefore, the entire description will be related to this VM and you can observe my narration, the course of which changes several times. <br><br><h4>  Introduction </h4><br>  In order to understand this article, you need to have a basic knowledge of assembly language for ARM architecture.  The article provides little information to understand this, but it emphasizes that the reader does not know.  Therefore, there are many explanations in your own words, but no more. <br><br>  It is also necessary that you have the skills to create android applications from scratch (they knew the directory structure and the main files). <br><br>  You can also look at the results of each article and see if you should read it. <br><br>  All 3 parts are very different load, about equal strength.  For example, when you go to the 3rd part, it may seem to you that it is as much more complicated than the 2nd as compared to the first.  So please be careful if you do not own the subject, at the end the load can be large. <br><br><h5>  Who will be interested in the article </h5><br>  Only for adventurers. <br><br>  A good developer, if he doesn‚Äôt know this, will easily find out (I hope my understanding of a good developer is not much overestimated), but the one who wants to start something and try, but does not know how, it will be very difficult for him. <br><br>  I wanted to show that to ask myself questions and find answers to them in such a dense forest as Dalvik VM, more than real and I want to show this path to anyone who decides on the same audacious act. <br><br><h5>  Original purpose </h5><br>  My main task is to compare the C code: <br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre> <br><br>  With the same Java code: <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Summator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">staticSum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } }</code> </pre><br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NativeSummator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">staticSum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span></span>; }</code> </pre><br><br>  I have my own assumptions, but I really want to see how it really happens. <br><br><h5>  Preparatory knowledge </h5><br>  I will remind here how integration with a code in Java, through JNI approximately looks. <br><br>  In order to use an external (native) function in Java code, the native keyword is used: <br><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.m039.study; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Summator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span></span>; }</code> </pre> <br><br>  In this case, the C code should look like: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_m039_study_Summator_sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv* env, jobject thiz, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre> <br><br>  In order for Java to see a function, it must be composed according to certain rules (given from memory): <br><ul><li>  name starts with java </li><li>  contains the path to: module + class name + function name </li><li>  Two additional arguments are passed to the function: a pointer to the environment and a structure to the object or class (if the method is static) </li></ul><br><br>  To compile, use the <code>ndk-build</code> .  This command expects C (or C ++) files to be in the ./jni directory.  The catalog must contain the Android.mk file and may be Application.mk. <br><br>  After compilation, the library libNAME.so will be created in the directory ./libs/armebi, where armebi may differ. <br><br>  You will have to refer to another document if you need more detailed steps.  You can look at the catalog of <a href="http://android.git.kernel.org/%3Fp%3Dplatform/ndk.git%3Ba%3Dtree%3Bf%3Ddocs%3Bh%3D529dcbea56edf85028aed8c46ce6e03a0ba1718e%3Bhb%3DHEAD">documentation</a> and examples attached to the <a href="http://developer.android.com/sdk/ndk/overview.html">NDK</a> . <br><br><h4>  Part I. What does the code generated by C look like? </h4><br>  Question: What exactly does the C code do? <br><br>  In principle, this is understandable, but how does it look from the point of view of the ARM architecture, since  almost all mobile devices now use this particular architecture? <br><br>  To understand this, you need to understand how C code looks in assembly (raw) form. <br><br><h5>  Disassemble </h5><br>  The main issue is the interaction between C and Java, based on this, chose 5 examples: <br><br>  1. Standard: <br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre><br><br>  2. Binding through JNI (non-static): <br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_m039_study_Summator_sum</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JNIEnv* env, jobject thiz, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre><br><br>  3. Binding via JNI (static): <br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_m039_study_StaticSummator_sum</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JNIEnv* env, jclass thiz, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre><br><br>  4. Binding through JNI (not static, through function): <br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_m039_study_Summator_sum</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JNIEnv* env, jobject thiz, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum(a, b); }</code> </pre><br><br>  5. Binding through JNI (staic, through function): <br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_m039_study_StaticSummator_sum</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JNIEnv* env, jclass thiz, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum(a, b); }</code> </pre><br><br>  We will think a little.  It seems to me 4 and 5 are almost alike, if not to say completely.  A 1-3 should be different transmitted parameters.  This is what I would like to check. <br><br><h6>  Assembly system </h6><br>  The system for assembling android applications is extremely simplified, and for such purposes as checking compiled code for android you need to know the compilation flags.  Especially the optimization flag. <br><br>  In the Application.mk file, you can change the <code>APP_OPTIM</code> variable and assign it one of two values: release or debug. <br><br>  Because  the purpose of this article is to compare the integration of two languages, and not to understand one well, then for simplicity, I will use the value of 'debug'.  This will probably give a better understanding and less chance of an error (which will give more chances to write this article), but still, then you need to see how much the code in the 'release' mode differs. <br><br>  Now a little more in detail. <br><br>  The <a href="http://android.git.kernel.org/%3Fp%3Dplatform/ndk.git%3Ba%3Dblob%3Bf%3Ddocs/APPLICATION-MK.html%3Bh%3De569716e1ef7b530b4c6d8fddafc890fedeca2ae%3Bhb%3DHEAD">APPLICATION-MK.html file</a> describes what the <code>APP_OPTIM</code> flag <code>APP_OPTIM</code> , it also indicates that you can change the attribute in the <a href="http://developer.android.com/guide/topics/manifest/application-element.html">application</a> tag to <code>android:debuggable="true"</code> and the variable <code>APP_OPTIM</code> assigned the value 'debug'.  If the attribute is set to "false", then <code>APP_OPTIM</code> assigned a 'release'. <br><br>  Therefore, in the future it is assumed that the AndroidManifest.xml attribute is set to <code>android:debuggable</code> to ‚Äútrue‚Äù. <br><br>  And we cannot miss the moment, which values ‚Äã‚Äãwill be transferred to the compiler, when using the variable <code>APP_OPTIM</code> , this can be seen below, in the same <a href="http://android.git.kernel.org/%3Fp%3Dplatform/ndk.git%3Ba%3Dblob%3Bf%3Dbuild/core/add-application.mk%3Bh%3D70c133e40a3084afb6696c42ebd687eb21245324%3Bhb%3DHEAD">file</a> : <br><br><pre> <code class="bash hljs">ifeq ($(APP_OPTIM),debug) APP_CFLAGS := -O0 -g $(APP_CFLAGS) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> APP_CFLAGS := -O2 -DNDEBUG -g $(APP_CFLAGS) endif</code> </pre><br><br>  Now attack to consider all 5 options. <br><br><h5>  In 'debug' mode </h5><br>  <i>Note</i> : all listings were received by the command <code>arm-linux-androideabi-objdump -d "  "</code> <br><br><h6>  Option 1 </h6><br><pre> <code class="hljs css">00000804 &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">sum</span></span>&gt;: 804: <span class="hljs-selector-tag"><span class="hljs-selector-tag">b082</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#8</span></span> 806: 9001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #4]</span></span> 808: 9100 <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #0]</span></span> 80<span class="hljs-selector-tag"><span class="hljs-selector-tag">a</span></span>: 9<span class="hljs-selector-tag"><span class="hljs-selector-tag">a01</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #4]</span></span> 80<span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span>: 9<span class="hljs-selector-tag"><span class="hljs-selector-tag">b00</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #0]</span></span> 80<span class="hljs-selector-tag"><span class="hljs-selector-tag">e</span></span>: 18<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">adds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span> 810: 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">c18</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">adds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#0</span></span> 812: <span class="hljs-selector-tag"><span class="hljs-selector-tag">b002</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#8</span></span> 814: 4770 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lr</span></span> 816: 46<span class="hljs-selector-tag"><span class="hljs-selector-tag">c0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nop</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span>)</code> </pre><br><br>  In this listing, a lot of superfluous, and all because of the calling agreement, and more specifically the <a href="http://en.wikipedia.org/wiki/Calling_convention">ARM calling convention</a> . <br><br>  I translate this example: <br>  - 04: reserves memory for 2 local variables. <br>  - 06-08: saves the arguments passed to the function. <br>  - 0a-0c: the same arguments are passed to other registers r2 and r3, respectively. <br>  - 0e: equivalent to r3 = r2 + r3 <br>  - 10: save result to register r0 <br>  - 12: return the stack pointer to the initial state <br>  - 14: returns where you came from <br>  - 16: align the function in the file using the nop command <br><br>  <i>Update</i> : I was not clear 2 points: the suffix s and the bx command.  The first means that the status flag will also be updated during execution.  The second is a thumb command, which is equivalent to the command bl. <br><br>  After the code was chewed, it became clear that a lot and a lot of excess.  Of course, if you use optimization, there was nothing like that. <br><br>  In this listing, only 2 points should be noted, how the arguments are passed to the function and how the main part is executed. <br><br>  Arguments are passed through registers, the main part contain only one command.  From here it was possible to make that the code <code>adds r0, r1, r2; bx lr</code>  <code>adds r0, r1, r2; bx lr</code> has the right to exist. <br><br>  But again, you can‚Äôt say that such code will be in the finished application (unless someone decides to release a debug version to the market).  And while there is an assumption that Java is still worse and I want to check it out.  Therefore, we must quickly go through the remaining listings. <br><br><h6>  Option 2 </h6><br><pre> <code class="hljs css">000007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ec</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">Java_com_m039_study_Summator_sum</span></span>&gt;: 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">ec</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">b084</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#16</span></span> 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">ee</span></span>: 9003 <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #12]</span></span> 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">f0</span></span>: 9102 <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #8]</span></span> 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">f2</span></span>: 9201 <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #4]</span></span> 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">f4</span></span>: 9300 <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #0]</span></span> 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">f6</span></span>: 9<span class="hljs-selector-tag"><span class="hljs-selector-tag">a01</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #4]</span></span> 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">f8</span></span>: 9<span class="hljs-selector-tag"><span class="hljs-selector-tag">b00</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #0]</span></span> 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">fa</span></span>: 18<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">adds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span> 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">fc</span></span>: 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">c18</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">adds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#0</span></span> 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">b004</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#16</span></span> 800: 4770 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lr</span></span> 802: 46<span class="hljs-selector-tag"><span class="hljs-selector-tag">c0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nop</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span>)</code> </pre><br><br>  Yes, the same thing as it was supposed, only the number of arguments increased and only.  And how many extra operations, horror.  But while the desire to see an optimized version becomes much more. <br><br>  <i>Note</i> : while the assumption is confirmed that using many JNI functions (to which redundant arguments are passed) is worse than using simple functions (to which fewer arguments are simply passed).  (Now, when rewriting this article, this statement sounds very naive) <br><br><h6>  Option 3 </h6><br><pre> <code class="hljs css">00000850 &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">Java_com_m039_study_StaticSummator_sum</span></span>&gt;: 850: <span class="hljs-selector-tag"><span class="hljs-selector-tag">b084</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#16</span></span> 852: 9003 <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #12]</span></span> 854: 9102 <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #8]</span></span> 856: 9201 <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #4]</span></span> 858: 9300 <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #0]</span></span> 85<span class="hljs-selector-tag"><span class="hljs-selector-tag">a</span></span>: 9<span class="hljs-selector-tag"><span class="hljs-selector-tag">a01</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #4]</span></span> 85<span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span>: 9<span class="hljs-selector-tag"><span class="hljs-selector-tag">b00</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[sp, #0]</span></span> 85<span class="hljs-selector-tag"><span class="hljs-selector-tag">e</span></span>: 18<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">adds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span> 860: 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">c18</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">adds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#0</span></span> 862: <span class="hljs-selector-tag"><span class="hljs-selector-tag">b004</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#16</span></span> 864: 4770 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lr</span></span> 866: 46<span class="hljs-selector-tag"><span class="hljs-selector-tag">c0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nop</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span>)</code> </pre><br><br>  The assumption was justified, the code is identical to option 2. <br><br><h6>  Option 4 </h6><br><pre> <code class="hljs delphi"><span class="hljs-number"><span class="hljs-number">000008</span></span>e0 &lt;Java_com_m039_study_Summator_sum&gt;: <span class="hljs-number"><span class="hljs-number">8</span></span>e0: b500 push <span class="hljs-comment"><span class="hljs-comment">{lr}</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>e2: b085 sub sp, <span class="hljs-string"><span class="hljs-string">#20</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>e4: <span class="hljs-number"><span class="hljs-number">9003</span></span> str r0, [sp, <span class="hljs-string"><span class="hljs-string">#12</span></span>] <span class="hljs-number"><span class="hljs-number">8</span></span>e6: <span class="hljs-number"><span class="hljs-number">9102</span></span> str r1, [sp, <span class="hljs-string"><span class="hljs-string">#8</span></span>] <span class="hljs-number"><span class="hljs-number">8</span></span>e8: <span class="hljs-number"><span class="hljs-number">9201</span></span> str r2, [sp, <span class="hljs-string"><span class="hljs-string">#4</span></span>] <span class="hljs-number"><span class="hljs-number">8</span></span>ea: <span class="hljs-number"><span class="hljs-number">9300</span></span> str r3, [sp, <span class="hljs-string"><span class="hljs-string">#0</span></span>] <span class="hljs-number"><span class="hljs-number">8</span></span>ec: <span class="hljs-number"><span class="hljs-number">9</span></span>a01 ldr r2, [sp, <span class="hljs-string"><span class="hljs-string">#4</span></span>] <span class="hljs-number"><span class="hljs-number">8</span></span>ee: <span class="hljs-number"><span class="hljs-number">9</span></span>b00 ldr r3, [sp, <span class="hljs-string"><span class="hljs-string">#0</span></span>] <span class="hljs-number"><span class="hljs-number">8</span></span>f0: <span class="hljs-number"><span class="hljs-number">1</span></span>c10 adds r0, r2, <span class="hljs-string"><span class="hljs-string">#0</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>f2: <span class="hljs-number"><span class="hljs-number">1</span></span>c19 adds r1, r3, <span class="hljs-string"><span class="hljs-string">#0</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>f4: f7ff ffde bl <span class="hljs-number"><span class="hljs-number">8</span></span>b4 &lt;sum&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>f8: <span class="hljs-number"><span class="hljs-number">1</span></span>c03 adds r3, r0, <span class="hljs-string"><span class="hljs-string">#0</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>fa: <span class="hljs-number"><span class="hljs-number">1</span></span>c18 adds r0, r3, <span class="hljs-string"><span class="hljs-string">#0</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>fc: b005 add sp, <span class="hljs-string"><span class="hljs-string">#20</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>fe: bd00 pop <span class="hljs-comment"><span class="hljs-comment">{pc}</span></span></code> </pre><br><br>  Why do you still need to consider this option?  In the event that it seemed that it was better to write everything in JNI functions.  Whereas in fact, it is better to use JNI as a wrapper for more complex constructions.  But in small C functions you can do whatever you want.  ( <i>Note</i> : after writing this article this statement already seems obvious to me) <br><br>  This code is a bit more complicated: <br>  - e0: saves return address <br>  - e2: reserves memory for local variables <br>  - e4-ea: saves arguments to local variables <br>  - ec-ee: takes the value of local variables <br>  - f0-f2: prepares the register value for the function call <br>  - f4: function call itself <br>  - f8-fa: saves the result to the register, and then writes it to the register for the return value <br>  - fc: returns the stack pointer to the initial position <br>  - fe: moves to where they called from <br><br>  The string 'e0', is used to save the return address, taking into account that the register lr will be rewritten via the instruction bl. <br><br>  As you can see, there are a lot of extra code.  I suppose that such a code has the right to exist: <br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">push</span></span> <span class="hljs-string"><span class="hljs-string">{lr}</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp</span></span></span><span class="hljs-function">, #20 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adds</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r0</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r2</span></span></span><span class="hljs-function">, #0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adds</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r3</span></span></span><span class="hljs-function">, #0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bl</span></span></span><span class="hljs-function"> 8</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b4</span></span></span><span class="hljs-function"> &lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp</span></span></span><span class="hljs-function">, #20 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pop</span></span></span><span class="hljs-function"> </span></span>{pc}</code> </pre><br><br><h6>  Option 5 </h6><br>  I think it should not be considered. <br><br><h5>  In 'release' mode </h5><br>  I'd like to check my guesses about which code will be in an optimized version. <br><h6>  Option 1 </h6><br><pre> <code class="hljs xml">0000894 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sum</span></span></span><span class="hljs-tag">&gt;</span></span>: 894: 1808 adds r0, r1, r0 896: 4770 bx lr</code> </pre><br><h6>  Option 2 </h6><br><pre> <code class="hljs xml">00000890 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Java_com_m039_study_Summator_sum</span></span></span><span class="hljs-tag">&gt;</span></span>: 890: 1898 adds r0, r3, r2 892: 4770 bx lr</code> </pre><br><h6>  Option 3 </h6><br><pre> <code class="hljs xml">00000898 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Java_com_m039_study_StaticSummator_SUM</span></span></span><span class="hljs-tag">&gt;</span></span>: 898: 1898 adds r0, r3, r2 89a: 4770 bx lr</code> </pre><br><h6>  Option 4 </h6><br><pre> <code class="hljs objectivec"><span class="hljs-number"><span class="hljs-number">0000089</span></span>c &lt;Java_com_m039_study_Summator_SUM3&gt;: <span class="hljs-number"><span class="hljs-number">89</span></span>c: b510 push {r4, lr} <span class="hljs-number"><span class="hljs-number">89</span></span>e: <span class="hljs-number"><span class="hljs-number">1</span></span>c10 adds r0, r2, <span class="hljs-meta"><span class="hljs-meta">#0 8a0: 1c19 adds r1, r3, #0 8a2: f7ff fff7 bl 894 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sum&gt;</span></span></span><span class="hljs-meta"> 8a6: bd10 pop {r4, pc}</span></span></code> </pre><br><h6>  Impression </h6><br>  I'm a little surprised and no.  Everything that was supposed before coincided.  The optimized code is good, very close to the one that I tried to write above myself. <br><br><h5>  Part I. Summary </h5><br>  This part will probably introduce you to the ARM assembler.  You may want to analyze other language constructs and understand them.  Maybe you will also be surprised at your guesses. <br><br>  But most importantly, if you are an android developer, then now it has become clear how the default compilation settings are used and where to look when you need it. <br><br>  I was initially interested to know how much C code would be better than Java code.  I first wrote an article, but I‚Äôm writing this result later.  I can say that for now you can pay attention to how elegantly it turns out to solve the problem in the C language and how compact it turned out to be in disassembler form.  In Java opcodes, this is also noticeable, but less so.  And in the 3rd article, where opcodes are mixed with C, this is almost gone. <br><br>  And now, just, a little about Java opcodes. <br><br><h4>  Part II.  What does the code generated by java look like? </h4><br>  First you need to understand how the JVM, or rather Dalvik VM.  To do this, you must disassemble the * .dex file, which is the bytecode file for Dalvik VM. <br><br>  What will the Summator class look like (see original goal)?  To do this, add the program <code>dexdump -d classes.dex</code> .  What the command issued: <br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#5 : (in Lcom/m039/study/Summator;) name : 'sum' type : '(II)I' access : 0x0000 () code - registers : 4 ins : 3 outs : 0 insns size : 3 16-bit code units 00226c: |[00226c] com.m039.study.Summator.sum:(II)I 00227c: 9000 0203 |0000: add-int v0, v2, v3 002280: 0f00 |0002: return v0 catches : (none) positions : 0x0000 line=73 locals : 0x0000 - 0x0003 reg=1 this com/m039/study/Summator; 0x0000 - 0x0003 reg=2 a I 0x0000 - 0x0003 reg=3 b I</span></span></code> </pre><br><br><pre> <code class="bash hljs"> name : <span class="hljs-string"><span class="hljs-string">'staticSum'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> : <span class="hljs-string"><span class="hljs-string">'(II)I'</span></span> access : 0x0008 (STATIC) code - registers : 3 ins : 2 outs : 0 insns size : 3 16-bit code units 002100: |[002100] com.m039.study.Summator.staticSum:(II)I 002110: 9000 0102 |0000: add-int v0, v1, v2 002114: 0f00 |0002: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> v0 catches : (none) positions : 0x0000 line=77 locals : 0x0000 - 0x0003 reg=1 a I 0x0000 - 0x0003 reg=2 b I</code> </pre><br><br>  Here you need to see the <code>add-int v0, v1, v2</code> and the opcode value '9000 0102'.  Now you can go to what these opcodes look like from the inside. <br><br><h5>  What opkody watch? </h5><br>  I'm more interested in the ARM architecture, and because  This architecture is used by default, then opcodes will be appropriate.  But there are a lot of ARMs, which is used by default? <br><br>  To do this, refer to the document Application.mk, and more specifically to the description of the variable <a href="http://android.git.kernel.org/%3Fp%3Dplatform/ndk.git%3Ba%3Dblob%3Bf%3Ddocs/APPLICATION-MK.html%3Bh%3De569716e1ef7b530b4c6d8fddafc890fedeca2ae%3Bhb%3DHEAD">APP_ABI</a> .  It indicates that armv5te is used by default.  So we will explore it! <br><br><h5>  Where to start watching? </h5><br>  The opcodes themselves are in the <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dtree%3Bf%3Dvm/mterp/armv5te%3Bhb%3DHEAD">armv5te</a> directory.  It would be correct to consider the files that are in this directory, but I wanted to do it in a not quite correct way, but it also works - to consider already generated files.  Or rather file <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">InterpAsm-armv5te.S</a> .  It seems to me so interesting and practical. <br><br><h5>  Documentation </h5><br>  All the main documentation is located in the <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dtree%3Bf%3Ddocs%3Bh%3D7045c2e00b823918a8387187ca171d4c68936080%3Bhb%3DHEAD">docs</a> directory, but if necessary I will give links to a more readable format than the raw html. <br><br><h5>  Investigate addition opcode (0x90) </h5><br>  Consider the opcode <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">0x90</a> , its code: <br><pre> <code class="hljs pgsql">.L_OP_ADD_INT: <span class="hljs-comment"><span class="hljs-comment">/* 0x90 */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* File: armv5te/OP_ADD_INT.S */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* File: armv5te/binop.S */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* * Generic 32-bit binary operation. Provide an "instr" line that * specifies an instruction that performs "result = r0 op r1". * This could be an ARM instruction or a function call. (If the result * comes back in a register other than r0, you can override "result".) * * If "chkzero" is set to 1, we perform a divide-by-zero check on * vCC (r1). Useful for integer division and modulus. Note that we * *don't* check for (INT_MIN / -1) here, because the ARM math lib * handles it correctly. * * For: add-int, sub-int, mul-int, div-int, rem-int, and-int, or-int, * xor-int, shl-int, shr-int, ushr-int, add-float, sub-float, * mul-float, div-float, rem-float */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* binop vAA, vBB, vCC */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span>(r0, <span class="hljs-number"><span class="hljs-number">1</span></span>) @ r0&lt;- CCBB mov r9, rINST, lsr #<span class="hljs-number"><span class="hljs-number">8</span></span> @ r9&lt;- AA mov r3, r0, lsr #<span class="hljs-number"><span class="hljs-number">8</span></span> @ r3&lt;- CC <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r2, r0, #<span class="hljs-number"><span class="hljs-number">255</span></span> @ r2&lt;- BB GET_VREG(r1, r3) @ r1&lt;- vCC GET_VREG(r0, r2) @ r0&lt;- vBB .<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> cmp r1, #<span class="hljs-number"><span class="hljs-number">0</span></span> @ <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> second operand zero? beq common_errDivideByZero .endif FETCH_ADVANCE_INST(<span class="hljs-number"><span class="hljs-number">2</span></span>) @ advance rPC, <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> rINST @ optional op; may <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> condition codes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r0, r0, r1 @ r0&lt;- op, r0-r3 changed GET_INST_OPCODE(ip) @ extract opcode <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rINST SET_VREG(r0, r9) @ vAA&lt;- r0 GOTO_OPCODE(ip) @ jump <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> next instruction <span class="hljs-comment"><span class="hljs-comment">/* 11-14 instructions */</span></span></code> </pre><br><br>  If you look at the comments, everything becomes clear, but I would like to see these comments in the code myself.  Therefore, further there is an analysis of a piece of this code. <br><br>  Opcode <a href="http://www.netmite.com/android/mydroid/dalvik/docs/dalvik-bytecode.html">0x90</a> corresponds to the addition instruction, its format is <a href="http://www.netmite.com/android/mydroid/dalvik/docs/instruction-formats.html">23x</a> .  This means that the size of the instruction is 2 bytes and uses 3 registers, 'x' means that there is no more than this. <br><br>  Therefore, the code of this opcode must extract these 3 registers, which are transmitted in 23x format and use them for addition.  But it turns out that everything is not so simple.  The prefix 'v' to the register, for example, 'vCC' - means virtual.  And it turns out that the opcode transmits the register numbers, and then the instruction retrieves the value contained in the specified register.  ( <i>Note</i> : registers do not always have the prefix 'v') <br><br>  It looks like this: <br>  - We have opcode: 00 | 90 02 | 01 (AA | op CC | BB) * <br>  - 90 means addition opcode <br>  - Extract the numbers of registers r9 = 0, r2 = 1, r3 = 2 <br>  - Extract the contents of the registers r1 = REG (r3), r0 = REG (r2) ** <br>  - We carry out the instruction 'add r0, r0, r1' <br>  - Save the return value REG (r9) = r0 <br><br>  * added for ease of perception |, similar to documentation <br>  ** REG - is pseudocode <br><br>  This opcode also contains the commands necessary to switch to another opcode.  Now they should not pay attention, since they parse a bit lower. <br><br>  And now how it all looks in assembly language or a more severe explanation: <br>  1. <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">FETCH</a> (r0, 1).  This opcode (0x90) uses two registers <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">rPC</a> and rINST (ibid), which correspond to r4 and r5.  If you look a little lower, you will notice that rINST ( <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">FETCH_INST</a> ) is the value at rPC.  Therefore, it can be said that rINST is equal to the value of the FETCH (rINST, 0) command. <br><br>  2. The numbers of the registers are retrieved by the standard method.  (see picture) <br><br>  3. <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">GET_VREG</a> (r1, r3).  A new rFP register appears.  This register points to the memory area for local variables and arguments.  Those.  through it, you can both extract the values ‚Äã‚Äãof the arguments and write the return value.  It can be represented as a pointer to the internal registers of the VM. <br><br>  4. .if 0 ... .endif is incomprehensible, and all because he began to explore with the file InterpAsm-armv5te.S!  If you look at the file <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/armv5te/binop.S%3Bh%3Dd169ed649e6880e5f27ba788abf75191e3a98941%3Bhb%3DHEAD">binop.S</a> , it becomes clear that checking the second argument but zero in this opcode is disabled. <br><br>  5. FETCH_ADVANCE_INST (2) is discussed further. <br><br>  6. Addition is performed. <br><br>  7. GET_INST_OPCODE (ip) is discussed further. <br><br>  8. <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">SET_VREG</a> (r0, r9) writes the return value to the corresponding register, the number of which is specified in r0. <br><br>  9. GOTO_OPCODE (ip) is discussed further. <br><br>  I painted a visual (I hope) picture: <br> <a href="http://imageshack.us/photo/my-images/546/opcodes.png/"><img src="http://img546.imageshack.us/img546/6802/opcodes.th.png"></a> <br><br>  It can be concluded that the opcode is similar to the same assembler code ('adds r0, r1, r0'), only with 2 additions: processing the virtual registers and moving on to the next opcode. <br><br><h6>  Not considered part </h6><br>  The processing of virtual registers was considered.  Now you also need to understand what the rest of the teams in the opcode are doing, I hope they will not lead too far.  For example, where the values ‚Äã‚Äãof registers such as rFP and rPC are initialized.  Although it is no less interesting, but a strong offshoot of the goal. <br><br>  Now consider the remaining commands: <br>  1. <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">FETCH_ADVANCE_INST</a> (2) the following opcode is written to the rINST register <br>  2. <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">GET_INST_OPCODE</a> (ip) in the ip register records the opcode number (already the next one) <br>  3. <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">GOTO_OPCODE</a> (ip) go to the code of the next opcode <br><br>  The rIBASE register appears in these 3 commands.  It is necessary to check whether it is an opcode with the number 0x00?  It seems as if it should.  That is how it is.  The code often contains the line: <br><pre> <code class="hljs swift">adr rIBASE, dvmAsmInstructionStart @ <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> rIBASE</code> </pre><br><br>  And the value of <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">dvmAsmInstructionStart</a> is equal to .L_OP_NOP.  And the code OP_NOP?  He really is <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/out/InterpAsm-armv5te.S%3Bh%3De6abac5023343f04630f73c5ce76becd433403af%3Bhb%3DHEAD">0x00</a> . <br><br><h6>  What is not considered, but I would like to </h6><br>  In this section, only the rest (rPC, rFP) registers of the initial value were not considered.  Perhaps we consider them further.  Why it is ‚Äúpossible‚Äù because it‚Äôs great value for an article while it‚Äôs represented by rFP, and not rPC. <br><br><h5>  Investigate addition opcode (correct version) </h5><br>  It seemed to me that the way the opcode was investigated was not quite correct, but it seemed to me more pleasant.  But now let us consider how this can be done better, namely, how are the files in the arm5vte folder composed? <br><br>  To do this, refer to the document <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob_plain%3Bf%3Dvm/mterp/README.txt%3Bhb%3DHEAD">README.txt</a> . <br><br>  I am a little surprised, but the method used for the study was correct, in terms of the README.txt file.  Here is a quote: <br><br>  <i>‚ÄúIt‚Äôs a directory where you‚Äôre looking for a directory, such as out / InterpC-portstd.c, rather than trying to get it. "</i> <br><br>  Now, as for our example, consider the OP_ADD_INS.S file: <br><pre> <code class="hljs perl">%verify <span class="hljs-string"><span class="hljs-string">"executed"</span></span> %include <span class="hljs-string"><span class="hljs-string">"armv5te/binop.S"</span></span> {<span class="hljs-string"><span class="hljs-string">"instr"</span></span>:<span class="hljs-string"><span class="hljs-string">"add r0, r0, r1"</span></span>}</code> </pre><br><br>  This code means that this file will, conditionally, be replaced by the file binop.S, in which the values ‚Äã‚Äãof $ instr will be <code>add r0, r0, r1</code> . <br><br>  It remains to consider the file <a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/armv5te/binop.S%3Bh%3Dd169ed649e6880e5f27ba788abf75191e3a98941%3Bhb%3DHEAD">binop.S</a> : <br><br><pre> <code class="hljs mel">%default {<span class="hljs-string"><span class="hljs-string">"preinstr"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"result"</span></span>:<span class="hljs-string"><span class="hljs-string">"r0"</span></span>, <span class="hljs-string"><span class="hljs-string">"chkzero"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>} <span class="hljs-comment"><span class="hljs-comment">/* * Generic 32-bit binary operation. Provide an "instr" line that * specifies an instruction that performs "result = r0 op r1". * This could be an ARM instruction or a function call. (If the result * comes back in a register other than r0, you can override "result".) * * If "chkzero" is set to 1, we perform a divide-by-zero check on * vCC (r1). Useful for integer division and modulus. Note that we * *don't* check for (INT_MIN / -1) here, because the ARM math lib * handles it correctly. * * For: add-int, sub-int, mul-int, div-int, rem-int, and-int, or-int, * xor-int, shl-int, shr-int, ushr-int, add-float, sub-float, * mul-float, div-float, rem-float */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* binop vAA, vBB, vCC */</span></span> FETCH(r0, <span class="hljs-number"><span class="hljs-number">1</span></span>) @ r0&lt;- CCBB mov r9, rINST, lsr #<span class="hljs-number"><span class="hljs-number">8</span></span> @ r9&lt;- AA mov r3, r0, lsr #<span class="hljs-number"><span class="hljs-number">8</span></span> @ r3&lt;- CC and r2, r0, #<span class="hljs-number"><span class="hljs-number">255</span></span> @ r2&lt;- BB GET_VREG(r1, r3) @ r1&lt;- vCC GET_VREG(r0, r2) @ r0&lt;- vBB .<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $chkzero cmp r1, #<span class="hljs-number"><span class="hljs-number">0</span></span> @ is second operand zero? beq common_errDivideByZero .endif FETCH_ADVANCE_INST(<span class="hljs-number"><span class="hljs-number">2</span></span>) @ advance rPC, load rINST $preinstr @ optional op; may set <span class="hljs-keyword"><span class="hljs-keyword">condition</span></span> codes $instr @ $result&lt;- op, r0-r3 changed GET_INST_OPCODE(ip) @ extract opcode from rINST SET_VREG($result, r9) @ vAA&lt;- $result GOTO_OPCODE(ip) @ jump to next instruction</code> </pre><br><br>  As you can see the code is very, very similar to what it was before.  Only now there are no unclear points.  For example, there was a comment "@optional op ..", and why, it is not clear.  It is now clear. <br><br>  I do not see the point of disassembling this opcode, everything has already been considered in it.  Now we need to quickly move to the most important question - how are the arguments of the native and non-native functions filled? <br><br><h5>  Part II.  Total </h5><br>  It was already another level than in the first part, it was necessary to learn a lot and remember, but now the structure of the opcode is clear!  This can be happy.  Yes, there is no more sense in this than simply rejoicing.  But at the same time you can already write your opcode. <br><br>  From this part you could learn what architecture is used to generate files.  Where and how to find the corresponding opcode. <br><br>  You may also have a lot of questions and I advise you to watch the <a href="http://sites.google.com/site/io/dalvik-vm-internals">presentation of the</a> developer Dalvik VM.  This presentation shows very well how exactly such commands as GOTO_OPCODE are used or how the bytecode queue is organized. <br><br>  I do not try to immediately draw conclusions to achieve the goal, all conclusions will be at the very end of the article.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And now I propose to dive inside Dalvik VM and understand where this code is being executed, but I warn you further the level is even higher, but I will insert less code. </font></font><br><br><h4>  Part III.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How and where does the code run? </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the third part will be considered the process of extracting the function in Dalvik VM. </font><font style="vertical-align: inherit;">The previous knowledge will help a lot, but I'm afraid to assume that the race will be the same as between the first and second part.</font></font> Let's get started! <br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : it seems to me that you better not immediately follow the links, but first read, so will the material gradually appear and less likely to get confused.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Disassemble </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It is necessary to understand how the opcode is filled in, for this we will see the following code in the section: </font></font><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Summator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sum(<span class="hljs-number"><span class="hljs-number">44</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>); staticSum(<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">41</span></span>); nSum(<span class="hljs-number"><span class="hljs-number">44</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>); nStaticSum(<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">41</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">staticSum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nSum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nStaticSum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span></span>; }</code> </pre><br><br><pre> <code class="bash hljs"> name : <span class="hljs-string"><span class="hljs-string">'test'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> : <span class="hljs-string"><span class="hljs-string">'()V'</span></span> access : 0x0000 () code - registers : 5 ins : 1 outs : 3 insns size : 21 16-bit code units outs : 3 insns size : 21 16-bit code units 0022a8: |[0022a8] com.m039.study.Summator.test:()V 0022b8: 1303 2c00 |0000: const/16 v3, <span class="hljs-comment"><span class="hljs-comment">#int 44 // #2c 0022bc: 1302 2b00 |0002: const/16 v2, #int 43 // #2b 0022c0: 1301 2a00 |0004: const/16 v1, #int 42 // #2a 0022c4: 1300 2900 |0006: const/16 v0, #int 41 // #29 0022c8: 6e30 2e00 3402|0008: invoke-virtual {v4, v3, v2}, Lcom/m039/study/Summator;.sum:(II)I // method@002e 0022ce: 7120 2d00 0100|000b: invoke-static {v1, v0}, Lcom/m039/study/Summator;.staticSum:(II)I // method@002d 0022d4: 6e30 2600 3402|000e: invoke-virtual {v4, v3, v2}, Lcom/m039/study/Summator;.nSum:(II)I // method@0026 0022da: 7120 2500 0100|0011: invoke-static {v1, v0}, Lcom/m039/study/Summator;.nStaticSum:(II)I // method@0025 0022e0: 0e00 |0014: return-void catches : (none) positions : 0x0008 line=29 0x000b line=30 0x000e line=31 0x0011 line=32 0x0014 line=33 locals : 0x0000 - 0x0015 reg=4 this Lcom/m039/study/Summator;</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I do not really want to disassemble (and copy to the article) each file in the armv5te directory. </font><font style="vertical-align: inherit;">Therefore, I will try to give links and excerpts from these files. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the listing above, you can see that the native method is no different from the other.</font></font> How so?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actually, this is how it should be, but still, the listing does not have any hint of how the native method is retrieved. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But first, why not consider the call itself (invoke-virtual) and immediately assume that the code there is not small. </font><font style="vertical-align: inherit;">Therefore, I will form in advance what I would like to find there: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the difference between virtual and static </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the very extraction of the function </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- and how many, and possibly, what operations follow before the extraction </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The rest is not yet interested and should not distract from the study.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Execution method </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's start looking at listing from top to bottom. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The part of the code that fills in and retrieves the sum method:</font></font><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">0022</span></span>b8: <span class="hljs-number"><span class="hljs-number">1303</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>c00 |<span class="hljs-number"><span class="hljs-number">0000</span></span>: const/<span class="hljs-number"><span class="hljs-number">16</span></span> v3, #<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> // #<span class="hljs-number"><span class="hljs-number">2</span></span>c <span class="hljs-number"><span class="hljs-number">0022</span></span>bc: <span class="hljs-number"><span class="hljs-number">1302</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>b00 |<span class="hljs-number"><span class="hljs-number">0002</span></span>: const/<span class="hljs-number"><span class="hljs-number">16</span></span> v2, #<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> // #<span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">0022</span></span>c8: <span class="hljs-number"><span class="hljs-number">6e30</span></span> <span class="hljs-number"><span class="hljs-number">2e00</span></span> <span class="hljs-number"><span class="hljs-number">3402</span></span> |<span class="hljs-number"><span class="hljs-number">0008</span></span>: invoke-virtual {v4, v3, v2}, Lcom/m039/study/Summator;.sum:(II)I // <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>@<span class="hljs-number"><span class="hljs-number">002</span></span>e</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At first glance, everything is very simple. </font><font style="vertical-align: inherit;">The relevant registers are filled in and the method is retrieved. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will try to guess what this method will look like from the inside. </font></font><br><br> <code>const/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- probably enters the value of 44 in the virtual register by the number 0, and then the value of 43. ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : and if we assume that v1 is the designation of the virtual register, then there is no doubt) </font></font><br><br> <code>invoke-vritual</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- enters the value of this in v4 and calls the function.</font></font><br><br><h6><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> const / 16 </font></font></h6><br><pre> <code class="hljs pgsql"> %verify "executed" <span class="hljs-comment"><span class="hljs-comment">/* const/16 vAA, #+BBBB */</span></span> FETCH_S(r0, <span class="hljs-number"><span class="hljs-number">1</span></span>) @ r0&lt;- ssssBBBB (sign-extended) mov r3, rINST, lsr #<span class="hljs-number"><span class="hljs-number">8</span></span> @ r3&lt;- AA FETCH_ADVANCE_INST(<span class="hljs-number"><span class="hljs-number">2</span></span>) @ advance rPC, <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> rINST SET_VREG(r0, r3) @ vAA&lt;- r0 GET_INST_OPCODE(ip) @ extract opcode <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rINST GOTO_OPCODE(ip) @ jump <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> next instruction</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This code reads the value transmitted in the second byte and writes the value to the virtual register. </font><font style="vertical-align: inherit;">It can be noted (again) that everything looks the same as the generated C code (optimized version) with only 2 additions: an intermediate virtual register is used for each write / read and a new opcode is loaded each time and a transition is made. </font><font style="vertical-align: inherit;">Otherwise, everything is very, very transparent.</font></font><br><br><h6><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">invoke- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kind</font></font></i> </h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 virtual registers are filled, now go to the file OP_INVOKE_VIRTUAL.S. And there is a deep horror. Therefore, we will immediately try to understand the difference between virtual (file </font></font><a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob_plain%3Bf%3Dvm/mterp/armv5te/OP_INVOKE_VIRTUAL.S%3Bhb%3DHEAD"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OP_INVOKE_VIRTUAL.S</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and static ( </font></font><a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob_plain%3Bf%3Dvm/mterp/armv5te/OP_INVOKE_STATIC.S%3Bhb%3DHEAD"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OP_INVOKE_STATIC.S</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By code difference in two places. The value passed to the dvmResolveMethod function and the non-static method has an additional appendix ".L $ {opcode} _continue:". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider what the dvmResolveMethod function does. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before calling this function, the registers are filled as follows. (extract from comments): </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- r0 &lt;- method-&gt; clazz </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- r1 &lt;- CCCC * </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- r2 &lt;- METHOD_VIRTUAL or METHOD_STATIC (method type) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- r3 &lt;- glue-&gt; method </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* by document</font></font><a href="http://www.netmite.com/android/mydroid/dalvik/docs/instruction-formats.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instructions-format</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CCCC, although BBBB is written in the comments. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now let's turn to the </font></font><a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/oo/Resolve.c%3Bh%3Dc4bda8baa87a3b1d86183b02f4dad01c420faa23%3Bhb%3DHEAD"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dvmResolveMethod</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/oo/Resolve.c%3Bh%3Dc4bda8baa87a3b1d86183b02f4dad01c420faa23%3Bhb%3DHEAD"><font style="vertical-align: inherit;">code</font></a><font style="vertical-align: inherit;"> . If you look at the function declaration, it becomes clear that the 4th argument (see above) is superfluous:</font></font><br><br><pre> <code class="hljs lisp"> Method* dvmResolveMethod(<span class="hljs-name"><span class="hljs-name">const</span></span> ClassObject* referrer, u4 methodIdx, MethodType methodType)</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This function returns a pointer to a </font></font><a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/oo/Object.h%3Bh%3D903450f69e86905ebce987a263f1e08bc137c615%3Bhb%3DHEAD"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> structure </font><font style="vertical-align: inherit;">, which is not necessary to know more about this function. Take a look at this structure. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are a lot of interesting and useful fields, but there is one wonderful field that provides particular interest - </font></font><code>nativeFunc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Therefore, this structure also contains a pointer to the native function. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now it would be nice to know where this structure or this method is ‚Äúimplemented.‚Äù </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both in the file OP_INVOKE_STATIC.S and in OP_INVOKE_VIRTUAL.S at the end the function is called </font></font><code>bl common_invokeMethod${routine}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Most likely this is the main handler of the Method structure and its code can be found in the </font></font><a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/armv5te/footer.S%3Bh%3Db69aef8006111f6079ac810ff778c48fed9e5325%3Bhb%3DHEAD"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">footer.S</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">. The prefix "NoRange" appeared because of the first line in the file - </font></font><code>%default { ... , "routine" : "NoRange" }</code> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But before looking at footer.S, you can see what type means</font></font><code>DalvikBridgeFunc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">near the field </font></font><code>nativeMethod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? If you run through the VM code, you can find that </font></font><code>nativeMethod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the </font></font><a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/Native.c%3Bh%3D1ebef2eedf15ff50a1de36b596b9367aac4431b3%3Bhb%3DHEAD"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dvmResolveNativeMethod</font></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function is assigned to the </font><a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/Native.c%3Bh%3D1ebef2eedf15ff50a1de36b596b9367aac4431b3%3Bhb%3DHEAD"><font style="vertical-align: inherit;">field.</font></a></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> By the comment of this function, it becomes clear that it is used to find the native method (in the library libNAME.so) and most importantly execute it. Well, we take her word for it, that case is the only case when it is better to believe. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One less question, it now became clear who performs the native method and where. But still, it‚Äôs not completely clear where. After all, the file footer.S was never reviewed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Returning to the </font><a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/armv5te/footer.S%3Bh%3Db69aef8006111f6079ac810ff778c48fed9e5325%3Bhb%3DHEAD"><font style="vertical-align: inherit;">common_invokeMethodNoRange</font></a><font style="vertical-align: inherit;"> function</font></font><a href="http://android.git.kernel.org/%3Fp%3Dplatform/dalvik.git%3Ba%3Dblob%3Bf%3Dvm/mterp/armv5te/footer.S%3Bh%3Db69aef8006111f6079ac810ff778c48fed9e5325%3Bhb%3DHEAD"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. You can pay attention to the fact that it is very scary and it has answers to what was not clear in the last part, namely who fills registers such as rFP and rPC. As you can see, this function fills them. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Only a little patience and there you can understand, for example, what fills rINST, rPC, r2? Pointer to the field method-&gt; inst, i.e. instructions (bytecode). And there are a lot of such moments, so I‚Äôll leave them out. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But native is of interest, and everything is still easier there. If our method is native (the corresponding flags are checked), then that nativeFunc function is executed, which has already been dealt with. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otherwise, common_invokeMethodNoRange is very similar to the standard opcode that was previously considered, only a lot of additional checks.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And what about static or non-static methods? apparently, footer.S has no relation to them, everything that could be said about them has already been said in the corresponding opcode files (invoke-virtual and invoke-static). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On this we can say who did what and where it made clear. And if not, then continue to figure it out is not difficult. My task was to show that it was more than realistic to ask myself questions (see the original goal) and to understand it well.</font></font><br><br><h5>  Part III.  Total </h5><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this part, a function was found responsible for retrieving the native method. Also traced to where this function is retrieved and where it is stored. With this knowledge, you can view other parts of the Java language and watch them in the code of Dalvik VM. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After this part it becomes clear that bytecode is a lot of opcodes and each interacts with each other. And in this part only a small part of this interaction was considered. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are interested in this topic, then you can further consider the standard structures of the Java language in a disassembler form and understand why the developer Dalvik VM in his presentation showed examples of how to do it or not do it when programming in Java for android.</font></font><br><br><h4>  Total </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here I will try to make excerpts from what I think can be found in this article. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But first I want to emphasize a couple of features, as the article is composed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You could see the word ‚ÄúRemark‚Äù in the text, it was added after writing the whole article in the draft. And then it seemed to me that these comments should be added. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My goal for this article is to show the thinking that is needed to research incomprehensible code in practice. I chose for this very simple questions and the object of interest to me. Therefore, you can meet many branches and notice how the attitude to the subject changes.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now a little about what seems to me interesting and is the result of research. They may seem banal to you, many things are written in the specification of the Java language, but after this article it is much easier to understand these structures as they are. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here are the main points: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. The method call, no matter how static or virtual it is (there is also a quick prefix), it is a very complex method call itself when compared to simple C (and even C ++). For example, let's say you have a wraper for Box2D. If every time (in an infinite loop) to call a method from this wrapper, in order to check whether the objects intersect, the corresponding question arises - why? This is better and needs to be done in C, but you can create a world and initialize objects in Java.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Opcodes are very close in their functionality to assembler inserts, so that they are implemented with the help of an assembler. Naturally, they are better than calling a third-party function via JNI, but worse than just doing it in C. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">They are worse by two criteria: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) They use a wrapper for virtual call through virtual registers, which is very similar to how C compiler issues in debug mode. It can even be said that the opcode is very similar in speed to the non-optimized version in C. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) Each opcode has the extraction code of the next opcode, but it is not large. After extraction, a transition to the next occurs, which already looks like a simple instruction </font></font><code>bl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I quenched my interest and found out what I wanted and my guesses were mostly justified. I am very pleased if you liked it and you followed this path with me. I hope you have interesting thoughts and the main interest in how everything works. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I often notice that the developers oochen often use stereotypes (about the Java and C / C ++ languages) and do not show the slightest action to destroy them, and without it nothing. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are interested in additional material, you can look in the docs folder for the </font></font><a href="http://www.netmite.com/android/mydroid/dalvik/docs/jni-tips.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jni-tips.html file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="http://sites.google.com/site/io/dalvik-vm-internals"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2008 </font><a href="http://sites.google.com/site/io/dalvik-vm-internals"><font style="vertical-align: inherit;">presentation of the</font></a><font style="vertical-align: inherit;"> Davik VM developer. There is also an interesting project </font></font><a href="http://code.google.com/p/smali/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smali</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but my hands did not get to him.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PS I apologize right away if I made a mistake, please correct me and then I will immediately make a change. </font></font></div><p>Source: <a href="https://habr.com/ru/post/126356/">https://habr.com/ru/post/126356/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126343/index.html">Google acquired Motorola's mobile business for $ 12.5 billion</a></li>
<li><a href="../126350/index.html">Mobile communication in the hauls and stations of the Moscow metro</a></li>
<li><a href="../126351/index.html">Intervalometer from the phone: continued</a></li>
<li><a href="../126352/index.html">Manufacturers of Android devices "approved" the purchase of Motorola Mobility</a></li>
<li><a href="../126354/index.html">KOSHT.com sold to the "First Catalog"?</a></li>
<li><a href="../126358/index.html">Introduction to PERFORMANCE_SCHEMA</a></li>
<li><a href="../126360/index.html">Part 1. The work space of this startup</a></li>
<li><a href="../126361/index.html">Two-day conference-workshop on design and usability - D-Camp</a></li>
<li><a href="../126362/index.html">Illustrator masters programming</a></li>
<li><a href="../126364/index.html">Anonymous hacked the site of the railway company BART</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>