<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FreePBX: first steps on rake</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starting familiarity with FreePBX, even experienced system administrators often make the same mistakes that can seriously spoil the mood and discourag...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FreePBX: first steps on rake</h1><div class="post__text post__text-html js-mediator-article">  Starting familiarity with FreePBX, even experienced system administrators often make the same mistakes that can seriously spoil the mood and discourage any desire to continue mastering this system. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3d0/fa3/b79/3d0fa3b790ee4728896657417441db1a.png"></div><br><a name="habracut"></a><br>  First of all, of course, these are errors related to the safety of the station.  Remember that connecting to the telephony operator you are fully financially responsible for the calls, even if in fact you did not make them!  Let's see what needs to be done in the first place, and what absolutely cannot be done. <br><br>  Immediately after installing the system, you must disable the ability to receive guest and anonymous calls, unless, of course, you are going to use them.  Otherwise, you actually allow anyone to make calls through your station, which can lead to significant financial losses. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Settings ‚Üí Asterisk Settings for SIP ‚Üí General SIP Settings </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/89d/7a9/425/89d7a942503a4253864a70fba65c8b5e.png"></div><br><h3>  Settings ‚Üí Asterisk Settings for SIP ‚Üí SIP Channel Settings </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/853/89c/5a6/85389c5a664345869a14c3a8f3ae417b.png"></div><br>  Despite the fact that FreePBX is constantly updated, and the developers make great efforts to ensure the security of the system, periodic vulnerabilities are discovered in the code, using which attackers can get, for example, access parameters to your telecom operators.  Despite the fact that in this case calls will not come from your station, the operator will most likely require payment from you.  Therefore, do not forget about the protection of the web interface: if the server is installed on your local network, do not forward port 80 to the outside - for remote configuration you can use a vpn, ssh tunnel or any other access method.  If FreePBX is installed on a remote server or for some other reason has direct access to the network, you can limit the ability to connect via port 80 at the iptables level, and also use Basic Auth password protection as an additional security tool. <br><br>  In case you installed FreePBX from the official image, you will need to edit the file. <br><br><pre><code class="hljs">/etc/httpd/conf.d/freepbx.conf</code> </pre> <br>  At the very end, before the last line, add the following <br><br><pre> <code class="hljs pgsql">AuthType Basic AuthName "Administrative zone" AuthUserFile /.htpasswd Require <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span></code> </pre><br>  Pay attention to the path to the .htpasswd file - you can specify any path to store it.  Then you need to create an account.  Go to the selected directory, run <br><br><pre> <code class="hljs swift">htpasswd -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> .htpasswd admin</code> </pre> <br>  and enter the password for the admin user.  Do not forget to restart apache: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">service</span></span> httpd reload</code> </pre> <br>  And check the result: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/8a9/2c2/6ff/8a92c26ff4d4484a8f51497fcc138a1a.png"></div><br>  You should also contact your telecom operator and limit the ability to connect with your credentials by ip-address: in this case, even if the attackers get your username and password, you will not be able to use them. <br><br>  Of course, we can not forget about the security of user accounts on your station.  If possible (for example, all your users are on the local network), be sure to restrict the ability to connect to ip-addresses - even if a certain user‚Äôs password is compromised, the attackers from the outside will not be able to use it. <br><br><h3>  Applications ‚Üí Extension ‚Üí Extension ‚Üí Extended </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a0d/e3f/673/a0de3f6734774471969b5abca59f4f75.png"></div><br>  There are situations when it is not possible to restrict a user by ip - for example, an account is used from a mobile phone, from different 3g, 4g, and wifi networks.  In this case, first of all, check the reliability of your passwords.  Remember, even on a ‚Äúempty‚Äù station, even for testing, you never need to set passwords like qwerty, because afterwards you can forget about such an account as easy as picking up such a password. <br><br><h3>  Applications ‚Üí Extension ‚Üí Extension ‚Üí General </h3><br><img src="https://habrastorage.org/files/255/eff/94e/255eff94e29a4df9b4c30372a149c38d.png"><br><br>  It is necessary to think about the search for passwords.  Naturally, if your server serves clients from the same network and connects to one telecom operator, you can and should even limit the ability to connect to the sip port (usually 5060) for everyone except the known addresses of their networks and providers, for example, if you installed FreePBX manually <br><br><pre> <code class="hljs matlab">-A INPUT -s xxx.xxx.xxx.xxx/<span class="hljs-number"><span class="hljs-number">32</span></span> -p udp -m udp --dport <span class="hljs-number"><span class="hljs-number">5060</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A INPUT -s yyy.yyy.yyy.yyy/<span class="hljs-number"><span class="hljs-number">32</span></span> -p udp -m udp --dport <span class="hljs-number"><span class="hljs-number">5060</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A INPUT -p udp -m udp --dport <span class="hljs-number"><span class="hljs-number">5060</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> DROP</code> </pre> <br>  Or use the built-in web-interface Firewall if you installed the system from an official image.  You can set trusted and external networks manually in the menu <br><br><h3>  Connections ‚Üí Firewall ‚Üí Zones ‚Üí Network </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e32/345/2d4/e323452d4007409fb382bc06f8d94f66.png"></div><br>  And then determine which services will be opened in the tab. <br><br><h3>  Connections ‚Üí Firewall ‚Üí Services </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a99/9d6/484/a999d648497e4666ac00827699fbf9dd.png"></div><br>  But it is not always possible to leave only a few subnets for the sip-port.  In this case, it is highly recommended to install fail2ban and configure it for use with asterisk.  This daemon, based on the logs of authorization attempts, blocks too persistent for a certain time after a specified number of authorization attempts, which allows you to stop brute force.  In the latest versions of fail2ban, the rules for asterisk are already included in the delivery, but it is recommended to check its operation - perform several registration attempts with a deliberately wrong login and password (only not necessarily from the same ip address from which you connect to the server!) And check that will this address be blocked by command <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">iptables</span></span> -L</code> </pre> <br>  In the official assembly of FreePBX, the password brute force protection system is already installed and configured.  Blocked addresses can be found in the tab. <br><br><h3>  Connections ‚Üí Firewall ‚Üí Status </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d14/5d1/550/d145d1550dbf44fa87346a1733e100af.png"></div><br>  Very often, especially in small organizations, when only one provider is used, system administrators do not pay attention to setting up outgoing routes correctly, limited to the X template, thus allowing all users to call any phone number.  Even if you completely exclude the possibility of making calls by intruders, we must not forget that the user may simply make a mistake and call somewhere in the Dominican Republic, so it is necessary to restrict outgoing calls.  Usually it is enough to add templates for calling city and mobile phone numbers; for the RF, the route might look like this: <br><br><h3>  Connections ‚Üí Outbound Routing ‚Üí Route ‚Üí Dialing Rules </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e86/fa8/4ff/e86fa84ff3c44487bef0b73c29ec9d47.png"></div><br>  Here we ask that the number should be 11-digit, start from 8, and the second digit should be 3,4,8 or 9, which completely covers all Russian numbers, and also we allow only 100-199 numbers to call through this route.  If an employee needs to open international calls, you should add an additional route for him before the main one, and it is necessary to indicate his number or number pattern in the CID field, if there are several such employees. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4dc/4ec/bc2/4dc4ecbc23264f9391b930a5974aa801.png"></div><br>  Also, you should always specify the number of simultaneous outgoing calls in the trunk settings, especially if they are not limited on the operator‚Äôs side (10 employees cannot make 100 outgoing calls), but in the case of unauthorized calls, hackers try to call to the maximum number of streams . <br><br><h3>  Connections ‚Üí Trunks ‚Üí Trunk Settings ‚Üí General </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/335/c76/0cc/335c760cc91a4706acdbd06dcc626ab9.png"></div><br>  The next common mistake is to create a queue of calls with no time limit and without the condition ‚Äúleave an empty queue‚Äù.  Such an action is especially dangerous if you use the 8-800 number with payment for incoming calls - a certain department can remain without communication (the switch hangs, the light goes out, the rats have eaten a twisted pair), and incoming calls for it will continue to arrive in the queue, and especially persistent Callers can wait on the line for hours. <br>  Trouble may also arise if you do not use 8-800, but the service provider limits the number of simultaneous incoming calls, or uses copper lines or a stream.  In this case, the channel resource will be spent simply on playing music to callers, and as a result, a situation may arise when all your incoming channels are busy waiting in an empty queue.  That is why you should always limit the waiting time in the queue and prevent calls to empty queues. <br><br><h3>  Applications ‚Üí Queues ‚Üí Queue Settings ‚Üí Time and Agent Settings </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d52/595/660/d52595660a204a9e86b70935ba13c8dd.png"></div><br><h3>  Applications ‚Üí Queues ‚Üí Queue Settings ‚Üí Queue Capacity Settings </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0bd/bb2/f73/0bdbb2f7360842cb9a0ed2912c05091b.png"></div><br>  Voice greetings and voice menus are certainly useful and necessary functions used by almost every organization that has decided to switch to FreePBX, but errors are often made when setting them up.  Firstly, the Greeting module, that is, just playing a voice clip that cannot be missed (or you can skip by pressing a key, which you usually forget to notify the user), should be used only when there is an urgent need for it.  I have seen how a one minute-long video clip is placed in the Welcome, and only after it follows the IVR with a proposal to choose the necessary department.  When a customer calls for the first time, this is perceived as normal, but when he calls back the fifth time in an hour, and for the fifth time in a row he listens about how the company is happy with his call, he begins to doubt it.  The client already knows that he needs to press button 2 and switch to the necessary department, but he is forced to listen to the entire greeting once and again.  Maximize the use of Greetings, use IVR and allow direct dialing - this will reduce the client's waiting time and not annoy him. <br><br>  Even when creating the Interactive IVR menu, it is often forgotten to change the default settings regarding the wrong dialing - when you press a key that is not described in the rules, the movie is repeated several times.  This behavior is appropriate only if the choice must be made necessarily (an extremely rare case), and completely inappropriate in the first, welcome voice menu.  Turn off the repetition of the voice menu and transfer the call to the default assignment: to the secretary, to the manager's queue, and so on.  The same applies to the set timeout. <br><br><h3>  Applications ‚Üí Interactive Menu (IVR) ‚Üí IVR Settings </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f8e/532/aae/f8e532aae89b4dc6843eaa09aba40056.png"></div><br>  If you are not sure that these and other errors are excluded on your FreePBX, and you want to feel safe, contact <a href="http://centos-admin.ru/">us</a> , and professionals with many years of experience in the field of ip-telephony will audit the system and correct all mistakes made. </div><p>Source: <a href="https://habr.com/ru/post/313078/">https://habr.com/ru/post/313078/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313066/index.html">Overview of options for implementing failover clusters: Stratus, VMware, VMmanager Cloud</a></li>
<li><a href="../313068/index.html">Media: German military hacked into the network of the Afghan mobile operator to find out the whereabouts of the hostage</a></li>
<li><a href="../313070/index.html">Java Continuations</a></li>
<li><a href="../313072/index.html">New podcast about computer science</a></li>
<li><a href="../313076/index.html">Artem Kukharenko, the founder of NTechLab - about face recognition, the potential of neural networks and business</a></li>
<li><a href="../313080/index.html">Divide and Conquer: Multidimensional Security Policies</a></li>
<li><a href="../313082/index.html">Work not from the office - to be or not to be, that is the question</a></li>
<li><a href="../313086/index.html">Personal experience of receiving the Blue Card in Germany 2015-2016. Part 2: Visa Issues</a></li>
<li><a href="../313090/index.html">Automation as a tool to improve the efficiency of the data center</a></li>
<li><a href="../313092/index.html">River Raid on FPGA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>