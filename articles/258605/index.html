<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bash state machine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think all of us who studied IT, at the university studied finite automata. For those who do not know, this is an abstract automaton capable of being...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bash state machine</h1><div class="post__text post__text-html js-mediator-article">  I think all of us who studied IT, at the university studied finite automata.  For those who do not know, this is an abstract automaton capable of being in a finite number of states, the transition from one state to another occurs when certain conditions are met.  The thing is interesting, but it is not entirely clear when and how this can be applied to solve real problems.  I would like to tell you how I came to solving the arisen task on the basis of a finite state machine, as well as how I implemented it in bash.  And as a bonus I will describe how to save its state for the ability to restore work from an interrupted point. <br><a name="habracut"></a><br>  The task was the following: to automate the process of importing data from external sources.  The system modules for importing these same data are already ready, but at the moment they have to be started manually.  The problem is that you need to import objects in a certain sequence.  In cases where the system could not automatically associate the data with existing data, it is necessary to send the task to operators to perform manual binding.  And only after they have done this, can the import be continued. <br><br>  Since the task mainly consists of running ready-made applications, it was decided to implement it in bash. <br>  <i>For simplicity, instead of the actually created script, the most simplified example will be shown here.</i> <br><br>  The first version of the script consisted of sequentially running the necessary commands and stopping if manual intervention was necessary.  Immediately the question arose of how to continue the robot from an interrupted place in order not to carry out all operations from the very beginning.  The simplest solution is to place a stop in a text file, read the value at start and go to the right place.  But bash does not have a goto statement that could be used to go to a breakpoint.  I had to write the conditions, and that the conditions did not look like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ <span class="hljs-variable"><span class="hljs-variable">$STEP</span></span> == <span class="hljs-string"><span class="hljs-string">'step3'</span></span> || <span class="hljs-variable"><span class="hljs-variable">$STEP</span></span> == <span class="hljs-string"><span class="hljs-string">'step4'</span></span> || ‚Ä¶ || <span class="hljs-variable"><span class="hljs-variable">$STEP</span></span> == <span class="hljs-string"><span class="hljs-string">'step10'</span></span> ]]</code> </pre> <br><br>  At each step, the $ STEP variable is assigned the value of the next step: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ <span class="hljs-variable"><span class="hljs-variable">$STEP</span></span> == <span class="hljs-string"><span class="hljs-string">'step3'</span></span> ]] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">#  .  . STEP='step4' fi if [[ $STEP == 'step4' ]] then #  .  . STEP='step5' fi</span></span></code> </pre><br><br>  Now, if at the very beginning we assign the step value to the variable STEP, we will immediately move to it, and then the script will be executed sequentially. <br><br>  However, after some thought, I realized that it was not always necessary to wait until the operators completed their part of the work.  Sometimes you can poison a message and continue working by skipping one or two steps, and return to them later.  The script began to take this form: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ <span class="hljs-variable"><span class="hljs-variable">$STEP</span></span> == <span class="hljs-string"><span class="hljs-string">'step3'</span></span> ]] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">#   if [[  ]] then STEP='step4' else STEP='step5' fi</span></span></code> </pre><br><br>  Rewriting the conditions several times, I realized that I was trying to create a state machine.  That the script has some state and under certain conditions there is a transition from one state to another.  It should be clarified here that the state does not have to be static, it can be any process, and the moment of transition and conditions are determined by the results of its completion. <br><br>  However, the written code did not allow to do one important thing - to make an arbitrary transition.  In it the sequence of transitions is rigidly sewn up with a sequence of steps in the code.  Steps can only be skipped.  Realizing the problem, the code was rewritten: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> step1 { <span class="hljs-comment"><span class="hljs-comment">#     1 } function step2 { #     2 } ‚Ä¶ while [[ -z $EXIT ]] do case $STEP in step1) step1 if [[  ]] then STEP='step2' else EXIT=1 fi ;; step2) step2 if [[  ]] then STEP='step3' else STEP='step1' fi ;; ... step10) step10 if [[  ]] then STEP='step6' else STEP='step9' fi esac done</span></span></code> </pre><br><br>  As a result, received: <br><ul><li>  Complete isolation of states.  Each state is a separate function. </li><li>  Freedom in transitions between states, regardless of the sequence of their description in the code. </li></ul><br>  I deliberately did not place the conditions for transitions inside functions so that they are pure states.  If conditions suddenly become too complicated, it is better to create separate transition functions for them. <br><br><h5>  Bonus: Preservation of state between calls. </h5><br>  Since I needed the ability to stop the script and continue its work after a while, I wrote a state saving function: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> saveState { <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e ¬´STEP=<span class="hljs-string"><span class="hljs-string">'$STEP'</span></span>\n¬ª &gt; state }</code> </pre><br><br>  The function call was added to the end of the script, and to the beginning of the loading state: source state. <br><br>  A simple script for experiments: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash STEP='step2' #   function step1 { echo 'step 1' } function step2 { echo 'step 2' } #   function saveState { #        echo -e "STEP='$STEP'\n" &gt; state; } #   function main { #         EXIT while [[ -z $EXIT ]] do case "$STEP" in step1) step1 EXIT=1 ;; step2) step2 STEP='step1' ;; esac done } #    state      (   ) if [ -f state ] then source 'state' fi main #   saveState #    .</span></span></code> </pre><br><br>  After the first call, it will output: <br><blockquote>  step2 <br>  step1 <br></blockquote><br>  After the second: <br><blockquote>  step1 <br></blockquote><br><br>  You can reset the state by deleting the state file in the script directory. <br><br><h5>  Some tips </h5><br>  Please note that bash is VERY sensitive to spaces and their absence.  It also has an unusual understanding of numeric values ‚Äã‚Äãas true and false, 0 is true (due to the fact that programs return 0 if successful, and a nonzero value in case of error).  To debug a script, it is useful to run it with the bash -x &lt;script&gt; command. <br><br><h4>  Update May 25, 2015 </h4><br>  Having come out on Monday to the robot and after a little more thought, I realized that the code can be improved a little more by getting rid of the case.  Also taken into account are the <a href="http://habrahabr.ru/users/kt97679/" class="user_link">kt97679</a> tips on using trap, and <a href="http://habrahabr.ru/users/zyxi/" class="user_link">ZyXI</a> on printf. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash STEP='step2' #   #   1 function step1 { echo 'step 1' } #    1 function step1Next { exit } #   2 function step2 { echo 'step 2' } #    2 function step2Next { STEP='step1' } #   function saveState { #       ,      &gt;&gt; printf "STEP=%q\n" "$STEP" &gt; state } #   function main { while true do $STEP $STEP'Next' done } function loadState { #    state      (   ) if [ -f state ] then source 'state' fi } trap saveState EXIT #     loadState #    main #  </span></span></code> </pre><br><br>  Now you can add any number of states without changing the main loop. <br>  For state names, I advise you to use some kind of prefix so that it is unambiguously clear that this is a state function. </div><p>Source: <a href="https://habr.com/ru/post/258605/">https://habr.com/ru/post/258605/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258595/index.html">The sad state of the sysadmin in the era of containers</a></li>
<li><a href="../258597/index.html">The application that I need</a></li>
<li><a href="../258599/index.html">Using Arduino as a component of Wolfram SystemModeler</a></li>
<li><a href="../258601/index.html">Unique TechTalk with Michael Monti Widenius</a></li>
<li><a href="../258603/index.html">We select the correct Microsoft Azure services</a></li>
<li><a href="../258607/index.html">Krovi: Big Data - as dream. 9th series: Why IBM was forced to buy "Alchemists" for $ 100 million</a></li>
<li><a href="../258611/index.html">An example of a vector implementation of a neural network using Python</a></li>
<li><a href="../258613/index.html">Wing IDE Protection Study</a></li>
<li><a href="../258615/index.html">Pulse sensor device Part 2 - Sensors</a></li>
<li><a href="../258619/index.html">Homemade control unit for diesel engine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>