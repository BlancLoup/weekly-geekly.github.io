<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write voice IVR menu in TCL language using Cisco IVR API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we are talking about the voice menu ( IVR ) for Cisco routers, which we will write in TCL, and connect to Cisco 3845. 

 So, first, let's unders...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write voice IVR menu in TCL language using Cisco IVR API</h1><div class="post__text post__text-html js-mediator-article">  Today we are talking about the voice menu ( <b>IVR</b> ) for Cisco routers, which we will write in TCL, and connect to Cisco 3845. <br><br><h1>  So, first, let's understand the basics </h1><br>  Cisco, starting with <b>IOS</b> 12, supports both <b>VXML</b> and <b>TCL</b> scripts for working with voice menus.  However, unlike <b>VXML</b> , <b>TCL</b> scripts have much more interaction with the <b>Cisco IVR API</b> .  It is also possible to connect hybrid <b>IVR</b> scripts, with embedded pieces of <b>VXML</b> code inside the <b>TCL</b> script. <br><br>  You can download all the documents related to Cisco IVR from Cisco <a href="https://cloud.mail.ru/public/FFBy/ZEujVorKp">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  FSM </h3><br>  The first is the <b>FSM</b> transitions. <br>  Finite-State Machines is an abstract automaton, the number of possible internal states of which is finite. <br>  It looks like this: <br><pre><code class="python hljs">set ivr_fsm(CALLCOMES,ev_setup_indication) <span class="hljs-string"><span class="hljs-string">"act_Setup same_state"</span></span></code> </pre> <br>  Such transitions can be any number, and they are located at the end of the <b>TCL</b> script. <br><br>  Let's see what it is all about. <br>  The general syntax of this command is: <br><pre> <code class="python hljs">set array(CURRSTATE, curr_event) ‚Äúact_proc NEXTSTATE‚Äù</code> </pre><br>  Where: <br>  <b>array</b> is the name of the <i><b>FSM</b></i> array. <br>  <b>CURRSTATE</b> is the name of the current state at which the <i><b>curr_event</b></i> event was <i><b>received</b></i> . <br>  <b>act_proc</b> is the name of the function to be executed when the <i><b>curr_event</b></i> event <i><b>arrives</b></i> . <br>  <b>NEXTSTATE</b> is the name of the state that will be set after the execution of <i><b>act_proc</b></i> . <br><br>  In other words, <b>FSM</b> is a marker by which Cisco compares the event received from the API with <b>curr_event</b> and the current status with <b>CURRSTATE</b> , if they are described in any FSM transition, the <b>act_proc</b> procedure is <b>called</b> and the state is changed to <b>NEXTSTATE</b> . <br><br>  The most important thing in this is that the current event and state are compared with all the described <b>FSM</b> transitions <b>at the same time</b> .  Those.  for Cisco, the order in which the FSM transitions are located does not matter; they are all processed asynchronously. <br><a name="habracut"></a><br><h3>  Functions </h3><br>  The second point is the functions themselves, which must be described before the script is initialized. <br><br>  The assignment of all commands and states is described in detail in the tcl_ivr_2.0_programming_guide file, which you can download <a href="https://cloud.mail.ru/public/FFBy/ZEujVorKp">here</a> , I‚Äôll only dwell on those that I will use directly in the script <br><br><h1>  1) Script initialization </h1><br>  The beginning of any TCL IVR script contains the <i><b>init</b></i> procedure, in my example, this function looks like this: <br><pre> <code class="python hljs">proc init { } { puts <span class="hljs-string"><span class="hljs-string">"\n proc Init start"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> param }</code> </pre><br>  Here, essentially, a screen is executed with the <i><b>puts "..."</b></i> command and the definition of a global variable <i><b>param</b></i> <br><br>  The script initialization occurs after the description of all functions, and begins with the launch of the function <i><b>init</b></i> .  This simple things ended, then everything is much more interesting. <br><br>  The last executable line of the script should be the line that defines the start <b>FSM</b> transition and the start state.  In our case it is: <br><pre> <code class="python hljs">fsm define ivr_fsm CALLCOMES</code> </pre><br>  This means that the <b>FSM</b> name of the array is given as <b>ivr_fsm</b> , and the starting state is <b>CALLCOMES</b> .  We'll finish with initialization, it will be more clear what is going on (I hope). <br><br><h1>  2) Greetings </h1><br><pre> <code class="python hljs">proc Play_Welcome { } { puts <span class="hljs-string"><span class="hljs-string">"\n\n IVR - proc Play_Welcome start \n\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> playng_files <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> param <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> pattern <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> numbers <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> workingtime <span class="hljs-comment"><span class="hljs-comment"># ,     init_perCallVars #  GetDate #      ,   if {$workingtime} { set after_welcome $playng_files(takenumber) } else { set after_welcome $playng_files(noworking) } #     set param(interruptPrompt) true set param(abortKey) * set param(terminationKey) # #   leg setupack leg_incoming leg proceeding leg_incoming leg connect leg_incoming #        leg collectdigits leg_incoming param pattern #    ,    #   param(interDigitTimeout),    #  ev_collectdigits_done media play leg_incoming %s500 $playng_files(welcome) $after_welcome $playng_files(onhold) # ,      ev_named_timer timer start named_timer $numbers(waiting_time) t1 }</span></span></code> </pre><br>  Here everything is described in some detail. <br><br>  The result of this procedure will be to connect the incoming line to Cisco at the expense of the <i><b>leg setupack, leg proceeding, leg connect,</b></i> and playing music files one by one on the incoming line at the expense of the <i><b>media play leg_incoming command</b></i> . <br>  The process of collecting the pressed <b><i>leg collectdigit</i></b> keys and the timer with the <i><b>timer start</b></i> command <b><i>starts immediately</i></b> . <br><br>  And whether the working time is now checked or not by calling the <i><b>GetDate</b></i> function: <br><pre> <code class="python hljs">proc GetDate { } { <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> workingtime <span class="hljs-comment"><span class="hljs-comment"># set houris [clock format [clock seconds] -format %H] #  set dayis [clock format [clock seconds] -format %A] #   if {$houris &gt; 17 || $houris &lt; 8 || $dayis=="Sunday" || $dayis=="Saturday"} { set workingtime 0 } else { set workingtime 1 } }</span></span></code> </pre><br>  Depending on the working time or not, we change the music file that will be played to the calling subscriber. <br><br>  Since the starting state is set in our case as <i><b>fsm define ivr_fsm CALLCOMES</b></i> , 3 <b>FSM</b> fall into it immediately: <br><pre> <code class="python hljs">set ivr_fsm(CALLCOMES,ev_setup_indication) <span class="hljs-string"><span class="hljs-string">"Play_Welcome, same_state"</span></span> set ivr_fsm(CALLCOMES,ev_collectdigits_done) <span class="hljs-string"><span class="hljs-string">"CheckDestanation, same_state"</span></span> set ivr_fsm(CALLCOMES,ev_named_timer) <span class="hljs-string"><span class="hljs-string">"GoToReception, same_state"</span></span></code> </pre><br>  The <i><b>ev_setup_indication</b></i> event will occur when a call arrives, and the <i><b>Play_Welcome</b></i> procedure will be launched, which describes the start of the process of collecting the pressed numbers and the start of the timer. <br><br>  After the music is played to the subscriber, a reverse timer report starts, which is set by the <i><b>param (initialDigitTimeout)</b></i> parameter (which could have been set just above the <i><b>set param</b></i> line <i><b>(initialDigitTimeout) 15</b></i> and set to 15 seconds), because  it is not specified here, its standard value is 10 seconds, after which the script will receive the event <b><i>ev_collectdigits_done</i></b> , upon the occurrence of which, as we described in the <b>FSM</b> transition, the <b><i>CheckDestanation</i></b> function will be executed. <br><br>  Timer running on <b><i>Play_Welcome with the</i></b> command: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  named_timer, ,    numbers(waiting_time),   t1 timer start named_timer $numbers(waiting_time) t1</span></span></code> </pre><br>  After its termination, it will generate an <i><b>ev_named_timer</b></i> event, which will be processed by the following <b>FSM</b> transition: <br><pre> <code class="python hljs">set ivr_fsm(CALLCOMES,ev_named_timer) <span class="hljs-string"><span class="hljs-string">"GoToReception, same_state"</span></span></code> </pre><br>  and the procedure <b><i>GoToReception will be called</i></b> . <br><br><h1>  3) Check the entered number </h1><br><pre> <code class="python hljs">proc CheckDestanation { } { puts <span class="hljs-string"><span class="hljs-string">"\n\n IVR - proc CheckDestanation start \n\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> playng_files <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> numbers <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> digit <span class="hljs-comment"><span class="hljs-comment">#   media stop leg_incoming #   set status [infotag get evt_status] set digit [infotag get evt_dcdigits] #     #    ,    $numbers(fast_reception), # digit      $digit   CheckCallersAndConnect, #     CALLCONNECTED, #  ,    ev_setup_done (   ) #    CallIsConnect if {$digit == $numbers(fast_reception)} { puts "\n\n IVR - proc CheckDestanation digit = $digit\nGoing to next reception \n\n" fsm setstate CALLCONNECTED set digit $numbers(reception) # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit #    ,    $numbers(fast_ckp),    # CheckCallersAndConnect } elseif {$digit == $numbers(fast_ckp)} { puts "\n\n IVR - proc CheckDestanation digit = $digit\nGoing to next CKP \n\n" fsm setstate CALLCONNECTED set digit $numbers(ckp) # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit #    ,    $numbers(fast_fax),    # CheckCallersAndConnect } elseif {$digit == $numbers(fast_fax)} { puts "\n\n IVR - proc CheckDestanation digit = $digit\nGoing to next fax \n\n" fsm setstate CALLCONNECTED set digit $numbers(fax) # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit #  = cd_004 (   ) -     # CheckCallersAndConnect } elseif {$status == "cd_004"} { puts "\n\n IVR - proc CheckDestanation status = $status digit = $digit \n\n" fsm setstate CALLCONNECTED # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit #  = cd_005 (  dial plan) -     # CheckCallersAndConnect } elseif {$status == "cd_005"} { puts "\n\n IVR - proc CheckDestanation status = $status digit = $digit \n\n" fsm setstate CALLCONNECTED # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit #  = cd_006 (   ) -    $playng_files(noexist) #     TORECEPTION,       #ev_media_done (   )   Play_TakeNumber } elseif {$status == "cd_006"} { puts "\n\n IVR - proc CheckDestanation status = $status digit = $digit \n\n" fsm setstate TRYAGAIN media play leg_incoming $playng_files(noexist) #       TORECEPTION,    #   ev_media_done (   )  # GoToReception } else { # "    " fsm setstate TORECEPTION media play leg_incoming $playng_files(toreception) puts "\n\n IVR - proc CheckDestanation status = $status \n\n" } }</span></span></code> </pre><br>  In the CheckDestanation procedure, which will be called after the caller dials the number, we compare the digits obtained with the settings with the settings and translate the script into the appropriate state <i><b>using the fsm setstate command</b></i> . <br><br>  All states in the function fall under the following FSM transitions: <br><pre> <code class="python hljs">set ivr_fsm(CALLCONNECTED,ev_setup_done) <span class="hljs-string"><span class="hljs-string">"CallIsConnect, same_state"</span></span> set ivr_fsm(TORECEPTION,ev_media_done) <span class="hljs-string"><span class="hljs-string">"GoToReception, same_state"</span></span> set ivr_fsm(TRYAGAIN,ev_media_done) <span class="hljs-string"><span class="hljs-string">"Play_TakeNumber, TRYING"</span></span> set ivr_fsm(TRYING,ev_collectdigits_done) <span class="hljs-string"><span class="hljs-string">"CheckDestanation, same_state"</span></span> set ivr_fsm(TRYING,ev_named_timer) <span class="hljs-string"><span class="hljs-string">"GoToReception, same_state"</span></span></code> </pre><br>  Let's take it in order. <br><br>  1) So, initially, the <i><b>CheckDestanation</b></i> function <i><b>is</b></i> called after the end of the keystroke collection procedure. <br>  2) We write the information about the keystrokes into the digit variable using the set digit [infotag get evt_dcdigits] command <br>  Similarly, write the state of the line in the status variable <br>  3) Then we compare the results obtained with the given variables and change the state of the script if it matches: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> {$digit == $numbers(fast_reception)} { puts <span class="hljs-string"><span class="hljs-string">"\n\n IVR - proc CheckDestanation digit = $digit\nGoing to next reception \n\n"</span></span> fsm setstate CALLCONNECTED leg setup $numbers(reception) callinfo leg_incoming }</code> </pre><br><br><h1>  4) Check the caller's number </h1><br><pre> <code class="python hljs">proc CheckCallersAndConnect {digit} { puts <span class="hljs-string"><span class="hljs-string">"\n\n IVR - proc CheckCallersAndConnect start \n\n"</span></span> set callernumber [infotag get leg_ani] switch $callernumber { <span class="hljs-string"><span class="hljs-string">"9120000000"</span></span> {set callInfo(displayInfo) <span class="hljs-string"><span class="hljs-string">"Director(mobile)"</span></span>} <span class="hljs-string"><span class="hljs-string">"9130000000"</span></span> {set callInfo(displayInfo) <span class="hljs-string"><span class="hljs-string">"Buhgalter(mobile)"</span></span>} default {} } puts <span class="hljs-string"><span class="hljs-string">"\n\n IVR - caller is $callernumber connect with $digit\n\n"</span></span> leg setup $digit callInfo leg_incoming }</code> </pre><br>  This feature allows you to change the field responsible for writing the name of the caller.  Just for the sake of aesthetics, it will be more pleasant when not only the number but also the subscriber ID is written on the phone.  After changing the subscriber ID the line is connected to the required number. <br><br><h1>  5) Connecting the number </h1><br><pre> <code class="python hljs">proc CallIsConnect { } { puts <span class="hljs-string"><span class="hljs-string">"\n\n IVR - proc CallIsConnect start \n\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> playng_files <span class="hljs-comment"><span class="hljs-comment">#   status set status [infotag get evt_status] #   ls_000 (    ),    CALLACTIVE if {$status == "ls_000"} { fsm setstate CALLACTIVE #   ls_002 (    ),     } elseif {$status == "ls_002"} { fsm setstate TRYAGAIN media play leg_incoming $playng_files(noanswer) #  -  ,     } elseif {$status == "ls_004" || $status == "ls_005" || $status == "ls_006"} { fsm setstate TRYAGAIN media play leg_incoming $playng_files(noexist) #   ls_007 ( ),     } elseif {$status == "ls_007"} { fsm setstate TRYAGAIN media play leg_incoming $playng_files(busy) } }</span></span></code> </pre><br>  This function is called by the following FSM transition: <br><pre> <code class="python hljs">set ivr_fsm(CALLCONNECTED,ev_setup_done) <span class="hljs-string"><span class="hljs-string">"CallIsConnect, same_state"</span></span></code> </pre><br>  The <i><b>ev_setup_done</b></i> event occurs after the caller is connected to the desired line. <br><br><h1>  6) Repeat number request </h1><br><pre> <code class="python hljs">proc Play_TakeNumber { } { puts <span class="hljs-string"><span class="hljs-string">"\n\n IVR - proc Play_TakeNumber start \n\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> playng_files <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> numbers <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> param <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> pattern <span class="hljs-comment"><span class="hljs-comment">#       if {$numbers(cur_try) &lt;= $numbers(max_try)} { puts "\n\n IVR - proc Play_TakeNumber current try is: $numbers(cur_try) \n\n" incr numbers(cur_try) #        leg collectdigits leg_incoming param pattern #   media play leg_incoming $playng_files(takenumber) # ,      ev_named_timer timer start named_timer $numbers(waiting_time) t1 #    $numbers(max_try) -  } else { fsm setstate CALLDISCONNECTED media play leg_incoming $playng_files(callafter) } }</span></span></code> </pre><br>  This function checks if the caller is wrong once, and if the value is less than <b><i>$ numbers (max_try)</i></b> asks to enter the number again. <br><br>  This function is called by the following <b>FSM</b> : <br><pre> <code class="python hljs">set ivr_fsm(TRYAGAIN,ev_media_done) <span class="hljs-string"><span class="hljs-string">"Play_TakeNumber, TRYING"</span></span> set ivr_fsm(TRYING,ev_collectdigits_done) <span class="hljs-string"><span class="hljs-string">"CheckDestanation, same_state"</span></span> set ivr_fsm(TRYING,ev_named_timer) <span class="hljs-string"><span class="hljs-string">"GoToReception, same_state"</span></span></code> </pre><br><br><h1>  7) Disconnection </h1><br><pre> <code class="python hljs">proc AbortCall { } { puts <span class="hljs-string"><span class="hljs-string">"\n\n IVR - proc AbortCall start \n\n"</span></span> call close }</code> </pre><br>  Called by the following <b>FSM</b> : <br><pre> <code class="python hljs">set ivr_fsm(any_state,ev_disconnected) <span class="hljs-string"><span class="hljs-string">"AbortCall, same_state"</span></span> set ivr_fsm(CALLACTIVE,ev_disconnected) <span class="hljs-string"><span class="hljs-string">"AbortCall, CALLDISCONNECTED"</span></span> set ivr_fsm(CALLDISCONNECTED,ev_disconnected) <span class="hljs-string"><span class="hljs-string">"AbortCall, same_state"</span></span> set ivr_fsm(CALLDISCONNECTED,ev_media_done) <span class="hljs-string"><span class="hljs-string">"AbortCall, same_state"</span></span> set ivr_fsm(CALLDISCONNECTED,ev_disconnect_done) <span class="hljs-string"><span class="hljs-string">"AbortCall, same_state"</span></span></code> </pre><br><br><h1>  8) Script connection </h1><br>  Connecting to a Cisco router runs in 2 steps. <br>  <b>The first</b> thing to do is define an <b>application</b> : <br><pre> <code class="python hljs">application service voicemunu flash:voicemenu.tcl param allowed_pattern <span class="hljs-number"><span class="hljs-number">5</span></span>[<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-number"><span class="hljs-number">-7</span></span>].. param fastto_reception <span class="hljs-number"><span class="hljs-number">1</span></span> param reception_number <span class="hljs-number"><span class="hljs-number">5501</span></span> param fastto_ckp <span class="hljs-number"><span class="hljs-number">2</span></span> param ckp_number <span class="hljs-number"><span class="hljs-number">5604</span></span> param fastto_fax <span class="hljs-number"><span class="hljs-number">3</span></span> param fax_number <span class="hljs-number"><span class="hljs-number">5555</span></span> param waiting_time <span class="hljs-number"><span class="hljs-number">20</span></span> param max_try <span class="hljs-number"><span class="hljs-number">3</span></span> param file_noanswer flash:en_noanswer.au param file_after flash:en_after.au param file_noexist flash:en_noexist.au param file_busy flash:en_busy.au param file_welcome flash:en_welcome.au param file_onhold flash:music-on-hold.au param file_noworking flash:en_takenumber2.au param file_takenumber flash:en_takenumber2.au</code> </pre><br>  <b>Second</b> , connect <i><b>service</b></i> to <b><i>dial-peer</i></b> : <br><pre> <code class="python hljs">dial-peer voice <span class="hljs-number"><span class="hljs-number">200</span></span> pots description -= ISP Beeline - INcoming call to number <span class="hljs-number"><span class="hljs-number">3300100</span></span> =- service voicemunu incoming called-number <span class="hljs-number"><span class="hljs-number">3300100</span></span></code> </pre><br>  Thus, when you receive a call to the number 3300100, our voice menu <b><i>voicemunu</i></b> will be called. <br><br><h1>  9) Full version of the script </h1><br>  Above only the main functions of the script were considered, then the full text, keep in mind, this is practically the simplest option: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">####################################################### # Cisco IVR TCL script by Konovalov DA v.2 ####################################################### # #    # debug voip application script #    ( ,    ) # debug voip ivr # #       : # param allowed_pattern 5[5-7].. # param fastto_reception 1 # param reception_number 5501 # param fastto_ckp 2 # param ckp_number 5604 # param fastto_fax 3 # param fax_number 5555 # param waiting_time 20 # param max_try 3 # param file_welcome flash:en_welcome.au # param file_takenumber flash:en_takenumber.au # param file_after flash:en_after.au # param file_busy flash:en_busy.au # param file_noexist flash:en_noexist.au # param file_noanswer flash:en_noanswer.au # param file_onhold flash:music-on-hold.au # param file_noworking flash:music-on-hold.au #   proc init { } { puts "\n proc Init start" global param } #   proc init_perCallVars { } { global pattern global numbers global playng_files #####  #       ,    .... - 4   if {[infotag get cfg_avpair_exists allowed_pattern]} { set pattern(1) [string trim [infotag get cfg_avpair allowed_pattern]] puts "\n\n IVR - Allowed pattern set as: $pattern(1) \n\n" } else { set pattern(1) .... puts "\n\n IVR - Allowed pattern set as DEFAULT: $pattern(1) \n\n" } ##### #.        ,     0000 if {[infotag get cfg_avpair_exists reception_number]} { set numbers(reception) [string trim [infotag get cfg_avpair reception_number]] puts "\n\n IVR - reception number set as: $numbers(reception) \n\n" } else { set numbers(reception) 0000 puts "\n\n IVR - reception number set as DEFAULT: $numbers(reception) \n\n" } # if {[infotag get cfg_avpair_exists ckp_number]} { set numbers(ckp) [string trim [infotag get cfg_avpair ckp_number]] puts "\n\n IVR - ckp number set as: $numbers(ckp) \n\n" } else { set numbers(ckp) 0000 puts "\n\n IVR - ckp number set as DEFAULT: $numbers(ckp) \n\n" } # if {[infotag get cfg_avpair_exists fax_number]} { set numbers(fax) [string trim [infotag get cfg_avpair fax_number]] puts "\n\n IVR - fax number set as: $numbers(fax) \n\n" } else { set numbers(fax) 0000 puts "\n\n IVR - fax number set as DEFAULT: $numbers(fax) \n\n" } #    if {[infotag get cfg_avpair_exists fastto_reception]} { set numbers(fast_reception) [string trim [infotag get cfg_avpair fastto_reception]] puts "\n\n IVR - fast to reception set as: $numbers(fast_reception) \n\n" } else { set numbers(fast_reception) 1 puts "\n\n IVR - fast to reception set as DEFAULT: $numbers(fast_reception) \n\n" } #    if {[infotag get cfg_avpair_exists fastto_ckp]} { set numbers(fast_ckp) [string trim [infotag get cfg_avpair fastto_ckp]] puts "\n\n IVR - fast to ckp set as: $numbers(fast_ckp) \n\n" } else { set numbers(fast_ckp) 2 puts "\n\n IVR - fast to ckp set as DEFAULT: $numbers(fast_ckp) \n\n" } #    if {[infotag get cfg_avpair_exists fastto_fax]} { set numbers(fast_fax) [string trim [infotag get cfg_avpair fastto_fax]] puts "\n\n IVR - fast to fax set as: $numbers(fast_fax) \n\n" } else { set numbers(fast_fax) 3 puts "\n\n IVR - fast to fax set as DEFAULT: $numbers(fast_fax) \n\n" } #    (       ) if {[infotag get cfg_avpair_exists waiting_time]} { set numbers(waiting_time) [string trim [infotag get cfg_avpair waiting_time]] puts "\n\n IVR - wait number set as: $numbers(waiting_time) \n\n" } else { set numbers(waiting_time) 10 puts "\n\n IVR - wait number set as DEFAULT: $numbers(waiting_time) \n\n" } #    ,        if {[infotag get cfg_avpair_exists max_try]} { set numbers(max_try) [string trim [infotag get cfg_avpair max_try]] puts "\n\n IVR - max try set as: $numbers(max_try) \n\n" set numbers(cur_try) 0 } else { set numbers(max_try) 5 puts "\n\n IVR - max try set as DEFAULT: $numbers(max_try) \n\n" set numbers(cur_try) 0 } ##### ,    #  if {[infotag get cfg_avpair_exists file_welcome]} { set playng_files(welcome) [string trim [infotag get cfg_avpair file_welcome]] puts "\n\n IVR - file_welcome set as: $playng_files(welcome) \n\n" } else { #   ,       1 set playng_files(welcome) %s1 puts "\n\n IVR - file_welcome set as DEFAULT: $playng_files(welcome) \n\n" } #     if {[infotag get cfg_avpair_exists file_takenumber]} { set playng_files(takenumber) [string trim [infotag get cfg_avpair file_takenumber]] puts "\n\n IVR - file_takenumber set as: $playng_files(takenumber) \n\n" } else { #   ,       1 set playng_files(takenumber) %s1 puts "\n\n IVR - file_takenumber set as DEFAULT: $playng_files(takenumber) \n\n" } # "  " if {[infotag get cfg_avpair_exists file_after]} { set playng_files(callafter) [string trim [infotag get cfg_avpair file_after]] puts "\n\n IVR - file_after set as: $playng_files(callafter) \n\n" } else { #   ,       1 set playng_files(callafter) %s1 puts "\n\n IVR - file_after set as DEFAULT: $playng_files(callafter) \n\n" } # " " if {[infotag get cfg_avpair_exists file_busy]} { set playng_files(busy) [string trim [infotag get cfg_avpair file_busy]] puts "\n\n IVR - file_busy set as: $playng_files(busy) \n\n" } else { #   ,       1 set playng_files(busy) %s1 puts "\n\n IVR - file_busy set as DEFAULT: $playng_files(busy) \n\n" } # "  " if {[infotag get cfg_avpair_exists file_noexist]} { set playng_files(noexist) [string trim [infotag get cfg_avpair file_noexist]] puts "\n\n IVR - file_noexist set as: $playng_files(noexist) \n\n" } else { #   ,       1 set playng_files(noexist) %s1 puts "\n\n IVR - file_noexist set as DEFAULT: $playng_files(noexist) \n\n" } # "  /" if {[infotag get cfg_avpair_exists file_toreception]} { set playng_files(toreception) [string trim [infotag get cfg_avpair file_toreception]] puts "\n\n IVR - file_toreception set as: $playng_files(toreception) \n\n" } else { #   ,       1 set playng_files(toreception) %s1 puts "\n\n IVR - file_toreception set as DEFAULT: $playng_files(toreception) \n\n" } # "  ,  " if {[infotag get cfg_avpair_exists file_noanswer]} { set playng_files(noanswer) [string trim [infotag get cfg_avpair file_noanswer]] puts "\n\n IVR - file_noanswer set as: $playng_files(noanswer) \n\n" } else { #   ,       1 set playng_files(noanswer) %s1 puts "\n\n IVR - file_noanswer set as DEFAULT: $playng_files(noanswer) \n\n" } # ,      if {[infotag get cfg_avpair_exists file_onhold]} { set playng_files(onhold) [string trim [infotag get cfg_avpair file_onhold]] puts "\n\n IVR - file_onhold set as: $playng_files(onhold) \n\n" } else { #   ,       1 set playng_files(onhold) %s1 puts "\n\n IVR - file_onhold set as DEFAULT: $playng_files(onhold) \n\n" } # ,       if {[infotag get cfg_avpair_exists file_noworking]} { set playng_files(noworking) [string trim [infotag get cfg_avpair file_noworking]] puts "\n\n IVR - file_noworking set as: $playng_files(noworking) \n\n" } else { #   ,       1 set playng_files(noworking) %s1 puts "\n\n IVR - file_noworking set as DEFAULT: $playng_files(noworking) \n\n" } } proc GetDate { } { global workingtime # set houris [clock format [clock seconds] -format %H] #  set dayis [clock format [clock seconds] -format %A] #   if {$houris &gt; 17 || $houris &lt; 8 || $dayis=="Sunday" || $dayis=="Saturday"} { set workingtime 0 } else { set workingtime 1 } } #   proc Play_Welcome { } { puts "\n\n IVR - proc Play_Welcome start \n\n" global playng_files global param global pattern global numbers global workingtime # ,     init_perCallVars #  GetDate #      ,   if {$workingtime} { set after_welcome $playng_files(takenumber) } else { set after_welcome $playng_files(noworking) } #     set param(interruptPrompt) true set param(abortKey) * set param(terminationKey) # #   leg setupack leg_incoming leg proceeding leg_incoming leg connect leg_incoming #        leg collectdigits leg_incoming param pattern #    ,     #  param(interDigitTimeout),    #  ev_collectdigits_done media play leg_incoming %s500 $playng_files(welcome) $after_welcome $playng_files(onhold) # ,      ev_named_timer timer start named_timer $numbers(waiting_time) t1 } #    proc Play_TakeNumber { } { puts "\n\n IVR - proc Play_TakeNumber start \n\n" global playng_files global numbers global param global pattern #       if {$numbers(cur_try) &lt;= $numbers(max_try)} { puts "\n\n IVR - proc Play_TakeNumber current try is: $numbers(cur_try) \n\n" incr numbers(cur_try) #        leg collectdigits leg_incoming param pattern #   media play leg_incoming $playng_files(takenumber) # ,      ev_named_timer timer start named_timer $numbers(waiting_time) t1 #    $numbers(max_try) -  } else { fsm setstate CALLDISCONNECTED media play leg_incoming $playng_files(callafter) } } #     proc GoToReception { } { puts "\n\n IVR - proc GoToReception start \n\n" global numbers #   media stop leg_incoming #  fsm setstate CALLCONNECTED set digit $numbers(reception) # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit } #        proc CheckDestanation { } { puts "\n\n IVR - proc CheckDestanation start \n\n" global playng_files global numbers global digit #   media stop leg_incoming #   set status [infotag get evt_status] set digit [infotag get evt_dcdigits] #     #    ,    $numbers(fast_reception), # digit      $digit   CheckCallersAndConnect, #     CALLCONNECTED, #  ,    ev_setup_done (   ) #    CallIsConnect if {$digit == $numbers(fast_reception)} { puts "\n\n IVR - proc CheckDestanation digit = $digit\nGoing to next reception \n\n" fsm setstate CALLCONNECTED set digit $numbers(reception) # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit #    ,    $numbers(fast_ckp),    # CheckCallersAndConnect } elseif {$digit == $numbers(fast_ckp)} { puts "\n\n IVR - proc CheckDestanation digit = $digit\nGoing to next CKP \n\n" fsm setstate CALLCONNECTED set digit $numbers(ckp) # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit #    ,    $numbers(fast_fax),    # CheckCallersAndConnect } elseif {$digit == $numbers(fast_fax)} { puts "\n\n IVR - proc CheckDestanation digit = $digit\nGoing to next fax \n\n" fsm setstate CALLCONNECTED set digit $numbers(fax) # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit #  = cd_004 (   ) -     # CheckCallersAndConnect } elseif {$status == "cd_004"} { puts "\n\n IVR - proc CheckDestanation status = $status digit = $digit \n\n" fsm setstate CALLCONNECTED # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit #  = cd_005 (  dial plan) -     # CheckCallersAndConnect } elseif {$status == "cd_005"} { puts "\n\n IVR - proc CheckDestanation status = $status digit = $digit \n\n" fsm setstate CALLCONNECTED # $digit   CheckCallersAndConnect CheckCallersAndConnect $digit #  = cd_006 (   ) -    $playng_files(noexist) #    TRYAGAIN,       ev_media_done #(   )   Play_TakeNumber } elseif {$status == "cd_006"} { puts "\n\n IVR - proc CheckDestanation status = $status digit = $digit \n\n" fsm setstate TRYAGAIN media play leg_incoming $playng_files(noexist) #       TORECEPTION,     #  ev_media_done (   )   GoToReception } else { # "    " fsm setstate TORECEPTION media play leg_incoming $playng_files(toreception) puts "\n\n IVR - proc CheckDestanation status = $status \n\n" } } # ,  ,     proc CheckCallersAndConnect {digit} { puts "\n\n IVR - proc CheckCallersAndConnect start \n\n" set callernumber [infotag get leg_ani] switch $callernumber { "9120000000" {set callInfo(displayInfo) "Director(mobile)"} "9130000000" {set callInfo(displayInfo) "Buhgalter(mobile)"} default {} } leg setup $digit callInfo leg_incoming } #          proc CallIsConnect { } { puts "\n\n IVR - proc CallIsConnect start \n\n" global playng_files #   status set status [infotag get evt_status] #   ls_000 (    ),    CALLACTIVE if {$status == "ls_000"} { fsm setstate CALLACTIVE #   ls_002 (    ),     } elseif {$status == "ls_002"} { fsm setstate TRYAGAIN media play leg_incoming $playng_files(noanswer) #  -  ,     } elseif {$status == "ls_004" || $status == "ls_005" || $status == "ls_006"} { fsm setstate TRYAGAIN media play leg_incoming $playng_files(noexist) #   ls_007 ( ),     } elseif {$status == "ls_007"} { fsm setstate TRYAGAIN media play leg_incoming $playng_files(busy) } } #   proc AbortCall { } { puts "\n\n IVR - proc AbortCall start \n\n" call close } #  init #init_perCallVars #         #        #       ev_disconnected,  AbortCall set ivr_fsm(any_state,ev_disconnected) "AbortCall, same_state" #   CALLCOMES   ev_setup_indication ( ) # Play_Welcome,     same_state (..  ) set ivr_fsm(CALLCOMES,ev_setup_indication) "Play_Welcome, same_state" #   CALLCOMES   ev_collectdigits_done (  ) # CheckDestanation,     set ivr_fsm(CALLCOMES,ev_collectdigits_done) "CheckDestanation, same_state" #   CALLCOMES   ev_named_timer (    ) # GoToReception,     set ivr_fsm(CALLCOMES,ev_named_timer) "GoToReception, same_state" #   TORECEPTION   ev_media_done (  ) # GoToReception,     set ivr_fsm(TORECEPTION,ev_media_done) "GoToReception, same_state" #         set ivr_fsm(TRYAGAIN,ev_media_done) "Play_TakeNumber, TRYING" set ivr_fsm(TRYING,ev_collectdigits_done) "CheckDestanation, same_state" set ivr_fsm(TRYING,ev_named_timer) "GoToReception, same_state" #   CALLCONNECTED   ev_setup_done #(/    )  CallIsConnect,     set ivr_fsm(CALLCONNECTED,ev_setup_done) "CallIsConnect, same_state" #     set ivr_fsm(CALLACTIVE,ev_disconnected) "AbortCall, CALLDISCONNECTED" set ivr_fsm(CALLDISCONNECTED,ev_disconnected) "AbortCall, same_state" set ivr_fsm(CALLDISCONNECTED,ev_media_done) "AbortCall, same_state" set ivr_fsm(CALLDISCONNECTED,ev_disconnect_done) "AbortCall, same_state" fsm define ivr_fsm CALLCOMES</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/265453/">https://habr.com/ru/post/265453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265443/index.html">Dijkstra's algorithm and our perishable world</a></li>
<li><a href="../265445/index.html">Windows 10 through 10. Issue # 1. How to increase the visibility and frequency of installations</a></li>
<li><a href="../265447/index.html">Did spammers appear in Telegram?</a></li>
<li><a href="../265449/index.html">How I use PostCSS</a></li>
<li><a href="../265451/index.html">CSS3 hover effects. Step by step tutorial</a></li>
<li><a href="../265455/index.html">Reversible Cyrillic transliteration</a></li>
<li><a href="../265457/index.html">Protection of negotiations. Anti-bugs and field indicators</a></li>
<li><a href="../265459/index.html">Depla: Nginx, Puma and Mina</a></li>
<li><a href="../265461/index.html">Another way to automatically invoke unit tests in the C language</a></li>
<li><a href="../265463/index.html">"I came to eat, and stayed to study at the Technopark." Student stories from our educational projects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>