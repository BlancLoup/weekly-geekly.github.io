<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of the xPDOObject :: save () + Transaction Method</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most recently, Sergei Prokhorov aka proxyfabio wrote an article Validation of objects + transactions . A little this topic was discussed here . From m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features of the xPDOObject :: save () + Transaction Method</h1><div class="post__text post__text-html js-mediator-article">  Most recently, Sergei Prokhorov aka <a href="http://habrahabr.ru/users/proxyfabio/" class="user_link">proxyfabio</a> wrote an article <a href="https://modxclub.ru/topics/validacziya-obektov-tranzakczii-1837.html">Validation of objects + transactions</a> .  A little this topic was <a href="https://modx.pro/help/6309/">discussed here</a> .  From myself I want to add that this topic is extremely important, and today it is one of the main problems in the development of large projects on MODX Revolution. <br><br>  <i>Here I will immediately ask you not to start anything like ‚ÄúIf you are doing major projects, do not do them on MODX, take the blah blah blah‚Äù.</i>  <i>We did major projects, and not only on MODX.</i>  <i>On MODX, it is quite possible to do large projects, and today there are only a couple of weak points that we rule on individual projects, otherwise the MODX is 98% suitable for the development of large projects.</i> <a name="habracut"></a><br><br>  So, one of these serious problems is associated with the xPDOObject :: save () method (called when saving xPDO objects).  The essence of this problem is that inside it, the method of saving the associated objects xPDOObject :: _ saveRelatedObjects () <b>twice</b> works.  <a href="https://github.com/modxcms/revolution/blob/36a662675acdb23d158f9879e16dfc979e56314c/core/xpdo/om/xpdoobject.class.php">One</a> and <a href="https://github.com/modxcms/revolution/blob/36a662675acdb23d158f9879e16dfc979e56314c/core/xpdo/om/xpdoobject.class.php">two</a> .  This is done in order to expose the primary and secondary keys for these related objects (see the <a href="https://ilyaut.ru/xpdo/xpdo-for-dummies-part-4/">reference material</a> from Ilya Utkin).  I will explain in more detail by example.  Here is the code: <br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $user_data = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"username"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"test"</span></span>, ); $profile_data = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $user = $modx-&gt;newObject(<span class="hljs-string"><span class="hljs-string">'modUser'</span></span>, $user_data); $user-&gt;Profile = $modx-&gt;newObject(<span class="hljs-string"><span class="hljs-string">'modUserProfile'</span></span>, $profile_data); $user-&gt;save(); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;pre&gt;'</span></span>; print_r($user-&gt;toArray()); print_r($user-&gt;Profile-&gt;toArray());</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, the essence of this code is certainly understandable to many, but let's focus on the details.  When we created two new objects ($ user and $ user-&gt; Profile), they do not yet have aisers until they are saved.  But having saved only the $ user object, we get the saved $ user-&gt; Profile object at the output.  It‚Äôs also clear why, Ilya describes all this in his article.  But a question that doesn‚Äôt quite hang out is ‚Äúhow does xPDO" know "what id of the $ user object to assign this id as $ modx-&gt; Profile-&gt; internalKey?".  To do this, again, let's go over the method code xPDO :: save (); <br><br>  Here we have the <a href="https://github.com/modxcms/revolution/blob/36a662675acdb23d158f9879e16dfc979e56314c/core/xpdo/om/xpdoobject.class.php">first call to the $ user -&gt; _ saveRelatedObjects () method</a> .  At this moment, the $ user object has not yet been saved (not written to the database), it has no id yet.  $ user-&gt; Profile is also not saved and has neither id nor internalKey.  Moving on to calling the $ user -&gt; _ saveRelatedObjects () method, we see that the <a href="https://github.com/modxcms/revolution/blob/36a662675acdb23d158f9879e16dfc979e56314c/core/xpdo/om/xpdoobject.class.php">related objects are</a> <a href="https://github.com/modxcms/revolution/blob/36a662675acdb23d158f9879e16dfc979e56314c/core/xpdo/om/xpdoobject.class.php">being</a> searched and <a href="https://github.com/modxcms/revolution/blob/36a662675acdb23d158f9879e16dfc979e56314c/core/xpdo/om/xpdoobject.class.php">saved</a> (xPDO :: _ saveRelatedObject () method).  Here I will clarify once again that we are saving the $ user object for which the $ user-&gt; Profile object is related.  And it is here that it turns out that in fact the object $ user-&gt; Profile will be preserved before the object $ user.  Why?  Because in a call to $ user -&gt; _ saveRelatedObject ($ user-&gt; Profile), the <a href="https://github.com/modxcms/revolution/blob/36a662675acdb23d158f9879e16dfc979e56314c/core/xpdo/om/xpdoobject.class.php">method $ user-&gt; Profile-&gt; save (</a> ) will be <a href="https://github.com/modxcms/revolution/blob/36a662675acdb23d158f9879e16dfc979e56314c/core/xpdo/om/xpdoobject.class.php">called</a> , and since there are currently no related objects for $ user-&gt; Profile, it will be written to the database.  And what do we get here?  $ user-&gt; Profile has already been saved and it has its own id, but the $ user object has no id (because it has not been saved yet).  For this reason, the secondary key $ user-&gt; Profile-&gt; internalKey is still empty. <br><br>  OK, we figured it out, we‚Äôre going on.  And then we have to save the object itself $ user with writing it to the database and assigning it an id.  Everything, record is made.  Now we both have these id-objects, but still there is no value for $ user-&gt; Profile-&gt; internalKey.  This is exactly how the <a href="https://github.com/modxcms/revolution/blob/36a662675acdb23d158f9879e16dfc979e56314c/core/xpdo/om/xpdoobject.class.php">$ user -&gt; _ saveRelatedObjects ()</a> method is called again.  Now that the associated $ user-&gt; Profile object is saved, it will be able to get the value of $ user-&gt; id and assign it as $ user-&gt; Profile-&gt; internalKey and save it. <br><br>  Yes, I agree that all this is very confusing (and I explain it even more confusing), but there is logic in all this.  And, actually, for this reason I see such persistent use of MyIsam instead of innoDB.  Why?  Yes, because it simply cannot work at innoDB.  And just now we will analyze the problem, and not the principle of operation.  I‚Äôll say right away that a complete understanding of all this requires a good understanding of MySQL, namely the understanding of transactions, primary and foreign key, etc. <br><br>  Let's configure our database more correctly, namely, we will configure primary and secondary keys at the level of the database itself.  To do this, do the following: <br><br><div class="spoiler">  <b class="spoiler_title">1. Translate tables into the innoDB engine.</b> <div class="spoiler_text"> <a href=""><img src="https://habrastorage.org/files/257/fbd/83f/257fbd83f3b949c58afe730cfa7435e5.jpg"></a> <br><br> <a href=""><img src="https://habrastorage.org/files/9f7/978/683/9f797868368c497b8efb4dd8b934c916.jpg"></a> <br></div></div><br><br>  2. In the modx_users table, the id field is int (10) unsigned, and in modx_users_attributes the internalKey int (10) field (not unsigned).  Because of this, we simply cannot configure the secondary key, because the data types in the columns of both tables must match completely. <br><div class="spoiler">  <b class="spoiler_title">Change to unsigned</b> <div class="spoiler_text"> <a href=""><img src="https://habrastorage.org/files/158/3f3/46a/1583f346aff74ad29d493584e4928078.jpg"></a> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">3 Create a secondary key</b> <div class="spoiler_text"> <a href=""><img src="https://habrastorage.org/files/0c3/56e/89b/0c356e89b04c445d912740937568f018.jpg"></a> <br><br> <a href=""><img src="https://habrastorage.org/files/afe/b24/4af/afeb244afc84482c9cfd8fe50b0277f2.jpg"></a> <br></div></div><br><br>  If you did not get any errors while saving the secondary key, then great!  But there are a few mistakes you can get.  The most common ones are: <br>  1. Data types do not match. <br>  2. There is no primary record for the secondary record (that is, for example, you have a record in modx_user_attributes with internalKey = 5, and there are no record in modx_users with id = 5). <br><br>  And now let's look at the essence of the problem on an example.  To do this, execute <a href="http://modx.com/extras/package/console">the</a> following code in the <a href="http://modx.com/extras/package/console">console</a> : <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $user_data = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"username"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"test_"</span></span>. rand(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">100000</span></span>), ); $profile_data = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"email"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"test@local.host"</span></span>, ); $user = $modx-&gt;newObject(<span class="hljs-string"><span class="hljs-string">'modUser'</span></span>, $user_data); $user-&gt;Profile = $modx-&gt;newObject(<span class="hljs-string"><span class="hljs-string">'modUserProfile'</span></span>, $profile_data); $user-&gt;save(); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;pre&gt;'</span></span>; print_r($user-&gt;toArray()); print_r($user-&gt;Profile-&gt;toArray());</code> </pre><br><br>  Now we have not seen any problem, everything is preserved without comment. <div class="spoiler">  <b class="spoiler_title">Approximate output on successful execution</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [id] =&gt; <span class="hljs-number"><span class="hljs-number">59</span></span> [username] =&gt; test_65309 [password] =&gt; [cachepwd] =&gt; [class_key] =&gt; modUser [active] =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> [remote_key] =&gt; [remote_data] =&gt; [hash_class] =&gt; hashing.modPBKDF2 [salt] =&gt; [primary_group] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [session_stale] =&gt; [sudo] =&gt; ) <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [id] =&gt; <span class="hljs-number"><span class="hljs-number">54</span></span> [internalKey] =&gt; <span class="hljs-number"><span class="hljs-number">59</span></span> [fullname] =&gt; [email] =&gt; test@local.host [phone] =&gt; [mobilephone] =&gt; [blocked] =&gt; [blockeduntil] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [blockedafter] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [logincount] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [lastlogin] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [thislogin] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [failedlogincount] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [sessionid] =&gt; [dob] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [gender] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [address] =&gt; [country] =&gt; [city] =&gt; [state] =&gt; [zip] =&gt; [fax] =&gt; [photo] =&gt; [comment] =&gt; [website] =&gt; [extended] =&gt; )</code> </pre><br></div></div><br><br>  And now let's change our code a bit: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $user_data = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"username"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"test_"</span></span>. rand(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">100000</span></span>), ); $profile_data = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"email"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"test@local.host"</span></span>, ); $user = $modx-&gt;newObject(<span class="hljs-string"><span class="hljs-string">'modUser'</span></span>, $user_data); $user-&gt;Profile = $modx-&gt;newObject(<span class="hljs-string"><span class="hljs-string">'modUserProfile'</span></span>, $profile_data); <span class="hljs-comment"><span class="hljs-comment">//   id  .     - id, ,      . $user-&gt;id = 40; $user-&gt;save(); print '&lt;pre&gt;'; print_r($user-&gt;toArray()); print_r($user-&gt;Profile-&gt;toArray());</span></span></code> </pre><br><br>  What do we get now when executing this code? <br><br>  1. SQL error message <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [<span class="hljs-number"><span class="hljs-number">0</span></span>] =&gt; <span class="hljs-number"><span class="hljs-number">23000</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] =&gt; <span class="hljs-number"><span class="hljs-number">1452</span></span> [<span class="hljs-number"><span class="hljs-number">2</span></span>] =&gt; Cannot add <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> update a child row: a foreign key constraint fails (`shopmodxbox_test2`.`modx_user_attributes`, CONSTRAINT `modx_user_attributes_ibfk_1` FOREIGN KEY (`internalKey`) REFERENCES `modx_users` (`id`)) )</code> </pre><br><br>  2. Both of our objects are still preserved and have the correct id and internalKey. <br><br>  Why it happens?  When saving a secondary object, xPDO <a href="https://github.com/modxcms/revolution/blob/36a662675acdb23d158f9879e16dfc979e56314c/core/xpdo/om/xpdoobject.class.php">checks if there is a primary key value</a> , and only if it exists, then sets its value as a secondary key and saves this object.  In our case, we manually specified the primary key id and the secondary object managed to get its value and tried to write to the database, but since the primary record is actually not there, we get a SQL error about the inability to write the secondary record without the primary object.  But the preservation of the primary object on this is not interrupted.  After that, the primary $ user object is successfully written to the database, and when you try to save the associated $ user-&gt; Profile object again, everything is normally saved, since there is a primary record. <br><br>  <b>From all this two conclusions follow.</b> <br><br>  1. When saving related objects, it is impossible to track the errors of saving secondary objects and somehow react to them.  That is, it is never possible to say with certainty why the secondary object was not saved (whether or not the primary object is still available, and it can later register when the xPDOObject :: _ saveRelatedObjects () method is called again, or if there is any unique key that conflicts the record cannot be recorded in principle, or validation at the level of the mapa did not pass there, etc., etc.). <br><br>  2. For this reason, it is impossible to fully use transactions. <br><br>  <b>Possible solution to this problem.</b> <br><br>  We see the solution to this problem in distinguishing the first and second calls of the xPDOObject :: _ saveRelatedObjects () method by the types of related objects, namely, the first call is for primary objects, and the second call is for secondary objects.  In this case, there will definitely be no confusion with the keys, and if the object has not been preserved for some reason, then this will definitely indicate an error and it will be possible to interrupt the save process (including rollback of transactions). </div><p>Source: <a href="https://habr.com/ru/post/265485/">https://habr.com/ru/post/265485/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265473/index.html">A bit about the underground data center Netflix</a></li>
<li><a href="../265475/index.html">Russian server market: real ways to save</a></li>
<li><a href="../265477/index.html">Tab module on es6 / es2015 without jQuery and other dependencies</a></li>
<li><a href="../265481/index.html">How company executives understand what is happening in the data center</a></li>
<li><a href="../265483/index.html">Using Microsoft Azure for scalability and resiliency of the CloudStats.me project</a></li>
<li><a href="../265487/index.html">Why gaming performance is not just average FPS</a></li>
<li><a href="../265489/index.html">Co-clustering: Segmentation of data along and across</a></li>
<li><a href="../265491/index.html">We do our iterator</a></li>
<li><a href="../265495/index.html">Corporate immunity: we create a system of centralized management of network security in the company and its branches</a></li>
<li><a href="../265497/index.html">Telegram-like animated placeholder for HTML inputs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>