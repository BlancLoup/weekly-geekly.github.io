<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Where do we form a model for UI with Domain Driven Design? Performance comparison of various architectural solutions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Consider from a performance point of view, options for locating logic to populate a model for three-tier and four-tier architectures when using differ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Where do we form a model for UI with Domain Driven Design? Performance comparison of various architectural solutions</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/305/60f/b36/30560fb360d44db3a880901bdf4733ef.jpg"></div><br>  Consider from a performance point of view, options for locating logic to populate a model for three-tier and four-tier architectures when using different interaction technologies between levels on the .NET stack (Web API, Web API OData, WCF net.tcp, WCF Data Services). <br><br><a name="habracut"></a><br><h3>  Preamble </h3><br><br>  Often, when automating something, an approach to designing software based on a <b>domain is used</b> , the so-called <b>Domain Driven Design</b> .  The essence of this approach is the creation of a program model of the domain containing the description of the objects of the domain, their relationships and possible operations with them.  The presence of such a model makes it convenient to automate complex business processes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As Fowler wrote in <a href="http://www.ozon.ru/context/detail/id/1616782/">"Enterprise Software Architecture"</a> <br><br><blockquote>  The value of the domain model is that, having mastered the approach, you have at your disposal a number of techniques that allow you to get along with the increasing complexity of business logic in a ‚Äúcivilized‚Äù way. </blockquote><br><br>  This design approach is object-oriented, so as a result we get a set of repository classes for performing CRUD and other operations on domain objects and DTO for transferring data from these objects. <br><br>  Often these classes are implemented as a web service and allocated to a separate level (let's call it AppServer), with which different levels of display interact - web servers, mobile clients, etc.  A complete implementation of this approach can be seen in the Pluralsight <a href="https://www.pluralsight.com/courses/building-multi-client-end-to-end-soa-angular">Building End-to-End Multi-Client Service Oriented Applications</a> course. <br><br><div class="spoiler">  <b class="spoiler_title">Remark</b> <div class="spoiler_text">  Naming the course as it hints that they implement the <abbr title="Service-Oriented Architecture">SOA</abbr> architecture.  It seems to me that they are implementing it with great stretch, because, for example, in the book <a href="https://blogs.technet.microsoft.com/isv_team/2010/09/16/microsoft-patterns-practices/">‚ÄúMicrosoft's Guide to Designing Application Architecture‚Äù</a> , the main feature of the SOA architecture is clearly marked - service autonomy, the possibility of their distributed deployment, independent maintenance and development.  IMHO service must have its own independent data storage to be part of SOA.  The guys from Pluralsight just have the access facade to the domain model implemented as a set of WCF services, nothing more. </div></div><br><br>  In other cases, these classes are simply a separate layer with which the presentation layer interacts. <br><br>  However, almost always DTOs returned by such classes cannot serve as a model for the View UI, since  contains either too much or too little data.  This is partly due to the fact that the display levels are different (mobile clients, web servers) and they need different UI, although they work with the same domain model.  Partly by the fact that just according to the requirements on a specific screen it is necessary to show the data of several objects of the domain. <br><br>  Thus, it is obvious that the models for the UI are not displayed 1 in 1 on the DTO used to store the data of the domain objects, and therefore they need to be formed somewhere. <br><br><h3>  And where to form them and why is it important? </h3><br><br>  As it turns out, the place of their formation, as well as the inter-level interaction technologies used in this process, can easily make a good system a bad one in the eyes of users. <br><br><div class="spoiler">  <b class="spoiler_title">Remark</b> <div class="spoiler_text">  It is believed that a good automation system is different from a bad one in that it allows users to do their work <u>faster than before</u> . </div></div><br><br>  Consider, from a performance point of view, the following options for forming a model for display in the UI: <br><br>  <i>Three-tier architecture (browser + webserver + database server)</i> <br><ul><li>  The model is formed on the client </li><li>  The model is formed on the web server. </li></ul><br><br>  <i>Four-tier architecture (browser + webserver + appserver + database server)</i> <br><ul><li>  The model is formed on the web server. </li><li>  The model is formed on the appserver </li></ul><br><br>  So, we have 4 basic options. <br><br>  To make it more interesting, we will use different technologies from the .NET stack for interaction between the levels. <br><br>  And in order to make it very interesting - in the form of a model we will transfer the ‚Äúreal‚Äù amount of data (~ 150kb in uncompressed form), and the browser will be placed away from the main stand (good, the size of our Motherland allows it). <br><br><h3>  Used technologies and tools </h3><br>  The browser is Chrome 48, the model from the web server will be received in JSON using JQuery 2. <br><br>  Web server - IIS 6.1, the model will render using Web API 2 (in one of the WebAPI OData v3 scenarios) using gzip compression.  JSON serializer standard.  The data will be received either from Appserver (in a four-tier architecture), or directly from the database using EF 6 (in a three-tier one). <br><br>  Appserver - IIS 6.1, data will be given either using WCF Service (Net.TCP binding), or using WCF DataService v3 (without compression).  C DB will communicate using EF 6. <br><br>  Database server - MS SQL 2014 standart. <br><br><h3>  Level distribution by gland </h3><br>  Browser, web server, appserver, database server - all on different physical machines. <br><br>  Iron configuration: <br><ul><li>  Browser - the usual office computer based on Core i5 </li><li>  Web server - virtual server based on Xeon E5504, 12 GB </li><li>  Appserver - virtual server based on Xeon E5504, 16 GB </li><li>  Database server - virtual server based on Xeon E5-2620, 32 GB, Raid 10 SAS </li></ul><br><br>  Web server, appserver, database server - in one network, geographically in Moscow.  Connected by 10TB network.  Webserver sticks to the Internet for Microsoft Forefront TMG. <br><br>  The browser is outside, geographically in Moscow and Ufa (we will consider two options).  Connected to the web server by the usual "good" Internet via WIFI. <br><br><h3>  Data </h3><br>  The database contains a simple table (Guid, Name) with 10 thousand data lines. <br><br>  To form a model from this label using EF, three sets of data of 1000 rows are taken starting from an arbitrary value (Skip, Take).  The first set is left unchanged, the second and third are filtered in the model's fill code.  The total size of the rows of three sets is 2000 objects or ~ 150 KB. <br><br>  Each data set is returned as a model.  In this case, the first set is obtained synchronously, and the second and third - asynchronously. <br><br>  Thus, both the database and the EF are present in us, but they contribute to the time of data acquisition in a minimum (since we test not the EF and not the database, but the architecture as a whole), but the size of the model is large. <br><br><h3>  What and how we measure </h3><br>  We measure the time in the browser between the beginning of the query model and the result in the form of javascript objects.  Rendering of results in the browser is present, but not measured. <br><br>  After rendering the model after waiting 1s, we repeat everything again. <br><br>  Thus, we make ~ 500 measurements and build a graph of the distribution of results as a percentage, depending on time. <br><br>  We will conduct two series of measurements simultaneously, placing the browsers geographically in different places (Moscow and Ufa) <br>  Measurements will be carried out during working hours when channels and servers are regularly loaded. <br><br><h3>  Test benches </h3><br>  Thus we form the following test benches <br><br><ul><li>  Four-tier architecture, the model is formed on the web server, the appserver is accessible via WCF DataService, the result is transmitted to the browser via the Web API </li><li>  Four-tier architecture, the model is formed on the web server, the appserver is available via the WCF service using the net.tcp protocol, the result is transmitted to the browser via the Web API </li><li>  Four-tier architecture, the model is formed on the appserver, which is accessible via the WCF service via the net.tcp protocol, the result is transmitted to the browser via the Web API </li><li>  Three-tier architecture, the model is formed on the web server, the result is transmitted to the browser via the Web API </li><li>  Three-tier architecture, the model is formed in the browser using a web server, accessible through the Odata Web API </li></ul><br><br>  Further description of each model and results, we go from the most brake to the fastest <br><br><h3>  Four-tier architecture, the model is formed on the web server, the appserver is accessible via WCF DataService, the result is transmitted to the browser via the Web API </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e1e/665/d06/e1e665d066c1423ab07601b2a39b5ed8.JPG"></div><br><h6>  Special features </h6><br>  Since the WCF DataService (which runs on top of the EF model) is used to access the application server, it is not necessary to write methods in this service to implement various data retrieval requests.  Requests can be made via URL, or using LINQ <br><br><div class="spoiler">  <b class="spoiler_title">Model Data Acquisition Code</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DocumentListController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { <span class="hljs-comment"><span class="hljs-comment">// GET: api/DocumentList/ public async Task&lt;DocumentListViewModel&gt; Get() { var result = new DocumentListViewModel(); var appServer = new DocumentsServiceHelper(); result.AllDocuments = await Task.Run(() =&gt; appServer.GetAllDocuments()); var data = await Task.WhenAll( Task.Run(() =&gt; appServer.GetEvenDocuments()), Task.Run(() =&gt; appServer.GetOddDocuments())); result.EvenDocuments = data[0]; result.OddDocuments = data[1]; return result; } } public class DocumentsServiceHelper { private const string DocumentsServiceUrl = @"http://xxx/appdataserver/documentsservice.svc/"; public DocumentItem[] GetAllDocuments() { var context = new Documents(new Uri(DocumentsServiceUrl)); var rnd = new Random(); return context.DocumentItems.OrderBy(x =&gt; x.Id).Skip(rnd.Next(0, 9000)).Take(1000).ToArray(); } public DocumentItem[] GetEvenDocuments() { var context = new Documents(new Uri(DocumentsServiceUrl)); var rnd = new Random(); return context.DocumentItems.OrderBy(x =&gt; x.Id).Skip(rnd.Next(0, 9000)).Take(1000).ToList().Where((x, i) =&gt; i % 2 != 0).ToArray(); } public DocumentItem[] GetOddDocuments() { var context = new Documents(new Uri(DocumentsServiceUrl)); var rnd = new Random(); return context.DocumentItems.OrderBy(x =&gt; x.Id).Skip(rnd.Next(0, 9000)).Take(1000).ToList().Where((x, i) =&gt; i % 2 == 0).ToArray(); } } }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Service code</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">System.ServiceModel.ServiceBehavior(IncludeExceptionDetailInFaults = true)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DocumentsService</span></span> : <span class="hljs-title"><span class="hljs-title">EntityFrameworkDataService</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Documents</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DataServiceConfiguration config</span></span></span><span class="hljs-function">)</span></span> { config.SetEntitySetAccessRule(<span class="hljs-string"><span class="hljs-string">"*"</span></span>, EntitySetRights.AllRead); config.DataServiceBehavior.MaxProtocolVersion = DataServiceProtocolVersion.V3; } }</code> </pre><br></div></div><br><br><h6>  results </h6><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1c3/219/78a/1c321978a13d476c81f6bc6f66bf1b69.JPG"></div><br>  As you can see, almost all requests fall in the interval of 850-1100 ms, and about 5% are executed more than 1.1s.  This is for Moscow.  For Ufa, the picture is worse. <br><br><h6>  Conclusion </h6><br>  WCF Data Services is not our option <br><br><h3>  Three-tier architecture, the model is formed in the browser using a web server, accessible through the Odata Web API </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c17/7ed/564/c177ed56439f4f4e8ecdd3dab223302a.JPG"></div><br><h6>  Description </h6><br>  Since the model is formed using the OData Web API (which also works on top of the EF model), to implement various data retrieval requests, it is not necessary to write methods in the Web API controller.  Requests can be made via URL. <br>  Since the model is formed in the browser, three Web API requests go to the web server, unlike all other scenarios, where there are only one such requests. <br><div class="spoiler">  <b class="spoiler_title">Model formation code (on Type Script)</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentItem</span></span></span><span class="hljs-class"> </span></span>{ Id: string; Name: string; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(_id: string, _name: string) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Id = _id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Name = _name; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentsController</span></span></span><span class="hljs-class"> </span></span>{ DocumentItems: DocumentItem[]; OddDocumentItems: DocumentItem[]; EvenDocumentItems: DocumentItem[]; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DocumentItems = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.EvenDocumentItems = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.OddDocumentItems = []; } public FillData(): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;any&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;any&gt;<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queryOne = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ExecuteQuery(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetQuery()) .then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: DocumentItem[]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DocumentItems = data; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queryTwo = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ExecuteQuery(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetQuery()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queryThree = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ExecuteQuery(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetQuery()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all([queryTwo, queryThree]); result .then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: DocumentItem[][]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.EvenDocumentItems = data[<span class="hljs-number"><span class="hljs-number">0</span></span>].filter(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, i, all</span></span></span><span class="hljs-function">) =&gt;</span></span> i % <span class="hljs-number"><span class="hljs-number">2</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.OddDocumentItems = data[<span class="hljs-number"><span class="hljs-number">1</span></span>].filter(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, i, all</span></span></span><span class="hljs-function">) =&gt;</span></span> i % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>); resolve(); }, reject); }, reject); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } private GetQuery(): string { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> random = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">9000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"$orderby=Id desc&amp;$skip="</span></span> + random + <span class="hljs-string"><span class="hljs-string">"&amp;$top=1000"</span></span>; } private ExecuteQuery(query: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;DocumentItem[]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uri = <span class="hljs-string"><span class="hljs-string">"odata/Documents?"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { $.getJSON(uri + query) .done(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> realData = $.map&lt;any, DocumentItem&gt;<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data.value, (x: any, i: number</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DocumentItem(x.Id, x.Name)); resolve(realData); }) .fail(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">jqXHR: JQueryXHR, textStatus: string, err: string</span></span></span><span class="hljs-function">) =&gt;</span></span> reject(err)); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } }</code> </pre><br></div></div><br><br>  On the server, the controller code is template (Web API 2 OData v3 Controller with actions using Entity Framework), I will not give it. <br><br><h6>  results </h6><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f10/29a/736/f1029a7365f4487a9a50ebbfa981d1ab.JPG"></div><br>  As you can see, almost all requests fall in the range of 200-350 ms for Moscow and 250-400 ms for Ufa, which is not so bad.  BUT, there are also slow queries, more than 800 ms (for Ufa such about 5%).  For the user, this will mean that the UI of the system works almost always quickly, but sometimes it will slow down.  This is very annoying. <br><br><h6>  Conclusion </h6><br>  This architecture is now fashionable.  And do not say that it is very slow.  But IMHO it is suitable only for intranets, only for powerful office machines and only for desktop applications UI.  Version, browser type - strongly influence the result.  Under IE, all of this works significantly slower, I'm not talking about mobile browsers. <br><br><h3>  Four-tier architecture, the model is formed on the web server, the appserver is available via the WCF service using the net.tcp protocol, the result is transmitted to the browser via the Web API </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e19/6cd/ef5/e196cdef5eb74637864af232c89f577f.JPG"></div><br><br><div class="spoiler">  <b class="spoiler_title">Controller Web API Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// GET: api/DocumentList/ public async Task&lt;DocumentListViewModel&gt; Get() { var result = new DocumentListViewModel(); var appServer = new DocumentsService.DocumentsServiceClient(); appServer.Open(); result.AllDocuments = await appServer.GetAllDocumentsAsync(); var even = appServer.GetEvenDocumentsAsync(); var odd = appServer.GetOddDocumentsAsync(); var data = await Task.WhenAll(even, odd); result.EvenDocuments = data[0]; result.OddDocuments = data[1]; appServer.Close(); return result; }</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Service code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DocumentsService</span></span> : <span class="hljs-title"><span class="hljs-title">IDocumentsService</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DocumentItem[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAllDocuments</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Documents()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.DocumentItems.OrderBy(x =&gt; x.Id).Skip(rnd.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">9000</span></span>)).Take(<span class="hljs-number"><span class="hljs-number">1000</span></span>).ToArray(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DocumentItem[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEvenDocuments</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Documents()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.DocumentItems.OrderBy(x =&gt; x.Id).Skip(rnd.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">9000</span></span>)).Take(<span class="hljs-number"><span class="hljs-number">1000</span></span>).ToList().Where((x, i) =&gt; i % <span class="hljs-number"><span class="hljs-number">2</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>).ToArray(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DocumentItem[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOddDocuments</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Documents()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.DocumentItems.OrderBy(x =&gt; x.Id).Skip(rnd.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">9000</span></span>)).Take(<span class="hljs-number"><span class="hljs-number">1000</span></span>).ToList().Where((x, i) =&gt; i % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>).ToArray(); } } }</code> </pre><br></div></div><br><br><h6>  Result </h6><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b08/454/ab5/b08454ab5be64e16b255133161c34e91.JPG"></div><br>  As you can see, almost all requests fall in the range of 100-200 ms for Moscow and 150-250ms for Ufa.  And, most importantly, there are no slow queries for Moscow, for Ufa - almost none. <br><br><h6>  Conclusion </h6><br>  With tz.  performance - uniquely suitable architecture. <br><br><h3>  Four-tier architecture, the model is formed on the Appserver, which is accessible via the WCF service via the net.tcp protocol, the result is transmitted to the browser via the Web AP </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/492/6d4/afe/4926d4afe24e47129e3a1cac1a107ee0.JPG"></div><br><h6>  Special features </h6><br>  Many will say that the model for UI to form on the appserver is moveton.  So it, in fact, is. <br>  To smooth the situation, we will not expand the facade of the DD model with methods for returning the model to the UI, but create a new service on the appserver that will use the facade of the DD model and form the model for the UI.  The web server will use this particular service.  If you need to implement a new UI, a new service must be added to the appserver. <br>  In this scenario, the web server sends 1 WCF request to form a model, instead of three for all the other considered four-level scenarios. <br><br><div class="spoiler">  <b class="spoiler_title">Model formation code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UIService</span></span> : <span class="hljs-title"><span class="hljs-title">IUIService</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;DocumentListViewModel&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DocumentListViewModel(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> docService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DocumentsService(); result.AllDocuments = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.Run(() =&gt; docService.GetAllDocuments()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> even = Task.Run(() =&gt; docService.GetEvenDocuments()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> odd = Task.Run(() =&gt; docService.GetOddDocuments()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> evenOdd = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.WhenAll(even, odd); result.EvenDocuments = evenOdd[<span class="hljs-number"><span class="hljs-number">0</span></span>]; result.OddDocuments = evenOdd[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } } }</code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Controller Web API Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// GET: api/DocumentList/ public DocumentListViewModel Get() { var appServer = new UIServiceClient(); appServer.Open(); var data = appServer.GetModel(); appServer.Close(); return data; }</span></span></code> </pre><br></div></div><br><br><h6>  results </h6><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7ba/82b/241/7ba82b24179641ad863c295d94d5b12e.JPG"></div><br>  As you can see, almost all requests fall in the range of 100-150 ms for Moscow and 150-250ms for Ufa. <br><br><h6>  Conclusion </h6><br>  The fastest four-tier architecture.  And the most reliable, because  the exchange between the web server and the appserver is minimized both by the amount of data and by the call frequency. <br><br><h3>  Three-tier architecture, the model is formed on the web server, the result is transmitted to the browser via the Web API </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/261/557/99b/26155799b7b14e6bbe7075d07e5faf69.JPG"></div><br><div class="spoiler">  <b class="spoiler_title">Controller code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DocumentListController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { <span class="hljs-comment"><span class="hljs-comment">// GET: api/DocumentList/ public async Task&lt;DocumentListViewModel&gt; Get() { var result = new DocumentListViewModel(); var watch = new Stopwatch(); watch.Start(); var docService = new DocumentsService(); result.AllDocuments = await Task.Run(() =&gt; docService.GetAllDocuments()); var even = Task.Run(() =&gt; docService.GetEvenDocuments()); var odd = Task.Run(() =&gt; docService.GetOddDocuments()); var evenOdd = await Task.WhenAll(even, odd); result.EvenDocuments = evenOdd[0]; result.OddDocuments = evenOdd[1]; watch.Stop(); result.Log = watch.ElapsedMilliseconds.ToString(); return result; } }</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Local repository code (wrapper over EF)</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DocumentsService</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DocumentItem[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAllDocuments</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Documents()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.DocumentItems.OrderBy(x =&gt; x.Id).Skip(rnd.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">9000</span></span>)).Take(<span class="hljs-number"><span class="hljs-number">1000</span></span>).ToArray(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DocumentItem[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEvenDocuments</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Documents()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.DocumentItems.OrderBy(x =&gt; x.Id).Skip(rnd.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">9000</span></span>)).Take(<span class="hljs-number"><span class="hljs-number">1000</span></span>).ToList().Where((x, i) =&gt; i % <span class="hljs-number"><span class="hljs-number">2</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>).ToArray(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DocumentItem[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOddDocuments</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Documents()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.DocumentItems.OrderBy(x =&gt; x.Id).Skip(rnd.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">9000</span></span>)).Take(<span class="hljs-number"><span class="hljs-number">1000</span></span>).ToList().Where((x, i) =&gt; i % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>).ToArray(); } } }</code> </pre><br></div></div><br><br><h6>  Result </h6><br><img src="https://habrastorage.org/files/4bf/b13/06a/4bfb1306a3534dafac92e4e48dc29599.JPG"><br>  As you can see, almost all requests fall in the range of 100-150 ms for Moscow and 100-200 ms for Ufa. <br><br><h6>  Conclusion </h6><br>  If you don't need a four-tier architecture, then this is the fastest option. <br><br><h3>  So it goes. </h3></div><p>Source: <a href="https://habr.com/ru/post/279331/">https://habr.com/ru/post/279331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279321/index.html">Finding inefficiencies: What you need to know about creating strategies for trading on the exchange</a></li>
<li><a href="../279323/index.html">Welcome to Moscow Python Meetup March 18</a></li>
<li><a href="../279325/index.html">Bounty program in Badoo</a></li>
<li><a href="../279327/index.html">We organize the recovery of virtual machine files using the web portal Veeam Self-Service File Restore</a></li>
<li><a href="../279329/index.html">NetApp Converged Infrastructure Storage. Predictions 2016</a></li>
<li><a href="../279333/index.html">Oracle Database 12.1.0.2 New Features</a></li>
<li><a href="../279335/index.html">Understand Open Source: Usage Models</a></li>
<li><a href="../279337/index.html">American mathematicians have discovered a previously unknown property of prime numbers.</a></li>
<li><a href="../279339/index.html">Universal backdoor installation tool: What's wrong with system updates</a></li>
<li><a href="../279341/index.html">Preview Rambler.iOS # 6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>