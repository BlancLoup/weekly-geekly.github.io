<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to cache AVURLAsset data downloaded by AVPLayer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. My name is Vlad. I work as an iOS developer at FunCorp. We make entertainment apps. You may have heard about our flagship iFunny and the pop...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to cache AVURLAsset data downloaded by AVPLayer</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/7l/eu/ck/7leuckr84qrhj8uanhrgx8kh5u8.png" alt="iFunny app image"></p><br><p>  Hi, Habr.  My name is Vlad.  I work as an iOS developer at FunCorp.  We make entertainment apps.  You may have heard about our flagship iFunny and the popular in the CIS application IdAprikol.  In this article I will talk about how to get the video data downloaded by the player for further work with them. </p><a name="habracut"></a><br><h2 id="tldr">  tl; dr </h2><br><p>  If you only need a solution, look <a href="https://github.com/vdugnist/DVAssetLoaderDelegate">here at this library</a> . </p><br><h2 id="problema">  Problem </h2><br><p>  In our application, iFunny content feed consists mainly of images and videos.  For caching images, we use <a href="https://github.com/rs/SDWebImage">SDWebImage</a> .  For the video, we previously downloaded the file completely and only then began to play.  It worked for short videos.  On the long ones, too much time passed from the moment the screen was opened (the start of the download) to the start of playback, even on wifi. </p><br><h2 id="resheniya">  Solutions </h2><br><p>  The first idea was to store <strong>AVAsset</strong> objects at the model level.  This approach works within a session (AVPlayer will not download the same file several times), but will not work between application launches. </p><br><p>  After that, I tried to transfer AVAsset to NSData using <a href="https://developer.apple.com/documentation/avfoundation/avassetexportsession"><strong>AVAssetExportSession</strong></a> .  The export session worked well for AVAsset created from local files, but for remote assets I always got the error: </p><br><pre><code class="hljs pgsql">Error <span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>=AVFoundationErrorDomain Code=<span class="hljs-number"><span class="hljs-number">-11800</span></span> ‚ÄúThe operation could <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> be completed‚Äù UserInfo={NSLocalizedFailureReason=An <span class="hljs-type"><span class="hljs-type">unknown</span></span> error occurred (<span class="hljs-number"><span class="hljs-number">-16974</span></span>), NSLocalizedDescription=The operation could <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> be completed, NSUnderlyingError=<span class="hljs-number"><span class="hljs-number">0x60000025a940</span></span> {Error <span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>=NSOSStatusErrorDomain Code=<span class="hljs-number"><span class="hljs-number">-16974</span></span> ‚Äú(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)‚Äù}}</code> </pre> <br><p>  The third solution was to use the <strong>resourceLoader</strong> field in AVURLAsset.  This approach worked, but I ran into some problems during its implementation. </p><br><h2 id="realizaciya">  Implementation </h2><br><p>  According to <a href="https://developer.apple.com/documentation/avfoundation/avassetresourceloaderdelegate">Apple documentation</a> : </p><br><pre> <code class="hljs sql">An AVAssetResourceLoader mediates requests to <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> resources <span class="hljs-keyword"><span class="hljs-keyword">required</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> an AVURLAsset <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> asking a <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> that you provide <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> assistance. <span class="hljs-keyword"><span class="hljs-keyword">When</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">resource</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">required</span></span> that cannot be loaded <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the AVURLAsset itself, the <span class="hljs-keyword"><span class="hljs-keyword">resource</span></span> loader makes a request <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> its <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> it <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> proceeds according <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span><span class="hljs-string"><span class="hljs-string">'s response.</span></span></code> </pre> <br><p>  First you need to make sure that AVURLAsset could not load the data itself and call the delegate methods of the resourceLoader for each request.  To do this, it is enough to change the URL scheme of AVURLAsset from HTTP (S) to any other.  Do not forget to keep the original, you still need it. </p><br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">NSURLComponents</span></span> *components = [[<span class="hljs-built_in"><span class="hljs-built_in">NSURLComponents</span></span> alloc] initWithURL:URL resolvingAgainstBaseURL:<span class="hljs-literal"><span class="hljs-literal">NO</span></span>]; components.scheme = @‚Äúcustomscheme‚Äù; <span class="hljs-built_in"><span class="hljs-built_in">AVURLAsset</span></span> *asset = [[<span class="hljs-built_in"><span class="hljs-built_in">AVURLAsset</span></span> alloc] initWithURL:[components URL] options:options];</code> </pre> <br><p>  When a resource loader cannot load a resource on its own, it calls the delegate method: </p><br><pre> <code class="hljs objectivec">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)resourceLoader:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoader</span></span> *)resourceLoader shouldWaitForLoadingOfRequestedResource:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingRequest</span></span> *)loadingRequest;</code> </pre> <br><p>  By returning YES from this method, you tell the resource loader that you are now responsible for this request.  The answer NO will result in an error inside AVURLAsset, since neither the resource loader nor the delegate can execute this request. </p><br><p>  From this point on, work begins with the AVAssetResourceLoadingRequest object, which was passed to the delegate method by an argument.  You can load data synchronously or asynchronously (remember to save the loadingRequest object somewhere if you load asynchronously).  After the download is complete, you need to call <strong>finishLoading</strong> or <strong>finishLoadingWithError:</strong> depending on the result. </p><br><hr><br><p>  There are two types of download requests for AVAssetResourceLoadingRequest: a data request and a request for content information.  You can determine the type by checking the fields: </p><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nullable</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingContentInformationRequest</span></span> *contentInformationRequest; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nullable</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingDataRequest</span></span> *dataRequest;</code> </pre> <br><p>  In response to <a href="https://developer.apple.com/documentation/avfoundation/avassetresourceloadingcontentinformationrequest">the download request,</a> you need to return the content type (UTI), its length and the flag "whether range requests are supported."  For this, I used HTTP HEAD.  When you receive the answer, you need to fill in the data in the fields of the <strong>contentInformationRequest</strong> object and call the <strong>finishLoading</strong> method. </p><br><p>  In response to <a href="https://developer.apple.com/documentation/avfoundation/avassetresourceloadingdatarequest">a data request,</a> you must return the URL, indent, and length data contained in the AVAssetResourceLoadingDataRequest object.  If you want to write your own implementation of the request, carefully read the <a href="https://developer.apple.com/documentation/avfoundation/avassetresourceloadingdatarequest">AVAssetResourceLoadingDataRequest documentation</a> , there are not quite obvious points. </p><br><p>  I wrote an implementation with HTTP GET requests and a range header.  While writing the data query, I noticed strange behavior.  Requests and responses in NSURLSessionDataTas k might be different.  <a href="https://forums.developer.apple.com/thread/67050">The forum branch at developer.apple</a> confirms that this is a bug inside NSURLCache.  The range header is ignored and you may receive the wrong piece of data you requested.  I managed to reproduce it only on iOS &lt;= 10. </p><br><p>  You must put the loaded data in the dataRequest using the method <strong>respondWithData:.</strong>  You can save the same data to your cache.  The next time you open this file, you can take data directly from the cache. </p><br><p>  Thus, we were able to launch the video immediately after the download started and cache it without making unnecessary requests. </p><br><hr><br><p>  Implementation of all delegate methods can be found <a href="">here</a> .  The library for caching AVURLAsset'a <a href="https://github.com/vdugnist/DVAssetLoaderDelegate">lies here</a> , the readme describes how to work with it. </p><br><p>  If you have any questions, welcome to the comments or in a personal.  <a href="https://habrahabr.ru/users/vdugnist/" class="user_link">vdugnist</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346848/">https://habr.com/ru/post/346848/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346834/index.html">We calculate the real effect of paid advertising on Youtube</a></li>
<li><a href="../346836/index.html">What rules of English do our foreign colleagues violate? Part 3</a></li>
<li><a href="../346838/index.html">10 most popular sites for the competition programmers at the beginning of 2018</a></li>
<li><a href="../346840/index.html">Seminar "Ecosystems for business. Application Performance in the Cloud, January 25, St. Petersburg</a></li>
<li><a href="../346844/index.html">blk-mq and I / O schedulers</a></li>
<li><a href="../346850/index.html">More about validation in ASP.NET</a></li>
<li><a href="../346852/index.html">Simulating iridissension: shader CD-ROM</a></li>
<li><a href="../346862/index.html">IPsec vs TLS / SRTP for VoIP Security</a></li>
<li><a href="../346864/index.html">Connect Fanvil phones to 3CX via L2TP tunnel on Mikrotik</a></li>
<li><a href="../346868/index.html">One-cloud - OS-level data center in Odnoklassniki</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>