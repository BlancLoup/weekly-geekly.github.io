<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use PowerShell for IT security. Part I: Event Tracking</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At a time when I wrote a series of articles on penetration tests to help humanity in the fight against hackers, I came across information about some i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use PowerShell for IT security. Part I: Event Tracking</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/c99/fac/e92/c99face9224048e2a4aed7ff169306f8.jpg"><br><br>  At a time when I wrote a series of articles on penetration tests to help humanity in the fight against hackers, I came across information about some interesting cmdlets and PowerShell techniques.  I made an outstanding discovery: PowerShell is a standalone defense.  It seems like a good time to start a new series of publications about PowerShell. <br><br>  In these publications, we‚Äôll be of the opinion that, although PowerShell will not replace special security platforms ( <a href="https://www.varonis.com/ru">Varonis</a> employees may breathe a sigh of relief), this tool will help IT professionals track threats and take other security measures.  In addition, the IT department will begin to appreciate the wonders of specialized security platforms, such as our <a href="https://www.varonis.com/ru/products/data-classification-framework/">Metadata Framework</a> solution.  PowerShell can perform interesting security tasks on a small scale, but this tool does not have the characteristics to work with the entire infrastructure. <br><a name="habracut"></a><br>  <b>An important event</b> <b><br></b> <br>  To begin, consider using PowerShell as a system monitoring tool for tracking files, processes, and user actions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before you start cursing me, let me say that I know perfectly well that any command language of the operating system can be used to track events at the system level.  Any junior system administrator can configure, for example, a Linux shell script to poll the directory to see if the file has been updated, or to get a list of running processes to find non-standard processes among them. <br><br>  Now it's not about that. <br><br>  Instead, PowerShell provides direct event-driven tracking based on the operating system‚Äôs access to low-level changes.  This is equivalent to receiving pop-up notifications about the latest events on the news site instead of having to refresh the page manually. <br><br>  In this case, PowerShell will not work without stopping, loading the processor cycles.  The script is activated when an event occurs (changing a file or logging on to a new user).  Such security tracking is much more effective than screening polls. <br><br>  Below I will explain how this is done. <br><br>  Anyone who, like me, has studied operating systems, knows that there is a boundary between user-level processes and system-level processes. <br><br>  The operating system (whether it is Linux or Windows) handles device actions at the lower level, from reading the disk to receiving packets, and hides it from ordinary applications running on the PC. <br><br>  Thus, if you run your favorite word processing application and view the first page of the document, the whole operation will look like a smooth and synchronous action.  However, all sorts of events actually occur (search on disk, reading disk blocks, sending characters to the screen, etc.) that are intentionally hidden from us.  For this you can thank Bill Gates. <br><br>  Previously, only the severe system engineers knew about event handling at the lower level.  Now PowerShell programmers can share this information with pleasure. <br><br>  <b>OS tool language</b> <br><br>  Consider the Windows Management Instrumentation (WMI), which is an attempt by Microsoft to ensure consistent viewing of operating system objects. <br><br>  WMI, which is only a few years old, is part of a large enterprise Internet management system (WBEM) designed to standardize information received from routers, switches, storage arrays, and operating systems. <br><br>  How does WMI look and work? <br><br>  For our purposes, the tool is a query language like SQL, but instead of accessing database columns, it provides comprehensive information about the operating system in the form <code> WMI</code> hierarchy.  Of course, the query language is called WQL. <br><br>  Windows has a WBEMTest utility that can be used to interact with WQL.  The image below shows a request for a <code>Win32_Process</code> object containing information about the currently running process. <br><br><img src="https://habrastorage.org/web/846/938/f21/846938f2185e4457981b1984acd86ec5.jpg" alt="image"><br>  <i>Training work with WQL in WBEMTest</i> <br><br>  In fact, this is the software equivalent of Windows Task Monitor.  Impressive, isn't it?  If you want to learn more about WQL, download Ravi Chaganti's excellent e-book on this topic. <br><br>  <b>PowerShell and Register-WmiEvent Cmdlet</b> <br><br>  But that is not all.  From training tasks in WBEMTest, you can go to queries directly in PowerShell. <br><br>  The PowerShell cmdlet <code>Get-WMIObject</code> suitable for this.  It allows you to send a WQL query directly as a parameter. <br><br>  The image below shows the first few startup results of <code>select Name, ProcessId, CommandLine from Win32_Process</code> in the AWS test environment. <br><br><img src="https://habrastorage.org/web/f76/a12/2f1/f76a122f16ef4b0e94f93bf75ca3dc4d.jpg"><br>  <i>gwmi is Get-WmiObject in PowerShell</i> <br><br>  The result is a bit unreliable, as there are some hidden properties related to the main class of data logging.  In addition, this cmdlet gives an impressive list in the console. <br><br>  To improve Win32_Process, I moved the query result to <code>Out-GridView</code> , a PowerShell cmdlet that formats the data into a neat table based on a graphical interface. <br><br><img src="https://habrastorage.org/web/f1f/5be/5a6/f1f5be5a650d4975997c0ecfb6607dea.jpg"><br><br>  Not bad for a PowerShell code line.  But the WMI service is capable of more than just requesting OS objects. <br><br>  As I mentioned earlier, it gives access to the relevant events of these objects.  In WMI, these events are roughly divided into three types: create, modify, and delete. <br><br>  Before the release of PowerShell 2.0, access to these events had to be obtained in an intricate way: creating many different objects, after which a synchronous hang occurred, so this was not real asynchronous event handling.  For more information, read the MS Technet post. <br><br>  Now the <code>Register-WmiEvent</code> in PowerShell 2.0 allows you to respond to events in a more acceptable manner.  In other words, when an event occurs, a call triggers, which can be registered. <br><br>  Let's return to my fictional (and already famous) company Acme, whose IT infrastructure operates in the AWS environment. <br><br>  The system administrator (let's call him Bob) from time to time notices that the place on the Salsa server ends.  He suspects that Acme CEO Ted Bloutley uploads large files, such as audio, to one of Bob‚Äôs directories, and then transfers it to his Taco server. <br><br>  Bob wants to create a trap: it is necessary that when creating a large file in the main directory, a notification appears in his console. <br><br>  To do this, he needs to work with the <code>CIM_DataFile.</code> class <code>CIM_DataFile.</code>  Instead of accessing processes, as we did earlier, Bob uses this class to connect to the main file's metadata. <br><br><img src="https://habrastorage.org/web/b5e/59a/38c/b5e59a38ca3443d5be4b4c37ff6452c4.jpg"><br>  <i>In PowerShell, you can directly access the CIM_DataFile object.</i> <br><br>  As Bob, I created the following <code>Register-WmiEvent</code> , which will send notifications to the console when creating a large file in the main directory. <br><br> <code>Register-WmiEvent -Query "SELECT * FROM __InstanceModificationEvent WITHIN 5 WHERE TargetInstance isa 'CIM_DataFile' and TargetInstance.FileSize &gt; 2000000 and TargetInstance.Path = '\\Users\\bob\\' and targetInstance.Drive = 'C:' "-sourceIdentifier "Accessor3" -Action { Write-Host "Large file" $EventArgs.NewEvent.TargetInstance.Name "was created‚Äù}</code> <br> <br>  Running this script directly in the Salsa console activates the Register-WmiEvent command in the background, assigning it a job number.  Further interaction occurs only when an event occurs. <br><br>  In the next post I will talk about this in more detail.  In fact, I use WQL to query from the \ Users \ bob directory of any <code>CIM_DataFile</code> object in excess of 2 million bytes.  When you create a file that meets the conditions, a notification appears, for which <code>InstanceModificationEvent.</code> is activated <code>InstanceModificationEvent.</code> <br><br>  In any case, playing the role of Bob, I ran the script from the PowerShell command line, and then, like Ted from our story, I copied a large MP4 file into the Bob directory.  You can see the result below. <br><br><img src="https://habrastorage.org/web/50c/b37/2b8/50cb372b8b244e0086213378d551925c.jpg"><br><br>  Now we know that Ted is a fan of Melody Gardo.  Who would have thought! <br><br>  The publication demonstrated some amazing possibilities of using PowerShell as a tool for detecting threats and a small analysis of behavior. <br><br>  We will continue to explore these aspects in the following articles. </div><p>Source: <a href="https://habr.com/ru/post/335176/">https://habr.com/ru/post/335176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335166/index.html">Very easy monitoring system with Telegram and Consul</a></li>
<li><a href="../335168/index.html">How to set up backup to S3-compatible cloud from Commvault</a></li>
<li><a href="../335170/index.html">How we look for (and why we find) cool developers. HR experience and tips for job seekers</a></li>
<li><a href="../335172/index.html">Attack of the clones. How to deal with code duplication?</a></li>
<li><a href="../335174/index.html">Smart stores, omni-channel analytics and endless loyalty: 6 retail trends in 2017</a></li>
<li><a href="../335178/index.html">Asynchronous decoder</a></li>
<li><a href="../335180/index.html">How the push notification service helped us make the technical support portal more visited</a></li>
<li><a href="../335184/index.html">Free network security audit with Fortinet. Part 1</a></li>
<li><a href="../335186/index.html">Sites online stores and industrial companies are most vulnerable to hacker attacks</a></li>
<li><a href="../335188/index.html">ML Boot Camp V, solution history for 3rd place</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>