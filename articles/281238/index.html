<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IoT solution for 1.5 hours</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Or how we lit a light bulb from a smartphone through a cloud service in front of the amazed students of the NSU. 

 We give the full technical descrip...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IoT solution for 1.5 hours</h1><div class="post__text post__text-html js-mediator-article">  Or how we lit a light bulb from a smartphone through a cloud service in front of the amazed students of the NSU. <br><img src="https://habrastorage.org/files/607/3b0/24a/6073b024a37f42e981bb9a652227523d.jpg"><br>  <i>We give the full technical description of the solution below, and begin with the lyric-philosophical prologue.</i> <br><br><h2>  Chapter 1. Lyric </h2><br>  Almost all of our employees received higher education, and very many at the Novosibirsk State University.  Someone just recently, someone - 10-20 years ago, and all were faced with the choice of a future profession.  In the last courses by students, we chose a department where we specialized and defended diplomas.  And there was such a wonderful tradition as Open Doors in institutes, laboratories and companies, where employees told them what they were doing, what issues are now facing science and technology and how to participate in this. <br><br>  What is the most interesting thing about student open days?  To walk, ask questions, look at real people who are engaged in the real business, which someone needs. <br><a name="habracut"></a><br>  According to one of our employees, for him, as a future specialist who had never seen the practical application of his knowledge in the framework of the Open Doors, it was very interesting to see the live docking simulator for Mir station, the telephone call interception system, the CHP management system, the virtual studio, talk to people all have already implemented.  And it was precisely such meetings that helped decide where the diploma would be written and in which of the areas I would like to develop professionally. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today, Open Days have changed Career Days.  But we wanted to keep the spirit of this event in our presentation. <br><br>  We set a goal - to do everything according to the good old and proven traditions on the one hand, and on the other, to show students that there are fundamental principles and the world is a rather complicated thing, but this is good.  This is a challenge and an opportunity to realize yourself in a professional IT society. <br><br>  It was with such thoughts that we began preparing for Career Days at NSU - the leading personnel forge among Novosibirsk universities for any self-respecting IT company in Novosibirsk and many other cities and countries. <br><br>  Therefore, we organized a poster session and a master class, which was attended by project managers and leading developers participating in interesting combat projects for our clients.  To put it simply - we were not limited to girls from HR, but put up the current ‚ÄúIT Special Forces‚Äù with a chic theme. <br><br>  We decided to knit a few fashionable IT themes and experience from a real project: <br><ul><li>  Internet of things </li><li>  Microcontroller Programming </li><li>  Cloud Services </li><li>  Mobile technology </li></ul><br>  And they invented to control the lights from a smartphone.  Yes, it‚Äôs so simple and clear to show how in one and a half hours you can write code and get a working complete solution. <br><img src="https://habrastorage.org/files/f8f/fa6/840/f8ffa68406b0407ca3b536eff6127555.jpg"><br>  But let's order. <br><br><h2>  Chapter 2. Introduction.  The philosophy of the Internet of things </h2><br>  If we talk in general about the Internet of things, we would highlight 2 directions in the development of solutions. <br><ol><li>  Remote control ‚Äúthings‚Äù.  For example, opening / closing doors, turning on / off security systems or, in our case, lighting. </li><li>  Data collection from remote sensors, analysis of these data, as well as prediction of the functioning of the studied systems, with the possible use of machine learning technologies. </li></ol><br><br>  Of course, future IoT class solutions will not choose one of two directions, but combine them.  However, the 2nd option seems so far somewhat difficult to conduct a master class, i.e.  writing it online in an hour and a half. <br><br>  As for the first, on the basis of experience in developing such solutions, we were quite able to demonstrate it.  Having somewhat simplified one of our projects, we decided to build the following. <br><ol><li>  There is a table lamp.  The lamp is connected to the controller, which periodically polls the service to see if it should be lit or not. </li><li>  There is a service that ‚Äúlives‚Äù in AWS (Amazon Web Services).  The service keeps an ‚Äúon / off‚Äù state and also provides an API for getting or changing this state. </li><li>  There is a mobile application that allows you to manage this state. </li></ol><br>  The guys from .NET took over the programming of the microcontroller, the guys from Java - the cloud service on Amazon, and our "mobile" colleagues - the Android application. <br><br>  In the presentation for the students, it sounded like this: <br><br><img src="https://habrastorage.org/files/97e/f7b/4fa/97ef7b4fac6d4fc08dce63531f26af74.jpg"><br><br><h2>  Chapter 3. Preparatory.  A few days before the day D. </h2><br>  To demonstrate at the poster session, we decided to make a separate device.  We were not too lazy and made it cool in steampunk style - we aged a wooden box and found vintage lamps. <br><br>  A couple of weekends and evenings - and the solution was ready, the stylish device was assembled and worked. <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/2zyyPId5eH4%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjs72YTCXvTOH9N9Xx1imPYUv_D4Q" frameborder="0" allowfullscreen=""></iframe><br><br>  A couple of working days from the top and we have cool designs for posters, booklets, stand and t-shirts. <br><img src="https://habrastorage.org/files/388/032/383/3880323835754b2aa9ec93eb079f6426.jpg"><br><br>  As responsible people, we decided to rehearse our master class.  We prepared a presentation, gathered all the technical specialists and arranged the run.  The program of the master class was the following: we consistently show how we program the controller, write the service, write the application, and at the end of each part we light a light bulb. <br><img src="https://habrastorage.org/files/02b/067/5c5/02b0675c5a2d4e049af7594bdd311f68.jpg"><br><br><img src="https://habrastorage.org/files/70d/c38/953/70dc38953fe34b1a876c59d0190a8998.jpg"><br><br>  Over the course of three runs, we learned to fit in the allotted timing, polished the code and text, and prepared a couple of tricky questions for the students. <br><br><h2>  Chapter 4. Convict.  Day D. Poster Session </h2><br>  In the morning we were one of the first to appear at NSU, we set up a stand, removed the dull standard table, put our branded cabinet and installed our device on it right in the center.  He enjoyed tremendous success.  Everyone came to watch and photograph everything - students, teachers, photographers, competitors and even security guards.  Our booklets and device worked perfectly - we gathered a full audience the next day! <br><img src="https://habrastorage.org/files/6e1/fdd/c1a/6e1fddc1ab9c4dd29cc41960df6fa5a7.jpg"><br><br><img src="https://habrastorage.org/files/bf8/96f/c75/bf896fc75e3d4a7eb2500ce2e550eabe.jpg"><br><br><h2>  Chapter 5. Heroic.  D + 1 day.  Master Class. </h2><br>  And then came the day of the master class.  We arrived at the NSU and realized that how not to get ready, and in such events will not do without gags. <br><br>  The full audience of students, and we don‚Äôt have Macs connected to the projector, doesn‚Äôt allow some devices to Wi-Fi, and even Amazon‚Äôs clouds tried to get into position and not stop our proven services.  But it‚Äôs not for nothing that we set up the dream, everything was resolved ‚Äúon the fly‚Äù, not falling out of the general timing and structure of the presentation. <br><br>  We gave a general introduction to our company, the Internet of things and how we will light a light bulb.  Then all the programming stages of the complex solution went through the steps, handing out souvenirs and branded circles to the most active, clever and cunning students.  Sly, because some of them tried to hack us, and the approach was pretty good, for which the hackers were awarded separately :). <br><img src="https://habrastorage.org/files/c4d/64e/bc3/c4d64ebc36a841f18faaf9502e868ea2.jpg"><br><br>  Yes, it was very reminiscent of a textbook cinematic disastrous meeting, on which everything goes wrong, but the final, as it should be in the genre, was happy.  The software has been created, the services are deployed in the cloud, the mobile application has fallen on the phones and the light has been lit at the strictly time allotted for this.  The students saw our ‚Äúsoul‚Äù;) and told us ‚Äúyes‚Äù, stayed after the end of the presentation to discuss projects, solutions and technologies with our children. <br><img src="https://habrastorage.org/files/25b/1dd/a53/25b1dda53f4b491d99b490c0fce9f4cf.jpg"><br><br>  And now to the most interesting thing for hack readers - to the code. <br><br><h2>  Chapter 6. Technical </h2><br>  So, we remind that our solution should consist of 3 components. <br><br><img src="https://habrastorage.org/files/e9a/822/d8e/e9a822d8e8a44b338a480470d2f3aa7b.png"><br><ol><li>  A microcontroller that turns on / off a light bulb.  This microcontroller periodically requests the status of the light from the service.  Here the attentive reader may ask why we have not used certain technologies that allow implementing Push from the server, and will be right.  In a real project, a connection using WebSocket was used.  However, in order to keep within such a short time, we decided to simplify the system as much as possible. </li><li>  RESTfull Service, which is ‚Äúhosted‚Äù by AWS, as well as a test page that allows them to be managed. </li><li>  Mobile application that also allows you to manage the status of the light bulb. </li></ol><br><br><h3>  6.1.  We program the microcontroller. </h3><br>  The heart of our device is the NodeMCU based on the ESP8266 controller. <br><br><img src="https://habrastorage.org/files/b64/a36/108/b64a361084eb4bffa7b27349b07ba5e9.jpg"><br>  From the entire list of features of this board, we are interested in the support of wireless networks Wi-Fi and GPIO - general purpose inputs / outputs.  Also, despite the fact that there is no OS for this board in its usual sense, various firmware versions support the execution of programs in C / C ++, Lua, JavaScript and MicroPython. <br><br>  We stopped at SMART.JS firmware, programs for which are written in JavaScript.  Of the possibilities of this firmware, we will use only the http-client. <br><br><img src="https://habrastorage.org/files/1b9/7b2/f30/1b97b2f307f0425bafbb5504382a5ec0.jpg"><br><br>  We are interested in the output number 5 (GPIO5).  This is a digital output.  It means that it can have a logical ‚Äú0‚Äù or a logical ‚Äú1‚Äù at the output.  With a logical 0, the relay will be turned off, with a logical 1 it will be turned on, and the light will be on. <br><br>  Prerequisites: <br>  1. SMART.JS Documentation: <a href="https://docs.cesanta.com/smartjs/latest/">docs.cesanta.com/smartjs/latest</a> <br>  2. SMART.JS firmware: <a href="">github.com/cesanta/smart.js</a> <br>  3. FNC (utility to download firmware and programs in JavaScript): <a href="https://github.com/cesanta/fnc">github.com/cesanta/fnc</a> <br>  4. Virtual COM port drivers: <a href="https://www.silabs.com/products/mcu/Pages/USBtoUARTBridgeVCPDrivers.aspx">www.silabs.com/products/mcu/Pages/USBtoUARTBridgeVCPDrivers.aspx</a> <br>  5. Test service: a test service that on a GET request issues JSON in the format: <br><pre><code class="hljs objectivec">{ ‚Äúresource_name‚Äù: <span class="hljs-literal"><span class="hljs-literal">true</span></span>/<span class="hljs-literal"><span class="hljs-literal">false</span></span> ‚Ä¶ }</code> </pre> <br><br>  So, to the point. <br><br>  To begin with, we flash on our board with SMART.JS firmware using the FNC program.  After that, our device starts working in the access point mode and the SMARTJS network appears ????  (for example, SMARTJS_FA352), the password can be peeped in the FNC console. <br><br>  Connect to the access point and open the address 192.168.4.1.  We have a configuration page where we enter the SSID and password for our network.  We save changes, the device is overloaded, and we are ready to write our application. <br><img src="https://habrastorage.org/files/97d/783/e9e/97d783e9e03b43f780631f8f252e250f.jpg"><br><br>  We take your favorite text editor and create the file app.js.  To begin with, we will output some welcome message to our console and define the output to which the relay is connected and the name of the resource associated with the light bulb: <br><pre> <code class="hljs javascript"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'device started.'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pin = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resource = <span class="hljs-string"><span class="hljs-string">'light01'</span></span>;</code> </pre><br><br>  Initialize our output and set the logical 0 to the output: <br><pre> <code class="hljs pgsql">GPIO.setmode(pin, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); GPIO.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(pin, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre><br>  Install the callback function on the connection state changes: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Wifi</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.changed</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">changedFunc</span></span>);</code> </pre><br>  The function accepts the numeric status of the connection.  For now, just output it to the console along with a textual representation of this status: <br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changedFunc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(state)</span></span></span></span> { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Wifi state: '</span></span>, state, Wifi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>()); }</code> </pre><br>  Having launched the application, we see that the status ‚Äúgot ip‚Äù corresponds to code 2. Now let‚Äôs send a request to the service upon successful connection to the network: <br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changedFunc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(state)</span></span></span></span> { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Wifi state: '</span></span>, state, Wifi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == <span class="hljs-number"><span class="hljs-number">2</span></span>) { mainFunc(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mainFunc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { Http.request({ hostname: <span class="hljs-string"><span class="hljs-string">'ngurestexample.us-east-1.elasticbeanstalk.com'</span></span>, port: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/'</span></span>, method: <span class="hljs-string"><span class="hljs-string">'GET'</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(response)</span></span></span></span>{ console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(response.body); }) .<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>() .setTimeout(<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'timeout error'</span></span>); }); }</code> </pre><br>  We receive an answer in the form of a string: {‚Äúlight01‚Äù: false}.  We transform it into a JS object and set the state on our output in accordance with what we received from the service: <br><pre> <code class="hljs pgsql">var states = <span class="hljs-type"><span class="hljs-type">JSON</span></span>.parse(response.body); GPIO.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(pin, !!states[resource]);</code> </pre><br>  Well, and so that our device periodically polls the service, we put the second call to mainFunc via setTimeout in the service response handling function and in the request timeout handling function: <br><pre> <code class="hljs lisp">setTimeout(<span class="hljs-name"><span class="hljs-name">mainFunc</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br>  Now our device is ready to work. <br><br><h3>  6.2.  AWS Service </h3><br><img src="https://habrastorage.org/files/d49/ba1/8a4/d49ba18a42154357941b44445034c609.jpg"><br>  Elastic Beanstalk is one of the useful AWS services for quickly deploying and scaling web applications.  Its use frees us from the need to create and customize the environment.  The service of choice provides several pre-configured.  All that is required of us is to choose the right environment and load the assembled application using an intuitive UI.  The rest will be done by the Beanstalk service.  At the output we get the URL to which the application will be accessible via HTTP. <br><br>  Select the Tomcat environment (servlet container) and the following configuration: <br><ul><li>  Amazon Linux operating system; </li><li>  disable the load balancer, because  we will not need it; </li><li>  choose a small virtual machine t1.micro. </li></ul><br><br>  The same actions in the pictures: <br><img src="https://habrastorage.org/files/4dc/c68/11f/4dcc6811f3a64d20a3eac4dbcd395ca3.jpg"><br><br><img src="https://habrastorage.org/files/078/bab/9db/078bab9db0f14c97833fe10f82b00a9c.jpg"><br><br><img src="https://habrastorage.org/files/dfe/c6b/162/dfec6b16201a4eb698ce35c9d3a21874.jpg"><br><br><img src="https://habrastorage.org/files/9b4/fc5/f46/9b4fc5f46d294ca18ee59d11066fae7a.jpg"><br><br><img src="https://habrastorage.org/files/c2b/232/724/c2b23272448b4333986ce30399cb7b7a.jpg"><br><br>  In addition, Beanstalk provides the ability to: <br><ul><li>  configure application server settings (JVM settings) and pass environment variables; </li><li>  connect to the built-in monitoring tools CloudWatch; </li><li>  select the appropriate database or storage; </li></ul><br>  Let's proceed to the creation of our web application. <br><br>  The goal is to implement a small and simple application that could store the state of the light bulbs (off / on) and change this state.  Clients are completely different (microcontroller and mobile application), so it makes sense to use the REST architecture. <br>  As a result, our application will provide the following standard REST API: <br><ul><li>  [get] "/" - returns the status of all the lights.  Example: {‚Äúbulb-1‚Äù: false, ‚Äúbulb-2": true} </li><li>  [get] "/ {resource}" - returns the status of the requested light bulb </li><li>  [delete] "/ {resource}" - will remove a light bulb from the list of light bulbs </li><li>  [put] "/ {resource}" - will update the status of the specified light bulb </li><li>  [post] "/ {resource}" - will create a new light bulb </li></ul><br>  We will write the code in Java, collect the results of our work using Maven, and use the resteasy library to write the code. <br><br>  Using Maven, we connect the necessary dependencies <br>  [ <a href="https://github.com/EBTRussia/nsucareerdays2016/edit/master/cloud/sample-web-app-rest">github.com/EBTRussia/nsucareerdays2016/edit/master/cloud/sample-web-app-rest</a> ] easy / pom.xml]: <br>  resteasy-jaxrs - to work with jaxrs <br>  resteasy-servlet-initializer - for integration with Tomcate <br>  resteasy-jackson2-provider - to work with json <br><br>  Why resteasy.  In the Java world, there are many tools that allow you to create rest-applications (Jersey, Spring, Spark, etc.).  We simply chose one of them, which, by the way, is included in the standard delivery of the WildFly application server. <br><br>  [ <a href="">github.com/EBTRussia/nsucareerdays2016/blob/master/cloud/sample-web-app-resteasy/src/main/java/ru/ebt/LightAppController.java</a> ] <br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Path(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces(MediaType.APPLICATION_JSON)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LightAppController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ConcurrentMap&lt;String, <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>&gt; resource = new ConcurrentHashMap&lt;&gt;(); <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Map getAll() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resource; } <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Path(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/{resource}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-meta"><span class="hljs-meta">@PathParam(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"resource"</span></span></span><span class="hljs-meta">)</span></span> String r) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resource.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(r); } <span class="hljs-meta"><span class="hljs-meta">@PUT</span></span> <span class="hljs-meta"><span class="hljs-meta">@Path(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/{resource}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> put(<span class="hljs-meta"><span class="hljs-meta">@PathParam(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"resource"</span></span></span><span class="hljs-meta">)</span></span> String r, <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resource.containsKey(r)) { resource.put(r, status); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new WebApplicationException(Response.Status.NOT_FOUND); } <span class="hljs-meta"><span class="hljs-meta">@POST</span></span> <span class="hljs-meta"><span class="hljs-meta">@Path(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/{resource}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> post(<span class="hljs-meta"><span class="hljs-meta">@PathParam(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"resource"</span></span></span><span class="hljs-meta">)</span></span> String r, <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> status) { resource.put(r, status); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; } <span class="hljs-meta"><span class="hljs-meta">@DELETE</span></span> <span class="hljs-meta"><span class="hljs-meta">@Path(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/{resource}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void delete(<span class="hljs-meta"><span class="hljs-meta">@PathParam(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"resource"</span></span></span><span class="hljs-meta">)</span></span> String r) { resource.remove(r); } }</code> </pre><br>  <a href="https://habrahabr.ru/users/get/" class="user_link">GET</a> , <a href="https://habrahabr.ru/users/put/" class="user_link">PUT</a> , <a href="https://habrahabr.ru/users/post/" class="user_link">POST</a> , <a href="https://habrahabr.ru/users/delete/" class="user_link">DELETE</a> - Annotations from JAX-RS, which show what http methods to contact our api. <br><br>  <a href="https://habrahabr.ru/users/path/" class="user_link">Path</a> ("/ {resource}") &amp; @PathParam ("resource") show which URL to access api and which part of the URL we want to process as a parameter in the application logic.  In our case, the resource is the name / id for the bulb. <br><br>  To store the state of our lamps, we use the ConcurrentHashMap [ <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html">docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html</a> ], a thread-safe dictionary of keys and values. <br><br>  Now we will turn our usual class into real rest-service.  To do this, create the BaseApplication configuration class, which we will inherit from javax.ws.rs.core.Application.  Inside the getSingletons () method, we list all the classes that will be REST services. <br><pre> <code class="hljs scala"><span class="hljs-meta"><span class="hljs-meta">@ApplicationPath</span></span>(<span class="hljs-string"><span class="hljs-string">""</span></span>) public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseApplication</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> public <span class="hljs-type"><span class="hljs-type">Set</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Object</span></span>&gt; getSingletons() { <span class="hljs-type"><span class="hljs-type">HashSet</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Object</span></span>&gt; objects = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">HashSet</span></span>&lt;&gt;(); objects.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">LightAppController</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> objects; } }</code> </pre><br><br>  Putting the application.  Go to the root directory of our application and execute the command: <br><pre> <code class="hljs sql">mvn clean <span class="hljs-keyword"><span class="hljs-keyword">install</span></span></code> </pre> <br>  After we go to the target folder created by maven and pick up the * .war file, deploy it to Tomcat using the BeansTalk service. <br><br>  Just press the button, everything should fly up: <br><img src="https://habrastorage.org/files/9df/2cc/60b/9df2cc60bcdd4d0fb736f847128e561e.jpg"><br><br>  We check that everything works: <br><ol><li>  we pull the URL of our application with the get [http: // whichever.address/] method and in response we get an empty json: {} </li><li>  using any REST client, we execute the request using the POST [http: // whatever.address/light01] method in the request body we write true </li><li>  and we see that the bulb lights up) (you can pull get ‚Äú/‚Äù again and get {‚Äúlight01‚Äù: true}) </li></ol><br><br><h3>  6.3.  Android application </h3><br><br><img src="https://habrastorage.org/files/2b3/ac9/1de/2b3ac91deaec42baaa2ad4dcbf974a50.jpg"><br><br>  <b>Step 0. Preparatory</b> <br>  To create Android applications, the Gradle automated build system is used.  In his build.gradle script, we will include several dependencies that will simplify our coding and life: <br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">dependencies</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">compile</span></span> <span class="hljs-string"><span class="hljs-string">'com.jakewharton:butterknife:7.0.1'</span></span> compile <span class="hljs-string"><span class="hljs-string">'com.squareup.retrofit2:retrofit:2.0.0'</span></span> compile <span class="hljs-string"><span class="hljs-string">'com.squareup.retrofit2:converter-gson:2.0.0'</span></span> }</code> </pre><br>  The Butterknife library will help us more easily set up a graphical interface, and Retrofit is ideal as an HTTP client if you plan to interact with a REST service. <br><br>  <b>Step 1. Graphical Interface</b> <br>  Add a Switch component to an empty screen (activity), which, like no one else, is well suited for controlling a light bulb, almost like a real switch: <br><pre> <code class="hljs objectivec">&lt;Switch android:<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-string"><span class="hljs-string">"@+id/light_switch"</span></span> android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span> android:layout_height=<span class="hljs-string"><span class="hljs-string">"wrap_content"</span></span> android:text=<span class="hljs-string"><span class="hljs-string">""</span></span>/&gt;</code> </pre><br>  We gave our component the unique name light_switch and wrote the text that will be visible to the user. <br><br>  Now add a switch to the code of our activity: <br><pre> <code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bind</span></span>(<span class="hljs-type"><span class="hljs-type">R</span></span>.id.light_switch) <span class="hljs-type"><span class="hljs-type">SwitchCompat</span></span> lightSwitch; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> void onCreate(<span class="hljs-type"><span class="hljs-type">Bundle</span></span> savedInstanceState) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(<span class="hljs-type"><span class="hljs-type">R</span></span>.layout.activity_main); <span class="hljs-type"><span class="hljs-type">ButterKnife</span></span>.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@OnClick</span></span>(<span class="hljs-type"><span class="hljs-type">R</span></span>.id.light_switch) void onLightSwitchClicked(<span class="hljs-type"><span class="hljs-type">Switch</span></span> lightSwitch) { boolean checked = lightSwitch.isChecked(); <span class="hljs-type"><span class="hljs-type">Toast</span></span>.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"Switch checked = "</span></span> + checked, <span class="hljs-type"><span class="hljs-type">Toast</span></span>.<span class="hljs-type"><span class="hljs-type">LENGTH_SHORT</span></span>).show(); } }</code> </pre><br><br>  We used two annotations from the ButterKnife library: <a href="https://habrahabr.ru/users/bind/" class="user_link">Bind</a> and <a href="https://habrahabr.ru/users/onclick/" class="user_link">OnClick</a> .  The first connects our switch, declared in the xml-markup with the switch that is declared in the code.  The second sets the onLightSwitchClicked () method as a click handler on our switch. <br><br>  <b>Step 2. HTTP client</b> <br>  Creating an http client is not at all difficult if you resort to using the retrofit library.  It is only necessary to create an interface and describe in it all requests to the server as its methods, and then feed this interface to retrofit, which will independently create a suitable implementation of our interface. <br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebApi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/"</span></span></span><span class="hljs-meta">)</span></span> Call&lt;Map&lt;String, <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>&gt;&gt; list(); <span class="hljs-meta"><span class="hljs-meta">@POST(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/{resource}"</span></span></span><span class="hljs-meta">)</span></span> Call&lt;<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>&gt; switchBulb(<span class="hljs-meta"><span class="hljs-meta">@Path(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"resource"</span></span></span><span class="hljs-meta">)</span></span> String resource, <span class="hljs-meta"><span class="hljs-meta">@Body</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> enabled); }</code> </pre><br>  In our interface, only 2 methods: <br><ul><li>  list () - GET request to get all the lights and their states in the form of a dictionary &lt;String, Boolean&gt; </li><li>  switchBulb (...) - POST request, creating (or re-creating) the state of the light bulb: <br><pre> <code class="hljs pgsql">webApi = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Retrofit.Builder() .baseUrl(getString(R.string.api_url)) .addConverterFactory(GsonConverterFactory.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>()) .build() .<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(WebApi.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>);</code> </pre><br></li></ul><br>  Here we specify the base url to the retrofit library, we inform you that the requests and responses will be in JSON format and we specify the interface we have just written, after which the HTTP client is ready for work. <br><br>  <b>Step 3. We are on friendly terms with UI and HTTP client</b> <br>  First, you need to get and display the current state of the light bulb.  Make a GET request and look for a lightbulb named ‚Äúlight01‚Äù in the returned dictionary: <br><pre> <code class="hljs pgsql">webApi.list().enqueue(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Callback&lt;Map&lt;String, <span class="hljs-type"><span class="hljs-type">Boolean</span></span>&gt;&gt;() { @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onResponse(<span class="hljs-keyword"><span class="hljs-keyword">Call</span></span>&lt;Map&lt;String, <span class="hljs-type"><span class="hljs-type">Boolean</span></span>&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>, Response&lt;Map&lt;String, <span class="hljs-type"><span class="hljs-type">Boolean</span></span>&gt;&gt; response) { <span class="hljs-type"><span class="hljs-type">Boolean</span></span> light01Enabled = response.body().<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("light01"); lightSwitch.setChecked(<span class="hljs-type"><span class="hljs-type">Boolean</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span> == light01Enabled); } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onFailure(<span class="hljs-keyword"><span class="hljs-keyword">Call</span></span>&lt;Map&lt;String, <span class="hljs-type"><span class="hljs-type">Boolean</span></span>&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>, Throwable t) { } });</code> </pre><br>  Secondly, when switching light bulbs on the client, you need to notify the server about it.  We have already written a click handler for the switch in the previous step, now we will add an HTTP request to it: <br><pre> <code class="hljs pgsql">@OnClick(R.id.light_switch) <span class="hljs-type"><span class="hljs-type">void</span></span> onLightSwitchClicked(Switch lightSwitch){ <span class="hljs-type"><span class="hljs-type">boolean</span></span> checked = lightSwitch.isChecked(); webApi.switchBulb("light01", checked).enqueue(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Callback&lt;<span class="hljs-type"><span class="hljs-type">Boolean</span></span>&gt;() { @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onResponse(<span class="hljs-keyword"><span class="hljs-keyword">Call</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Boolean</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>, Response&lt;<span class="hljs-type"><span class="hljs-type">Boolean</span></span>&gt; response) { Toast.makeText(MainActivity.this, "Light01 changed", Toast.LENGTH_SHORT).<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(); } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onFailure(<span class="hljs-keyword"><span class="hljs-keyword">Call</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Boolean</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>, Throwable t) { } }); }</code> </pre><br><img src="https://habrastorage.org/files/4c3/d63/523/4c3d635230e1426ab30b56f284024101.jpg"><br><br>  And-and-and, the light is on! <br><img src="https://habrastorage.org/files/d7e/7a5/2b0/d7e7a52b071d41988421aea5cf612273.jpg"><br><br><h2>  Chapter 7. Short, concluding. </h2><br><br>  The complete solution code can be found at: <a href="https://github.com/EBTRussia/nsucareerdays2016">github.com/EBTRussia/nsucareerdays2016</a> <br><br>  We wanted to show a master class and this example - you can do cool and interesting things in a short time and with a minimum of effort.  Need an idea.  Dare!  It is from simple and necessary things that entire industries are born, such as the Internet of things. <br><br>  And come to work with us :) We have a truly unique team and very interesting projects. <br>  See you! </div><p>Source: <a href="https://habr.com/ru/post/281238/">https://habr.com/ru/post/281238/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281228/index.html">Friday format: How Netflix works</a></li>
<li><a href="../281230/index.html">The law ‚ÄúOn Personal Data‚Äù and the practice of its application in Russian reality</a></li>
<li><a href="../281232/index.html">Honda has improved the management of the power plant of a Formula 1 car with the help of IBM Watson IoT</a></li>
<li><a href="../281234/index.html">New vulnerability Flash Player is exploited in-the-wild</a></li>
<li><a href="../281236/index.html">Garbage collection in the persistent model: from terabyte and beyond</a></li>
<li><a href="../281240/index.html">Add ECMAScript 2015 support to ExtJS6</a></li>
<li><a href="../281242/index.html">NVRAM device in UEFI-compatible firmware, part one</a></li>
<li><a href="../281244/index.html">Five tips for anyone posting their .Net project on GitHub</a></li>
<li><a href="../281246/index.html">The faces of technology. Overview of the presentations of the largest technology companies</a></li>
<li><a href="../281248/index.html">Defeating the evil volcano with Rails and RGeo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>