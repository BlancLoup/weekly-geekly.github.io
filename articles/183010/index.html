<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHPUnit: a simple syntax for creating mock objects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. why not mockery 
2. main advantage - syntax 
3. moki - native 
4. creating stub objects 
5. mocking class properties 
6. mock injection 
7. conveni...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHPUnit: a simple syntax for creating mock objects</h1><div class="post__text post__text-html js-mediator-article"><img src="http://cdn.tutsplus.com/net.tutsplus.com/authors/gabriel-manricks/2013_year_of_PHP_PHPUnit.png" align="left"><br><br><ol><li>  why not mockery </li><li>  main advantage - syntax </li><li>  moki - native </li><li>  creating stub objects </li><li>  mocking class properties </li><li>  mock injection </li><li>  convenient methods for working with Reflection </li><li>  how to add to the project </li></ol><br><a name="habracut"></a><br><h2>  Why not mockery </h2><br>  PHPUnit is the standard, most common framework for writing unit tests in the PHP world.  No wonder - he copes well with the responsibilities assigned to him.  But if we talk about the standard syntax for creating mock-objects, many people complain about its some cumbersome.  They offer various plugins for creating mocks, such as Mockery (I understand that this is not just a plugin). <br><br>  However, I am sure that PHPUnit has a well-developed system for creating mocks to continue using it.  PHPUnit is actively developing: mocking of traits, mocking of nonexistent classes for TDD were added not so long ago. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And this XPMock project is a way to simplify the syntax for creating mocks.  It should be emphasized that XPMock does not create its own mocks, and does not make any wrappers over the mocks of PHPUnit.  XPMock calls the same PHPUnit methods, thus creating the same Mocks, only slightly simpler. <br><br><h2>  The main advantage is syntax. </h2><br>  The standard syntax for creating a mock (stub object with three methods) in PHPUnit looks like this: <br><br><pre><code class="php hljs">$mock = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getMockBuilder(<span class="hljs-string"><span class="hljs-string">'MyClass'</span></span>) -&gt;setMethods([<span class="hljs-string"><span class="hljs-string">'getBool'</span></span>, <span class="hljs-string"><span class="hljs-string">'getNumber'</span></span>, <span class="hljs-string"><span class="hljs-string">'getString'</span></span>]) -&gt;disableOriginalConstructor() -&gt;getMock(); $mock-&gt;expects(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;any()) -&gt;method(<span class="hljs-string"><span class="hljs-string">'getBool'</span></span>) -&gt;will(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;returnValue(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); $mock-&gt;expects(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;any()) -&gt;method(<span class="hljs-string"><span class="hljs-string">'getNumber'</span></span>) -&gt;will(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;returnValue(<span class="hljs-number"><span class="hljs-number">1</span></span>)); $mock-&gt;expects(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;any()) -&gt;method(<span class="hljs-string"><span class="hljs-string">'getString'</span></span>) -&gt;will(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;returnValue(<span class="hljs-string"><span class="hljs-string">'string'</span></span>));</code> </pre> <br><br>  Those who mock most of the dependencies in unit tests notice that the test code grows very quickly because of such constructions. <br><br>  If you use XPMock, the creation of mock becomes much shorter: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mock(<span class="hljs-string"><span class="hljs-string">'MyClass'</span></span>) -&gt;getBool(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) -&gt;getNumber(<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt;getString(<span class="hljs-string"><span class="hljs-string">'string'</span></span>) -&gt;new();</code> </pre><br><br><h2>  Moki - native </h2><br>  XPMock <br>  - does not create its own moki <br>  - does not make additional wrappers over mocks PHPUnit <br>  - supports all native PHPUnit constructs <br><br>  For example, <br><br><pre> <code class="php hljs">$mock-&gt;getNumber(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;once())</code> </pre><br><br>  it's the same as writing <br><br><pre> <code class="php hljs">$mock-&gt;expects(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;once()) -&gt;method(<span class="hljs-string"><span class="hljs-string">'getNumber'</span></span>) -&gt;will(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;returnValue(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>))</code> </pre><br><br>  Other examples of a short recording of commonly used constructions can be found here: <a href="https://github.com/ptrofimov/xpmock">github.com/ptrofimov/xpmock</a> <br><br><h2>  Creating stub objects </h2><br>  Stub objects, or stub objects, are mock objects in which all methods by default override the actual methods and return null.  In PHPUnit, in the syntax there is no division into mocks, stubs, and others like them.  All artificial objects for testing are created using getMock or getMockBuilder. <br><br>  In XPMock, a special stub method is included that returns a mock, for which all methods return null by default.  This improves the readability of the code, and eliminates the need to call the setMethods method when creating real mocks. <br><br><h2>  Mock class properties </h2><br>  PHPUnit cannot mock class properties.  XPMock too.  However, it provides convenient methods for setting properties of the created mock via Reflection.  The assignments specified when creating the mock will be executed immediately after calling the new constructor method. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mock(<span class="hljs-string"><span class="hljs-string">'MyClass'</span></span>) -&gt;__set(<span class="hljs-string"><span class="hljs-string">'property'</span></span>, $value) -&gt;new();</code> </pre><br><br>  You can use the familiar syntax of setting properties without using magic methods. <br><br><h2>  Mock injection </h2><br>  Very often, when creating mocks, they need to be immediately embedded into other objects.  For example, create a singleton instance and embed a reference to it in a static instance variable of the same class.  This is usually done via Reflection.  XPMock and here provides a convenient syntax for such actions. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mock(<span class="hljs-string"><span class="hljs-string">'MyClass'</span></span>) -&gt;injectTo($object, <span class="hljs-string"><span class="hljs-string">'property'</span></span>) -&gt;new();</code> </pre><br><br><h2>  Convenient methods for working with Reflection </h2><br>  XPMock provides a common short syntax for working with objects via Reflection. <br><br>  For example, to get a private property of an object, you usually need to write this: <br><br><pre> <code class="php hljs">$property = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ReflectionProperty(<span class="hljs-string"><span class="hljs-string">'MyClass'</span></span>, <span class="hljs-string"><span class="hljs-string">'property'</span></span>); $property-&gt;setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $value = $property-&gt;getValue($object);</code> </pre><br><br>  With XPMock you can do it like this: <br><br><pre> <code class="php hljs">$value = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;reflect(<span class="hljs-string"><span class="hljs-string">'MyClass'</span></span>)-&gt;property;</code> </pre><br><br>  With this syntax, you can get the values ‚Äã‚Äãof closed / open static / non-static properties of objects, as well as call private methods. <br><br><h2>  How to add to the project </h2><br>  XPMock is easily integrated into existing tests and does not interfere with the native syntax for creating mocks PHPUnit. <br><br>  Option 1. Add XPMock trait to an existing test (suitable for PHP&gt; = 5.4) <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyTestCase</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PHPUnit_Framework_TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">Xpmock</span></span>\<span class="hljs-title"><span class="hljs-title">TestCaseTrait</span></span>; }</code> </pre><br><br>  Option 2. Inherit the test class from the corresponding XPMock class (suitable for PHP&gt; = 5.3) <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyTestCase</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Xpmock</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre><br><br>  Adding XPMock to a project is very simple - through the composer dependency manager.  Installation instructions for 2 steps here - <a href="https://github.com/ptrofimov/xpmock">github.com/ptrofimov/xpmock#installation</a> </div><p>Source: <a href="https://habr.com/ru/post/183010/">https://habr.com/ru/post/183010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../182996/index.html">And again about video surveillance</a></li>
<li><a href="../182998/index.html">Spatial hashing for the smallest</a></li>
<li><a href="../183004/index.html">XQuery enhancements in MarkLogic Server</a></li>
<li><a href="../183006/index.html">Electricity Lessons - Transmission Lines</a></li>
<li><a href="../183008/index.html">Deferred objects in AngularJS</a></li>
<li><a href="../183012/index.html">Windows Server 2012 - life without GUI</a></li>
<li><a href="../183016/index.html">External impact on the web client 1C: Enterprise</a></li>
<li><a href="../183018/index.html">Web Design + Mac OS - Adobe = Sketch. The new tool is better than all the old</a></li>
<li><a href="../183022/index.html">Random'ization in Python. Is it random?</a></li>
<li><a href="../183024/index.html">Numbers in itself</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>