<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenGL ES 3.0 in Android 4.3 - ETC2 texture compression</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Just recently a new version of Android has been released - 4.3. Already long before its release, there were leaks first for the Galaxy S4, and then th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenGL ES 3.0 in Android 4.3 - ETC2 texture compression</h1><div class="post__text post__text-html js-mediator-article">  Just recently a new version of Android has been released - 4.3.  Already long before its release, there were leaks first for the Galaxy S4, and then the Nexus 4. In these firmware, I immediately found libraries for working with OpenGL ES 3.0, which was overjoyed - rumors that the demos of OpenGL ES 3.0 shown back in March HTC One is working on native Android libraries, confirmed (as well as rumors of support for Bluetooth Low Energy). <br><br>  And on Friday evening, the OTA updates came to our two devices at the same time - the Nexus 4 and the Nexus 10. On the Nexus 7, the update has not yet arrived at 4.3, but this does not upset us at all (why - I will explain later).  Of course, my hands itched to try this good. <br><br><img src="https://habrastorage.org/storage2/cc8/e91/39f/cc8e9139f99b303ac1084eb5659f2e6d.png"><br><a name="habracut"></a><br><h4>  Introduction - What's new in OpenGL ES 3.0 </h4><br>  The new version of OpenGL ES 3.0 has a number of new features that I will not list, you can learn about them from the documentation here: <a href="http://www.khronos.org/opengles/3_X">www.khronos.org/opengles/3_X</a> <br>  and in a brief press release here: <a href="https://www.khronos.org/news/press/khronos-releases-opengl-es-3.0-specification">www.khronos.org/news/press/khronos-releases-opengl-es-3.0-specification</a> <br>  In this article, we will touch upon the simplest and fastest-to-use feature of OpenGL ES 3.0 ‚Äî the new standard ETC2 texture compression format. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  ETC2 </h4><br>  The ETC2 compression format was developed based on ETC1 and its principle of operation is based on sequences of bits not used in ETC1.  In order to understand the genius of how we managed to expand ETC1 to ETC2, it is worth reading these documents: <br>  Description of the compression algorithm: <a href="http://www.jacobstrom.com/publications/StromPetterssonGH07.pdf">www.jacobstrom.com/publications/StromPetterssonGH07.pdf</a> <br>  and a description of the ETC2 format: <a href="http://www.graphicshardware.org/previous/www_2007/presentations/strom-etc2-gh07.pdf">www.graphicshardware.org/previous/www_2007/presentations/strom-etc2-gh07.pdf</a> <br><br>  ETC2, as well as ETC1, works with blocks of 4x4 pixels, but for each block a certain compression algorithm is selected - the usual ETC1 or one of three additional algorithms. <br><br>  As a result, ETC2 has turned out to be a very balanced compression algorithm, which allows both to preserve the sharpness of the boundaries in some blocks and not distort smooth gradients in others. <br><br>  Here is an example of compressing various images from documents: <br><br><img src="https://habrastorage.org/storage2/a5f/c3f/3b1/a5fc3f3b197924f9fa91d45d61d21e35.png"><br><br><h4>  Initializing OpenGL ES 3.0 </h4><br>  To initialize OpenGL ES 3.0 in Android 4.3, no additional manipulations are required.  You should create the usual OpenGL ES 2.0 context.  If the GPU supports OpenGL ES 3.0, then Android automatically creates the OpenGL ES 3.0 context, which is fully backward compatible with OpenGL ES 2.0.  That is, on Android 4.3, all applications using OpenGL ES 2.0 actually work with OpenGL ES 3.0.  In order to make sure that the received context is 3.0, you should check the string GL_VERSION.  Sample code from Android 4.3 source: <a href="">android.googlesource.com/platform/frameworks/base/+/android-4.3_r0.9/libs/hwui/Extensions.cpp</a> <br>  Thanks to Romain Guy for this and other explanations about using OpenGL ES 3.0 on release day 4.3: <a href="https://plus.google.com/u/0/%2BRomainGuy/posts/iJmTjpUfR5E">plus.google.com/u/0/+RomainGuy/posts/iJmTjpUfR5E</a> <br><br>  Java code example: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mOpenGLVersionMajor; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mOpenGLVersionMinor; String strGLVersion = GLES20.glGetString(GLES20.GL_VERSION); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strGLVersion != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Scanner scanner = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scanner(strGLVersion); scanner.useDelimiter(<span class="hljs-string"><span class="hljs-string">"[^\\w']+"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (scanner.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (scanner.hasNextInt()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i == <span class="hljs-number"><span class="hljs-number">0</span></span>) { mOpenGLVersionMajor = scanner.nextInt(); i++; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i == <span class="hljs-number"><span class="hljs-number">1</span></span>) { mOpenGLVersionMinor = scanner.nextInt(); i++; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (scanner.hasNext()) { scanner.next(); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isES2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mOpenGLVersionMajor == <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isES3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mOpenGLVersionMajor == <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre> <br><h4>  nVidia </h4><br>  Then perhaps it makes sense to explain why we don‚Äôt care about the delay in updating Nexus 7 to Android 4.3.  The fact is that nVidia Tegra 2/3 chips do not support OpenGL ES 3.0.  Unfortunately, even Tegra 4 does not support it.  Nvidia simply continues to push its desktop solutions into mobile chips, and their marketing department pushes this outdated solution successfully.  That there is a very ridiculous justification for this in the Tegra 4 Whitepaper, page 11: <a href="http://www.nvidia.com/docs/IO/116757/Tegra_4_GPU_Whitepaper_FINALv2.pdf">www.nvidia.com/docs/IO/116757/Tegra_4_GPU_Whitepaper_FINALv2.pdf</a> They admit that the chip does not support the full ES 3.0 specification, and openly say that it‚Äôs ‚Äúwe We do not expect that soon applications / games will use ES 3.0 ‚Äù.  Surprise - Android 4.3 itself uses OpenGL ES 3.0. <br><br>  Although despite the fact that nVidia is not going to expand the current chips to support ES 3.0, Tegra 5 will still support it: <a href="http://www.ubergizmo.com/2013/07/nvidia-tegra-5-release-date-specs-news/">www.ubergizmo.com/2013/07/nvidia-tegra-5-release-date-specs-news</a> <br><br><h4>  Creating compressed textures </h4><br>  To create an ETC2 texture, use the Mali Texture Compression Tool: <a href="http://malideveloper.arm.com/develop-for-mali/mali-gpu-texture-compression-tool/">malideveloper.arm.com/develop-for-mali/mali-gpu-texture-compression-tool</a> .  To obtain the best quality texur, the compression method ‚ÄúSlow‚Äù and Error Metric ‚ÄúPerceptual‚Äù were used. <br><img src="https://habrastorage.org/storage2/0a5/871/6ed/0a58716ed96129224cddd8e7fdb6551f.png"><br>  Below are images for comparing the compression quality of ETC1 and ETC2, as well as the difference between the original and the compressed image, enhanced 4 times for clarity. <br><img src="https://habrastorage.org/storage2/cff/fc5/e33/cfffc5e338f8caf43058e61489d2a7df.png"><br>  When compressing the texture in ETC1, artifacts are visible in the form of horizontal (especially well visible) and vertical stripes.  When compressing ETC2, these artifacts are virtually absent. <br>  In our live wallpapers, on areas of scenes for which the texture quality is critical, we use uncompressed textures.  As seen in the comparative image, ETC1 introduces the most noticeable distortion in textures with smooth gradients ‚Äî compression artifacts are clearly visible, caused by the compression feature of squares measuring 4x4 pixels.  Therefore, we apply textures without compression to the sky, and they take up quite a lot of space - because their size is 2048x512.  Compression in the PVRTC format also gives fairly good texture quality, but is only available on PowerVR chips.  The use of the standard for ES 3.0 format ETC2 allowed us to achieve an acceptable texture quality while reducing the amount of video memory allocated for the texture by 4 times: <br>  For texture 2048x512: <br>  Uncompressed (16-bit color 565 - 2 bytes per pixel): 2 * 2048 * 512 = 2097152 // 2 MB of data <br>  Compressed (16 bytes - PKM header): 524304-16 = 524288 // 512 kB data. <br><br><h4>  Loading ETC2 textures </h4><br>  The texture is loaded from a .pkm file.  The same format is used to store ETC1 textures.  The header format is described here: <a href="http://forums.arm.com/index.php%3F/topic/15835-pkm-header-format/">forums.arm.com/index.php?/topic/15835-pkm-header-format</a> <br><br>  I decided not to try to load ETC2 textures using ETC1Util, since it has header validation. <br>  Texture Download Code: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadETC2Texture</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String filename, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> compression, Boolean bClamp, Boolean bHighQuality)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] textures = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>]; GLES20.glGenTextures(<span class="hljs-number"><span class="hljs-number">1</span></span>, textures, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> textureID = textures[<span class="hljs-number"><span class="hljs-number">0</span></span>]; GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureID); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bHighQuality) { GLES20.glTexParameterf(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR); GLES20.glTexParameterf(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { GLES20.glTexParameterf(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_NEAREST); GLES20.glTexParameterf(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bClamp) { GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_CLAMP_TO_EDGE); GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_CLAMP_TO_EDGE); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT); GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT); } InputStream is = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { is = mWallpaper.getContext().getAssets().open(filename); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e1) { e1.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data = readFile(is); ByteBuffer buffer = ByteBuffer.allocateDirect(data.length).order(ByteOrder.LITTLE_ENDIAN); buffer.put(data).position(PKM_HEADER_SIZE); ByteBuffer header = ByteBuffer.allocateDirect(PKM_HEADER_SIZE).order(ByteOrder.BIG_ENDIAN); header.put(data, <span class="hljs-number"><span class="hljs-number">0</span></span>, PKM_HEADER_SIZE).position(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> width = header.getShort(PKM_HEADER_WIDTH_OFFSET); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> height = header.getShort(PKM_HEADER_HEIGHT_OFFSET); GLES20.glCompressedTexImage2D(GLES20.GL_TEXTURE_2D, <span class="hljs-number"><span class="hljs-number">0</span></span>, compression, width, height, <span class="hljs-number"><span class="hljs-number">0</span></span>, data.length - PKM_HEADER_SIZE, buffer); checkGlError(<span class="hljs-string"><span class="hljs-string">"Loading of ETC2 texture; call to glCompressedTexImage2D()"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Log.w(TAG, <span class="hljs-string"><span class="hljs-string">"Could not load ETC2 texture: "</span></span> + e); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { is.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-comment"><span class="hljs-comment">// ignore exception thrown from close. } } return textureID; } ... if (isES3()) { textureID = loadETC2Texture("textures/etc2/sky1.pkm", GLES30.GL_COMPRESSED_RGB8_ETC2, false, false); } else { textureID = loadTexture("textures/sky1.png"); } ...</span></span></code> </pre><br>  Thus, if there is an ES 3.0 context, the ETC2 texture will load, and in ES 2.0 mode, the normal uncompressed texture. <br><br>  Of course, to access the GLES30 class, you need to set android: targetSdkVersion = "18" in the application manifest and target = android-18 in the project.properties. <br><br><h4>  Result </h4><br>  In the application, the difference between the uncompressed texture (without distortion) and ETC2 is not noticeable: <br><br> <a href=""><img src="https://habrastorage.org/storage2/7b4/0cf/726/7b40cf726675c5b578125c5cc2b35753.png"></a> <br>  The application is available here: <a href="https://play.google.com/store/apps/details%3Fid%3Dorg.androidworks.livewallpapercarfree">play.google.com/store/apps/details?id=org.androidworks.livewallpapercarfree</a> <br><br><h4>  Conclusion </h4><br>  We always try to use the new features of each new version of Android to optimize performance and enhance capabilities.  In particular, wallpaper support and work in the screen saver mode - daydream.  Although the article was not large enough, but I hope that our modest experience in using ETC2 can help someone to optimize their applications. <br><br><h5>  PS </h5><br>  If someone has set themselves the leaked 4.3 firmware for Samsung Galaxy S4, please check the operation of this application on this device. </div><p>Source: <a href="https://habr.com/ru/post/188252/">https://habr.com/ru/post/188252/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188240/index.html">AWS: Cloudwatch + SNS</a></li>
<li><a href="../188242/index.html">Search through sphinx in django 1.6 admin</a></li>
<li><a href="../188244/index.html">Hidden Markov chains, Bauma-Welch algorithm</a></li>
<li><a href="../188246/index.html">Sample Exam at the Faculty of Computer Science at TU Dresden</a></li>
<li><a href="../188248/index.html">Editing Configs in Python</a></li>
<li><a href="../188254/index.html">JS Library Performance Comparison</a></li>
<li><a href="../188258/index.html">The Old Reader is no longer public</a></li>
<li><a href="../188262/index.html">YAF - language reporting forms</a></li>
<li><a href="../188266/index.html">Site Logo Animation</a></li>
<li><a href="../188268/index.html">test.it - ‚Äã‚Äãjavascript testing or my bike with nesting and detailed output</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>