<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As I wrote the web app angular + material and REST on Yii2 + webserver nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I'll start with the background of the project itself. The thought came to my mind quite by accident - I clearly did not have enough additional respons...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As I wrote the web app angular + material and REST on Yii2 + webserver nginx</h1><div class="post__text post__text-html js-mediator-article">  I'll start with the background of the project itself.  The thought came to my mind quite by accident - I clearly did not have enough additional responsibility to work on my projects.  So I decided to create a portal where I could stimulate my own motivation, publicly risking reputation and money. <br><br>  Well, now get down to business.  The topic is extensive, but I hope that at the output I will be able to convey the whole picture and recall all the pitfalls that surfaced before the project was created.  I will point out all the primary sources that I used to help those who want to write their application on angular.  Yes, actually, everyone will be able to find answers to most of their questions on this topic in a single series of articles. <br><a name="habracut"></a><br>  I have long cherished the idea of ‚Äã‚Äãtesting <a href="http://material.angularjs.org/">material.angularjs.org</a> on some kind of combat project.  Then an idea arose and I decided ... It looked pretty simple in appearance - a set of ready-made components = fast development, familiar Yii and ... on the backend, but ... I didn‚Äôt expect that a small application would be a little more than originally planned, and there would be such a fuss with the web server.  As they say, oops ... <br><br>  It all started with the nginx configuration.  It turned out that I needed to redirect all requests, except for a certain REST location, to index.html, where I started to work on angular.  The first configuration looked like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">charset</span></span> utf-<span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> truemania.ru; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /path/to/root; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /path/to/root/log/access.log; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /path/to/root/log/error.log; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-comment"><span class="hljs-comment"># Angular app conf root /path/to/root/frontend/web; try_files $uri $uri/ /index.html =404; } location ~* \.php$ { include fastcgi_params; #fastcgi_pass 127.0.0.1:9000; fastcgi_pass unix:/var/run/php5-fpm.sock; try_files $uri =404; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; } # avoid processing of calls to non-existing static files by Yii (uncomment if necessary) location ~* \.(css|js|jpg|jpeg|png|gif|bmp|ico|mov|swf|pdf|zip|rar)$ { try_files $uri =404; } location ~* \.(htaccess|htpasswd|svn|git) { deny all; } location /api-location { client_max_body_size 2000M; alias /path/to/root/frontend/web; try_files $uri /frontend/web/index.php?$args; location ~* ^/api-location/(.+\.php)$ { try_files $uri /frontend/web/$1?$args; } } }</span></span></code> </pre> <br>  Here all our API is located by location / api-location.  Angular $ routeProvider configuration: <br><br><pre> <code class="javascript hljs">app.config([<span class="hljs-string"><span class="hljs-string">'$routeProvider'</span></span>, <span class="hljs-string"><span class="hljs-string">'$locationProvider'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$routeProvider, $locationProvider</span></span></span><span class="hljs-function">) </span></span>{ $routeProvider. when(<span class="hljs-string"><span class="hljs-string">'/route1'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">templateUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'/views/route1.html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">controller</span></span>: <span class="hljs-string"><span class="hljs-string">'route1Ctrl'</span></span> }). when(<span class="hljs-string"><span class="hljs-string">'/route2'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">templateUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'/views/route2.html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">controller</span></span>: <span class="hljs-string"><span class="hljs-string">'route2Ctrl'</span></span> }). when(<span class="hljs-string"><span class="hljs-string">'/route3'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">templateUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'/views/route3.html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">controller</span></span>: <span class="hljs-string"><span class="hljs-string">'route3Ctrl'</span></span> }). otherwise({ <span class="hljs-attr"><span class="hljs-attr">redirectTo</span></span>: <span class="hljs-string"><span class="hljs-string">'/route1'</span></span> }); <span class="hljs-comment"><span class="hljs-comment">// use the HTML5 History API $locationProvider.html5Mode({ enabled: true, requireBase: false }); }]);</span></span></code> </pre><br>  But how will the angular site be indexed?  The decision at once came to a head that it is necessary to give a statics separately.  A little googling, found information about? _Escaped_fragment.  It was necessary to separately generate statics and give on requests of the type <code><a href="http://truemania.ru/%3F_escaped_fragment"></a> truemania.ru/?_escaped_fragment</code>  <code><a href="http://truemania.ru/%3F_escaped_fragment"></a> truemania.ru/?_escaped_fragment</code> ready for indexing fragments. <br><br>  During a short search, I came across an <a href="http://habrahabr.ru/post/187008/">article</a> where the indexing mechanism for angular sites was described in detail, just for the nginx server.  A few more locations have been added to the configuration: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$args</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ "_escaped_fragment_=(.*)")</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">rewrite</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^</span></span> /snapshot<span class="hljs-variable"><span class="hljs-variable">${uri}</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /snapshot { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://help.truemania.ru/snapshot; <span class="hljs-attribute"><span class="hljs-attribute">proxy_connect_timeout</span></span> <span class="hljs-number"><span class="hljs-number">60s</span></span>; }</code> </pre><br>  We create a second-level domain, where requests for the return of ready-made fragments will be processed.  On request type <br><pre> <code class="html hljs xml">http://truemania.ru/user/50?_escaped_fragment_=</code> </pre><br>  You'll get <br><pre> <code class="html hljs xml">http://help.truemania.ru/snapshot/user/50</code> </pre><br><br>  It remains only to create all the necessary impressions that need to give the search bot.  In doing so, I used the standards of micromaps <a href="http://schema.org/">schema.org</a> .  Who is not familiar with the world of semantic markup, I advise you to read <a href="http://habrahabr.ru/company/yandex/blog/211638/">in this article</a> . <br><br>  Creating a dynamic sitemap is described in great detail in <a href="http://www.elisdn.ru/blog/38/sitemap-for-yii-project">this article</a> - I advise you to read.  But it is a pity that the solution for the first version of Yii is described here.  Sitemap is created with each new request again, which can cause a very high load on the server.  Exit - creating a console controller and updating the sitemap at intervals of 10 minutes using crontab.  Having changed the source code quite a bit, I got a good solution for the Yii2 console: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">console</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> ElisDN &lt;mail</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@elisdn</span></span></span><span class="hljs-comment">.ru&gt; * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> http://www.elisdn.ru */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DSitemap</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ALWAYS = <span class="hljs-string"><span class="hljs-string">'always'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> HOURLY = <span class="hljs-string"><span class="hljs-string">'hourly'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DAILY = <span class="hljs-string"><span class="hljs-string">'daily'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WEEKLY = <span class="hljs-string"><span class="hljs-string">'weekly'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MONTHLY = <span class="hljs-string"><span class="hljs-string">'monthly'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> YEARLY = <span class="hljs-string"><span class="hljs-string">'yearly'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NEVER = <span class="hljs-string"><span class="hljs-string">'never'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $items = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $url * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $changeFreq * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> float $priority * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $lastMod */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addUrl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url, $changeFreq=self::DAILY, $priority = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.5</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $lastMod = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $host = Yii::$app-&gt;urlManager-&gt;getBaseUrl(); $item = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'loc'</span></span> =&gt; $host . $url, <span class="hljs-string"><span class="hljs-string">'changefreq'</span></span> =&gt; $changeFreq, <span class="hljs-string"><span class="hljs-string">'priority'</span></span> =&gt; $priority ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($lastMod) $item[<span class="hljs-string"><span class="hljs-string">'lastmod'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;dateToW3C($lastMod); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;items[] = $item; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \yii\db\ActiveRecord[] $models * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $changeFreq * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> float $priority */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addModels</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($models, $changeFreq=self::DAILY, $priority=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.5</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $host = Yii::$app-&gt;urlManager-&gt;getBaseUrl(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($models <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $model) { $item = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'loc'</span></span> =&gt; $host . $model-&gt;getUrl(), <span class="hljs-string"><span class="hljs-string">'changefreq'</span></span> =&gt; $changeFreq, <span class="hljs-string"><span class="hljs-string">'priority'</span></span> =&gt; $priority ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($model-&gt;hasAttribute(<span class="hljs-string"><span class="hljs-string">'create_date'</span></span>)) $item[<span class="hljs-string"><span class="hljs-string">'lastmod'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;dateToW3C($model-&gt;create_date); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;items[] = $item; } } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string XML code */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $dom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DOMDocument(<span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>); $urlset = $dom-&gt;createElement(<span class="hljs-string"><span class="hljs-string">'urlset'</span></span>); $urlset-&gt;setAttribute(<span class="hljs-string"><span class="hljs-string">'xmlns'</span></span>,<span class="hljs-string"><span class="hljs-string">'http://www.sitemaps.org/schemas/sitemap/0.9'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;items <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $item) { $url = $dom-&gt;createElement(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($item <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key=&gt;$value) { $elem = $dom-&gt;createElement($key); $elem-&gt;appendChild($dom-&gt;createTextNode($value)); $url-&gt;appendChild($elem); } $urlset-&gt;appendChild($url); } $dom-&gt;appendChild($urlset); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $dom-&gt;saveXML(); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dateToW3C</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($date)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_int($date)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> date(DATE_W3C, $date); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> date(DATE_W3C, strtotime($date)); } }</code> </pre><br>  Console action: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionGetsitemap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $sitemap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DSitemap(); $sitemap-&gt;addModels(Model1::find()-&gt;active()-&gt;all(), DSitemap::HOURLY); $sitemap-&gt;addModels(Model2::find()-&gt;all(), DSitemap::HOURLY); $sitemap-&gt;addModels(Model3::find()-&gt;all(), DSitemap::HOURLY); $path = \Yii::getAlias(<span class="hljs-string"><span class="hljs-string">"@frontend/web"</span></span>) . DIRECTORY_SEPARATOR . <span class="hljs-string"><span class="hljs-string">"sitemap.xml"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file_put_contents($path, $sitemap-&gt;render()); }</code> </pre><br>  Configuration crontab to run every 10 min. <br><br> <code>*/10 * * * * /path/to/yii cron/getsitemap &gt;&gt; /path/to/log/command_log/getsitemap.log; <br></code> <br><br>  This solution is optimal and very productive, so we get quite relevant data.  If necessary, you can recreate the sitemap with more frequent or less frequent intervals. <br><br>  Then went to work on a beautiful output of links in social networks.  For those who are not in the subject, this is the markup standard <a href="http://ogp.me/">http://ogp.me/</a> .  I was very disappointed that the bots did not understand the meta <br>  ‚ÄîTag: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fragment"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  At this stage, I stumbled a bit, since there was no solution elementary in the forehead.  I wanted to make bots understand that there is a real fragment behind the page.  Googling, I decided to give fragments on the user-agent.  I had to study the documentation for the corresponding service to get an approximate user-agent, which could be extracted using regular expressions. <br><br>  My configuration for sharing statics to social networking bots: <br><br><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">#     user-agent ‚Äî    ,   if ( $http_user_agent ~* (facebookexternalhit|facebot|twitterbot|tinterest|google.*snippet|vk.com|vkshare) ){ rewrite ^ /snapshot${uri}; }</span></span></code> </pre><br>  Naturally, it remains to include information on the open graph markup in my casts. <br><br>  Next, I wanted to use websocket in some very beneficial points - it was perfectly suited for solving such tasks as online / offline state for the user.  Of course, the websocket themselves is a very non-standard thing for PHP, but a ready-made solution was quickly found - <a href="http://socketo.me/">http://socketo.me/</a> . <br><br>  It remains only to understand how I run these sockets on Yii2 in ubuntu.  Actually, I created a console controller, and this is what action looked like: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionWebsocketaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $server = IoServer::factory( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpServer( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WsServer( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserOnline() ) ), <span class="hljs-number"><span class="hljs-number">8099</span></span>, <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span> ); $server-&gt;run(); }</code> </pre><br>  Well, and further I apply the UserOnline model itself: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">console</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">common</span></span>\<span class="hljs-title"><span class="hljs-title">modules</span></span>\<span class="hljs-title"><span class="hljs-title">core</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ratchet</span></span>\<span class="hljs-title"><span class="hljs-title">MessageComponentInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ratchet</span></span>\<span class="hljs-title"><span class="hljs-title">ConnectionInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">web</span></span>\<span class="hljs-title"><span class="hljs-title">ServerErrorHttpException</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserOnline</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageComponentInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *  ,    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> USER_OFFLINE = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> USER_ONLINE = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//       resourceId public function onOpen(ConnectionInterface $conn) { echo "New connection! ({$conn-&gt;resourceId})\n"; } //   ,     online public function onMessage(ConnectionInterface $from, $username) { $model = UserOnlineConnections::findByUsername($username); if(empty($model)) { $model = new UserOnlineConnections(); //     ,     $model-&gt;username = preg_replace('/\\r\\n$/', '', $username); $model-&gt;conn_id = $from-&gt;resourceId; if(!($model-&gt;validate() &amp;&amp; $model-&gt;save())) throw new ServerErrorHttpException(json_encode($model-&gt;getErrors())); } else { $model-&gt;conn_id = $from-&gt;resourceId; if(!($model-&gt;validate() &amp;&amp; $model-&gt;save())) throw new ServerErrorHttpException(json_encode($model-&gt;getErrors())); } echo "New user online $model-&gt;username \n"; self::setUserStatus($username, self::USER_ONLINE); } //   ‚Äî   offline public function onClose(ConnectionInterface $conn) { echo "Close connection! ({$conn-&gt;resourceId})\n"; $username = UserOnlineConnections::findByConnId($conn-&gt;resourceId)-&gt;username; if($username) { //Set status offline echo "User offline $username \n"; self::setUserStatus($username, self::USER_OFFLINE); } } //  ‚Äî   offline public function onError(ConnectionInterface $conn, \Exception $e) { $username = UserOnlineConnections::findByConnId($conn-&gt;resourceId)-&gt;username; if($username) { //Set status offline echo "User offline $username \n"; self::setUserStatus($username, self::USER_OFFLINE); echo "An error has occurred: {$e-&gt;getMessage()}\n"; $conn-&gt;close(); } } /** *     * @param $username * @param $status * @return bool * @throws ServerErrorHttpException */ public function setUserStatus($username, $status) { $model = User::findByUsername($username); if ($model) { $model-&gt;online = $status; if(!($model-&gt;validate() &amp;&amp; $model-&gt;save())) throw new ServerErrorHttpException(json_encode($model-&gt;getErrors())); return true; } if($status == self::USER_OFFLINE) { UserOnlineConnections::deleteAll( "username=".$username ); } } }</span></span></code> </pre><br>  It remains only to run it all.  It was necessary to conclude stderr in stdout, but for some reason &amp;&gt; did not want to work.  The solution came through nohup.  The launch of the socket looked like this: <br><br><pre> <code class="bash hljs">nohup /path/to/yii ws/useronline &gt;&gt; /path/to/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/command_log/useronline.log;</code> </pre><br>  Also in the event of a fall, you must restart this process.  I didn‚Äôt find a more elegant solution, like to run the command in crontab every minute.  If the port is busy, nothing will happen (an error will be issued), but if the port is free, the process will be restarted. <br><br>  Next, you need to proxy the websocet using nginx.  And here the following lines were added to the configuration: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> useronline { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:8099</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">map</span></span> <span class="hljs-variable"><span class="hljs-variable">$http_upgrade</span></span> <span class="hljs-variable"><span class="hljs-variable">$connection_upgrade</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> upgrade; '' close; } <span class="hljs-comment"><span class="hljs-comment">#    server server { #ws proxy location /useronline { proxy_set_header X-Real-IP $remote_addr; proxy_set_header Host $host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; proxy_pass http://useronline; } }</span></span></code> </pre><br>  Now our web socket will be available at ws: //truemania.ru/useronline. <br><br>  And the last thing I encountered (from the settings of the web server) in the development process is the transition to the https protocol.  The problem was the following - facebook and google + wanted the pictures to be given over http, and stubbornly did not want to display a picture in the preview.  To do this, I had to change the configuration, namely, to force the server to give the media files via http: <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> truemania.ru; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /path/to/frontend/web; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> https://<span class="hljs-variable"><span class="hljs-variable">$server_name</span></span><span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>; <span class="hljs-comment"><span class="hljs-comment"># enforce https } #   http location ~* \.(css|js|jpg|jpeg|png|gif|bmp|ico|mov|swf|pdf|zip|rar)$ { try_files $uri =404; } } server { charset utf-8; listen 443 ssl; ssl_certificate /path/to/ssl/truemania.crt; ssl_certificate_key /path/to/ssl/truemania.key; }</span></span></code> </pre><br>  Also, after the protocol has changed, the call to socet occurs at wss: //truemania.ru/useronline. <br><br>  Well, if you like it, then in the next article I will tell you how the web application itself + backend wrote, describe interesting solutions on angular - such as authorization, permissions for authorized and unauthorized users, use requireJS. </div><p>Source: <a href="https://habr.com/ru/post/274867/">https://habr.com/ru/post/274867/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274855/index.html">Dangerous video: how I found a vulnerability in video hosting and did not die after 7 days</a></li>
<li><a href="../274857/index.html">New in Wolfram Language | Analytical solution of partial differential equations</a></li>
<li><a href="../274859/index.html">Implementing a list of used libraries using DialogFragment in Android application</a></li>
<li><a href="../274863/index.html">Checking IronPython and IronRuby with PVS-Studio</a></li>
<li><a href="../274865/index.html">Sir Charles Anthony Richard Hoare or just Dad Quicksort, NULL and Problems of Dining Philosophers</a></li>
<li><a href="../274871/index.html">Linus Torvalds announced the release of the Linux 4.4 LTS kernel (Long-Term Support)</a></li>
<li><a href="../274873/index.html">Static, Aggregate and Generate routes at JunOS</a></li>
<li><a href="../274875/index.html">Debugging Groovy scripts with Grape based on maven aether</a></li>
<li><a href="../274877/index.html">Mercurial: changing history</a></li>
<li><a href="../274879/index.html">Reverse engineering laser distance sensor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>