<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to get and measure high-speed TCP connection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Reliable data transmission on the Internet is based on the TCP ( Transmission Control Protocol ) protocol , the specification for which was published ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to get and measure high-speed TCP connection</h1><div class="post__text post__text-html js-mediator-article">  Reliable data transmission on the Internet is based on the TCP ( <b>Transmission Control Protocol</b> ) <b>protocol</b> , the specification for which was published almost 30 years ago.  The TCP algorithm ( <a href="http://www.ietf.org/rfc/rfc793.txt">RFC793</a> ) allows the connected device to adapt to work on the network at speeds of tens of megabits per second and delays of up to 100 seconds.  With the rapid development of new data transmission technologies, already 10 years after <a href="http://www.securitylab.ru/informer/240661.php">implementation,</a> it became clear that the performance of the protocol would not be enough for wider channels. <br><a name="habracut"></a><br><h4>  <font color="#153E7E"><strong>1) TCP restrictions</strong></font> </h4><br>  Data transfer rate depends on network and system characteristics. <br><img src="https://habrastorage.org/storage/0ffe0ef9/b9b856e0/e1ac57c7/0b2702f7.png"><br>  <i>img1 The process of transferring data over the network</i> <br><br>  <b><i>a) Buffers</i></b> <br>  The original TCP configuration limits the transfer rate to the buffer (the Window Size option is ‚Äúwindow size‚Äù) and is a field with a size of 2 ^ 16 bytes (up to 64 KB).  Maximum throughput in this case: <br><div style="text-align:center;"><img src="https://habrastorage.org/storage/ae73bfd7/6a221792/a34858de/12b30235.png"></div><br>  Example: You have a 100 megabyte connection to the Internet and there is a 100 ms delay to the server. <br>  Standard TCP stack, maximum data transfer rate does not exceed 10 Mbps <br>  (524288 bits / 0.1 sec = 5.24 Mbps in spite of the fact that you have a 100 megabit link). <br><br>  <i><b>b) Bandwidth-delay product (BDP)</b></i> <br>  TCP performance in principle depends not so much on the speed of the channel as on the so-called ‚Äúbandwidth * delay product‚Äù or BDP (the result is bandwidth * delay), which is the number of bytes needed for the sender and receiver for maximally filling the TCP connection. <br>  Performance problems arise in cases of so-called ‚Äúlong and wide pipes‚Äù (LFN ‚Äúlong fat network‚Äù), since the BDP in this case exceeds the TCP window size, thereby limiting the transmission rate. <br><img src="https://habrastorage.org/storage/954c0433/91f4c80c/c70b187b/69f825ac.png"><br>  <i>img2 Effect of delay on maximum TCP throughput</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      An example would be the mobile Internet or a fast optical link. <br>  Example of BDP calculations: <br>  a) Mobile broadband internet: 10 Mb / s, 100 ms RTT <br> <code>B√óD = 10^7 b/s √ó 10^-1 s = 10^6 b, or 1 Mb / 125 kB</code> <br>  b) high-speed ground network: 1 Gb / s, 10 ms RTT <br> <code>B√óD = 10^9 b/s √ó 10^-2 s = 10^7 b, or 10 Mb / 1.25 MB</code> <br> <br>  You can calculate BDP <a href="http://www.speedguide.net/bdp.php">here</a> . <br>  The ‚ÄúTCP window size‚Äù must exceed the BDP in order to reach the maximum channel load. <br><br>  <i><b>c) Protocol Overhead</b></i> <br>  By some estimates, about 95% of the computers in the world are connected via Ethernet technology. <br>  Ethernet MTU (Ethernet frame payload) = max.  1500 bytes. <br>  If we take into account all the Ethernet, IP, TCP headers, the picture will look like this: <br><img src="https://habrastorage.org/storage/af89294a/649d44ec/8ea950e3/c94cac4b.png"><br>  <i>img3 Single Ethernet frame transmission</i> <br><br>  The numbers indicate the size (in bytes) of the header for a particular protocol. <br>  IFG (Interframe gap) - mandatory interframe space. <br>  Headers: preamble, frame delimiter, Ethernet header / FCS - 26 bytes, IFG - 12 bytes, IP header - 20 bytes, TCP header - 20 bytes. <br><br>  If you exclude VLAN tagging, TCP timestamp and other optional features, the maximum payload (TCP) on Ethernet networks will be: <br>  <b>Max TCP Payload</b> = (MTU ‚Äì TCP ‚Äì IP) / (MTU + Ethernet + IFG) = (1500‚Äì40) / (1500 + 26 + 12) = <b>94.9%</b> <br><br>  <i><b>d) Packet Delay and Loss</b></i> <br>  Since we are talking about reliable transmission of information, the loss of packets on the network forces TCP to resend segments and directly affects the reduction in speed. <br>  The dependence of TCP speed in relation to packet loss is determined by the Mathis formula: <br><div style="text-align:center;"><img src="https://habrastorage.org/storage/346d0b18/d3f4494c/0f9c043b/b36a31f1.png"></div><br>  where: MSS (Maximum segment size) - the maximum size of a TCP segment (MSS = MTU - packet headers = 1460 bytes), <br>  MTU is the maximum size of the transmitted OSI lower layer block (Ethernet MTU = 1500 bytes), <br>  RTT - time of bilateral delay (from one end to another and back, from the English. Round Trip Time) <br>  Ploss - Loss probability. <br>  It can be noted that the formula is not valid with Ploss = 0. This is normal, as there are always packet losses in the real world. <br><br><img src="https://habrastorage.org/storage/1afbb9ed/9ae4a75e/ec1da01c/baee9938.png"><br>  <i>img4 Impact of delay and packet loss on maximum TCP throughput</i> <br><br>  Most providers will not guarantee a loss of less than 0.01% (1 package out of 10'000). <br>  You can check protocol statistics using the ‚Äúnetstat ‚Äìs‚Äù command. <br><br><h4>  <font color="#153E7E"><strong>2) TCP optimization</strong></font> </h4><br>  <i><b>a) protocol enhancements</b></i> <br>  In this regard, protocol extensions have been developed, described in the <b>TCP Extensions for High Performance</b> ( <a href="http://www.ietf.org/rfc/rfc1323.txt">RFC1323</a> ) <a href="http://www.ietf.org/rfc/rfc1323.txt">standard</a> , which are designed to solve constraints. <br>  Among them: <br>  - TCP <b>Window Scale</b> Option: the ability to increase the size of the window to 2 ^ 30 (1 GB) <br>  - TCP selective acknowledgment ( <b>SACK</b> ) options: the receiving party specifies which packets in the stream are confirmed (positive or negative) ( <a href="http://www.ietf.org/rfc/rfc2018.txt">RFC2018</a> ), <br>  - <b>TCP timestamps</b> : Improved RTT (Round Trip Time Measurement - RTTM) measurements, preventing overlapping of sequence numbers ACK (Prevention Against Wrapped Sequence numbers - PAWS), <br>  - <b>Path MTU discovery</b> : determining the maximum MTU all the way, <br>  - Explicit Congestion Notification ( <b>ECN</b> ): Indicates path overload without dropping packets ( <a href="http://www.ietf.org/rfc/rfc3168.txt">RFC3168</a> ). <br><br>  You can check the current TCP / IP settings of your computer <a href="http://www.speedguide.net/analyzer.php">here</a> . <br><br>  <i><b>b) Adaptation of operational systems</b></i> <br>  Despite the fact that RFC1323 was published back in 1992, the OSs did not implement the changes immediately. <br><br>  <b>OS Windows</b> <br>  RFC1323 support appeared since Windows 2000 (XP, Server 2003) and to activate the option you need to rotate in the registry. <br>  Windows Server 2008, Vista, 7 includes a new implementation of the TCP / IP protocol stack, known as the new generation TCP / IP protocol stack (‚ÄúNext Generation TCP / IP Stack‚Äù).  It is designed to provide Windows networking technology for several years to come.  Among the innovations: <br>  - auto tuning of the receiving window (Receive Window Auto-Tuning), <br>  - compound TCP: solves the problem of poor performance in high-bandwidth networks with the help of a new algorithm, instead of algorithms used on other platforms, <br>  - enhancements for high loss environments and whatnot. <br>  Many options are enabled by default.  Configuration via command line. <br><br>  Detailed configuration procedures <b>for various operating systems</b> (Windows XP, FreeBSD, Linux, Solaris, Mac OS X) can be found on the <a href="http://www.psc.edu/networking/projects/tcptune/">site of the Pittsburgh supercomputer center</a> . <br><br>  Note: Although routers basically pass all traffic (between different networks), they have only an indirect relation to TCP optimization (in some cases), since they work at a lower level of the OSI network model and perform the function of determining the best routes and only delivering packets to destination. <br><br><h4>  <font color="#153E7E"><strong>3) Measuring TCP / IP stack performance</strong></font> </h4><br>  In the network there are many methods for measuring the speed of connection to the Internet. <br>  Here we will look at the case of using the <a href="http://www.lcp.nrl.navy.mil/nuttcp/">nuttcp</a> utility ("New TTCP"), since it has several nice advantages: <br>  - simple and effective method of measuring bandwidth via TCP or UDP, <br>  - cross-platform single-file program (CLI), <br>  - the ability to verify the effectiveness of the local TCP / IP stack (loopback), <br>  - stable server operation (correct termination of TCP sessions), without hangs and crashes <br>  (as in the case of iperf) <br>  - client's work from NAT. <br><br>  A bit of history: In 1980, Mike Muuss (ping-a) created ttcp ("Test TCP") - one of the first TCP bandwidth testing tools.  Many changes have since been created in various implementations and with new features.  <b>Nuttcp</b> is one of them.  Last beta is April 2010. <br><br>  Testing works according to the client-server scheme. <br>  Payload is measured - payload (without headers). <br>  Connection via port 5000. Data transfer - 5001 (and higher if you specify a multi-threaded test). <br><br>  Server - just specify <b>#nuttcp -S</b> <br>  Client - you can specify <a href="">many options</a> . <br><br>  Example: <br>  FreeBSD server, Windows XP SP3 client, FastEthernet (100Mbps). <br>  <b>server-ip # nuttcp ‚ÄìS</b> <br><br>  client options: <br>  -w128 - TCP receive window size = 128 KB <br>  -r - receiving (for client) <br>  -F - fixes possible connection problems if you are in NAT <br>  -i5 - show result every 5 seconds <br>  -T15 - test duration (15 seconds). <br><br>  TX% and RX% are the processor load on the transmitter and receiver. <br><br>  Performance check for hardware and TCP / IP OS stack: <br>  <b>C: \&gt; nuttcp.exe -w1m 127.0.0.1</b> <br>  205.0625 MB / 10.00 sec = 172.0189 Mbps 19% TX 12% RX <br><br>  Examples of results: <br>  - Intel Core 2 Duo (2 core) @ 1.6 GHz / 1 GB RAM / Windows XP = 1300/1400 Mbps <br>  - AMD Athlon X2 Dual-Core 4600 @ 2.4 GHz / 2 GB RAM / Windows 7 = 2000/2100 Mbps <br>  - Intel XEON X5650 (24 cores) @ 2.67GHz / 8 GB RAM / FreeBSD = 16600/18000 Mbps <br><br>  <u>Check Download (from server to client)</u> : <br>  <b>C: \&gt; nuttcp.exe -w128 -r -F ‚Äìi5 -T15 server-ip</b> <br>  56.0166 MB / 5.00 sec = 93.9803 Mbps <br>  56.0575 MB / 5.00 sec = 94.0489 Mbps <br>  56.0338 MB / 5.00 sec = 94.0090 Mbps <br><br>  168.2676 MB / 15.00 sec = 94.1020 Mbps 3% TX 10% RX <br><br>  <b>some-unix-client # nuttcp -r -F -i5 -T15 server-ip</b> <br>  429.0000 MB / 5.02 sec = 717.3541 Mbps <br>  526.0000 MB / 5.00 sec = 882.0518 Mbps <br><br>  1371.1741 MB / 15.00 sec = 766.6703 Mbps 26% TX 39% RX 3153 host-retrans 0.29 msRTT <br><br>  <u>Check Upload (from client to server)</u> : <br>  <b>C: \&gt; nuttcp.exe -w128 ‚Äìi5 -T15 server-ip</b> <br>  55.6250 MB / 5.00 sec = 93.3169 Mbps <br>  55.8125 MB / 5.00 sec = 93.6562 Mbps <br>  55.6875 MB / 5.00 sec = 93.4277 Mbps <br><br>  167.2500 MB / 15.12 sec = 92.7664 Mbps 17% TX 6% RX <br><br>  <b>some-unix-client # nuttcp -i5 -T15 server-ip</b> <br>  422.9375 MB / 5.00 sec = 709.5294 Mbps <br>  420.6875 MB / 5.00 sec = 705.9357 Mbps <br>  456.3750 MB / 5.00 sec = 765.6674 Mbps <br><br>  1305.3853 MB / 15.06 sec = 727.0077 Mbps 20% TX 48% RX 24478 host-retrans 0.29 msRTT <br><br><h4>  <font color="#153E7E"><strong>4) Instead of conclusion</strong></font> </h4><br>  In the process of testing, you need to remember that the maximum speed of an <b>individual TCP connection</b> is determined by various factors: <br>  - maximum throughput of the slowest part of the road, <br>  - time between sending a request and receiving a response (RTT), <br>  - most delays at long distances are caused by the speed of light in the fiber (~ 200 km / ms), <br>  - additional delays may occur at the time of network or device overload (server, router, PC), <br>  - automatic speed reduction upon detection of packet loss (standard TCP overload prevention mechanism), <br>  - the absence of other negative effects (the minimum number of bit errors at the physical level (Bit Error Rate &lt;10 ^ -8), <br>  - the health of the network card and the correct operation of the driver), <br>  - one physical link can carry many simultaneous TCP connections, <br>  - one host can have several simultaneous connections, even with the same remote host (you can quickly check with <a href="http://technet.microsoft.com/en-us/sysinternals/bb897437">TCPView</a> or <a href="http://tcpmonitor.altervista.org/tcpeye-network-monitoring/">TCPEye</a> ). <br><br>  Popular speedtest usually work in a browser, flash + geo-location to the nearest available server, which creates: <br>  - additional load on the local machine (CPU, memory) and network (WWW headers, etc.), <br>  - server selection may not be optimal, <br>  - the possibility of erroneous results. <br><br>  And lastly, I would like to note the frequently encountered problems with low network performance: <br>  - narrow TCP window (Window Size), <br>  - Ethernet Duplex mismatch, <br>  - bad network cable. <br><br>  Related Links: <br>  <a href="http://technet.microsoft.com/en-us/magazine/2007.01.cableguy.aspx">technet.microsoft.com/en-us/magazine/2007.01.cableguy.aspx</a> <br>  <a href="http://fasterdata.es.net/fasterdata/host-tuning/">fasterdata.es.net/fasterdata/host-tuning</a> <br><br> <a title="free hit counters" href="http://statcounter.com/free-hit-counter/"><img src="https://habrastorage.org/getpro/habr/post_images/330/ed7/08a/330ed708a1aa493498f25de98a59cf09.gif" alt="free hit counters"></a> </div><p>Source: <a href="https://habr.com/ru/post/115527/">https://habr.com/ru/post/115527/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115517/index.html">The speed and cost of working with Google App Engine data in tables</a></li>
<li><a href="../115518/index.html">Google street view updated</a></li>
<li><a href="../115521/index.html">Picapy: Picasa Web Desktop Browser for Ubuntu</a></li>
<li><a href="../115522/index.html">Anyone, even the smallest online store, can accept cards</a></li>
<li><a href="../115525/index.html">Prostopleer became paid</a></li>
<li><a href="../115528/index.html">HTML5 Canvas browser performance test</a></li>
<li><a href="../115529/index.html">Free access to the course on ReSharper from PluralSight</a></li>
<li><a href="../115531/index.html">Server from image: DHCP + TFTP + Initrd + OpenVZ</a></li>
<li><a href="../115533/index.html">Donetsk coffee-and-code with a taste of Ruby on Rails</a></li>
<li><a href="../115536/index.html">The simplest RSS reader</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>