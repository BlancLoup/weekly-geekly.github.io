<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search optimization when choosing a campaign</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Blah blah blah 


 When the head starts to swell from the main work, I like to switch the context and come up with a task related to the improvement o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search optimization when choosing a campaign</h1><div class="post__text post__text-html js-mediator-article"><h3 id="bla-bla-bla">  Blah blah blah </h3><br><p>  When the head starts to swell from the main work, I like to switch the context and come up with a task related to the improvement of some algorithm, optimization.  Since more than 10 years I have been developing advertising management systems, all my tasks are also related to this area. </p><br><p>  Recently, my thoughts are busy with the question of how to increase the speed of search for advertising campaigns according to specified parameters.  An advertising campaign is, in fact, a set of restrictions that must be checked in order to choose the right one for a request.  Trying to speed up the exhaustive search, I reached intrinsic, but the achievements could not be called outstanding.  At the same time, there was always a feeling that I was not going the right way, that somewhere I had to turn something upside down and the speed would increase by an order of magnitude. </p><br><p>  Yesterday I was lit up after a conversation with Pasha Beyzman, who spoke the other day with a report on HighLoad ++.  Bit operations !!!  Yes, I perfectly understand the power of bit operations, but I didn‚Äôt prepare them correctly;) The test results exceeded my most optimistic expectations. <a name="habracut"></a></p><br><h3 id="ideya">  Idea </h3><br><p>  One type of constraint when choosing a campaign is to check whether a value is in the set.  For example, a campaign can be restricted by country, region, city, category, etc.  The first thing that comes to mind is a tree with all the values ‚Äã‚Äãat the campaign level.  The second is an array of values; if the values ‚Äã‚Äãin the set are few (about 10), brute force will be faster than using trees.  To select a campaign, you must go through everything and in each of them check the occurrence of a given value in the set. </p><br><p>  The algorithm with correctly prepared bit operations is as follows.  For a given restriction value, we build a large bit mask whose size is equal to the number of campaigns and set the bits for the campaigns that are assigned to this value (or there are no restrictions of a given type).  Bitmasks are placed in a tree, where the key is the value of the constraint.  For example, for countries, this will be a tree, where the key is the country identifier, and the value is a mask with bits set for campaigns that can be shown to this country. </p><br><p>  It is very easy to work with such a structure.  Knowing which country to select campaigns for, we select the bit mask by identifier and perform the AND operation with masks of other restrictions.  Very fast and beautiful. </p><br><h3 id="testy">  Tests </h3><br><p>  Where without performance tests ... I tested the processing of one limit for 1 million campaigns.  For each of the campaigns, a restriction with a set of 10 values ‚Äã‚Äãfrom 0 to 256 was randomly generated (checks for memory allocation errors, etc., from the code were removed): </p><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nels = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> campaigns = <span class="hljs-number"><span class="hljs-number">1000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *values = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) * campaigns * nels); srand(<span class="hljs-number"><span class="hljs-number">13</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; campaigns; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; nels; j++) { values[i * nels + j] = rand() % <span class="hljs-number"><span class="hljs-number">256</span></span>; } }</code> </pre> <br><h4 id="perebor-so-znacheniyami-v-massive">  Brute force with values ‚Äã‚Äãin an array </h4><br><p>  We just try to sort through all the campaigns with all the restrictions.  Here and below, we compile with the -O3 option. </p><br><p>  We are testing. </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">clock_t</span></span> cs, ce; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> found_campaigns = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> reference = <span class="hljs-number"><span class="hljs-number">13</span></span>; cs = clock(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; campaigns; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; nels; j++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (values[i * nels + j] == reference) { found_campaigns++; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } ce = clock(); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"test #1 bruteforce, found: %d, clocks: %ld, sec: %f\n"</span></span>, found_campaigns, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) (ce - cs), (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (ce - cs) / CLOCKS_PER_SEC);</code> </pre> <br><p>  Result: clocks: 7034, sec: 0.007034. </p><br><h4 id="perebor-so-znacheniyami-v-dereve">  Brute force tree </h4><br><p>  We try to use a tree instead of an array of constraint values ‚Äã‚Äã( <a href="http://judy.sourceforge.net/">Judy Arrays</a> ). </p><br><div class="spoiler">  <b class="spoiler_title">Preparing data</b> <div class="spoiler_text"><pre> <code class="hljs matlab">Pvoid_t *sets = (Pvoid_t) malloc(sizeof(Pvoid_t) * campaigns); memset(sets, <span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof(Pvoid_t) * campaigns); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; campaigns; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> &lt; nels; <span class="hljs-built_in"><span class="hljs-built_in">j</span></span>++) { PWord_t pw; JLI(pw, sets[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>], values[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> * nels + <span class="hljs-built_in"><span class="hljs-built_in">j</span></span>]); } }</code> </pre> </div></div><br><p>  We are testing. </p><br><pre> <code class="cpp hljs"> found_campaigns = <span class="hljs-number"><span class="hljs-number">0</span></span>; cs = clock(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; campaigns; i++) { PWord_t pw; JLG(pw, sets[i], reference); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pw) { found_campaigns++; } } ce = clock(); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"test #2 set, found: %d, clocks: %ld, sec: %f\n"</span></span>, found_campaigns, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) (ce - cs), (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (ce - cs) / CLOCKS_PER_SEC);</code> </pre> <br><p>  Result: clocks: 7930, sec: 0.007930. </p><br><p>  The enumeration of 10 array values ‚Äã‚Äãturned out to be faster than using a tree.  There is nothing surprising here; brute force through the array utilizes the processor cache remarkably well.  The approximate equality between the arrays and the tree was on 12 elements. </p><br><h4 id="ispolzuem-bitovye-maski">  Use bit masks </h4><br><div class="spoiler">  <b class="spoiler_title">We prepare bit masks</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SET_BIT(_n, _i) _n[_i / 64] |= 1ULL &lt;&lt; (_i % 64) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CHECK_BIT(_n, _i) _n[_i / 64] &amp; (1ULL &lt;&lt; (_i % 64)) PWord_t pw; Pvoid_t pv = (Pvoid_t) 0; int mask_size = sizeof(uint64_t) * (campaigns / 64 + 1); for (int i = 0; i &lt; campaigns; i++) { for (int j = 0; j &lt; nels; j++) { int id = values[i * nels + j]; JLI(pw, pv, id); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (*pw) { uint64_t *mask = (uint64_t *) *pw; SET_BIT(mask, i); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { uint64_t *mask = (uint64_t *) malloc(mask_size); memset(mask, 0, mask_size); SET_BIT(mask, i); *pw = (Word_t) mask; } } }</span></span></code> </pre> </div></div><br><p>  We are testing. </p><br><pre> <code class="cpp hljs"> found_campaigns = <span class="hljs-number"><span class="hljs-number">0</span></span>; cs = clock(); JLG(pw, pv, reference); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pw) { <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> *mask = (<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> *) *pw; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; campaigns; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CHECK_BIT(mask, i)) { found_campaigns++; } } } ce = clock(); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"test #3 bitmaps, found: %d, clocks: %ld, sec: %f\n"</span></span>, found_campaigns, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) (ce - cs), (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (ce - cs) / CLOCKS_PER_SEC);</code> </pre> <br><p>  Result: clocks: 1393, sec: 0.001393. </p><br><p>  5 times faster than brute force.  Not bad, but better. </p><br><h4 id="uskoryaem-ispolzovanie-bitovyh-masok">  Accelerate the use of bitmasks </h4><br><p>  To speed up, use the built-in function gcc __builtin_ffsll, which returns the index of the first bit set. </p><br><p>  We are testing. </p><br><pre> <code class="cpp hljs"> found_campaigns = <span class="hljs-number"><span class="hljs-number">0</span></span>; cs = clock(); JLG(pw, pv, reference); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pw) { <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> *mask = (<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> *) *pw; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (campaigns / <span class="hljs-number"><span class="hljs-number">64</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>); i++) { <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> m = mask[i]; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (m) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = __builtin_ffsll(m); m &amp;= ~(<span class="hljs-number"><span class="hljs-number">1U</span></span>LL &lt;&lt; (n - <span class="hljs-number"><span class="hljs-number">1</span></span>)); found_campaigns++; } } } ce = clock(); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"test #4 bitmaps 2, found: %d, clocks: %ld, sec: %f\n"</span></span>, found_campaigns, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) (ce - cs), (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (ce - cs) / CLOCKS_PER_SEC);</code> </pre> <br><p>  Result: clocks: 28, sec: 0.000028. </p><br><p>  In this place, my eyes went up to my forehead.  Acceleration is 250 times compared with brute force. </p><br><p>  How the processor works, what SSE, AVX and similar instructions are, how the cache works - this knowledge allows you to speed up the program, often significantly.  But a beautiful algorithm can speed up the work by orders of magnitude. </p><br><p>  The text of the program can be found here: <a href="https://github.com/saterenko/labs/tree/master/bit_limits">https://github.com/saterenko/labs/tree/master/bit_limits</a> </p><br><h3 id="ps">  PS </h3><br><p>  Thanks to <a href="https://habrahabr.ru/users/pkxwmpgn/" class="user_link">PkXwmpgN</a> for the error found in the initialization, because of it, not the entire array of test data was filled, but only a tenth of it.  After correcting the error, the execution time of the last test increased by an order of magnitude, i.e.  acceleration compared to brute force - 25 times, eyes on the forehead no longer climb, but also impressive;) </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/314818/">https://habr.com/ru/post/314818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314804/index.html">50 shades of Go: traps, pitfalls and common mistakes beginners</a></li>
<li><a href="../314806/index.html">The history of the startup and our pivot</a></li>
<li><a href="../314810/index.html">Analyzing the performance of the server Oracle SPARC T7-2</a></li>
<li><a href="../314814/index.html">Working with different units of measurement of the same type and converting them</a></li>
<li><a href="../314816/index.html">Microsoft fixed a serious vulnerability in Windows</a></li>
<li><a href="../314820/index.html">Tricks for taking complex integrals</a></li>
<li><a href="../314822/index.html">Manage identity verification with Windows Hello for Business</a></li>
<li><a href="../314824/index.html">5 lessons of a seven-month stay in a start-up hell</a></li>
<li><a href="../314826/index.html">JetBrains Night in Moscow. Video. Kotlin as the first step to JVM</a></li>
<li><a href="../314830/index.html">How ABBYY technologies help improve data leak detection systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>