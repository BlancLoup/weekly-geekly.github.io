<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Law ‚Ññ139-–§–ó: view from a small provider</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of weeks ago, my good friend (part-time system administrator in a city, but not very large provider) colleagues from Roskomnadzor put on the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Law ‚Ññ139-–§–ó: view from a small provider</h1><div class="post__text post__text-html js-mediator-article">  A couple of weeks ago, my good friend (part-time system administrator in a city, but not very large provider) colleagues from Roskomnadzor put on the form that by IP he, of course, blocks banned sites, but by URL or domain names absolutely not; When the IP address is changed by a prohibited resource, it starts to open again.  A comrade complained to me about his fate, at the same time hinting that once he personally had already been fined for failing to comply with the requirements of the infamous No. 139-FZ. <br><br><a name="habracut"></a><br>  The connection scheme for this provider is as follows: <br><ul><li>  All users (except those who bought a static IP) are behind NAT; </li><li>  NAT is implemented as normal forwarding on at least the usual debian; </li><li>  Every NAT has at least the usual iptables; </li><li>  There are two of its DNS servers running on the same debian and PowerDNS. </li></ul><br><br>  After some thought, as well as googling information about layer 7 filtering on the knee, Google told us that such things are the prerogative of expensive equipment, and l7-filter for iptables stopped developing a long time ago.  After that, we started to think in the direction of proxy servers.  None of us worked with squid on an industrial scale, however there were quite a few experiments with nginx - a very powerful product of Igor Sysoyev. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The general scheme of work was developed as follows: <br><ul><li>  iptables on NAT intercepts all DNS requests and redirects them to our DNS server; </li><li>  DNS-server keeps zones including forbidden resources, not trying to update them through recursor; </li><li>  These zones only address these resources indicate the server address with nginx. </li></ul><br><br>  It is clear that the configuration of nginx and the list of zones of forbidden resources must be updated dynamically: the frequency of Roskomnadzor‚Äôs requirements indicates the frequency 3 times a day.  The drawback is also obvious: access via HTTPS will either have to be restricted or allowed, but using a self-signed certificate, otherwise the traffic through our nginx will be encrypted and it will not be able to perform its main function (filtering).  In the second variant, swearing of clients' browsers on the wrong certificate is inevitable.  Moreover, if the block gets an address from the list of google domains, and google chrome is installed on the client, then the client will not allow the client to these sites in principle.  But we couldn‚Äôt invent other knee variants for a limited time.  So, what we have: <br><ol><li>  The script that loads the list of prohibited sites (plain XML, is given by the SOAP service after a corresponding request. Authorization is required using a certificate that is unique for each provider). </li><li>  Script that loads the list of zones in the DNS server. </li><li>  The script that creates the necessary configuration for nginx. </li></ol><br><br>  I will not give the first script: providers themselves know how to get information, and it is not recommended to disclose it to ordinary users. <br><br>  The second script (SQL for working with the PowerDNS database): <br><br><pre><code class="bash hljs">USE pdns; create temporary table <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not exists dump( domain text ); TRUNCATE TABLE dump; load data <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> infile <span class="hljs-string"><span class="hljs-string">'/opt/zapret/dump.xml'</span></span> into table dump LINES STARTING BY <span class="hljs-string"><span class="hljs-string">'&lt;domain&gt;'</span></span> TERMINATED BY <span class="hljs-string"><span class="hljs-string">'&lt;/domain&gt;'</span></span> (@tmp) SET domain = ExtractValue(@tmp, <span class="hljs-string"><span class="hljs-string">'/'</span></span>); create temporary table <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not exists locked( domain varchar(767) primary key ); TRUNCATE TABLE locked; INSERT INTO locked SELECT DISTINCT domain FROM dump; create temporary table <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not exists locked1( domain varchar(767) primary key ); TRUNCATE TABLE locked1; INSERT INTO locked1 SELECT * FROM locked; DELETE FROM l USING locked l INNER JOIN locked1 l1 ON l.domain=SUBSTR(l1.domain from 5); UPDATE locked SET domain=SUBSTR(LCASE(domain) FROM 5) WHERE LEFT(LCASE(domain), 4) = <span class="hljs-string"><span class="hljs-string">'www.'</span></span>; DELETE FROM locked WHERE domain LIKE <span class="hljs-string"><span class="hljs-string">'%youtube.com'</span></span> OR domain LIKE <span class="hljs-string"><span class="hljs-string">'%google.com'</span></span> OR domain LIKE <span class="hljs-string"><span class="hljs-string">'%google.ru'</span></span>; create temporary table <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not exists old_locked( id int, domain varchar(767) primary key ); TRUNCATE TABLE old_locked; INSERT INTO old_locked SELECT DISTINCT d.id, d.name as domain FROM domains d INNER JOIN records r ON d.id=r.domain_id WHERE r.content=<span class="hljs-string"><span class="hljs-string">'1.2.3.4'</span></span> AND d.name NOT LIKE <span class="hljs-string"><span class="hljs-string">'%provider.ru'</span></span>; INSERT INTO domains (name, master, last_check, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, notified_serial, account) SELECT n.domain, NULL, NULL, <span class="hljs-string"><span class="hljs-string">'NATIVE'</span></span>, NULL, NULL FROM locked n LEFT JOIN old_locked o ON n.domain=o.domain WHERE o.domain IS NULL; INSERT INTO records (domain_id, name, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, content, ttl, prio, change_date, ordername, auth) SELECT d.id AS domain_id, d.name, <span class="hljs-string"><span class="hljs-string">'SOA'</span></span> as <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, <span class="hljs-string"><span class="hljs-string">'ns.provider.ru dns.provider.ru 2014022701 28800 7200 604800 86400'</span></span> as content, 86400 as ttl, 0 as prio, 1393508792 as change_date, <span class="hljs-string"><span class="hljs-string">''</span></span> as ordername, 1 as auth FROM domains d INNER JOIN locked l ON d.name=l.domain LEFT JOIN old_locked o ON d.name=o.domain WHERE o.domain IS NULL; INSERT INTO records (domain_id, name, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, content, ttl, prio, change_date, ordername, auth) SELECT d.id AS domain_id, CONCAT(<span class="hljs-string"><span class="hljs-string">'*.'</span></span>, d.name), <span class="hljs-string"><span class="hljs-string">'A'</span></span> as <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, <span class="hljs-string"><span class="hljs-string">'1.2.3.4'</span></span> as content, 86400 as ttl, 0 as prio, 1393508820 as change_date, <span class="hljs-string"><span class="hljs-string">''</span></span> as ordername, 1 as auth FROM domains d INNER JOIN locked l ON d.name=l.domain LEFT JOIN old_locked o ON d.name=o.domain WHERE o.domain IS NULL; DELETE FROM r, d USING records r INNER JOIN domains d ON r.domain_id=d.id INNER JOIN old_locked o ON d.name=o.domain LEFT JOIN locked l ON o.domain=l.domain WHERE l.domain IS NULL;</code> </pre> <br><br>  After the execution of this script, you must not forget to execute <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># pdnssec rectify-all-zones</span></span></code> </pre><br>  so that powerdns is aware of the change. <br><br>  The third script (forming the list of blocked): <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $xml = simplexml_load_file (<span class="hljs-string"><span class="hljs-string">'/opt/zapret/dump.xml'</span></span>); $dirty = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $excl = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $excl[] = <span class="hljs-string"><span class="hljs-string">'youtube.com'</span></span>; $excl[] = <span class="hljs-string"><span class="hljs-string">'google.ru'</span></span>; $excl[] = <span class="hljs-string"><span class="hljs-string">'google.com'</span></span>; $excl[] = <span class="hljs-string"><span class="hljs-string">'badsite.org'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($xml <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $node) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( strlen( (string)$node-&gt;domain )&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> ) { $parsed = parse_url((string)$node-&gt;url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( $parsed!=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($parsed[<span class="hljs-string"><span class="hljs-string">'path'</span></span>]) ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($parsed[<span class="hljs-string"><span class="hljs-string">'scheme'</span></span>]) ) $scheme = $parsed[<span class="hljs-string"><span class="hljs-string">'scheme'</span></span>] . <span class="hljs-string"><span class="hljs-string">"://"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $scheme = <span class="hljs-string"><span class="hljs-string">"http://"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($parsed[<span class="hljs-string"><span class="hljs-string">'port'</span></span>]) ) { $port = <span class="hljs-string"><span class="hljs-string">':'</span></span> . $parsed[<span class="hljs-string"><span class="hljs-string">'port'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( $scheme==<span class="hljs-string"><span class="hljs-string">"https://"</span></span> ) $port = $port . <span class="hljs-string"><span class="hljs-string">" ssl"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( $scheme==<span class="hljs-string"><span class="hljs-string">"https://"</span></span> ) $port = <span class="hljs-string"><span class="hljs-string">":443 ssl"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $port = <span class="hljs-string"><span class="hljs-string">":80"</span></span>; } $port = $port . <span class="hljs-string"><span class="hljs-string">";"</span></span>; $domain = (string)$node-&gt;domain; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( strcmp(strtolower(substr($domain, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)), <span class="hljs-string"><span class="hljs-string">'www.'</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> ) $domain = substr($domain, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($parsed[<span class="hljs-string"><span class="hljs-string">'query'</span></span>]) ) $que = $parsed[<span class="hljs-string"><span class="hljs-string">'query'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $que = <span class="hljs-string"><span class="hljs-string">''</span></span>; $que = str_replace(<span class="hljs-string"><span class="hljs-string">'\\E'</span></span>, <span class="hljs-string"><span class="hljs-string">'\\E\\\\E\\Q'</span></span>, $que); $que = <span class="hljs-string"><span class="hljs-string">'\\Q'</span></span> . $que . <span class="hljs-string"><span class="hljs-string">'\\E'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( strcmp($que, <span class="hljs-string"><span class="hljs-string">'\\Q\\E'</span></span>)==<span class="hljs-number"><span class="hljs-number">0</span></span> ) $que = <span class="hljs-string"><span class="hljs-string">''</span></span>; $path = $parsed[<span class="hljs-string"><span class="hljs-string">'path'</span></span>]; $path = str_replace(<span class="hljs-string"><span class="hljs-string">'\\E'</span></span>, <span class="hljs-string"><span class="hljs-string">'\\E\\\\E\\Q'</span></span>, $path); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( strcmp($path, <span class="hljs-string"><span class="hljs-string">'/'</span></span>)&lt;&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> ) { $path = <span class="hljs-string"><span class="hljs-string">'\\Q'</span></span> . $path . <span class="hljs-string"><span class="hljs-string">'\\E'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( strcmp($path, <span class="hljs-string"><span class="hljs-string">'\\Q\\E'</span></span>)==<span class="hljs-number"><span class="hljs-number">0</span></span> ) $path = <span class="hljs-string"><span class="hljs-string">''</span></span>; } $keys = preg_grep(<span class="hljs-string"><span class="hljs-string">'/'</span></span> . $domain . <span class="hljs-string"><span class="hljs-string">'/'</span></span>, $excl); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( count($keys)&lt;<span class="hljs-number"><span class="hljs-number">1</span></span> ) $dirty[] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'domain'</span></span>=&gt;$domain, <span class="hljs-string"><span class="hljs-string">'url'</span></span>=&gt;(string)$node-&gt;url, <span class="hljs-string"><span class="hljs-string">'loc'</span></span>=&gt;$path, <span class="hljs-string"><span class="hljs-string">'query'</span></span>=&gt;$que, <span class="hljs-string"><span class="hljs-string">'port'</span></span>=&gt;$port, <span class="hljs-string"><span class="hljs-string">'scheme'</span></span>=&gt;$scheme); } } } } <span class="hljs-comment"><span class="hljs-comment">// ..   ,     $dirty[] = array('domain'=&gt;'badsite.org', 'url'=&gt;'badsite.org', 'loc'=&gt;'/', 'query'=&gt;'', 'port'=&gt;':80;', 'scheme'=&gt;'http://'); $sort_func = function($obj_1, $obj_2) { return strnatcasecmp($obj_1['domain'] . $obj_1['url'], $obj_2['domain'] . $obj_2['url']); }; $domains = array_unique($dirty, SORT_REGULAR); usort($domains, $sort_func); $old_domain = ""; $old_loc = ""; $wasroot = false; $alldomain = false; $allloc = false; foreach($domains as $node) { $domain = $node['domain']; $url = $node['url']; $loc = $node['loc']; $query = $node['query']; $port = $node['port']; $scheme = $node['scheme']; // echo "\n1. Root " . (string)$wasroot . "; alldomain " . (string)$alldomain . "; alloc " . (string) $allloc . "; loc '" . $loc . "'; query '" . $query . "'\n"; if( strcmp($domain, $old_domain) ) { loc_close( $old_loc, ($alldomain || $wasroot || $allloc)); dom_close( $old_domain, $wasroot ); dom_open( $domain, $port, $scheme ); $old_loc = ''; $alldomain = false; $wasroot = false; } if( !$alldomain ){ if( strcmp($loc, $old_loc) ) { loc_close( $old_loc, ($alldomain || $allloc) ); loc_open( $loc ); $allloc = false; } if( strlen($loc)&lt;2 &amp;&amp; strlen($query)&gt;0 ) $wasroot = true; if( strlen($loc)&lt;2 &amp;&amp; strlen($query)&lt;1 ) { $alldomain = true; $wasroot = true; } if( strlen($query)&lt;1 ) $allloc = true; if( !$allloc ) args_check( $query ); } // echo "\n2. Root " . (string)$wasroot . "; alldomain " . (string)$alldomain . "; alloc " . (string) $allloc . "; loc '" . $loc . "'; query '" . $query . "'\n"; $old_loc = $loc; $old_domain = $domain; } loc_close( $loc, ($alldomain || $wasroot || $allloc) ); dom_close( $domain, $wasroot ); function loc_close( $_loc, $_alldomain ) { if (strlen($_loc)&gt;0 ) { if( $_alldomain ) { </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> return 301 http://eais.rkn.gov.ru/; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> } else { //if ( strcmp($_loc, '/')==0 ) { </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> include /etc/nginx/proxy_params; if ($args = '') { proxy_pass $scheme://$host$uri; } if ($args != '') { proxy_pass $scheme://$host$uri?$args; } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> } echo " } # location\n"; } } function dom_close( $_dom, $_wasroot ) { if( strlen($_dom)&gt;0 ) { if( !$_wasroot ) { </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> location / { include /etc/nginx/proxy_params; if ($args = '') { proxy_pass $scheme://$host$uri; } if ($args != '') { proxy_pass $scheme://$host$uri?$args; } } #root location </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> } echo "} #domain\n"; } } function loc_open( $_loc ) { </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> location ~* </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $_loc . "* {\n"; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> } function dom_open( $_domain, $_port, $_scheme ) { </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> server { listen 1.2.3.4</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $_port; if( strcmp( $_scheme, 'https:\/\/' )==0 ) echo ' ssl'; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> server_name </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $_domain . " " . "*." . $_domain . ";\n"; } function args_check( $_query ) { if ( strlen($_query)&gt;0 ) { echo "\t if (\$args ~* \""; if(strlen($_query)&gt;0) echo $_query; echo "*\") {\n"; echo "\t\treturn 301 http://eais.rkn.gov.ru/;\n"; echo "\t } #args\n"; } else echo "\treturn 301 http://eais.rkn.gov.ru/;\n"; } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  Following the execution of the third script, we get the configuration for nginx, which proxies the domain names that we received.  If the address is blocked, then an unconditional redirect (301) to the address of the <a href="http://eais.rkn.gov.ru/">eais.rkn.gov.ru</a> - the registry of prohibited sites. <br>  There are three types of locks: <br><br>  1. Whole domain.  For such sites we get the following entry: <br><pre> <code class="bash hljs">server { listen 1.2.3.4:80; server_name badsite.org *.badsite.org; location ~* /* { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> 301 http://eais.rkn.gov.ru/; } <span class="hljs-comment"><span class="hljs-comment"># location } #domain</span></span></code> </pre><br><br>  2. Specific URLs in the domain.  In this case, we get another entry: <br><pre> <code class="bash hljs">server { listen 1.2.3.4:80; server_name badsite.hk *.badsite.hk; location ~* \Q/h/\E* { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> 301 http://eais.rkn.gov.ru/; } <span class="hljs-comment"><span class="hljs-comment"># location location ~* \Q/h/res/214.html\E* { return 301 http://eais.rkn.gov.ru/; } # location location / { include /etc/nginx/proxy_params; if ($args = '') { proxy_pass $scheme://$host$uri; } if ($args != '') { proxy_pass $scheme://$host$uri?$args; } } #root location } #domain</span></span></code> </pre><br><br>  3. Certain arguments at a specific URL (for example, a specific post in PHPBB): <br><pre> <code class="bash hljs">server { listen 1.2.3.4:80; server_name badsite.com *.badsite.com; location ~* \Q/forum/viewforum.php\E* { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$args</span></span> ~* <span class="hljs-string"><span class="hljs-string">"\Qf=6\E*"</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> 301 http://eais.rkn.gov.ru/; } <span class="hljs-comment"><span class="hljs-comment">#args if ($args ~* "\Qf=6&amp;start=25\E*") { return 301 http://eais.rkn.gov.ru/; } #args include /etc/nginx/proxy_params; if ($args = '') { proxy_pass $scheme://$host$uri; } if ($args != '') { proxy_pass $scheme://$host$uri?$args; } } # location location / { include /etc/nginx/proxy_params; if ($args = '') { proxy_pass $scheme://$host$uri; } if ($args != '') { proxy_pass $scheme://$host$uri?$args; } } #root location } #domain&lt;</span></span></code> </pre><br><br>  And, of course, in default there is a forwarding of all requests to the corresponding addresses (just in case): <br><pre> <code class="bash hljs">server { listen 1.2.3.4:80 default_server; location / { include /etc/nginx/proxy_params; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$args</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>) { proxy_pass <span class="hljs-variable"><span class="hljs-variable">$scheme</span></span>://<span class="hljs-variable"><span class="hljs-variable">$host</span></span><span class="hljs-variable"><span class="hljs-variable">$uri</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$args</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span>) { proxy_pass <span class="hljs-variable"><span class="hljs-variable">$scheme</span></span>://<span class="hljs-variable"><span class="hljs-variable">$host</span></span><span class="hljs-variable"><span class="hljs-variable">$uri</span></span>?<span class="hljs-variable"><span class="hljs-variable">$args</span></span>; } } } server { listen 1.2.3.4:443 ssl default_server; location / { include /etc/nginx/proxy_params; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$args</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>) { proxy_pass <span class="hljs-variable"><span class="hljs-variable">$scheme</span></span>://<span class="hljs-variable"><span class="hljs-variable">$host</span></span><span class="hljs-variable"><span class="hljs-variable">$uri</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$args</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span>) { proxy_pass <span class="hljs-variable"><span class="hljs-variable">$scheme</span></span>://<span class="hljs-variable"><span class="hljs-variable">$host</span></span><span class="hljs-variable"><span class="hljs-variable">$uri</span></span>?<span class="hljs-variable"><span class="hljs-variable">$args</span></span>; } } }</code> </pre><br><br>  After generating the configuration, you need to remember to say <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># service nginx reload</span></span></code> </pre> <br>  That will inform nginx about the need to reload the configuration, gently extinguishing the old pools. <br><br>  The system with nginx was tested for strength a week ago, when one video from youtube.com was added to this list.  In addition to the increased memory consumption, no side effects were noted.  We managed to fight memory consumption by disabling keep-alive client connections.  But with the convenience for users, of course, it was not very good: viewing and uploading videos on youtube.com generally worked, but many videos were embedded into other pages using https, and browsers did not want to display them with the substituted certificate.  The deliberate decision of the provider‚Äôs google.com, google.com, and youtube.com domains were put on the list of exceptions, and one of the sites was included in the list of ‚Äúexceptions on the contrary‚Äù: it has a long-standing decision to block it entirely, but it is unloaded in this registry with only two forbidden URLs. <br>  In general, this solution proved to be quite efficient for a small provider who wants to continue working in the difficult conditions of our Russian legislation. </div><p>Source: <a href="https://habr.com/ru/post/216209/">https://habr.com/ru/post/216209/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216199/index.html">Logitech G700. One year later</a></li>
<li><a href="../216201/index.html">Collect and analyze logs with Lumberjack + Logstash + Elasticsearch + RabbitMQ</a></li>
<li><a href="../216203/index.html">Notes for sales managers in a web-studio or ‚ÄúSay a word about a poor marketer‚Äù</a></li>
<li><a href="../216205/index.html">Raspbian and QEMU</a></li>
<li><a href="../216207/index.html">Implementing Koh-Zhao steganographic method on Ruby</a></li>
<li><a href="../216213/index.html">How a designer find a job in IT</a></li>
<li><a href="../216215/index.html">Creating a failover IPSec VPN tunnel between Mikrotik RouterOS and Kerio Control</a></li>
<li><a href="../216219/index.html">We expand the functionality of the exchange of orders between 1C-Bitrix and 1C Enterprise UT 11</a></li>
<li><a href="../216221/index.html">4 ways to turn "No" into "Yes"</a></li>
<li><a href="../216223/index.html">Add Cyrillic to Source Sans Pro Font for Lumen Bootstrap Theme</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>