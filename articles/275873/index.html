<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AUTO_CLOSE</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If SQL Server existed at the time of the Inquisition, then for the inclusion of some options on the production servers would have to be punished with ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AUTO_CLOSE</h1><div class="post__text post__text-html js-mediator-article">  If <i>SQL Server</i> existed at the time of the Inquisition, then for the inclusion of some options on the production servers would have to be punished with a hot iron.  But if we discard the lyrics, then we‚Äôll look at why we don‚Äôt need to turn on <i>AUTO_CLOSE</i> and what the use of this option may cause <br><br>  Actually, like any interesting life stories, it all began with a routine task. <br><br>  The other day I had to look into the <i>Error Log</i> on a test server.  In the second minute of waiting, <i>SSMS</i> pretty poplohlo from the abundance of messages that kept the magazine, and I decided to see how much the logs weigh using <i>xp_enumerrorlogs</i> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="1c hljs">DECLARE @t TABLE (lod_id INT PRIMARY KEY, last_log SMALLDATETIME, size INT) INSERT INTO @t EXEC sys.xp_enumerrorlogs SELECT lod_id, last_log, size_mb = size / <span class="hljs-number"><span class="hljs-number">1048576</span></span>. FROM @t</code> </pre> <br><pre> <code class="1c hljs">lod_id last_log size_mb -------- --------------------- --------------- <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">567.05288505</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">1370.39249420</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">768.46394729</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">220.20050621</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">24.04152870</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">11</span></span>-<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">80.07946205</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">109.33527946</span></span></code> </pre><a name="habracut"></a><br>  As a rule, I try not to deal with the log size on test servers, because every time <i>SQL Server</i> starts, the log files change cyclically: the current <i>errorlog is</i> renamed to <i>errorlog.1</i> , an empty <i>errorlog</i> file is created and the oldest <i>errorlog.6</i> is deleted. <br><br>  In the case when it is necessary to clear the logs, <i>sp_cycle_errorlog</i> can come to the <i>rescue</i> .  But before clearing the journals, I still wanted to understand that they contained such interesting things. <br><br>  Made a read from the current log using the <i>xp_readerrorlog</i> stored procedure: <br><br><pre> <code class="1c hljs">EXEC sys.xp_readerrorlog</code> </pre><br>  And then my peripheral vision caught the eye of numerous messages: <br><br><pre> <code class="1c hljs">Starting up database '...'.</code> </pre><br>  On the one hand, there is nothing wrong with that.  Each time <i>SQL Server</i> starts, it opens the data files and checks the boot page: <br><br><pre> <code class="1c hljs">Starting up database '...'. CHECKDB for database '...' finished without errors on ... (local time).</code> </pre><br>  But after I filtered by the desired post, the sample results made me think: <br><br><pre> <code class="1c hljs">DECLARE @t TABLE (log_date SMALLDATETIME, spid VARCHAR(<span class="hljs-number"><span class="hljs-number">50</span></span>), msg NVARCHAR(<span class="hljs-number"><span class="hljs-number">4000</span></span>)) INSERT INTO @t EXEC sys.xp_readerrorlog <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, N'Starting up database' SELECT msg, COUNT_BIG(<span class="hljs-number"><span class="hljs-number">1</span></span>) FROM @t GROUP BY msg HAVING COUNT_BIG(<span class="hljs-number"><span class="hljs-number">1</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> ORDER BY <span class="hljs-number"><span class="hljs-number">2</span></span> DESC</code> </pre><br><pre> <code class="1c hljs">------------------------------------------------------ -------------------- Starting up database 'AUTOTEST_DESCRIBER'. <span class="hljs-number"><span class="hljs-number">127723</span></span> Starting up database 'MANUAL_DESCRIBER'. <span class="hljs-number"><span class="hljs-number">12913</span></span> Starting up database 'AdventureWorks<span class="hljs-number"><span class="hljs-number">2012</span></span>'. <span class="hljs-number"><span class="hljs-number">12901</span></span></code> </pre><br>  A large number of such messages may occur due to the inclusion of the <i>AUTO_CLOSE option</i> . <br><br>  According to the documentation, when the <i>AUTO_CLOSE option is</i> enabled, the database will automatically close and release all the resources it occupies when the last user connection using this database ceases to exist.  When you re-apply the database will automatically re-open ... and so on to infinity. <br><br>  Once upon a time I read that at the physical level, the <i>AUTO_CLOSE</i> operation for older versions of <i>SQL Server</i> was a completely synchronous process that could cause large delays with constant reopening of the database files.  Starting with <i>SQL Server 2005</i> , <i>AUTO_CLOSE</i> became asynchronous and some of the problems were gone.  And what's left?  Just enough to not use this option ... <br><br>  To optimize performance, <i>SQL Server</i> performs page changes in the buffer cache and does not write these pages to disk after each modification.  Instead, <i>SQL Server</i> periodically creates a checkpoint on which it writes the current pages that have been modified in memory, along with the transaction log information from memory to disk.  When you close the database, <i>CHECKPOINT</i> is automatically executed.  Accordingly, with constant DB closures, the disk load can greatly increase. <br><br>  Also, each time the database is closed, its procedural cache is cleared.  Accordingly, when the database reopens, you will have to generate execution plans for the new one.  But what is even sadder ... when closing, the buffer cache is also cleared, which increases the disk load when executing queries. <br><br>  <i>Microsoft is</i> <a href="https://technet.microsoft.com/en-us/library/bb402929.aspx">solidary</a> with me and also does not recommend including <i>AUTO_CLOSE</i> : <br><br>  <i>There is a possibility for your team to go ahead and you‚Äôll be able to complete the database after each connection.</i>  <i>AUTO_CLOSE also flushes the procedure cache after each connection.</i> <br><br>  However, there are a couple of nuances.  If you are using <i>SQL Server 2000</i> or any <i>Express</i> edition, then when creating a new database, the <i>AUTO_CLOSE option</i> will implicitly turn on: <br><br><pre> <code class="1c hljs">USE [master] GO IF DB_ID('test') IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> DROP DATABASE [test] GO CREATE DATABASE [test] GO SELECT is_auto_close_on FROM sys.databases WHERE database_id = DB_ID('test')</code> </pre><br><pre> <code class="1c hljs">is_auto_close_on ---------------- <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Bravo <i>Microsoft</i> !  Standing ovations ... <br><br>  Although, if you look at it from the other side, this behavior is quite understandable for <i>SQL Server Express</i> , because within this edition there is a limit on the size of the RAM used - no more than 1 GB. <br><br>  But for the future, if you suddenly need to deploy the database using a script, it is better to be safe and explicitly disable <i>AUTO_CLOSE</i> : <br><br><pre> <code class="1c hljs">ALTER DATABASE [test] SET AUTO_CLOSE OFF</code> </pre><br>  In the course of work, I noticed another interesting point - when accessing some functions or system views, all databases with the <i>AUTO_CLOSE</i> option enabled will open: <br><br><pre> <code class="1c hljs">USE [master] GO IF DB_ID('p1') IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> DROP DATABASE [p1] GO CREATE DATABASE [p1] GO ALTER DATABASE [p1] SET AUTO_CLOSE ON GO IF DB_ID('p2') IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> DROP DATABASE [p2] GO CREATE DATABASE [p2] GO ALTER DATABASE [p2] SET AUTO_CLOSE ON GO EXEC sys.xp_readerrorlog <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, N'Starting up database ''p' GO</code> </pre><br><pre> <code class="1c hljs">LogDate ProcessInfo Text ----------------------- ------------ ---------------------------------- <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">40.310</span></span> spid53 Starting up database 'p1'. <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">41.980</span></span> spid53 Starting up database 'p2'.</code> </pre><br>  We refer to <i>p1</i> : <br><br><pre> <code class="1c hljs">WAITFOR DELAY '00:03' GO SELECT DB_ID('p1') GO EXEC sys.xp_readerrorlog <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, N'Starting up database ''p'</code> </pre><br>  But <i>p2</i> also wakes up "for the company": <br><br><pre> <code class="1c hljs">LogDate ProcessInfo Text ----------------------- ------------ ---------------------------------- <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">40.310</span></span> spid53 Starting up database 'p1'. <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">41.980</span></span> spid53 Starting up database 'p2'. <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">17.440</span></span> spid52 Starting up database 'p1'. <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">17.550</span></span> spid52 Starting up database 'p2'.</code> </pre><br>  And finally, we got to the bottom of the truth.  On the server, various users actively accessed metadata ... this made the databases wake up with <i>AUTO_CLOSE</i> enabled, which in turn implicitly caused the log to grow. <br><br>  Preventive measures, by the way, came out very simple: <br><br><pre> <code class="1c hljs">DECLARE @SQL NVARCHAR(MAX) SELECT @SQL = ( SELECT ' ALTER DATABASE ' + QUOTENAME(name) + ' SET AUTO_CLOSE OFF WITH NO_WAIT;' FROM sys.databases WHERE is_auto_close_on = <span class="hljs-number"><span class="hljs-number">1</span></span> FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)') EXEC sys.sp_executesql @SQL</code> </pre><br>  <i>Everything was tested on Microsoft SQL Server 2012 (SP3) (KB3072779) - 11.0.6020.0 (X64).</i> <br><br>  If you want to share this article with an English-speaking audience: <br>  <a href="http://blog.devart.com/enabling-auto_close-is-a-bad-idea.html">Enabling AUTO_CLOSE is a bad idea?</a> </div><p>Source: <a href="https://habr.com/ru/post/275873/">https://habr.com/ru/post/275873/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275863/index.html">Clock on FPGA Lattice</a></li>
<li><a href="../275865/index.html">Classes, sets, groups, systems</a></li>
<li><a href="../275867/index.html">Which countries and programming languages ‚Äã‚Äãare more likely to win the game for CodeBattle programmers?</a></li>
<li><a href="../275869/index.html">Congratulations to students on their professional holiday</a></li>
<li><a href="../275871/index.html">Applications in EDS. Part 3: Context-role model of the document, the rights and the optimal interface for working with documents</a></li>
<li><a href="../275877/index.html">Games and porn in virtual reality: what you need to know on the eve of the launch of Oculus Rift, PlayStation VR, HTC Vive</a></li>
<li><a href="../275881/index.html">OpenJDK 9 is finally ported to iOS</a></li>
<li><a href="../275883/index.html">Alexey Ragozin and Artyom Panasyuk on distributed load testing on jug.msk.ru</a></li>
<li><a href="../275885/index.html">Video of the best reports of the JPoint 2015 Java Conference - Part 2</a></li>
<li><a href="../275887/index.html">Microsoft has posted on Github CNTK toolkit for deep learning</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>