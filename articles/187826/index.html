<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Data recovery redis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The authorship of the article belongs to our employee Stepan Karamyshev skob 
 Invite he has not yet, because I spread for him. 
 Further narration on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Data recovery redis</h1><div class="post__text post__text-html js-mediator-article">  The authorship of the article belongs to our employee Stepan Karamyshev <a href="http://habrahabr.ru/users/skob/" class="user_link">skob</a> <br>  Invite he has not yet, because I spread for him. <br>  Further narration on his behalf. <br><br>  This text does not pretend to genius, the methods described in it are not a panacea, much less a silver bullet.  Just as a result of a study conducted during the accident described below, not a single source was found either in Russian or in English (nor, it seems, in German) languages, which would give similar information.  Note: the information is provided "as is", its use without thoughtful study can be destructive! <br><br>  Grandpa for red'ku <br>  Folk tale 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/bae/314/241/bae31424113bc7c3e5930d3a6fdd86eb.png" alt="image"><br><br><a name="habracut"></a><br><br>  Cases are different.  Sometimes even the most reliable systems can fail.  So this time, dropping into the seat of my command center, I with horror and bitterness found more than a hundred messages in Skype chat.  Reading along the diagonal of the story showed that redis was swollen from our customers, went into itself and was killed with the help of OOM-killer.  Naturally, it wasn‚Äôt time to postpone the append-only file.  The magical redis-check-aof --fix to the file happily reported on the fix, simultaneously suggesting that you cut the 8-gigabyte file to 900 megabytes. <br><br><blockquote>  - Oh God!  Shouted customers. <br>  - Fiasco!  Shouted customers. <br>  - $ #% \! [_ *** #% \!  Shouted customers. <br></blockquote><br><br>  In aof-files, if someone does not know, there is a consistently executed redis command. <br><br>  Fortunately, before running --fix "into the battle", the file was copied.  In parallel, an administrative decision was made that we would not leave without repairing the file. <br><br>  The very first attempt to load a daemon with a file showed ‚ÄúHQET command not found‚Äù.  Then the mind games began.  The file was recaptured from sin, after which it was subjected to cruel vivisection.  First of all, the page http://redis.io/commands was opened, where all the possible redis control commands are available. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/590/2b6/b02/5902b6b028bf49767497e16e3c84c061.png" alt="image"><br><br><h5>  Level one.  Hurt me plenty. </h5><br><br>  yum install -y hexedit &lt;- set hexedit <br>  hexedit &lt;aof-file&gt; &lt;- open the hexedit file <br>  &lt;- go to ascii mode <br>  &lt;/&gt; &lt;- go to search <br>  HQET-&gt; &lt;- we are looking for the desired command, we rule <br>  &lt;ctrl-X&gt; &lt;- exit hexedit <br><br>  After correcting the first wave of commands (HQET, HSAT, ZASD), redis-check-aof was re-set on the file.  The execution results led to <br><br><img src="http://assets.centos-admin.ru/images/habrahabr/redis_img2.png" alt="image"><br><br><h5>  Level two.  Ultra-Violence. </h5><br><br>  Now the file required attention about: <br><br><pre><code class="bash hljs">0x308a7042: Expected prefix <span class="hljs-string"><span class="hljs-string">'\r\n'</span></span>, got: <span class="hljs-string"><span class="hljs-string">'0f0a'</span></span></code> </pre> <br><br>  hexedit &lt;aof-file&gt; &lt;- open the hexedit file <br>  &lt;- go to the address <br>  &lt;rule 0f0a on 0d0a&gt; &lt;- I remind you, 0d0a this is \ r \ n in hex. <br><br>  It seems to have become even easier, but the next run of the redis-check-aof has already begun to talk about <br><br><img src="http://assets.centos-admin.ru/images/habrahabr/redis_img3.png" alt="image"><br><br><h5>  Level three.  Nightmare! </h5><br><br><pre> <code class="bash hljs">0x       308a7046: Expected prefix <span class="hljs-string"><span class="hljs-string">'*'</span></span>, got: <span class="hljs-string"><span class="hljs-string">'$'</span></span></code> </pre><br><br>  Radish sources were downloaded, redis-check-aof was rebuilt with extended logging.  In my case, I preferred to print a sequence of characters _of_ after the problematic place for more accurate identification, having received something like: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">'34'</span></span> <span class="hljs-string"><span class="hljs-string">'D'</span></span> <span class="hljs-string"><span class="hljs-string">'A'</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span></code> </pre><br><br>  This is done by logging not only buf [0], but also a few characters after, or the entire buf. <br>  Additionally, note that in hexedit, the string from the example above will be represented as '34 0D 0A 00 ', i.e.  two characters with leading zero. <br><br>  Next, you need to very carefully read the ASCII before the problem place. <br>  If we analyze the example above, then in ASCII we will see: <br><br><pre> <code class="bash hljs">HSET..<span class="hljs-variable"><span class="hljs-variable">$16</span></span>..{u204237826932}g..<span class="hljs-variable"><span class="hljs-variable">$3</span></span>..150..<span class="hljs-variable"><span class="hljs-variable">$1</span></span>..1..*6..<span class="hljs-variable"><span class="hljs-variable">$4</span></span>..HSET..<span class="hljs-variable"><span class="hljs-variable">$16</span></span>..{u204237826932}g..<span class="hljs-variable"><span class="hljs-variable">$3</span></span> ..139..<span class="hljs-variable"><span class="hljs-variable">$1</span></span>..1..*4..<span class="hljs-variable"><span class="hljs-variable">$4</span></span>..</code> </pre><br><br>  Further, we carefully studied the source code of redis, especially the following piece: <br><br><pre> <code class="cpp hljs">    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buf[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'*'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> fmterr;       argc = atoi(buf+<span class="hljs-number"><span class="hljs-number">1</span></span>);       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argc &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> fmterr;       argv = zmalloc(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(robj*)*argc);       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; argc; j++) {           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fgets(buf,<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(buf),fp) == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> readerr;           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buf[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'$'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> fmterr;           len = strtol(buf+<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>);           argsds = sdsnewlen(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,len);           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (len &amp;&amp; fread(argsds,len,<span class="hljs-number"><span class="hljs-number">1</span></span>,fp) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> fmterr;           argv[j] = createObject(REDIS_STRING,argsds);           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fread(buf,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,fp) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> fmterr; <span class="hljs-comment"><span class="hljs-comment">/* discard CRLF */</span></span>    }</code> </pre><br><br>  and at some point we came to understand that the line is higher: <br><br><pre> <code class="bash hljs">HSET..<span class="hljs-variable"><span class="hljs-variable">$16</span></span>..{u204237826932}g..<span class="hljs-variable"><span class="hljs-variable">$3</span></span>..150..<span class="hljs-variable"><span class="hljs-variable">$1</span></span>..1..*6..<span class="hljs-variable"><span class="hljs-variable">$4</span></span>..HSET..<span class="hljs-variable"><span class="hljs-variable">$16</span></span>..{u204237826932}g..<span class="hljs-variable"><span class="hljs-variable">$3</span></span> ..139..<span class="hljs-variable"><span class="hljs-variable">$1</span></span>..1..*4..<span class="hljs-variable"><span class="hljs-variable">$4</span></span>..</code> </pre><br><br>  Will be normally eaten by check, if it is corrected to: <br><br><pre> <code class="bash hljs">HSET..<span class="hljs-variable"><span class="hljs-variable">$16</span></span>..{u204237826932}g..<span class="hljs-variable"><span class="hljs-variable">$3</span></span>..150..<span class="hljs-variable"><span class="hljs-variable">$1</span></span>..1..*4..<span class="hljs-variable"><span class="hljs-variable">$4</span></span>..HSET..<span class="hljs-variable"><span class="hljs-variable">$16</span></span>..{u204237826932}g..<span class="hljs-variable"><span class="hljs-variable">$3</span></span> ..139..<span class="hljs-variable"><span class="hljs-variable">$1</span></span>..1..*4..<span class="hljs-variable"><span class="hljs-variable">$4</span></span>..</code> </pre><br><br>  for the lazy, the difference is in replacing 6 by 4 before the second HSET, which gave us a change in the length of the argument line in the code above, which allowed us to go through the ‚Äúgoto fmterr‚Äù section and quietly go on. <br><br>  As a result, the file was refilled in manual mode, redis was launched, clients were reassured, the project was returned to work, the reputation was slightly dried, the file backup was reconfigured and rechecked.  Just in case twice. </div><p>Source: <a href="https://habr.com/ru/post/187826/">https://habr.com/ru/post/187826/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../187808/index.html">AngularJS vs. Knockoutjs</a></li>
<li><a href="../187812/index.html">In August, it will be possible to purchase and rent textbooks on Google Play</a></li>
<li><a href="../187814/index.html">About RNA molecules</a></li>
<li><a href="../187820/index.html">Parsing NetFlow v.9 C # Packages</a></li>
<li><a href="../187822/index.html">Simple and scalable event subscription with WebSockets, STOMP, SockJS and Spring Framework 4.0</a></li>
<li><a href="../187828/index.html">Proper understanding of gamification</a></li>
<li><a href="../187830/index.html">Tiny Thief - a cool mobile game made using Flash + Autodesk Scaleform Mobile SDK</a></li>
<li><a href="../187834/index.html">New for web designer for July 2013</a></li>
<li><a href="../187836/index.html">New Brief: Samsung Announced New Exynos 5 Octa Processor - Exynos 5420</a></li>
<li><a href="../187844/index.html">CowboyD: demonizing Cowboy, the embedded web server for Erlang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>