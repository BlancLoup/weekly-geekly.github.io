<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ImageResizer module for IIS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the wake of a recent article about resizing images on a server, I decided to share the experience of implementing the ImageResizer module for IIS. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ImageResizer module for IIS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/2aa/98e/94c/2aa98e94ca32e7bb10e8e8b508d4e47b.jpg" align="right"><br>  In the wake of a recent <a href="http://habrahabr.ru/post/160059/">article</a> about resizing images on a server, I decided to share the experience of implementing the <a href="http://imageresizing.net/">ImageResizer</a> module for IIS.  Of course, writing a simple review would be too boring, but we didn‚Äôt limit ourselves to a simple implementation of the module. <br>  So, we had a purchased ImageResizer + <a href="http://imageresizing.net/plugins/bundles/3">Cloud Bundle</a> plugin for working with clouds. <br><a name="habracut"></a><br>  Unfortunately, I am forbidden to name projects in which this solution is implemented, but I can outline the essence.  These are news portals focused on North America.  The site contains articles and video clips. <br><br>  Articles are stored in the database, the editor can attach the title picture to the article.  The image is stored in Amazon S3.  As you understand, the editor can upload an image, both small and huge, and one should not lose the original. <br><br>  Video files are uploaded, processed, and stored in the <a href="http://www.brightcove.com/en/">BrightCove</a> video cloud storage.  After the video is uploaded to the storage, it is fully processed, recoded into several streams of different formats and a thumbnail is automatically selected for the video. <br>  Naturally, since all this happens in the cloud, then the picture is stored in the cloud, and we get a direct link to insert.  But even here the picture can not always correspond to the required size. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In total, we have a set of images in Amazon S3, a set of images in BrightCove, and all images need to be able to quickly give already fitted to the desired size.  In addition, different image sizes can be used in different parts of the site.  We did not have a set of <a href="http://imageresizing.net/plugins/bundles/1">plug-ins for caching</a> , but we had CloudFront. <br><br><img src="https://habrastorage.org/storage2/026/cdd/d14/026cddd14334fc47ba49cd38a85bcb0c.jpg"><br><br>  Strangely enough, the comrade <a href="https://habrahabr.ru/users/bitmap/" class="user_link">bitmap</a> did not mention in his article exactly how he changes the image size, because there are many ways (you can see the torment in finding out the necessary option with the customer in the photo).  You can stretch into the frame, getting stretched faces, you can save proportions and fill the vacant space with color.  You can keep the proportions and trim the edges.  The module also allows a bunch of ryushechek we do not need, such as the blending of filters and other things.  As a result, on one project we began to stretch in the same way as stretching css, and on another project we filled in color. <br><br><h4>  Standard script </h4><br>  By default, out of the box it is assumed that the images and IIS are located on the same server and resizing is performed by simply adding parameters to the link: <br> <code>/image.jpg?height=200&amp;width=300</code> <br>  or <br>  <code>/image.jpg?h=200&amp;w=300</code> . <br>  Great, but how to pick up images from Amazon S3? <br><br><h4>  S3 reader </h4><br>  This is where the first of the Cloud Bundle plug-ins comes into play: <a href="http://imageresizing.net/plugins/s3reader">S3 Reader</a> .  Using simple web.config settings, it allows you to use the link in the following format: <br> <code>/s3/bucket/folder/image.jpg?h=200&amp;w=300</code> <br> <br><h4>  RemoteReader plugin </h4><br>  Ok, now we can give pictures from S3, but S3 is quite a popular thing, how about a completely third-party server?  This is where the <a href="http://imageresizing.net/plugins/remotereader">RemoteReader plugin is enabled</a> .  There is not so simple.  The final link has the following format: <br>  <code>/remote.jpg.ashx?w=200&amp;height=300&amp;urlb64=45b45c4a2099b...&amp;hmac=a2099ba2099b</code> . <br><br>  Where remote.jpg.ashx is the end point for the module to intercept the link, the urlb64 parameter is a simple link to the remote server with a picture that is encrypted with HMAC SHA-256.  This link generates a special method: <br> <code>RemoteReaderPlugin.Current.CreateSignedUrl("http://remote.com/image.jpg");</code> <br> <br><h4>  Cloudfront </h4><br>  Ok, we coped with the main task.  Now you need to somehow cache the result, otherwise it will not work quickly. <br>  We have no caching plug-ins, but there is such a magical thing as CloudFront custom origin.  We have created a new distribution of CloudFront, pointing to our domain.  So now we have the format links: <br> <code>htt://my-distribution-name.cloudfront.com/remote.jpg.ashx?w=200&amp;height=300&amp;urlb64=45b45c4a2099b...&amp;hmac=a2099ba2099b</code> <br>  and <br> <code>htt://my-distribution-name.cloudfront.com/s3/bucket/folder/image.jpg?h=200&amp;w=300</code> <br> <br>  But now our site began to open at https: //my-distribution-name.cloudfront.com, clogging the cloudfront.  Then we quickly added a section for pictures.  And CloudFront from the link <br> <code>htt://my-distribution-name.cloudfront.com/s3/bucket/folder/image.jpg?h=200&amp;w=300</code> <br>  I began to redirect the request to <br> <code>htt://my-site.com/images/s3/bucket/folder/image.jpg?h=200&amp;w=300</code> <br> <br>  It seems that the whole should work, but suddenly it turned out that CloudFront mercilessly chops long lines of parameters and we received tons of errors and not opening pictures.  Here the <a href="http://imageresizing.net/plugins/cloudfront">CloudFront plugin</a> helped us, which allowed us to convert links to the following format: <br> <code>htt://my-distribution-name.cloudfront.com/remote.jpg.ashx;w=200;height=300;urlb64=45b45c4a2099b...;hmac=a2099ba2099b</code> <br>  and <br> <code>htt://my-distribution-name.cloudfront.com/s3/bucket/folder/image.jpg;h=200;w=300</code> <br> <br><h4>  Short links </h4><br>  All this worked fine, but engineering thought went even further.  What if someone starts generating unnecessary image resolutions?  The maximum size of the increase is of course limited, but still it is possible to follow the DODOS site, and even the resulting pictures will be distributed across hundreds of CloudFront servers around the world.  And of course the length of the link is just awful.  Then we decided to implement the functionality of short links. <br><br>  When generating a link, we add to the database the resulting long link of the form: <br> <code>/remote.jpg.ashx;w=200;height=300;urlb64=45b45c4a2099b...;hmac=a2099ba2099b</code> <br>  and get its id in the table.  In the layout we spit out a format link: <br> <code>htt://my-distribution-name.cloudfront.com/42</code> <br> <br>  CloudFront addresses us at: <br> <code>htt://my-site.com/i/42</code> <br> <br>  We intercept the request, select the long link by key 42 from the database, in the server code we do the HttpRequest to ourselves, so that it is intercepted by the ImageResizer and in response we give the result of its work.  CloudFront adds the resulting image on its servers and we no longer receive this request until the next cache invalidation. <br><br>  And the final touch is hiding the terrible prefix of the CloudFront link, which is a random collection of numbers and letters, which is also not very nice with the help of an additional domain. <br><br>  As a result, the end user link is: <br> <code>htt://short.com/42</code> <br> <br>  At the same time, the image is cached, easily accessible from the server closest to the user, the malicious hacker cannot resize on his own, after DDOS is our module, we have a short link and most importantly all the pictures with the right dimensions look beautiful in their places. <br><br><h4>  Conclusion </h4><br>  In conclusion, I want to say that the plugin works fine, has a bunch of different settings and plug-ins for all occasions, it has a debug mode in case of unforeseen situations.  The author is responsible for handling problems and even seems to pay for the bugs found.  Of course, the module is paid, but worth it. </div><p>Source: <a href="https://habr.com/ru/post/160843/">https://habr.com/ru/post/160843/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160833/index.html">Google Drive now supports website publishing.</a></li>
<li><a href="../160835/index.html">Answers Minister of Communications to the questions of users</a></li>
<li><a href="../160837/index.html">10 Active Directory Administrative Tasks Solved With PowerShell</a></li>
<li><a href="../160839/index.html">Team Presentation NMSYS</a></li>
<li><a href="../160841/index.html">Native MVC for Silex PHP Framework</a></li>
<li><a href="../160845/index.html">Choosing an ORM Strategy (.NET)</a></li>
<li><a href="../160849/index.html">Yandex.Amnestia</a></li>
<li><a href="../160851/index.html">Convert menu to drop-down list on small screens</a></li>
<li><a href="../160853/index.html">Angry Citizen</a></li>
<li><a href="../160855/index.html">6400mAh High Capacity Battery for Samsung Galaxy Note II [HLI-N7100XL]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>