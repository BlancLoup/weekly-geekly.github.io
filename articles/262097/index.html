<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Algorithms of attack and protection of mobile advertising network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I would like to talk about mobile advertising networks, about their protection system and ways to circumvent it. Ways to bypass the protection systems...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Algorithms of attack and protection of mobile advertising network</h1><div class="post__text post__text-html js-mediator-article">  I would like to talk about mobile advertising networks, about their protection system and ways to circumvent it.  <b>Ways to bypass the protection systems were used only for educational purposes.</b>  Also note that the attack algorithms presented here are valid for all platforms, but the example shows the work of Android, because  attacks on its code are the easiest to describe. <br><a name="habracut"></a><br>  What is a mobile ad network?  This is a client-server application in which the server receives reports from the client applications on launching the application, making clicks on advertising and performing actions, and also sends them an advertisement for display to the user.  Client applications are libraries that can interact with the server, which are usually embedded in mobile applications of third-party developers. <br><br>  The power of the advertising network is measured in the number of users of applications that show advertising, which is logical - the more advertising the network can show to users, the more money it will earn and the more attractive it will be for other advertisers. <br><br>  To increase the number of applications that show ads, networks are trying to attract third-party applications instead of writing their own.  They provide developers with their own advertising SDK, able to communicate with their servers.  For this, they give such developers a certain% of the money earned for showing clicks or actions taken from a third-party application.  In this honest collaboration, everyone is happy: the advertising network receives a new application with a ready-made audience with which to advertise, a third-party developer gets money from this advertisement, and the advertiser receives a large audience. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Any partner of the advertising network is given a pair of appId - the application ID in the database of the advertising network and the secret is the secret key for signing actions.  Anyone - ideally, because  Some ad networks only give it to advertisers. <br><br><img src="https://habrastorage.org/files/cfc/78d/e24/cfc78de24d8347469baaecd7fb033526.png" alt="image"><br><br>  What happens next?  When the application starts, this pair enters the advertising SDK and that's it, the work of a bona fide integrator at this stage ends.  If this is a marketing application, it makes a request to the server, sending all its parameters (various identifiers, such as imei, openudid, udid, serial), device and platform information, and its appId.  She signs all this with a secret, usually making a sha1 hash of the parameters to be sent and adding it to the request.  The server, after authentication, gives the application advertising.  Each advertising unit is accompanied by a set of two links.  This is a link to now (which is not all ad networks) and a link to click.  When an advertisement appears on the screen and the user actually sees it, the link to the show is pulled and the fact of the show is sent to the server.  If the user becomes interested and makes a click - the fact of the click will also go to the server via another link. <br><br>  As a result of these actions, the advertising application from which the actions were performed will receive money. <br><br><h4>  Views and Clicks </h4><br>  What will happen if the developer is dishonest and wants to get money just like that?  In this case, it also registers in the advertising network, integrates the advertising SDK into it, and brings the application to the market.  Next, he needs to send a fake request for real advertising, send the fact of display and click and get money.  To do this, you need to examine what parameters are required for the request and their format.  Some ad networks themselves write this information in the documentation, others have the source code of the SDK.  Still others supply their SDKs as closed source libraries.  The attacker must obtain an ad network library, then change the mechanism for generating an ad request so that device identifiers are not collected, but generated randomly. <br><br><div class="spoiler">  <b class="spoiler_title">Hacking a closed library</b> <div class="spoiler_text">  The closed Android SDKs are usually distributed as a jar archive with compiled classes.  The source java-code can be obtained using a Java decompiler, for example, jd gui.  There may be a problem with masking methods in nested classes.  A Java compiler, in the case of nesting a class in a class and calling a top-class method from the bottom, changes the method call to the generated method ID $ access.  In this case, the attacker needs to guess which method should be invoked by meaning and by the passed parameters.  This inconvenience does not greatly complicate the actions of the attacker, but it can make it difficult to automate the hacking SDK. <br></div></div><br>  As a result, the attacker sends a request for advertising with the appId of its advertising applications and non-existent device.  Then he receives advertising and pulls links to commit actions.  It's simple. <br><br>  It is impossible to protect against such fraud on the side of the SDK, so ad networks refuse to advertise with views and clicks and move on to the next type of advertising - adverts for installations. <br><br><h4>  Installations and actions </h4><br>  It is more difficult to fake installations, since  The advertised application participates in them.  With fair use immediately after clicking on an advertisement, the interested user starts installing this application.  When the application is installed, it also uses the advertising SDK to send the fact of installation to the server.  In the case of advertising for the action - the fact of installation is not enough.  After installation, the user must perform a certain action in the application, which will also be reported to the advertising network. <br><br>  An attacker needs to know the secret key of the advertised application in order to send a fake fact of installation or action. <br><br>  How to do it?  It is necessary to download the application 1 time, decompile and get the secret key.  For the Android platform, this is easy. <br><br>  Packages of applications under Android OS are delivered in the form of archives with the apk expansion.  The archive contains application resources, media files, other files and a dex file with compiled application classes. <br><br><img src="https://habrastorage.org/files/70f/11a/d0a/70f11ad0a82d40edb61608b87d83d316.png" alt="image"><br><br>  That he is interested in the attacker.  Using the dex2jar application, an attacker can get a jar-ahriv with the compiled source code of the application and then proceed to decompile to get the secret code. <br><br><img src="https://habrastorage.org/files/287/6d9/00a/2876d900a6b74507aa104a35da04778f.png" alt="image"><br><br>  If the application developer did not pay attention to the protection of the application and did not obfuscate the code, the secret parameters of the application will be stored in clear text in the code.  All you have to do is search through the class and function that calls the ad SDK. <br><br><div class="spoiler">  <b class="spoiler_title">Decompiled class</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/d7c/914/9da/d7c9149da99f4d748438b662b11ec5b5.png" alt="image"><br></div></div><br>  In most cases, application developers try to complicate hacking by transferring the secret and id of an ad network application from code, where it can be easily reached, into resources and obfuscating the application to confuse the attacker. <br><br>  Application resources are located in the apk-package in the resources.arsc file.  This is a special file containing a table of application resources.  The figure above shows that the attacker's goal - the secret and id of the application in the advertising network are hidden in files with resources, and the code that calls them is obfuscated. <br><br><div class="spoiler">  <b class="spoiler_title">Obfuscated class</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a92/5cf/6d1/a925cf6d129d46afab26e54c4c02f087.png" alt="image"><br>  This can be judged by the fact that instead of a line like <i>TapjoyConnect.requestTapjoyConnect (paramContext.getApplicationContext (), "appId", "secret");</i>  there is a loop that passes 1 time and receives the application id and secret from the resources.  In this case, the attacker has to search for the fragment of code he is interested in throughout the application and analyze the entire code obfuscated by the obfuscator. <br></div></div><br>  The secret and id of this application were hidden in the resource file.  At the same time, all resource identifiers when compiling an application for Android are entered into R.class, which generates the Android SDK.  Therefore, an attacker can spy on the id the name of the resource that is being called.  In the id code fragment, the application corresponds to the code 2131165201, and to the secret - the code 2131165202. <br><br><img src="https://habrastorage.org/files/3f0/0e5/4a3/3f00e54a3e194ad6a506a1c4e33a5e67.png" alt="image"><br><br>  A search for these codes in the R class shows that a resource called tapjoy_amazon_app_id and tapjoy_amazon_secret_key is being used.  All the attacker now needs is to access the strings.xml resource file, encoded in resources.arsc. <br><br><img src="https://habrastorage.org/files/797/9c1/513/7979c1513b4341f0a90b72f969ed0bfc.png" alt="image"><br><br>  To do this, you need to decode the apk-package of the application using the apktool utility, after which all the application's resources will become available and the attacker can simply open it with a text editor and find the resources by previously obtained names. <br><br><div class="spoiler">  <b class="spoiler_title">Found resources</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/32b/a1a/b91/32ba1ab91b554baca6c0e751961a0a39.png" alt="image"><br></div></div><br>  As soon as the attacker received the secret key, he can send the fact of a false installation from the fake identifiers that he sgenerated during the advertisement request stage. <br><br><div class="spoiler">  <b class="spoiler_title">Ad network recommendations</b> <div class="spoiler_text">  Protecting the advertising SDK is not enough in this case.  Even if you use the native library instead of Java, you can only make it difficult to hack (and make compatibility problems), because  it is distributed freely and will always be available to the attacker.  To catch fake facts - you need to use the following: <br>  In the case of logical protection you need: <br><ul><li>  do not count clicks if there was no request for advertising </li><li>  do not consider clicks, if before that there was no fact of viewing </li><li>  do not take into account the installation, if too little time has passed after the click (depending on the size of the application being downloaded) </li><li>  remember which ad was given in the ad request and prevent ad views / clicks on the ad that the user did not receive </li><li>  after clicking to prevent clicks on other advertisements from the same issue </li></ul><br>  Compliance with the recommendations for logical protection will significantly reduce the rate of falsification of facts by the attacker, but if he also guesses to see this spoiler, then the ad network will need more complex protection. <br><br>  You need to check the actual number of installations for advertising applications.  Unfortunately, at the moment, application stores do not provide this information to third parties.  However, you can look towards Google Analytics.  If the number of devices on which there is advertising, exceeds the number of installed, the partner is an attacker. <br><br>  You can also monitor all devices that send facts of installations / requests for advertising.  And if within a month no action was taken from these identifiers - consider such a device as an accidentally generated intruder and non-existent. <br><br>  If the ad network has enough traffic, then you should not send the same ad to the same advertising application.  This will significantly reduce the rate of hacking, because  the attacker will always get advertisers secrets slower than the advertising rotation will occur. <br><br>  And finally - require your advertisers to obfuscate the code without fail and enter a secret change once in a while or for a certain number of fact signings. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Next steps</b> <div class="spoiler_text">  <b>This spoiler is not a recommendation to attackers.</b>  <b>His goal is to show networks that not only piece hacks are possible and that they have something to fear.</b> <br><br>  If an attacker takes the issue of hacking seriously, he can easily automate it.  Searching even obfuscated code is not a difficult task, since  The class name and method of invoking the advertising SDK is always open.  And if you consider that a sufficiently large percentage of developers do not obfuscate the code, then you can automatically get a sufficiently large number of secrets. <br><br>  The scheme by which attackers can act is to create several applications whose task is to collect a large number of advertised applications for hacking.  As soon as a sufficiently large amount of data is accumulated, you can run an application that uses the collected databases to send falsified data. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/262097/">https://habr.com/ru/post/262097/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262087/index.html">Interview with the coordinator of the Code Club project on teaching children 9-11 years old the basics of programming</a></li>
<li><a href="../262089/index.html">Adding an OpenCV library to an Android Studio project</a></li>
<li><a href="../262091/index.html">Mikrotik VRF + NAT - Managing devices with the same IP address from one host</a></li>
<li><a href="../262093/index.html">Gangbang, protein window and poker with ballerinas: Robots Office Dictionary</a></li>
<li><a href="../262095/index.html">7 steps to launch gh-pages for AngularJS projects created using Yeoman</a></li>
<li><a href="../262101/index.html">Advanced Exim and Dovecot configuration with OpenLDAP binding</a></li>
<li><a href="../262103/index.html">Why we encrypt</a></li>
<li><a href="../262105/index.html">Checking JSON using decorators in TypeScript</a></li>
<li><a href="../262113/index.html">Insane experiences on the "implementation" of Windows 3.11 continues</a></li>
<li><a href="../262115/index.html">Icinga2 and agentless monitoring of Windows servers using WMI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>