<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We make a simple web service using the Yandex.Metrics API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 Not so long ago, Yandex discovered the use of the Yandex.Metrica API. In this article I will tell why it is needed, how to use it and briefl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We make a simple web service using the Yandex.Metrics API</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  Not so long ago, Yandex discovered the use of the Yandex.Metrica API.  In this article I will tell why it is needed, how to use it and briefly describe the differences from the Google Analytics API. <br><br>  In addition, I will show how to use this API to create a web service where you can compare the site‚Äôs current performance with the past and see how the popularity of pages changed over time: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/storage1/c9f0b527/38970edd/a2d6e576/6988a68d.png"></div><br><a name="habracut"></a><br><h4>  About the Metrics API in Brief </h4><br>  The main difference between the Metrics API and the Google Analytics API is that it focuses on reports, not indicators.  A programmer using GA should tell the service ‚ÄúI want to see visits from advertising sources broken down by goal 1, the number of visits, the bounce rate‚Äù, the user of Metrics will say ‚ÄúI want to see a report on the content‚Äù. <br><br>  The choice of targeting reports, rather than indicators, is consistent with the concept of Metrics as a tool for ordinary users, not professionals.  Using the Metrics API is really much simpler. <br><br>  However, the current approach has drawbacks.  First of all, you can request from the service only reports predefined by Yandex programmers.  Secondly, since the structure of the reports cannot be changed, each time you will receive an excess amount of information, which may affect the response time of the service. <br><br>  The metric is developing very quickly (at the time of writing this article, I even managed to change the API a little), so I am sure that soon it will be possible, just like in GA, to generate reports only for the necessary indicators, and the problems described above will disappear. <br><br><h4>  Why is it needed? </h4><br>  So why do we need a metrics API?  With it, you can mess things up a lot of interesting things, for example: <br><ol><li>  Show real-time statistics on the site </li><li>  Integrate site statistics into your CRM </li><li>  Automate and streamline employee work </li></ol><br>  Point one is a funny whistle-fake, which, nevertheless, may be interesting to the advertisers of the site.  You can directly on the page "advertise on the site" automatically display the most popular queries that come to the site, the schedule of attendance, geographic regions from which users come and much more. <br><br>  For example, here‚Äôs how it was done on Habr√© ( <a href="http://habrahabr.ru/info/stats/">http://habrahabr.ru/info/stats/</a> ): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/8df5b334/236fa556/76ed877d/127be42f.jpg"></div><br><br>  Point 2 (integration of statistics in CRM) is understandable without explanation.  Add to the internal information about the order of its source, the region of the buyer and sometimes even a specific advertising creative is the blue dream of any advertiser / analyst.  After this is done, you will immediately see which advertising is effective and which is not and at the same time save the call center from at least a few unnecessary questions to the user. <br><br>  Employee automation (point 3) is important for those who place a lot of advertising, spend a lot of money on SEO and constantly monitor the effectiveness of this whole business.  Let's say that every week your employees process 40 reports from Yandex. Metrics.  They spend 10 minutes on each report.  It is 6 hours and 40 minutes.  And if you give them the already processed documents, then these 7 hours can be spent on something really useful. <br><br><h4>  The main advantage for the programmer </h4><br>  After working with the GA API and its cumbersome <nobr>XML format,</nobr> I would like to separately emphasize another important point: The metric allows you to receive data in JSON!  In my opinion, this is one of the most important competitive advantages over GA.  All modern languages ‚Äã‚Äãare able to work with JSON out of the box, and thus there is no need for any additional libraries.  Unlike Google with Metric, you can immediately sit down and go. <br><br>  This is very easy to verify, open a new browser tab and go to the following URL (you should be logged in with Yandex): <a href="">http://api-metrika.yandex.ru/counters.json?pretty=1</a> . <br><br>  Congratulations, you have just used the metrics API.  And you don‚Äôt even need any additional programs to parse the server‚Äôs response. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/39599625/7500f133/0f99cc2a/1323d31d.png"></div><br><br><h4>  We make our own service based on API Metrics </h4><br><br>  So, in order to get a deeper understanding of the API, we will try to create an Internet service that expands the standard capabilities of the Metric.  By default, it lacks one very important thing - a comparison with the previous period.  This is a very convenient feature, thanks to which site analytics become much easier.  In GA, the period comparison looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/14d4ea97/06f10665/d09f9745/51756581.jpg"></div><br><br>  Let's try to do something similar for Metrics. <br><br>  Before you start creating reports directly, you must give the user the opportunity to select the counter whose statistics he wants to see.  To do this, we must use the link that we have already seen above ( <a href="">http://api-metrika.yandex.ru/counters.json</a> ).  From the information that the server sends, we need to pull out two parameters: id and site.  ID is the number of the counter, without which it is impossible to get any statistics, and site is the name of the site specified during registration. <br><br>  It should be noted that when creating an API, you need to log in.  This can be done in several different ways, which I will not describe in this article.  For my service, I chose oAuth, since I already used it when working with Google services.  As it turned out, the implementation of oAuth from Yandex is much easier to use than the version of its overseas rival. <br><br>  So, we will create for the user an interface for choosing a counter and a period with which we will compare our data.  On python, the code for requesting counters will look like this: <br><br><blockquote><code><a href=""></a> <font color="#008000"><strong>class</strong></font> <font color="#0000FF"><strong>FetchCounters</strong></font> (webapp <font color="#666666">.</font> RequestHandler): <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">post</font> ( <font color="#008000">self</font> ): <br> token <font color="#666666">=</font> cgi <font color="#666666">.</font> escape( <font color="#008000">self</font> <font color="#666666">.</font> request <font color="#666666">.</font> get( <font color="#BA2121">'token'</font> )) <br> counters <font color="#666666">=</font> memcache <font color="#666666">.</font> get(token) <br> <font color="#008000"><strong>if</strong></font> counters <font color="#AA22FF"><strong>is</strong></font> <font color="#008000">None</font> : <br> fetch_url <font color="#666666">=</font> <font color="#BA2121">'api-metrika.yandex.ru/counters.json?oauth_token='</font> <font color="#666666">+</font> token <br> result <font color="#666666">=</font> urlfetch <font color="#666666">.</font> fetch(url <font color="#666666">=</font> fetch_url, deadline <font color="#666666">=3600</font> ) <br> <font color="#008000"><strong>if</strong></font> result <font color="#666666">.</font> status_code <font color="#666666">==</font> <font color="#666666">200</font> : <br> counters <font color="#666666">=</font> json <font color="#666666">.</font> loads(result <font color="#666666">.</font> content)[ <font color="#BA2121">"counters"</font> ] <br> memcache <font color="#666666">.</font> add(token, counters, <font color="#666666">3600</font> ) <font color="#408080"><em># TTL 3600 __seconds__</em></font> <br> <font color="#008000"><strong>else</strong></font> : <br> counters <font color="#666666">=</font> <font color="#BA2121">'Oops, looks like you don</font> <font color="#BB6622"><strong>\'</strong></font> <font color="#BA2121">t have permission to access counters'</font> <br> <font color="#008000">self</font> <font color="#666666">.</font> response <font color="#666666">.</font> out <font color="#666666">.</font> write(json <font color="#666666">.</font> dumps(counters)) <br></code> </blockquote><br><br>  Since this service is not intended for production, we will save a list of memcache counters for a user token in order not to pull the server once more.  In reality, this is probably not worth doing on the Google AppEngine platform - memcache size is relatively small. <br><br>  For the user, the interface will look like this: <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/storage1/5dcf72c2/0a0afbff/e94498ee/c9994819.png"></a> </div><br><br>  Next, we need to select the appropriate report from the available list.  The Metrics API has the following report groups: <br><ul><li>  Traffic </li><li>  Sources </li><li>  Content </li><li>  Geography </li><li>  Demography </li><li>  Computers </li></ul><br>  To build a graph, you need to know the number of visits on each of the days of the period under consideration, therefore we need the ‚Äútraffic‚Äù report group, and the ‚Äúattendance‚Äù report in it.  To get the necessary data we will form a request of the following form: <br>  <a href="">http://api-metrika.yandex.ru/stat/traffic/summary.json?id=XXXXXX&amp;date1=YYYYMMDD&amp;date2=YYYYMMDD&amp;oauth_token=XXXXXX</a> <br><br>  The id is the ID of the user-selected counter, date1 and date2 - the dates in the specified format.  Any request to the API metrics can be checked directly in the browser, so you can simply take the id of your counter and substitute it in this link.  If you are logged in to Yandex services, you can omit the oAuth token. <br><br>  In response, the metric will return a report, which contains a lot of different superfluous information, we only need the date (‚Äúdate‚Äù) and the number of visits (‚Äúvisits‚Äù): <br><br><blockquote> <code>data1 <font color="#666666">=</font> <font color="#008000">map</font> ( <font color="#008000"><strong>lambda</strong></font> x: { <font color="#BA2121">"date"</font> : <font color="#008000">self</font> <font color="#666666">.</font> format_date(x[ <font color="#BA2121">"date"</font> ]), <font color="#BA2121">"visits"</font> : x[ <font color="#BA2121">"visits"</font> ] }, json <font color="#666666">.</font> loads(res1 <font color="#666666">.</font> content)[ <font color="#BA2121">"data"</font> ]) <br></code> </blockquote><br><br>  Further, we will compare the period chosen by the user with the previous period with a similar number of days (for example, <nobr>1.06-7.06</nobr> will be compared with <nobr>24.05-31.05).</nobr>  To do this, first calculate the length of the period in time: <br><br><blockquote> <code>period <font color="#666666">=</font> [datetime <font color="#666666">.</font> strptime(cgi <font color="#666666">.</font> escape( <font color="#008000">self</font> <font color="#666666">.</font> request <font color="#666666">.</font> get( <font color="#BA2121">'date_1'</font> )), <font color="#BA2121">"%Y-%m-</font> <font color="#BB6688"><strong>%d</strong></font> <font color="#BA2121">"</font> ), datetime <font color="#666666">.</font> strptime(cgi <font color="#666666">.</font> escape( <font color="#008000">self</font> <font color="#666666">.</font> request <font color="#666666">.</font> get( <font color="#BA2121">'date_2'</font> )), <font color="#BA2121">"%Y-%m-</font> <font color="#BB6688"><strong>%d</strong></font> <font color="#BA2121">"</font> )] <br> rng <font color="#666666">=</font> period[ <font color="#666666">1</font> ] <font color="#666666">-</font> period[ <font color="#666666">0</font> ] <font color="#666666">+</font> timedelta( <font color="#666666">1</font> ) <br></code> </blockquote><br><br>  And then we subtract the length from the end points of our period: <br><br><blockquote> <code>res2 <font color="#666666">=</font> <font color="#008000">self</font> <font color="#666666">.</font> fetch_data( <font color="#008000">map</font> ( <font color="#008000"><strong>lambda</strong></font> x: x <font color="#666666">-</font> rng, period)) <br> <font color="#008000"><strong>if</strong></font> <font color="#AA22FF"><strong>not</strong></font> res2: <br> <font color="#008000"><strong>return</strong></font> <br> data2 <font color="#666666">=</font> <font color="#008000">map</font> ( <font color="#008000"><strong>lambda</strong></font> x: { <font color="#BA2121">"visits"</font> : x[ <font color="#BA2121">"visits"</font> ] }, json <font color="#666666">.</font> loads(res2 <font color="#666666">.</font> content)[ <font color="#BA2121">"data"</font> ]) <br></code> </blockquote><br><br>  As a result, for each date from the user period, we will have the number of visits on that day and N days ago and on the basis of this data it is already possible to build a schedule.  I used Google Charts to build graphs, because it‚Äôs easy to work with them, and the result looks pretty nice.  The comparison chart looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/61e87151/81ab64c5/cdb8a13c/8eb8b230.png"></div><br><br>  Now that we have data on days and visits, why don't we calculate the deviation from the average on each of the days.  If you present this information in the form of a histogram, it will be easier to perceive than if you look at the plotted chart. <br><br>  To do this, we calculate the average value by dividing the sum of visits by the number of days, and then compare the resulting value with the value of each individual day.  As a result, we obtain the following diagram: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/56fa6123/5aee7fe1/0eb09e64/b012ff76.jpg"></div><br><br>  So, now we have diagrams for comparing traffic with the past, but in order to make our service truly useful, we need to add something else there. <br><br>  Very often, when evaluating a site, one has to compare how the popularity of pages has changed.  For example, the fact that telescopes on the Dobson stand go well this month does not mean that they also sold well in the past.  Let's try to add a report in which you can quickly and easily see changes in page traffic. <br><br>  To do this, we will use the report type "content", and in it the report "Popular".  This report provides information on the number of entries, exits, and views.  You can get the report data by clicking on the link <a href="">http://api-metrika.yandex.ru/stat/content/popular.json?id=XXXXXX&amp;date1=YYYYMMDD&amp;date2=YYYYMMDD&amp;oauth_token=XXXXXXper2page=20</a> . <br><br>  Please note that this time a new parameter ‚Äúper_page‚Äù has appeared in the link.  This is an optional parameter that tells the Metrics API how many records should be in the server response.  By default, the server always gives 100 entries, but in this case for us this is an excess value. <br><br>  The rest of the data acquisition mechanisms are extremely similar. <br><br><blockquote> <code>res1 <font color="#666666">=</font> <font color="#008000">self</font> <font color="#666666">.</font> fetch_data(period, <font color="#666666">20</font> ) <br> <font color="#008000"><strong>if</strong></font> <font color="#AA22FF"><strong>not</strong></font> res1: <br> <font color="#008000"><strong>return</strong></font> <br> data1 <font color="#666666">=</font> json <font color="#666666">.</font> loads(res1 <font color="#666666">.</font> content)[ <font color="#BA2121">"data"</font> ] <br> <br> res2 <font color="#666666">=</font> <font color="#008000">self</font> <font color="#666666">.</font> fetch_data( <font color="#008000">map</font> ( <font color="#008000"><strong>lambda</strong></font> x: x <font color="#666666">-</font> rng, period)) <br> <font color="#008000"><strong>if</strong></font> <font color="#AA22FF"><strong>not</strong></font> res2: <br> <font color="#008000"><strong>return</strong></font> <br> data2 <font color="#666666">=</font> make_url_tuple(json <font color="#666666">.</font> loads(res2 <font color="#666666">.</font> content)[ <font color="#BA2121">"data"</font> ]) <br></code> </blockquote><br><br>  As a result, our service will look like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/3c912150/673573ab/f86e783e/f3a41ad4.jpg"></div><br><br>  Due to the fact that the right column shows how the position has changed in comparison with the previous period, it is very easy to understand the dynamics of page popularity. <br><br><h4>  Appendix </h4><br>  Play with the service can be made at <a href="http://metrika-api.appspot.com/">http://metrika-api.appspot.com</a> <br>  Source code is available here: <a href="https://github.com/sakudayo/Hello-Metrics">https://github.com/sakudayo/Hello-Metrics</a> <br>  API metrics documentation is posted by Yandex at the URL: <a href="">http://api.yandex.ru/metrika/doc/ref/concepts/About.xml</a> <br>  Google Charts Documentation: <a href="http://code.google.com/intl/ru-RU/apis/chart/">http://code.google.com/intl/ru-RU/apis/chart/</a> </div><p>Source: <a href="https://habr.com/ru/post/123207/">https://habr.com/ru/post/123207/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123197/index.html">New PHC shop partners network management module released</a></li>
<li><a href="../123198/index.html">Crowdsourcing in translation sites</a></li>
<li><a href="../123200/index.html">Controller architecture: simple tips for every day</a></li>
<li><a href="../123205/index.html">Is it all bad with RIM and BlackBerry?</a></li>
<li><a href="../123206/index.html">Organizational structure of different IT companies</a></li>
<li><a href="../123208/index.html">Please finally shoot these tags!</a></li>
<li><a href="../123209/index.html">Court and EMS</a></li>
<li><a href="../123210/index.html">Opera Extension: Radio</a></li>
<li><a href="../123213/index.html">Ricoh bought Pentax</a></li>
<li><a href="../123214/index.html">Inviter: how to remove topics with 1500+ comments about invites</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>