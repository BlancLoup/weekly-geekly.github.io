<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cross-platform New Year's demo on .NET Core and Avalonia</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="" AAA! It's time to rewrite to .NET Core«É, " they said, WPF discussed in the comments. So let's check if you can write a cross-platform GUI applicatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cross-platform New Year's demo on .NET Core and Avalonia</h1><div class="post__text post__text-html js-mediator-article"><p>  " <a href="https://habrahabr.ru/company/jugru/blog/345136/">AAA! It's time to rewrite to .NET Core«É,</a> " they said, WPF discussed in the comments.  So let's check if you can write a cross-platform GUI application in .NET / C #. </p><br><p><img src="https://habrastorage.org/webt/oo/6j/qp/oo6jqpzzknwmescta77e6nf7nqe.gif"></p><br><p>  Christmas mood inspired the idea to make the animation of falling snow.  There were such demos for DOS, burning fire, fractals, a snowball falling on a Christmas tree, and so on. </p><br><p>  As we will see below, it is not only fun, but also allows you to experience the key functionality of the UI framework.  Go! </p><a name="habracut"></a><br><h1 id="sozdanie-proekta-i-ui">  Project Creation and UI </h1><br><p> For Avalonia, there is a <a href="https://marketplace.visualstudio.com/items%3FitemName%3DAvaloniaTeam.AvaloniaforVisualStudio">Visual Studio Extension</a> with a project template.  Install, create <code>Avalonia .NET Core Application</code> .  We see habitual on WPF <code>App.xaml</code> and <code>MainWindow.xaml</code> .  However, the project contains <code>&lt;TargetFrameworks&gt;netcoreapp1.1;net461&lt;/TargetFrameworks&gt;</code> , change to <code>&lt;TargetFramework&gt;netcoreapp2.0&lt;/TargetFramework&gt;</code> , we are not in the Stone Age. </p><br><p>  The Avalonia extension for the studio contains the XAML Designer, but it did not work for me.  Resharper goes a little crazy in the markup editor, wants to insert explicit namespaces everywhere, so we'll manage without him too. </p><br><p>  For the rest, we have in our hands the usual XAML with the usual controls and properties.  All differences can be read in the <a href="http://avaloniaui.net/tutorial/from-wpf.html">documentation</a> . </p><br><p>  For arbitrary drawing, there is an analogue of the same name <code>WriteableBitmap</code> from WPF.  A huge plus is that there are no problems drawing in it from any stream, it looks like this: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Image</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Bitmap}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Stretch</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Fill"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ILockedFramebuffer buf = writeableBitmap.Lock()) { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>* ptr = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>*) buf.Address; <span class="hljs-comment"><span class="hljs-comment">//  *ptr = uint.MaxValue; }</span></span></code> </pre> <br><p>  However, <code>Image</code> , which is tied to our writeableBitmap, will not update by itself, it needs to say <code>InvalidateVisual()</code> . </p><br><p>  Thus, we can draw animations in the background thread without loading UI thread.  In addition to <code>Image</code> we will add a couple of sliders to control the speed of snow falling and the number of snowflakes, everything is standard here, <code>{Binding Mode=TwoWay}</code> .  Plus, the "start over" button is also a standard link to <code>ICommand</code> .  I note that vector icons on XAML, copied from Google, are used, <code>&lt;Path&gt;</code> functions as expected. </p><br><p>  Full markup: <a href="">MainWindow.xaml</a> </p><br><h1 id="snezhnyy-algoritm">  Snow algorithm </h1><br><h3 id="fizika">  "Physics" </h3><br><p>  Move the snowflake down one pixel.  If the pixel is already occupied by the "lying" snowflake, check the points on the left and right, and move to where it is free.  Everything is busy - mark the point as "lying."  Thus, the rolling of snowflakes from inclined surfaces is achieved. </p><br><h3 id="parallaks">  Parallax </h3><br><p>  To achieve the volume effect, let us set a random speed for each snowflake.  The lower the speed, the darker the shade we use for drawing. </p><br><p>  In order for our "physics" to work correctly, it is necessary to move the snowflakes no more than 1 pixel per frame.  That is, the fastest snowflakes move each frame per pixel, the others skip some frames.  To do this, you can use the <code>float</code> coordinates and simply redraw every snowflake for each frame.  Instead, I use two integer <code>short</code> fields and redraw the snowflake only <a href="">if it really moved</a> . </p><br><h3 id="rendering">  Rendering </h3><br><p>  The main idea is to avoid full frame redrawing.  We need to somehow store the "lying" snow, user-drawn dots, downloaded images (yes, you can draw with the mouse and load picchi with a right click - the snowball will stick to Christmas trees and inscriptions). </p><br><p>  A simple and effective solution is to use <code>WriteableBitmap</code> itself.  Let the ‚Äúpermanent‚Äù pixels be completely opaque (A = 255), and for moving snowflakes A = 254. </p><br><p>  Falling snowflakes are always a fixed number, position and speed of each stored in the array.  As a result, if the snowflake has moved - we erase the point on the old position and draw on the new one.  If turned into a "recumbent" - set the alpha channel of the point to 255, move the live dropback back to the top. </p><br><h1 id="kak-eto-zapustit">  How to run it? </h1><br><p>  Thanks to the possibility of drawing directly "alive", it turned out to be a pretty sticky thing, try it :) </p><br><p>  For all OS, the instruction is the same: </p><br><ul><li>  Install <a href="https://www.microsoft.com/net/download">.NET Core SDK</a> </li><li> <code>git clone https://github.com/ptupitsyn/let-it-snow.git</code> </li> <li> <code>cd let-it-snow/AvaloniaCoreSnow</code> </li> <li> <code>dotnet run</code> </li> </ul><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  .NET Core is young, Avalonia is still in alpha, but now these tools solve the problem!  The code is simple and clear, no hacks and extra squats, works great on Windows, macOS, Linux. </p><br><p>  Alternatives? </p><br><ul><li>  Qt (more difficult to use) </li><li>  Java (no normal unsafe) </li><li>  Electron (JavaScript + HTML - no, thanks) </li></ul><br><p>  The UI in this demo is very simple, but it uses some of the most important features: </p><br><ul><li>  Layout (Grid, StackPanel, alignment) - the basis of the layout </li><li>  Binding (binding of controls to model properties) </li><li>  ItemsControl, ItemsPanel, DataTemplate - working with data collections </li><li>  WriteableBitmap - direct work with images </li><li>  OpenFileDialog native on each platform </li></ul><br><p>  This is enough to build a UI of any complexity.  So, we can say that the last gap in the .NET ecosystem is closed: it is possible to create web (ASP.NET Core), mobile (Xamarin) and desktop (Avalonia) applications, while reusing the code by placing it in the .NET Standard libraries. </p><br><h3 id="ssylki">  Links </h3><br><ul><li>  <a href="https://github.com/ptupitsyn/let-it-snow">Githaba code</a> </li><li>  <a href="https://www.microsoft.com/net">.NET Core</a> </li><li>  <a href="https://github.com/AvaloniaUI/Avalonia">Avalonia ui</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/345708/">https://habr.com/ru/post/345708/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345698/index.html">We turn speakers into speakers on the example of HighLoad ++</a></li>
<li><a href="../345700/index.html">Mobile retargeting - the main tool for promoting mobile applications in 2018</a></li>
<li><a href="../345702/index.html">The story of the emergence of financial accounting in my life</a></li>
<li><a href="../345704/index.html">Amazon EC2 vs Atlex Cloud VDC: Performance Comparison</a></li>
<li><a href="../345706/index.html">Distributed backends for 2GIS video advertising on .NET Core and Kubernetes</a></li>
<li><a href="../345710/index.html">Unity newbie bugs tested in their own skin</a></li>
<li><a href="../345712/index.html">New to the New Year: a review of Veeam Backup & Replication 9.5 Update 3</a></li>
<li><a href="../345714/index.html">Mathematical models of relay-pulse regulators</a></li>
<li><a href="../345716/index.html">SAP Cloud Platform Webinar Library: from Internet of Things services to machine learning and UX</a></li>
<li><a href="../345724/index.html">Efficient use of process.env</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>