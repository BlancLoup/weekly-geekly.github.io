<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Operating systems from scratch; Level 0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon / evening / night / morning! There is one experimental course on operating systems. There he is at Stanford University. But some materi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Operating systems from scratch; Level 0</h1><div class="post__text post__text-html js-mediator-article"><p><img title="CPDV" width="300" align="left" src="https://habrastorage.org/webt/0m/ys/el/0myseltgynio6yfqva1boggadq8.gif">  Good afternoon / evening / night / morning!  There is one experimental course on operating systems.  There he is at Stanford University.  But some materials are available to everyone.  In addition to the slides, full descriptions of practical exercises are available. </p><br><p>  How does this course differ from others?  Most of the code is written independently and runs on a very real modern hardware.  The target platform is <a href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b/">Raspberry Pi 3 model B.</a>  Those.  sufficiently current architecture AArch64.  ARMv8 Cortex-A53, four cores, 64-bit and that's it.  <a href="https://www.rust-lang.org/">Rust is</a> selected as the main programming language.  Which is safe, fast, without GC and so on.  He, Rust, is supposed to be studied during the course. </p><br><p>  There are about disks, file systems, input-output operations, threads / processes, scheduling, virtual memory, protection and security, interrupts, concurrency and synchronization.  As in any other self-respecting course.  The difference in the relevance of the material and the amount of practice.  Coddit will <strong>have a lot</strong> . </p><a name="habracut"></a><br><h2 id="primechanie-perevodchika">  Translator's Note </h2><br><p>  If you wanted to see a literal translation, then it will not be.  Instead, I will try to make the text useful and understandable.  For example, in places that are relevant only to Stanford students, I will put the information useful to others.  There may be a little slang, a little unrelated to the original illustrations and a small number of additional comments.  For the sake of readability, there will be no obvious Translator Notes ‚Ñ¢.  The text can be considered a literary translation or an article based on.  I'm not a welder - I will not be offended. </p><br><p>  Where did I learn about this course?  Someone posted a <a href="https://news.ycombinator.com/item%3Fid%3D16134618">reference on Hacker News</a> .  I accidentally saw and penetrated.  A little he poked the course materials and eventually decided to translate this matter. </p><br><h2 id="obzor">  Overview </h2><br><p>  In this part we will customize the raspberry and necessary tools.  As a result, we will have a raspberry flashing LED.  There are four main stages.  First of all, we need to make sure that the connection between Pi and the computer works for itself.  Run the pre-prepared program.  In the second stage, let's figure out how to connect LEDs.  Pro breadboard and wiring.  At the third stage we will collect <del>  nyashny </del>  call code and run it on Pi.  Install the <code>aarch64-none-elf</code> and try it out.  And at the fourth stage we will rewrite this whole thing on Rust. </p><br><p>  A couple of useful links: </p><br><ul><li>  <a href="https://web.stanford.edu/class/cs140e/docs/BCM2837-ARM-Peripherals.pdf">Documentation on the BCM2837 processor</a> - mainly about peripherals </li><li>  <a href="https://learn.sparkfun.com/tutorials/how-to-use-a-breadboard">Colorful comprehensive article</a> about mockup and wiring </li><li>  <a href="">About using GPIO in Malinka</a> </li><li>  <a href="https://learnxinyminutes.com/docs/rust/">Briefly about the basic syntax of Rust</a> for those who are already well programmed </li><li>  <a href="https://doc.rust-lang.org/book/second-edition/">The official tutorial on Rust</a> in angelic ( <a href="https://github.com/ruRust/rust_book_2ed">Russian version</a> is not yet ready - you can help with the translation) </li><li>  <a href="https://web.stanford.edu/class/cs140e/notes/lec2/paper.pdf">Rusty Types for Solid Safety</a> </li><li>  <a href="https://habrahabr.ru/post/322140/">Cheat Sheet by Liftaim in Rust</a> </li><li>  <a href="https://docs.google.com/presentation/d/1q-c7UAyrUlM-eZyTo1pd8SZ0qwA_wYxmPZVOQkoDmH4/present%3Ftoken%3DAC4w5VgEyYo5AyyCd0GYMh-mP8O3hNlQQA%253A1518749570893%26amp%3Bincludes_info_params%3D1">Cheat Sheet on Rust Containers</a> (blue text is clickable) </li></ul><br><h2 id="faza-0-nachalo-raboty">  Phase 0: Getting Started </h2><br><p>  Before completing the course, you should get yourself a unix-like operating system for your immediate use.  It can be Linux, BSD or macOS with <code>git</code> , <code>wget</code> , <code>tar</code> , <code>screen</code> and <code>make</code> installed.  Theoretically, it can work in Windows 10 with the linux subsystem, but no one has verified for sure.  At least this configuration is not supported.  Those.  There are no ready-made recipes for Windows and it is recommended to install <a href="https://www.ubuntu.com/download/desktop">Ubuntu LST</a> or <a href="https://getfedora.org/en/workstation/download/">Fedora</a> . </p><br><div style="text-align:center;"><img title="The choice is obvious.  Or not?" src="https://habrastorage.org/webt/-w/hd/y2/-whdy2veleyhwxy-xy-8sshf7kk.jpeg"></div><br><p>  From iron we will need: </p><br><ul><li>  Raspberry Pi 3 model B (required with BCM2837 process) </li><li>  Development board, it‚Äôs also a prototyping board </li><li>  microSD card (plus adapter / adapter) </li><li>  USB-UART adapter (CP2102 USB TTL) </li><li>  A dozen multi-color LEDs </li><li>  Resistors for 100 ohms and 1 kOhm four each </li><li>  wiring </li></ul><br><p>  In the discussion on reddit there are <a href="https://www.reddit.com/r/cs140e/comments/7ql4fw/info_general_discussion/dsq6uhz/">references</a> on amazon with what may be required.  However, all this can be bought in any other store.  Including offline.  In addition, all you can buy more any components to your taste. </p><br><p>  <strong>Caution</strong> : Malinka is electrostatically sensitive.  Try not to touch the contacts with your bare hands.  You will not be killed by a current or even scratched, but Malinka itself may be completely incapacitated.  Ground yourself. </p><br><p>  When all this is available, you can tighten the job code: </p><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://web.stanford.edu/class/cs140e/assignments/0-blinky/skeleton.git 0-blinky <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> assignment0 make fetch</code> </pre> <br><p>  Feel free to explore the content yourself. </p><br><h2 id="faza-1-gotovim-malinku">  Phase 1: Cooking Raspberries </h2><br><img title="CP2102 USB Module" width="240" align="right" src="https://habrastorage.org/webt/wt/qe/f_/wtqef_oktbiqrox9rfgs_xlehc4.jpeg"><br><p>  The first thing we need to do is configure the CP2102 adapter.  It is needed for communication between a computer and Pi.  In addition to this, the raspberry gets through it the vital 5 volts.  On the one hand there is USB, on the other there are five pins, in the middle of the handkerchief. </p><br><h3 id="nastroyka-drayverov">  Driver setup </h3><br><p>  On Linux, everything should work right out of the box.  You need to install a driver on Macs.  Download <a href="">this archive</a> and unpack.  We start <code>SiLabsUSBDriverDisk.dmg</code> and agree with the points on the sale of the soul under a license.  After that, on the mounted volume, launch <code>Silicon Labs VPC Driver.pkg</code> .  Install and reboot. </p><br><p>  Try inserting the CP2102 into a free USB slot.  If everything works, the corresponding files should appear in <code>/dev</code> .  In the case of poppy <code>/dev/tty.SLAB_USBtoUART</code> .  In the case of Linux, something like <code>/dev/ttyUSB0</code> .  Write it down - useful.  Take out the adapter. </p><br><h3 id="podklyuchenie-malinki">  Connect raspberry </h3><br><p>  Now connect the Raspberry Pi to the CP2102.  Here is the connector mapping table: </p><br><table><thead><tr><th>  CP2102 connectors </th><th>  Raspberry Pi connectors </th></tr></thead><tbody><tr><td>  + 5v </td><td>  four </td></tr><tr><td>  GND </td><td>  6 </td></tr><tr><td>  Rxd </td><td>  eight </td></tr><tr><td>  Txd </td><td>  ten </td></tr></tbody></table><br><p>  Numbering of pins on the raspberry (still there is <a href="https://pinout.xyz/">an interactive</a> version): </p><br><img title="Pinout raspberry" width="500" src="https://habrastorage.org/getpro/habr/post_images/a5f/0e8/151/a5f0e81510ebb7cb27b18f9c6ac50863.svg"><br><p>  All together it will look like this (the colors of the wires can be chosen arbitrarily): </p><br><img title="Connection adapter" width="500" src="https://habrastorage.org/webt/dw/g6/xr/dwg6xrgielletzhzajmwcoijbis.png"><br><img align="right" width="200" src="https://habrastorage.org/webt/sy/9s/_e/sy9s_ete3dbxqvcixjmukbr7_cs.gif"><br><p>  <strong>Important</strong> : check and recheck the connections before connecting all this to the computer.  We need fresh raspberry, not burnt jam. </p><br><p>  If there is confidence in the correctness of pairing the raspberry and adapter - you can still connect the CP2102 to the computer. </p><br><h3 id="zapusk">  Launch </h3><br><p>  Raspberry Pi loads programs from a microSD card during power up.  Right now we will figure out how to cook it. </p><br><p>  First of all, we need to drop files from the cloned repository onto the microSD box.  Namely, those that are in the <code>files/firmware</code> folder.  Those.  <code>bootcode.bin</code> , <code>config.txt</code> and <code>start.elf</code> .  Copy them to the root of the flash card.  If suddenly there are no these files in the repository repository - you forgot about <code>make fetch</code> . </p><br><blockquote>  <strong>Why do we need <code>bootcode.bin</code> , <code>config.txt</code> and <code>start.elf</code> ?</strong> <br>  This is all a bootloader for the raspberry.  <code>bootcode.bin</code> is the first boot loader.  His task is to load <code>start.elf</code> .  Which configures the processor in accordance with the contents of the <code>config.txt</code> file.  After that, it loads <code>kernel8.img</code> and passes control to it.  By the way where is he? </blockquote><p>  Now copy the <code>files/activity-led-blink.bin</code> from the repo to the root of the flash card and give this file the name <code>kernel8.img</code> .  Unmount the card and pull out.  Make sure that the raspberry is disabled.  Then we insert the card into the raspberry and connect the raspberry to the power supply.  We should see a flashing LED on the raspberry and on the CP2102 adapter.  Blinking of the latter means that some data is being transferred there. </p><br><p>  Data?  What data?  In order to see them, we need to connect a serial terminal emulator to the CP2102 and read what is happening there.  We will use the <a href="https://www.gnu.org/software/screen/manual/screen.html">screen</a> for it is installed on both Linux and macOS.  Remember the device path from the <code>/dev</code> folder and run </p><br><pre> <code class="bash hljs">screen /dev/&lt;&gt; 115200</code> </pre> <br><p>  On Linux, you may need to use <code>sudo</code> to run this command.  However, you can add your user to the <code>dialout</code> group and not constantly write to this <code>sudo</code> command: </p><br><pre> <code class="bash hljs">sudo gpasswd --add &lt;-&gt; dialout</code> </pre> <br><p>  One way or another, but we should see greetings from the raspberry.  To exit the <code>screen</code> , press <code>&lt;ctrl-a&gt; k</code> , and then answer <code>y</code> to the exit prompt. </p><br><h2 id="faza-2-migaem-svetodiodom">  Phase 2: LED flashing </h2><br><p>  At this stage we will connect the 16th pin of the GPIO (physical contact No. 36) of the raspberry to the LED on the breadboard.  Check out his work using a pre-prepared binary with firmware.  Make sure the raspberry is disabled. </p><br><h3 id="gpio-general-purpose-io-vvod-vyvod-obschego-naznacheniya">  GPIO: General Purpose I / O (General Purpose I / O) </h3><br><p>  As the name implies, GPIO is a common mechanism for transferring data / signals between any two devices through electrical contacts. </p><br><p>  The GPIO pins on the malinka can work as <em>inputs</em> or as <em>outputs</em> .  When a contact is a <em>holiday</em> , it can be turned on or off.  The inclusion of a contact means that you can take 3.3 volts from it.  By turning off, it means that there is no current through this contact.  When the GPIO-contact is <em>input</em> , the Malinka checks whether there are 3.3 volts on it, or not. </p><br><p>  These contacts are incredibly, breathtakingly versatile and can be used to implement a huge range of different functions.  Details can be found in the <a href="">documentation</a> .  Documentation is not just attached.  It is possible, and sometimes necessary, to read along the course. </p><br><h3 id="podklyuchenie-svetodioda">  LED connection. </h3><br><p>  Let's start with the construction of such a scheme: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/abf/d98/6fc/abfd986fc5ccfe911b3d6c57e43310f8.svg" alt="LED on the constant"></p><br><p>  If you have never used a breadboard, then it is recommended to read (or at least see the pictures) <a href="https://learn.sparkfun.com/tutorials/how-to-use-a-breadboard">here in this guide</a> .  In our scheme, we connect the LED to the contact 3.3 volts (pin number 1) and to the contact with zero potential (number 14).  Pay attention to the correct connection of the LED.  His shorter leg must be connected through a resistor to pin 14 (zero potential, or ground differently).  After that, you can connect the malinka to the power.  The LED will be on (if everything is connected correctly).  If you turn the LED, it simply will not light up.  He is finally the same <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D0%25BE%25D0%25B4">diode</a> as any of his friends. </p><br><p>  If everything worked with a uniformly lit LED, then you can try to blink it.  Cut off the raspberry from food.  Now we reconnect the LED from pin 1 to pin 36 (GPIO 16) like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3f8/bbb/f99/3f8bbbf993a0d50805f54fa6e42df95f.svg" alt="LED flashing circuit"></p><br><p>  Again, remove the memory card.  Copy <code>files/gpio16-blink.bin</code> with the name <code>kernel8.img</code> instead of the old one with the same name.  Put the card back and connect the malinka to the power supply.  Now the LED should blink uncontrollably. </p><br><h2 id="faza-3-nyashnyy-si">  Phase 3: Nice Si </h2><br><p>  This time we will be writing a prog, which will do the same as <code>gpio16-blink.bin</code> .  In order to be able to compile the nude sishechka under the raspberry we need a cross-compiler under <code>aarch64-none-elf</code> . </p><br><h3 id="ustanovka-kross-kompilyatora">  Cross-compiler installation </h3><br><p>  We need to install a GNU toolchain for the <code>aarch64-none-elf</code> architecture (the gcc compiler and its company are like objcopy). </p><br><h4 id="pod-macos">  Under macOS </h4><br><p>  First you need to install the <a href="https://brew.sh/">homebrew</a> package manager.  If already installed, then this part can be skipped. </p><br><ol><li>  Install the Xcode tools for the command line.  A dialog box will appear.  When it appears - click on "Install", "Continue" or whatever it usually is. <br><pre> <code class="hljs pgsql">xcode-<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-comment"><span class="hljs-comment">--install</span></span></code> </pre> </li><li>  Run the Homebrew installation script.  It will guide you through the rest of the installation process. <br><pre> <code class="hljs sql">/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/<span class="hljs-keyword"><span class="hljs-keyword">install</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">master</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">install</span></span>)<span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre> </li></ol><br><p>  Now install the aarch64-none-elf toolchain using homebrew. </p><br><pre> <code class="hljs sql">brew tap SergioBenitez/osxct brew <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> aarch64-<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>-elf</code> </pre> <br><p>  Check whether everything is correctly installed: </p><br><pre> <code class="hljs vbscript">$ aarch64-none-elf-gcc --version aarch64-none-elf-gcc (GCC) <span class="hljs-number"><span class="hljs-number">7.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Copyright (C) <span class="hljs-number"><span class="hljs-number">2017</span></span> Free Software Foundation, Inc. This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> free software; see the source <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> copying conditions. There <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NO warranty; <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> even <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MERCHANTABILITY <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> FITNESS <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> A PARTICULAR PURPOSE.</code> </pre> <br><h4 id="pod-linux">  Under linux </h4><br><ol><li>  Download and unzip <a href="">aarch64-none-elf-linux-x64.tar.gz</a> .  After that move <code>arch64-none-elf</code> to <code>/usr/local/bin</code> : <br><pre> <code class="hljs pgsql">wget https://web.stanford.edu/<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>/cs140e/files/aarch64-<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>-elf-linux-x64.tar.gz tar -xzvf aarch64-<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>-elf-linux-x64.tar.gz sudo mv aarch64-<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>-elf /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin</code> </pre> </li><li>  Add <code>/usr/local/bin/aarch64-none-elf/bin</code> to the PATH environment variable.  How exactly - it depends on your particular Linux distribution.  In most cases, you should add the following to <code>~/.profile</code> : <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">PATH</span></span>="/usr/local/bin/aarch64-none-elf/bin:$PATH"</code> </pre> </li><li>  Check if everything is normal.  As output, we have to get the gcc version and all that. <br><pre> <code class="hljs pgsql">aarch64-<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>-elf-gcc <span class="hljs-comment"><span class="hljs-comment">--version</span></span></code> </pre> </li></ol><br><p>  You can build yourself from the source if such a desire arises.  Read more <a href="https://wiki.osdev.org/GCC_Cross-Compiler">here</a> . </p><br><h3 id="teper-nemnogo-o-zheleze">  Now a little about iron </h3><br><p>  The interaction of the vast majority of modern hardware devices with software is carried out through its mapping into memory <a href="https://en.wikipedia.org/wiki/Memory-mapped_I/O">Memory-mapped I / O.</a>  The bottom line is this: you can communicate with devices as if it were just some part of the memory.  This provides a specification of what will happen when you write or read certain addresses in memory.  Addresses are usually divided into pieces of 32 or 64 bits, which are called registers.  Registers can only be read from, written to, or both. </p><br><p>  How do we know which registers and what to use, and where are they in memory?  Manufacturers of various devices write documentation for these devices.  Usually they are called datasheets (data sheet), manuals (device manual), well, or just documentation.  There is no common widespread format for documenting devices.  Sometimes the documentation may be insufficient or it may not be at all.  The ability to read and understand the hardware documentation is quite a useful skill, and in some ways even art. </p><br><h3 id="interfeys-gpio-v-pamyati">  GPIO interface in memory </h3><br><p>  Documentation for many of the peripherals that the Rasbperry Pi has can be found in <a href="https://web.stanford.edu/class/cs140e/docs/BCM2837-ARM-Peripherals.pdf">BCM2837 ARM Peripherals Manual</a> .  About GPIO can be read on page 89. </p><br><blockquote>  <strong>Pajazhi, in the same place about BCM2835, and we have BCM2837.</strong>  <strong>Is that normal?</strong> <br><br>  If you open the manual, then there can be seen in many places mentioning BCM2835.  We just took a guide to it and corrected some errors.  Well, the title was changed to BCM2837.  BCM2837 and BCM2835 have the same peripheral devices with the same <em>relative</em> addresses in memory.  The main difference in the overall configuration of physical memory.  The base <em>physical</em> address of the peripherals on the BCM2837 is <code>0x3F000000</code> , as opposed to <code>0x20000000</code> in the BCM2835.  However, both chips display these addresses at <code>0x7E000000</code> .  Briefly on the BCM2837, the "peripheral" address <code>0x7EXXXXXX</code> will be located at the physical address <code>0x3FXXXXXX</code> .  This documentation has been modified to reflect this. </blockquote><p>  For our task, the following registers are enough for us: </p><br><table><thead><tr><th>  name </th><th>  address </th><th>  description </th><th>  the size </th><th>  read / write </th></tr></thead><tbody><tr><td>  GPFSEL1 </td><td>  0x7E200004 </td><td>  GPIO Function Select 1 </td><td>  32 bits </td><td>  both </td></tr><tr><td>  GPSET0 </td><td>  0x7E20001C </td><td>  GPIO Pin Output Set 0 </td><td>  32 bits </td><td>  only record </td></tr><tr><td>  GPCLR0 </td><td>  0x7E200028 </td><td>  GPIO Pin Output Clear 0 </td><td>  32 bits </td><td>  only record </td></tr></tbody></table><br><p>  This is directly copied directly from the documentation on page 90. </p><br><p>  Now read the documentation for the <code>GPFSELn</code> register on pages 91 and 92. We write to this register to configure the pins as output or input.  What should be the value in each field of the register <code>GPFSEL1</code> to configure the output number 16 GPIO, so that it becomes an output? </p><br><p>  Now, again, read the documentation on page 95. About the registers <code>GPSET0</code> and <code>GPCLR0</code> .  We write to the <code>GPSET0</code> register to enable the contact.  And in <code>GPCLR0</code> for shutdown.  What value do we need to write to these registers to enable / disable pin 16? </p><br><h3 id="napisanie-koda">  Code writing </h3><br><p>  In the <code>phase3/</code> turnips directory there is a procurement code for building a binary file for Malinka.  For now, we can do without explaining why we need <code>crt0.S</code> , <code>layout.ld</code> and <code>Makefile</code> .  Instead, focus on <code>blinky.c</code> .  In it you will find that the addresses of all three registers we need at the top are already indicated.  In addition, there are a couple of functions that can create a time delay.  The task is to supplement the <code>main</code> function so that pin 16 of the GPIO is configured as an output, and then it turns on and then turns off to flash with a LED. </p><br><p>  When the code is ready - it should be tested.  First, compile it by running <code>make</code> , being in the <code>phase3/</code> directory.  If everything is good and there are no errors, then the blinky.bin <code>blinky.bin</code> will be <code>blinky.bin</code> .  Rename it to <code>kernel8.img</code> , copy it to a microSD card and run it all on a raspberry.  If you already have a working <code>kernel8.img</code> , you can proceed to the next phase. </p><br><blockquote>  Tips: <br><br>  Setting / on / off pins can be implemented in a single line of code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here operators <code>&lt;&lt;</code> , <code>|</code>  , <code>&amp;</code> and <code>~</code> . <br><br>  Hex and binary forms can be used in sishechke.  For the number three, something like <code>0x03</code> and <code>0b011</code> respectively. </blockquote><br><h2 id="faza-4-rzhavchina">  Phase 4: Rust </h2><br><p>  This time we will be writing a program like <code>gpio16-blink.bin</code> , but already in Rust.  The code is written in <code>phase4/src/lib.rs</code> </p><br><h3 id="ustanovka-rust-i-xargo">  Install Rust and Xargo </h3><br><p>  In order to compile programs on Rust, we should install this compiler.  In addition, we will install <code>xargo</code> , which is a wrapper associated with the package manager <code>cargo</code> .  Xargo allows us to compile our code for Rasbperry Pi and all that. </p><br><ol><li>  We go to <a href="https://rustup.rs/"></a>  <a href="https://rustup.rs/">https://rustup.rs/</a> and follow the instructions for installing <code>rustup</code> .  Verify that Rust was installed correctly by running <code>rustc --version</code> . </li><li>  Now use <code>rustup</code> and <code>cargo</code> (which was installed with rustc in the last step) to install the Rust night assembly.  At the same time and install the source code of the standard library.  And <code>xargo</code> course. <br><pre> <code class="hljs cs">rustup <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> nightly<span class="hljs-number"><span class="hljs-number">-2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span> rustup component <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rust-src cargo install xargo</code> </pre> </li><li>  We check the installed commands and make sure that the versions of all this correspond to what we want from them: <br><pre> <code class="hljs ruby">$ rustc --version rustc <span class="hljs-number"><span class="hljs-number">1.25</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-nightly (b5392f545 <span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-08) $ xargo --version xargo <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3.10</span></span> cargo <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">25.0</span></span>-nightly (a88fbace4 <span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">29</span></span>)</code> </pre> </li></ol><br><p>  Now we have quite a working compiler Rust. </p><br><h3 id="napisanie-koda-1">  Code writing </h3><br><p>  To write code in the file <code>phase4/src/lib.rs</code> you need to know at least the following constructs: </p><br><p>  1) You can read from and write to what is behind the bare pointers ( <code>*mut T</code> ) using the <code>read_volatile()</code> and <code>write_volatile()</code> methods.  For example, we have declared this: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> A: *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> = <span class="hljs-number"><span class="hljs-number">0x12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> B: *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> = <span class="hljs-number"><span class="hljs-number">0x34</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>;</code> </pre> <br><p>  We can write a 32-bit unsigned integer with the address <code>0x12</code> into the cell with the address <code>0x34</code> like this: </p><br><pre> <code class="rust hljs">B.write_volatile(A.read_volatile());</code> </pre> <br><p>  2) Local variables are declared using the <code>let _ = _;</code>  . <br>  You can read <code>A</code> from the previous example (i.e. the value located at address <code>0x12</code> ) into a variable like this: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> value = A.read_volatile();</code> </pre> <br><p>  3) Call the function <code>fn f(param: usize);</code>  can be like this: <code>f(123);</code>  . <br>  4) The <code>loop</code> block can be used to repeat infinitely something: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> { do_this_again_and_again(); }</code> </pre> <br><p>  5) Rust has the following bitwise operators: </p><br><ul><li> <code>!</code>  - inversion </li><li>  <code>&lt;&lt;</code> - left shift </li><li>  <code>&gt;&gt;</code> - right shift </li><li> <code>|</code>  - bit OR </li><li>  <code>&amp;</code> - bit I. </li></ul><br><p>  Now you are ready to flash the LED from the code on Rust.  The code is written in <code>phase4/src/lib.rs</code>  Translate the code into a similar rust code (in the <code>kmain</code> function).  There are already announced the necessary registers and the function of "sleep", which creates a delay for some time.  Use it all. </p><br><p>  When you are ready to test your program, compile it by running <code>make</code> in the <code>phase4</code> directory.  If everything is fine, then the file <code>build/blinky.bin</code> will be created, which we rename to <code>kernel8.img</code> and put it on the microSD card, which we then insert into the raspberry.  When the LED flashes again, we can assume that this part of the tutorial is complete. </p><br><p>  <strong>UPD</strong> <a href="https://habrahabr.ru/post/351082/">Next series</a> </p></div><p>Source: <a href="https://habr.com/ru/post/349248/">https://habr.com/ru/post/349248/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349234/index.html">Security Week 4: Bots for GTA fans, malicious addons for Chrome with Yandex technologies</a></li>
<li><a href="../349236/index.html">Measuring and shaping the frequency characteristics of electric guitars</a></li>
<li><a href="../349238/index.html">My remarks on the book by L.P. Plekhanov "Fundamentals of self-timed electronic circuits"</a></li>
<li><a href="../349242/index.html">Monitoring IT Performance with Splunk IT Service Intelligence</a></li>
<li><a href="../349246/index.html">Bro, why do we need a business? Let's trade in brooms. After all, they are used in every yard</a></li>
<li><a href="../349250/index.html">Using the Hi / Lo algorithm to generate keys in the Entity Framework Core</a></li>
<li><a href="../349252/index.html">Release Rust 1.24</a></li>
<li><a href="../349254/index.html">ITSM literacy program: Users and Customers - who is behind these names?</a></li>
<li><a href="../349256/index.html">Journal of the work with the network. Part 2</a></li>
<li><a href="../349260/index.html">Is it a bird? This is a plane? No, this is your user's token flying to a new phone.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>