<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to parallel computing in R</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is devoted to the language of R. It is not as widespread on the ex-USSR territory as Matlab and especially Python, but it certainly deser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to parallel computing in R</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/d26/405/bde/d26405bde6a5edca7f75eccd0bf9d2d6.jpg">  This article is devoted to the <a href="http://www.r-project.org/">language of R.</a>  It is not as widespread on the ex-USSR territory as Matlab and especially Python, but it certainly deserves attention.  It should be noted that R is actually a standard for Data Science (although it is well written <a href="http://www.r-bloggers.com/python-vs-r-vs-spss-cant-all-programmers-just-get-along/">here</a> that data scientists do not live by a single R).  The rich syntax, compatibility with legacy code (which is very important in scientific applications), the convenient RStudio development environment and the presence of a huge number of libraries in CRAN make R such. <br><a name="habracut"></a><br>  But, as always, the flip side of the coin (or rather, the interpreter R) is the <a href="http://www.r-bloggers.com/how-slow-is-r-really/">speed of calculations</a> .  R supports vectorized calculations ‚Äî <a href="http://stackoverflow.com/questions/3505701/r-grouping-functions-sapply-vs-lapply-vs-apply-vs-tapply-vs-by-vs-aggrega">the apply family of functions</a> allows you to avoid using loops.  But this is, in general, syntactic sugar, and often the effect of "acceleration" from using * apply is still negative.  Against this background, a completely logical step (if we do not consider the transition to lower level languages) looks like parallelization of calculations.  It is no secret that the code is difficult to follow this procedure. <br><br>  Further work will require two packages - ‚Äúforeach‚Äù (allows the use of the foreach construct) and ‚ÄúdoSNOW‚Äù (provides support for parallel computing).  From CRAN you can install them like this: <br><pre><code class="hljs swift">install.packages(<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>(<span class="hljs-string"><span class="hljs-string">"foreach"</span></span>,<span class="hljs-string"><span class="hljs-string">"doSNOW"</span></span>))</code> </pre> <br><br>  The following commands - preparation of the "cluster" of the three processor cores to work: <br><pre> <code class="hljs lisp">library(<span class="hljs-name"><span class="hljs-name">foreach</span></span>) library(<span class="hljs-name"><span class="hljs-name">doSNOW</span></span>) cluster &lt;- makeCluster(<span class="hljs-number"><span class="hljs-number">3</span></span>, type = <span class="hljs-string"><span class="hljs-string">"SOCK"</span></span>, outfile=<span class="hljs-string"><span class="hljs-string">""</span></span>) registerDoSNOW(<span class="hljs-name"><span class="hljs-name">cluster</span></span>)</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider an example where the sum of squares of numbers from 1 to 10,000 is calculated: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.time ({ sum.par &lt;- <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(i=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10000</span></span>, .combine=<span class="hljs-string"><span class="hljs-string">'+'</span></span>) %dopar% { i^<span class="hljs-number"><span class="hljs-number">2</span></span> }})</code> </pre><br>  In principle, everything is very similar to a normal cycle, except that you need to specify how to group the results ‚Äî in this case, the addition operation (and often these are the functions c, rbind, cbind ‚Äî or a handwritten function).  If it does not matter in which order to group, then using the argument .inorder = F allows to speed up the calculations somewhat.  If the% do% directive is used instead of% dopar%, then the calculations will be performed sequentially (that is, as in a normal loop).  By the way, for such a simple task the execution time in the sequential version will be noticeably less, since  invoices for data manipulation in a parallel version are far from the last place in the balance sheet. <br><br>  Let's move on to a more difficult task.  Suppose we have a vector of random variables <b>x</b> . <br><img src="http://habrastorage.org/storage3/cd1/ddf/bc9/cd1ddfbc9256c2865ebb02f2604f0f64.png"><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">trials </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">10000</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">n</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">24000</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">alfa</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1.6</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">beta</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">set.seed</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rgamma</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">n</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">alfa,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">scale</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">beta),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rgamma</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">n</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">3*alfa,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">scale</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4*beta),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rgamma</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">n</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">10*alfa,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">scale</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">3*beta))</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">plot</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">density</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernel</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"cosine"</span></span></span></span><span class="xml"><span class="hljs-tag">),</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lwd</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">2,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">col</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"blue"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xlab</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"x"</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ylab</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"Density"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"Density plot"</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">abline</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">v</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">median(x),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">col</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"red"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lty</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">5)</span></span></span></span></span></span></code> </pre><br></div></div><br><br>  Estimate the median - indicating the confidence intervals.  For this, we apply <a href="https://en.wikipedia.org/wiki/Bootstrapping_%2528statistics%2529">bootstrap</a> and measure the execution time for serial and parallel code, respectively: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span>.seed(<span class="hljs-number"><span class="hljs-number">1</span></span>) seq.time &lt;- <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.time({ seq.medians &lt;- <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(icount(trials), .combine=cbind) %<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>% { median(sample(x, replace = T)) } })</code> </pre><br><pre> <code class="hljs css">&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">quantile</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">seq</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.medians</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span>(<span class="hljs-selector-class"><span class="hljs-selector-class">.025</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.975</span></span>)) 2<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span>% 97<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span>% 52<span class="hljs-selector-class"><span class="hljs-selector-class">.56311</span></span> 54<span class="hljs-selector-class"><span class="hljs-selector-class">.99636</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">system</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">elapsed</span></span> 19<span class="hljs-selector-class"><span class="hljs-selector-class">.884</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.252</span></span> 20<span class="hljs-selector-class"><span class="hljs-selector-class">.138</span></span></code> </pre><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span>.seed(<span class="hljs-number"><span class="hljs-number">1</span></span>) par.time &lt;- <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.time({ par.medians &lt;- <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(icount(trials), .combine=cbind) %dopar% { median(sample(x, replace = T)) } })</code> </pre><br><pre> <code class="hljs css">&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">quantile</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">par</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.medians</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span>(<span class="hljs-selector-class"><span class="hljs-selector-class">.025</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.975</span></span>)) 2<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span>% 97<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span>% 52<span class="hljs-selector-class"><span class="hljs-selector-class">.56257</span></span> 54<span class="hljs-selector-class"><span class="hljs-selector-class">.94890</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">par</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">system</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">elapsed</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.252</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.420</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.893</span></span></code> </pre><br>  The difference is quite palpable.  Let us estimate the run time of the sequential ‚Äúvectorized‚Äù version for the same task (using the apply function): <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span>.seed(<span class="hljs-number"><span class="hljs-number">1</span></span>) seq.time.ap &lt;- <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.time({ seq.medians.ap &lt;- apply(matrix(sample(x, trials*n, replace = T), trials, n), <span class="hljs-number"><span class="hljs-number">1</span></span>, median) })</code> </pre><br><pre> <code class="hljs css">&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">quantile</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">seq</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.medians</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ap</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span>(<span class="hljs-selector-class"><span class="hljs-selector-class">.025</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.975</span></span>)) 2<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span>% 97<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span>% 52<span class="hljs-selector-class"><span class="hljs-selector-class">.56284</span></span> 54<span class="hljs-selector-class"><span class="hljs-selector-class">.98266</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.time</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">system</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">elapsed</span></span> 23<span class="hljs-selector-class"><span class="hljs-selector-class">.732</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.728</span></span> 25<span class="hljs-selector-class"><span class="hljs-selector-class">.472</span></span></code> </pre><br><br>  A similar approach can be used to determine the parameters of machine learning algorithms.  For example, in the ‚ÄúRSNNS‚Äù package there are functions for training <a href="https://ru.wikipedia.org/wiki/%25D0%259D%25D0%25B5%25D0%25B9%25D1%2580%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D0%25B5%25D1%2582%25D1%258C_%25D0%25AD%25D0%25BB%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B0">the Elman network</a> (as far as I know, in R, in general, there are no other packages for working with recurrent networks).  The choice of the number of neurons and the speed of learning is quite a resource-intensive task, therefore there is a sense in parallelization. <br>  Let's move from spherical examples to a more pressing problem.  To do this, install two packages: <br><pre> <code class="hljs swift">install.packages(<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>(<span class="hljs-string"><span class="hljs-string">"ElemStatLearn"</span></span>,<span class="hljs-string"><span class="hljs-string">"RSNNS"</span></span>))</code> </pre><br>  From the ElemStatLearn package, we need two data sets, zip.train and zip.test, which contain compressed (gzipped) images of handwritten numbers.  The datasets are quite voluminous, so we take only a part of them: respectively, for network training, validation and testing. <br><img src="http://habrastorage.org/storage3/d40/d68/125/d40d681257396009b0aeaecd9a123e79.png"><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs swift">library(<span class="hljs-string"><span class="hljs-string">"ElemStatLearn"</span></span>) library(<span class="hljs-type"><span class="hljs-type">RSNNS</span></span>) data(<span class="hljs-built_in"><span class="hljs-built_in">zip</span></span>.train) data(<span class="hljs-built_in"><span class="hljs-built_in">zip</span></span>.test) image(zip2image(<span class="hljs-built_in"><span class="hljs-built_in">zip</span></span>.train, <span class="hljs-number"><span class="hljs-number">1000</span></span>), col=gray(<span class="hljs-number"><span class="hljs-number">255</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">255</span></span>)) train &lt;- <span class="hljs-built_in"><span class="hljs-built_in">zip</span></span>.train[<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>,-<span class="hljs-number"><span class="hljs-number">1</span></span>] trainC &lt;- decodeClassLabels(<span class="hljs-built_in"><span class="hljs-built_in">zip</span></span>.train[<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>]) valid &lt;- <span class="hljs-built_in"><span class="hljs-built_in">zip</span></span>.train[<span class="hljs-number"><span class="hljs-number">1001</span></span>:<span class="hljs-number"><span class="hljs-number">1200</span></span>,-<span class="hljs-number"><span class="hljs-number">1</span></span>] validC &lt;- <span class="hljs-built_in"><span class="hljs-built_in">zip</span></span>.train[<span class="hljs-number"><span class="hljs-number">1001</span></span>:<span class="hljs-number"><span class="hljs-number">1200</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>] test &lt;- <span class="hljs-built_in"><span class="hljs-built_in">zip</span></span>.test[<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>,-<span class="hljs-number"><span class="hljs-number">1</span></span>] testC &lt;- <span class="hljs-built_in"><span class="hljs-built_in">zip</span></span>.test[<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>]</code> </pre><br></div></div><br><br>  Before teaching several networks in parallel, we need to consider what we want to receive.  Suppose we are interested in two parameters of the neural network - the number of neurons in the hidden layer and the speed of learning, and we want to choose their more or less optimal values.  This means that the work will result in <a href="http://stat.ethz.ch/R-manual/R-patched/library/base/html/data.frame.html">a data frame</a> containing three numbers - the number of neurons, the learning rate and the error, on the basis of which we will determine the optimality of the parameters.  Earlier, I mentioned a function that grouped the results of a parallel loop.  In the case of data that has a more complex structure than the vector, such a function will have to write itself. <br><pre> <code class="hljs vbscript">comb &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(df1, df2) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (df1$<span class="hljs-built_in"><span class="hljs-built_in">err</span></span> &lt; df2$<span class="hljs-built_in"><span class="hljs-built_in">err</span></span>) df1 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> df2</code> </pre> <br>  As can be seen from the code, the function compares the err field of two data frames and selects the one where the error is less.  Below is a fragment of the script that provides network training in parallel mode.  We start it and for some time we admire 100% loading of three cores. <br><img src="http://habrastorage.org/storage3/ca4/400/449/ca4400449daa8fb91f0a276b3973fea2.png"><br><br><pre> <code class="hljs pgsql">errCl &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (predicted, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(round(sum(predicted != <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)/length(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>), <span class="hljs-number"><span class="hljs-number">4</span></span>)) } size &lt;- c(<span class="hljs-number"><span class="hljs-number">13</span></span>,<span class="hljs-number"><span class="hljs-number">29</span></span>,<span class="hljs-number"><span class="hljs-number">53</span></span>,<span class="hljs-number"><span class="hljs-number">71</span></span>) lr &lt;- c(<span class="hljs-number"><span class="hljs-number">.001</span></span>,<span class="hljs-number"><span class="hljs-number">.01</span></span>,<span class="hljs-number"><span class="hljs-number">.1</span></span>,<span class="hljs-number"><span class="hljs-number">.5</span></span>) nn.time &lt;- <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.time({ elm_par &lt;- <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(s=size, .combine=<span class="hljs-string"><span class="hljs-string">'comb'</span></span>) %:% <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(r=lr, .packages=<span class="hljs-string"><span class="hljs-string">'RSNNS'</span></span>, .combine=<span class="hljs-string"><span class="hljs-string">'comb'</span></span>, .inorder=F) %dopar% { elm &lt;- elman(x=train, y=trainC, size=s, learnFunc="JE_BP", learnFuncParams=r, linOut=F, maxit=<span class="hljs-number"><span class="hljs-number">193</span></span>) pred &lt;- max.col(predict(elm, <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>)) - <span class="hljs-number"><span class="hljs-number">1</span></span> e &lt;- errCl(pred, validC) data.frame(opt_size=s, lrate=r, err=e) } })</code> </pre><br>  The errCl function is used to determine the classification error.  The size and lr vectors contain, respectively, the number of neurons in the hidden layer of the network and the speed of network learning.  Notice how the nested loop is organized using the <code>%:%</code> instruction.  Actually, if you don‚Äôt go into details, the body of the cycle happens what is usually done when choosing parameters: the model is trained in a training data set, then a validating data set is used, a classification error is selected and those parameters are chosen for which the error is smaller.  I got the same result: <br><pre> <code class="hljs css">&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">elm_par</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">opt_size</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lrate</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">err</span></span> 1 29 0<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.05</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">nn</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">system</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">elapsed</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.312</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span> 179<span class="hljs-selector-class"><span class="hljs-selector-class">.542</span></span></code> </pre><br>  Although, of course, do not deceive yourself with an error of 5%.  Check our network with 29 neurons and a learning rate of 0.5 on the test set: <br><pre> <code class="hljs django"><span class="xml"><span class="xml">elm </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">elman</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">train,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">trainC,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">29,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">learnFunc</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"JE_BP"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">learnFuncParams</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0.5,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">linOut</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">F,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">maxit</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">193)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pred</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">max.col</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predict</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">elm</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">test</span></span></span></span><span class="xml"><span class="hljs-tag">)) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">e</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">errCl</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pred</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">testC</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span></span></span></code> </pre><br><pre> <code class="hljs css">&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">e</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.119</span></span></code> </pre><br>  Well, 11.9% is also quite good.  Now it remains for the small - to "pay off" the cluster <br><pre> <code class="hljs lisp">stopCluster(<span class="hljs-name"><span class="hljs-name">cluster</span></span>)</code> </pre> <br><h3>  Instead of conclusion </h3><br>  R is a very convenient and cunning language.  Getting used to it - and especially to the variety of packages in CRAN - it is difficult to switch to something else.  But, of course, each language has its own niche.  For R, this is statistics and data analysis.  And although R can be quite unhurried, for many tasks its performance is enough. <br><br><h5>  Literature </h5><br>  <a href="http://cran.r-project.org/web/views/HighPerformanceComputing.html">High Performance and Parallel Computing with R</a> <br>  <a href="http://cran.r-project.org/web/packages/foreach/vignettes/nested.pdf">Nesting Foreach Loops</a> <br>  <a href="http://cran.r-project.org/web/packages/RSNNS/RSNNS.pdf">RSNNS Package</a> </div><p>Source: <a href="https://habr.com/ru/post/206892/">https://habr.com/ru/post/206892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206876/index.html">Asterisk 12 released</a></li>
<li><a href="../206880/index.html">TV on the Internet</a></li>
<li><a href="../206884/index.html">Alpha Mio - wrist heart rate monitor without chest strap</a></li>
<li><a href="../206886/index.html">Dozen design jambs</a></li>
<li><a href="../206888/index.html">Integration of Symfony2 authentication and Jira tracker</a></li>
<li><a href="../206894/index.html">Tree list on ASP.NET MVC 4</a></li>
<li><a href="../206896/index.html">All that merge: ribosomal software architecture</a></li>
<li><a href="../206898/index.html">Backing up web projects on Yandex.Disk without OOP and models</a></li>
<li><a href="../206900/index.html">Is Telegram Safe? Or as I was looking for a bookmark in MTProto</a></li>
<li><a href="../206904/index.html">FTCA Data Clustering Algorithm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>