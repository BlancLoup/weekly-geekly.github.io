<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Choosing a Pull To Refresh Tool</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I encountered the problem of introducing the Pull To Refresh mechanism to the project for updating lists. Due to the specificity of the avai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Choosing a Pull To Refresh Tool</h1><div class="post__text post__text-html js-mediator-article">  Recently, I encountered the problem of introducing the <b>Pull To Refresh</b> mechanism to the project for updating lists.  Due to the specificity of the available lists (lists of different lengths, from 0 to ~ 100; loading of elements on demand; a set of lists is located in a self-written component, ala <a href="http://developer.android.com/reference/android/support/v4/view/ViewPager.html">ViewPager</a> ), this really turned out to be problematic.  Read about all my research in this direction under the cut. <br><a name="habracut"></a><br>  <b>Pull To Refresh</b> - a chip, as far as I know, migrated to Android from the iPhone.  A convenient way to update the list. <br>  Consider it on the example of our news application (it actually became necessary to implement this feature): there is a list of news that is updated via the news server.  Manual update, so that the ‚ÄúUpdate‚Äù button sticks out below, which takes up some space on the screen.  And why waste precious screen space on a button that is not so often used if you can use Pull To Refresh: at the top of the list, pull the list down and then release it to refresh the list.  New news (pun) will be loaded and displayed.  It looks like this: <br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/d2e/379/b89/d2e379b89ed6b66a9ba239a2c39bd8a0.png"></div><br>  The idea is quite successful, and therefore used in many applications, including popular Facebook and Twitter clients.  So we decided to introduce such a chip into our news project. <br>  But why write from scratch what is already in the finished form?  A quick search on Google, the great and mighty StackOverFlow - and now found the most popular <b><a href="https://github.com/johannilsson/android-pulltorefresh"><u>android-pulltorefresh tool</u></a></b> from Johan Nilsson.  I took the latest version from GitHub and started using it.  Not here it was!  The project seems to be developing for almost a year, but ... this is what I see in the case of small lists: <br><br><img align="left" src="https://habrastorage.org/storage2/198/a4a/e75/198a4ae75ccc05e887ade14fafc3cf13.png">  And such a question immediately arises: <b>WTF?</b>  The project is a watch'at of 418 people, as many as 71 people have forged it, and here is such a <s>flawed</s> incorrect behavior.  Why all?  Because this one here is ‚ÄúTap to refresh ...‚Äù - this is the header of the ListView.  And he hides, in the implementation of Johan, banal <i>ListView.</i>  <b><i>setSelection (1)</i></b> <i>.</i>  And in the case of short lists, this <i>setSelection (1)</i> <s>politely sends to FEC</s> does not work. <br>  But then I notice that the project has two more branches: <b>enhancedpull</b> (which was already with the main branch) and, moreover, <b>scrollfix_for_short_list</b> :) <br>  I pull out the latest version of the scrollfix_for_short_list branch, fasten it to the project: the short list looks like it looks normal, just why did I start to slow down the UI so much?  And the thing is this: my list is not simple, but with loading on demand (on-demand), i.e.  Sanacha shows the first 10 elements, and if you flush to the end, then the next portion is loaded to the list.  And what is the fix for short lists according to Johan? <br>  ‚ÄúAnd let's add an empty view to the footer ListView that is exactly the same height so that <i>setSelection (1)</i> can hide the header again normally,‚Äù said Johan and proceeded to detracting the height of footer.  To calculate its height, you need to know the total height of all the elements in the list (except for the header, of course).  Then we will subtract this height from the height of the ListView and get the height for footer.  And in order to find out the height of each element of the list, <a href="http://iserveandroid.blogspot.com/2011/06/how-to-calculate-lsitviews-total.html"><u>from somewhere</u></a> , a ‚Äúingenious‚Äù decision was made to sort through all elements using the adapter (using <i>getView ()</i> ) and each <b><i>measure ()</i></b> , i.e.  essentially draw them (even if they are invisible).  As a result, my list thought that everything was being squandered and squandered - and everything was loading and loading new portions until the elements were finished.  And I usually have 50 items in the list, and several lists (they scroll like the recently appeared <a href="http://developer.android.com/reference/android/support/v4/view/ViewPager.html"><u>ViewPager</u></a> 'a).  In general, this is the implementation of counting the total height of the list items: <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTotalItemHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ListAdapter adapter = getAdapter(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> listviewElementsheight = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; adapter.getCount(); i++) { View mView = adapter.getView(i, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-comment"><span class="hljs-comment">// wtf? mView.measure(MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED), MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED)); listviewElementsheight += mView.getMeasuredHeight(); } return listviewElementsheight; }</span></span></code> </pre> <br>  It is absolutely not suitable for on-demand upload lists.  And in general, you should avoid <i>pulling</i> the adapter's <i>getView ()</i> manually.  Who knows what kind of logic is there? <br>  As a result, I went to surf the Internet in search of a more adequate tool.  Here is what I found: <br><ul><li>  Guillermo <a href="https://github.com/guillep/PullToRefresh">PullToRefresh</a> <br></li><li>  <a href="https://github.com/timahoney/Android-Pull-To-Refresh">Android-pull-to-refresh</a> from Tim Mahoney <br></li><li>  <a href="https://github.com/wdx700/Android-Pull-To-Refresh">Android-Pull-To-Refresh</a> from Daniel Wang (forked and fixed timahoney) </li></ul><br>  Guillermo, in the best OOP tradition, implemented Pull To Refresh using the <b>State</b> pattern.  The result was 13 classes, and the ability to do not only pull-down-to-refresh, but also pull-up-to-refresh.  I don‚Äôt know why, but the implementation was not very fast: I didn‚Äôt have time to catch up with the edge of the list.  And the triggering required a rather sharp downward movement to cause the header to appear.  And the animation is something not observed ... Let's go further. <br>  Tim Mahoney didn‚Äôt fool anyone, but immediately wrote to README: <b>‚ÄúCurrent Status: Buggy.‚Äù</b> No, it‚Äôs not suitable for a real project.  But I looked at the graph of versions - some kind Daniel Wang forked the project and fixed the bugs.  We take, fasten.  Usability leaves much to be desired.  If in previous implementations, it was enough to update the list upon the arrival of the <i>onRefresh</i> event and then call <i>onRefreshComplete ()</i> : <br><pre> <code class="java hljs">((PullToRefreshListView) getListView()).setOnRefreshListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnRefreshListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRefresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GetDataTask().execute(); } });</code> </pre><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetDataTask</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPostExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Void result)</span></span></span><span class="hljs-function"> </span></span>{ ... ((PullToRefreshListView) getListView()).onRefreshComplete(); } }</code> </pre><br>  here it is necessary to manually create the header, and upon the arrival of events, change the text in it, and of course the list should be updated: <br><pre> <code class="java hljs">mRefreshHeader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextView(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); mRefreshHeader.setLayoutParams(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT)); mRefreshHeader.setGravity(Gravity.CENTER); mRefreshHeader.setText(<span class="hljs-string"><span class="hljs-string">"Pull to refresh..."</span></span>); mContainerView = (PullRefreshContainerView) findViewById(R.id.container); mContainerView.setRefreshHeader(mRefreshHeader); mContainerView.setOnChangeStateListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnChangeStateListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onChangeState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PullRefreshContainerView container, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PullRefreshContainerView.STATE_IDLE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PullRefreshContainerView.STATE_PULL: mRefreshHeader.setText(<span class="hljs-string"><span class="hljs-string">"Pull to refresh..."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PullRefreshContainerView.STATE_RELEASE: mRefreshHeader.setText(<span class="hljs-string"><span class="hljs-string">"Release to refresh..."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PullRefreshContainerView.STATE_LOADING: mRefreshHeader.setText(<span class="hljs-string"><span class="hljs-string">"Loading..."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GetDataTask().execute(); <span class="hljs-comment"><span class="hljs-comment">//  onPostExecute() - mContainerView.completeRefresh(); break; } } });</span></span></code> </pre><br>  I do not know, maybe it is more flexible, but ... uncomfortable.  In addition, it turned out that this implementation does not work correctly in Pager: it became possible to scroll the list vertically and Pager horizontally at the same time. <br>  As a result, with tears in my eyes, I began to put on crutches the version of Johan from the scrollfix_for_short_list <b>branch</b> so that it would not force the lists to be loaded indefinitely.  Something was done, but it worked, to put it mildly, unstable.  On the horizon, the prospect of writing a component loomed itself, and I decided once again to re-search the Internet.  And, lo and behold! I stumbled upon <a href="https://github.com/chrisbanes/Android-PullToRefresh">another implementation</a> - from Chris Baines.  The project was based on the version of Johan, but has since been significantly improved (as the author writes).  The test confirmed: this implementation is validly devoid of all the bugs inherent in the version of Johan, and it looks more pleasant (due to the additional animation). <br><br>  So, why did I spread here so much?  And then all to give <b>morality</b> : <br><blockquote>  If you want to use the <b>Pull To Refresh</b> mechanism in your project - use the <a href="https://github.com/chrisbanes/Android-PullToRefresh"><b>implementation from Chris Baines</b></a> .  In my opinion, at the moment it is the highest quality implementation of Pull To Refresh. </blockquote><br>  <b>PS</b> A little later I found a <a href="http://habrahabr.ru/blogs/android_development/132277/">similar article</a> on Habr√©, which also criticizes the projects described above and promotes <a href="https://github.com/ondesly/Pull-to-refresh">its version of the Pull To Refresh implementation</a> .  But ... for some reason, when using this component, my application just started to fall: some problems with the cursor when trying to upload a new batch to the list.  So this option is not for me.  But the demo looks good: better than Johan. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/135226/">https://habr.com/ru/post/135226/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135214/index.html">Theme of the main menu for half an hour</a></li>
<li><a href="../135217/index.html">MySQL: transaction isolation levels</a></li>
<li><a href="../135220/index.html">FlashDevelop 4.0 released</a></li>
<li><a href="../135224/index.html">The 43rd issue of Russian Full Circle Magazine</a></li>
<li><a href="../135225/index.html">Mail.Ru Group continues the AOL era?</a></li>
<li><a href="../135229/index.html">New paint can work as a photocell</a></li>
<li><a href="../135230/index.html">Apple is working on a fuel cell laptop project</a></li>
<li><a href="../135231/index.html">Homemade flow meter for car</a></li>
<li><a href="../135232/index.html">Heaps. Part 1. The Binomial Heap</a></li>
<li><a href="../135234/index.html">John Carmack on static code analysis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>