<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Resident error</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently I received a letter similar to the following: 
 Dear X. Your candidacy is very interested in us, so we would not mind to get to know each oth...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Resident error</h1><div class="post__text post__text-html js-mediator-article">  Recently I received a letter similar to the following: <br><blockquote>  Dear X. Your candidacy is very interested in us, so we would not mind to get to know each other better.  You must first download our resume.exe letterhead, fill it out, and send it back to us.  Sincerely, network villains. <br></blockquote><br>  Tellingly, the link to the resume was written exactly like that.  <a href="http://resume.exe/">resume.exe</a> (do not click, link for example).  They generally, or what? <br><br>  Download, look.  The file is 159744 bytes in size and is packed at first glance.  Kaspersky program is known as " <a href="http://www.viruslist.com/en/viruses/encyclopedia%3Fvirusid%3D219756">Trojan.Win32.Srizbi.v</a> ". <br><br><a name="habracut"></a>  Ida scares the question on the damaged import table.  It is understandable - it is quite clear that the file is packed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/geektimes/post_images/fc2/768/87c/fc276887c11b759178d62aed9a53b8cd.gif" width="555" height="103" alt="6.09 KB"><br><br>  The code (blue section) takes up about five percent of the program size, but the data - in bulk.  This data is most likely a packed code.  Particularly frightening the names of the segments: "_67D &amp; NEk &amp;" or "_uoeWPJ3" instead of something familiar like ".code".  The entry point is not somewhere at the beginning of the file, but in some ass. <br><br>  We try a pair of packers, such as PEID - to no avail, this packer is not familiar to them.  Therefore, immediately proceed to action.  We will not analyze how the program is packaged.  Once she can unpack, let her do it herself.  (This case turned out to be quite simple, in others the launch of the program can lead to Terrible Things). <br><br>  Load the file to debugger, set a breakpoint on CreateFile.  It is logical after all - should any malicious program use it?  (Actually, here we can make some big misses. For example, if the program would use the native function ZwCreateFile, which is a level lower than CreateFile). <br><br>  ... and run for execution.  Here we are in for a surprise number 1. It takes 15-20 seconds (!) Before execution stops at the entrance to CreateFile.  See, the program is packed and repacked far and wide and more than once.  We tried with all my heart what to say. <br><br>  Stopping at the entrance to CreateFile, we look at the name of the file being opened: <br><blockquote><pre>  kernel32! CreateFileA:
 7c801a24 8bff mov edi, edi
 0: 000&gt; da poi (esp + 4)
 0012fe70 "C: \ WINDOWS \ system32 \ drivers \ gran"
 0012fe90 "de48.sys" </pre></blockquote><br>  Driver!  The case smells like rootkits.  While the program is running, we make a dump with something like PE Tools, and view it in a disassembler.  He curses ever more, now on IAT, but it is not lethal.  In the debager we look at the call stack, find where the function was called from, go back to the disassembler, find this code.  The call to CreateFile looks something like <br><blockquote><pre>  call ds: 42C1C8 </pre></blockquote><br>  that doesn't really tell us anything.  Therefore, using the dds command in windbg, we find the addresses of real functions, transfer them to go (out of a little, something around twenty).  Now we have the names of the called functions (as if an import table restored by hands), and we can analyze the code in a disassembler.  It turns out to be very simple, linear, almost without branches.  I will give the full code of the main function: <br><br>  ;  Attributes: bp-based frame <br>  Main_40164F proc near <br>  var_32C = dword ptr -32Ch <br>  String1 = byte ptr -228h <br>  Windir = byte ptr -124h <br>  var_20 = dword ptr -20h <br><br>  push ebp <br>  mov ebp, esp <br>  sub esp, 32Ch <br>  <b>call unxor_401040</b> <b><br></b>  <b>call SetupImports_401248</b> <br>  call ds: GetTickCount_0 <br>  mov ds: TickCount_42C1AC, eax <br>  push 104h;  uSize <br>  lea eax, [ebp + windir] <br>  push eax;  lpBuffer <br>  <b>call ds: GetWindowsDirectoryA</b> <br>  lea eax, [ebp + windir] <br>  push eax <br>  lea eax, [ebp + String1] <br>  push eax <br>  call ds: lstrcpyA <br>  lea eax, [ebp + windir] <br>  push eax <br>  lea eax, [ebp + var_32C] <br>  push eax <br>  call ds: lstrcpyA <br>  push ds: lpString2 <br>  lea eax, [ebp + var_20] <br>  push eax <br>  call ds: lstrcpyA <br>  push ds: dword_42C16C <br>  lea eax, [ebp + windir] <br>  push eax <br>  call ds: lstrcatA <br>  lea eax, [ebp + windir] <br>  push eax <br>  <b>call ExtractDriver_4015E4</b> <br>  lea eax, [ebp + var_20] <br>  push eax <br>  lea eax, [ebp + windir] <br>  push eax <br>  <b>call LoadDriver_4014CB</b> <br>  add esp, 0Ch <br>  <b>call KillMySelf_40139F</b> <br>  call CleanUp_401000 <br>  leave <br>  retn <br>  Main_40164F endp <br><br>  As you can see, everything is simple.  First, the lines are prepared, then the import is restored, after which the driver is removed from the program body, saved to the driver folder and loaded. <br><blockquote><pre>  ADVAPI32! CreateServiceA:
 77e37071 6a30 push 30h
 0: 000&gt; da poi (esp + 8)
 0012ff74 "grande48" </pre></blockquote><br><br><blockquote>  <i>Here I want to remind you of one simple, but very effective way to combat this kind of infection.</i>  <i>Enough to prohibit entry to the system directories and more than half of the viruses will simply not work.</i> <i><br></i> </blockquote><br>  At the stage of loading the driver we are waiting for the second surprise.  It does not load.  You can sit and wait for hours with a debugger in hand, when this long-awaited IoCreateDevice is called, but this moment does not come.  After a few hours of fruitless attempts to load the driver, it turns out that it was made for Windows 2000!  Therefore, most windows users who use XP, this infection is not terrible.  It is quite possible that this is only this modification that behaves this way, so I will not say for sure. <br><br>  Speaking of driver.  Size 167936. Defined by Kaspersky as Rootkit.Win32.Agent.aih.  Inside contains a lot of diverse code that sends spam.  Among other things, contains the IP address of the managing server: 208.66.195.172.  Apparently, this is a co-location, and the server itself is rented.  Not really, however, it is clear how it is possible to rent a server to manage a botnet) Or maybe the server is legal, just the malicious code is implemented on it, and the admins missed.  In general, everything is foggy. <br><br>  We return back.  The KillMySelf function creates a bat file _it.bat in the Temp folder and then launches it: <br><blockquote><pre>  kernel32! CreateFileA:
 7c801a24 8bff mov edi, edi
 0: 000&gt; da poi (esp + 4)
 0012fb58 "C: \ DOCUME ~ 1 \ dev \ LOCALS ~ 1 \ Temp \ _i"
 0012fb78 "t.bat" </pre></blockquote><br>  Here is its full text: <br><br><blockquote>  : abc <br>  del "C: \ sandbox \ Trojan.Win32.Srizbi.v \ resume.exe." <br>  if exist "C: \ sandbox \ Trojan.Win32.Srizbi.v \ resume.exe.txt" goto abc <br>  rmdir "C: \ sandbox \ Trojan.Win32.Srizbi.v" <br>  del "C: \ DOCUME ~ 1 \ dev \ LOCALS ~ 1 \ Temp \ _it.bat" <br></blockquote><br>  That is, it tries to remove the program, the folder that contains it, and itself for the last. <br><br><h3>  Conclusion </h3>  Srizbi is not a Trojan, but a carrier of a real malware.  His goal is to unload the real virus from his body as quickly as possible (albeit slowly), run it, then disappear, leaving a minimum of traces.  Its code is simple and non-volumetric, and for beginners (like me :), it‚Äôs pretty easy to figure it out.  Because of the stupid error, all the work of Srizbi.v goes for a smarka: it does not check the version of the operating system for compliance with the driver it contains.  As a result, the system simply refuses to load the driver.  It is useful to look into the driver, there is a rootkit, which hides files, registry keys, network connections and listening ports. </div><p>Source: <a href="https://habr.com/ru/post/25502/">https://habr.com/ru/post/25502/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255009/index.html">Self-assembly 3d-printer or purchase ready-made equipment for the design. 3d printing. Part 3</a></li>
<li><a href="../255011/index.html">Improving sound quality on Android tablets with Intel Atom processors using the Dolby Digital API</a></li>
<li><a href="../255013/index.html">Cloud services under high load. Cackle experience</a></li>
<li><a href="../255015/index.html">How to catch what is not. Part sad: what is an antivirus?</a></li>
<li><a href="../255019/index.html">Clouds - white-manned horses or secure ownCloud for ‚Äúsmall‚Äù ones in FreeNAS</a></li>
<li><a href="../255021/index.html">Top 100+ Wolfram | Alpha Sine Functions, or Wolfram | Alpha Overview of Mathematical Features and Syntax</a></li>
<li><a href="../255025/index.html">The story of creating another robot. Part One, Design</a></li>
<li><a href="../255027/index.html">DevCon 2015: announcement of the speakers - representatives of the community</a></li>
<li><a href="../255029/index.html">Creation of microservices</a></li>
<li><a href="../25503/index.html">Reply to the message on Odnoklassniki.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>