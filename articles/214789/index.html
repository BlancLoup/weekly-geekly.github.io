<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configure the Site-to-Site IPsec tunnel between the Windows Azure cloud and the D-Link DFL-210</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings 

 In this article, I will describe in stages the entire process of configuring the Site-to-Site tunnel between the Windows Azure cloud and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configure the Site-to-Site IPsec tunnel between the Windows Azure cloud and the D-Link DFL-210</h1><div class="post__text post__text-html js-mediator-article">  Greetings <br><br>  In this article, I will describe in stages the entire process of configuring the Site-to-Site tunnel between the Windows Azure cloud and the D-Link DFL-210 firewall (relevant for the DFL line of devices: 210 \ 260E \ 800 \ 860E) <br><br>  <b>Attention!</b>  <b>All configuration steps are accompanied by a large number of pictures!</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h2>  Step 1: Configure Windows Azure </h2><br><br>  First, create a new Windows Azure virtual network using the wizard <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/1c0/158/15a/1c015815a32ffa1a6dc74be577f53165.png"></div></div><br>  <i>Name: Habratest</i> <i><br></i>  <i>New Territorial Group: Habragroup</i> <i><br></i>  <i>Region: Western Europe</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/034/b4f/10e/034b4f10e74ca23a4a9bdeb085e7c2ff.png"></div></div><br>  Then we enter the name and address of the local DNS (if necessary).  Otherwise, we use DNS from Windows Azure, or any public <br>  Put the checkbox <b>"Configure a network-to-network VPN connection</b> " <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/883/be8/fb6/883be8fb64e2f554486b2afbfc17f2a8.png"></div></div><br>  In the next step, enter the settings of our DFL: <br>  <i>Name: Mydfl</i> <i><br></i>  <i>The IP address of the VPN device: 78.153.146.110 is the dedicated static IPv4 address of our DFL ( <b>This is important. If DFL is over NAT, then we will fail</b> )</i> <i><br></i>  <i>Address space: 192.168.22.0/24 - local subnet, which we will connect to Windows Azure</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/854/121/a00/854121a0064727f59e5fbe27fb246667.png"></div></div><br>  In the last step, enter the settings of the subnet to which we will connect (will be used for services created in Windows Azure) <br>  In our case, the settings will be as follows: <br>  <i>The total address space of the virtual network: 172.16.80.0/24</i> <i><br></i>  <i>Subnet:</i> <i><br></i>  <i>AzureSubnet 172.16.80.0/27</i> <i><br></i>  <i>Gateway 172.16.80.32/29</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/a27/6f1/694/a276f16945229213533329763f50fd13.png"></div></div><br>  Virtual subnet is created! <br><br>  Go to the " <b>Settings</b> " of the newly created virtual network and check that we did everything correctly <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/f35/2f6/fcf/f352f6fcfa94745690f7e8e1f80691ff.png"></div></div><br><br>  On the " <b>Dashboard</b> " tab we see the following picture. <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/3da/54b/83d/3da54b83dadffd778070b2a22f4ef626.png"></div></div><br>  Click the " <b>Create Gateway</b> " button at the bottom of the page and select the " <b>Static Routing</b> " mode.  Confirm your intentions by clicking " <b>OK</b> " <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/d9a/89b/a8c/d9a89ba8c40053ae2f4d1bba5a847cb7.png"></div></div><br>  We are waiting for 10-15 minutes until Windows Azure creates a gateway for us <br><br><h6>  ... It took 10 to 15 minutes ... </h6><br>  So, the gateway is created.  We look, that Windows Azure gave us: <br>  <i>Gateway IP Address: 23.97.132.122</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/00c/5fd/b9e/00c5fdb9e7c6f8a7dc45dd3c17423cc4.png"></div></div><br>  Next, click the " <b>Key Management</b> " button at the bottom of the page and get our personal pre-shared key: <br>  <i>R9GrgLgZPosdZ7isMdt8MkrDQnfBwUbO</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/ed5/2f7/5ad/ed52f75ade0fff7f4e442efd5199231d.png"></div></div><br><br><h2>  Step 2: Configure DFL </h2><br><br>  General requirements for the gateway can be found here: <br>  <a href="http://msdn.microsoft.com/ru-ru/library/windowsazure/jj156075.aspx">http://msdn.microsoft.com/ru-ru/library/windowsazure/jj156075.aspx#BKMK_VPNGateway</a> <br><br><blockquote>  <b>Here you have to make one very important note.</b> <br>  In the Russian DFL firmware (installed by default), such wonderful encryption methods as AES, which Windows Azure uses (and not only) for its work, are not available.  We will leave discussions on this topic outside of this article and use the following trick: <br>  We follow the link <a href="http://tsd.dlink.com.tw/">http://tsd.dlink.com.tw/</a> <br>  Choose your DFL model from the list and download the latest WorldWide firmware for our device (denoted ‚ÄúFor WW‚Äù) <br>  Download the firmware in our DFL and wait for the completion of the operation <br>  Firmware uploaded and we can continue </blockquote><br><br>  Now let's add all the IP addresses of the cloud to the directory (‚Äú <u>Objects-&gt; Address book-&gt; InterfaceAddresses</u> ): <br>  <i>Name: Habratest_cloud_gateway</i> <i><br></i>  <i>Value: 23.97.132.122</i> <i><br></i>  <i>Name: Habratest_cloud_subnet</i> <i><br></i>  <i>Value: 172.16.80.0/24</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/fb7/b32/f6f/fb7b32f6f3e6a7ae9fd222a9ad6a6a48.png"></div></div><br>  Then go to " <u>Objects-&gt; Authentication Objects</u> " and add a new object of the type " <b>Pre-shared key</b> ": <br>  <i>Name: Habratest_cloud_key</i> <i><br></i>  <i>Passphrase: R9GrgLgZPosdZ7isMdt8MkrDQnfBwUbO</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/a3c/ad0/97f/a3cad097f81bd4d8a1ab56fc145bff2d.png"></div></div><br>  Next, go to the " <u>Objects-&gt; VPN Objects-&gt; IKE Algorithms</u> " item and create a new IKE algorithm: <br>  <i>Name: Habratest_cloud_stage1</i> <i><br></i>  <i>We put the daws: 3DES and AES (128,128,256), as well as the SHA1 checkbox</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/3f0/8f4/76b/3f08f476bcb0f10bcc0dde2cf0b5103c.png"></div></div><br>  After creating the IKE algorithm, proceed to the creation of the IPsec algorithm ( <u>"Objects-&gt; VPN Objects-&gt; IPsec Algorithms"</u> ): <br>  <i>Name: Habratest_cloud_stage2</i> <i><br></i>  <i>Galki: same as IKE</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/102/53d/998/10253d9988bf7a15dd61aaebe5dfa10d.png"></div></div><br>  Now let's proceed directly to creating a rule for an IPsec tunnel ( <u>"Interfaces-&gt; IPsec"</u> ): <br>  <u>General</u> tab <br>  <i>Name: Habratest_cloud_IPsec</i> <i><br></i>  <i>Local Network: lannet</i> <i><br></i>  <i>Remote Network: Habratest_cloud_subnet</i> <i><br></i>  <i>Remote Endpoint: Habratest_cloud_gateway</i> <i><br></i>  <i>Encapsulation mode: Tunnel ( <b>important setting!</b> )</i> <br><br>  <i>IKE Config Mode Pool: None</i> <i><br></i>  <i>IKE Algorithms: Habratest_cloud_stage1</i> <i><br></i>  <i>IKE Lifetime: 28800</i> <br><br>  <i>IPsec Algorithms: Habratest_cloud_stage2</i> <i><br></i>  <i>IPsec Lifetime: 3600 sec</i> <i><br></i>  <i>IPsec Lifetime: 102400000 Kb</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/f23/99f/fa8/f2399ffa8b4067844dd3661aec1f6aca.png"></div></div><br>  <u>‚ÄúAuthentication‚Äù</u> tab <br>  Put the point ‚Äú <b>Pre-shared key</b> ‚Äù and choose our ‚Äú <b>Habratest_cloud_key</b> &gt;‚Äù <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/a9d/84b/aff/a9d84baff88d5a99f47182642b1d6f65.png"></div></div><br>  Tab " <u>IKE Settings</u> " <br>  <i>IKE:</i> <i><br></i>  <i>Main - DH Group 2</i> <i><br></i>  <i>PFS - None</i> <i><br></i>  <i>Security Association: Per Net</i> <i><br></i>  <i>NAT Traversal: On if supported and NATed</i> <i><br></i>  <i>Dead Peer Detection: Use</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/aad/566/9dc/aad5669dc9f9a64470ef7e34e612371b.png"></div></div><br>  Then we create two IP Rules (‚Äú <u>Rules-&gt; IP Rules</u> ‚Äù): <br>  <u>Rule 1</u> : <br>  <i>Name: lan_to_cloud</i> <i><br></i>  <i>Action: Allow</i> <i><br></i>  <i>Service: All_service</i> <i><br></i>  <i>Schedule: None</i> <i><br></i>  <i>Source interface: lan</i> <i><br></i>  <i>Source Network: lannet</i> <i><br></i>  <i>Destination Interface: Habratest_cloud_IPsec</i> <i><br></i>  <i>Destination Network: Habratest_cloud_subnet</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/a62/105/224/a6210522465f02e630072a289bcb4ef0.png"></div></div><br>  <u>Rule 2</u> : <br>  <i>Name: cloud_to_lan</i> <i><br></i>  <i>Action: Allow</i> <i><br></i>  <i>Service: All_service</i> <i><br></i>  <i>Schedule: None</i> <i><br></i>  <i>Source interface: Habratest_cloud_IPsec</i> <i><br></i>  <i>Source Network: Habratest_cloud_subnet</i> <i><br></i>  <i>Destination Interface: lan</i> <i><br></i>  <i>Destination Network: lannet</i> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/edf/650/b68/edf650b68c3e6795b1e2567975fdaf66.png"></div></div><br><br>  So we created the basic settings for the tunnel.  Now save and apply the changes to the DFL <br><br>  <b>That's all!</b>  <b>We observe beautiful pictures of the raised tunnel</b> <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/c23/42a/692/c2342a692370fbd26fd3113bc0512fc3.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/d09/995/f58/d09995f588c9f6ff92b6ed6f17c76082.png"><br></div></div><br>  Then you can create the necessary services in Windows Azure (virtual machines, databases, etc) <br><br><hr><br>  A little about possible errors in the DFL logs: <br>  1. statusmsg = ‚ÄúNo request" - incorrect encryption methods are selected <br>  2. reason = ‚ÄúInvalid proposal‚Äù - the same as item 1 <br>  3. reason = "IKE_INVALID_COOKIE" - the tunnel was already raised, but after that changes were made to its settings.  Go to the DFL "Status-&gt; IPsec-&gt; Habratest_cloud_IPsec-&gt; on the top right of the List all active IKE SAs page" and delete the outdated IKE SA.  Reboot DFL <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/e58/7c5/2fa/e587c52fa43e117e600359de6114b252.png"></div></div><br><hr><br>  That's all.  Do not forget to change the test data from the article (IP addresses, subnets, regions, pre-shared key keys) to your <br><br>  Thanks for attention! <br><br>  PS I ask you to pay attention to the comment of the habrauser <a href="http://habrahabr.ru/post/214789/">DikSoft</a> , which reports that such a scenario is officially unsupported and there may be problems </div><p>Source: <a href="https://habr.com/ru/post/214789/">https://habr.com/ru/post/214789/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214777/index.html">Sochi 2014 mobile apps: how to show megabytes of results to users</a></li>
<li><a href="../214779/index.html">Automate mouse clicks on Linux: xdotool</a></li>
<li><a href="../214781/index.html">Collect millions of likes or task queues in Node.js</a></li>
<li><a href="../214783/index.html">PhD thesis. Instructions for clearing scientific stubs. Part 2</a></li>
<li><a href="../214787/index.html">About customization of information systems</a></li>
<li><a href="../214793/index.html">This post is written by the author who does not read the comments, please do not write them.</a></li>
<li><a href="../214795/index.html">Inside stories Mt. Gox</a></li>
<li><a href="../214797/index.html">The logic of thinking. Part 6. The system of projections</a></li>
<li><a href="../214799/index.html">Creating a game on your eyes - part 5: Subtotal (prototype)</a></li>
<li><a href="../214801/index.html">Mobius Conference: Final Schedule</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>