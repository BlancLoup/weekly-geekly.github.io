<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to reduce the likelihood of errors at the stage of writing code. Note N1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I got to the code of the well-known instant messaging client Miranda IM . Together with various plugins, this is a fairly large project, the size of w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to reduce the likelihood of errors at the stage of writing code. Note N1</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/a20/013/0cb/a200130cb35c903d1569b7471a8f4d80.png" alt="Check miranda im"><br>  I got to the code of the well-known instant messaging client <a href="http://www.miranda-im.org/">Miranda IM</a> .  Together with various plugins, this is a fairly large project, the size of which is about 950 thousand lines of code in C and C ++.  And, as in any solid project with a history of development, it contains a considerable number of errors and typos. <br><br>  Considering defects in various applications, I noticed some patterns.  And now, using the example of defects found in Miranda IM, I will try to formulate some recommendations that will allow you to avoid many errors and typos at the stage of writing code. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For the analysis of Miranda IM, I used (yes, you guessed it) the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> 4.14 analyzer.  The code of the project Miranda IM is very high quality, as evidenced by the popularity of this program.  I myself am a user of this client and have no complaints about it in terms of quality.  The project is collected in Visual Studio with Warning Level 3 (/ W3), and the number of comments is 20% of the entire program text. <br><br><h2>  1. Avoid memset, memcpy, ZeroMemory and similar functions. </h2><br>  We will start with errors that occur when using low-level memory functions such as memset, memcpy, ZeroMemory, and the like. <br><br>  I recommend to avoid these functions in every possible way.  It is clear that you should not literally follow my advice and replace all these functions with cycles.  But I have seen such a huge number of errors associated with the use of these functions, that I highly recommend to be careful with them and use them only when necessary.  In my opinion there are only two cases where the use of these functions is justified: <br><br>  1) Processing large arrays.  That is, where the optimized algorithm of the function will give a gain compared with the processing of elements in a simple cycle. <br><br>  2) Processing a large number of small arrays.  It also makes sense in terms of performance improvement. <br><br>  In all other cases, it is better to try to do without them.  For example, I consider these functions superfluous in a program such as Miranda.  There are no resource-intensive algorithms or huge arrays in it.  Consequently, the use of memset / memcpy functions derives only from the convenience of writing short code.  However, this simplicity is very deceptive and, having saved a few seconds on writing code, you can catch for weeks a vaguely manifested memory corruption error.  Consider a few code examples taken from the Miranda IM project. <br><br>  <a href="http://www.viva64.com/ru/d/0101/">V512</a> A call of the memcpy function will lead to a buffer overflow or underflow.  tabsrmm utils.cpp 1080 <br><pre>  typedef struct _textrangew
 {
   CHARRANGE chrg;
   LPWSTR lpstrText;
 } TEXTRANGEW;

 const wchar_t * Utils :: extractURLFromRichEdit (...)
 {
   ...
   :: CopyMemory (tr.lpstrText, L "mailto:", 7);
   ...
 } </pre><br>  Copy only a piece of string.  The error is trivial to a disgrace, but this does not cease to be an error.  Most likely, a string consisting of 'char' was used here before.  Then we switched to Unicode strings, but forgot to change the constant. <br><br>  If you initially use to copy the string functions that are intended for this, then such an error simply can not occur.  Imagine what it was written like this: <br><pre>  strncpy (tr.lpstrText, "mailto:", 7); </pre><br>  Then, when moving to Unicode strings, the number 7 does not need to be changed: <br><pre>  wcsncpy (tr.lpstrText, L "mailto:", 7); </pre><br>  I'm not saying that this is the perfect code.  But it is already much better than using CopyMemory.  Consider another example. <br><br>  <a href="http://www.viva64.com/ru/d/0163/">V568</a> It's odd that the sizeof () operator is the '&amp; ImgIndex' expression.  clist_modern modern_extraimage.cpp 302 <br><pre>  void ExtraImage_SetAllExtraIcons (HWND hwndList, HANDLE hContact)
 {
   ...
   char * (ImgIndex [64]);
   ...
   memset (&amp; ImgIndex, 0, sizeof (&amp; ImgIndex));
   ...
 } </pre><br>  Here I wanted to reset the array consisting of 64 pointers.  But instead, we will reset only the first element.  The same error, by the way, is present again in another file.  Thanks to Copy-Paste: <br><br>  <a href="http://www.viva64.com/ru/d/0163/">V568</a> It's odd that the sizeof () operator is the '&amp; ImgIndex' expression.  clist_mw extraimage.c 295 <br><br>  The correct version of the code should look like this: <br><pre>  memset (&amp; ImgIndex, 0, sizeof (ImgIndex)); </pre><br>  By the way, taking an address from an array can only further confuse the person who is reading the code.  Here taking an address has no effect.  And the code can be written like this: <br><pre>  memset (ImgIndex, 0, sizeof (ImgIndex)); </pre><br>  The following example. <br><br>  <a href="http://www.viva64.com/ru/d/0163/">V568</a> It's odd that the sizeof () operator is the '&amp; rowOptTA' expression.  clist_modern modern_rowtemplateopt.cpp 258 <br><pre>  static ROWCELL * rowOptTA [100];

 void rowOptAddContainer (HWND htree, HTREEITEM hti)
 {
   ...
   ZeroMemory (rowOptTA, sizeof (&amp; rowOptTA));
   ...
 } </pre><br>  Again, instead of calculating the size of the array, we calculate the size of the pointer.  The correct expression is "sizeof (rowOptTA)".  To clean the array, I suggest the following version of this code: <br><pre>  const size_t ArraySize = 100;
 static ROWCELL * rowOptTA [ArraySize];
 ...
 std :: fill (rowOptTA, rowOptTA + ArraySize, nullptr); </pre><br>  I have already got used to the fact that such strings like to multiply according to the copy program: <br><br>  V568 It's odd that the sizeof () operator is the '&amp; rowOptTA' expression.  clist_modern modern_rowtemplateopt.cpp 308 <br><br>  V568 It's odd that the sizeof () operator is the '&amp; rowOptTA' expression.  clist_modern modern_rowtemplateopt.cpp 438 <br><br>  Do you think that this is all about low-level work with arrays?  No, not all.  Look further, be afraid and beat the hands of fans to write memset. <br><br>  <a href="http://www.viva64.com/ru/d/0101/">V512</a> A call of the memset function will lead to a buffer overflow or underflow.  clist_modern modern_image_array.cpp 59 <br><pre>  static BOOL ImageArray_Alloc (LP_IMAGE_ARRAY_DATA iad, int size)
 {
   ...
   memset (&amp; iad-&gt; nodes [iad-&gt; nodes_allocated_size], 
     (size_grow - iad-&gt; nodes_allocated_size) *
        sizeof (IMAGE_ARRAY_DATA_NODE),
     0);
   ...
 } </pre><br>  This time the size of the copied data is calculated correctly.  Here are the second and third arguments that are confused in places.  As a result, we fill 0 items.  The correct option is: <br><pre>  memset (&amp; iad-&gt; nodes [iad-&gt; nodes_allocated_size], 0,
   (size_grow - iad-&gt; nodes_allocated_size) *
      sizeof (IMAGE_ARRAY_DATA_NODE)); </pre><br>  How to rewrite this code snippet more gracefully, I do not know.  Rather, it cannot be rewritten beautifully, without affecting other parts of the program and data structures. <br><br>  The question arises, how can we do without memset when working with such structures as OPENFILENAME: <br><pre>  OPENFILENAME x;
 memset (&amp; x, 0, sizeof (x)); </pre><br>  Very simple.  You can create a zeroed structure like this: <br><pre>  OPENFILENAME x = {0}; </pre><br><br><h2>  2. Watch carefully whether you work with a signed or unsigned type. </h2><br>  The problem of confusion between signed and unsigned types may seem far-fetched at first glance.  But this question is in vain underestimated by programmers. <br><br>  In most cases, people do not like to consider the compiler warnings related to the fact that a variable of type int is compared with a variable of type unsigned.  Indeed, most often such code is completely correct.  Programmers disable such warnings or do not pay attention to them.  Or there is a third option, they enter an explicit type conversion to silence the compiler warning, without going into details. <br><br>  I suggest not doing this anymore and analyzing the situation each time when the sign type meets with the unsigned one.  And, in general, be attentive to what type the expression has or what the function returns.  Now a few examples on the subject. <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'wParam&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. clist_mw cluiframes.c 3140 <br><br>  The program code has a function id2pos, which returns the value '-1' in case of an error.  This function is all right.  Elsewhere, the result of the id2pos function is used as follows: <br><pre>  typedef UINT_PTR WPARAM; 
 static int id2pos (int id);
 static int nFramescount = 0;

 INT_PTR CLUIFrameSetFloat (WPARAM wParam, LPARAM lParam)
 {
   ...
   wParam = id2pos (wParam);
   if (wParam&gt; = 0 &amp;&amp; (int) wParam &lt;nFramescount)
     if (Frames [wParam] .floating)
   ...
 } </pre><br>  The problem is that the wParam variable is unsigned.  Therefore, the condition 'wParam&gt; = 0' is always true.  If the id2pos function returns '-1', then the condition for checking invalid values ‚Äã‚Äãdoes not work, and we will start using a negative index. <br><br>  I'm pretty sure that the following code was written at first: <br><br>  if (wParam&gt; = 0 &amp;&amp; wParam &lt;nFramescount) <br><br>  The Visual C ++ compiler issued a warning warning C4018: '&lt;': signed / unsigned mismatch.  This warning is included on Warning Level 3, with which Miranda IM is going.  And at this moment insufficient attention was paid to this place.  The warning was suppressed by an explicit type conversion.  But the error did not disappear, but only hid.  The correct code should be the following code: <br><br>  if ((int) wParam&gt; = 0 &amp;&amp; (int) wParam &lt;nFramescount) <br><br>  So attention and more attention to such places.  In Miranda IM, I counted 33 conditions that, because of the confusion with signed / unsigned, are always true or always false. <br><br>  We continue.  I especially like the following example.  And the comment is just beautiful. <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'nOldLength &lt;0' is always false.  Unsigned type value is never &lt;0. IRC mstring.h 229 <br><pre>  void Append (PCXSTR pszSrc, int nLength)
 {
   ...
   UINT nOldLength = GetLength ();
   if (nOldLength &lt;0)
   {
     // protects from underflow
     nOldLength = 0;
   }
   ...
 } </pre><br>  I think no explanation for this code is required. <br><br>  Of course, programmers are not always to blame for mistakes.  Sometimes the developers of libraries (in this case WinAPI) also enclose the pig. <br><pre>  #define SRMSGSET_LIMITNAMESLEN_MIN 0
 static INT_PTR CALLBACK DlgProcTabsOptions (...)
 {
   ...
   limitLength =
     GetDlgItemInt (hwndDlg, IDC_LIMITNAMESLEN, NULL, TRUE)&gt; =
     SRMSGSET_LIMITNAMESLEN_MIN?
     GetDlgItemInt (hwndDlg, IDC_LIMITNAMESLEN, NULL, TRUE):
     SRMSGSET_LIMITNAMESLEN_MIN;
   ...
 } </pre><br>  If you do not pay attention to unnecessarily complex expression, the code looks correct.  By the way, it was generally one line.  For convenience, I broke it into several.  However, the formatting of the code now we will not affect. <br><br>  The problem is that the GetDlgItemInt () function does not return an 'int' at all, as the programmer expected.  This function returns a UINT.  Here is its prototype from the ‚ÄúWinUser.h‚Äù file: <br><pre>  WINUSERAPI
 Uint
 Winapi
 GetDlgItemInt (
     __in HWND hDlg,
     __in int nIDDlgItem,
     __out_opt BOOL * lpTranslated,
     __in BOOL bSigned); </pre><br>  As a result, PVS-Studio displays the message: <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression is always true.  Unsigned type value is always&gt; = 0. scriver msgoptions.c 458 <br><br>  And indeed it is.  The expression "GetDlgItemInt (hwndDlg, IDC_LIMITNAMESLEN, NULL, TRUE)&gt; = SRMSGSET_LIMITNAMESLEN_MIN" is always true. <br><br>  Specifically, in this case, perhaps, there will be no mistake.  But the meaning of my warning, I hope, is clear.  Look carefully at what functions return to you. <br><br><h2>  3. Avoid a lot of calculations in one line. </h2><br>  Every programmer knows and responsibly declares in discussions that it is necessary to write simple and clear code.  But in practice, it sometimes seems that he is participating in a secret contest who will write a string more cunningly, using an interesting construction of the language or demonstrate the ability to juggle with pointers. <br><br>  Most often, errors occur where the programmer, in order to create a compact code, collects several actions into one line at a time.  With a slight gain in elegance, it significantly increases the risk of a typo or that it does not take into account side effects.  Consider an example: <br><br>  <a href="http://www.viva64.com/ru/d/0162/">V567</a> Undefined behavior.  The variable is modified while it is being used.  msn ezxml.c 371 <br><pre>  short ezxml_internal_dtd (ezxml_root_t root, char * s, size_t len)
 {
   ...
   while (* (n = ++ s + strspn (s, EZXML_WS)) &amp;&amp; * n! = '&gt;') {
   ...
 } </pre><br>  This is where undefined behavior occurs.  This code can function correctly for a long period of program life.  But there is no guarantee that it will also behave after changing the version of the compiler or optimization keys.  The compiler is right to first compute '++ s' and then call the function 'strspn (s, EZXML_WS)'.  Or, on the contrary, at first it can call a function, and only then increase the value of the variable 's'. <br><br>  I will give another example, why you should not try to collect everything in one line.  In Miranda IM, some branches of the program execution are disabled / enabled using inserts of the form '&amp;&amp; 0'.  Examples: <br><pre>  if ((1 || altDraw) &amp;&amp; ...
 if (g_CluiData.bCurrentAlpha == GoalAlpha &amp;&amp; 0)
 if (checkboxWidth &amp;&amp; (subindex == - 1 || 1)) { </pre><br>  With the given comparisons, everything is clear and well marked.  Now imagine that you meet the fragment shown below.  I formatted the code.  The program is one line. <br><br>  <a href="http://www.viva64.com/ru/d/0153/">V560</a> A part of the conditional expression is always false: 0. clist_modern modern_clui.cpp 2979 <br><pre>  LRESULT CLUI :: OnDrawItem (UINT msg, WPARAM wParam, LPARAM lParam)
 {
   ...
   DrawState (dis-&gt; hDC, NULL, NULL, (LPARAM) hIcon, 0,
     dis-&gt; rcItem.right + dis-&gt; rcItem.left-
     GetSystemMetrics (SM_CXSMICON)) / 2 + dx,
     (dis-&gt; rcItem.bottom + dis-&gt; rcItem.top-
     GetSystemMetrics (SM_CYSMICON)) / 2 + dx,
     0,0,
     DST_ICON |
     (dis-&gt; itemState &amp; ODS_INACTIVE &amp;&amp; FALSE? DSS_DISABLED: DSS_NORMAL));
    ...
 } </pre><br>  If there is no error here, it is still not easy to remember and find the word FALSE in this line.  Did you find him?  Agree - not an easy task.  And if this is a mistake?  Then there is no chance at all to find it, just looking through the code.  Such expressions are very useful to make separately.  Example: <br><pre>  UINT uFlags = DST_ICON;
 uFlags | = dis-&gt; itemState &amp; ODS_INACTIVE &amp;&amp; FALSE?
             DSS_DISABLED: DSS_NORMAL; </pre><br>  And I myself, perhaps, would have written it in a long, but more understandable way: <br><pre>  UINT uFlags;
 if (dis-&gt; itemState &amp; ODS_INACTIVE &amp;&amp; (((FALSE))))
   uFlags = DST_ICON |  DSS_DISABLED;
 else 
   uFlags = DST_ICON |  DSS_NORMAL; </pre><br>  Yes, it is longer, but easy to read, and the word FALSE is better noticeable. <br><br><h2>  4. Align all that is possible in the code </h2><br>  Alignment of the code reduces the likelihood of typo or errors during Copy-Paste.  If the error is still made, then finding it in the process of reviewing the code will be several times easier.  Consider the sample code. <br><br>  <a href="http://www.viva64.com/ru/d/0126/">V537</a> Consider reviewing the correctness of 'maxX' item's usage.  clist_modern modern_skinengine.cpp 2898 <br><pre>  static BOOL ske_DrawTextEffect (...)
 {
   ...
   minX = max (0, minX + mcLeftStart-2);
   minY = max (0, minY + mcTopStart-2);
   maxX = min ((int) width, maxX + mcRightEnd-1);
   maxY = min ((int) height, maxX + mcBottomEnd-1);
   ...
 } </pre><br>  Monolithic code snippet, which is not interesting to read.  Format it: <br><pre>  minX = max (0, minX + mcLeftStart - 2);
 minY = max (0, minY + mcTopStart - 2);
 maxX = min ((int) width, maxX + mcRightEnd - 1);
 maxY = min ((int) height, maxX + mcBottomEnd - 1); </pre><br>  This is not the most illustrative example, but you must admit, now it has become much easier to notice that the maxX variable is used twice. <br><br>  My alignment recommendation should not be taken literally and everywhere to build columns of code.  Firstly, it requires additional time when writing and editing code.  Secondly, it can lead to other errors.  In the following example, just the desire to make a beautiful column led to an error in the Miranda IM code. <br><br>  <a href="http://www.viva64.com/ru/d/0125/">V536</a> Be advised that the utilized form.  Oct: 037, Dec: 31. msn msn_mime.cpp 192 <br><pre>  static const struct _tag_cpltbl
 {
   unsigned cp;
   const char * mimecp;
 } cptbl [] =
 {
   {037, "IBM037"}, // IBM EBCDIC US-Canada 
   {437, "IBM437"}, // OEM United States 
   {500, "IBM500"}, // IBM EBCDIC International 
   {708, "ASMO-708"}, // Arabic (ASMO 708) 
   ...
 } </pre><br>  Wanting to make a beautiful column of numbers, it is easy to get carried away and enter '0' at the beginning, making the constant octal. <br><br>  I specify the recommendation.  Align in the code everything that is possible.  But do not align the numbers by appending zeros. <br><br><h2>  5. Do not multiply the string more than once. </h2><br>  Copying lines while programming is inevitable.  But you can secure yourself without pasting a string from the clipboard several times at once.  In most cases, it is better to copy the string, then edit it.  Copy and edit again.  And so on.  So it‚Äôs harder to forget to change something in the string or change it incorrectly.  Consider the sample code: <br><br>  <a href="http://www.viva64.com/ru/d/0114/">V525</a> The code containing the collection of similar blocks.  Check items '1316', '1319', '1318', '1323', '1323', '1317', '1321' in lines 954, 955, 956, 957, 958, 959, 960. clist_modern modern_clcopts.cpp 954 <br><pre>  static INT_PTR CALLBACK DlgProcTrayOpts (...)
 {
   ...
   EnableWindow (GetDlgItem (hwndDlg, IDC_PRIMARYSTATUS), TRUE);
   EnableWindow (GetDlgItem (hwndDlg, IDC_CYCLETIMESPIN), FALSE);
   EnableWindow (GetDlgItem (hwndDlg, IDC_CYCLETIME), FALSE);    
   EnableWindow (GetDlgItem (hwndDlg, IDC_ALWAYSPRIMARY), FALSE);
   EnableWindow (GetDlgItem (hwndDlg, IDC_ALWAYSPRIMARY), FALSE);
   EnableWindow (GetDlgItem (hwndDlg, IDC_CYCLE), FALSE);
   EnableWindow (GetDlgItem (hwndDlg, IDC_MULTITRAY), FALSE);
   ...
 } </pre><br>  Most likely, there is no real error here.  Just work twice with the IDC_ALWAYSPRIMARY element.  However, it is very easy to make mistakes in such blocks of copied lines. <br><br><h2>  6. Expose a high level of warnings to the compiler and use static analyzers. </h2><br>  For many errors it is impossible to give recommendations on how to reduce the likelihood of their occurrence in the code.  Most often, they are typos that both the novice and the most highly qualified programmer allow. <br><br>  However, many of these errors can be found even at the stage of writing code.  First of all, these are compiler warnings.  And in the second - reports from the night run static code analyzers. <br><br>  Now someone will say that this is a poorly hidden advertisement.  But in fact, this is just another recommendation that reduces the number of errors.  If I found errors using static analysis, and I cannot say how to avoid their appearance in the code, then the recommendation is to use code analyzers. <br><br>  Consider some examples of errors that can be quickly identified by source code analyzers: <br><br>  <a href="http://www.viva64.com/ru/d/0153/">V560</a> A part of the conditional expression is always true: 0x01000.  tabsrmm tools.cpp 1023 <br><pre>  #define GC_UNICODE 0x01000

 DWORD dwFlags;

 UINT CreateGCMenu (...)
 {
   ...
   if (iIndex == 1 &amp;&amp; si-&gt; iType! = GCW_SERVER &amp;&amp;
       ! (si-&gt; dwFlags &amp;&amp; GC_UNICODE)) {
   ...
 } </pre><br>  Mistakened.  Instead of the '&amp;' operator, the '&amp;&amp;' operator is used.  How to err when writing code, I do not know.  The correct version of the condition: <br><pre>  (si-&gt; dwFlags &amp; GC_UNICODE) </pre><br>  The following example. <br><br>  <a href="http://www.viva64.com/ru/d/0117/">V528</a> It is odd that pointer to 'char' type is compared with the '\ 0' value.  Probably meant: * str! = '\ 0'.  clist_modern modern_skinbutton.cpp 282 <br><br>  <a href="http://www.viva64.com/ru/d/0117/">V528</a> It is odd that pointer to 'char' type is compared with the '\ 0' value.  Probably meant: * endstr! = '\ 0'.  clist_modern modern_skinbutton.cpp 283 <br><pre>  static char * _skipblank (char * str)
 {
   char * endstr = str + strlen (str);
   while ((* str == '' || * str == '\ t') &amp;&amp; str! = '\ 0') str ++;
   while ((* endstr == '' || * endstr == '\ t') &amp;&amp;
          endstr! = '\ 0' &amp;&amp; endstr &lt;str)
     endstr--;
   ...
 } </pre><br>  In this code, only two asterisks '*' are forgotten for pointer dereferencing.  The result can be fatal.  This code is predisposed to access violation.  The correct code is: <br><pre>  while ((* str == '' || * str == '\ t') &amp;&amp; * str! = '\ 0') str ++;
 while ((* endstr == '' || * endstr == '\ t') &amp;&amp;
        * endstr! = '\ 0' &amp;&amp; endstr &lt;str)
   endstr--; </pre><br>  Here again it is difficult to give advice, apart from using special tools for checking the code. <br><br>  The following example. <br><br>  <a href="http://www.viva64.com/ru/d/0103/">V514</a> Dividing sizeof a pointer 'sizeof (text)' by another value.  There is a possibility of logical error presence.  clist_modern modern_cachefuncs.cpp 567 <br><pre>  #define SIZEOF (X) (sizeof (X) / sizeof (X [0]))

 int Cache_GetLineText (..., LPTSTR text, int text_size, ...)
 {
   ...
   tmi.printDateTime (pdnce-&gt; hTimeZone, _T ("t"), text, SIZEOF (text), 0);
   ...
 } </pre><br>  At first glance, everything is fine.  The text and its length, calculated using the SIZEOF macro, is transferred to the function.  In fact, the macro should be called COUNT_OF, but that's not the point.  The trouble is that we are trying to count the number of characters in the index.  Here, ‚Äúsizeof (LPTSTR) / sizeof (TCHAR)‚Äù is calculated.  A person notices such suspicious places badly, but the compiler and the static analyzer are good.  Corrected code: <br><pre>  tmi.printDateTime (pdnce-&gt; hTimeZone, _T ("t"), text, text_size, 0); </pre><br>  Following example <br><br>  <a href="http://www.viva64.com/ru/d/0153/">V560</a> A part of the conditional expression is always true: 0x29.  icqoscar8 fam_03buddy.cpp 632 <br><pre>  void CIcqProto :: handleUserOffline (BYTE * buf, WORD wLen)
 {
   ...
   else if (wTLVType = 0x29 &amp;&amp; wTLVLen == sizeof (DWORD))
   ...
 } </pre><br>  Here the recommendation is appropriate to write a constant in the condition in the first place.  Here such code simply will not compile: <br><pre>  if (0x29 = wTLVType &amp;&amp; sizeof (DWORD) == wTLVLen) </pre><br>  But many programmers, and I among them, do not like this style.  For example, it prevents me from reading the code, because first I want to know which variable is being compared, and only then with what exactly. <br><br>  If the programmer refuses this style of comparisons, then he is left with either to rely on the compiler / analyzer, or to take risks. <br><br>  By the way, despite the fact that everyone knows about this error, it is not the rarest.  Three more examples from Miranda IM, where the PVS-Studio analyzer issued a warning <a href="http://www.viva64.com/ru/d/0152/">V559</a> : <br><pre>  else if (ft-&gt; ft_magic = FT_MAGIC_OSCAR)
 if (ret = 0) {return (0);}
 if (Drawing-&gt; type = CLCIT_CONTACT) </pre><br>  Analysis of the code also allows you to identify if not errors, then very suspicious places in the code.  For example, in Miranda IM, pointers are used not only as pointers.  If in some places of the code such games look normal, in others they are scary.  An example of code that is extremely alarming to me: <br><br>  <a href="http://www.viva64.com/ru/d/0131/">V542</a> Consider inspecting an odd type cast: 'char *' to 'char'.  clist_modern modern_toolbar.cpp 586 <br><pre>  static void
 sttRegisterToolBarButton (..., char * pszButtonName, ...)
 {
   ...
   if ((BYTE) pszButtonName)
     tbb.tbbFlags = TBBF_FLEXSIZESEPARATOR;
   else
     tbb.tbbFlags = TBBF_ISSEPARATOR;
   ...
 } </pre><br>  In fact, we check that the address of the string is not a multiple of 256. I do not understand what we really wanted to write in the condition.  Perhaps this is even correct, but very doubtful. <br><br>  By analyzing the code, you can find a lot of incorrect conditions.  Example: <br><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions 'user-&gt; statusMessage' operator.  jabber jabber_chat.cpp 214 <br><pre>  void CJabberProto :: GcLogShowInformation (...)
 {
   ...
   if (user-&gt; statusMessage &amp;&amp; user-&gt; statusMessage)
   ...
 } </pre><br>  And so on and so forth.  I can give other examples for a long time, but it does not make sense.  It is important that a large number of errors can be detected using static analysis at the earliest stages. <br><br>  When a static analyzer finds few errors in your program, its use does not seem interesting.  But this is not the right way to reason.  After all, many of the errors that the analyzer could find in the early stages were corrected by sweat and blood, debugging for hours. <br><br>  Static analysis is of more interest in the program development process, and not as one-time checks.  Many errors and typos are in the process of testing and creating unit tests.  But if some of these errors can be found at the stage of writing the code, it will be a huge gain of time and effort.  It's a shame to debug the program for two hours, in order to later notice an extra semicolon ';'  after the 'for' operator.  This error can often be neutralized by spending 10 minutes on a static analysis of files that have been modified during the operation. <br><br><h2>  Conclusion </h2><br>  In this article, I shared only a few thoughts on how to make less mistakes when programming in C ++.  Other thoughts are about to ripen, which I will try to write about in the following articles and notes. <br><br><h2>  PS </h2><br>  It has already become a tradition that after a similar article, someone asks if you have informed the developers of the program / library about errors found.  I will answer in advance the question if we sent a bug report on the Miranda IM project. <br><br>  No, not sent.  This is too resource-intensive task.  The article shows only a small part of what was found.  There are about a hundred fragments in the project, where the code should be corrected, and more than a hundred, where I just don‚Äôt know if this is a mistake or not.  However, a translation of this article will be sent to the authors of Miranda IM and they will be offered a free version of the PVS-Studio analyzer.  If they show interest, they will be able to check the source code themselves and correct what they see fit. <br><br>  It is also worth explaining why I often do not venture to judge the error of a particular piece of code or not.  An example of an ambiguous code: <br><br>  <a href="http://www.viva64.com/ru/d/0112/">V523</a> The 'then' statement is equivalent to the 'else' statement.  scriver msglog.c 695 <br><pre>  if (streamData-&gt; isFirst) {
   if (event-&gt; dwFlags &amp; IEEDF_RTL) {
     AppendToBuffer (&amp; buffer, &amp; bufferEnd, &amp; bufferAlloced, "\\ rtlpar");
   } else {
     AppendToBuffer (&amp; buffer, &amp; bufferEnd, &amp; bufferAlloced, "\\ ltrpar");
   }
 } else {
   if (event-&gt; dwFlags &amp; IEEDF_RTL) {
     AppendToBuffer (&amp; buffer, &amp; bufferEnd, &amp; bufferAlloced, "\\ rtlpar");
   } else {
     AppendToBuffer (&amp; buffer, &amp; bufferEnd, &amp; bufferAlloced, "\\ ltrpar");
   }
 } </pre><br>  Here are two identical code snippets.  Perhaps this is a mistake.  And perhaps now in any branch need the same set of actions.  And the code is written specifically so that later it was easy to modify.  Here it is necessary to know the program in order to sort out this place erroneously or not. </div><p>Source: <a href="https://habr.com/ru/post/115143/">https://habr.com/ru/post/115143/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115136/index.html">Web Platform Installer: review of the third version</a></li>
<li><a href="../115137/index.html">How to write a game in two days</a></li>
<li><a href="../115139/index.html">Supercomputer on the third generation of Loongson processors</a></li>
<li><a href="../115140/index.html">Kyiv.py # 2</a></li>
<li><a href="../115141/index.html">Spy in your pocket. How can your mobile phones give out your geographic coordinates?</a></li>
<li><a href="../115144/index.html">What OS do you use at home?</a></li>
<li><a href="../115147/index.html">MinHash - we identify similar sets</a></li>
<li><a href="../115148/index.html">What are dangerous cheap GPS jammers</a></li>
<li><a href="../115149/index.html">Droider Chart. Release 42</a></li>
<li><a href="../115150/index.html">Installing Remote Server Administration Tools (RSAT) on Windows 7 SP1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>