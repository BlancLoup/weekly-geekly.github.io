<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search for deleted files: FAT file system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to talk about the algorithms that we used when creating the data recovery program Hetman Partition Recovery . 

 But for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search for deleted files: FAT file system</h1><div class="post__text post__text-html js-mediator-article">  In this article, I would like to talk about the algorithms that we used when creating the data recovery program <a href="http://hetmanrecovery.com/ru/">Hetman Partition Recovery</a> . <br><br>  But for a start it is worth saying that the recovery of files is generally possible, because they are stored as blocks of information recorded on hard disk sectors.  Sectors can be arranged either sequentially, one after another, or be randomly scattered across the surface of the disk.  The location of the sectors depends on which particular blocks were free when the file was saved to disk.  If the system does not detect an uninterrupted free block of sectors of sufficient size on a disk in order to save the file as a continuous data sequence, the system will fragment the file, writing its separate parts into free blocks. <br><br>  By the way, in case files are fragmented and the file system is damaged or destroyed (for example, after formatting a disk), data recovery tools use signature search algorithms that read all data from the surface of a hard disk in order to detect known file types. <br><a name="habracut"></a><br>  And here lies the main difficulty.  The signature search algorithms in their work depend on the file header structures, having analyzed which, it is possible to determine the file size.  Possessing information about the location of the header and knowing the exact file size, the programs calculate sectors on the disk, which, in their opinion, contain the file data.  As you understand, these algorithms will work correctly only in conditions when the entire file is stored as a single continuous fragment.  If the file was saved as a set of separate fragments, it will be extremely difficult, almost impossible, to restore it in the absence of a record in the file system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But even for such cases, there are special methods used by special services and criminologists, allowing to restore the contents of some types of files literally in pieces.  Their work is similar to a puzzle collection: various pieces of data are tried in different places of the file, after which the file is analyzed for integrity using heuristic algorithms.  Needless to say, the work of such algorithms is extremely resource-intensive, but at the same time it is so slow and unreliable that it is simply not profitable to use them outside the walls of forensic laboratories. <br><br>  So, in order to navigate the recorded information, Windows creates a record in the file system with an indication of which sectors on the disk is occupied by the contents of a specific file. <br><br>  At the moment when the user deletes the file, Windows does not erase or rewrite the contents of the sectors on the disk.  In the case of deleting a file from the SSD, the memory can be cleared by the <a href="http://ru.wikipedia.org/wiki/TRIM">TRIM</a> function enabled.  The contents of the file entry in the file system are also not deleted, but are subject to modification: the system marks the entry as belonging to the deleted file.  Now Windows can save some other file to this space.  But until this happens, you can try to restore the contents of the deleted file.  Tools for recovering deleted files scan the file system in the search for records marked as deleted.  After analyzing such records, it becomes possible to find out the exact addresses of the sectors on the disk in which the contents of the original file were written.  After a quick additional check - if these sectors do not belong to any other file - the program will read the data from the necessary sectors and save them in a new file.  What happens if there is no record in the file system pointing to the deleted file?  In this case, the simplest tools do not work. <br><br>  Next, I will describe the algorithm for finding and restoring deleted files from the FAT section that we used when developing our program, this algorithm is best described in the book ‚ÄúForensic analysis of file systems‚Äù by Brian Kerri. <br><br>  The Windows partition system contains one or more tables, with each table entry describing one partition.  The entry data usually indicates the starting sector sector, the ending sector sector (or length) and the type of the section. <br><br><img src="https://habrastorage.org/storage2/69a/e23/401/69ae2340160821bd6544936897da1e2d.jpg"><br><br><img src="https://habrastorage.org/storage2/730/672/5b4/7306725b4415e50f3d8fced538e9a6d2.jpg"><br><br>  To search for the file system, our program proceeds from the assumption that there was a file system in each section.  Many file systems start with a data structure with a constant signature.  For example, the FAT file system contains the values ‚Äã‚Äã0x55 and 0xAA in bytes 510 and 511 of the first sector.  The recovery program searches for signatures and determines from them the possible beginning of the partition.  When a signature is detected, additional checks are often performed with ranges of values ‚Äã‚Äãallowed for some fields of the data structure.  For example, one of the fields in the FAT file system determines the number of sectors in a cluster;  the field value is a power of 2 (for example, 1, 2, 4, 8, 16, 32, 64, or 128).  Any other value indicates that the sector is not part of the boot sector of the FAT file system, although it ends with a 0x55AA signature. <br><br><h5>  How to find a file in the FAT table </h5><br>  The basic concept of the FAT file system is that each file and directory is given a data structure called a directory entry.  This structure stores the file name, its size, the starting address of the file content and other metadata.  The contents of files and directories are stored in blocks of data called clusters.  If a file or directory is allocated more than one cluster, the remaining clusters are located using a data structure called FAT.  The FAT structure is used both to identify the next clusters in the files and to determine the allocation status of the clusters. <br><br>  FAT file system is divided into three physical areas.  The first area is called reserved, it stores data from the file system category.  In FAT12 and FAT16, the reserved area occupies only 1 sector, but formally its size is determined in the boot sector.  The second area FAT - contains the main and backup structures FAT.  It begins in the sector following the reserved area, and its size is determined by the number and size of FAT structures.  The third area - the data area contains clusters allocated for storing files and directory contents. <br><br><img src="https://habrastorage.org/storage2/998/d26/eef/998d26eef1f63b2dac549ad2eb54231f.jpg"><br><br>  One of the first tasks in analyzing the FAT file system should be the identification of three physical areas.  The reserved area begins in sector 0 of the file system, and its size is specified in the boot sector.  In FAT 12/16, it usually takes only 1 sector, and in FAT32 several sectors are reserved for it. <br><br>  The FAT area contains one or more FAT structures and starts in the sector following the reserved area.  Its size is calculated by multiplying the number of FAT structures by the size of one structure;  both values ‚Äã‚Äãare stored in the boot sector (reserved area). <br><br><h5>  File recovery </h5><br>  When you delete a file in Windows, its directory entry is marked as unused, and the cluster entries in FAT are reset.  The beginning and size of the file are known, but there is no information about the remaining clusters of the file. <br><br><img src="https://habrastorage.org/storage2/03d/c5e/73f/03dc5e73f1b6b7d8794f5a05dfa69b06.jpg"><br><br>  You can try to restore the contents of the file by reading the data from a known initial cluster.  Regarding the choice of the remaining clusters, the recovery program has two methods: read the amount of data corresponding to the file size, not paying attention to the selection state, or read the data only from free clusters. <br><br>  The second method often leads to success, because it recovers some fragmented files.  Figure 5 explains what is happening: <br>  It shows six file system clusters and three different scenarios.  The file size is 7094 bytes, and the cluster size is 2048 bytes;  therefore, four clusters were allocated for the file.  We also know that the file begins with cluster 56. The light gray clusters represent the actual location of the file contents in each scenario. <br><br>  In the scenario in fig.  A 5 (A) file occupies four contiguous clusters.  In this case, clusters 56-59 are correctly restored in both cases.  In fig.  5 (B) the file was divided into three fragments, and the clusters between the fragments (57 and 60) were allocated to another file during recovery.  In this scenario, the first method restores clusters 56-59 and erroneously includes the contents of cluster 57. The second method correctly restores sectors 56, 58.59 and 61. In fig.  5 (C) shows the scenario in which the same fragments are allocated to the file as in fig.  5 (B), but the clusters between the fragments were not allocated to other files at the time of recovery.  In this scenario, both methods mistakenly restore clusters 56-59, as was done in the previous example.  In the process of restoring the file, other situations are possible, but in them a part of the file is erased, and no other method can recover the data exactly.  Thus, method 2 (taking into account the state of cluster allocation) is able to recover deleted files more often than method 1. <br><br><img src="https://habrastorage.org/storage2/29e/550/328/29e5503289a2d033d07cfda04dd00809.jpg"><br><br>  In conclusion, I will say that the NTFS file system is much more complex than FAT, the search for deleted files in it is the topic of a separate article. <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/177549/">https://habr.com/ru/post/177549/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177529/index.html">The results of the research laboratory of Digital Security for 5 years</a></li>
<li><a href="../177531/index.html">IBM developed a photovoltaic system with an efficiency of ~ 80%</a></li>
<li><a href="../177541/index.html">Resource Management: striving for maximum efficiency</a></li>
<li><a href="../177543/index.html">Competition Apps4Russia 2013 - open data on which you can earn money</a></li>
<li><a href="../177547/index.html">StrongSwan. Remote Access VPN using MSCHAPv2-EAP</a></li>
<li><a href="../177551/index.html">Classification of user authentication mechanisms and their review</a></li>
<li><a href="../177553/index.html">Front-end project management with NPM</a></li>
<li><a href="../177555/index.html">The digest of interesting news and materials from the world of PHP over the past two weeks, ‚Ññ15 (04/08/2013 - 04/22/2013)</a></li>
<li><a href="../177557/index.html">Dzhigurda bought Facebook shares</a></li>
<li><a href="../177559/index.html">Manipulating URLs in JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>