<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ContactManager, part 5. Add work via HTTPS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Before sending our REST service to free floating and making it publicly available, you need to take care of enhancing security and ensure operation vi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ContactManager, part 5. Add work via HTTPS</h1><div class="post__text post__text-html js-mediator-article">  Before sending <a href="http://habrahabr.ru/post/173593/">our REST service</a> to free floating and making it publicly available, you need to take care of enhancing security and ensure operation via HTTPS.  We use Tomcat 7 as the servlet container. <br><br>  The order of action will be as follows: <br><ul><li>  generate a security key </li><li>  add HTTS support in Tomcat </li><li>  add HTTS support in SpringSecurity </li><li>  test (and how without it) </li></ul><br><a name="habracut"></a><br><h6>  We generate a security key </h6><br>  The keytool utility from the standard JRE delivery will help us generate the key.  If JAVA_HOME is added to path, then just run keytool from the command line, if not, then go to the <code>%JAVA_HOME%/bin</code> and launch keytool from there.  For MS Windows, the command will look something like this: <br><pre> <code class="bash hljs">keytool -genkey -<span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> ContactManager -keyalg RSA -keystore c:/contactmanager.keystore</code> </pre><br>  <code>alias</code> - unique key identifier <br>  <code>keyalg</code> - generation algorithm.  Possible RSA, DSA, DES values <br>  <code>keystore</code> - file path <br><br>  After launching, the program will ask you to enter a password and several parameters, it is desirable to remember the password, it will still be useful to us, other values ‚Äã‚Äãcan be arbitrary: who, what, where, country and so on  As a result, we get the file on the disk in the specified directory.  The key is ready. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Changing Tomkat settings </h6><br>  Open the file <code>%CATALINA_HOME%/conf/server.xml</code> and find the commented out piece <br><pre> <code class="xml hljs"> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Define a SSL HTTP/1.1 Connector on port 8443 This connector uses the JSSE configuration, when using APR, the connector should be using the OpenSSL style configuration described in the APR documentation --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- &lt;Connector port="8443" protocol="HTTP/1.1" SSLEnabled="true" maxThreads="150" scheme="https" secure="true" clientAuth="false" sslProtocol="TLS" /&gt; --&gt;</span></span></code> </pre><br>  Remove comments from the Connector element and add a couple of attributes for our key: <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Connector</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"8443"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SSLEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocol</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"HTTP/1.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxThreads</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"150"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">secure</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">keystoreFile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"c:\contactmanager.keystore"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">keystorePass</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sslProtocol</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TLS"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  <code>keystorePass</code> - the password that we entered when generating the key.  Yes, it is stored in clear form.  There are ways to solve this problem, but for now let's leave it that way.  Actually everything can be run.  Oops ... <br><pre> <code class="bash hljs">INFO: Initializing ProtocolHandler [<span class="hljs-string"><span class="hljs-string">"http-apr-8080"</span></span>]  28, 2013 11:43:04 AM org.apache.coyote.AbstractProtocol init INFO: Initializing ProtocolHandler [<span class="hljs-string"><span class="hljs-string">"http-apr-8443"</span></span>]  28, 2013 11:43:04 AM org.apache.coyote.AbstractProtocol init SEVERE: Failed to initialize end point associated with ProtocolHandler [<span class="hljs-string"><span class="hljs-string">"http-apr-8443"</span></span>] java.lang.Exception: Connector attribute SSLCertificateFile must be defined when using SSL with APR at org.apache.tomcat.util.net.AprEndpoint.bind(AprEndpoint.java:507) ...</code> </pre><br>  Did not work out.  Googling gives the answer that <code>protocol="HTTP/1.1"</code> needs to be replaced with <code>protocol="org.apache.coyote.http11.Http11Protocol"</code> .  We start, now everything is in order. <br><pre> <code class="bash hljs">...  28, 2013 11:56:41 AM org.apache.coyote.AbstractProtocol init INFO: Initializing ProtocolHandler [<span class="hljs-string"><span class="hljs-string">"http-apr-8080"</span></span>]  28, 2013 11:56:41 AM org.apache.coyote.AbstractProtocol init INFO: Initializing ProtocolHandler [<span class="hljs-string"><span class="hljs-string">"http-bio-8443"</span></span>]  28, 2013 11:56:41 AM org.apache.coyote.AbstractProtocol init INFO: Initializing ProtocolHandler [<span class="hljs-string"><span class="hljs-string">"ajp-apr-8009"</span></span>]  28, 2013 11:56:41 AM org.apache.catalina.startup.Catalina load INFO: Initialization processed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1909 ms ...</code> </pre><br>  When you go to <a href="https://localhost:8443/">https: // localhost: 8443 /, the</a> browser warns about the doubtfulness of our certificate, but we ignore its warnings, click ‚Äúcontinue at your own risk‚Äù and see the root page of Tomkat. <br><br><h5>  Configuring Spring Security </h5><br>  Here, too, everything is quite simple.  In the security.xml file, the attribute <code>requires-channel="https"</code> must be added to each of the critical URLs of the web service.  It will look like this: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intercept-url</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/ws/index*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">access</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hasAnyRole('ROLE_USER','ROLE_ANONYMOUS')"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">requires-channel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intercept-url</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/ws/add*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">access</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hasRole('ROLE_USER')"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">requires-channel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intercept-url</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/ws/delete/*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">access</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hasRole('ROLE_ADMIN') "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">requires-channel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br><h5>  We are testing </h5><br>  We also hid the resource <code>/ws/index</code> for <code>HTTPS</code> , so we <code>index_user1()</code> try the <code>index_user1()</code> test.  Error, which, however, is expected.  The question is what kind of error and how to fix it.  JUnit swears at the response curve <br><pre> <code class="bash hljs">com.fasterxml.jackson.databind.JsonMappingException: No content to map due to end-of-input at [Source: java.io.StringReader@1841d1d3; line: 1, column: 1]</code> </pre><br>  but it is clear that this is not the case.  We look at the log in the console, there is already more interesting, there is an error status, 302: <br><pre> <code class="bash hljs">... MockHttpServletResponse: Status = 302 Error message = null Headers = {Location=[https://localhost/ws/index]} Content <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = null Body = Forwarded URL = null Redirected URL = https://localhost/ws/index Cookies = []</code> </pre><br>  Apparently, we somehow do not form a query in the test.  Go to the builder <a href="">MockHttpServletRequestBuilder</a> and study the list of its methods, look for something related to security.  Yeah, here it is. <br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Set the secure property of the {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> ServletRequest} indicating use of a * secure channel, such as HTTPS. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> secure whether the request is using a secure channel */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MockHttpServletRequestBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">secure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> secure)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.secure = secure; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }</code> </pre><br>  Looks like what you need.  Add this method to the call chain in the builder. <br><pre> <code class="java hljs"> def result = mockMvc.perform(MockMvcRequestBuilders.get(<span class="hljs-string"><span class="hljs-string">"/ws/index"</span></span>) .secure(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;---------    HTTPS .with(SecurityRequestPostProcessors.userDetailsService(USER1))) .andDo(MockMvcResultHandlers.print()) .andReturn()</span></span></code> </pre><br>  Hurray, it works!  Fine.  Modify the rest of the WS tests in the same way.  Now we are transferring authorization data over a secure connection and we can safely lay out our REST service outside.  But this concerns only REST requests, the old Form-based authentication is not protected by us and remains a vulnerability.  I propose to solve this problem on my own. <br><br>  What else can be done?  Now we are forced to specify a username and password for each request to a protected resource.  Plus, users are rigidly registered in the file seciruty.xml, and suddenly (though why suddenly?), Our service will become popular?  Therefore, in the next iteration, we will do the following: transfer the user data to the database and change the authentication scheme to work with Auth Token, in which we will store the user session data. <br><br>  To be continued. </div><p>Source: <a href="https://habr.com/ru/post/174513/">https://habr.com/ru/post/174513/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../174499/index.html">High Level APIs for Linux Containers</a></li>
<li><a href="../174501/index.html">GNOME 3.8 released</a></li>
<li><a href="../174503/index.html">Digitimes: Windows RT will no longer</a></li>
<li><a href="../174505/index.html">The Chinese, LEDs and giant screens - a short photo report with LED China</a></li>
<li><a href="../174509/index.html">Resource Odnoklassniki blocked</a></li>
<li><a href="../174519/index.html">In the city of Lutsk (Ukraine) public transport equipped with GPS devices</a></li>
<li><a href="../174521/index.html">Technical debt will ruin you. If you allow, of course</a></li>
<li><a href="../174523/index.html">"Tongue twisters". Part 1: From idea to design</a></li>
<li><a href="../174525/index.html">How we learned to work with freelancers</a></li>
<li><a href="../174531/index.html">ASP.NET MVC 4 RAZOR Dynamic Multi-Level Database Menu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>