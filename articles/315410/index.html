<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bilateral data binding with ECMAScript-2015 without proxy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear readers of Habr. This article is a kind of opposition to the article ‚ÄúOne-way data binding with ECMAScript-2015 Proxy‚Äù, which I recently r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bilateral data binding with ECMAScript-2015 without proxy</h1><div class="post__text post__text-html js-mediator-article">  Hello, dear readers of Habr.  This article is a kind of opposition to the article <a href="https://habrahabr.ru/company/rtl-service/blog/309978/">‚ÄúOne-way data binding with ECMAScript-2015 Proxy‚Äù, which</a> I recently read.  If it is interesting to you to learn how to make a bilateral asynchronous binding without unnecessary structures in the form of a Proxy, then I ask for cat. <br><a name="habracut"></a><br>  Those who are not interested in reading the letters, I invite you to immediately push on these very letters <a href="http://plnkr.co/edit/YXC6J0h7kvyWxSE5xwW8%3Fp%3Dpreview">DEMO binding</a> <br><br>  So, what embarrassed me in that article and motivated me to write my own: <br><br><ol><li>  The author talks about data binding, but describes the implementation of <b>observer</b> a.  Those.  Subscription to change the properties of objects.  Of course, with the help of callbacks, you can implement the binding, but somehow you want something simpler.  The term binding itself implies a simple indication of the correspondence of the value of one storage unit to the value of another. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li><li>  Not very successful implementation of asynchrony - <blockquote>  setTimeout (() =&gt; listener (event), 0); </blockquote>  With a minimum timeout, everything is fine, the functions of the subscribers are called one after another through a constant minimum interval (sort of like 4mc).  But what if we need to increase it, for example, to 500 ms.  Then there will simply be a delay for a given interval and then all functions will be called, but also with a minimum interval.  And I would like to specify the interval, namely, between calls to subscribers. <br><br></li><li>  And a little more - the insecurity of the shared storage fields from direct rewriting; there is no implementation of the DOM ‚Üí JS bindings, DOM ‚Üí DOM bindings. </li></ol><br>  Well, enough to be clever, it's time to show your "creativity".  Let's start with the formulation of the problem. <br><br>  <b>Given:</b> <br><br><ul><li>  "Pure" JS objects and DOM elements. </li></ul><br>  <b>The task:</b> <br><br><ul><li>  Implement two-way data binding between any types of objects (DOM - JS, JS - DOM, JS - JS, DOM - DOM). </li><li>  Implement asynchronous bindings with the ability to specify a timeout </li><li>  Implement the possibility of subscriptions to changes in properties (hanging functions of observers) to extend the functionality of the bindings. </li><li>  Implement a distributed repository of bindings with direct write protection. </li></ul><br>  <b>Decision:</b> <br><br>  Basic ideas for implementation: <br><br><ol><li>  No shared storage will be created; each object will store its bindings itself.  Create a separate class of such objects.  The constructor of this class will create new objects or expand existing objects with the structures we need. <br><br></li><li>  The necessary functionality is to intercept access to the properties of an object, but without creating unnecessary structures in the form of <b>proxy</b> objects.  For this, the getters and setters functionality ( <b>Object.defineProperty</b> ) defined in ECMAScript 5.1 is perfect. <br><br></li><li>  For sequential asynchronous binding, we implement queues.  Let's try using <b>setTimeout + Promises</b> for this. </li></ol><br>  Implementation: <br><br><ol><li>  Binder class structure: <br><img src="http://priladnykh.ru/images/articles/class.jpg" alt="image"><br>  <i>Fig.</i>  <i>1 - class Binder diagram</i> <br><br>  Static: <br><br><ul><li>  <b>hash</b> - calculates the hash function, will be used to identify the functions of observers </li><li>  <b>delay</b> - timeout in the asynchronous queue </li><li>  <b>queue</b> - creates an asynchronous queue </li><li>  <b>timeout</b> - getter / setter for _timeout </li><li>  <b>_timeout</b> - default timeout </li><li>  <b>prototypes</b> - stores prototypes for "extended" objects </li><li>  <b>createProto</b> - creates prototypes for "extended" objects </li></ul><br>  Instance: <br><br><ul><li>  <b>‚Äú</b> Transformed <b>properties‚Äù</b> - properties of objects converted to getter / setter </li><li>  <b>_binder</b> - service information </li><li>  <b>emitter</b> - points to the object that is currently initiating the binding </li><li>  <b>bindings</b> - storage bindings </li><li>  <b>watchers</b> - the repository of observers </li><li>  <b>properties</b> - property storage - values ‚Äã‚Äãthat were converted to getter / setter </li><li>  <b>_bind / _unbind</b> - the implementation of binding / decoupling </li><li>  <b>_watch / _unwatch</b> - implementation of subscription / optical </li></ul><br></li><li>  Constructor class: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(obj){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> instance; <span class="hljs-comment"><span class="hljs-comment">/*1*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj) { instance = Binder.createProto(obj, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { instance = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*2*/</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(instance, <span class="hljs-string"><span class="hljs-string">'_binder'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: {} }); <span class="hljs-comment"><span class="hljs-comment">/*3*/</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperties(instance._binder, { <span class="hljs-string"><span class="hljs-string">'properties'</span></span>: { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: {} }, <span class="hljs-string"><span class="hljs-string">'bindings'</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: {} }, <span class="hljs-string"><span class="hljs-string">'watchers'</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: {} }, <span class="hljs-string"><span class="hljs-string">'emitter'</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">writable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: {} } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } <span class="hljs-comment"><span class="hljs-comment">/*1*/</span></span> ‚Äî ,      ,    .       .   <span class="hljs-string"><span class="hljs-string">`createProto`</span></span> .  <span class="hljs-comment"><span class="hljs-comment">/*8*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*2*/</span></span> ‚Äî <span class="hljs-comment"><span class="hljs-comment">/*3*/</span></span> ‚Äî   - <span class="hljs-string"><span class="hljs-string">`_bunder`</span></span>,      ,     ,   .  ¬´emitter¬ª     ,     .     ,       (<span class="hljs-string"><span class="hljs-string">`writable: false`</span></span>).</code> </pre> <br></li><li>  Class static methods: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*4*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> get timeout(){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Binder._timeout || <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*5*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> set timeout(ms){ <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">'_timeout'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: ms }); } <span class="hljs-comment"><span class="hljs-comment">/*6*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> delay(ms = Binder.timeout){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res, rej</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ms &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>){ setTimeout(res, ms); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res(); } }); } <span class="hljs-comment"><span class="hljs-comment">/*7*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> get queue(){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(); } <span class="hljs-comment"><span class="hljs-comment">/*4*/</span></span>-<span class="hljs-comment"><span class="hljs-comment">/*5*/</span></span>‚Äî       <span class="hljs-string"><span class="hljs-string">`_timeout`</span></span>       .  ,       ,   ES6        -. <span class="hljs-comment"><span class="hljs-comment">/*6*/</span></span>-<span class="hljs-comment"><span class="hljs-comment">/*7*/</span></span>  queue    ,     .  <span class="hljs-string"><span class="hljs-string">`delay`</span></span>  ,   <span class="hljs-string"><span class="hljs-string">""</span></span>        .       .</code> </pre><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*8*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> createProto(obj, instance){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> className = obj.constructor.name; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prototypes){ <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">'prototypes'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>() }); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prototypes.has(className)){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> descriptor = { <span class="hljs-string"><span class="hljs-string">'constructor'</span></span>: { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: obj.constructor } }; <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyNames(instance.__proto__).forEach( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> prop </span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(prop !== <span class="hljs-string"><span class="hljs-string">'constructor'</span></span>){ descriptor[prop] = { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: instance[prop] }; } } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prototypes.set( className, <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.create(obj.__proto__, descriptor) ); } obj.__proto__ = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prototypes.get(className); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj; } <span class="hljs-comment"><span class="hljs-comment">/*8*/</span></span>‚Äî    .        .      ,         - <span class="hljs-string"><span class="hljs-string">`Binder.prototypes`</span></span></code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*9*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> transform(obj, prop){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> descriptor, nativeSet; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> newGet = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.properties[prop];}; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> newSet = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*10*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> queues = [Binder.queue, Binder.queue]; <span class="hljs-comment"><span class="hljs-comment">/*11*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.properties[prop] === value){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.properties, prop, { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: value }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.bindings[prop]){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.bindings[prop].forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [prop, ms], boundObj </span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*12*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(boundObj === <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.emitter) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.emitter = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(boundObj[prop] === value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*13*/</span></span> queues[<span class="hljs-number"><span class="hljs-number">0</span></span>] = queues[<span class="hljs-number"><span class="hljs-number">0</span></span>] .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> Binder.delay(ms) ) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { boundObj._binder.emitter = obj; boundObj[prop] = value; }); }); queues[<span class="hljs-number"><span class="hljs-number">0</span></span>] = queues[<span class="hljs-number"><span class="hljs-number">0</span></span>].catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err) ); } <span class="hljs-comment"><span class="hljs-comment">/*14*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.watchers[prop] ){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.watchers[prop].forEach( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [cb, ms] </span></span></span><span class="hljs-function">) =&gt;</span></span> { queues[<span class="hljs-number"><span class="hljs-number">1</span></span>] = queues[<span class="hljs-number"><span class="hljs-number">1</span></span>] .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> Binder.delay(ms) ) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { cb(value); }); }); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.watchers[<span class="hljs-string"><span class="hljs-string">'*'</span></span>] ){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.watchers[<span class="hljs-string"><span class="hljs-string">'*'</span></span>].forEach( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [cb, ms] </span></span></span><span class="hljs-function">) =&gt;</span></span> { queues[<span class="hljs-number"><span class="hljs-number">1</span></span>] = queues[<span class="hljs-number"><span class="hljs-number">1</span></span>] .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> Binder.delay(ms) ) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { cb(value); }); }); } queues[<span class="hljs-number"><span class="hljs-number">1</span></span>] = queues[<span class="hljs-number"><span class="hljs-number">1</span></span>].catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err)); }; <span class="hljs-comment"><span class="hljs-comment">/*15*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(obj.constructor.name.indexOf(<span class="hljs-string"><span class="hljs-string">'HTML'</span></span>) === <span class="hljs-number"><span class="hljs-number">-1</span></span>){ descriptor = { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">enumerable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">get</span></span>: newGet, <span class="hljs-attr"><span class="hljs-attr">set</span></span>: newSet }; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*16*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">'value'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> obj) { descriptor = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyDescriptor( obj.constructor.prototype, <span class="hljs-string"><span class="hljs-string">'value'</span></span> ); obj.addEventListener(<span class="hljs-string"><span class="hljs-string">'keydown'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">evob</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(evob.key.length === <span class="hljs-number"><span class="hljs-number">1</span></span>){ newSet.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.value + evob.key); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Binder.queue.then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { newSet.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.value); }); } }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { descriptor = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyDescriptor( Node.prototype, <span class="hljs-string"><span class="hljs-string">'textContent'</span></span> ); } <span class="hljs-comment"><span class="hljs-comment">/*17*/</span></span> nativeSet = descriptor.set; descriptor.set = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">)</span></span>{ nativeSet.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); newSet.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); }; } <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(obj._binder.properties, prop, { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: obj[prop] }); <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(obj, prop, descriptor); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj; } <span class="hljs-comment"><span class="hljs-comment">/*9*/</span></span> -  <span class="hljs-string"><span class="hljs-string">`transform`</span></span>   .   JS ,      <span class="hljs-string"><span class="hljs-string">`obj._binder.properties`</span></span>,     /.    DOM ,      /. <span class="hljs-comment"><span class="hljs-comment">/*10*/</span></span> -        . <span class="hljs-comment"><span class="hljs-comment">/*11*/</span></span> -                . <span class="hljs-comment"><span class="hljs-comment">/*12*/</span></span> -      -      .         <span class="hljs-string"><span class="hljs-string">`obj._binder.emitter`</span></span>  .          .        . <span class="hljs-comment"><span class="hljs-comment">/*13*/</span></span> -         . <span class="hljs-comment"><span class="hljs-comment">/*14*/</span></span> -          . <span class="hljs-comment"><span class="hljs-comment">/*15*/</span></span> -      DOM <span class="hljs-comment"><span class="hljs-comment">/*16*/</span></span> -    DOM .     <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-string"><span class="hljs-string">`input`</span></span>, <span class="hljs-string"><span class="hljs-string">`textarea`</span></span>   <span class="hljs-string"><span class="hljs-string">`value`</span></span>    <span class="hljs-string"><span class="hljs-string">`textContent`</span></span>.  <span class="hljs-string"><span class="hljs-string">""</span></span>  / <span class="hljs-string"><span class="hljs-string">`value`</span></span>    (. <span class="hljs-string"><span class="hljs-string">`. 2`</span></span>). ,  <span class="hljs-string"><span class="hljs-string">`input`</span></span>   <span class="hljs-string"><span class="hljs-string">`HTMLInputElementPrototype`</span></span>. <span class="hljs-string"><span class="hljs-string">`textContent`</span></span>   /    <span class="hljs-string"><span class="hljs-string">`Node.prototype`</span></span>(. <span class="hljs-string"><span class="hljs-string">`. 3`</span></span>).    /   <span class="hljs-string"><span class="hljs-string">`Object.getOwnPropertyDescriptor`</span></span>.     <span class="hljs-string"><span class="hljs-string">""</span></span>      . <span class="hljs-comment"><span class="hljs-comment">/*17*/</span></span> -     ,      . <span class="hljs-comment"><span class="hljs-comment">/**/</span></span> -  <span class="hljs-string"><span class="hljs-string">`newSet`</span></span>  <span class="hljs-string"><span class="hljs-string">`newGet`</span></span>, ,     .</code> </pre><br><div style="text-align:center;"><img src="http://priladnykh.ru/images/articles/HTMLInputElement.jpg" alt="image"></div><br>  <i>Fig.2 - inheritance of the property `value`</i> <br><br><div style="text-align:center;"><img src="http://priladnykh.ru/images/articles/HTMLDivElement.jpg" alt="image"></div><br>  <i>Fig.3 - inheritance of the `textContent` property, by the example of the` div`</i> <br><br>  For clarity, I will give another image explaining the transformation of the DOM element, for example, the element ‚Äúdiv‚Äù ( <i><b>Fig. 4</b></i> ) <br><br><div style="text-align:center;"><img src="http://priladnykh.ru/images/articles/transformation.jpg" alt="image"></div><br>  <i>Figure 4 - scheme of the transformation of the DOM element.</i> <br><br>  Now about asynchronous queues.  In the beginning, I intended to make one execution queue for all the bindings of a specific property, but then an unpleasant effect appeared, see <i><b>fig.</b></i>  <i><b>5</b></i>  Those.  the first binding will wait for the entire queue to be executed before updating the value again.  In the case of separate queues, we know for sure that the first binding will be updated at the specified interval, and all subsequent ones will be updated through the sum of the intervals of the previous binding. <br><br><div style="text-align:center;"><img src="http://priladnykh.ru/images/articles/queues.jpg" alt="image"></div><br>  <i>Fig.5 Comparison of the common execution queue with separate ones</i> <br><br></li><li>  <b>Binder</b> class instance methods: <br><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">/*18*/</span></span> _bind(ownProp, obj, objProp, ms){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.bindings[ownProp]) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.bindings[ownProp] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>(); Binder.transform(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, ownProp); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.bindings[ownProp].has(obj)){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !!<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Binding for this object is already set'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.bindings[ownProp].set(obj, [objProp, ms]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !obj._binder.bindings[objProp] || !obj._binder.bindings[objProp].has(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) { obj._bind(objProp, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, ownProp, ms); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*19*/</span></span> _unbind(ownProp, obj, objProp){ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.bindings[ownProp].delete(obj); obj._binder.bindings[objProp].delete(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !!<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(e); } }; <span class="hljs-comment"><span class="hljs-comment">/*20*/</span></span> _watch(prop = <span class="hljs-string"><span class="hljs-string">'*'</span></span>, cb, ms){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cbHash = Binder.hash(cb.toString().replace(<span class="hljs-regexp"><span class="hljs-regexp">/\s/g</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.watchers[prop]) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.watchers[prop] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(prop === <span class="hljs-string"><span class="hljs-string">'*'</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).forEach( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function"> =&gt;</span></span> { Binder.transform(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, item); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Binder.transform(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, prop); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.watchers[prop].has(cbHash)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !!<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Watchers is already set'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.watchers[prop].set(cbHash, [cb, ms]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cbHash; }; <span class="hljs-comment"><span class="hljs-comment">/*21*/</span></span> _unwatch(prop = <span class="hljs-string"><span class="hljs-string">'*'</span></span>, cbHash = <span class="hljs-number"><span class="hljs-number">0</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._binder.watchers[prop].delete(cbHash); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !!<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(e); } }; <span class="hljs-comment"><span class="hljs-comment">/*18*/</span></span> - <span class="hljs-comment"><span class="hljs-comment">/*19*/</span></span> -  /.          ,   ,   ,       .           () . . <span class="hljs-string"><span class="hljs-string">`. 6`</span></span> <span class="hljs-comment"><span class="hljs-comment">/*20*/</span></span> - <span class="hljs-comment"><span class="hljs-comment">/*21*/</span></span> -  /.           (   - <span class="hljs-string"><span class="hljs-string">"*"</span></span>).          .        .</code> </pre><br><div style="text-align:center;"><img src="http://priladnykh.ru/images/articles/binding.jpg" alt="image"></div><br>  <i>Fig.6 Meet the cat Binder</i> <br></li></ol><br><br>  <b>Results:</b> <br><br><h5>  Good: </h5><br><ol><li>  Protection of properties from direct rewriting; </li><li>  The mechanism of subscriptions to change the properties of the object; </li><li>  Customizable asynchronous bind and subscription queues; </li><li>  Bilateral "honest" binding, i.e.  we simply indicate the correspondence of the value of one to another. </li></ol><br><h5>  Poorly : </h5><br><ol><li>  For DOM elements, binding only to the <b>'value'</b> and <b>'textContent' properties</b> ; </li><li>  Ability to specify only one binding between two objects; </li></ol><br>  <b>PS</b> This is by no means a ready-to-use solution.  This is just the realization of some thinking. <br><br>  Thank you all for your attention.  Comments and criticism are welcome. <br>  Everything!  Finally the end :) </div><p>Source: <a href="https://habr.com/ru/post/315410/">https://habr.com/ru/post/315410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315400/index.html">Constantly invest in your education</a></li>
<li><a href="../315402/index.html">Backup VM ESXi with Bareos</a></li>
<li><a href="../315404/index.html">We invite you to a meeting with practitioners defenders of ASU-TP</a></li>
<li><a href="../315406/index.html">Implementing a pull-down interface in an iOS application</a></li>
<li><a href="../315408/index.html">Zvooq filed a lawsuit for $ 29 million to the ‚Äúlargest Russian public corporation‚Äù - ‚ÄúYandex‚Äù</a></li>
<li><a href="../315414/index.html">Pro web client 1C</a></li>
<li><a href="../315416/index.html">Personal experience of receiving the Blue Card in Germany 2015-2016. Part 3: Arriving in Germany</a></li>
<li><a href="../315418/index.html">Polish clouds. Price notes (not only for Ukrainians)</a></li>
<li><a href="../315420/index.html">How to create elusive goals in the game 2016 Hitman</a></li>
<li><a href="../315422/index.html">We control the quality of the code using the SonarQube platform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>