<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mail collector (making simple things difficult)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As a preface 
 Probably, many of you in your practice faced the task of collecting mail from a number of mailboxes. Why it may be necessary? Probably ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mail collector (making simple things difficult)</h1><div class="post__text post__text-html js-mediator-article"><h4>  As a preface </h4><br>  Probably, many of you in your practice faced the task of collecting mail from a number of mailboxes.  Why it may be necessary?  Probably because it is a universal mechanism for exchanging data between systems.  Many libraries for any languages ‚Äã‚Äãthat implement SMTP, POP3, IMAP, ready-made solutions for the implementation of the stack of messages (as I called the mailbox is difficult ...), etc. <br><br>  It is not surprising that many integration tasks are realized through mail.  Then a service enters into the business, which is able to quickly pick up, categorize and carry out the necessary actions. <br><br>  To whom the following code is sufficient, they may not read further: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mailbox <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> mailboxes) <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pop3Client()) { client.Connect(Hostname, Port, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); client.Authenticate(User, Password); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> count = client.GetMessageCount(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; i++) { Mail = client.GetMessage(i + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cat = SortMail(Mail); DoSomething(Mail, cat); } }</code> </pre> <br><a name="habracut"></a><br><h2>  What do we do </h2><br>  Immediately make a number of assumptions: <br>  1) Collect mail for multiple systems.  Maybe in the future for a few more.  And yet ... In general, the solution should be universal; <br>  2) There will probably be a lot of mail - it follows from point 1 (otherwise I would not write this post); <br>  3) Mail will have to be parsed; <br>  4) All service boxes - users do not climb there. <br><br><h2>  What will we use </h2><br>  The system should work 24/7, so we will implement it as a Windows Service.  For these purposes, I propose to immediately use <a href="https://github.com/Topshelf/Topshelf">TopShelf</a> . <br><br>  Of course, everything must be parallelized.  This is <a href="https://msdn.microsoft.com/en-us/library/hh228603(v%3Dvs.110).aspx">where</a> my favorite <a href="https://msdn.microsoft.com/en-us/library/hh228603(v%3Dvs.110).aspx">TPL DataFlow</a> library comes onto the scene. <br><br>  We will pick up mail on POP3.  All the ‚Äúfancy things‚Äù of IMAP in this task are superfluous - it is necessary as soon as possible and easier to pick up the source of the letter and delete it on the server.  POP3 is enough for the eyes.  We use <a href="https://www.nuget.org/packages/OpenPop.NET/">OpenPop.NET</a> . <br><br>  As already mentioned, the mail will parse.  Maybe through Regex, can custom logic ... you never know what.  That is why you need to flexibly and quickly push up new rules using plug-ins.  This is where the <a href="https://msdn.microsoft.com/ru-ru/library/dd460648(v%3Dvs.110).aspx">Managed Extensibility Framework</a> helps. <br><br>  Logs write via <a href="http://nlog-project.org/">NLog</a> . <br><br>  As an optional fix monitoring in <a href="http://www.zabbix.com/ru/">Zabbix</a> .  (We are going to work 24/7 and give out a vaunted speed - you need to follow this). <br><br><h2>  Go </h2><br>  We create the usual console application.  Open the NuGet console and install all the necessary packages: <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package Nlog <span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package OpenPop.NET <span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package TopShelf <span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package Microsoft.TPL.DataFlow</code> </pre><br>  Go to the project folder, create App.Debug.config and App.Release.config.  We unload the project from the studio, open its code (hereafter, TopCrawler.csproj).  In the section with the config add: <br><br><div class="spoiler">  <b class="spoiler_title">Configurations</b> <div class="spoiler_text"><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"App.Debug.config"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DependentUpon</span></span></span><span class="hljs-tag">&gt;</span></span>App.config<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DependentUpon</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"App.Release.config"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DependentUpon</span></span></span><span class="hljs-tag">&gt;</span></span>App.config<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DependentUpon</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  And below its own target for MSBuild: <br><br><div class="spoiler">  <b class="spoiler_title">Transform target</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UsingTask</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TransformXml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AssemblyFile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(MSBuildExtensionsPath32)\Microsoft\VisualStudio\v$(VisualStudioVersion)\Web\Microsoft.Web.Publishing.Tasks.dll"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AfterCompile"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Exists('App.$(Configuration).config')"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--Generate transformed app config in the intermediate directory--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TransformXml</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"App.config"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Destination</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(IntermediateOutputPath)$(TargetFileName).config"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Transform</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"App.$(Configuration).config"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--Force build process to use the transformed configuration file from now on.--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AppConfigWithTargetPath</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"App.config"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AppConfigWithTargetPath</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(IntermediateOutputPath)$(TargetFileName).config"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetPath</span></span></span><span class="hljs-tag">&gt;</span></span>$(TargetFileName).config<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetPath</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AppConfigWithTargetPath</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  <i>Personally, I used it in this way - in the old way - to add a transformation of configs for the separation of environments.</i> <br>  For convenience, I suggest strongly-type configs.  A separate class will read the configuration.  (On the theoretical aspects of such a decision, you can talk in the comments).  Configs, logs, monitoring is an excellent reason to implement the Singleton pattern. <br><br>  Create a folder of the same name in the project (there must be an order).  Inside we create 3 classes - Config, Logger, Zabbix.  Our logger: <br><br><div class="spoiler">  <b class="spoiler_title">Logger</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Logger</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> NLog.Logger Log { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> NLog.Logger Archive { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Logger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Log = LogManager.GetLogger(<span class="hljs-string"><span class="hljs-string">"Global"</span></span>); Archive = LogManager.GetLogger(<span class="hljs-string"><span class="hljs-string">"Archivator"</span></span>); } }</code> </pre><br></div></div><br>  Monitoring using Zabbix deserves a separate post, so I‚Äôll just leave here the class that implements the agent: <br><br><div class="spoiler">  <b class="spoiler_title">Zabbix</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">namespace TopCrawler.Singleton { /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// Singleton: zabbix sender <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; static <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Zabbix { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static ZabbixSender Sender { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } static Zabbix() { Sender = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ZabbixSender(Config.ZabbixServer, Config.ZabbixPort); } } struct ZabbixItem { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string Host; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string Key; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ZabbixSender { <span class="hljs-type"><span class="hljs-type">internal</span></span> struct SendItem { // ReSharper <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> InconsistentNaming - Zabbix <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> sensitive <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string host; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string key; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string clock; // ReSharper restore InconsistentNaming } #pragma <span class="hljs-built_in"><span class="hljs-built_in">warning</span></span> <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-number"><span class="hljs-number">0649</span></span> <span class="hljs-type"><span class="hljs-type">internal</span></span> struct ZabbixResponse { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string Response; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span>; } #pragma <span class="hljs-built_in"><span class="hljs-built_in">warning</span></span> restore <span class="hljs-number"><span class="hljs-number">0649</span></span> #region <span class="hljs-comment"><span class="hljs-comment">--- Constants --- public const string DefaultHeader = "ZBXD\x01"; public const string SendRequest = "sender data"; public const int DefaultTimeout = 10000; #endregion #region --- Fields --- private readonly DateTime _dtUnixMinTime = DateTime.SpecifyKind(new DateTime(1970, 1, 1), DateTimeKind.Utc); private readonly int _timeout; private readonly string _zabbixserver; private readonly int _zabbixport; #endregion #region --- Constructors --- public ZabbixSender(string zabbixserver, int zabbixport) : this(zabbixserver, zabbixport, DefaultTimeout) { } public ZabbixSender(string zabbixserver, int zabbixport, int timeout) { _zabbixserver = zabbixserver; _zabbixport = zabbixport; _timeout = timeout; } #endregion #region --- Methods --- public string SendData(ZabbixItem itm) { return SendData(new List&lt;ZabbixItem&gt;(1) { itm }); } public string SendData(List&lt;ZabbixItem&gt; lstData) { try { var serializer = new JavaScriptSerializer(); var values = new List&lt;SendItem&gt;(lstData.Count); values.AddRange(lstData.Select(itm =&gt; new SendItem { host = itm.Host, key = itm.Key, value = itm.Value, clock = Math.Floor((DateTime.Now.ToUniversalTime() - _dtUnixMinTime).TotalSeconds).ToString(CultureInfo.InvariantCulture) })); var json = serializer.Serialize(new { request = SendRequest, data = values.ToArray() }); var header = Encoding.ASCII.GetBytes(DefaultHeader); var length = BitConverter.GetBytes((long)json.Length); var data = Encoding.ASCII.GetBytes(json); var packet = new byte[header.Length + length.Length + data.Length]; Buffer.BlockCopy(header, 0, packet, 0, header.Length); Buffer.BlockCopy(length, 0, packet, header.Length, length.Length); Buffer.BlockCopy(data, 0, packet, header.Length + length.Length, data.Length); using (var socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp)) { socket.Connect(_zabbixserver, _zabbixport); socket.Send(packet); //Header var buffer = new byte[5]; ReceivData(socket, buffer, 0, buffer.Length, _timeout); if (DefaultHeader != Encoding.ASCII.GetString(buffer, 0, buffer.Length)) throw new Exception("Invalid header"); //Message length buffer = new byte[8]; ReceivData(socket, buffer, 0, buffer.Length, _timeout); var dataLength = BitConverter.ToInt32(buffer, 0); if (dataLength == 0) throw new Exception("Invalid data length"); //Message buffer = new byte[dataLength]; ReceivData(socket, buffer, 0, buffer.Length, _timeout); var response = serializer.Deserialize&lt;ZabbixResponse&gt;(Encoding.ASCII.GetString(buffer, 0, buffer.Length)); return string.Format("Response: {0}, Info: {1}", response.Response, response.Info); } } catch (Exception e) { return string.Format("Exception: {0}", e); } } private static void ReceivData(Socket pObjSocket, byte[] buffer, int offset, int size, int timeout) { var startTickCount = Environment.TickCount; var received = 0; do { if (Environment.TickCount &gt; startTickCount + timeout) throw new TimeoutException(); try { received += pObjSocket.Receive(buffer, offset + received, size - received, SocketFlags.None); } catch (SocketException ex) { if (ex.SocketErrorCode == SocketError.WouldBlock || ex.SocketErrorCode == SocketError.IOPending || ex.SocketErrorCode == SocketError.NoBufferSpaceAvailable) Thread.Sleep(30); else throw; } } while (received &lt; size); } #endregion } }</span></span></code> </pre><br></div></div><br>  Configs ... It's time to do something interesting.  First of all, we will keep the boxes in the configs that we are polling.  Secondly settings DataFlow.  I suggest this: <br><br><div class="spoiler">  <b class="spoiler_title">Configs</b> <div class="spoiler_text"><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CredentialsList</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">credentials</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"8.8.8.8"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">username</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"popka@example.com"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"123"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"110"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fbl"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">credentials</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"8.8.8.8"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">username</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"kesha@example.com"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"123"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"110"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bounce"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CredentialsList</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataFlowOptionsList</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">datablockoptions</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_sortMailDataBlock"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxdop</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">boundedcapacity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">datablockoptions</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_spamFilterDataBlock"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxdop</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">boundedcapacity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">datablockoptions</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_checkBounceDataBlock"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxdop</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">boundedcapacity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">datablockoptions</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_identifyDataBlock"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxdop</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">boundedcapacity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">datablockoptions</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_addToCrmDataBlock"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxdop</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">boundedcapacity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">datablockoptions</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_addToFblDataBlock"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxdop</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">boundedcapacity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">datablockoptions</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_addToBounceDataBlock"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxdop</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">boundedcapacity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataFlowOptionsList</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  So, the host and port are connected, the user and password - everything is clear.  Next is the box type.  Suppose the service is used by marketing (as well as other departments).  They have mailboxes where auto-mailing lists are being dumped, as well as <a href="https://en.wikipedia.org/wiki/Feedback_loop_(email)">FBL</a> spam reports.  The box itself already categorizes the letter, so for such situations we immediately specify the type of the box.  With the DataFlow settings, it will be clear further when we start creating objects.  Here we will have our own sections in the config.  A lot of manuals how to do it, so just show the result: <br><br><div class="spoiler">  <b class="spoiler_title">Determine Types</b> <div class="spoiler_text"><pre> <code class="hljs vala"> #region --- Types --- <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MailboxType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Bo = <span class="hljs-string"><span class="hljs-string">"bo"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Crm = <span class="hljs-string"><span class="hljs-string">"crm"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Fbl = <span class="hljs-string"><span class="hljs-string">"fbl"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Bounce = <span class="hljs-string"><span class="hljs-string">"bounce"</span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MailboxInfo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Hostname { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> User { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Port { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataBlockOptions</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Maxdop { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BoundedCapacity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DataBlockOptions() { Maxdop = <span class="hljs-number"><span class="hljs-number">1</span></span>; BoundedCapacity = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } #endregion</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Create sections</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// Custom config section /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CustomSettingsConfigSection : ConfigurationSection { [ConfigurationProperty("CredentialsList")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> CredentialsCollection CredentialItems { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base["CredentialsList"] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CredentialsCollection; } } [ConfigurationProperty("DataFlowOptionsList")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DataBlockOptionsCollection DataFlowOptionsItems { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base["DataFlowOptionsList"] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DataBlockOptionsCollection; } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Learning to read the values ‚Äã‚Äãfrom these sections.</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// Custom collection - credentials list /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; [ConfigurationCollection(typeof(CredentialsElement), AddItemName = "credentials")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CredentialsCollection : ConfigurationElementCollection, IEnumerable&lt;CredentialsElement&gt; { protected override ConfigurationElement CreateNewElement() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CredentialsElement(); } protected override <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetElementKey(ConfigurationElement element) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((CredentialsElement)element).Username; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> CredentialsElement this[<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseGet(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CredentialsElement; } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> IEnumerator&lt;CredentialsElement&gt; GetEnumerator() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; Count; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseGet(i) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CredentialsElement; } } } /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// Custom credentials item /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CredentialsElement : ConfigurationElement { [ConfigurationProperty("hostname", DefaultValue = "")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string Hostname { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base["hostname"] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> string; } } [ConfigurationProperty("username", DefaultValue = "", IsKey = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string Username { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base["username"] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> string; } } [ConfigurationProperty("password", DefaultValue = "")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Password</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base["password"] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> string; } } [ConfigurationProperty("type", DefaultValue = "")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base["type"] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> string; } } [ConfigurationProperty("port", DefaultValue = "")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string Port { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base["port"] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> string; } } } /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// Custom collection - DataBlock <span class="hljs-keyword"><span class="hljs-keyword">options</span></span> list /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; [ConfigurationCollection(typeof(DataBlockOptionsElement), AddItemName = "datablockoptions")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> DataBlockOptionsCollection : ConfigurationElementCollection, IEnumerable&lt;DataBlockOptionsElement&gt; { protected override ConfigurationElement CreateNewElement() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DataBlockOptionsElement(); } protected override <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetElementKey(ConfigurationElement element) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((DataBlockOptionsElement)element).Name; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> CredentialsElement this[<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseGet(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CredentialsElement; } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> IEnumerator&lt;DataBlockOptionsElement&gt; GetEnumerator() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; Count; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseGet(i) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DataBlockOptionsElement; } } } /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// Custom DataBlock <span class="hljs-keyword"><span class="hljs-keyword">options</span></span> item /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> DataBlockOptionsElement : ConfigurationElement { [ConfigurationProperty("name", DefaultValue = "", IsKey = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-type"><span class="hljs-type">Name</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base["name"] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> string; } } [ConfigurationProperty("maxdop", DefaultValue = "")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string Maxdop { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base["maxdop"] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> string; } } [ConfigurationProperty("boundedcapacity", DefaultValue = "")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string BoundedCapacity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base["boundedcapacity"] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> string; } } }</code> </pre><br></div></div><br>  I will not write the full implementation of the config, it is assumed that in the development process the necessary parameters will be added there. <br><br>  Our custom settings read as follows: <br><br><div class="spoiler">  <b class="spoiler_title">We read</b> <div class="spoiler_text"><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;MailboxInfo&gt; CredentialsList { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, DataBlockOptions&gt; DataFlowOptionsList { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> customConfig = (CustomSettingsConfigSection)ConfigurationManager.GetSection(<span class="hljs-string"><span class="hljs-string">"CustomSettings"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//Get mailboxes foreach (var item in customConfig.CredentialItems) CredentialsList.Add(new MailboxInfo { Hostname = item.Hostname, Port = Convert.ToInt32(item.Port), User = item.Username, Type = item.Type, Password = item.Password }); //Get DataFlow settings foreach (var item in customConfig.DataFlowOptionsItems) DataFlowOptionsList.Add(item.Name, new DataBlockOptions { Maxdop = Convert.ToInt32(item.Maxdop), BoundedCapacity = Convert.ToInt32(item.BoundedCapacity) }); } catch (Exception ex) { Logger.Log.Fatal("Error at reading config: {0}", ex.Message); throw; } }</span></span></code> </pre><br></div></div><br>  <i>Somehow it is very prolonged, and we have not even reached the most interesting.</i> <br><br>  For now, let's lower the binding from TopShelf, performance counters, communication with the database and get down to business!  Create a class Crawler - core.  First, read the mail: <br><br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _stopPipeline; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getMailsTasks = _config.CredentialsList.Select(credentials =&gt; Task.Run(() =&gt; GetMails(credentials))).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> getMailsTasks) task.Wait(); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">2000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!_stopPipeline); <span class="hljs-comment"><span class="hljs-comment">//Stop pipeline - wait for completion of all endpoints //   DataFlow  if (_stopPipeline) Logger.Log.Warn("Pipeline has been stopped by user"); }</span></span></code> </pre><br>  <i>It was here that laziness took its toll and I decided not to bother - if the boxes are on the order of 20-30, you can launch a task under each one and not sweat about the number of threads.</i>  <i>(I authorize to shower tomatoes.)</i> <br><br>  Go to the very reading: <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMails</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MailboxInfo info</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pop3Client()) {</code> </pre><br>  Immediately we calculate the access timings to the box - it is useful for diagnosing the network and server load. <br><br><pre> <code class="hljs pgsql"> //<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> Zabbix metrics var stopwatch = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Stopwatch(); stopwatch.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> mail count client.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.Hostname, <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.Port, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); client.Authenticate(<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>); stopwatch.Stop();</code> </pre><br>  We send data to Zabbix.  Everything is simple - we specify the host name (as entered in Zabbix), the key (again, strictly, as in Zabbix) and the string value. <br><br><pre> <code class="hljs pgsql"> //Send it <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Zabbix Zabbix.Sender.SendData(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ZabbixItem { Host = Config.HostKey, Key = <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> + Config.TimingKey, <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> = stopwatch.ElapsedMilliseconds.ToString() }); Logger.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>("Send [{0}] timing to Zabbix: connected to '{1}' as '{2}', timing {3}ms", <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.Hostname, <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, stopwatch.ElapsedMilliseconds); var count = client.GetMessageCount(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; Logger.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>("We've got new {0} messages in '{1}'", count, <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>); //Send messages <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> sorting block <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; i++) { try { var mailInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MessageInfo { IsSpam = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, Mail = client.GetMessage(i + <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> = MessageType.UNKNOWN, Subtype = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, Recipient = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, Mailbox = <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> }; Logger.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>("Download message from '{0}'. Size: {1}b", <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, mailInfo.Mail.RawMessage.Length);</code> </pre><br>  The DataFlow pipeline will be created when creating the Crawler class.  We consider that our first stage is to sort the letter. <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">while</span></span> (!_<span class="hljs-selector-tag"><span class="hljs-selector-tag">sortMailDataBlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Post</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">mailInfo</span></span>)) <span class="hljs-selector-tag"><span class="hljs-selector-tag">Thread</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Sleep</span></span>(500);</code> </pre><br>  You see, how simple - the conveyor itself is one.  All task reading mail throw messages there one by one.  If the block is busy, Post will return false and we will just wait until it is free.  The current then continues to work at this time.  This is what I call concurrency without worries. <br><br>  The message went to the conveyor, now you can save it with peace of mind in the RAW archive (yes, yes, we read everything we save into a file archive. The support service will thank us later). <br><br>  Set up, for example, archive rotation: <br><br><div class="spoiler">  <b class="spoiler_title">NLog.config</b> <div class="spoiler_text"><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">targets</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- add your targets here --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logfile"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"File"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fileName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${basedir}\logs\${shortdate}-message.log"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Archivefile"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"File"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fileName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${basedir}\archive\${shortdate}-archive.dat"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">targets</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Then you can set <a href="https://www.elastic.co/products/logstash">logStash</a> on him, but that's another story ... <br><br><pre> <code class="hljs pgsql"> //Save every mail <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> archive Logger.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>("Archive message"); Logger.Archive.<span class="hljs-keyword"><span class="hljs-keyword">Info</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span>.MessageToString(mailInfo.Mail)); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Logger.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.Error("Parse email error: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span>.ErrorsCounters[<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>].Increment(); //Archive mail anyway Logger.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>("Archive message"); Logger.Archive.<span class="hljs-keyword"><span class="hljs-keyword">Info</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>.GetString(client.GetMessageAsBytes(i + <span class="hljs-number"><span class="hljs-number">1</span></span>))); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_config.DeleteMail) client.DeleteMessage(i + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_stopPipeline) break; } Logger.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>("Done with '{0}'", <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>); } } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Logger.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.Error("General error - type: {0}, message: {1}", ex, ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span>.ErrorsCounters[<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>].Increment(); } }</code> </pre><br>  Here we used static error counters (in terms of mailbox types), where ErrorsCounters is: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Counter&gt; ErrorsCounters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Counter&gt;();</code> </pre><br>  And the meters themselves can be done like this: <br><br><div class="spoiler">  <b class="spoiler_title">Counter.cs</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Counter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> _counter; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Counter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Increment</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Interlocked.Increment(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _counter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Read</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _counter; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Refresh</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Interlocked.Exchange(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _counter, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { Interlocked.Add(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _counter, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { Interlocked.Exchange(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _counter, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } }</code> </pre><br></div></div><br>  We turn to the creation of the pipeline.  Suppose we have mailboxes where auto-replies pour in.  Such letters should be parsed (what kind of auto-answer, from whom, on what list, etc.) and put the result in the repository (DB).  Suppose there are boxes where FBL reports fall.  Such letters immediately add up to the database.  We consider all other letters ‚Äúuseful‚Äù - they should be checked for spam and sent to an external system, for example, CRM. <br><br>  <i>As you already understood, this example mainly considers the use of a collector for marketing tasks - collecting statistics on mail delivery, information about spam.</i> <br><br>  So, we decided on the workflow.  We declare the necessary blocks in the Crawler class: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsSpam { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Message Mail { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Subtype { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Recipient { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MessageType Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MailboxInfo Mailbox { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Crawler</span></span> { <span class="hljs-comment"><span class="hljs-comment">//Pipeline private TransformBlock&lt;MessageInfo, MessageInfo&gt; _sortMailDataBlock; private TransformBlock&lt;MessageInfo, MessageInfo&gt; _spamFilterDataBlock; private TransformBlock&lt;MessageInfo, MessageInfo&gt; _checkBounceDataBlock; private TransformBlock&lt;MessageInfo, MessageInfo&gt; _identifyDataBlock; private ActionBlock&lt;MessageInfo&gt; _addToCrmDataBlock; private ActionBlock&lt;MessageInfo&gt; _addToFblDataBlock; private ActionBlock&lt;MessageInfo&gt; _addToBounceDataBlock; ...</span></span></code> </pre><br>  We create an initialization method and create pipeline blocks (to initialize the blocks, we use our wonderful sections from configs): <br><br><pre> <code class="hljs coffeescript"> public void Init() { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>*** Create pipeline *** <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Create TransformBlock to get message type var blockOptions = _config.GetDataBlockOptions(<span class="hljs-string"><span class="hljs-string">"_sortMailDataBlock"</span></span>); _sortMailDataBlock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransformBlock&lt;MessageInfo, MessageInfo&gt;(mail =&gt; SortMail(mail), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExecutionDataflowBlockOptions { MaxDegreeOfParallelism = blockOptions.Maxdop, BoundedCapacity = blockOptions.BoundedCapacity }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Create TransformBlock to filter spam blockOptions = _config.GetDataBlockOptions(<span class="hljs-string"><span class="hljs-string">"_spamFilterDataBlock"</span></span>); _spamFilterDataBlock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransformBlock&lt;MessageInfo, MessageInfo&gt;(mail =&gt; FilterSpam(mail), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExecutionDataflowBlockOptions { MaxDegreeOfParallelism = blockOptions.Maxdop, BoundedCapacity = blockOptions.BoundedCapacity }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Create TransformBlock to sort bounces blockOptions = _config.GetDataBlockOptions(<span class="hljs-string"><span class="hljs-string">"_checkBounceDataBlock"</span></span>); _checkBounceDataBlock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransformBlock&lt;MessageInfo, MessageInfo&gt;(mail =&gt; BounceTypeCheck(mail), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExecutionDataflowBlockOptions { MaxDegreeOfParallelism = blockOptions.Maxdop, BoundedCapacity = blockOptions.BoundedCapacity }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Create TransformBlock to identify bounce owner blockOptions = _config.GetDataBlockOptions(<span class="hljs-string"><span class="hljs-string">"_identifyDataBlock"</span></span>); _identifyDataBlock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransformBlock&lt;MessageInfo, MessageInfo&gt;(mail =&gt; GetRecipient(mail), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExecutionDataflowBlockOptions { MaxDegreeOfParallelism = blockOptions.Maxdop, BoundedCapacity = blockOptions.BoundedCapacity }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Create ActionBlock to send mail to CRM blockOptions = _config.GetDataBlockOptions(<span class="hljs-string"><span class="hljs-string">"_addToCrmDataBlock"</span></span>); _addToCrmDataBlock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionBlock&lt;MessageInfo&gt;(mail =&gt; AddToCrm(mail), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExecutionDataflowBlockOptions { MaxDegreeOfParallelism = blockOptions.Maxdop, BoundedCapacity = blockOptions.BoundedCapacity }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Create ActionBlock to send FBL to MailWH blockOptions = _config.GetDataBlockOptions(<span class="hljs-string"><span class="hljs-string">"_addToFblDataBlock"</span></span>); _addToFblDataBlock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionBlock&lt;MessageInfo&gt;(mail =&gt; AddToFbl(mail), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExecutionDataflowBlockOptions { MaxDegreeOfParallelism = blockOptions.Maxdop, BoundedCapacity = blockOptions.BoundedCapacity }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Create ActionBlock to send Bounce to MailWH blockOptions = _config.GetDataBlockOptions(<span class="hljs-string"><span class="hljs-string">"_addToBounceDataBlock"</span></span>); _addToBounceDataBlock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionBlock&lt;MessageInfo&gt;(mail =&gt; AddToBounce(mail), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExecutionDataflowBlockOptions { MaxDegreeOfParallelism = blockOptions.Maxdop, BoundedCapacity = blockOptions.BoundedCapacity });</code> </pre><br>  We assemble the conveyor in accordance with our scheme: <br><br><pre> <code class="hljs pgsql"> /<span class="hljs-comment"><span class="hljs-comment">/*** Build pipeline *** _sortMailDataBlock.LinkTo(_spamFilterDataBlock, info =&gt; info.Type == MessageType.GENERAL); _sortMailDataBlock.LinkTo(_addToFblDataBlock, info =&gt; info.Type == MessageType.FBL); _sortMailDataBlock.LinkTo(_checkBounceDataBlock, info =&gt; info.Type == MessageType.BOUNCE); _sortMailDataBlock.LinkTo(DataflowBlock.NullTarget&lt;MessageInfo&gt;(), info =&gt; info.Type == MessageType.UNKNOWN); /*STUB*/</span></span> _checkBounceDataBlock.LinkTo(_identifyDataBlock); _identifyDataBlock.LinkTo(_addToBounceDataBlock); _spamFilterDataBlock.LinkTo(_addToCrmDataBlock, <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.IsSpam); _spamFilterDataBlock.LinkTo(DataflowBlock.NullTarget&lt;MessageInfo&gt;(), <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>.IsSpam); <span class="hljs-comment"><span class="hljs-comment">/*STUB*/</span></span></code> </pre><br>  As you can see, everything is extremely simple - we associate the block with the following (with the possibility of setting the communication condition).  All blocks are executed in parallel.  Each block has a degree of parallelism and capacity (with the help of capacity, you can adjust the queue before the block, that is, the block has received the message but does not process it yet).  Thus, you can set a high degree of parallelism for "complex" and long operations, such as parsing the contents of the letter. <br><br>  <i>I will not describe the DataFlow materiel, it is better to read everything in the original <a href="https://msdn.microsoft.com/en-us/library/hh228603(v%3Dvs.110).aspx">TPL DataFlow</a> source</i> . <br><br>  Next, set the exit rules from the block: <br><br><pre> <code class="hljs javascript"> _sortMailDataBlock.Completion.ContinueWith(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.IsFaulted) ((IDataflowBlock)_spamFilterDataBlock).Fault(t.Exception); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _spamFilterDataBlock.Complete(); }); _sortMailDataBlock.Completion.ContinueWith(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.IsFaulted) ((IDataflowBlock)_addToFblDataBlock).Fault(t.Exception); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _addToFblDataBlock.Complete(); }); _sortMailDataBlock.Completion.ContinueWith(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.IsFaulted) ((IDataflowBlock)_checkBounceDataBlock).Fault(t.Exception); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _checkBounceDataBlock.Complete(); }); _spamFilterDataBlock.Completion.ContinueWith(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.IsFaulted) ((IDataflowBlock)_addToCrmDataBlock).Fault(t.Exception); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _addToCrmDataBlock.Complete(); }); _checkBounceDataBlock.Completion.ContinueWith(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.IsFaulted) ((IDataflowBlock)_identifyDataBlock).Fault(t.Exception); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _identifyDataBlock.Complete(); }); _identifyDataBlock.Completion.ContinueWith(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.IsFaulted) ((IDataflowBlock)_addToBounceDataBlock).Fault(t.Exception); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _addToBounceDataBlock.Complete(); }); }</code> </pre><br>  Everything, in fact, the pipeline is already working, you can post messages to it.  It remains only to stop it by adding our Start method: <br><br><div class="spoiler">  <b class="spoiler_title">Start</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { var getMailsTasks = _config.CredentialsList.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(credentials =&gt; Task.Run(() =&gt; GetMails(credentials))).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var task <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> getMailsTasks) task.Wait(); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">2000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!_stopPipeline); //Stop pipeline - wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> completion <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> endpoints _sortMailDataBlock.Complete(); _addToCrmDataBlock.Completion.Wait(); _addToFblDataBlock.Completion.Wait(); _addToBounceDataBlock.Completion.Wait(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_stopPipeline) Logger.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.Warn("Pipeline has been stopped by user"); }</code> </pre><br></div></div><br>  Go to the delegates. <br>  Sorting ... Well, let's say everything is simple with us (we always have time to complicate things): <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> MessageInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SortMail</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MessageInfo mail</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (mail.Mailbox.Type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MailboxType.Crm: mail.Type = MessageType.GENERAL; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MailboxType.Bounce: mail.Type = MessageType.BOUNCE; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MailboxType.Fbl: mail.Type = MessageType.FBL; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mail; }</code> </pre><br>  Spam filter  This is homework - use <a href="http://spamassassin.apache.org/">SpamAssassin</a> . <br>  Here is the delegate: <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> MessageInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterSpam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MessageInfo mail</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Add SpamAssassin logic return mail; }</span></span></code> </pre><br>  And classes for working with the SpamAssassin API ( <a href="http://www.codeproject.com/Articles/13106/A-C-Wrapper-for-the-SpamAssassin-Protocol">link to the project</a> ). <br>  And we turn to the parsing of letters.  Parsim we auto-reply.  Here comes the MEF case. <br>  We create a project (dll) with interfaces for our plug-ins (Let's call the Interfaces). <br>  Add an interface: <br><br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ICondition</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Check</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message mimeMessage</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IConditionMetadata</span></span> { Type Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre><br>  And ... everything.  Our TopCrawler depends on this project and the project with plugins will also use it. <br>  Create a new project (also dll), let's call Conditions. <br>  Add types of auto-responses: <br><br><pre> <code class="hljs vala"> #region --- Types --- <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BounceType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Full = <span class="hljs-string"><span class="hljs-string">"BounceTypeFull"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Timeout = <span class="hljs-string"><span class="hljs-string">"BounceTypeTimeout"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Refused = <span class="hljs-string"><span class="hljs-string">"BounceTypeRefused"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NotFound = <span class="hljs-string"><span class="hljs-string">"BounceTypeNotFound"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Inactive = <span class="hljs-string"><span class="hljs-string">"BounceTypeInactive"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> OutOfOffice = <span class="hljs-string"><span class="hljs-string">"BounceTypeOutOfOffice"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> HostNotFound = <span class="hljs-string"><span class="hljs-string">"BounceTypeHostNotFound"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NotAuthorized = <span class="hljs-string"><span class="hljs-string">"BounceTypeNotAuthorized"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ManyConnections = <span class="hljs-string"><span class="hljs-string">"BounceTypeManyConnections"</span></span>; } #endregion</code> </pre><br>  And the classes that implement our interface: <br><br><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">Export(typeof(ICondition))</span></span>] [ExportMetadata(<span class="hljs-string"><span class="hljs-string">"Type"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ConditionNotFound1))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConditionNotFound1</span></span> : <span class="hljs-title"><span class="hljs-title">ICondition</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Check</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message mimeMessage</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!mimeMessage.MessagePart.IsMultiPart) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> pattern = <span class="hljs-string"><span class="hljs-string">"Diagnostic-Code:.+smtp.+550"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> regexp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex(pattern, RegexOptions.IgnoreCase); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mimeMessage.MessagePart.MessageParts.Any(part =&gt; part.ContentType.MediaType == <span class="hljs-string"><span class="hljs-string">"message/delivery-status"</span></span> &amp;&amp; regexp.IsMatch(part.GetBodyAsText())) ? BounceType.NotFound : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } ... [Export(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ICondition))] [ExportMetadata(<span class="hljs-string"><span class="hljs-string">"Type"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ConditionTimeout2))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConditionTimeout2</span></span> : <span class="hljs-title"><span class="hljs-title">ICondition</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BounceType.Timeout; } ...</code> </pre><br>  As you can see, it's all about attributes.       . <br>       : <br><br><pre> <code class="hljs ruby"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Crawler</span></span></span><span class="hljs-class"> { ... //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plugins</span></span></span><span class="hljs-class"> [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImportMany</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IEnumerable</span></span></span><span class="hljs-class">&lt;Lazy&lt;ICondition, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IConditionMetadata</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BounceTypeConditions</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">;</span></span> set; } private void LoadPlugins() { try { var container = new CompositionContainer(new DirectoryCatalog(_config.PluginDirectory), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); container.ComposeParts(this); } catch (Exception ex) { Logger.Log.Error(<span class="hljs-string"><span class="hljs-string">"Unable to load plugins: {0}"</span></span>, ex.Message); } } ...</code> </pre><br> LoadPlugins     .        ‚Äî   . <br><br>       Bounce.     ,     ‚Äî  : <br><br><pre> <code class="hljs kotlin"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MessageInfo BounceTypeCheck(MessageInfo mailInfo) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { foreach (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> condition <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> BounceTypeConditions) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = condition.Value.Check(mailInfo.Mail); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; mailInfo.Subtype = res; Logger.Log.Debug(<span class="hljs-string"><span class="hljs-string">"Bounce type condition [{0}] triggered for message [{1}]"</span></span>, condition.Metadata.Type, mailInfo.Mail.Headers.MessageId); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { Logger.Log.Error(<span class="hljs-string"><span class="hljs-string">"Failed to determine bounce type for message '{0}': {1}"</span></span>, mailInfo.Mail.Headers.MessageId, ex.Message); Logger.ErrorsCounters[MailboxType.Bounce].Increment(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mailInfo; }</code> </pre><br>               ,     ‚Äî ! <i>          ‚Äî     (   ,        )</i> . <br><br>        .  For example: <br><br><pre> <code class="hljs pgsql"> private <span class="hljs-type"><span class="hljs-type">void</span></span> AddToBounce(MessageInfo mail) { try { MailWH.BounceAdd(mail); <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span>.ProcessedCounters[MailboxType.Bounce].Increment(); <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>("Send Bounce to MailWH"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.Error("Error saving Bounce message '{0}' to MailWH: {1}", mail.Mail.Headers.MessageId, ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span>.ErrorsCounters[MailboxType.Bounce].Increment(); } }</code> </pre><br><div class="spoiler"> <b class="spoiler_title">BounceAdd</b> <div class="spoiler_text"><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BounceAdd</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MessageInfo message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnection(ConnectionString)) <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlDataAdapter(<span class="hljs-string"><span class="hljs-string">"BounceAdd"</span></span>, conn)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = message.Mail.FindFirstPlainTextVersion() == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? message.Mail.FindFirstHtmlVersion().GetBodyAsText() : message.Mail.FindFirstPlainTextVersion().GetBodyAsText(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> outId = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlParameter(<span class="hljs-string"><span class="hljs-string">"@ID"</span></span>, SqlDbType.BigInt) { Direction = ParameterDirection.Output }; cmd.SelectCommand.CommandType = CommandType.StoredProcedure; cmd.SelectCommand.Parameters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlParameter(<span class="hljs-string"><span class="hljs-string">"@RawMessage"</span></span>, message.Mail.RawMessage)); cmd.SelectCommand.Parameters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlParameter(<span class="hljs-string"><span class="hljs-string">"@Message"</span></span>, body)); cmd.SelectCommand.Parameters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlParameter(<span class="hljs-string"><span class="hljs-string">"@Subject"</span></span>, message.Mail.Headers.Subject ?? <span class="hljs-string"><span class="hljs-string">""</span></span>)); cmd.SelectCommand.Parameters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlParameter(<span class="hljs-string"><span class="hljs-string">"@MessageID"</span></span>, message.Mail.Headers.MessageId ?? <span class="hljs-string"><span class="hljs-string">""</span></span>)); cmd.SelectCommand.Parameters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlParameter(<span class="hljs-string"><span class="hljs-string">"@AddressTo"</span></span>, message.Mail.Headers.To[<span class="hljs-number"><span class="hljs-number">0</span></span>].Address ?? <span class="hljs-string"><span class="hljs-string">""</span></span>)); cmd.SelectCommand.Parameters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlParameter(<span class="hljs-string"><span class="hljs-string">"@AddressFrom"</span></span>, message.Mail.Headers.From.Address ?? <span class="hljs-string"><span class="hljs-string">""</span></span>)); cmd.SelectCommand.Parameters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlParameter(<span class="hljs-string"><span class="hljs-string">"@DateRecieved"</span></span>, DateTime.Now)); cmd.SelectCommand.Parameters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlParameter(<span class="hljs-string"><span class="hljs-string">"@BounceTypeSysName"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)message.Subtype ?? DBNull.Value)); cmd.SelectCommand.Parameters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlParameter(<span class="hljs-string"><span class="hljs-string">"@SourceFrom"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)message.Recipient ?? DBNull.Value)); <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Add ListId support cmd.SelectCommand.Parameters.Add(new SqlParameter("@ListId", DBNull.Value)); cmd.SelectCommand.Parameters.Add(outId); conn.Open(); cmd.SelectCommand.ExecuteNonQuery(); return outId.Value as long? ?? 0; } }</span></span></code> </pre><br></div></div><br> ,     TopShelf ‚Äî      . <br><br><h2>  findings </h2><br>     ,         .         ‚Äî DataFlow-,    .        ,   DataFlow    (         ). TopShelf         ,        . <br><br> ‚Ä¶   ,  ,      Continious Integration,       <a href="https://www.visualstudio.com/en-us/features/release-management-vs.aspx">VS Release Management</a> . </div><p>Source: <a href="https://habr.com/ru/post/262613/">https://habr.com/ru/post/262613/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262601/index.html">Deviation transformation and its use to determine the coordinate system for a set of distances</a></li>
<li><a href="../262603/index.html">Writing a web service on Scalatra</a></li>
<li><a href="../262605/index.html">Migrate data from Oracle to PostgreSQL</a></li>
<li><a href="../262607/index.html">We give the right to choose access to the page using the Rules</a></li>
<li><a href="../262611/index.html">Mail.Ru Rating Launches Website Scan For Viruses</a></li>
<li><a href="../262615/index.html">iOS Developer Tools</a></li>
<li><a href="../262617/index.html">48 hours of your publication on Habr√©</a></li>
<li><a href="../262623/index.html">36 million requests per hour, 10,000+ constantly working clients, on one server, nginx + mysql</a></li>
<li><a href="../262625/index.html">Ten commandments of a successful data center</a></li>
<li><a href="../262627/index.html">6 phrases that can change your approach to customer service</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>