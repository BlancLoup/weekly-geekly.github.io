<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automate monitoring: low-level detection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Monitoring a large number of devices requires automation tools to help. Otherwise, if you do everything with the mouse, you can ‚Äúclick‚Äù while you add ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automate monitoring: low-level detection</h1><div class="post__text post__text-html js-mediator-article">  Monitoring a large number of devices requires automation tools to help.  Otherwise, if you do everything with the mouse, you can ‚Äúclick‚Äù while you add and configure everything that was required.  Besides, you will definitely make a mistake somewhere, man is not a robot.  Fortunately, all these tools are in Zabbix: these are <a href="https://www.zabbix.com/documentation/ru/2.0/manual/config/templates">templates</a> , <a href="https://www.zabbix.com/documentation/2.0/manual/appendix/api/api">API</a> , <a href="https://www.zabbix.com/documentation/ru/2.0/manual/discovery/network_discovery">discovery of network devices</a> , <a href="https://www.zabbix.com/documentation/ru/2.0/manual/discovery/auto_registration">auto</a> - <a href="https://www.zabbix.com/documentation/ru/2.0/manual/discovery/auto_registration">registration of</a> Zabbix agents. <br><br>  And from version 2.0, <a href="https://www.zabbix.com/documentation/ru/2.0/manual/discovery/low_level_discovery">Low-Level Discovery (LLD)</a> or low-level detection was added here.  I would like to tell what it is. <br><a name="habracut"></a><br><h4>  Low level detection </h4><br><img src="https://habrastorage.org/storage3/fef/810/edb/fef810edbc93f9e59dedb50203c53099.jpg" alt="image"><br><br>  <b>Network Discovery (Network Discovery)</b> is a very useful thing that allows you to avoid manually adding new <a href="https://www.zabbix.com/documentation/ru/2.0/manual/config/hosts">network nodes</a> and associating them with the necessary templates.  What can create quite complex scenarios.  For example, automatically associate a new client (its CPE) with a Wi-Fi base station with the necessary template for CPE and even automatically add this node in the right place on the map.  The <a href="https://www.zabbix.com/documentation/ru/2.0/manual/discovery/network_discovery/rule">documentation</a> has a good example of how network discovery is configured. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      LLD becomes necessary in the next stage, after the node is found and attached to the template.  LLD allows you to find objects of the node itself. <br><br>  LLD allows us to automatically create <a href="http://blog.zabbix.com/%25D1%258D%25D0%25BB%25D0%25B5%25D0%25BC%25D0%25B5%25D0%25BD%25D1%2582%25D1%258B%2520%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D1%2585">data elements</a> , <a href="https://www.zabbix.com/documentation/ru/2.0/manual/config/triggers">triggers</a> and <a href="https://www.zabbix.com/documentation/ru/2.0/manual/config/visualisation/graphs">graphics</a> for: <br><br><ul><li>  computer file systems </li><li>  computer network interfaces </li><li>  data from SNMP tables with a one-dimensional index </li></ul><br>  You can extend the capabilities of LLD through your own scripts, as long as the output of the script for Zabbix is ‚Äã‚Äãclear to JSON. <br><br>  In addition to what LLD creates, it also regularly scans the <b>host</b> for changes and dynamically deletes old data elements (deleted file system) and adds new ones (inserted expansion card with additional ports). <br><br>  Of course, you can do without LLD, because in all previous versions they did the same patterns.  Here are just everyone who uses Zabbix, faced with the situation that there are two in one logical drive server and four in the other.  That one switch has Ethernet ports 8, and the other from the same line has 24. It remains to write a 24-port pattern (4 disks), and then, after binding the device, manually disconnect unnecessary data elements, triggers.  Here we are already ‚Äúcrowded‚Äù.  And then someone made a new server, and there are 8 disks in it ... And another colleague in the existing server created another partition with a non-standard way and did not say anything ... <br><br><h4>  As it was before </h4><br>  To understand what the LLD gives us, there is nothing better than a good example.  Recall what we had to do with multiport switches in previous versions of Zabbix. <br><br>  Let's say we have Cisco switches, D-Link, Zyxel and other ‚Äúzoo‚Äù.  With the number of ports 5/8/16/24/50. <br><br><img src="https://habrastorage.org/storage3/15b/8e0/a00/15b8e0a0032067a9f407e307c751fac4.jpg" alt="image"><br><br>  We will monitor the state of the ports using SNMPv2 and the counters described in the IF-MIB.  We don‚Äôt have LLD yet, so let's start writing a regular template.  Let's call it <b>Template_IF_MIB_SNMPV2</b> . <br><br>  In the template for one port, we need to create 14 data elements (of course, less can be done, but we will decide that it is critically important for us to collect almost everything), as well as a number of <b>triggers</b> , <b>graphs</b> .  In the Zabbix web interface, this will take about 10 minutes if you actively swing the mouse and use the ‚ÄúClone‚Äù button. <br><br><img src="https://habrastorage.org/storage3/810/6ff/e3b/8106ffe3b0cfe41828ab385d88aeefbd.jpg" alt="image"><br><br>  After taking a breath, I don‚Äôt really want to continue for other ports.  Who wants to do the same thing 50 times?  Therefore, immediately there are questions: <br><br><ul><li>  How to avoid wasting time creating the remaining ports (2-50) </li><li>  How to avoid requests to counters from 6 to 50 ports that are doomed to failure without manual intervention, when the universal template is attached to the 5th port switch </li><li>  How not to clutter the network with polls of port counters that are not used </li></ul><br>  The first problem can be solved, for example, by <a href="https://www.zabbix.com/documentation/ru/2.0/manual/xml_export_import">uploading a</a> template to XML followed by CTRL + C / CTRL + V in a text editor.  Or even write a small external script and generate XML to them.  But‚Ä¶ <br><br><h4>  What can be done now with LLD </h4><br>  But with <b>Low-Level Discovery</b> , we have the opportunity to make everything much easier.  Instead of creating <b>data elements</b> for a single port, we simply create <b>prototypes</b> of data elements, as well as prototypes of necessary triggers ONCE.  Since we only do this once, it is not at all a pity to spend time and also create informative graphs, or more precisely, prototypes of graphs, in addition. <br><br>  So, to create in the LLD template, go to <b>the detection rules</b> : <br><br><img src="https://habrastorage.org/storage3/468/ec7/246/468ec7246ae397c44e53c1bb4d7ef64c.png" alt="image"><br><br>  Next, click <b>to create a discovery rule</b> and create a new rule, let's call it <b>Network interfaces discovery</b> : <br><br><img src="https://habrastorage.org/storage3/32d/a80/911/32da809111dd6254087485be3889cc9d.png" alt="image"><br><br>  We indicate everything as in the picture.  Some fields are worth commenting: <br><table><tbody><tr><td>  <b>Key</b> </td><td>  snmp.discovery.v2 </td></tr><tr><td>  <b>SNMP OID</b> </td><td>  The OID that we will use for the criterion for adding the monitoring interface, in this case ifOperStatus. <br></td></tr><tr><td>  <b>SNMP community</b> </td><td>  This example uses the {$ COMMUNITY} macro.  The same template contains the default value, {$ COMMUNITY} = public.  Further, for each specific <b>network node</b> to which we attach this template, we can either rewrite the value of the macro, if its snmp community is different, or do nothing, and then the one written in the public template will be used.  This technique helps to avoid the need to change <b>items</b> at the <b>host</b> level. <br></td></tr><tr><td>  <b>Filter</b> </td><td>  The value of the special macro {#SNMPVALUE}, which corresponds to the result of the ifOperStatus.X query to the device, we subject to a very complex regular expression: 1. As we know from the IF-MIB, ifOperStatus.X = 1 corresponds to up (1).  Thus, we will put on monitoring only those interfaces that at the time of scanning the network were able to up (1).  This will save us from collecting the counters of those interfaces that are not used.  If we want to add all ports to the monitoring indiscriminately, then the <b>filter</b> field is simply left blank. <br></td></tr><tr><td>  <b>Period of preservation of lost resources</b> </td><td>  After how many days to remove the network interface from monitoring, if the network interface has ceased to be re-scanning LLD, or ifOperStatus.X status ceases to be up (1).  In this case, set to zero - do not delete. <br></td></tr></tbody></table><br>  So, we created a <b>rule</b> , now we have to create <b>prototypes of data elements</b> .  Everything here is practically the same as when creating ordinary <b>data elements</b> , but there are a couple of features.  For example, add inbound traffic, ifInOctets: <br><br><img src="https://habrastorage.org/storage3/7cf/78e/c18/7cf78ec188f05c19771d499f31410862.png" alt="image"><br><br>  Description of fields: <br><table><tbody><tr><td>  <b>Name</b> </td><td>  if {#SNMPINDEX} ({$ PORT {#SNMPINDEX} _DESC}) In.  We decipher the design.  As we already know, {#SNMPINDEX} is a <a href="https://www.zabbix.com/documentation/ru/2.0/manual/appendix/macros/supported_by_location">system macro</a> that will correspond to the interface index in SNMP.  We will substitute it in the name of the interface, for names that we understand.  It will turn out: if1, if2, if3, etc.  The second <a href="https://www.zabbix.com/documentation/ru/2.0/manual/config/macros/usermacros">macro is a custom one</a> , {$ PORT {#SNMPINDEX} _DESC}, into which name the interface index will be inserted, dynamically changing the name of the macro.  It is optional, but I use it in order for Zabbix to prescribe an additional description of each interface by simply adding a macro at the <b>host</b> level, for example: <br><br>  {$ PORT1_DESC} = uplink, ISP1 <br></td></tr><tr><td>  <b>Key</b> </td><td>  The key must contain {#SNMPINDEX} so that the key is always unique. </td></tr><tr><td>  <b>SNMP OID</b> </td><td>  Similarly, we substitute the macro {$ SNMPINDEX} in our SNMP OID to poll the counter of the interface we need. <br></td></tr></tbody></table>  Let's create prototypes for the remaining <b>data elements</b> that we need for each interface, we get something like this list: <br><br><img src="https://habrastorage.org/storage3/8ce/f75/c59/8cef75c59d76db7588d326a7f4bc7f54.png" alt="image"><br><br>  create <b>prototypes of triggers</b> ... <br><br><img src="https://habrastorage.org/storage3/339/29c/b7f/33929cb7f6924790bf2366c2f17bb784.png" alt="image"><br><br>  ... and <b>chart prototypes</b> : <br><br><img src="https://habrastorage.org/storage3/723/f27/812/723f2781255ecd0a5cc639aa20096f02.png" alt="image"><br><br>  By hooking our template to real network nodes, after a while we will get the result.  This is how the <b>last data</b> for the <b>host</b> will look like after the LLD test: <br><br><img src="https://habrastorage.org/storage3/cd6/5a9/028/cd65a90281ff765bc9d0de555930c361.png" alt="image"><br><br>  As expected, data is collected only for active ports. <br><br>  And here are the graphs, also dynamically created via LLD: <br><br><img src="https://habrastorage.org/storage3/f56/442/f4b/f56442f4b9b3c83daa85249f61c5dedb.jpg" alt="image"><br><br><h4>  Total </h4><br>  To summarize what we got, using LLD in a template for multiport switches: <br><br><ul><li>  Universal template for all devices that support IF-MIB </li><li>  Does not require additional configuration at the host level after adding the template.  The maximum you need is to fill the {$ COMMUNITY} macros (if the snmp community is not public), fill in the {$ PORTx_DESC) macro (if you want to see the port description) and activate the <b>[NET]</b> triggers <b>if {#SNMPINDEX} ({$ PORT { #SNMPINDEX} _DESC}) is down</b> for key ports that require notification of status changes from <b>up</b> to <b>down</b> (which is why these triggers in the prototypes are deactivated so as not to be bombarded with triggers from the access ports of users that turn on and off their computers). </li></ul><br>  But, as already mentioned, the exact same focus can be cranked with file systems and network interfaces of the computer (another example <a href="https://www.zabbix.com/documentation/ru/2.0/manual/discovery/low_level_discovery">here</a> ), as well as with many other things stored in SNMP.  True, there are limitations.  For example, unfortunately, the LLD will not work if the SNMP table contains several indices.  It is possible to circumvent this restriction with the help of macros, however, this is already, as they say, from the category of ‚Äúcrutches‚Äù. <br><br>  Like this.  And no more fussing with similar data elements, triggers, graphs.  Just set up LLD and enjoy the fruits of automation.  Or configure LLD + network discovery and generally go on vacation :) </div><p>Source: <a href="https://habr.com/ru/post/193460/">https://habr.com/ru/post/193460/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193436/index.html">Dusk Rift - online game about the real world and real places</a></li>
<li><a href="../193442/index.html">Live Broadcast Windows Camp</a></li>
<li><a href="../193450/index.html">Electromagnetic radiation that blocks the operation of engines</a></li>
<li><a href="../193452/index.html">Load testing in Skyforge, or Bots - server orderlies. Part 2</a></li>
<li><a href="../193454/index.html">IBM Introduces NeXtScale System - High-Performance Computing Platform for Data Centers</a></li>
<li><a href="../193464/index.html">Yealink and 3CX become strategic partners</a></li>
<li><a href="../193466/index.html">Competition within the team kills the team spirit</a></li>
<li><a href="../193468/index.html">Localization trends and localization of trends: a summary of Localization World-2013</a></li>
<li><a href="../193470/index.html">‚ÄúYour mom's combat boots‚Äù is a new feature in iOS7</a></li>
<li><a href="../193472/index.html">Scaling Zabbix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>