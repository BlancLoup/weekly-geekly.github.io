<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features scanning antivirus executable files and trust the results of VirusTotal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. Below is a lot of stupid text, nostalgic memories and school code. In addition, the effectiveness of the VirusTotal service, as well as the ant...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features scanning antivirus executable files and trust the results of VirusTotal</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/3y/xn/4j/3yxn4jipriehwlz7rceg967cdke.jpeg"><br><br>  Hello.  Below is a lot of stupid text, nostalgic memories and school code.  In addition, the effectiveness of the VirusTotal service, as well as the antivirus engines for executable files, will be reviewed. <br><a name="habracut"></a><br><h3>  Part 1. Delusional nostalgic introduction </h3><br>  In my life a lot has changed.  My current work became interesting to me (in places - to lack of sleep), in my region there is a war going on for the fourth year, much has changed and has been rethought in my personal life. <br><br>  Many views and opinions have changed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      About 15-20 years ago, I was interested in the topic of hacking and writing malicious code, then interests changed to just the opposite - protection from this case, and then I realized that money and personal interests rule everything, and not altruism and the desire to help. <br><br>  But that is.  In any case, IT turned out to be part of even my current job, although it does not at all relate to the initial specialization. <br><br>  About 10 years ago I wrote in a very narrow circle about the possibility of removing antivirus detection using self-extracting archives.  Then it was, it seems, on Virusinfo, then some people reposted it under their nickname on DrWeb - so to speak, without copyrights and with their authorship, then there was even a scandal - but that was also not true for a long time. <br><br>  And recently I remembered the old.  Much has passed, many things have been updated and to keep up with the progress, without bothering with the topic, it turned out to be difficult. <br><br>  But the essence remains the same: sensations, money and personal interests.  And the game on ignorance - which sometimes comes to the point that the vulnerabilities of Meltdown / Specter are sought in televisions and on-board computers of cars))) <br><br>  But enough of this uninteresting nonsense.  So, I decided to remember the old, and since I remembered a little, I decided to remove detections from several viruses in the old manner. <br><br>  We will need: <br><br><ol><li>  Knowledge of Windows command bat scripts at the student level. </li><li>  <a href="https://www.abyssmedia.com/quickbfc/">Quick Batch File Compiler</a> (hereinafter - QBC) </li><li>  <a href="">7za.exe from the 7z1800-extra.7z package</a> (hereinafter - 7Z) </li><li>  <a href="">upx.exe from the package upx394w.zip</a> (hereinafter <a href="">referred</a> to as UPX) </li><li>  file eicar.com, you can download, for example, <a href="https://support.kaspersky.ru/common/troubleshooting/7399">here</a> (hereinafter - Eicar) </li><li>  The most basic computer with Internet access running any Windows OS </li></ol><br><h3>  Part 2. Quite a bit of theory. </h3><br>  In order to move on, let's find out what will be discussed.  At the moment, as, however, and earlier, the subject of antiviruses is actively promoted.  Say, antiviruses help to prevent the loss of important data, antiviruses save from vulnerabilities, antiviruses - that, antiviruses - that and so on. <br><br>  At the same time, an ordinary user does not even understand that an antivirus is not just a scanner, it is both resident protection, and heuristics, and often - proactive protection, firewall and sandbox. <br><br>  We can devote to each of these components not only an article - a book, but we will dwell on the most basic one: a scanner. <br><br>  This component will not prevent connections to malicious sites, it will not catch the malicious code on the fly, but it allows you to check the file and give an answer: whether to store it - or better to delete it immediately and permanently. <br><br>  Below we will test different antivirus engines and see how well they cope with this task. <br><br>  Separately, I would like to mention the <a href="https://www.virustotal.com/">VirusTotal</a> resource - it allows you not only to check the file with various antivirus engines, but also represents a kind of sandbox for testing malicious (and generally any) code.  Plus platforms are free of charge, minus - all samples that are sent to VirusTotal are subsequently transferred to all anti-virus laboratories. <br><br>  It is for this reason that below I will not provide links to pages with scan results, but will provide screenshots of these results obtained during the course of work.  Obviously (and I want to believe it!) After this article, the results will improve. <br><br>  Malicious code authors extremely often use packers and protectors, which not only compress a malicious file, but also make it difficult for it to be detected by signatures, as well as its subsequent analysis.  When using stolen licenses of protectors such as WinLicense and Themida, usually antivirus laboratories do not make it difficult to unpack, but simply add protector signatures with a stolen key to the detector (the famous Trojan detectors: W32 / Black.A).  This leads to the appearance of false positives - the authors of key generators, patchers, and some programs that are not malicious in nature, but are nevertheless protected from reversing, use similar stolen licenses. <br><br>  Since everything described in this article will be presented below to the reader for review, I did not work with real malicious code (although I‚Äôll provide his scan results below), but used the Eicar file, which is popular when testing anti-viruses: this is a kind of stub for which any Antivirus should give a persistent detect. <br><br>  So let's get started. <br><br><h3>  Part 3. Practice </h3><br><div class="spoiler">  <b class="spoiler_title">So, as Eicar is now detected on VirusTotal</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/sv/ns/-_/svns-_vttambdu0ehojjczfjzr0.jpeg"><br></div></div><br>  Frankly, I was somewhat struck by what I saw, because two anti-virus engines, Comodo and Malwarebytes, for some reason decided not to follow common standards and ignore the detection.  Nevertheless, the result is obvious - the file has a detector close to 100%. <br><br>  As we agreed at the very beginning, we are a complete shkolota, and therefore we will not invent our own packaging methods, but simply package the file into the archive using 7Z: <br><br><pre><code class="hljs css">7<span class="hljs-selector-tag"><span class="hljs-selector-tag">za</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eicar</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.7z</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eicar</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Check the resulting file on VirusTotal</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/mw/7t/nm/mw7tnmjwww10ekrslheoymnzg4k.jpeg"><br></div></div><br>  Yes, there are fewer detections, because not all anti-virus engines include the 7Z archive unpacker (well, or this setting is not included in VirusTotal by default) - but the detection is still high. <br><br>  Complicate the task: pack the file in the archive with a password.  Let the password be fun: <br><br><pre> <code class="hljs kotlin"><span class="hljs-number"><span class="hljs-number">7</span></span>za a -mhe=on -pfun eicar-<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function">.7z eicar.com</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">The result of the check is obvious.</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ii/u8/ez/iiu8ezp-o87bg4r-ld18h8xudls.jpeg"><br></div></div><br>  The file is clean, because even with the unpacking procedure, the antivirus does not know the password to the file. <br><br>  Detect removed - but we did not receive the executable file. <br><br>  In real packers, the solution is quite complicated and we will not go into these details.  Let's use the QBC services and write the simplest script: <br><br><pre> <code class="hljs kotlin"><span class="hljs-number"><span class="hljs-number">7</span></span>za e -pfun eicar-<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function">.7z start eicar.com</span></span></code> </pre> <br>  The script simply unpacks the archive and runs the resulting file.  QBC allows not only to create the simplest executable file based on this script, but also to include in this file the necessary (7za.exe and eicar-fun.7z archive), which is accessed through the variable% myfiles%. <br><br>  The resulting executable file can be without opening a terminal window (the so-called "Ghost"), and this is what we need: <br><br><img src="https://habrastorage.org/webt/mm/oc/28/mmoc28bxuuwgcqggckb6wfswlry.jpeg"><br><br>  The final code looks like this: <br><br><pre> <code class="hljs kotlin">cd %myfiles% <span class="hljs-number"><span class="hljs-number">7</span></span>za e -pfun eicar-<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function">.7z start eicar.com</span></span></code> </pre> <br>  After compiling, the resulting file dumb_bat.exe unpacks Eicar and launches it. <br><br><div class="spoiler">  <b class="spoiler_title">See the result of checking this file on VirusTotal</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/-w/sw/lj/-wswljroevzprcbtn81awrwgzxm.jpeg"><br></div></div><br>  Funny, the detection has decreased from 60 for unpacked file and 41 for archive to 17 - while none of the anti-virus engines detected Eicar, the detections obviously have a heuristic character, and in some cases they resemble a false positive (DrWeb, Baidu, etc.) <br><br>  Let's go further - we will add protection from execution in our script to the test environment ‚Äî the simplest test that the file is executed in a real system.  To do this, run the unpacking only if there is a D drive in the system and there is at least one file on it: <br><br><pre> <code class="hljs perl">cd %myfiles% <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> exist d:<span class="hljs-regexp"><span class="hljs-regexp">/* (7za e -pfun eicar-fun.7z) start eicar.com</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">We look at detekty</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ht/hw/qw/hthwqwacmx63mztxmlswwv-cjog.jpeg"><br><br>  <b>Special attention</b> is on the bottom of the table, I singled out it separately, because everything did not fit into one picture: <br><br><img src="https://habrastorage.org/webt/dz/qp/_a/dzqp_aoivmbwt1jb6kthv2at_ic.jpeg"></div></div><br>  So, the D check ‚Äúbroke off‚Äù the detections of the Chinese, Russians and Ukrainians: Baidu, DrWeb, Zillya.  At the same time, these engines, like a number of others, were stopped by a timeout (!) <br><br><div class="spoiler">  <b class="spoiler_title">For the sake of justice, it is worth noting that the restart did bring the scan to the end</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ok/id/vd/okidvdvnh6mi3xyl2ogzhwt1qkc.jpeg"><br></div></div><br>  However, in this case, the experiment cannot be considered ‚Äúpure‚Äù, since a considerable time has passed since the first check. <br><br>  I found this situation curious - and I changed the line in the code to the following: <br><br><pre> <code class="hljs ruby">... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> &lt;b&gt;<span class="hljs-keyword"><span class="hljs-keyword">not</span></span>&lt;<span class="hljs-regexp"><span class="hljs-regexp">/b&gt; exist d:/</span></span>* (<span class="hljs-number"><span class="hljs-number">7</span></span>za e -pfun eicar-fun.<span class="hljs-number"><span class="hljs-number">7</span></span>z) ...</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">The checkout is impressive.</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/rg/fo/-z/rgfo-zkfb874acgw659ja5nixzq.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">However, again, the second scan did take place.</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/vm/v1/wl/vmv1wlqa5nmdqwkehjanrijpd3y.jpeg"><br></div></div><br>  There is a difference in the heuristics of a number of antiviruses (for some reason, AegisLab and Baidu did not find anything in the second case), and there is also a scanning problem in case of checking for a disk D. However, this may be a coincidence, although I‚Äôve never seen anything else during the whole study. I have never seen the "dump" of so many engines at once. <br><br>  Moving on, we add interactivity to our file, which we definitely won't have in any test environment.  Modify the script - let's make it a full console (not ‚ÄúGhost‚Äù), and also add the pause command: <br><br><pre> <code class="hljs perl">@cd %myfiles% @pause @if exist d:<span class="hljs-regexp"><span class="hljs-regexp">/* (7za e -pfun eicar-fun.7z) &gt; nul @start eicar.com</span></span></code> </pre> <br>  Here is the result of the execution of such a file: <br><br><img src="https://habrastorage.org/webt/h9/ld/d_/h9ldd_4wadyc9x5oahohcvqya3s.jpeg"><br><br>  I do not want to slander users, but it seems to me that almost everyone will press a key in this case :) In any case, we have a simple example, which can be turned into a brighter wrapper of social engineering. <br><br><div class="spoiler">  <b class="spoiler_title">Detection of such a file</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c3/v6/nc/c3v6ncyzcew4364nwunzmwua-tw.jpeg"><br></div></div><br>  6 of 67 detects. <i><b>Six, Karl!</b></i>  All are heuristic.  And most likely the unsuspecting user will find the file safe. <br><br>  I got an interesting result after compressing the final file with the UPX command: <br><br><pre> <code class="hljs pgsql">upx <span class="hljs-comment"><span class="hljs-comment">--best --ultra-brute --8086 --backup --compress-icons=3 dumb_bat3.exe</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">If we do this for our very first code - which was generally without checks, then Antiy-AVL fell off the detectors</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ac/bp/em/acbpemyvc-xy3l6hm-xqdq3o2ny.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">For the latest version, the file has decreased, the essence has not changed, but the detections have increased</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/zp/j3/rq/zpj3rqhaqnb32lb235-ilwijfx4.jpeg"><br></div></div><br>  Detectors added Chinese, but Ukrainian Zillya successfully failed the test. <br><br><h3>  Part 4. Conclusions </h3><br>  Is it possible without them?  ;) Okay. <br><br>  Of course, the above is primitive, simple, and everything in life is not so.  If only because in reality the execution of our file will first trigger the activation of the pro-activation, and then it will be blocked by the resident module, which will see the final Eicar file. <br><br>  But the point is not that. <br><br>  The fact is that modern antivirus scanners have remained junk, which were a dozen or two years ago, absolutely grazing before the simplest types of code packaging.  Solutions in the form of test environments - sandboxes, heuristic analyzers, etc.  only added confusions, false positives, but in fact do not protect against a real threat.  With the old, open and chewed up giblets, UPX as it was a mess - so it remained.  But I could easily pack not the file causing the malicious activity, but the code itself, work not with files on the disk in% temp%, but in memory, use not freely available utilities, but own or closed development - and thus circumvent the resident triggering protection.  I could easily add interesting elements of the interface or copy one of the common program - and bypass the proactivate from an inexperienced user who will simply agree with any requests, trusting what he launched. <br><br>  What we have done above is a primitive way to deceive an antivirus that almost anyone can understand and implement.  And it worked.  What to say about sophisticated professionals! <br><br><img src="https://habrastorage.org/webt/1c/p1/dh/1cp1dhdwuqir24ucfdug4ce11oy.jpeg"><br><br>  The archive with files, scripts and results can be downloaded <a href="http://mir.cr/ECUXMQE7">here</a> . <br><br>  The following was not included in the archive (it will not be included and will not be provided at any request for obvious reasons): files processed according to the above mechanism and containing: <br><br><ul><li>  <u>File Infector Sality.aa</u> <br><br><div class="spoiler">  <b class="spoiler_title">The results of the scan of the infector itself</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/jv/ll/a1/jvlla1j6aka1e1yz5vnupaw69jq.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Shame on the jungle</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ei/kh/cu/eikhcu8ca06ktz1omo5qwrrep9g.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">'Packing' scan results</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/84/e2/rh/84e2rhjdgyaittybzmgqtnyq3wo.jpeg"><br></div></div></li><li>  <u>Quite loudly most recently hit Petya locker</u> <br><br><div class="spoiler">  <b class="spoiler_title">The results of the scan of the infector itself</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/yq/s6/ad/yqs6adyvabb6dzm7iuzi7zfma2w.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Twice the shame of the jungle</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/rv/q4/1b/rvq41bipxprgmvvwlymvze-ex9c.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">'Packing' scan results</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/n1/d2/rp/n1d2rp_sedaqm9gm7i6xvmce93m.jpeg"><br></div></div><br></li></ul><br><div class="spoiler">  <b class="spoiler_title">If you have read all this to the end - click here.</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/a7/4d/nm/a74dnmepw-flvjjepoit98taj9e.jpeg"><br><br><h2>  I sincerely hope that I was not boring and I can still clearly express my thoughts on the subject, as I once had before. </h2></div></div></div><p>Source: <a href="https://habr.com/ru/post/346480/">https://habr.com/ru/post/346480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346470/index.html">Corporate habits in British and American companies</a></li>
<li><a href="../346472/index.html">Tiny CI of your Symfony project in 2 minutes</a></li>
<li><a href="../346474/index.html">Our experience creating web flow chart editor</a></li>
<li><a href="../346476/index.html">OpenStreetMap conferences in 2017</a></li>
<li><a href="../346478/index.html">User Reddit under the name DeepFakes has taught neural networks to create intimate videos with stars</a></li>
<li><a href="../346482/index.html">Using cucumber as a business rules engine</a></li>
<li><a href="../346484/index.html">The largest events of 2018: design and front-end</a></li>
<li><a href="../346486/index.html">Overview of the procurement of web applications on the Zend Framework 3</a></li>
<li><a href="../346488/index.html">21 tips to make better use of Composer</a></li>
<li><a href="../346490/index.html">What to look at the weekend? Review of the best reports in the public domain. Part Two, JBreak 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>