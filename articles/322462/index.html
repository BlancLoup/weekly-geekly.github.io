<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>sip messages: delayed delivery</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The topic of messages (ala SMS) in Asterisk is not the first on Habr√© , but all publications have one drawback - they do not have the functionality of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>sip messages: delayed delivery</h1><div class="post__text post__text-html js-mediator-article">  The topic of messages (ala SMS) in Asterisk is <a href="https://habrahabr.ru/post/207622/">not the first on Habr√©</a> , but all publications have one drawback - they do not have the functionality of deferred message delivery.  When the recipient is not online, you receive a message about it when you try to send him a message, and the offer to try later. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d19/7ac/023/d197ac0233b20d025b75f7ce7dbe5a54.png" alt="image" width="500"></div><br>  Disorder! <br><a name="habracut"></a><br>  We will work with asterisk 11, with FreePBX installed.  Traditionally, ‚Äúwithout configs‚Äù will not work this time. <br><br>  So, we allow the work of messages and specify the context for processing them in the webmoney section Settings ‚Üí Asterisk SIP Settings.  At the very bottom we add custom fields for sip.conf and specify: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">accept_outofcall_message</span></span> = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> outofcall_message_context = messages auth_message_requests = <span class="hljs-literal"><span class="hljs-literal">no</span></span></code> </pre> <br>  Create this context in extensions_custom.conf: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs perl">[messages] <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span>.,<span class="hljs-number"><span class="hljs-number">1</span></span>,Set(MSG_TO=${CUT(MESSAGE(to),@,<span class="hljs-number"><span class="hljs-number">1</span></span>)}) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span>.,n,MessageSend(${MSG_TO},${MESSAGE(from)}) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span>.,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${MESSAGE_SEND_STATUS}</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>]?sendfailedmsg) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span>.,n,Hangup() <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span>.,n(sendfailedmsg),Set(MSG_TMP=${CUT(MESSAGE(from),&lt;,<span class="hljs-number"><span class="hljs-number">2</span></span>)}) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span>.,n,Set(MSG_FROM=${CUT(MSG_TMP,@,<span class="hljs-number"><span class="hljs-number">1</span></span>)}) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span>.,n,Set(ODBC_SAVE_MESSAGE(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${MESSAGE(from)}</span></span></span><span class="hljs-string">"</span></span>,<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${MSG_TO}</span></span></span><span class="hljs-string">"</span></span>,<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${MESSAGE(body)}</span></span></span><span class="hljs-string">"</span></span>)=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span>.,n,Set(MESSAGE(body)=<span class="hljs-string"><span class="hljs-string">"[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${STRFTIME(${EPOCH},,%d%m%Y-%H:%M:%S)}</span></span></span><span class="hljs-string">]    </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${EXTEN}</span></span></span><span class="hljs-string">  .   ,     ."</span></span>) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span>.,n,MessageSend(${MSG_FROM}, SYSTEM) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span>.,n,Hangup()</code> </pre><br>  In this context, there is a call to an ODBC function that stores the SMS text in MySQL.  In order not to fool around with separate databases and DSNs, I created a table in the existing asteriskcdrdb database: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`messages`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`dt`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>, <span class="hljs-string"><span class="hljs-string">`mfrom`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`mto`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`mbody`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`delivered`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0000-00-00 00:00:00'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1 AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> ;</code> </pre><br>  Add the ODBC_function itself in the func_odbc.conf file: <br><br><pre> <code class="hljs pgsql">[SAVE_MESSAGE] writesql = <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> messages (mfrom,mto,mbody) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'${ARG1}'</span></span>,<span class="hljs-string"><span class="hljs-string">'${ARG2}'</span></span>,<span class="hljs-string"><span class="hljs-string">'${BASE64_ENCODE(${ARG3})}'</span></span>) dsn = asteriskcdrdb</code> </pre> <br>  As you can see, the text of the message is encoded in base_64 before saving.  In such a simple way, I bypass glitches with Cyrillic.  By the way, the transmission of text in the context of messages must be enclosed in quotes, otherwise when a message appears, for example, a comma in the text, dialpan considers this as a parameter separator :) <br><br>  So, our messages are saved to the database in the absence of a subscriber in the network.  It remains to configure the mechanism for delivering this message to him.  We will do on php, the script I put in /etc/asterisk/send_delayes_messages.php: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">#asteriskcdrdb database #mysql settings $hostname = "localhost"; $username = "asteriskuser"; $password = "password"; $dbName = "asteriskcdrdb"; mysql_connect($hostname,$username,$password) or die("no connect to MySQL."); mysql_select_db($dbName) or die("ERROR: ".mysql_error()); mysql_query("set names 'utf8'"); $messages_query = mysql_query('SELECT `id`,`mfrom`,`mto`,`mbody` FROM `messages` WHERE `delivered` = "0000-00-00 00:00:00" ORDER BY `dt`') or die("ERROR: ".mysql_error()); while($message = mysql_fetch_array($messages_query, MYSQL_ASSOC)) { $peer_to = explode(":", $message['mto']); if (peer_online($peer_to[1])) { //print_r($message); file_put_contents('/tmp/delayed_message_'.$peer_to[1].'_'.time(), 'Channel: Local/s@default'."\r\n".'Application: MessageSend'."\r\n".'Set: MESSAGE(body)='.base64_decode($message['mbody'])."\r\n".'Data: '.$message['mto'].','.$message['mfrom']."\r\n"); exec("mv /tmp/delayed_message_* /var/spool/asterisk/outgoing/"); mysql_query('UPDATE `messages` SET `delivered` = "'.date("Ymd H:i:s").'" WHERE `id` = '.$message['id']." LIMIT 1") or die("ERROR: ".mysql_error()); } } function peer_online($peer) { $raw = shell_exec('asterisk -rx "sip show peer '.$peer.'" | grep "Status" | grep "OK"'); print $raw; if(!empty($raw)) return true; else return false; } ?&gt;</span></span></code> </pre> <br>  As a label for the fact of delivery, I use the delivered field of the timestamp type, if there are zeros there, then the message needs to be delivered.  Thus, running through saved undelivered messages, we check for each registration of a peer through the cli command, and if it is online, we create an outgoing call file, which delivers this message.  After this, the script marks the message in the database, setting the date of sending. <br><br>  It will be necessary to fasten the script via php -f /etc/asterisk/send_delayes_messages.php to the minute-by-minute cron and once a minute, the message will be checked and attempted. <br><br>  What are the disadvantages of this implementation?  The first is that the registration of the status of a peer is kept for some time after the break, and it is quite possible that the feast will register briefly and fall off, and the system will ‚Äúsend‚Äù a message to it within a minute, and will consider it delivered.  You can get out using not the Application in the call-file, but transferring the data to the context with checking the status of the $ {MESSAGE_SEND_STATUS} variable.  Probably, it will be possible to use the existing context by setting variables via Set in a call-file. <br>  But while I stopped at this: there is no time. <br><br>  Good luck! </div><p>Source: <a href="https://habr.com/ru/post/322462/">https://habr.com/ru/post/322462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322450/index.html">Immunitable data in C ++. Part 2</a></li>
<li><a href="../322452/index.html">How to conduct A / B testing on Twitch</a></li>
<li><a href="../322454/index.html">Four non-secret advice Stirlitz</a></li>
<li><a href="../322458/index.html">After stealth: how to preserve the freshness of horror games</a></li>
<li><a href="../322460/index.html">Documenting # microservices</a></li>
<li><a href="../322464/index.html">How is ABC analysis used in stock?</a></li>
<li><a href="../322466/index.html">Where to talk "on IB": OWASP Russia Meetup # 6 will be held in the office of Positive Technologies</a></li>
<li><a href="../322468/index.html">February 23: there is no worse thing than an IT person</a></li>
<li><a href="../322470/index.html">What to read to the programmer at your leisure</a></li>
<li><a href="../322474/index.html">Events, tires and data integration in the challenging world of microservices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>