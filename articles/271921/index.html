<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Record a video call from the browser: we hoped to file a week</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the beginning of our journey, our voximplant cloud platform allowed us to work only with voice calls. But progress does not stand still, and over t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Record a video call from the browser: we hoped to file a week</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/360/bd6/028/360bd6028ed34a96ab05bdd4d30068e4.jpg" align="left">  At the beginning of our journey, our voximplant cloud platform allowed us to work only with voice calls.  But progress does not stand still, and over time we added video transmission, text messages, presence, and many other features.  And recently we finished developing the video recording function: now during a video call, it‚Äôs enough to call the record function from the javascript call manager to get a link to the recorded video file. <br><br>  For our clients, everything looks and works very simply, but for us this task was not as simple as we thought.  Several months it took our far from weak developers to solve a number of technical problems and create an adequately working solution.  Under the cut - the story of our struggle with codecs, file formats and webRTC. <br><a name="habracut"></a><br>  Video calls are different.  You can call from the browser using the fashionable technology webRTC.  If the browser is old and there is no technology in it, you can roll back to flash.  You can do without a browser and use the phone program, the so-called ‚Äúsip softphone‚Äù.  You can connect to the Internet physical video phone with SIP support and make calls through it.  You can make a mobile application calling via the Internet: especially for this we have <a href="https://voximplant.com/docs/references/mobilesdk/ios/">sdk</a> for ios, android and react native. <br><br>  All these methods are united using the SDP protocol, thanks to which the parties involved in the video call agree on the resolution of the video, the codecs used and many other things needed to organize the call. And at this moment we get the first problem. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  <b><font color="00384F">Difficulties with codecs</font></b> </h1><br>  Codecs are different.  SIP phones can try to agree on any.  For flash, this is h.264.  But for webRTC the story is quite interesting.  The webRTC Standardization Committee has been puzzled for a long time about which codecs to make mandatory for the protocol: vp8 does not require patent fees, but h.264 is in every refrigerator.  In the end, they spat on this case and made both codecs <a href="https://tools.ietf.org/html/draft-ietf-rtcweb-video-06">mandatory to implement</a> .  So despite the fact that de facto webRTC uses VP8, H.264 support is specified in the standard and, possibly, will receive some distribution. <br><br><img src="https://habrastorage.org/files/e6b/fd9/87d/e6bfd987d4904d21ad1abf500b189919.png" align="right">  What are the problems?  Oddly enough, with containers.  We do not know in advance about which codec the calling parties agree.  Moreover, the video can be turned on and off during a call.  Not all containers are equally useful, and for most containers libraries require you to immediately specify the codec for the video - which we do not yet know at the time of recording.  And customers want to give the video in the most common containers, and that there is good compatibility with browsers.  And browsers do not support all possible combinations when playing videos.  For example, most browsers will not be able to play mp4 with VP8 video codec.  And I‚Äôm not talking about the ‚Äúbad‚Äù combinations of video and audio codecs. <br><br>  The most durable solution we have found is the recording of video and sound into an intermediate file, after which the conversion without recoding to the desired format.  Data can be written both in raw files and in a container.  After some discussion, we decided to use the mkv container: it supports all the necessary codecs and simply convert it to other formats. <br><br><h1>  <b><font color="00384F">Video recording</font></b> </h1><br><img src="https://habrastorage.org/files/8b0/172/bc2/8b0172bc203442c79481cb313e6e6d5d.png" align="left">  At first we tried to go the easiest way and use the de facto standard video library, the great and powerful ffmpeg.  But reality often makes adjustments to ambitious plans.  It turned out that the mkv module for writing the container of the same name is complex.  No, not so - it is <b>DIFFICULT</b> .  Having spent several days on not very successful struggle with api and studying numerous unanswered questions in Google search, we changed tactics and began to look for a replacement.  It turned out you don‚Äôt need to go far: the <a href="https://github.com/Matroska-Org/libmatroska">libmatroska</a> from the mkv team is easy to use and works out of the box, which could not fail to please our developers. <br><br>  The result is the following architecture: <br><br><ol><li>  Javascript client running in our cloud calls the call.record () method with the settings ‚Äú{video: true}‚Äù for video recording. </li><li>  Our server creates the mkv file and records the video for the corresponding participant in the call (if any) and two audio tracks, one per participant in the call. </li><li>  If the javascript is subscribed to the recording start event, then the corresponding callback is called from the url of the file being written (more on that later). </li><li>  After the end of the call, the python script is executed, which analyzes the tracks in the mkv file and converts it to either .mp4 or webM, depending on the codec used.  Audio tracks are combined into one, stereo or mono for choice.  In the case of stereo, the voice of the first participant of the call is placed in the left stereo channel, and the second participant in the right one. </li><li>  The resulting file is uploaded to Amazon, where it becomes available at the previously issued URL.  The file in the URL does not have an extension (since we do not know it at the time of the start of the recording), so its type is transmitted to the MIME client by the field in the HTTP header. </li></ol><br><br><h1>  <b><font color="00384F">Bonus for Habr</font></b> </h1><br><img src="https://habrastorage.org/files/dbe/cae/aa6/dbecaeaa6f7041f2a968f400751447cb.png" align="right">  Open source we love not less than javascript and webrtc.  Since we have spent so much time recording calls, we can and should share with the community.  Especially for harabrachiteli we laid out on github the c ++ library created by us for recording mkv video in a few lines of code.  So if you ever face a similar task, you will be able to take advantage of our work and save some time.  The library is available under the MIT license in our <a href="https://github.com/voximplant/zmkv">official repository</a> . <br><br><h1>  <b><font color="00384F">findings</font></b> </h1><br>  Initially, we wanted to ‚Äúburn‚Äù a video recording for a couple of weeks.  It turned out for a couple of months.  Why does this happen?  The rapid development of the software development industry has led to a rapid change in technology and the emergence of a huge number of narrow specializations.  Therefore, when planning, if you do not have a specialized specialist in the team, you can seriously ‚Äúmiss‚Äù, without disregarding any nuance.  Agile approach recommends that before planning technically complex projects, a series of experiments be carried out in order to make sure that the technological stack is properly understood and there are no major surprises.  Actually, this is exactly what we did the first week - we looked at different libraries for recording video and checked them on our data.  But even a carefully laid straw can not always protect from surprises at a later development time.  For us, such surprises were the opportunity to pause the video, packet loss and other small nuances.  As it turned out, writing a video call is much more difficult than TCP stream from the camera. <br><br>  The recording of video calls created by us made a favorable impression on the first customers who tried, and they have already started shipping their ideas on ‚Äúimprovement and expansion‚Äù to us.  Let's see how the created architecture turned out to be adequate to the task: I hope that in half a year we will not write an article ‚Äúhow we remade the video recording‚Äù :).  We also plan to do the conversion in the near future not only in the ‚Äúnative‚Äù container, but immediately in both.  The load on computing power, of course, will increase, but clients will be able to play recorded video in any modern browser. <br><br>  A sample of the recorded video call, a 10 megabyte file can be downloaded <a href="https://ru04-records-voximplant.s3.amazonaws.com/a759b2377992cad4.1448894512.1019691">here</a> : <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/b8DZQrln8TI%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhINAwucxbjPhHrp7_K7CksgydUTQ" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/271921/">https://habr.com/ru/post/271921/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271909/index.html">QCTF Starter: computer security for four or how we made a tournament for beginners in 19 cities simultaneously</a></li>
<li><a href="../271911/index.html">Equivalent transformations of Maxwell equations (ps)</a></li>
<li><a href="../271913/index.html">We test the quality of VoIP passing through common channels (Windows)</a></li>
<li><a href="../271915/index.html">.NET-hardcore in Moscow</a></li>
<li><a href="../271919/index.html">The digest of interesting materials for the mobile developer # 131 (November 23-29)</a></li>
<li><a href="../271927/index.html">Works and Copies</a></li>
<li><a href="../271929/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ187 (November 23 - 29, 2015)</a></li>
<li><a href="../271931/index.html">How is the rendering frame in GTA V</a></li>
<li><a href="../271935/index.html">What is under the hood of travel startups or why does a programmer need to go to Hack`n`Roll</a></li>
<li><a href="../271937/index.html">5 major risks in custom software development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>