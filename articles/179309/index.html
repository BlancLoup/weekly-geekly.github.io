<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of one garbage collection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This enlightening story tells how important it is to develop googling skills and how I struggled with the hourly full Garbage collection. 

 Brief des...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of one garbage collection</h1><div class="post__text post__text-html js-mediator-article">  This enlightening story tells how important it is to develop googling skills and how I struggled with the hourly full Garbage collection. <br><br><h3>  Brief description of the problem </h3><br>  After we migrated in production one of the system components (the only one working on Tomcat) to the new version of Tomcate, the support suddenly panicked, seeing half-second GC launches in the logs. <br><a name="habracut"></a><br>  In general, in our project (FX trading platform in an investment bank) any launch of GC for more than 50 milliseconds (ms) causes concern for the support that monitors, among other things, the GC logs, and GC for more than 100 ms causes hysteria.  Therefore, having seen 1.45 seconds in the logs, they simply panicked.  I was lucky to be on the ‚Äúsecond line of defense‚Äù that day, and I started to figure out what the matter was. <br><br><h3>  Investigation progress </h3><br>  For a start, got into the logs.  And saw: <br> <code>[Full GC (System) 25.575: [CMS: 20700K-&gt;22393K(655360K) &lt;...&gt;</code> <br> <br>  The key here is an indication that this is System - i.e.  full garbage collection is activated by calling <code>System.gc()</code> .  I think it would be superfluous to say that this is not used in our code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text">  To be completely honest, this is not true - we use the call <code>System.gc()</code> , with quite a good purpose.  The fact is that during the launch process, the system pre-caches a huge amount of ‚Äústatic data‚Äù - information about users, currencies, etc., and this process generates quite a lot of garbage.  Therefore, after we have finished all the preparations, and immediately before we report that the system has started, we call <code>System.gc()</code> to at the same time get rid of unnecessary memory fragmentation.  In addition, we do the same thing every night at 5:00 pm New York time, when the trading day ends, and our entire system goes offline for 5 minutes (maintenance mode), in order to remove the garbage accumulated during the day and defragment the memory .  During working hours, we try to avoid the old-gen collection, since even ParNew assemblies that take 20-40 ms sometimes create unallowable delays. </div></div><br>  First of all, the old memory was checked by the <a href="http://publib.boulder.ibm.com/infocenter/javasdk/v5r0/index.jsp%3Ftopic%3D%252Fcom.ibm.java.doc.diagnostics.50%252Fdiag%252Funderstanding%252Frmi_dgc.html">DGC</a> (reference to the anti-Mongolian, briefly the garbage collector activated when used in the RMI application).  Once, it was he who caused the complete builds every hour on many of our systems, for the simple reason that we use RMI for JMX.  Therefore, one fine day, many years ago, we on all systems added the following to the JVM launch parameters: <br><br><pre> <code class="bash hljs">-Dsun.rmi.dgc.server.gcInterval=0x7FFFFFFFFFFFFFFE -Dsun.rmi.dgc.client.gcInterval=0x7FFFFFFFFFFFFFFE</code> </pre><br>  Sources of these settings: <a href="http://www.oracle.com/technetwork/java/javase/gc-tuning-6-140523.html">[1]</a> , <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/rmi/sunrmiproperties.html">[2]</a> .  All that they are called to change is to tell the DGC that it can be run once in <code>0x7FFFFFFFFFFFFFFE</code> milliseconds (approximately once in 292471208 years). <br><br>  After checking the start script of Tomkata, I saw that there was a small error there, and instead of <code>0x7FFFFFFFFFFFFFFE</code> , <code>0x7FFFFFFFFFFFFFFF</code> used.  The boundary value causes an <code>IllegalArgumentException</code> (code from the <code>sun.misc.GC</code> class): <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.latency == <span class="hljs-number"><span class="hljs-number">9223372036854775807L</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"Request already cancelled"</span></span>); }</code> </pre><br><h4>  We need to go deeper! </h4><br>  However, correcting this misunderstanding, I was very surprised when, after restarting the tomkats, we again saw all the same hourly <code>Full GC (System)</code> !  I had to strain my mind.  To find out who is to blame for the <code>System.gc()</code> call, I quickly wrote my implementation of the <code>java.lang.Runtime</code> class, copying the standard class and changing its <code>gc()</code> method (which is called when <code>System.gc()</code> called). <br>  Original method: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br>  Modified method: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Thread.dumpStack(); }</code> </pre><br>  As you can see, everything that we are doing here - we will find out who caused us all the same, by outputting the spectra to <code>stdout</code> , since  all that the <code>Thread.dumpStack()</code> method <code>Thread.dumpStack()</code> is create an exception and output it to the framework: <br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Prints a stack trace of the current thread to the standard error stream. * This method is used only for debugging. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> Throwable#printStackTrace() */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dumpStack</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Stack trace"</span></span>).printStackTrace(); }</code> </pre><br>  We substitute the <code>java.lang.Runtime</code> class in our java machine with <code>-Xbootclasspath/p:/tmp/runtime</code> , run ... And what do we see? <br><br><pre> <code class="java hljs">java.lang.Exception: Stack trace at java.lang.Thread.dumpStack(Thread.java:<span class="hljs-number"><span class="hljs-number">1249</span></span>) at java.lang.Runtime.gc(Runtime.java:<span class="hljs-number"><span class="hljs-number">689</span></span>) at java.lang.System.gc(System.java:<span class="hljs-number"><span class="hljs-number">926</span></span>) at sun.misc.GC$Daemon.run(GC.java:<span class="hljs-number"><span class="hljs-number">92</span></span>)</code> </pre><br>  The same DGC!  But how?  Did we actually set an infinite interval between DGC launches?  Here I had to strain all my googling skills.  And so I searched, and that way - I could not find anything.  I checked if anyone overwrites my settings for the DGC - it turned out that by the time GC was launched, all system properties had the same values ‚Äã‚Äãas I set.  Surprise‚Ä¶ <br><img src="https://habrastorage.org/getpro/habr/post_images/def/f8b/b4b/deff8bb4bc7cf554ab29d2e95e8a8d13.jpg" alt="image"><br><br><h4>  ... Deeper! </h4><br>  At this point, my suspicion fell on the volume.  And so, the happy combination of words in the request to Google did give me one single link that made me say what I was very ashamed to type here, and my English colleagues (who helped me, as far as possible, in the investigation, by asking guiding questions like "Did you try to google?") looked at me very disapprovingly ... Then they looked at what was written on the link - and repeated my curses. <br>  So, here it is, the <a href="http://stackoverflow.com/questions/14902928/why-does-the-jvm-of-these-tomcat-servers-perform-a-full-gc-hourly">link</a> , which, in turn, leads to tomkata bugzilla: tynts.  In short, these brilliant guys from Apache, through reflection, overwrite the value of the interval with which the DGC should be called, right in the <code>sun.rmi.GC</code> class, and despite the fact that we set our <code>-Dsun.rmi.dgc.*</code> Properties, they are still have no effect!  For we use tomkat 6.0.35, and this bug was fixed in the next version, 6.0.36. <br><br>  Here is the code from the Tomcat class <code>JreMemoryLeakPreventionListener</code> , which is actually responsible for this behavior: <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Several components end up calling: * sun.misc.GC.requestLatency(long) * * Those libraries / components known to trigger memory leaks * due to eventual calls to requestLatency(long) are: * - javax.management.remote.rmi.RMIConnectorServer.start() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gcDaemonProtection) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string"><span class="hljs-string">"sun.misc.GC"</span></span>); Method method = clazz.getDeclaredMethod(<span class="hljs-string"><span class="hljs-string">"requestLatency"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[] {<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.class}); method.invoke(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, Long.valueOf(<span class="hljs-number"><span class="hljs-number">3600000</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (...) { ... } }</code> </pre><br>  In the same place, on SO, I found and workaround: <br><blockquote>  set <code>/&gt;</code> </blockquote><br><br>  That is what I did.  As you can see from the code above, the <code>gcDaemonProtection</code> flag simply disables this block of code responsible for the strange behavior.  And - oh, a miracle!  - That helped!  Hourly garbage collection disappeared into oblivion, the support is happy, I went to drink tea. <br><br><h3>  findings </h3><br>  And the conclusions, in general, are few: <br><ol><li>  The most important thing is to learn how to formulate requests to Google!  I tried with a dozen different combinations, until finally I came across a completely banal query <code>tomcat hourly full GC</code> , which gave me the desired link. </li><li>  No need to imply that third-party, even if very well-known software, does not have bugs - it even has!  And this is not the first time when we run into bugs.  Last time it was a bug in Hotspot CMS, which very badly spoiled our time for garbage collection.  I decided to upgrade to a new JVM. </li><li>  And, of course, reflection is evil, especially if you are a developer of a container or a library, and use your <s>dirty hands to</s> reflect on system classes. <br></li><br><br>  Thank you for your attention, I hope someone my experience will be useful. </ol></div><p>Source: <a href="https://habr.com/ru/post/179309/">https://habr.com/ru/post/179309/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179295/index.html">Japanese old man creates amazing pictures using Excel (Wait, Excel?)</a></li>
<li><a href="../179297/index.html">Pistol "Liberator": 100 thousand downloads in two days</a></li>
<li><a href="../179299/index.html">The digest of interesting news and materials from the world of IT and web development for the last week No. 56 (May 4 - 10, 2013)</a></li>
<li><a href="../179303/index.html">In-app purchases - some statistics</a></li>
<li><a href="../179307/index.html">Learning experience in programming students</a></li>
<li><a href="../179315/index.html">Microsoft and Adobe have released updates for their products.</a></li>
<li><a href="../179317/index.html">Debugging Go Code with GDB. Introduction</a></li>
<li><a href="../179319/index.html">Analysis of "scam" on playing cards</a></li>
<li><a href="../179323/index.html">DLink DNS-325 - we connect cloud storages via WebDav</a></li>
<li><a href="../179327/index.html">Million articles in Russian Wikipedia!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>