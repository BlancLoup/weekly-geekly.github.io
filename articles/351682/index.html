<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Graal: how to use the new JIT JIT compiler in real life</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the main Siberian Java conference JBreak-2018 , held in Novosibirsk, Christian Thalinger from Twitter shared his practical experience of using Graa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Graal: how to use the new JIT JIT compiler in real life</h1><div class="post__text post__text-html js-mediator-article">  At the main Siberian Java conference <a href="https://2018.jbreak.ru/">JBreak-2018</a> , held in Novosibirsk, Christian Thalinger from <a href="https://twitter.com/">Twitter</a> shared his practical experience of using Graal.  The company (‚ÄúPeter-Service‚Äù) sent our entire working group to the conference, and we came to listen to this report as a whole.  This is understandable if you take into account the fact that Graal is still considered a bold and potentially dangerous experiment (although it is very likely that it will enter JDK 10).  It was very interesting to learn how this new product manifests itself in battle - yes, not anywhere, but in the development of this level. <br><br><img src="https://habrastorage.org/webt/f1/_3/ta/f1_3taqo6b3fbkimdqnkzu9ox8e.jpeg"><br><br>  Christian Talinger has been working with Java virtual machines for more than a dozen years, and the key skill in his expertise is JIT compilers.  That Christian introduced Graal and became the initiator of his current (very, according to Chris, active) use in the production environment Twitter.  And, according to Talinger, this innovation saves the company a lot of money by saving iron resources. <br><a name="habracut"></a><br>  <a href="https://habrahabr.ru/company/jugru/blog/349638/">Here in this interview</a> with the organizers JBreak Christian lucidly explains the basics - what Graal is and how to manage it.  Well, the report in Novosibirsk was more practice-oriented: its main task was to show the audience how to start working with Graal in a simple and painless way, and why it is worth trying. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For a start - still a couple of theoretical introductory.  So what is a JIT - just-in-time compiler?  To run the program in Java, you need to perform several steps: first compile the source code in the instructions for the JVM - bytecode, and then run this bytecode in the JVM.  Here the JVM acts as an interpreter.  The JIT compiler was created to speed up Java applications: it optimizes the bytecode being started by translating it into low-level machine instructions right while the program is running. <br><br>  HotSpot / OpenJDK uses two levels of JIT compilation implemented in C ++.  These are C1 and C2 (also known as client and server).  By default, they work together: first, a quick but superficial optimization with C1 is performed, and then the hottest methods are further optimized with C2. <br><br>  In Java 9, a mechanism was implemented within <a href="http://openjdk.java.net/jeps/243">JEP-243</a> for embedding a compiler written in Java into the JVM.  And this is a dynamic compiler - JVMCI (Java Virtual Machine Compiler Interface).  Actually, this mechanism also supports Graal.  I must say, in Java 9 Graal was already available as part of <a href="http://openjdk.java.net/jeps/295">JEP-295</a> - AOT-compilation (Ahead-of-time) in the JVM.  True, although the AOT compilation mechanisms use Graal as a compiler, this JEP states that initially the integration of Graal code into the JDK is assumed only within the framework of the Linux / x64 platform. <br><br>  So, to try Graal, you need to take the JDK with AOT and JMVCI.  And if you need to run on MacOS or Windows platforms, you will have to wait for the release of Java 10 (in the corresponding ticker <a href="https://bugs.openjdk.java.net/browse/JDK-8172670">JDK-8172670</a> fix version is put in the top ten). <br><br><img src="https://habrastorage.org/webt/q5/7r/v1/q57rv1pjjuadpn43tvjn9mjyusa.jpeg"><br><br>  Here Christian drew attention to the fact that in the current JDK distributions, the Graal version is, to put it mildly, outdated (either a year ago, or even younger).  But here the modularity of Java 9 comes to the rescue. Thanks to it, we can build the latest version of the Graal sources and embed it in the JVM using the --upgrade-module-path command.  Since the development of Graal was started long before the system of modules, a special tool, mx, is used to build it, which to some extent repeats the modular Java system.  The tool runs on Python 2.7, all links can be found in <a href="https://github.com/oracle/graal">the Graal repository in GitHub</a> . <br>  That is, we first extort and install mx, then we extort Graal and assemble it into the module via mx, which will then replace the original module in the JDK. <br><br>  At first glance, these manipulations may seem complicated and labor-intensive, but in reality this feature is not so terrible.  And in principle, the ability to replace the Graal version without waiting for the patch to be released on the JDK or even the new JDK, personally seems to me more than convenient.  At least, Christian showed how he collected it all live on the machines in the cloud.  When building Truffle, however, an error occurred - some additional dependencies were needed that were installed on the machine.  But Graal gathered correctly and was used in this form (from which we conclude that we can forget about Truffle: Graal is completely independent of it). <br><br>  Next: in order for the JVM to start using Graal, you need to additionally set 3 flags: <br><br><pre><code class="bash hljs">-XX:+UnlockExperimentalVMOptions -XX:+UseJVMCICompiler -XX:-EnableJVMCI</code> </pre> <br>  Since, in essence, Graal is a normal Java application, it also needs to compile and prepare itself for work (the so-called bootstrapping).  In the default mode (on-demand), this happens in parallel with the launch of the application, in which case Graal uses C1 to optimize its code. <br><br>  It is also possible to explicitly launch initialization before starting the application, and in this situation, you can even instruct Graal to optimize itself.  However, this usually takes much more time and does not provide significant benefits.  The Grail is initialized a little longer than C1 / C2, and it uses the free processor power more actively due to the fact that it needs to compile more classes.  But these differences are not so great and are practically leveled, being lost in the general noise when the application is initialized. <br>  In addition, since Graal is written in Java, it uses heap for initialization (in the case of C1 / C2, memory is also used only through malloc).  The main memory consumption comes at the start of the application.  Both Graal and C1 / C2 use free kernels when compiling.  Memory consumption by Grail can be traced by enabling GC logging (currently, no heap isolation for Graal initialization from the main application heap is provided). <br><br>  Well, we learned how to set it all up - it's time to understand why.  What are the benefits of using Graal? <br><br>  Christian used a practical example to answer this question.  He launched a couple of benchmarks from one project written in Scala: one was actively working with the CPU, and the other was already interacting more actively with the memory.  On the benchmark that worked with the CPU, when using Graal, there was a noticeable slowdown by an average of a second due to a longer start (the benchmark itself was running for 5 seconds).  But on the second benchmark, Graal showed quite a good result - ~ 20 seconds versus ~ 28 on C1 / C2.  And this is despite the fact that, as noted by Christian, the Scala Graal example does not work as well as it could (due to the dynamic structure of the generated Scala bytecode).  That is, you can hope that in the case of a pure Java application, everything should be even better. <br><br>  Plus, when outputting GC logs, it was clear that with the Graal application produces much less garbage collections (about 2 times).  This is associated with more efficient escape analysis, which allows you to optimize the number of objects created on the heap. <br><br><img src="https://habrastorage.org/webt/cx/mw/h2/cxmwh26r0tj_aujlihbu21l-hwo.jpeg"><br><br>  Summarizing my personal impressions of what I heard, I will say that the report seemed to me rather comprehensive, and not at all carrying an advertising message in the spirit of ‚Äúall go urgently to Graal‚Äù.  It is clear that the magic tablet does not happen, and everything always determines the real application - Christian himself recognizes that the specific values, of course, depend on the specific benchmarks.  Those who decide to try the Grail, in any case, will have to apply the method of scientific typing, run and (surely) find bugs (and it is better then to edit them and issue pull-requests in the Graal repo). <br><br>  But in general, with the current trend towards the use of microservices and stateless applications - and, as a result, the Young Gen - Graal looks very good in a more active (and correct) application. <br><br>  So, if the project can be translated with little blood into Java 9 (or write from scratch on it), I would definitely try Graal.  And, for example, I was even pleased that the whole emphasis in the report was made specifically on Graal as a JIT compiler - because in general, it is in that capacity that an ordinary Java developer is required (that is, without Truffel and other things from GraalVM, which Oracle recently combined into a framework for development and runtime for various languages ‚Äã‚Äãbased on JVM).  It would be interesting to test the cost of memory and see how noticeable the difference between the standard C1 / C2 and Graal.  On the other hand, despite the fact that quite a decent amount of memory is allocated to the application in our time, and its main volume is consumed at startup (and today it is usually the initialization and start of the container that the application is already launching), these figures are probably in any case not so significant. <br><br>  <i><a href="https://downloads.ctfassets.net/oxjq45e8ilak/1r4i54cCKIicQckSGUCWu2/24589d235f05db55cd3532fa64886ed5/Chris_Thalinger_Graal_-_How_to_use_the_new_JVM_JIT_compiler_in_real_life__1_.pdf">Here</a> you can download the presentation from the report.</i> <br><br>  In truth, I personally was so interested in the idea that I plan to repeat all the steps taken by Christian, but I‚Äôll try to get rid of Java benchmark suites directly (for example, DaCapo and SPECjvm2008 - I‚Äôm not so good at Java benchmarking, so I would appreciate it if someone will offer more adequate options in the comments or HP).  Well, closer to the specifics of work - I will try to sketch a simple web application (for example, SpringBoot + Jetty + PostgreSQL), drive under load and compare the numbers.  The results promise to share with the community. </div><p>Source: <a href="https://habr.com/ru/post/351682/">https://habr.com/ru/post/351682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351672/index.html">About porting the MIPSfpga project</a></li>
<li><a href="../351674/index.html">Neoquest 2018: ‚ÄúAirship? Yeah! ‚Äù</a></li>
<li><a href="../351676/index.html">How professional interest stole my weekend</a></li>
<li><a href="../351678/index.html">Angular application architecture. We use NgModules</a></li>
<li><a href="../351680/index.html">DEFCON conference 17. ‚ÄúStealing profits from spammers: how I stopped worrying about spam and loved it‚Äù. Grant jordan</a></li>
<li><a href="../351684/index.html">In google with no work experience. Programmer from Silicon Valley about Russian diplomas, interviews and work in the US</a></li>
<li><a href="../351686/index.html">Big clump of dirt</a></li>
<li><a href="../351688/index.html">The sysadmin needs long hands</a></li>
<li><a href="../351690/index.html">Useful to the designer and developer. Fresh utilities and tools to speed up work. Issue number 10</a></li>
<li><a href="../351692/index.html">Disruption of a large-scale hacker attack on Windows users in Russia: part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>