<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Centralized log storage for Squid Proxy or how we wrapped the logs in the database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username%, 

 Today I would like to tell you about the rather trivial task of collecting logs from decentralized Squid proxy servers and the pitfa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Centralized log storage for Squid Proxy or how we wrapped the logs in the database</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f44/761/ce4/f44761ce4323873a566ccac5aff56c0f.gif" alt="image"></div><br>  Hi% username%, <br><br>  Today I would like to tell you about the rather trivial task of collecting logs from decentralized Squid proxy servers and the pitfalls we faced. <br><br>  What we have: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Squid-hq </li><li>  Squid-br1 </li><li>  Squid-br2 </li><li>  Squid-br3 </li><li>  Squid-br4 </li><li>  Squid-db </li></ol><a name="habracut"></a><br>  As can be seen from the list, there are 5 squid proxy servers in different remote offices, and 1 database for collecting logs.  All OS CentOS 7.3, squid proxy from 3.3.8 to 3.5.26, Squid-db - with installed mariadb 5.6 <br><br>  From the fact that we managed to find this <a href="https://sourceforge.net/projects/logmysqldaemon/">pearl barley scripts and schema</a> , we actually take them as a basis: <br><br><ol><li> Install dependencies on squid proxy servers: <br> <code>yum install perl perl-Readonly* perl-URI perl-YAML perl-DBI perl-Carp perl-DBD-mysql</code> <br> </li><li>  Then we put in place the scripts and the config for connecting to the database: <br><br> <code>cp log_mysql_daemon.pl /usr/libexec/squid/log_mysql_daemon.pl</code> <br> <br>  Giving rights: <br><br> <code>chmod +x /usr/libexec/squid/log_mysql_daemon.pl <br> chown squid:squid /usr/libexec/squid/log_mysql_daemon.pl</code> <br> <br></li><li>  Next, create a config file to connect the script to the database: <br><br> <code>vi /etc/squid/log_mysql_daemon.conf <br> <br> host: "&lt;database-ip&gt;" <br> database: "squid_log" <br> table: "access_log" <br> user: "squid" <br> pass: "&lt;squid-passwd&gt;"</code> <br> <br></li><li>  Create a database, import the schema and create a user: <br><br> <code>mysql -p <br> create database squid_log; <br> CREATE USER 'squid'@'%' IDENTIFIED BY '&lt;squid-passwd&gt;'; <br> GRANT ALL PRIVILEGES ON squid_log.* TO 'squid'@'&lt;Squid-hq-ip&gt;'; <br> GRANT ALL PRIVILEGES ON squid_log.* TO 'squid'@'&lt;Squid-br1-ip&gt;'; <br> GRANT ALL PRIVILEGES ON squid_log.* TO 'squid'@'&lt;Squid-br2-ip&gt;'; <br> GRANT ALL PRIVILEGES ON squid_log.* TO 'squid'@'&lt;Squid-br3-ip&gt;'; <br> GRANT ALL PRIVILEGES ON squid_log.* TO 'squid'@'&lt;Squid-br4-ip&gt;'; <br> exit <br> <br> cat log_mysql_daemon-table.sql log_mysql_daemon-views.sql | mysql -p squid_log</code> <br> <br></li><li><br>  Moving to the <s>evil</s> side squid proxy config <br><br>  Add configuration for daemon <br><br> <code>vi /etc/squid/squid.conf <br> <b>acl dontLog http_status 403 407</b> <br> logformat squid_mysql %ts.%03tu %6tr %&gt;a %Ss %03Hs %&lt;st %rm %ru %un %Sh %&lt;A %mt squid-hq <br> access_log /var/log/squid/access.log squid <br> access_log daemon:/etc/squid/log_mysql_daemon.conf squid_mysql <b>!dontLog</b> <br> logfile_daemon /usr/libexec/squid/log_mysql_daemon.pl</code> <br> <br>  Parse: <br>  <b>acl dontLog http_status 403 407</b> is an optional string, removes errors from the log going to the database associated with the eror codes 403, 407. The base will grow in geometric progression and will not carry any value for reporting <br><br>  <b>logformat squid_mysql% ts.% 03tu% 6tr%&gt; a% Ss% 03Hs% &lt;st% rm% ru% un% Sh% &lt;A% mt squid-hq</b> - set the format to the log, one of the important conditions for multiple squid servers is the last value with the name of the server from which logs come.  In the original scripts, there is no functionality, so we wind up this line and the script itself as follows: <br><br>  in /usr/libexec/squid/log_mysql_daemon.pl we add squid-server to the column setup <br><br> <code># fields that we should have in the database table <br> # this list depends on the log format configuration <br> my @required_fields = qw( <br> id <br> time_since_epoch <br> response_time <br> client_src_ip_addr <br> squid_request_status <br> http_status_code <br> reply_size <br> request_method <br> request_url <br> username <br> squid_hier_status <br> server_ip_addr <br> mime_type <br> <b>squid_server</b> <br> );</code> <br> <br>  <b>access_log /var/log/squid/access.log squid</b> - We leave local logs for debugs and cases of problems with the database, they have rotations enabled, so they won‚Äôt be superfluous <br><br>  <b>access_log daemon: /etc/squid/log_mysql_daemon.conf squid_mysql! dontLog</b> - the actual line itself to the configuration of the daemon.  Please note that <b>! DontLog</b> cancels logging 403,407 <b>only</b> for the database, so in the case of debugging you can easily use local logs <br><br>  <b>logfile_daemon /usr/libexec/squid/log_mysql_daemon.pl</b> - path to the pearl-barley daemon <br><br></li><li>  Rereading squid proxy configs <br><br> <code>squid reconfigure <br> squid -k reconfigure</code> <br> <br>  and we get the desired result: <br><img src="https://habrastorage.org/getpro/habr/post_images/c43/d3a/097/c43d3a0970db08236d01569a93f0f74a.jpg" alt="image"><br><br>  Available tables and views: <br><img src="https://habrastorage.org/getpro/habr/post_images/c87/543/e03/c87543e03a365c7008e8dd0e1d5c14be.jpg" alt="image"><br></li></ol><br><h3>  Conclusion: </h3><br>  As you can see, the data are now centrally located in the database and easily accessible for processing.  Next, we plan to write a frontend for filtering and exporting data (reporting).  In general, the article was written and compiled from various sources, unfortunately I could not find everything together anywhere, so I consider it advisable to leave it here. <br><br>  Would you be interested in reading the continuation of a series of articles about the Squid Proxy? </div><p>Source: <a href="https://habr.com/ru/post/335204/">https://habr.com/ru/post/335204/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335188/index.html">ML Boot Camp V, solution history for 3rd place</a></li>
<li><a href="../335192/index.html">What are the bad nested classes and how to learn rails magic</a></li>
<li><a href="../335194/index.html">Why do you need SBC on the border</a></li>
<li><a href="../335196/index.html">Cryptocurrency Dash invites ... to crack your blockchain</a></li>
<li><a href="../335200/index.html">What is always worth remembering when localizing a website, so that later was not ashamed</a></li>
<li><a href="../335206/index.html">Outsourcing: Pros and Cons</a></li>
<li><a href="../335208/index.html">Oh, I have a delay</a></li>
<li><a href="../335210/index.html">GraphQL offline queries with Redux Offline and Apollo</a></li>
<li><a href="../335212/index.html">Algorithm for memorizing foreign words</a></li>
<li><a href="../335214/index.html">‚ÄúA train that could!‚Äù Or ‚ÄúSpecialization Machine learning and data analysis‚Äù, through the eyes of a beginner in Data Science</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>