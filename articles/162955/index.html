<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Positioning without GPS: how Yandex.Lokator works</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now more and more mobile applications are becoming geo-dependent. Some simply do not make sense without knowledge of the location of the user, others ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Positioning without GPS: how Yandex.Lokator works</h1><div class="post__text post__text-html js-mediator-article">  Now more and more mobile applications are becoming geo-dependent.  Some simply do not make sense without knowledge of the location of the user, others become more convenient with him.  These are the so-called Location Based Services (LBS): navigators, forkswera, instagrams with photo geotags and even reminder applications that work around a specific place, for example, near an office or a store. <br><br>  For Yandex services and applications, we created our own implementation of the method of determining the location without GPS - Yandex. <a href="http://api.yandex.ru/locator/">Locator</a> .  It saves user time and makes our applications a little smarter.  In Navigator and Maps, it saves you from entering the starting point of the route, even if you are in a covered parking lot.  And when choosing a movie in the Kinoafish or product in the mobile Market it helps to immediately show where to find them in your area of ‚Äã‚Äãthe city.  Well, of course, when searching for cafes and ATMs - it allows you to show you immediately, even when you are on the subway. <br><img src="https://habrastorage.org/getpro/habr/post_images/a60/3c7/1b5/a603c71b55fb31875a9af054db27206c.png" alt="image"><br><br>  We <a href="">have long discovered the</a> technology as a free API.  Today we want to tell how it works. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><h4>  Why no GPS and how else </h4><br>  Satellite navigation systems ( <a href="http://en.wikipedia.org/wiki/GNSS">GNSS</a> ), in our case, this is GPS and GLONASS, is the most accurate method of geo-determination today.  The corresponding modules are in almost all modern smartphones.  But not always and not everywhere he can solve the problems of LBS. <br><br>  First, the search for satellites sometimes takes a few minutes, and there are situations in which the speed of determination is important even with loss of accuracy.  For example, when you need to build a preliminary route in the navigator or <a href="http://ru.wikipedia.org/wiki/%25D0%2593%25D0%25B5%25D0%25BE%25D1%2581%25D0%25BE%25D1%2586%25D0%25B8%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2581%25D0%25B5%25D1%2582%25D0%25B8">check in</a> .  Secondly, satellites are usually not ‚Äúvisible‚Äù in rooms or underground.  Thirdly, GPS-modules are not in every mobile phone or tablet, and they are almost absent in laptops.  That is, LBS needs alternatives. <br><br>  And there are, of course, alternatives - you can determine the location by the nearest GSM towers, Wi-Fi networks and even by IP address.  The accuracy of determining each of these methods is much worse than that of GPS.  But if you combine them, they together will give an acceptable quality.  At the same time, some of the shortcomings of one are neutralized by the capabilities of the other.  GSM-towers are practically everywhere, and Wi-Fi networks are not.  In this case, Wi-Fi accuracy is better.  Therefore, the combined method of completeness and accuracy is better than each separately.  Less well known is the fact that two routers in different parts of the city can have the same MAC address.  The combination of GSM and Wi-Fi solves such collisions.  Most likely, these routers will have towers with different identifiers nearby - after all, the probability of coincidence within a quarter is much less than in the whole city. <br><br>  In the world there are several implementations of such a combined method of geo-determination.  And it seems that the first question that all developers faced was where to get information about the location of Wi-Fi networks and cell towers? <br><br><h4>  Network Location Base </h4><br>  In the buy or create dilemma, we ultimately preferred the latter.  The main reason is that with own data and algorithms it is much easier to control the quality of the result.  Users of mobile Yandex.Maps helped us collect information. <br><br>  When we started developing the Locator, there were already hundreds of thousands of people on the streets of the cities with Yandex.Maps included in their phones.  With the user's consent, the application constantly transmits its GPS coordinates - Yandex.Probits are built based on this information.  We thought that along with this, the application can mark which base station the phone is servicing in these coordinates, which Wi-Fi networks are visible (while, of course, not connecting to the networks themselves, so as not to create privacy risks). <br><br>  A person does not need to do anything specifically to participate in such crowdsourcing - just use the application.  As well as on coordinates, the data on the surrounding Wi-Fi networks and GSM stations are impersonal.  They practically do not "weigh", and the battery does not sit down faster from their transmission, respectively. <br><br>  Thus, users began to help each other: <br><img src="https://habrastorage.org/getpro/habr/post_images/1ef/a4e/021/1efa4e021f20b50f4f8198dfbb19c1a4.png" alt="image"><br>  Some, with a GPS receiver in the phone, find out the exact location of the networks and transmit information to Yandex.  Others who do not have GPS modules send a list of networks that they see at the moment and receive their approximate location on the map in reply. <br><br>  The base is collected and regularly updated.  And here we are faced with the following problem. <br><br><h4>  "Moving" networks </h4><br>  Experience shows that cell tower identifiers are constantly changing - the number that was in the center of the city yesterday may be on the outskirts tomorrow.  Wi-Fi routers can also move - along with their owners.  And it turns out that with each move you need to invalidate a significant part of the data. <br><br>  This is how we managed to solve at the same time problems with moving both towers and routers.  The user is asked to determine the location along with information about which network he sees.  If there is one in the list of networks that was seen in different parts of the city, the algorithm takes into account how many signals from it are accumulated in each district and the age of the latter.  Each dense cluster of signals from a Wi-Fi network or cell tower we call a ‚Äúcloud‚Äù.  The more signals in the cloud and the fresher they are, the more trustworthy it is.  The answer will be, respectively, the largest and freshest.  And we consider the cloud, in which there are no signals for more than a month, obsolete - even if no more fresh cloud appeared in this area for another network. <br><br><h4>  Cloud radius </h4><br>  Since the position is approximately determined, it is impossible to show a point - you need to draw a circle (because the radio signal in the absence of interference is distributed in all directions evenly).  Although, if you look at the actual picture of the signals, most often it is an ellipse.  Indeed, motorists use mobile maps the most.  Their GPS-traces remain on the roads, and from the courtyards and, especially, from the buildings, signals are practically not received. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b17/6ca/297/b176ca29750ee0ff21ca429e7e496ce6.png" alt="image"><br><br>  For the answer to be extremely accurate, the radius of the circle must be minimal.  If you simply circle the circle around all points of the signals of a particular network, the radius will be too large.  Reduce it helped mat.  statistics.  Signal density is subject to normal distribution, that is, the <a href="http://ru.wikipedia.org/wiki/%25D1%25F0%25E5%25E4%25ED%25E5%25EA%25E2%25E0%25E4%25F0%25E0%25F2%25E8%25F7%25E5%25F1%25EA%25EE%25E5_%25EE%25F2%25EA%25EB%25EE%25ED%25E5%25ED%25E8%25E5">three-sigma rule</a> applies.  99.7% of the points fall into the vicinity of such a radius. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f7c/9d7/5f8/f7c9d75f8b73d58d20fafa7a0f36f6b2.png" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/5e1/8da/764/5e18da764c6b11cbc70796f44e38ece3.png" alt="image"><br><br>  We decided to go further and experimentally selected sigma for a coefficient that minimized the radius as much as possible, but retained acceptable accuracy.  It was possible, because in most cases the user sees several networks.  That is, the ‚Äúopen‚Äù areas with a decrease in the coefficient are most likely overlapped by other clouds. <br><br><h4>  Cloudy signals </h4><br>  Unfortunately, not all GPS signals from users are simply bundled into the clouds.  It turned out that if you put on the map all the signals of a single network, in addition to the ‚Äúellipses‚Äù, points and lines will appear on it.  These are, respectively, single signals, far removed from the accumulation of signals from the same network, and very long GPS tracks (ie, a chain of GPS signals). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/434/94c/87d/43494c87d55555277787b407a8e3189b.png" alt="image"><br><br>  "Singles" appear, for example, when a person moves on the subway.  The phone loses connection with the cell at one station, and when it reaches the other one, it still believes that it is serviced by that cell.  Such signals Locator filters.  In addition, we set a minimum threshold for clouds so as not to rely on clusters of signals that are too small. <br><br>  Long GPS tracks appear, for example, when a person drives a car through the whole city.  The phone ‚Äúdrags‚Äù the tower identifier from the beginning of the route and reports that it allegedly sees it all the way.  It is known that base stations have a limited range, so the GPS locator also filters out such GPS tracks.  Tracks, the length of which fits into the range of the tower, remain.  As a rule, they are noticeable in areas where there is little data.  There they become a chain of small clouds. <br><br>  We consider single signals, small clouds and long tracks ‚Äúnoise‚Äù.  When the user sees a single network for which we know only such signals, he receives the answer that the location could not be determined.  We believe this is more correct than giving a deliberately wrong, according to our estimates, result. <br><br>  When little data was accumulated, there was another difficulty with combining all the signals into one cloud.  It happened that the signals from the tower from one city came also from another.  The presence in the identifiers of GSM networks of the location area code LAC (Location Area Code) helped us.  Since the towers with the same code should be close by the standard, to the clouds that were ‚Äúnot in their city‚Äù (ie, among the clouds with another LAC), the Locator began to give underweight. <br><img src="https://habrastorage.org/getpro/habr/post_images/fb3/977/c89/fb3977c89927720a798806fc8744dd30.png" alt="image"><br><br><h4>  Improved accuracy of determination ... </h4><br><h5>  ... via GSM networks </h5><br>  Once upon a time, information about only one base station was available to applications, although the phone most often sees several.  After the advent of the Android platform, applications were able to learn <a href="http://developer.android.com/reference/android/telephony/TelephonyManager.html">to see them all</a> (except for connecting to the 3G standard, which allows you to find out only one cell tower).  The location was determined more precisely - no longer on one cloud, but on the totality of several.  It turned out that for many clouds you can use the same approach as for one.  The radius is calculated from the standard deviation of the signals included in the combination of clouds, and the center is calculated from their average coordinates. <br><br><h5>  ... via Wi-Fi networks </h5><br>  When a smartphone is within range of several Wi-Fi networks, it can report not only their list, but also the signal strength of each.  Knowledge of this power we used to clarify the center of the circle in which the user is located.  We began to hang imaginary springs to the centers of the observed clouds - the tighter the stronger the signal.  And their free ends - to connect.  The point at which these springs are balanced is the specified center. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/968/ec5/899/968ec58993299b9db03f6a58cd056a40.png" alt="image"><br><br><h4>  The resulting quality </h4><br>  First, a few words about how we evaluate the quality of our decision.  As already mentioned, from users who have a GPS module in their devices, Latitude receives both coordinates and a list of networks that see devices.  To assess the quality, he first determines the approximate location, focusing only on these networks.  It then checks to see if the true coordinates from the user are in the circle suggested by Locator. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f9d/bb1/bf3/f9dbb1bf383b82556989495570fc1117.png" alt="image"><br><br>  Using this technique, we obtained the following figures: <br><ul><li>  for 83% of requests per day, the location is determined correctly - the GPS coordinates of the device fell into an area called Locator </li><li>  14% of signals - with an error: <br><ul><li>  7% - error less than 100 meters </li><li>  5.6% - from 100 meters to several kilometers </li><li>  1.4% - Locator wrong city </li></ul></li><li>  the remaining 3% of requests receive the answer "Location not found" </li></ul><br><br><img src="https://habrastorage.org/getpro/habr/post_images/165/51d/efd/16551defd535e13d8fd4321db3306a2c.png" alt="image"><br><img src="http://habr.habrastorage.org/post_images/afa/19d/045/afa19d045b2bce238895a5f2856f9174.gif"><br><br>  Is it possible to achieve better quality?  Yes.  The advantage of the method is that at a certain maturity of the algorithms, it is enough to collect more data in order to determine the location more accurately.  And this is quite easy, because the number of Wi-Fi networks and the number of users of our applications is growing. <br><br>  But there are technological limits: <br><ul><li>  if the phone reports only one GSM tower - the minimum radius will be several hundred meters in the city, and several kilometers outside the city </li><li>  if the phone sees several towers - the center can be determined more precisely, but the radius can hardly be reduced </li><li>  if the Wi-Fi network is visible - the minimum radius will be 10 meters </li></ul><br><br><h4>  Calculation volumes </h4><br>  To quickly respond to the user, you need to prepare in advance the entire answer, or at least a substantial part.  Every night, a cluster based on our distributed computing system <a href="http://events.yandex.ru/talks/44/">YAMR</a> aggregates signals received up to yesterday, getting ready for the answer "clouds".  At the time of the request, the Latitude remains only the right way to combine them.  So terabytes of "raw signals" shrunk to 1.5-2 GB of ready-made answers that easily fit into memory.  And the preparation of the response almost always fits into 1 ms, and each server in the cluster withstands 10 thousand RPS. <br><br>  And so that the duration of the daily calculation does not grow linearly with the growth of the history of GPS signals, we have achieved the "additivity" of the clouds.  Now it is enough to store only a few indicators for each cloud, and there is no need to re-process the entire old history every day. <br><br>  Preparing a more complete answer is ineffective.  If you cluster each combination of networks into a separate cloud, you get a combinatorial explosion.  The volume of ready-made answers grows by several orders of magnitude, and with partial overlap of the networks, even more calculations are needed to prepare an answer. <br><br><h4>  Analogs </h4><br>  Location services without GPS, as we have said, are not only available to Yandex.  Developers can contact a commercial provider (such as <a href="http://www.altergeo.ru/">Altergeo</a> in Russia and <a href="http://www.skyhookwireless.com/">Skyhook Wireless</a> in the world), or use the mobile platform or browser API. <br><br>  In general, such a database can be assembled in three ways: <br><ul><li>  go around the cities of interest by car, scan the network, and then periodically go around again to update the base </li><li>  create a massive mobile application (for example, Yandex.Maps) </li><li>  create a mobile platform (for example, iOS or Android) </li></ul><br>  But only the developer of a geo-dependent application has to choose between different solutions, and the user ‚Äúlives‚Äù with this choice.  In the absence of a uniform comparison methodology, attention should be paid to the accuracy of determination (radius of the ‚Äútolerance‚Äù and the percentage of errors) in the regions of interest. <br><br>  True, the developer may not always choose.  On iOS and Windows Mobile, the application can only use geo-detection functions built into the operating system.  The application does not have access to the current base station and / or a list of WiFi networks other than the current one. <br><br>  Another situation in web services.  All modern browsers have a <a href="http://en.wikipedia.org/wiki/W3C_Geolocation_API">geo-definition API</a> .  And changing the browser, the user changes the geo-determiner.  Firefox and Google Chrome use the Google implementation, Safari uses Apple, and IE uses Microsoft.  Our Locator works in the <a href="http://browser.yandex.ru/">Yandex browser</a> . </div><p>Source: <a href="https://habr.com/ru/post/162955/">https://habr.com/ru/post/162955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162945/index.html">NASA bombs the moon online</a></li>
<li><a href="../162947/index.html">"Problem 2000" in WebMoney WMClasses</a></li>
<li><a href="../162949/index.html">Autonomous work frontend (stub, proxy_store, use_stale)</a></li>
<li><a href="../162951/index.html">If you are a rubist, then from what language did you switch to Ruby?</a></li>
<li><a href="../162953/index.html">DARPA begins development of long-haul 100 Gbps systems</a></li>
<li><a href="../162957/index.html">Payments to DealExtreme (www.dx.com) are now available via WebMoney</a></li>
<li><a href="../162961/index.html">Would you buy a paid and stable Linux distro?</a></li>
<li><a href="../162963/index.html">New courses on Windows Server 2012 on the MVA portal</a></li>
<li><a href="../162965/index.html">The most stupid domain dispute of the year</a></li>
<li><a href="../162969/index.html">How to choose an investor and present a project to him: checklist, rake and delusions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>