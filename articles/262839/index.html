<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Porting Arm Mbed OS to a dedicated controller</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Arm Mbed OS is a popular open source project that accelerates the development of devices for the Internet of Things (IoT). If you have created your un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Porting Arm Mbed OS to a dedicated controller</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/e1/df/kf/e1dfkfxvx5-rwi5rhvyogpzte5s.jpeg"><br><br>  <b>Arm Mbed OS</b> is a popular open source project that accelerates the development of devices for the Internet of Things (IoT).  If you have created your unique processor device, then the first task will be to port some operating system (OS) to it. <br><br>  Here is a step-by-step instruction on how to launch <b>Arm Mbed OS</b> on a motherboard with a <b>NXP Kinetis</b> microcontroller family. <br><a name="habracut"></a><br><h3>  <b>Arm Mbed OS</b> project </h3>  is owned by ARM and is intended only for the ARM architecture.  Contrary to popular belief, <b>Mbed is</b> not written entirely in C ++, is not sharpened exclusively for <b>Cortex-M</b> and is not that new.  Its origins lie in the distant 90s when <b>Keil</b> created <b>RTX</b> , the real-time operating system (RTOS) for I8051.  Subsequently, the <b>RTX</b> was Keil transferred to ARM7 and ARM9, and then Cortex appeared. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ARM acquired <b>Keil</b> and RTOS was named <b>CMSIS-RTOS</b> .  It was still entirely written in <b>C.</b>  Finally, with the arrival of the <b>IoT and Arduino</b> boom, <b>Mbed</b> appeared.  <b>Arduino's</b> changes caused a <b>C ++</b> shell and a simplified API with a familiar set of dozens of pins, a UART and a LED, and IoT filled the project with <b>TCP / IP, Bluetooth Low Energy, 6LoWPAN, Thread</b> <b>stacks</b> ... But <b>RTX5</b> still sits in the depth of the source code <b>Mbed OS</b> . <br><br>  The <b>Keil</b> brand continues to exist and in the Keil development tools distribution kit, you can find CMSIS-RTOS with a large selection of middleware and porting examples for a larger range of microcontroller families than <b>Mbed</b> offers.  However, it is a closed commercial project. <br><br><h3>  Specialized fee </h3><br>  for which the porting is made here for an example and its scheme does not matter much.  More importantly the microcontroller that is installed on it.  This is the <b>MKE18F512VLL16 of the Kinetis</b> family from NXP.  Its main parameters are: <br><blockquote>  Kernel - ARM Cortex-M4F 32-Bit <br>  Maximum core frequency - 168MHz <br>  Flash 512KB (512K x 8) <br>  RAM 64 KB <br>  100-LQFP (14x14) <br></blockquote><h4>  Microcontroller content </h4><br><img width="500" align="left" src="https://habrastorage.org/webt/ie/p-/ma/iep-map-ngkh0md2aiumhqkq080.png"><br><br>  This microcontroller is not in the list of supported ARM Mbed OS.  It can be explained by the fact that it is <b>relatively new</b> . <br><br>  The microcontroller is interesting with a good set of peripherals at a fairly <b>modest price</b> and high core frequency.  The <b>FlexIO</b> module allows you to create <b>non-standard interfaces</b> that are not available on conventional microcontrollers. <br><br><img src="https://habrastorage.org/webt/lz/ou/dp/lzoudprmhyxm9cwixionj5rtbiq.gif"><br><br><h3>  Step 1. Downloading NXP Tools </h3><br><ul><li>  We configure our version of <i>MCUXpresso Software Development Kit (SDK)</i> for the <b>MKE18F512xxx16</b> family online at <a href="https://www.nxp.com/">www.nxp.com</a> </li><li>  When you need to specify the Toolchain / IDE, select the <b>IAR IDE</b> .  Further work will be considered in <b>IAR IDE</b> . </li><li>  Select all available <i>Software Components</i> . </li><li>  Download the resulting <i>MCUXpresso Config Tools, Windows 64bit package</i> from the site. <br><br><img align="right" src="https://habrastorage.org/webt/rk/uk/mb/rkukmb33r6orlicsj_byhpa8a3c.png">  This will be a 30 megabyte archive MKE18F512xxx16.zip with the following contents: <br><br><img src="https://habrastorage.org/webt/lz/ou/dp/lzoudprmhyxm9cwixionj5rtbiq.gif"></li><li>  - Download also <i>MCUXpresso Config Tools v4.1 for Windows</i> .  With it, we configure the microcontroller clocking subsystem. </li></ul><br><h3>  Step 2. Getting the application project without RTOS </h3><br><ul><li>  Launch <i>MCUXpresso Config Tools v4.1 for Windows</i> <br><br><img width="600" src="https://habrastorage.org/webt/u-/pf/w7/u-pfw7qzyuqvihhff4ekc4jhxss.png"></li><li>  As a template, choose one of the simplest demo examples - led_blinky. <br><br><img src="https://habrastorage.org/webt/f3/2k/bj/f32kbjasdsvs1ul5cqvtpkdu49c.png"></li><li>  We configure the clocking scheme and give the command to generate the clocking initialization sources.  Initialization sources are updated directly in the project directories. <br><br><img src="https://habrastorage.org/webt/9a/pp/jx/9appjxxmwquh67ctc0lvaeuxfzs.png"></li><li>  We copy the received project with source codes under <b>IDE IAR</b> in the directory.  In the project, select the <b>J-Link</b> debugger, the debug channel through the <b>SWD</b> interface.  We modify the write commands to the LED port, compile and upload to the board. <br></li></ul><br><br><h3>  Step 3. Configuring and converting the Mbed project </h3><br><ul><li>  We go to the site of the project <b>Mbed</b> in the platform section - <a href="https://os.mbed.com/platforms/">os.mbed.com/platforms</a> . <br><br>  There we are looking for a board with a microcontroller as close as possible to the one we have chosen. </li><li>  Choose a board <b>FRDM-K66F</b> - <a href="https://os.mbed.com/platforms/FRDM-K66F/">os.mbed.com/platforms/FRDM-K66F</a> .  The choice is not random, with a similar microcontroller have <a href="https://habr.com/post/392839/">experience</a> . </li><li>  On the page with the board presentation we decide to choose a demo - mbed-os-example-blinky - <a href="https://os.mbed.com/teams/mbed-os-examples/code/mbed-os-example-blinky/%3Fplatform%3DFRDM-K66F">os.mbed.com/teams/mbed-os-examples/code/mbed-os-example-blinky/?platform=FRDM-K66F</a> <br><br>  This is the simplest example and will be the easiest to adapt for another board. </li><li>  Register and go to the on-line section of the compiler - <a href="https://os.mbed.com/compiler/">os.mbed.com/compiler</a> </li><li>  First we select the platform - <b>FRDM-K66F</b> , and then we import the demo we have chosen - <b>mbed-os-example-blinky</b> .  In the <b>Programs</b> panel, this demo will be named <b>mbed_blinky</b> . <br><br><img align="left" src="https://habrastorage.org/webt/vd/od/ty/vdodty2ymjyorv1vpkj1rssubje.png"></li><li>  We compile this example for verification, and then export it. </li></ul><br>  We export in a format intended for <b>IDE IAR</b> <img align="right" src="https://habrastorage.org/webt/yk/vp/me/ykvpme5hxiqbwo30_v-wdhw6wus.png"><br><img src="https://habrastorage.org/webt/lz/ou/dp/lzoudprmhyxm9cwixionj5rtbiq.gif"><br><img align="left" src="https://habrastorage.org/webt/xq/9q/wj/xq9qwjwavvx3mneizeydngxbe-0.png"><br><br>  Now we have the source for the <b>Mbed</b> working project for <b>IAR</b> .  However, the resulting project is inconvenient to work. <br><br>  All files in the project were collected in one group and mixed.  It is impossible to search and identify which file belongs to which function package.  The project involved the <b>sources of almost all the middleware</b> project <b>Mbed</b> , although most of them we do not need now. <br><br><img src="https://habrastorage.org/webt/lz/ou/dp/lzoudprmhyxm9cwixionj5rtbiq.gif"><br><br><h3>  Step 4. Convert the IAR project to normal form </h3><br>  - With the help of specially written utilities in Python, we perform several conversion operations. <br><br>  First, we delete from the directories of the demonstration project all sources that are not included in the project.  The list of sources is obtained from the file <i>mbed-os-example-blinky.ewp</i> .  The utility is called <i>Clear_from_unused_files_and_dirs.py</i> .  It also removes the empty directories formed after deleting files. <br><br>  Secondly, using the <i>Convert_ewp_file.py</i> utility <i>,</i> we reconfigure the project file <i>mbed-os-example-blinky.ewp</i> so that the groups in it correspond to the project directories.  We get the project with a more understandable structure, where you can remove or add packages.  Here we can rename the project.  To do this, edit the tag <pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>mbed-os-example-blinky<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  in the file <i>mbed-os-example-blinky.ewp</i> .  Change the name of the file <i>mbed-os-example-blinky.ewp</i> (in this case, <i>Test_proj.ewp</i> ), fix the tag <pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path</span></span></span><span class="hljs-tag">&gt;</span></span>$WS_DIR$/mbed-os-example-blinky.ewp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  in the <i>mbed-os-example-blinky.eww file</i> (in this case on <i>Test_proj.ewp</i> ) and change the name of the <i>mbed-os-example-blinky.eww file</i> to the one we chose (in this case, <i>Test_proj.eww</i> ) <br><br><img align="left" src="https://habrastorage.org/webt/cf/yp/b4/cfypb45uuidjdmfewjwun3erngi.png"><br><br>  As a result, has a project structure <br><br><img src="https://habrastorage.org/webt/lz/ou/dp/lzoudprmhyxm9cwixionj5rtbiq.gif"><br><br><img align="right" src="https://habrastorage.org/webt/66/db/n1/66dbn1ybvdh1egkebzo4gnlzieu.png"><br><br>  - We study the source code to determine those of them that depend on the characteristics of the microcontroller.  For this, it is more convenient to use more specialized editors, such as SlickEdit or <b>Eclipse</b> .  The editor should also report macros declared in the <b>IDE</b> settings.  To do this, create an additional header file <i>Extra_options.h</i> and copy the contents of the <i>Extra Options</i> from <b>IDE IAR there</b> . <br><br><img src="https://habrastorage.org/webt/lz/ou/dp/lzoudprmhyxm9cwixionj5rtbiq.gif"><br><br><h3>  Step 5. Editing the Mbed project </h3><br>  We are ready to edit the project.  Let's start by analyzing the macros in the <i>Extra_options.h</i> file.  This is done in the editor with the appropriate capabilities, you can do in the IAR environment. <br><br>  - Remove unused macros so that they do not distract attention with further analysis.  We sort the rest.  About half of the macros were unused. <br><br>  - In <i>Extra Options,</i> enter the new macro - <i>TARGET_MKE18F</i> .  It defines the starting address of the stack in the <i>mbed_rtx.h</i> file.  The stack grows in the direction of decreasing addresses.  In <b>Mbed,</b> it is customary to start the stack from the top of the available RAM.  For MKE18F we set this limit to <i>0x20008000UL</i> <br><br>  - Find the directory <i>TARGET_K66F</i> .  There are stored files depending on the type of microcontroller.  There are quite a lot of them - 136 files.  Create next to the directory <i>TARGET_K66F</i> your own name <i>TARGET_MKE18F</i> . <br><br>  - From the directory of the demonstration project <b>SDK</b> <i>led_blinky \ CMSIS,</i> copy to the directory <b>Mbed</b> - <i>os \ targets \ TARGET_Freescale \ TARGET_MCUXpresso_MCUS \ TARGET_MKE18F \ device</i> files: <br><blockquote>  ‚Ä¢ fsl_device_registers.h.  (Macro CPU_MK66FN2M0VMD18 in Extra Options is replaced by CPU_MKE18F512VLL16) <br>  ‚Ä¢ MKE18F16.h <br>  ‚Ä¢ MKE18F16_features.h <br>  ‚Ä¢ system_MKE18F16.h <br>  ‚Ä¢ system_MKE18F16.c <br></blockquote><br>  - Delete files <br><blockquote>  ‚Ä¢ MK66F18.h <br>  ‚Ä¢ MK66F18_features.h <br>  ‚Ä¢ system_MK66F18.c <br>  ‚Ä¢ system_MK66F18.h <br></blockquote><br>  - In the <i>TOOLCHAIN_IAR</i> directory, <i>we</i> replace the contents with the <i>startup_MKE18F16.s</i> and <i>MKE18F512xxx16_flash.icf files</i> . <br>  - In the <b>IDE IAR</b> project, also for the linker, specify the path to the new file <i>MKE18F512xxx16_flash.icf</i> <br>  - The contents of the <i>Mbed-os \ targets \ TARGET_Freescale \ TARGET_MCUXpresso_MCUS \ TARGET_MKE18F \ drivers</i> directory are erased and populated with the <i>devices \ MKE18F16 \ drivers</i> directory <i>in the MKE18F512xxx16 family SDK</i> <br>  - Replace the <i>\ mbed-os \ targets \ TARGET_Freescale \ TARGET_MCUXpresso_MCUS \ fsl_common.c file</i> with the same one from the <i>devices \ MKE18F16 \ drivers</i> directory located in the <b>MKE18F512xxx16</b> <b>SDK</b> .  In the <i>Mbed-os \ targets \ TARGET_Freescale \ TARGET_MCUXpresso_MCUS \ TARGET_MKE18F \ drivers directory,</i> delete the same file. <br>  - From the <i>mbed-os \ targets \ TARGET_Freescale \ TARGET_MCUXpresso_MCUS \ TARGET_MKE18F \ drivers directory we</i> delete files in the name of which FreeRTOS is present. <br>  - From the <i>\ mbed-os \ features \ netsocket \ emac-drivers directory we</i> delete all the files associated with the K6 microcontroller EMAC peripherals, because the new microcontroller does not have EMAC. <br>  - Again we use the utility <b>Convert_ewp_file.py</b> <br>  - Compile and get 267 errors.  They are all in files that are in the <i>TARGET_MCUXpresso_MCUS</i> directory and are mostly named with the suffix <i>api</i> .  Each file must be dealt with separately.  A total of 12 files appear with errors. <br><br><h3>  Step 6. Editing Mbed Files </h3><br><h4>  Fsl_clock_config.c file </h4><br>  This is the most important file at this stage.  It is the initialization of clocking all subsystems of the chip.  The RTOS initialization function <i>mbed_sdk_init</i> calls the <i>BOARD_BootClockRUN</i> function from this file.  Replace the <i>fsl_clock_config.c</i> file <i>with</i> the verified file from the <b>led_blinky</b> project.  There it is called <i>clock_config.c</i> (renamed after copying to <i>fsl_clock_config.h</i> and correct <i>#include</i> in it where necessary), and the call to the <i>BOARD_BootClockRUN</i> function in the RTOS files is replaced with <i>BOARD_BootClockHSRUN</i> , because we want to start the chip at the maximum frequency of <b>168 MHz</b> . <br><br>  - We consider the remaining files.  Immediately raise doubts about their need.  Indeed, many of them are simple wrappers for peripheral functions with a simplified interface.  Most likely, they are made for an audience of novice programmers, for whom it is important that the API is similar to Arduino-based systems.  We may neglect these files as not carrying the payload, although we will not be accepted into the Mbed community for this. <br><br>  Files to remove: <br><blockquote>  API <br>  ‚Ä¢ analogin_api.c <br>  ‚Ä¢ analogout_api.c <br>  ‚Ä¢ dma_api.c <br>  ‚Ä¢ i2c_api.c <br>  ‚Ä¢ pwmout_api.c <br>  ‚Ä¢ spi_api.c <br>  ‚Ä¢ dma_api_hal.h <br><br>  Drivers <br>  ‚Ä¢ AnalogIn.cpp <br>  ‚Ä¢ I2C.cpp <br>  ‚Ä¢ I2CSlave.cpp <br>  ‚Ä¢ SPI.cpp <br>  ‚Ä¢ SPISlave.cpp <br>  ‚Ä¢ AnalogIn.h <br>  ‚Ä¢ AnalogOut.h <br>  ‚Ä¢ I2C.h <br>  ‚Ä¢ I2CSlave.h <br>  ‚Ä¢ PwmOut.h <br>  ‚Ä¢ SPI.h <br>  ‚Ä¢ SPISlave.h <br><br>  HAL <br>  ‚Ä¢ analogin_api.h <br>  ‚Ä¢ analogout_api.h <br>  ‚Ä¢ i2c_api.h <br>  ‚Ä¢ pwmout_api.h <br>  ‚Ä¢ spi_api.h <br></blockquote><br><ul><li>  Edit the file <i>mbed.h</i> to comment out the connection of the files that we deleted.  Also edit <i>object.h</i> . </li><li>  Edit the <i>mbed_die</i> function called when the system <i>crashes</i> .  By default, it flashes an LED.  Remove blinking, we do not have such an LED. </li><li>  We are <i>clearing PinNames.h</i> and <i>PeripheralNames.h</i> files from pin announcements and structures associated with api files deleted before this </li><li>  We delete unnecessary arrays in the <i>PeripheralPins.c</i> file, after that it remains only to edit the pin map for UARTs in it. </li><li>  We slightly change the directory structure and the location of files in the targets subdirectory to reduce the randomness of naming and file fragmentation. </li></ul><br>  List of remaining files requiring correction: <br><blockquote>  ‚Ä¢ serial_api.c <br>  ‚Ä¢ trng_api.c <br>  ‚Ä¢ flash_api.c <br>  ‚Ä¢ sleep.c <br>  ‚Ä¢ us_ticker.c <br></blockquote><br>  These files cannot simply be deleted, as important RTOS services depend on them.  The main problem is that the <b>MKE18F512xxx16</b> family uses a different peripheral name than the <b>MK66FN2M0VMD18</b> , although the periphery for the main API has almost remained the same. <br><br><h4>  File serial_api.c </h4><br>  In it, we mainly change the names of functions and enumerations inherited from the K66 chip.  This file defines low-level functions for debugging RTOS output via UART. <br><br><h4>  Us_ticker.c file </h4><br>  important because it determines the mechanism for obtaining the exact time in ticks for RTOS (in our example, the value of the tick is 1 Œºs).  This API is used in the RTOS delay functions and in the event queue services with a specified activation time on the time scale.  To organize a continuous time counter, the associated channels 0 and 1 of the PIT module are used.  Channel 0 has a period of 1 Œºs, channel 1 ends the cycle in 429 seconds (0xFFFFFFFF is loaded into it, the channel counter is decremented).  To queue events, channels 2 and 3 of the PIT module with interrupts from channel 3 are used. Thus it turns out that Mbed occupied the entire PIT module and cannot be used for anything else. <br><br><h4>  Trng_api.c file </h4>  realizes hardware random number generation.  In the chip <b>MKE18F512xxx16</b> there is no such generator, so we put plugs from the standard C function <b>rand</b> .  A good random number generator is needed for SSL and TLS data encryption protocols.  So far we are not planning to use such on our board. <br><br><h4>  Sleep.c file </h4>  implements the function of entering and exiting sleep mode.  This affects the work of the accelerator to work with Flash memory.  It is necessary to correct the names of the functions that allow and prohibit the flash memory cache. <br><br><h4>  File flash_api.c </h4>  implements functions for programming internal flash memory.  Here we came across the fact that <b>there</b> can be two sections of Flash memory in chips of the <b>MKE18F512xxx16</b> family.  Chose to work with section 0. <br><br>  - Correct macros with internal chip frequency values ‚Äã‚Äãin the <i>system_MKE18F16.h</i> file <br><br><h4>  Linker file MKE18F512xxx16_flash.icf. </h4><br>  It should have a declaration of the symbol <i>__VECTOR_RAM</i> .  This is the address from which the interrupt vector table will be placed in RAM.  In <b>Mbed OS, the</b> interrupt vector table is always copied from Flash to RAM since it can be programmatically modified by the system during operation. <br><br><h3>  Kurez </h3><br>  Rested against the fact that the vector <i>SVC_Handler is a</i> stub and fixated on itself.  And the initialization of <b>Mbed OS</b> causes exactly this vector.  Somewhere missing the moment of setting the correct vector.  It turns out they forgot to connect to IAR assembler files with the extension with a capital letter <b>S.</b>  And there the most important file with a context switch is <i>irq_cm4f.S</i> .  Thank you Python.  Fix the <i>Convert_ewp_file.py</i> utility and run it again.  Recompile the project. <br><br><h3>  How to revive a dead chip </h3><br>  When initializing GPIO ports, it is possible to randomly incorrectly initialize I / O lines for the debugger and quartz.  In this case, the chip stops debugging and even the SWD adapter J-Link stops programming.  In our case, the problem can be solved simply.  We short-circuit one output of the outer quartz to the ground, remove power, and serve again.  Our program will not reach the wrong initialization GPIO because stuck waiting for the inclusion of quartz.  At this time, SWD programming by the adapter becomes available again. <br><br><h3>  The problem of wrong time delay function wait </h3><br>  Measuring the blinking period of the LED, the slowdown in the execution of the <i>wait</i> function was found to be longer than expected exactly twice.  To check the correctness of the internal frequency settings, we initialize the output to the external output of the internal PLL clock divided by 8. We see the frequency 21 MHz.  All right <br><br>  During initialization of the frequency of ticks <b>RTX, the</b> parameters of which are set in the <i>RTX_Config.h</i> file, the <i>SystemCoreClock</i> variable is <i>used</i> , and it, in turn, is assigned in the <i>BOARD_BootClockHSRUN</i> function during system initialization and is equal to 168000000. Everything is also correct here. <br><br>  Checked in the <i>TimeLine</i> window of the <i>IAR</i> debugger the interrupt rate of the system tick, it is equal to 1 KHz, also correct. <br><br>  It turned out to be incorrectly initialized module <b>PIT</b> .  He stopped counting when <b>RTX</b> went into SLEEP mode.  And <b>RTX</b> enters this mode at every tick if there are no active tasks.  Thus, the timer stopped, but its values ‚Äã‚Äãwere used in the <i>wait</i> function to provide the most accurate delay.  But we inherited this error from the official port of Mbed for K66! <br><br>  On the third day, the porting of <b>ARM Mbed OS was</b> successfully completed and the LED flashes. <br>  <a href="https://github.com/Indemsys/Mbed_led_blinky_MKE18F">github.com/Indemsys/Mbed_led_blinky_MKE18F</a> <br><br><img src="https://habrastorage.org/webt/x_/fh/to/x_fhtok0q1ck36mqlzcx7rvxj70.png"></div><p>Source: <a href="https://habr.com/ru/post/262839/">https://habr.com/ru/post/262839/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../26283/index.html">Windows Podcasts</a></li>
<li><a href="../262831/index.html">Unreal real estate developers, or why years of experience do not say anything</a></li>
<li><a href="../262833/index.html">Star rating on CSS with font-awesome font icons</a></li>
<li><a href="../262835/index.html">vCloud Director for the smallest (part 4): everything about working with virtual machine templates</a></li>
<li><a href="../262837/index.html">Palantir, PayPal Mafia, special services, world government</a></li>
<li><a href="../262841/index.html">Why Go and Rust are not rivals, but damn enemies</a></li>
<li><a href="../262843/index.html">Why is becoming a VPN provider not so easy?</a></li>
<li><a href="../262845/index.html">Hey Simulator! Show your language</a></li>
<li><a href="../26285/index.html">Oddities with rss</a></li>
<li><a href="../262851/index.html">Simple phone interface from Nokia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>