<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use powershell scripts in icinga2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to raise micromonitoring . We will proceed from the fact that we have a park, mainly consisting of windows machines, and they are located ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use powershell scripts in icinga2</h1><div class="post__text post__text-html js-mediator-article">  We continue <a href="https://habrahabr.ru/post/307358/">to raise micromonitoring</a> .  We will proceed from the fact that we have a park, mainly consisting of windows machines, and they are located in local networks that are not connected with each other, but with access to the Internet.  Let us use native windows - powershell and teach our Icinga2 windows agents to send the information we need without direct access to them. <br><a name="habracut"></a><br>  In the latest versions of Icinga2 agent for windows, the location of configuration files has changed, now they are in the directory: C: \ ProgramData \ icinga2 \ etc \ icinga2.  On the client, add a global zone in the zones.conf file (in new versions of the agent, such a zone is already registered, but commented out): <br><br><pre><code class="bash hljs">object Zone <span class="hljs-string"><span class="hljs-string">"global-templates"</span></span> {        global = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre> <br>  On the server, create the /etc/icinga2/zones.d/global-templates directory, and in it the commands.conf file with the following contents where we define the command to execute the powershell scripts: <br><br><pre> <code class="bash hljs">object CheckCommand <span class="hljs-string"><span class="hljs-string">"powershell"</span></span> { import <span class="hljs-string"><span class="hljs-string">"plugin-check-command"</span></span> timeout = 5m <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> = [ <span class="hljs-string"><span class="hljs-string">"powershell.exe"</span></span> ] arguments = { <span class="hljs-string"><span class="hljs-string">"-command"</span></span> = { skip_key = <span class="hljs-literal"><span class="hljs-literal">true</span></span> value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ps_command</span></span></span><span class="hljs-string">$"</span></span> order = 0 } <span class="hljs-string"><span class="hljs-string">"-args"</span></span> = { skip_key = <span class="hljs-literal"><span class="hljs-literal">true</span></span> value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ps_args</span></span></span><span class="hljs-string">$"</span></span> order = 1 } } }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Additional optional commands</b> <div class="spoiler_text"><pre> <code class="bash hljs">// 64   powershell object CheckCommand <span class="hljs-string"><span class="hljs-string">"powershell64"</span></span> { import <span class="hljs-string"><span class="hljs-string">"plugin-check-command"</span></span> timeout = 3m <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> = [ <span class="hljs-string"><span class="hljs-string">"C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe"</span></span> ] arguments = { <span class="hljs-string"><span class="hljs-string">"-command"</span></span> = { value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ps_command</span></span></span><span class="hljs-string">$"</span></span> order = 0 } <span class="hljs-string"><span class="hljs-string">"-args"</span></span> = { skip_key = <span class="hljs-literal"><span class="hljs-literal">true</span></span> value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ps_args</span></span></span><span class="hljs-string">$"</span></span> order = 1 } } } // powershell   . object CheckCommand <span class="hljs-string"><span class="hljs-string">"powershell-bypass"</span></span> { import <span class="hljs-string"><span class="hljs-string">"plugin-check-command"</span></span> timeout = 3m <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> = [ <span class="hljs-string"><span class="hljs-string">"powershell.exe"</span></span> ] arguments = { <span class="hljs-string"><span class="hljs-string">"-ExecutionPolicy"</span></span> = { value = <span class="hljs-string"><span class="hljs-string">"ByPass"</span></span> order = 0 } <span class="hljs-string"><span class="hljs-string">"-File"</span></span> = { value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ps_command</span></span></span><span class="hljs-string">$"</span></span> order = 1 } <span class="hljs-string"><span class="hljs-string">"-args"</span></span> = { skip_key = <span class="hljs-literal"><span class="hljs-literal">true</span></span> value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ps_args</span></span></span><span class="hljs-string">$"</span></span> order = 2 } } }</code> </pre><br></div></div><br>  On the server in the same directory, create a services.conf file in which our agent services will be described.  To get started, let's add a script update service from the server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">apply Service <span class="hljs-string"><span class="hljs-string">"upd-powershell-scripts"</span></span> {   max_check_attempts = 2 //    60    check_interval = 60m   retry_interval = 30m //       Windows   assign <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> host.vars.os == <span class="hljs-string"><span class="hljs-string">"Windows"</span></span> &amp;&amp; host.name == NodeName //    Linux   ignore <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> host.vars.os == <span class="hljs-string"><span class="hljs-string">"Linux"</span></span>   check_command = <span class="hljs-string"><span class="hljs-string">"powershell"</span></span>   vars.ps_command = <span class="hljs-string"><span class="hljs-string">"C:\\Scripts\\Icinga2\\update_icinga2_scripts.ps1"</span></span> }</code> </pre><br>  When installing the Windows agent, in the etc / conf.d / hosts.conf file, the default variable vars.os = "Windows" is written based on this and this service will be used and ignored on Linux agents. <br><br>  Now on the client in the directory c: \ Scripts \ Icinga2 you need to place the powershell script that will perform the update scripts. <br><br><div class="spoiler">  <b class="spoiler_title">Script download powershell scripts from a remote server</b> <div class="spoiler_text"><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta"># icinga2scripts Version 0.2 Description: Update powershell from remote host. Pavel Satin (c) 2016 pslater.ru@gmail.com #&gt; $returnStateOK = 0 $returnStateWarning = 1 $returnStateCritical = 2 $returnStateUnknown = 3 $localDir = "c:\Scripts\icinga2\" $ScriptHost = "http://--" $ScriptHostPath = $ScriptHost + "/icinga2scripts/" Try { $HttpContent = Invoke-WebRequest -URI $ScriptHostPath -UseBasicParsing $ArrLinks = $HttpContent.Links | Foreach {$_.href } Foreach ($ArrStr in $ArrLinks) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( $ArrStr.endsWith(".ps1") ) { ## Apache2 $NewScriptHostPath = $ScriptHostPath + $ArrStr ## IIS,         #$NewScriptHostPath = $ScriptHost + $ArrStr $localFile = $localDir + $ArrStr Invoke-WebRequest -URI $NewScriptHostPath -UseBasicParsing -OutFile $localFile $script_count = $script_count + 1 } } $icinga2_status = "Update OK: Downloads " + $script_count + " scripts." Write-Host $icinga2_status [System.Environment]::Exit($returnStateOK) } Catch { $ErrorMessage = $_.Exception.Message $FailedItem = $_.Exception.ItemName Write-Host $ErrorMessage [System.Environment]::Exit($returnStateCritical) }</span></span></code> </pre><br></div></div><br>  After a short time, agents download a new version of the global zone. <br>  We start the update of the node configuration on the server and overload the service: <br><br><pre> <code class="bash hljs">icinga2 node update-config service icinga2 reload</code> </pre> <br>  Our service is added to the agent and it works. <br><br><img src="https://habrastorage.org/files/8ab/90b/57f/8ab90b57f0fe4cfd95194d25decd5f00.png"><br><br>  For example, add the reboot functionality.  Add one more service to the services.conf file, which will reboot the OS at our request.  Be sure to turn off the active check of such a service (we don‚Äôt want the server we are monitoring to reboot every n minutes). <br><br><pre> <code class="bash hljs">apply Service <span class="hljs-string"><span class="hljs-string">"reboot-system"</span></span> { //   enable_active_checks = <span class="hljs-literal"><span class="hljs-literal">false</span></span>   max_check_attempts = 2 //       Windows   assign <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> host.vars.os == <span class="hljs-string"><span class="hljs-string">"Windows"</span></span> &amp;&amp; host.name == NodeName //    Linux   ignore <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> host.vars.os == <span class="hljs-string"><span class="hljs-string">"Linux"</span></span>   check_command = <span class="hljs-string"><span class="hljs-string">"powershell"</span></span>   vars.ps_command = <span class="hljs-string"><span class="hljs-string">"C:\\Scripts\\Icinga2\\Reboot_System.ps1"</span></span> }</code> </pre><br>  Again, we start updating the node configuration on the server and overload the service so that the configuration changes take effect: <br><br><pre> <code class="bash hljs">icinga2 node update-config service icinga2 reload</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Reboot Script</b> <div class="spoiler_text"><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta"># icinga2scripts Version 0.2 Description: Reboot system. Pavel Satin (c) 2016 pslater.ru@gmail.com #&gt; $returnStateOK = 0 $returnStateWarning = 1 $returnStateCritical = 2 $returnStateUnknown = 3 #  </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( $args[0] -ne $Null) { $ComputerName = $args[0] } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { $ComputerName = "localhost" } $result = Test-Connection -ComputerName $ComputerName -Count 2 -Quiet </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($result) { Restart-Computer -computername $ComputerName -force Write-Host "OK - Command send." [System.Environment]::Exit($returnStateOK) } #End </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> test-connection result </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Write-Host " $ComputerName  ." [System.Environment]::Exit($returnStateUnknown) }</span></span></code> </pre><br></div></div><br>  We will place this script on our web server (which is registered in the download script) and the agent will download it himself after a certain period of time.  You can check the serviceability of the service with the following command on the server: <br><br><pre> <code class="bash hljs">/bin/<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"[`date +%s`] SCHEDULE_FORCED_SVC_CHECK;;reboot-system;`date +%s`"</span></span> &gt;&gt; /var/run/icinga2/cmd/icinga2.cmd</code> </pre><br>  After that, the windows agent machine should reboot. <br><br>  In order for powershell scripts to run on an agent, they must either be signed ( <a href="https://habrahabr.ru/post/137884/">How to sign</a> ) or set the execution policy correctly (Set-ExecutionPolicy).  In order for Icinga2 to correctly determine the state of the service after the check (normal / warning / critical), the script must return the correct return code. <br><br>  We defined the main return codes in scripts as follows: <br><br><pre> <code class="cs hljs">$returnStateOK = <span class="hljs-number"><span class="hljs-number">0</span></span> $returnStateWarning = <span class="hljs-number"><span class="hljs-number">1</span></span> $returnStateCritical = <span class="hljs-number"><span class="hljs-number">2</span></span> $returnStateUnknown = <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br>  For example, when the service is in critical condition, we return: <br><br><pre> <code class="cs hljs"> Write-Host <span class="hljs-string"><span class="hljs-string">" $ComputerName  ."</span></span> [System.Environment]::Exit($returnStateCritical)</code> </pre><br><br>  Additional performance data from the script can be returned like this: <br><br><pre> <code class="cs hljs">Write-Host <span class="hljs-string"><span class="hljs-string">"OK -  :"</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;_&lt;/th&gt;&lt;th&gt;Value&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;"</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;tr&gt;&lt;td&gt;  :&lt;/td&gt;&lt;td&gt;"</span></span> + $catridge_usage_prc + <span class="hljs-string"><span class="hljs-string">" %&lt;/td&gt;&lt;/tr&gt;"</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;tr&gt;&lt;td&gt; :&lt;/td&gt;&lt;td&gt;"</span></span> + $page_count + <span class="hljs-string"><span class="hljs-string">"&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;"</span></span> <span class="hljs-string"><span class="hljs-string">"|catridge_usage_prc=$catridge_usage_prc;10;3;100;0"</span></span> <span class="hljs-string"><span class="hljs-string">"|page_count=$page_count;;;;"</span></span> [System.Environment]::Exit($returnStateOK)</code> </pre><br>  Here, after the pipe, we send the performance data in the following format: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">'label'</span></span>=value[UOM];[warn];[crit];[min];[max]</code> </pre><br>  In icingaweb2, it will look something like this: <br><br><img src="https://habrastorage.org/files/612/1ee/9c1/6121ee9c1df240c086f5c7afab4c912a.png"><br><br>  If you have scripts with the output of messages in Cyrillic, the files must be saved in UTF-8 with BOM, otherwise there may be problems with the display of these messages in our web interface or in icingaweb2. <br><br>  There are already a huge number of plugins for icinga / nagios, but in most cases they are designed to work in linux systems.  For windows, of course, there are ready-made solutions that supplement the standard icinga2 commands, for example: <a href="https://www.nsclient.org/">nsclient ++</a> , but these are additional entities, additional configurations.  In our solution, everything is done using standard windows tools and at the same time there is an opportunity to receive additional information ‚Äúon the fly‚Äù simply by adding an additional service to the Icinga2 configuration and an additional powershell script to the web server. <br><br><h4>  Links </h4><br><blockquote>  <a href="https://habrahabr.ru/post/307358/">We raise micromonitoring on icinga2 with minimal costs</a> <br>  <a href="https://github.com/plsatin/icinga2scripts">Repository with scripts</a> <br>  <a href="https://www.monitoring-plugins.org/doc/guidelines.html">Monitoring plugins guidelines</a> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/307560/">https://habr.com/ru/post/307560/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307550/index.html">The collapse of the cloud technology exchange. What's next?</a></li>
<li><a href="../307552/index.html">Path indie developers on the market Steam Greenlight: Project ‚Ññ1</a></li>
<li><a href="../307554/index.html">Understanding Go: bytes and strings packages</a></li>
<li><a href="../307556/index.html">Planning usability testing. Part 1</a></li>
<li><a href="../307558/index.html">Blend @PreAuthorize in Spring Security with arbitrary types and simple inspected DSL</a></li>
<li><a href="../307562/index.html">Soprocess: -What, -how, -why?</a></li>
<li><a href="../307564/index.html">The Golden Key is an unavoidable possibility of a full bypass of Secure Boot on most Windows devices.</a></li>
<li><a href="../307568/index.html">Search for invalid passports or learn how to prepare binary files</a></li>
<li><a href="../307570/index.html">The final release of Vivaldi 1.3</a></li>
<li><a href="../307572/index.html">33 ways to deal with uncertainty and anxiety like Madonna</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>