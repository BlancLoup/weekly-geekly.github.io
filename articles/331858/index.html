<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to beat the Petya virus</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Following the sensational campaign of the cipher virus WannaCry, which was recorded in May of this year, on June 27, more than 80 companies in Russia ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to beat the Petya virus</h1><div class="post__text post__text-html js-mediator-article">  Following the sensational campaign of the cipher virus WannaCry, which was recorded in May of this year, on June 27, more than 80 companies in Russia and Ukraine fell victim to a new attack using the extortionist cipher Petya.  And this campaign was not related to WannaCry at all.  Experts at Positive Technologies presented a detailed analysis of the new malware and made recommendations to combat it. <br><br> <a href="https://habrahabr.ru/company/pt/blog/331858/"><img src="https://habrastorage.org/web/244/c22/ed2/244c22ed2faf4690b8b1a3d7f82c6c7a.jpg"><br></a> <a name="habracut"></a><br><br>  Ukrainian, Russian and international companies, in particular, Novaya Pochta, Zaporozhieoblenergo, Dneproenergo, Oschadbank, media holding TRK Lux, Mondelƒìz International, TESA, Nivea, Mars, operators LifeCell, UkrTeleCom, Kievstar and many other organizations have already become victims of the extortionist.  In Kiev, including some ATMs and checkout terminals in stores, were infected.  It was in Ukraine that the first attacks were recorded. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      An analysis of the ransomware sample conducted by our experts showed that Petya‚Äôs principle of operation is based on encrypting the master boot record (MBR) of the boot sector of a disk and replacing it with its own.  This record is the first sector on the hard disk, it contains the partition table and the loader program, which reads from this table information about which partition of the hard disk the system will boot from.  The original MBR is stored in the 0x22nd disk sector and is encrypted using a XOR byte operation with 0x07. <br><br>  After launching the malicious file, a task is created to restart the computer, delayed for 1-2 hours, at which time you can run <a href="https://twitter.com/msuiche/status/879722894997278720">the</a> <b>bootrec / fixMbr command</b> to restore the MBR and restore the OS to work.  Thus, it is possible to start the system even after its compromise, but it will not be possible to decrypt the files.  Each disk generates its own AES key, which exists in memory until encryption is completed.  It is encrypted using the RSA public key and deleted.  Restoring content after completion requires knowledge of the private key, thus, without knowing the key, data cannot be recovered.  Presumably, the malware encrypts files to a maximum of 15 directories.  That is, files nested to a greater depth are safe (at least for this modification of the cryptographer). <br><br>  If the disks were successfully encrypted after a reboot, a window is displayed on the screen with a message about the requirement to pay a ransom of $ 300 (as of June 27, 2017 - approximately 0.123 bitcoins) to obtain the file unlock key.  For the transfer of money specified bitcoin wallet <a href="https://blockchain.info/address/1Mz7153HMuxXTuR2R1t78mGSdzaAtNbBWX">1Mz7153HMuxXTuR2R1t78mGSdzaAtNbBWX</a> .  A few hours after the start of the attack, the wallet already receives transactions that are multiples of the requested amount - some victims chose to pay the ransom, not waiting for the researchers to study the malware and try to find a file recovery tool. <br><br><img src="https://habrastorage.org/web/c40/823/641/c408236417bf44e090514e21b5676506.png"><br><br>  At the moment, the number of transactions has increased to 45. <br><br><img src="https://habrastorage.org/web/ed3/7b5/9c7/ed37b59c74e9422f8c63ac6ced381a10.JPG"><br><br>  Petya uses 135, 139, 445 TCP ports for distribution (using SMB and WMI services).  Distribution within the network to other nodes occurs by several methods: using Windows Management Instrumentation (WMI) and <a href="https://technet.microsoft.com/ru-ru/library/bb545021.aspx">PsExec</a> , as well as using an exploit that exploits the <a href="https://technet.microsoft.com/en-us/library/security/ms17-010.aspx">MS17-010</a> vulnerability ( <a href="https://vulners.com/seebug/SSV-92952">EternalBlue</a> ).  WMI is a technology for centrally managing and monitoring the work of various parts of the computer infrastructure running on the Windows platform.  PsExec is widely used to administer Windows and allows you to run processes on remote systems.  However, to use these utilities, you must have local administrator privileges on the victim's computer, which means that the encryption officer can continue to distribute only from those devices whose user has the maximum privileges of the OS.  The EternalBlue exploit allows you to get maximum privileges on a vulnerable system.  The cryptographer also uses the publicly available <a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a> utility to open the credentials of all Windows users, including local administrators and domain users.  <b>Such a toolkit allows Petya to maintain performance even in those infrastructures where the WannaCry lesson was taken into account and the corresponding security updates were installed, which is why the encryption tool is so effective</b> . <br><br>  As part of testing for penetration of modern corporate infrastructures, Positive Technologies experts regularly demonstrate the possibility of using the EternalBlue exploit (in 44% of the work in 2017), as well as the successful use of the Mimikatz utility to develop the attack vector to gain full control over the domain (in each project). <br><br>  Thus, Petya has the functionality that allows it to spread to other computers, and this process is avalanche-like.  This allows the cryptographer to compromise including the domain controller and develop an attack before gaining control over all nodes of the domain, which is equivalent to the complete compromise of the infrastructure. <br><br>  We reported on the existing threat of compromise more than a month ago in alerts about the <a href="https://www.ptsecurity.com/upload/corporate/ru-ru/analytics/WannaCry-analytics-rus.pdf">WannaCry</a> attack and <a href="https://www.ptsecurity.com/ru-ru/about/news/250571/">gave recommendations</a> on how to identify vulnerable systems, how to protect them and what to do if an attack has already occurred.  Additional recommendations we will give in this article.  In addition, our company has developed a free utility <a href=""><b>WannaCry_Petya_FastDetect</b></a> for automated detection of infrastructure vulnerabilities.  MaxPatrol detects this vulnerability in both Audit mode and Pentest mode.  Detailed instructions are indicated in <a href="https://www.ptsecurity.com/ru-ru/about/news/250571/">our recommendations</a> .  In addition, the MaxPatrol SIEM set up the appropriate <a href="https://github.com/ptresearch/Bad_Tuesday_Cryptor_SIEM">correlation rules</a> to identify the Petya attack. <br><br>  Positive Technologies experts have revealed <b>‚Äúkill-switch‚Äù</b> - the ability to disable cipher crawler locally.  If the process has administrative privileges in the OS, then before replacing the MBR, the cryptographer checks for the presence of the <b>perfc</b> file (or another <b>empty file</b> with a different name) <b>without an extension</b> in the <b>C: \ Windows</b> \ directory (the directory is hard coded in the code).  This file has the same name as the dll library of this cryptographer (but without the extension). <br><br><img src="https://habrastorage.org/web/869/a84/8e3/869a848e32ff4d8d8ff8be60f997c8ac.png"><br><br><img src="https://habrastorage.org/web/ac3/41f/756/ac341f756bb9403d8fc11319425bcb2b.png"><br><br>  The presence of such a file in the specified directory may be one of the indicators of compromise.  If the file is present in this directory, then the execution of the malware is completed, thus creating a file with the correct name can prevent the MBR from being spoofed and further encryption. <br><br><img src="https://habrastorage.org/web/946/269/e94/946269e94f114b2a867ac1f2817d9bc0.png"><br><br>  If the cryptographer does not detect such a file during the scan, then the file is created and the process of running the malware runs.  Presumably, this happens so that the MBR substitution process does not start again. <br><br>  On the other hand, if the process does not initially have administrative privileges, the encryption officer will not be able to check for the presence of an empty file in the C: \ Windows \ directory, and the file encryption process will still start, but without replacing the MBR and restarting the computer. <br>  In order not to become a victim of such an attack, you must first update the software used to the latest versions, in particular, install all the latest updates for MS Windows.  In addition, it is necessary to minimize user privileges on workstations. <br><br>  If the infection has already occurred, we <b>do not recommend</b> paying money to attackers.  The <u>e-</u> mail address of the violators <u>wowsmith123456@posteo.net</u> was blocked, and even if the ransom payment was made, the key for decrypting files will most likely not be received.  To prevent the encoder from spreading on the network, it is recommended to turn off other computers that have not been infected, disconnect infected nodes from the network and remove images of compromised systems.  In case researchers find a way to decrypt files, locked data can be recovered in the future.  In addition, this image can be used to analyze the encoder, which will help researchers in their work. <br><br>  In the long term, it is recommended to develop a system of regular staff training to raise their awareness of information security issues, based on the demonstration of practical examples of potential attacks on the company's infrastructure using social engineering methods.  It is necessary to regularly check the effectiveness of such trainings.  It is also necessary to install anti-virus software on all computers with a self-defense function, providing for entering a special password to disable or change settings.  In addition, it is necessary to ensure regular updates of software and operating systems on all nodes of the corporate infrastructure, as well as an effective process of managing vulnerabilities and updates.  Regular audits of information security and penetration testing will allow timely identification of existing weaknesses in the protection and vulnerability of systems.  Regular monitoring of the perimeter of the corporate network will allow you to monitor the Internet interfaces of the network services available on the network and make adjustments to the firewall configuration on time.  For the timely detection and suppression of an already occurring attack, it is necessary to monitor the internal network infrastructure, for which it is recommended to use the SIEM class system. <br><br>  The following indicators can be used to detect Petya attacks in the infrastructure: <br><br><ul><li>  <b>C: \ Windows \ perfs</b> </li><li>  Task in Windows Scheduler with an empty name and action (reboot) </li><li>  <b>"% WINDIR% \ system32 \ shutdown.exe / r / f"</b> </li></ul><br>  IDS / IPS rules triggered: <br><br><ul><li>  msg: "[PT Open] Unimplemented Trans2 Sub-Command code. Possible ETERNALBLUE (WannaCry, Petya) tool";  sid: 10001254;  rev: 2; </li><li>  msg: "[PT Open] ETERNALBLUE (WannaCry, Petya) SMB MS Windows RCE";  sid: 10001255;  rev: 3; </li><li>  msg: "[PT Open] Trans2 Sub-Command 0x0E. Likely ETERNALBLUE (WannaCry, Petya) tool";  sid: 10001256;  rev: 2; </li><li>  msg: "[PT Open] Petya ransomware perfc.dat component";  sid: 10001443;  rev: 1 </li><li>  msg: "[PT Open] SMB2 Create PSEXESVC.EXE";  sid: 10001444;  rev: 1 </li></ul><br>  Signatures: <br><br><ul><li>  <a href="https://github.com/ptresearch/AttackDetection/blob/master/eternalblue(WannaCry%252CPetya)/eternalblue(WannaCry%252CPetya).rules">Link to github.com</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/331858/">https://habr.com/ru/post/331858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331842/index.html">Multicore DSP TMS320C6678. Operational kernels: processor computing resources</a></li>
<li><a href="../331846/index.html">Deskun update: from the ticket system inside Gmail to the multi-channel support system</a></li>
<li><a href="../331848/index.html">How NVIDIA and AMD earn on the rise in cryptocurrency popularity</a></li>
<li><a href="../331852/index.html">Browser online game development</a></li>
<li><a href="../331854/index.html">PETYA malware. Recovery is possible</a></li>
<li><a href="../331860/index.html">WannaCry and Petya - how does the center for monitoring and response to cyber attacks in case of global incidents work?</a></li>
<li><a href="../331862/index.html">Secure USB flash drive. Myth or Reality</a></li>
<li><a href="../331864/index.html">Sizes of raster images: pixels, DPI, PPI, centimeters - you do not confuse anything?</a></li>
<li><a href="../331866/index.html">Using Pinba in Badoo: what you don't know yet</a></li>
<li><a href="../331868/index.html">IBM Bluemix in universities: examples of implemented projects from students and teachers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>