<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Static storage, processing and release</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Beginners (and not so) developers often have questions about how to work correctly with user-generated content, and specifically with pictures. This t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Static storage, processing and release</h1><div class="post__text post__text-html js-mediator-article"> Beginners (and not so) developers often have questions about how to work correctly with user-generated content, and specifically with pictures.  This topic has many aspects and more than one solution.  Here, only one of the possible options will have its own advantages and disadvantages.  We also assume that the static and code are stored on a single server, and the files are loaded one by one. <br><br>  Tasks solved by the system: <br>  - convenient file downloads; <br>  - the possibility of asynchronous processing of images; <br>  - easy work with previews; <br>  - separation of configuration from execution. <br><br>  <b>Go</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  First, create a File table in the database with the following fields: id, name, size, width, height, is_deleted, is_ready, updated, created. <br><br>  When loading a file, first of all, an entry will be created in the File table.  Further, based on id, the path will be calculated by which it should be saved. <br><br> <code>$number = sprintf('%08d', $id); <br> $uri = '/' . <br> substr($number, 0, 2) . '/' . <br> substr($number, 2, 2) . '/' . <br> substr($number, 4, 2) . '/' . <br> $number; <br></code> <br><br>  At the output we get something like this: / 00/47/31/00473161 <br><br>  <b>upd1</b> <a href="https://habrahabr.ru/users/arkadiy_kulev/" class="user_link">Arkadiy_Kulev</a> pointed out that it is better to limit the depth of directories to two levels. <br><br>  <b>upd2</b> Indeed, it is more correct to make a path in the reverse order for a better distribution of pictures into folders.  Ie, we get the URL / 161/473/00473161.  Thank you <a href="https://habrahabr.ru/users/atd/" class="user_link">atd</a> <br><br>  What is it done for? <br><ul><li>  file_id will be a field in the tables of entities that need images ($ user-&gt; avatar_file_id).  This approach allows you to determine the full path to the image on the basis of a single file_id without additional requests to the database. </li><li>  We get a unified way to work with all pictures, both user and downloadable operators through the admin area. </li><li>  A folder structure is created on the disk in such a way that there will be no more than 100 subfolders or files in one folder.  Although this number can be increased to 1000 folders, but with a larger number of difficulties may arise in working with FS. </li><li>  The file table helps with asynchronous work with files.  If we suddenly need to convert all the images into another format or perform any other manipulations, then we can use the is_ready field (or add our own field) to determine the images that we have already processed and which remains to be processed. </li><li>  Thanks to the is_deleted field, deleting images can be done asynchronously.  The code will just have to set true (it is more convenient to implement on triggers), and there will be a special collector to delete (of course you need to write it).  This can be implemented on triggers. </li></ul><br><br>  As can be seen from the example ‚Äú00/47/31/00473161‚Äù, the number of possible downloads of pictures, with this approach, is limited to a billion.  Naturally it is easy to change at the implementation stage. <br><br>  To implement the functionality described above, you need to create the Image_Manager class with the receive method.  This class will be engaged in creating a record in the database and moving the file to the appropriate directory in the file system, as well as creating the missing directories. <br><br> <code>... <br> if ($form-&gt;isValid()) { <br> //      , Image_Manager     <br> // $_FILE        . <br> ... <br> $im = new Image_Manager($options); //      <br> // 'avatar'    ,     <br> $file_id = $im-&gt;receive('avatar'); //    <br> $user-&gt;avatar_file_id = $file_id; <br> $user-&gt;save() <br> }</code> <br> <br>  We saved the original image and gave it to the user id.  But it still needs to be processed, and it is possible to create several preview sizes for display on the site.  Then you can go in several ways, create images at once or use lazy load.  The second method also has several options for development and is beyond the scope of this article (At the end of the article a list of links is given, where an example of a possible implementation of this method is given).  We will go the first way.  And it is for this purpose that the $ options array is passed to the image_manager constructor, and the ‚Äúavatar‚Äù string is passed to the recive method. <br><br>  In order to create thumbnails, you need a configuration file describing the types of images uploaded to the site and their parameters.  For example (using the format Zend_Config_Ini): <br><br> <code>... <br> [avatar] ;   big, medium  small   <br> resize.big.OutputFileFormat = jpg <br> resize.big.keepFrame = true <br> resize.big.backgroundColor = 240.240.240 <br> resize.big.width = 236 <br> resize.big.height = 177 <br> resize.medium.keepFrame = true <br> resize.medium.backgroundColor = 240.240.240 <br> resize.medium.width = 144 <br> resize.medium.height = 108 <br> resize.small.keepFrame = true <br> resize.small.width = 72 <br> resize.small.height = 54 <br> resize.small.roundCorners = false <br> <br> [user_album_photo] <br> ... <br></code> <br><br>  It is this configuration file that is passed to the Image_Manager constructor.  By calling the recive method, we specify a section of the configuration file and in fact we determine how this picture will be processed and how many previews will be created.  To process images, it is desirable to have a separate library with which the Image_Manager interacts within itself. <br><br>  To save the preview, use the same storage format of the source file ‚Äú00/47/31/00473161‚Äù, but at the end a special hash is added, calculated based on the parameters of this preview, as a result the path will be something like this ‚Äù/ 00/47/31 / 00473161X2280688952 .jpg "(again, this is just an example, you can do it differently).  This hash helps determine the existence of a preview for images whose parameters have changed and, if there is no, generate an image upon request. <br><br>  It remains to deal with the conclusion.  The simplest option would be to write a special image helper, which will work like a url helper: <br><br> <code>//  url  <br> $this-&gt;image($user-&gt;avatar_file_id, 'small', 'avatar') <br></code> <br><br>  The helper image refers to an object (possibly Image_Manager), which knows how to build a path to the current image, taking into account its parameters, section, and the name of the preview.  If the pictures are on a separate host, then it substitutes it.  In the absence of the necessary preview, the helper can generate it (controversially, with a large number of missing images, memory or timeout may end) or give way to a special stub for this type of file. <br><br>  As a result, we got a convenient configuration file, file download in one line and a unified way to work with all site images, including user ones. <br><br>  Related Links: <br>  <a href="http://habrahabr.ru/blogs/nginx/77873/">http://habrahabr.ru/blogs/nginx/77873/</a> - very valuable comments here <br>  <a href="http://habrahabr.ru/blogs/nginx/94435/">http://habrahabr.ru/blogs/nginx/94435/</a> <br>  <a href="http://ru.wikipedia.org/wiki/WebDAV">http://ru.wikipedia.org/wiki/WebDAV</a> - when moving static to a separate server (s) </div><p>Source: <a href="https://habr.com/ru/post/101654/">https://habr.com/ru/post/101654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../101646/index.html">tweet-button</a></li>
<li><a href="../101647/index.html">The killer of your time</a></li>
<li><a href="../101650/index.html">Peter Zaitsev will answer all your questions.</a></li>
<li><a href="../101652/index.html">Saudi Arabia has become the second country to ban Blackberry</a></li>
<li><a href="../101653/index.html">We sharpen the old code under the new realities</a></li>
<li><a href="../101658/index.html">FBI demands to remove its emblem from the site of the free encyclopedia</a></li>
<li><a href="../101659/index.html">Improving forms with jqTransform</a></li>
<li><a href="../101661/index.html">Does porn have a future?</a></li>
<li><a href="../101663/index.html">Low-cost Internet and mobile communications in Europe - sharing experience</a></li>
<li><a href="../101664/index.html">Canobuvosti, 52nd edition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>