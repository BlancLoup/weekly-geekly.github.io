<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configure IPSec VPN server through strongSwan and On-Demand on iOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with the fact that it became necessary to protect user data transmitted to the server. And it was necessary to do it in such a way so a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configure IPSec VPN server through strongSwan and On-Demand on iOS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/40d/49b/d98/40d49bd98322460bbf19ba4684eaeb72.png" alt="How did I get this message"><br><br>  It all started with the fact that it became necessary to protect user data transmitted to the server.  And it was necessary to do it in such a way so as not to frustrate users of corporate iPads.  I couldn‚Äôt think anything smarter how to use IPSe <s>x</s> c and VPN On-Demand on iOS.  And I decided to raise it through strongSwan. <br><br>  How did I suffer with this ... How did I hate this message in the picture above ... The Internet is full of articles and ready-made examples, but they all use login and password authentication. <br>  And now I want to save time for those who dare to go through this thorny path. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h4>  The beginning of the way </h4><br>  Determine what should get the output: <br><ul><li>  configured VPN server </li><li>  client certificates that we install on iOS </li></ul><br>  How it should work: <br>  VPN should be enabled on the iPad itself as soon as we turn to a specific host, for example, ‚Äúya.ru‚Äù.  At the same time without requesting a password from the user. <br>  What we will use: <br><ul><li>  Ubuntu </li><li>  strongSwan 5.0.3 </li></ul><br>  What do we do: <br><ul><li>  Sniper keys </li><li>  Let's extort from a git-repository and collect by hands strongSwan </li><li>  Configure Configs </li></ul><br><h4>  First blood </h4><br>  As it turned out, RSA authorization in strongSwan is done via xauth.  And this same xauth, in addition to the certificate, also requires a login with a password.  This is their implementation.  StrongSwan has quite a decent <a href="http://wiki.strongswan.org/projects/strongswan/wiki/IOS_(Apple)">description of</a> how to raise IPSec VPN to work with iOS.  But the problem here is just a password request.  Therefore, this option does not suit us. <br><br>  But it is not all that bad!  Tobias Brunner and his <a href="http://git.strongswan.org/%3Fp%3Dstrongswan.git%3Ba%3Dcommit%3Bh%3Dfb780b2147fecd4e02a6cac99b1071c6060cb3f7">commit</a> will save us!  Without this commit, we would have failed.  Thank him so much.  This code is a plugin for xauth, which does not require additional authentication of the user login and password.  Those.  RSA key authentication only occurs.  What we needed was! <br><br><h4>  Certificates </h4><br>  I will not talk about how to generate keys.  This is described in great detail in the <a href="http://wiki.strongswan.org/projects/strongswan/wiki/IOS_(Apple)">tutorial of strongSwan</a> .  I just want to draw attention to several important points of the tutorial: <br><ol><li>  The value of the common name (CN) field of the certificate must exactly match with the ip or domain name of the VPN server.  In the case of Amazon EC2, it would be something like "ecX-XX-XXX-XX-XX.eu-west-1.compute.amazonaws.com". </li><li>  When installing certificates on the iPad, you need not to forget, in addition to client PKCS # 12 (* .p12), to install the root one as well.  In the tutorial, it is called caCert.pem. </li></ol><br><br><h4>  Let's get started </h4><br>  Before installing it is recommended to read and understand the <a href="https://github.com/strongswan/strongswan/blob/master/HACKING">recommendations</a> on "hacking".  Or rather, to build a package from the repository. <br><br>  After installing all the necessary libraries and tools, proceed to the assembly: <br><ol><li>  Pump up the branch with the magic plugin: git clone git: //git.strongswan.org/strongswan.git xauth-noauth strongswan-git-xauth-noauth / </li><li>  Create configuration scripts: ./autogen.sh </li><li>  Configuring: ./configure --prefix = / usr --sysconfdir = / etc --enable-xauth-noauth </li><li>  Build the package: sudo checkinstall -D --install = no </li><li>  And finally, install it: dpkg -i strongswan-git-xauth_5.0.3-xauth-noauth-1_amd64.deb </li></ol><br>  Do not forget to open ports on the firewall 500 and 4500, because  IPSec works through them. <br>  Let's allow packet forwarding through NAT: <br><pre> iptables --table nat --append POSTROUTING --jump MASQUERADE
 echo 1&gt; / proc / sys / net / ipv4 / ip_forward
 for each in / proc / sys / net / ipv4 / conf / *
 do
     echo 0&gt; $ each / accept_redirects
     echo 0&gt; $ each / send_redirects
 done
</pre><br>  Finally we can proceed to the configuration. <br><br><h5>  /etc/ipsec.conf </h5><br><pre> version 2.0 # conforms to second version of ipsec.conf specification

 config setup
        
 conn ios
       keyexchange = ikev1
       xauth = server
       leftauth = rsa
       rightauth = rsa
       rightauth2 = xauth-noauth
       left =% defaultroute
       leftsubnet = 0.0.0.0 / 0
       leftfirewall = yes
       leftcert = serverCert.pem
       right =% any
       rightsubnet = 10.0.0.0 / 24
       rightsourceip = 10.0.0.0 / 24
       rightcert = clientCert.pem
       auto = add
</pre><br><br><h5>  /etc/ipsec.secrets </h5><br><pre> : RSA serverKey.pem
</pre><br><br><h5>  /etc/strongswan.conf </h5><br><pre> charon {

         # number of worker threads in charon
         threads = 16
         dns1 = 8.8.8.8

         plugins {
         }
 }

 libstrongswan {
 }
</pre><br>  The init.d script is too long.  It can be picked up <a href="https://gist.github.com/anonymous/4953417">here</a> . <br><br><h4>  Installing certificates on iOS </h4><br>  There are several ways to install certificates (clientCert.p12 and caCert.pem): <br><ul><li>  Using the <a href="http://www.apple.com/support/iphone/enterprise/">iPhone Configuration Utility</a> </li><li>  By sending certificates to yourself by mail.  And then get out on the iPad. </li><li>  Downloading them with Safari right on the device itself. </li></ul><br>  Personally, I advise you to use the iPhone Configuration Utility, because  only there you can specify the domains for which the On-Demand VPN should be. <br><br>  Questions, comments, criticism is welcome. <br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/169463/">https://habr.com/ru/post/169463/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../169451/index.html">Optimization of 2D applications for mobile devices in Unity3d</a></li>
<li><a href="../169453/index.html">Well, that's about Google shot the movie, this time comedy</a></li>
<li><a href="../169455/index.html">Malbolge: Programming from Hell</a></li>
<li><a href="../169457/index.html">Kickstarter in your pocket. With love!</a></li>
<li><a href="../169461/index.html">Manga "Entertaining statistics", "The Mystery of Disasters" and other similar books</a></li>
<li><a href="../169467/index.html">Android Application Development with C #</a></li>
<li><a href="../169469/index.html">Perl recurrence calculation</a></li>
<li><a href="../169471/index.html">Portable prism</a></li>
<li><a href="../169481/index.html">In iOS 6.1, password bypass is possible</a></li>
<li><a href="../169483/index.html">Digital equipment sales statistics in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>