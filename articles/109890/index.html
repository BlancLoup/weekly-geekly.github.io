<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHPLego: Do-it-yourself plugins</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good morning, dear Hobrochityateli! 

 Have you ever wanted to make the modules to the site unobtrusive, so that it was enough to put the module in a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHPLego: Do-it-yourself plugins</h1><div class="post__text post__text-html js-mediator-article"><img src="http://./_storage/2010_12_13__01_03_46__0.21484600.png"><br><br>  Good morning, dear Hobrochityateli! <br><br>  Have you ever wanted to make the modules to the site unobtrusive, so that it was enough to put the module in a folder and not do any more work on their connection.  That once written block of the site could be used on new projects again, regardless of their structure. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I want to share a modest microbike that helps me in the difficult task of site building. <br><br>  <a href="http://habrahabr.ru/company/microset/blog/109481/">Our first acquaintance</a> with you turned out to be very interesting, and I sincerely appreciate you for your constructive criticism.  Hope to continue in the same vein. <br><br>  So, for myself, I formulated the task according to the following criteria: <br><br>  1) Each module must contain everything necessary for work in one folder - both templates, and model, and controller.  So that it could be easily copied, corrected - and voila - a new module. <br>  2) The module should not know anything about those who create it - it receives all the data it needs for work through the designer.  This is so that the module works not only on my site, but also on all the sites of my friends and clients without any file filing. <br>  3) In order to use the module it should not be necessary to register or include additional files anywhere.  It is stupid annoying. <br>  4) A module can consist of modules.  Those.  There must be support for nested modules. <br>  5) Links (a href = ...) inside the module templates should be relative, regardless of how deep the nesting module is.  In order to avoid modifying templates, we move a module from one parent module to another. <br>  6) The site itself should also be a module, for that matter.  In order to be able to buy from a friend already a working site, put yourself in a folder and embed all of it on any page without unnecessary rework. <br><br>  Well, for one article, I think enough, let's proceed to implementation. <br><a name="habracut"></a><br><br><h3>  Project File Structure </h3><br>  To begin with, we outline the structure of the project files: <br><pre><code class="hljs ruby">/nome/user/www/ <span class="hljs-params"><span class="hljs-params">|---[.myengine] //    |</span></span> <span class="hljs-params"><span class="hljs-params">|---[classes] //   |</span></span> <span class="hljs-params"><span class="hljs-params">|---autoload.php //    ,     |</span></span> <span class="hljs-string"><span class="hljs-string">`---README.TXT //      |---[classes] //   | |---[articles] //   | | |---[m] //   | | | `</span></span>---article.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.php /<span class="hljs-regexp"><span class="hljs-regexp">/   ( : articles_m_article) | | |---[view] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   CSS   | | | |---[css] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    | | | | `---style.css /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    | | | |---article_list.tpl /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    | | | `---one_article.tpl /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     | | `---controller.class.php /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ( : articles_controller) | |---[comments] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   | |---[fotos] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   | |---[site] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ( ) | `---[users] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   |---.setup.php /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   (  ,    ..) `---index.php /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    </span></span></code> </pre> <br><br><h3>  Automatic loading of modules </h3><br>  For the purity of the system, we arrange it so that in any place of the site where we want to use the modules, it was necessary to include just one file, some kind of autoload.php.  And we will make the path to the module folder to be customizable (some kind of global variable) or, even better, let it be several paths.  Well, it may be necessary, for example, in order to make two folders of modules - one private, only for oneself, and the other shared - for collective development. <br><br>  In our case, there is a folder /.myengine/classes - these are modules of our engine, some modules that we use in all our projects.  A / classes is the module folder of the project itself. <br><br>  So, the <b>autoload.php</b> file <b>itself</b> : <br><pre> <code class="hljs perl">&lt;?php //    PHP,    ,    new SomeClass() function __autoload($class_name){ $class_folder = <span class="hljs-string"><span class="hljs-string">'classes'</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      //   //       $class_folder.      $class_paths[] = dirname($_SERVER[<span class="hljs-string"><span class="hljs-string">'SCRIPT_FILENAME'</span></span>]).<span class="hljs-string"><span class="hljs-string">"/$class_folder/"</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   $class_paths[] = __DIR_<span class="hljs-number"><span class="hljs-number">_</span></span>.<span class="hljs-string"><span class="hljs-string">"/classes/"</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     $CLASS_PATHS <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!empty($GLOBALS[<span class="hljs-string"><span class="hljs-string">"CLASS_PATHS"</span></span>])){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!is_array($GLOBALS[<span class="hljs-string"><span class="hljs-string">"CLASS_PATHS"</span></span>])) throw new Exception(<span class="hljs-string"><span class="hljs-string">'$CLASS_PATHS must be array!'</span></span>); $class_paths = array_merge($class_paths, $GLOBALS[<span class="hljs-string"><span class="hljs-string">"CLASS_PATHS"</span></span>]); } //   (      A_B_C) $slashed_class_name = str_replace(<span class="hljs-string"><span class="hljs-string">"_"</span></span>, <span class="hljs-string"><span class="hljs-string">"/"</span></span>, $class_name); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> A/B/C $short_path = <span class="hljs-keyword"><span class="hljs-keyword">substr</span></span>($slashed_class_name, <span class="hljs-number"><span class="hljs-number">0</span></span>, strrpos($slashed_class_name, <span class="hljs-string"><span class="hljs-string">'/'</span></span>)); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> A/B <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($class_paths as $class_path){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   A_B_C    /A/B/C.class.php $file_full_name = <span class="hljs-string"><span class="hljs-string">"{$class_path}/{$slashed_class_name}.class.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(file_exists($file_full_name)){ require_once($file_full_name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } //   A_B_C    /A/B/C/A_B_C.class.php //     -      (     ) $file_full_name = <span class="hljs-string"><span class="hljs-string">"{$class_path}/{$slashed_class_name}/{$class_name}.class.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(file_exists($file_full_name)){ require_once($file_full_name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } } ?&gt;</code> </pre><br><br>  Small explanations to the startup file.  Here we made it possible to add paths to modules in the global $ CLASS_PATHS array.  Autoload will sort out the model paths in this order: <br>  1) first look in the classes folder next to the file being called <br>  2) if not found, look in the engine modules <br>  2) if you did not find it there, it will go through all the folders added to $ CLASS_PATHS. <br><br>  I would not recommend adding too many paths to $ CLASS_PATHS - after all, every access to the file system for the existence of a file is time.  Although small, but still. <br><br>  Also, for the convenience and portability of all project files, I propose to create a file, a certain .setup.php.  Create it in the project root, as well as in all subfolders where PHP files are stored that use modules.  The root .setup.php will include the modules autoload file: <br><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">include</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">__DIR__</span></span></span><span class="php">.</span><span class="hljs-string"><span class="php"><span class="hljs-string">'.myengine/autoload.php'</span></span></span><span class="php">; </span><span class="hljs-comment"><span class="php"><span class="hljs-comment">//    //     ,      </span></span><span class="hljs-meta"><span class="php"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></span></span></code> </pre><br><br>  And all the <b>.setup.php</b> files in the project subfolders will include the top-level <b>.setup.php</b> : <br><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-comment"><span class="php"><span class="hljs-comment">//  .setup.php  : include __DIR__.'/../.setup.php'; </span></span><span class="hljs-meta"><span class="php"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></span></span></code> </pre><br><br>  This is convenient because all files that create modules always contain the same line: <br><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">include</span></span></span><span class="php"> </span><span class="hljs-string"><span class="php"><span class="hljs-string">'.setup.php'</span></span></span><span class="php">; </span><span class="hljs-comment"><span class="php"><span class="hljs-comment">// --         //   ,   $m = new SomeModule(); $m-&gt;run(); echo $m-&gt;getOutput(); </span></span><span class="hljs-meta"><span class="php"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></span></span></code> </pre><br><br>  And then, moving files from folder to folder (which is the inevitability of any creative project), I need to edit the paths of inclusion.  Everything works right away. <br><br>  In general, including files is like gluing a project with electrical tape, if there are a lot of them and they are complex - the program turns into a plate with pasta, in which one file pulls the other along, and the third one is uncomfortable.  Therefore, we got rid of ikluds - classes of modules do not deceive anything at all - they themselves include autoloading.  And PHP files executables always contain only one include - include ".setup.php". <br><br><blockquote>  <i>Note:</i> some project files start with '.'  (points) so that when sorting by name they are on top </blockquote><br><br><h3>  Class controller module </h3><br>  Module classes are essentially the Lego controllers described in <a href="http://habrahabr.ru/company/microset/blog/109481/">my previous article</a> .  In which we add a couple of functions that allow us to determine the folder in which this controller lies, and take templates, Java scripts and Css relative to this path. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lego</span></span></span></span>{ .................. <span class="hljs-comment"><span class="hljs-comment">//     http://habrahabr.ru/company/microset/blog/109481/ abstract public function getDir(); //  ,       //     (.. ,     ) public function getWebDir(){ $viewdir = str_replace('\\', '/', $this-&gt;getViewDir()); //  ,     //, !      DOCUMENT_ROOT: return str_ireplace($_SERVER['DOCUMENT_ROOT'], '', $viewdir).'/'.$dirname; } //    -,    public function getJavascripts(){ $js = array(); $h = @opendir($this-&gt;getDir()."/js"); while($file = @readdir($h)) if(preg_match("/(\.js|\.js\.php)$/i", $file)) $js[] = $this-&gt;getWebDir()."/js/".$file; return $js; } //    ,    public function getStylesheets(){ $css = array(); $h = @opendir($this-&gt;getDir()."/view/css"); while($file = @readdir($h)) if(preg_match("/(\.css|\.css\.php)$/i", $file)) $css[] = $this-&gt;getWebDir()."/view/css/".$file; return $css; } //  ,    ,        public function getHeaderBlock(){ $csses = $this-&gt;getStylesheets(); $jses = $this-&gt;getJavascripts(); $ret = ""; foreach($csses as $one) $ret .= "\n&lt;link rel='stylesheet' href='{$one}' type='text/css' media='screen' /&gt;\n"; foreach($jses as $one) $ret .= "\n&lt;script type='text/javascript' src='{$one}'&gt;&lt;/script&gt;\n"; return $ret; } //    (   ,  ) public function fetch($template){ return Smarty::fetch($this-&gt;getDefaultDir().'/view/'.$template); } }</span></span></code> </pre><br><br>  Thus, we untied the location of style files, Java scripts and templates from the project as a whole.  The module can be moved from folder to folder, renamed and the system will continue to work.  Now we have the most interesting thing: how to specify links inside the templates?  After all, they, too, must be untied from the project as a whole and from the location of the modules. <br><br><h3>  Relative references in templates </h3><br>  If we recall the previous article, each Lego object rents its array variable in the address bar whose name matches the module name.  In order to refer to some method of the module controller, it is enough to take the current address bar, and replace it with data related only to the current module.  For lazy work with GET-parameters of the address bar, let's create the UriConstrucor class: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//       class UriConstructor{ public $arr; public function __construct($arr = false){ $this-&gt;arr = $arr ? $arr : $_GET; } //      (     ) public function put($key, $val){ $this-&gt;arr = array_replace_recursive($this-&gt;arr, array($key =&gt; $val)); return $this; } //      public function remove($key){ unset($this-&gt;arr[$key]); return $this; } //         public function clear(){ $this-&gt;arr = array(); return $this; } //         public function set($lego_name, $action /*....*/){ if(isset($this-&gt;arr[$lego_name]) &amp;&amp; !is_array($this-&gt;arr[$lego_name])) unset($this-&gt;arr[$lego_name]); $this-&gt;arr[$lego_name]['act'] = $action; $params = func_get_args(); array_shift($params); array_shift($params); foreach($params as $key=&gt;$one){ $this-&gt;arr[$lego_name][$action][$key] = $one; } return $this; } //    ,        public function setAct($action /*....*/){ $lego = Lego::current(); $params = array($lego-&gt;getName()); $params = array_merge($params, func_get_args()); return call_user_func_array( array($this, "set"), $params ); } //    get-,   (    ) public function url($path = false){ if(!$path) $path = $_SERVER['SCRIPT_NAME']; return $path.'?'.$this; } //      -    GET- public function __toString(){ return http_build_query($this-&gt;arr); } //      GET-   public function asArray(){ return $this-&gt;arr; } }</span></span></code> </pre><br><br>  And in the base class Lego add a couple more methods: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lego</span></span></span></span>{ .................. <span class="hljs-comment"><span class="hljs-comment">//    public function uri(){ return new UriConstructor(); } //  ,   ,         href //    action- ,    ,    public function actUri($action /* params */){ $params = func_get_args(); array_unshift($params, $this-&gt;getName()); return call_user_func_array( array($this-&gt;uri(), "set"), $params ); } }</span></span></code> </pre><br><br>  And in the templates we write the links like this: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{$lego-&gt;actUri('allfotos')-&gt;url()}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span>  ,  ,  : <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{$lego-&gt;actUri('showonefoto', $id)-&gt;url()}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> //       : <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/index.php?.....__...&amp;fotos[act]=showonefoto&amp;fotos[0]=123"</span></span></span><span class="hljs-tag">&gt;</span></span>....<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Previously, of course, you need to pass the lego object itself to the template engine so that the $ lego variable is available.  This can be done in the run () method of the Lego base class: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lego</span></span></span></span>{ .................. <span class="hljs-comment"><span class="hljs-comment">//    public function run(){ Smarty::assign("lego", $this); //   $lego -     ..... //    } }</span></span></code> </pre><br><br>  Here, now we also untied the templates.  The modules no longer know what project they are creating, and what module they have become easily relocatable in the project and between projects. <br><br>  Of course, the module must be somehow connected with the project, otherwise it would be absolutely meaningless.  Therefore, the necessary data he should receive through the designer. <br><br>  We give the code for a typical module: <br><br><pre> <code class="hljs bash">/*  ,   ,    <span class="hljs-variable"><span class="hljs-variable">$entity_id</span></span>  <span class="hljs-variable"><span class="hljs-variable">$entity_name</span></span> */ class fotos_controller extends Lego{ private <span class="hljs-variable"><span class="hljs-variable">$entity_id</span></span>; private <span class="hljs-variable"><span class="hljs-variable">$entity_name</span></span>; private <span class="hljs-variable"><span class="hljs-variable">$num_for_page</span></span> = 5; //     ( ),     <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> __construct(<span class="hljs-variable"><span class="hljs-variable">$name</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-variable"><span class="hljs-variable">$entity_id</span></span> = 0, <span class="hljs-variable"><span class="hljs-variable">$entity_name</span></span> = <span class="hljs-string"><span class="hljs-string">"User"</span></span>){ parent::__construct(<span class="hljs-variable"><span class="hljs-variable">$name</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;entity_id = <span class="hljs-variable"><span class="hljs-variable">$entity_id</span></span>; <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;entity_name = <span class="hljs-variable"><span class="hljs-variable">$entity_name</span></span>; } //   ,       Lego. public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDir</span></span></span></span>(){ <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> __DIR__; } //   -    //   ,    <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">action_index</span></span></span></span>(){ Database::query(<span class="hljs-string"><span class="hljs-string">"select * from `fotos` where `entity_name`='{</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;entity_name}' and `entity_id`={</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;entity_id} and deleted = 0 order by created desc"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$fotos</span></span> = Database::fetchObjects(); Output::assign(<span class="hljs-string"><span class="hljs-string">"fotos"</span></span>, <span class="hljs-variable"><span class="hljs-variable">$fotos</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;fetch(<span class="hljs-string"><span class="hljs-string">"allfotos.tpl"</span></span>); } //        <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">action_mainbar</span></span></span></span>(){ <span class="hljs-variable"><span class="hljs-variable">$offset</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_get(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getName().<span class="hljs-string"><span class="hljs-string">"_offset"</span></span>, 0); Database::query(<span class="hljs-string"><span class="hljs-string">"select * from `fotos` where `entity_name`='{</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;entity_name}' and `entity_id`={</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;entity_id} and deleted = 0 order by created desc limit {</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$offset</span></span></span><span class="hljs-string">}, "</span></span>.(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;num_for_page+1)); <span class="hljs-variable"><span class="hljs-variable">$fotos</span></span> = Database::fetchObjects(); Output::assign(<span class="hljs-string"><span class="hljs-string">"fotos"</span></span>, <span class="hljs-variable"><span class="hljs-variable">$fotos</span></span>); Output::assign(<span class="hljs-string"><span class="hljs-string">"offset"</span></span>, <span class="hljs-variable"><span class="hljs-variable">$offset</span></span>); Output::assign(<span class="hljs-string"><span class="hljs-string">"num_for_page"</span></span>, <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;num_for_page); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;fetch(<span class="hljs-string"><span class="hljs-string">"lego_fotos.tpl"</span></span>); } //             <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">action_sidebar</span></span></span></span>(){ <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;action_mainbar(); } //     (   POST) <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">action_submit</span></span></span></span>(){ <span class="hljs-variable"><span class="hljs-variable">$f</span></span> = new tbl_fotos(); <span class="hljs-variable"><span class="hljs-variable">$f</span></span>[<span class="hljs-string"><span class="hljs-string">'entity_name'</span></span>] = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;entity_name; <span class="hljs-variable"><span class="hljs-variable">$f</span></span>[<span class="hljs-string"><span class="hljs-string">'entity_id'</span></span>] = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;entity_id; <span class="hljs-variable"><span class="hljs-variable">$f</span></span>[<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>] = User::getCurrentUser()-&gt;getId(); <span class="hljs-variable"><span class="hljs-variable">$f</span></span>[<span class="hljs-string"><span class="hljs-string">'text'</span></span>] = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_post(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getName().<span class="hljs-string"><span class="hljs-string">"_text"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$f</span></span>[<span class="hljs-string"><span class="hljs-string">'file_id'</span></span>] = FotoStorage::putFromPost(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getName().<span class="hljs-string"><span class="hljs-string">"_file"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$f</span></span>[<span class="hljs-string"><span class="hljs-string">'file_id'</span></span>]) <span class="hljs-variable"><span class="hljs-variable">$f</span></span>-&gt;insert(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_goto(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;actUri(<span class="hljs-string"><span class="hljs-string">"mainbar"</span></span>)-&gt;url()); //_goto -   header(<span class="hljs-string"><span class="hljs-string">"Location: ... } //       function action_showone(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">){ </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string"> = new tbl_fotos(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">); Output::assign("</span></span>foto<span class="hljs-string"><span class="hljs-string">", </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ret</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;fetch("</span></span>showone.tpl<span class="hljs-string"><span class="hljs-string">"); // .    </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$c</span></span></span><span class="hljs-string"> = new comments_controller("</span></span>foto_comments<span class="hljs-string"><span class="hljs-string">", "</span></span>tbl_fotos<span class="hljs-string"><span class="hljs-string">", </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">-&gt;getId()); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$c</span></span></span><span class="hljs-string">-&gt;run(); return </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ret</span></span></span><span class="hljs-string">.</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$c</span></span></span><span class="hljs-string">-&gt;getOutput(); //    } //  "</span></span>  <span class="hljs-string"><span class="hljs-string">" function action_set_as_main(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">){ Auth::authorize(); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string"> = new tbl_fotos(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$user</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">-&gt;getOwner(); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$user</span></span></span><span class="hljs-string">['foto'] = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">['file_id']; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$user</span></span></span><span class="hljs-string">-&gt;update(); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;_goto(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;actUri("</span></span>showone<span class="hljs-string"><span class="hljs-string">", </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">)-&gt;url()); } //  "</span></span> <span class="hljs-string"><span class="hljs-string">" function action_delete(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">){ Auth::authorize(); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string"> = new tbl_fotos(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">); //FileStorage::delete(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">['file_id']); if(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">-&gt;isMain()){ </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$user</span></span></span><span class="hljs-string"> = User::getCurrentUser(); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$user</span></span></span><span class="hljs-string">['foto'] = "</span></span><span class="hljs-string"><span class="hljs-string">"; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$user</span></span></span><span class="hljs-string">-&gt;update(); } </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">['deleted'] = 1; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">-&gt;update(); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;_goto(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;actUri("</span></span>showone<span class="hljs-string"><span class="hljs-string">", </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">)-&gt;url()); } //  "</span></span>  <span class="hljs-string"><span class="hljs-string">" function action_restore(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">){ Auth::authorize(); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string"> = new tbl_fotos(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">['deleted'] = 0; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">-&gt;update(); </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;_goto(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$this</span></span></span><span class="hljs-string">-&gt;actUri("</span></span>showone<span class="hljs-string"><span class="hljs-string">", </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$foto_id</span></span></span><span class="hljs-string">)-&gt;url()); } }</span></span></code> </pre><br><br>  Each module, including the root module of the site, is executed by the following lines of code. <br>  For example, this is index.php in the project root: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">".setup.php"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    $lego = new site_controller(); //  -  $lego-&gt;run(); //   echo $lego-&gt;getOutput();// !      </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  That's all. <br>  How to add Lego-modules of life-giving AJAX, you can read <a href="http://habrahabr.ru/company/microset/blog/109481/">here</a> . <br>  You can test how it works with AJAX <a href="http://xn--e1afggmlij4g.xn--p1ai/">here</a> . <br><br>  I hope someone will come in handy this article. <br>  All successful Lego programming.  :) <br>  Thanks for attention!  Always yours, Jozhik. </div><p>Source: <a href="https://habr.com/ru/post/109890/">https://habr.com/ru/post/109890/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109881/index.html">"Come with us" move for the better!</a></li>
<li><a href="../109884/index.html">Web Store Restrictions Bypass</a></li>
<li><a href="../109887/index.html">Made by Us! Site about production in Russia</a></li>
<li><a href="../109888/index.html">A study of the Dutch shows that Anonymus is not so anonymous</a></li>
<li><a href="../109889/index.html">Mobile Application Development</a></li>
<li><a href="../109891/index.html">Microsoft Moles</a></li>
<li><a href="../109892/index.html">Overview of Configuration Management Best Practices Book</a></li>
<li><a href="../109894/index.html">New version of ASP.NET MVC 3 RC2 released</a></li>
<li><a href="../109895/index.html">5th Startup Crash Test</a></li>
<li><a href="../109897/index.html">Live stream from TechCrunch Moscow has begun</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>