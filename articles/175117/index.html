<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a complex application on knockout.js - 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am writing here one epic megahrenia, which I want to promote in Habr√©. This thing is a type of distributed social network. There are cores with api ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a complex application on knockout.js - 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/9e2/a94/4a5/9e2a944a57c8bc3121dd6f3488103e7b.png" align="left">  I am writing here one epic megahrenia, which I want to promote in Habr√©.  This thing is a type of distributed social network.  There are cores with api that communicate by some standard and front end.  The peculiarity of the network is that the frontend lives ‚Äúseparately‚Äù from the kernel, that is, the network does not have its own domain - we take html, put a link to any kernel and get a network that lives on top of the site.  Outwardly, this is similar to <a href="http://developers.facebook.com/docs/plugins/">Facebook social plugins</a> - comments and likes can be put on any page from there - only instead of fb-like tags powerful <a href="http://knockoutjs.com/">knockout.js</a> + links are used; the user is not limited to snaps from comments and likes - almost any block from the network can be imported to the site and do almost any action.  The frontend is written on the same technologies that the user can use and add on his page. <br><br>  The result was a technique that may be of interest to the front-line man.  I want to disassemble this technique in this article. <br><br>  I'll tell you about the system that is embedded on the html-page through the knockout binding.  The code lives in plug-in widgets, which consist of html-templates with knockout binding.  Widgets can be nested in each other.  All this uses <a href="http://requirejs.org/">require.js</a> and lives in <a href="http://requirejs.org/docs/whyamd.html">amd</a> form.  Dependencies on the external page are minimized, all libraries (jquery, knockout and plugins) are used only in their own local space with namespaces.  To build the code, use <a href="https://github.com/jrburke/r.js/">r.js.</a>  Even as cool peppers we will write a full-fledged window manager on the basis of the bootstrap dialogue - with a knockout, it‚Äôs like two fingers on asphalt ... <br><a name="habracut"></a><br><h4>  Demo and source </h4><br>  I advise you to look through my first knockout article - <a href="http://habrahabr.ru/post/154003/">http://habrahabr.ru/post/154003/</a> .  We will develop the ideas started there. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The prototype of the frontend network is here - <a href="https://github.com/Kasheftin/uncrd">https://github.com/Kasheftin/uncrd</a> . <br><br>  How it all looks, you can see here - <a href="http://www.photovision.ru/">http://www.photovision.ru</a> .  There is a site with photos that is not intended to be altered.  One script is connected from the uncrd.com domain, which provides network functionality.  When clicking on photos, the photo viewer windows should pop up, you can go to the authors' profiles, register, post photos and comments.  My goal was to write a standard network with the minimum allowable functionality. <br><br>  The repository also contains a piece of network documentation that lists most of the blocks and describes their parameters - <a href="http://uncrd.com/docs/1.html">http://uncrd.com/docs/1.html</a> . <br><br>  It should be noted that the frontend consists of a universal core and network-specific widgets.  View photos and profiles of the authors belong to the second, the window manager and the mechanism for connecting the widget to the first.  We will consider the basis, but it is poorly allocated from the system code, since it is being developed at the same time (for example, authorization is in the kernel, although it should be in a network-specific place), so I‚Äôll tell you something from the theory, and then I will collect in the demo-branch bare core, and analyze in detail a couple of demovidzhetov on it. <br><br><h4>  Disadvantages and css </h4><br>  The standard logic is when modules from some social network are connected to an external site - using an iframe.  This is safe because the external site does not catch the session, and the css is correct, because the css of the external site does not affect the styles inside the iframe.  This logic is broken here.  The network code is embedded directly on the page of the site, and due to this we get much more opportunities, and not just a dumb insertion of predefined square blocks.  Security is largely solved by the registration of sites on the network and tokens.  But css is not solved.  I don‚Äôt know how to insert your element on a page with arbitrary css-rules, don‚Äôt break everything around and know 100% what it looks like (except for listing absolutely all css-properties in each tag).  Therefore, in the prototype it is assumed that the site works on the bootstrap (the network does not drag css with its bootstrap, as this may break the design of the source site). <br><br><h4>  Core system </h4><br>  The frontend consists of a system kernel and dynamically loaded widgets.  Each widget consists of a js-object, which is located in a separate file in the amd-form (example <a href="">messageForm.js</a> ) and html-template with code (example <a href="https://github.com/Kasheftin/uncrd/blob/master/source/js/widgets/templates/messageForm.html">messageForm.html</a> ).  Recently, I have encountered several applications on knockout.js with a modular approach, and they all used this kind of binding: <br><br><pre><code class="javascript hljs">ko.bindingHandlers.widget = { <span class="hljs-attr"><span class="hljs-attr">update</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">element, valueAccessor, allBindingsAccessor, viewModel, bindingContext</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> widget = ko.utils.unwrapObservable(valueAccessor().data); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>([widget.templateName],<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">html</span></span></span><span class="hljs-function">) </span></span>{ ko.renderTemplate(element,bindingContext.extend({<span class="hljs-attr"><span class="hljs-attr">$data</span></span>:widget}),{<span class="hljs-attr"><span class="hljs-attr">html</span></span>:html},element); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (widget.domInit) widget.domInit(elem,valueAccessor()); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">controlsDescendantBindings</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}; }</code> </pre> <br><br>  Then in core.js or in any widget (since they support nesting each other), an object of the required widget is created: this.w = SomeWidget ();  and in the right place of the template the &lt;! - ko widget: {data: w} -&gt; &lt;! - / ko -&gt; is called.  I note that knockout natively supports only "named" and "internal unnamed" templates, and therefore the renderTemplate method in this case uses the <a href="">stringTemplateEngine</a> from <a href="http://habrahabr.ru/post/154003/">this article</a> . <br><br>  The advantage of this approach is simplicity.  At explicit creation of the widget it is known that where it lives, and the binding stupidly renders the template in the context of the newly created object.  However, in uncrd it is necessary that widgets can be created from html, without programming.  You need to work, for example, such code: <br><br><pre> <code class="html hljs xml">...   ... <span class="hljs-comment"><span class="hljs-comment">&lt;!-- uncrd if: user --&gt;</span></span> , <span class="hljs-comment"><span class="hljs-comment">&lt;!-- uncrd text: user.name --&gt;</span></span><span class="hljs-comment"><span class="hljs-comment">&lt;!-- /uncrd --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- uncrd widget: 'userMenu' --&gt;</span></span><span class="hljs-comment"><span class="hljs-comment">&lt;!-- /uncrd --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- /uncrd --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- uncrd ifnot: user --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- uncrd widget: 'loginForm' --&gt;</span></span><span class="hljs-comment"><span class="hljs-comment">&lt;!-- /uncrd --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- /uncrd --&gt;</span></span> ...   ...</code> </pre><br><br>  This means that widgets must be created inside widget-binding.  In this case, there is a problem with access to the created object - inside the model code we do not know when the objects of the internal subwidgets will be loaded and created, and where they will live.  Therefore, when creating a widget inside widget-binding, you need to register the created object in its parent within some childrenWidgets variable, and if you want to delete the widget, recursively delete the entire subtree.  This is due to the rather voluminous code of the resulting binding, <a href="">widgetBinding.js</a> . <br><br><h4>  Window manager </h4><br>  I like the way the bootstrap dialog pops up.  I even tried to use its window jquery plugin, however glitches with fade prevented me from creating multiple windows and incorrect scrolling.  I'm lying.  Mainly prevented by the realization that all the power of a knockout is at hand, and he is busy with jquery and DOM.  I hate DOM manipulations if there is a knockout.  In uncrd, DOM th manipulations are found only in two cases in specially designed domInit methods.  Therefore, its own window manager <a href="">windowManager.js</a> was written on the bootstrap styles, which supports multiple open windows and drag-and-drop, and all window parameters are observable variables. <br><br>  I'll tell you about one elegant trick there.  windowManager has an open method through which a window opens with any widget.  The opened window itself is also a widget, and therefore registers itself in the childrenWidgets array with the guy, which is the windowManager.  When we initialize windowManager, we explicitly set this.childrenWidgets = ko.observableArray ([]), and therefore it is not overridden by a regular array in the widget binding.  The convenience here is that observableArray has the same push, pop, splice methods as a regular array.  Therefore, inside a binding binding widget it doesn‚Äôt matter whether it‚Äôs a regular array or observable.  Each opened window registers itself now in observableArray.  And this means that you can subscribe to the changes of the latter, which is done.  And now - if childrenWidgets is not empty, you need to darken the site page, ‚Äúnail down‚Äù the content with position: fixed and show the finished windows, and if not, return everything as it was. <br><br>  The <a href="">modalWindow3.js</a> modal window <a href="">itself</a> is html from bootstrap + calculation of positioning depending on the size of the content, position and dragging, nothing supernatural.  The only feature is that the name, title and footer of the internal widget can be sub-widgets defined via observable variables, and when parameters are changed, the widgets are automatically re-created.  And for this you did not need to write a single line - everything is provided by the update method in the widget binding. <br><br><h4>  Boot indication </h4><br>  Load indication during ajax requests is one of the unloading things in the site's UI.  Every time you need to think about where the icon will appear with ‚Äúplease wait‚Äù when submitting the next form, where the result will be drawn (especially if there is an error), and what to do with the other elements on the screen (whether to block the input and how to respond when trying to close the window with the form being sent) .  In the network engine, the following mechanism is implemented to indicate loading. <br><br>  The <a href="https://github.com/Wolfy87/EventEmitter">eventEmitter</a> methods are mixed into the prototype of each widget.  When the widget is initialized, you can set the special variable this.requiresLoading = true, and then widgetBinding will consider the widget asynchronous and expect a ready event from it.  However, the widget is rendered immediately, regardless of its state, and therefore must internally take care of what it shows until it prepares its data.  Simple widgets usually have the variable this.loading = ko.observable (true), and their templates look like this: <br><br><pre> <code class="html hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- uncrd if: loading --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"uncrd-loading-with-icon"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- /uncrd --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- uncrd ifnot: loading --&gt;</span></span> ...   ... <span class="hljs-comment"><span class="hljs-comment">&lt;!-- /uncrd --&gt;</span></span></code> </pre><br><br>  Let's presuppose that on the page there is a link, when clicked, you need to open a modal window with a user profile, <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-uncrd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"click:open.bind($data,{name:'profile',id:123})"</span></span></span><span class="hljs-tag">&gt;</span></span>  #123<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span>.</code> </pre><br><br>  When you click a modal window opens (the modal window widget does not require its download), a profile widget is displayed inside it, which shows the download icon while prompting for user data.  It works clumsily, it turns out that when surfing within the network, with each click, the same empty modal window with a download icon is shown each time.  To avoid this, it is here that the ready event from the widget is used.  You can write this: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-uncrd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"click:open.bind($data,{name:'profile',id:123,loading:'after'})"</span></span></span><span class="hljs-tag">&gt;</span></span>  #123<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"uncrd-loading-after"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-uncrd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"click:open.bind($data,{name:'profile',id:123})"</span></span></span><span class="hljs-tag">&gt;</span></span>  #123<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span>.</code> </pre><br><br>  And then when you click a modal window does not open until an asynchronous internal widget emits a ready event.  Instead, we have an event of the event click, the event.currentTarget element, we check for the presence of the loading property or the uncrd-loading css class of something and draw an absolutely positioned loading icon next to the currentTarget element.  After means after the element, before - before, over - over the middle of the link (in photos and avatars).  If it was not possible to draw the download icon to the element that caused the opening of the window, force the window to open in a clumsy way.  The last case occurs, for example, when the page is reloaded - the router during initialization, depending on location.hash, opens the corresponding window but does not know to which element on the page to draw an icon while the data is being loaded. <br><br><h4>  Connecting libraries and compiling with r.js </h4><br>  I repeat once again that an important requirement for the network is maximum autonomy.  All libraries, including jquery and knockout, live locally and are loaded from the system kernel.  That is why the use of tags and attributes data-uncrd = "..." instead of native and data-bind = "..." - this is not foppery.  All libraries and kernel scripts are assembled into a single main.js file using bare <a href="https://github.com/jrburke/r.js/">r.js.</a>  Config here - <a href="">build.js</a> .  However, in the future I will advise everyone to use <a href="http://gruntjs.com/">soil</a> as a basis.  In r.js, for some reason, you can either process one file or the entire directory, but you can't put main.js from one of the kernel files + in one action next to the subdirectory of the widgets.  Also, if you have a project on require.js with require.config ({...}) in the main main.js file, you should be aware that this config is not taken into account when building with r.js - all paths should Re-specified in the build.js file, which is specified during the build (node ‚Äã‚Äãr.js -o build.js). <br><br>  In r.js, errors ( <a href="https://github.com/jrburke/r.js/issues/341"># 341</a> ) are possible when working with namespaces, this is due to the fact that at the moment the namespace is substituted into the define and require variables through regular regular expressions.  In the code of the knockout.js library, the syntax in the amd environment check is slightly different, and the regularspace for the namespace does not work there.  There is no solution yet, you need to check the output and add regulars or edit the library code. <br><br><h4>  Practice writing your widgets </h4><br>  In the repository in the <a href="https://github.com/Kasheftin/uncrd/tree/demo">demo</a> branch threw all unnecessary.  In the /demo/1.html folder there is a file on which primitive widgets are displayed, which we will now write. <br><br>  Let's start with the top bar widget, which does not require downloads, but simply shows the bar with the top menu.  The widget's logic is in source / widgets / models / topBar.js, it is empty: <br><br><pre> <code class="javascript hljs">define(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> TopBar = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TopBar; });</code> </pre><br><br>  The widget's HTML template is in source / widgets / templates / topBar.html, the usual html type: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar navbar-fixed-top uncrd-topbar"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-inner"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"brand"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag">&gt;</span></span>UnCRD<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-uncrd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"click:o('page1')"</span></span></span><span class="hljs-tag">&gt;</span></span>  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-uncrd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"click:o({name:'page2',param1:'value1',loading:'after'})"</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-uncrd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"click:o({modalWindow:{header:'',content:''}})"</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"loginForm"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-uncrd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"widget:{name:'loginForm',template:'loginFormInline'}"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Despite the fact that TopBar contains nothing, it should be remembered that widgetBinding adds eventEmitter methods to it, the widget has an array of this.childrenWidgets from one element - the loginForm internal widget.  It also has methods common for all widgets: this.destroy (deletes the subwidget tree), this.open (opens the window) and this.o (short for this.open, which returns this.open.bind (...)). <br><br>  Let's complicate topBar.  Suppose that at initialization it should beautifully jquery-slow go to the top.  There are two ways to do this.  It is more correct to write customBinding to leave and pryndit it to the root element of the template, however sometimes you want to have access to the DOM from the model from inside the model, which obviously appears after creating the widget object and using renderTemplate.  The domInit method is provided for this - it is called after the renderTemplate if specified and has self parameters (the widget itself), element (the DOM element that caused the widget to be created) and firstDomChild (the first found DOM element of the nodeType = 1 type within the template): <br><br><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">"jquery"</span></span>],<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> TopBar = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ } TopBar.prototype.domInit = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">self,element,firstDomChild</span></span></span><span class="hljs-function">) </span></span>{ $(firstDomChild).hide().slideDown(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TopBar; });</code> </pre><br><br>  When clicking on the first link of the top bar, the method o ('page1') is called.  This means that a modal window will be opened, into the content of which the widget with the model /widgets/models/page1.js and the template /widgets/templates/page1.html will be loaded.  Despite the fact that the modalWindow widget formally contains page1, in fact, page1 is the main one, and modalWindow is only a binding, so page1 has access to its window in the property this.modalWindow. <br><br><pre> <code class="javascript hljs">define(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Page1 = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">o</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modalWindow = o.options.modalWindow; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modalWindow) { modalWindow.width(<span class="hljs-number"><span class="hljs-number">700</span></span>); modalWindow.cssPosition(<span class="hljs-string"><span class="hljs-string">"absolute"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.close = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ modalWindow.destroy(); <span class="hljs-comment"><span class="hljs-comment">//      modalWindow,    modalWindow      } } else { this.close = function() { this.destroy(); } } } return Page1; });</span></span></code> </pre><br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> ...   ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-uncrd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"click:close"</span></span></span><span class="hljs-tag">&gt;</span></span>    page1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  By default, a modal window has position = fixed.  When the window is opened, the site content is dimmed by the fade div and ‚Äúnailed‚Äù, i.e.  it is placed position = fixed, marginTop = scrollTop, then the darkened content remains in place and the scroll disappears.  If the modal window has position = absolute and is higher than the screen height, the resulting scroll begins to control the window offset instead of the content offset.  When all windows are closed, the original properties are put down.  This behavior seems to me more correct than bootstrap, when a dialogue with position: fixed appears, and the content under it continues to scroll (and ahtung happens, if suddenly the modal window is higher in height than the screen). <br><br>  Let's proceed to asynchronous loading.  Let page2 need to load some data before displaying.  We set this.requiresLoading, emit the ready event, do not forget that the widget can be shown immediately with no data loaded: <br><br><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">"knockout"</span></span>],<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ko</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Page2 = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">o</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requiresLoading = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loading = ko.observable(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stringFromServer = ko.observable(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } Page2.prototype.domInit = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">self,element,firstDomChild</span></span></span><span class="hljs-function">) </span></span>{ setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     self.stringFromServer("   "); self.loading(false); self.emit("ready"); },1000); } return Page2; });</span></span></code> </pre><br><br><pre> <code class="html hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- uncrd if: loading --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"uncrd-loading-with-icon"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- /uncrd --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- uncrd ifnot: loading --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-uncrd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text:stringFromServer"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- /uncrd --&gt;</span></span></code> </pre><br><br>  Paste this widget directly to the / demo/1.html page next to the top bar and reload the page.  We see that the widget here has nowhere to ascribe its download icon, so it is drawn immediately and shows the download icon inside.  However, when clicking on the page2 link in the top menu, the download icon will appear next to the link, and the modal window with the page will appear ready. <br><br>  The properties of the modal window can be set from the internal widget, but with a lower priority, you can specify them directly in the open method.  For example, you can not specify the name of the internal widget at all, but instead specify the content property - then you get a normal modal window with the text: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-uncrd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"click:o({modalWindow:{header:'',content:''}})"</span></span></span><span class="hljs-tag">&gt;</span></span>    <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h4>  Total </h4><br>  Simple widgets written together.  Complex widgets can be seen in the repository, <a href="https://github.com/Kasheftin/uncrd">https://github.com/Kasheftin/uncrd</a> .  These are the same simple widgets, only more voluminous.  The system is in development at the prototype level.  How the prototype works on a live site - see here: <a href="http://www.photovision.ru/">http://www.photovision.ru</a> .  A demo page with all the widgets and pieces of documentation is available here: <a href="http://uncrd.com/docs/1.html">http://uncrd.com/docs/1.html</a> .  A demo from the bare core and three stupid example widgets can be downloaded from the <a href="https://github.com/Kasheftin/uncrd/tree/demo">demo</a> branch, everything has already been assembled (and relative paths are set), you just need to open /demo/1.html in the browser. </div><p>Source: <a href="https://habr.com/ru/post/175117/">https://habr.com/ru/post/175117/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175107/index.html">Software Day Conference - Legal Aspects of Software</a></li>
<li><a href="../175109/index.html">What is most important in IT exhibitions? Demonstrations</a></li>
<li><a href="../175111/index.html">IT exhibition MUK-EXPO 2013 in a week</a></li>
<li><a href="../175113/index.html">Theoretical computer science at the Academic University</a></li>
<li><a href="../175115/index.html">Why today's rights holders curse descendants</a></li>
<li><a href="../175119/index.html">The efficiency of the working day of one PMA</a></li>
<li><a href="../175121/index.html">Writing multi-threaded applications for a Windows store using Intel Threading Building Blocks - now with a DLL</a></li>
<li><a href="../175125/index.html">III Forum Apps4All: free for habr developers</a></li>
<li><a href="../175127/index.html">Test task - long, interesting, but ineffective</a></li>
<li><a href="../175131/index.html">IT exhibition MUK-EXPO 2013 in 2 days</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>