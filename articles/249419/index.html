<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Methods for modifying machine code: "selection" vs. "Genetic Engineering"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About the myths about GMOs have already been written here . In addition to this, I would like to share an excellent analogy with the analysis of real ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Methods for modifying machine code: "selection" vs. "Genetic Engineering"</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/cb8/0a9/485/cb80a948570843dfbe3b93079c56ffbb.png" title="9999 topics in 1 article!"><br><br>  About the myths about GMOs <a href="http://geektimes.ru/post/171273/">have already been written here</a> .  In addition to this, I would like to share an excellent analogy with the analysis of real examples from the field of reverse engineering and the modification of machine code, which will be understood and closely related to programmers. <br><br><h2>  Machine Code Mutations </h2><br>  As an example, let's take the NES prefix (known as Dendy here), which uses the 6502 processor. The command system is very simple - the opcode is always represented by one byte, and each of the 256 does at least do something.  No "protection" against the fool is not provided, and almost any random set of bytes will be executed without resistance from the processor.  Thus, we can take a ROM of a game, fix random bits in it (we will call it ‚Äúmutations‚Äù) - and after launching we see <a href="http://youtu.be/0bgomwomhJ4%3Ft%3D2m26s">funny glitches</a> in various unexpected places, but in general the game will most likely work.  It seems that on YouTube there is <a href="https://www.youtube.com/results%3Fsearch_query%3Dcorrupt%2Bnes">a whole genre of</a> this video.  The machine code obtained in this way is probably not very correct, but in most cases the processor will be able to execute it and do something. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As it turned out, such a technique is used not only for fun (and playing familiar games with unexpected glitches is quite funny), but also for getting specific modifications to yourself: they make a large number of ‚Äúmutants‚Äù and look for the one in which the desired effect manifests itself.  Just as in modern methods of selection, when the embryos of organisms are exposed to mutagens (which leads to random changes in the genetic code), and then from those that could grow, those that have the desired trait are selected.  The organisms thus obtained receive, in the appendix, a mass of other undesirable mutations.  Get rid of them by gradual crossing with a normal species, seeking to obtain a more or less sane organism with the desired trait and a minimum of other mutations that were noticeable.  The same can be done with machine code. <br><a name="habracut"></a><br><h2>  "Genetic engineering" on machine code </h2><br>  As a direct analogy, reverse engineering is suggested here.  We study the machine (binary) code, understand how it works (in whole or only some of its parts), after which we make the changes that will most likely lead us to the target effect. <br><br>  Programmers have a huge number of tools for analyzing machine code (all kinds of disassemblers, debuggers, and the like).  Despite the fact that the machine code itself is not intended for human reading, it was invented by people and documented, so creating tools to transform it into a more understandable form (assembly listing) was not a problem.  Also, almost any program under investigation was most likely also written by man, so what makes its code usually looks logical and understandable. <br><br>  It is clear that geneticists are much more difficult.  There is no official documentation that could shed light on any questions that may arise.  The genetic code was ‚Äúwritten‚Äù by chance and selected according to the principle ‚Äúwhether it could survive, adapt and give offspring‚Äù, so surely it is far from logical and optimal, rather even any obfuscation of program code we have invented will seem just childish prattle.  However, this does not mean that the genetic code cannot be studied and tried to change it. <br><br><h2>  Prehistory </h2><br>  For me, Dendy has always been more than just a prefix.  I not only played it, but also spent considerable time inside it with a soldering iron in my hands for some simple modifications.  On the way somewhere I often thought about how these games are created and how it works inside.  Surely, many of you, too, once asked such questions, such is the nature of future IT-people. <br><br>  Years have passed.  With a certain periodicity I immersed myself in an emu-topic, learning everything new on thematic sites, but I did not dare to plunge into the study of 6502 assembler and NES architecture.  Internal conflict is rational and irrational.  I have long convinced myself that I did not need to spend time on it, but ... I lost my temper.  Looking at what interesting things do emu-scene enthusiasts do, I took up my old idea with a bright thought: ‚ÄúI will be able too!‚Äù. <br><br>  Surely many of you remember the ‚Äú9999-in-1‚Äù cartridges, which were remarkable for the beautiful menu with a romantic plot by the sea, flying seagulls and pleasant music (Unchained Melody).  I disassembled this menu and made a tribute demo of <a href="http://veg.by/ru/projects/unchained/">Unchained Nostalgia</a> based on it. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/_9HYL21d8gQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  The main idea is that there is no list of games, and the slides switch to the music.  In the free sky, I drew meaningful clouds and stars;  implemented automatic slide switching in sync with music and the ability to manually switch;  added auto-correction of playback speed and pitch for systems other than Dendy (after all, this menu was made specifically for Chinese family names, and they <a href="http://wiki.nesdev.com/w/index.php/Clock_rate">differed</a> from the original NES, which is why the original menu works too fast on NES NTSC, and on NES PAL it turns out to be too low sound);  I could not resist the temptation to add a number of curious Easter eggs.  That is, the approach used does not limit the imagination in any way and allows, in principle, to make any changes for some finite time. <br><br><h2>  However, similar ideas come to mind to different people. </h2><br>  After the release of my demo, I discovered that someone also tried to implement the same idea.  The author indicated that he used ‚Äúcorruptor‚Äù, which is usually used to create corrupt versions of games with various glitches. <br><br>  If someone had previously told me that such a ‚Äúrandom‚Äù method is actually used to modify the machine code with the desired effects, I certainly would not have believed it.  After all, this requires a lot of time and luck.  Although on the other hand there is no need to study and understand the machine code.  Since I already had a ‚Äúlive‚Äù example of such a hack in my hands, nothing remained but to investigate his work. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/tBO9isaAOTU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Slides switch automatically, about every 2 seconds (which is too fast).  There is no manual control.  When you change the slide for some reason, the screen flickers twice.  The main thing is that it works!  But how? <br><br><h2>  Traces of surgery </h2><br>  In the cartridge, the program code and graphics tiles are stored separately.  The code is in PRG ROM, the tiles are in CHR ROM.  The second can be easily changed using standard tools, for this reason, for Dendy there are a huge number of graphical hacks of famous games, where the code is left completely unchanged. <br><br>  Compare the CHR ROM of the original menu and the hack under study: <br><img src="https://habrastorage.org/files/639/067/70a/63906770a75b47859488fa750b706a69.gif"><br>  On the face of the traces of direct "surgical" intervention.  For some reason, tiles of numbers, dots and a small gull were cut.  Let's try to return the original CHR ROM and see what was hidden in this way. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6yze-bszgmA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Now it has become a little clearer.  The input was broken in the program code, because of which the menu thinks that the ‚Äúdown‚Äù button is always pressed.  Also the output of game titles was broken.  Apparently, it did not work to break the output of the numbers of games and the little gull (this is the cursor pointing to the selected game), so they had to be hidden by cutting out the corresponding tiles in CHR ROM. <br><br><h2>  ... and some magic! </h2><br>  Digging deeper.  Using the disassembler, let's see what exactly the bytes mutated in the PRG ROM do. <br><table><tbody><tr><th>  Original Code </th><th>  Hack code </th></tr><tr><td><code>NMI: <br> PHA <br> TXA <br> PHA <br> TYA <br> PHA <br> LDA $1E <br> BEQ loc_C181 <br> JSR sub_C592 <br> loc_C181: <br> LDA #0 <br> JSR <font color="red">sub_C428</font></code> </td> <td> <code>NMI: <br> PHA <br> TXA <br> PHA <br> TYA <br> PHA <br> LDA $1E <br> BEQ loc_C181 <br> JSR sub_C592 <br> loc_C181: <br> LDA #0 <br> JSR <font color="red">sub_C445</font></code> </td> </tr></tbody></table>  This is the NMI interrupt handler, which is called when the next frame is drawn.  Apparently, the address of the called function was corrected.  The original function was engaged in reading the state of all buttons and writing their values ‚Äã‚Äãinto one byte in the form of a bit mask.  The new call executes only the last instruction in this function, which saves the result from the Y register to a variable with the mask of the currently pressed buttons.  Thus, the garbage value of the Y register is used, which remains after the execution of the previous code.  In most cases, there is a trash value of 0x07, which in binary form looks like 00000111 and corresponds to the Down, Left, and Right buttons simultaneously pressed (the main code ignores Left and Right, processing the Down button) .  However, immediately after the slide is switched to Y, the trash value 0xFF remains, which means that all the buttons were pressed simultaneously, which eventually caused the debugging code, which in the original menu (on Left + Start + B) displays the revision number that is accompanied by disabling PPU for one frame.  This causes double screen flicker. <br><table><tbody><tr><th>  Original Code </th><th>  Hack code </th></tr><tr><td> <code>LDA #0 <br> STA $2000 <br> STA $2001 <br> <font color="red">LDA</font> #$22 <br> STA $2006 <br> LDA #$AC <br> STA $2006</code> </td> <td> <code>LDA #0 <br> STA $2000 <br> STA $2001 <br> <font color="red">SBC</font> #$22 <br> STA $2006 <br> LDA #$AC <br> STA $2006</code> </td> </tr></tbody></table>  The output code of the revision number on Left + Start + B is broken here, so even though this debugging code is executed every time due to the problem described above, we still don‚Äôt see the revision numbers on the screen.  It turned out in a funny way: the instruction that set the value of 0x22 into register A was replaced with an instruction that subtracts the number 0x22 from register A.  Since the register A is always 0 before this, the number 0xDE is obtained.  The original code set for PPU the beginning of the output at 0x22AC in the video memory, which is located within the first screen.  The new code, it turns out, sets the address 0xDEAC, which is far beyond the limits of the available video memory (the maximum allowed address is $ 3FFF), and as a result, the inscription is displayed ‚Äúto nowhere‚Äù. <br><table><tbody><tr><th>  Original Code </th><th>  Hack code </th></tr><tr><td> <code>ASL A <br> TAX <br> LDA $EAB3,X <br> STA <font color="red">$0A</font> <br> LDA $EAB4,X <br> STA $0B <br> LDY #0 <br> loc_C380: <br> LDA ( <font color="red">$0A</font> ),Y <br> BEQ loc_C38B <br> STA $2007 <br> INY <br> JMP loc_C380</code> </td> <td> <code>ASL A <br> TAX <br> LDA $EAB3,X <br> STA <font color="red">$FA</font> <br> LDA $EAB4,X <br> STA $0B <br> LDY #0 <br> loc_C380: <br> LDA ( <font color="red">$FA</font> ),Y <br> BEQ loc_C38B <br> STA $2007 <br> INY <br> JMP loc_C380</code> </td> </tr></tbody></table>  Here we had a broken code that displays the names of games.  When writing a pointer to the output string, the low byte of the 16-bit pointer is written at 0xFA instead of 0x0A, and the high byte is written as it should - at address 0x0B.  I was lucky that 0xFA was not used, and it did not break anything further.  Next, the program reads the line pointed to by a pair of bytes 0xFA and 0xFB (0xFB is always 0).  By a happy coincidence, all the pointers thus obtained point to a memory filled with zeros, so the lines with the name of the games are not output. <br><br><h2>  findings </h2><br>  Have you been able to feel how everything is ‚Äúfamously twisted‚Äù in the modifications created in such a ‚Äúrandom‚Äù way?  One failure props another failure, and somehow it generally gives a result that is close to the desired one.  At the same time, there are simply incredible dependencies between random and, at first glance, unconnected parts of the code, and with the slightest further modifications (even correct ones themselves), everything can collapse.  Full reverse engineering is much more reliable.  The same can be said about genetic engineering, in comparison with traditional selection. <br><br><h2>  File Links </h2><br><ul><li>  <a href="">unchained_nostalgia.zip</a> is a Unchained Nostalgia demo created by reverse engineering. </li><li>  <a href="">guyver_hack.zip</a> is a <a href="">randomly crafted</a> hack and its original ROM. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/249419/">https://habr.com/ru/post/249419/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249409/index.html">Reverse engineering of Parktronic protocol. Dance of little bits</a></li>
<li><a href="../249411/index.html">The digest of interesting materials for the mobile developer # 88 (January 26 - February 1)</a></li>
<li><a href="../249413/index.html">Non-von Neumann computer based on combinatorial logic</a></li>
<li><a href="../249415/index.html">Overview of the most interesting materials on data analysis and machine learning ‚Ññ33 (January 26 - February 1, 2015)</a></li>
<li><a href="../249417/index.html">Breeze Server - we delimit access to objects using attributes</a></li>
<li><a href="../249421/index.html">Robot on RaspberryPi, Arduino and RaspiCam + OpenCV. Part 1 Review</a></li>
<li><a href="../249423/index.html">Find typos in ** kwargs</a></li>
<li><a href="../249425/index.html">Pundle - bundler for python</a></li>
<li><a href="../249427/index.html">New invariant of a natural number. Theorem and proof</a></li>
<li><a href="../249429/index.html">On the existence of periodic solutions in the Lorentz system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>