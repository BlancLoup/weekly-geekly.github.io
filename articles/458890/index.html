<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sampling and calculation accuracy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A number of my colleagues are faced with the problem that in order to calculate a certain metric, for example, a conversion rate, it is necessary to c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sampling and calculation accuracy</h1><div class="post__text post__text-html js-mediator-article"><p>  A number of my colleagues are faced with the problem that in order to calculate a certain metric, for example, a conversion rate, it is necessary to check the entire database.  Or you need to conduct detailed research on each client, where there are millions of customers.  These kinds of checks can work for quite a long time, even in storage facilities specially made for this.  It's not very cool to wait for 5-15-40 minutes, while a simple metric is considered to find out that you need to count something else or add something else. </p><br><p>  Sampling is one of the solutions to this problem: we are not trying to calculate our metric on the whole data array, but take a subset that representatively represents the metrics we need.  This sample can be 1000 times smaller than our data set, but at the same time it is good enough to show the numbers we need. </p><br><p>  In this article, I decided to demonstrate how the sampling sample sizes affect the final metric error. </p><a name="habracut"></a><br><h2 id="problema">  Problem </h2><br><p>  The key question is: how well does the sample describe the ‚Äúpopulation‚Äù?  Once we take a sample from the common array, the metrics we get are random variables.  Different samples will give us different metrics results.  Different, does not mean any.  Probability theory tells us that sampling metric values ‚Äã‚Äãshould be grouped around the true metric value (taken over the entire sample) with a certain level of error.  At the same time, we often have problems where, to solve, we can manage with different levels of error.  It's one thing to figure out whether we get a conversion of 50% or 10%, and another thing is to get the result with an accuracy of 50.01% vs 50.02%. </p><br><p>  Interestingly, from the point of view of the theory, the conversion rate observed by us over the entire sample is also a random variable, since  The ‚Äútheoretical‚Äù conversion rate can only be calculated on a sample of infinite size.  This means that even all our observations in the database actually give an estimate of the conversion with their accuracy, although it seems to us that these calculated figures of ours are absolutely accurate.  This also leads to the conclusion that even if today the conversion rate is different from yesterday's, it does not mean that something has changed, but only means that today's sample (all observations in the database) from the general population (all possible observations of this day, which occurred and did not occur) gave a slightly different result than yesterday.  In any case, for any honest product or analyst, this should be a basic hypothesis. </p><br><h2 id="formulirovka-zadachi">  Task statement </h2><br><p>  Suppose we have 1,000,000 entries in the database of the form 0/1, which tell us about whether there was a conversion on the event.  Then the conversion rate is simply the sum of 1 divided by 1 million. </p><br><p>  Question: if we take a sample of size N, then by how much and with what probability will the conversion rate differ from that calculated for the entire sample? </p><br><h2 id="teoreticheskie-rassuzhdeniya">  Theoretical reasoning </h2><br><p>  The task is to calculate the confidence interval of the conversion coefficient for a sample of a given size for the binomial distribution. </p><br><p>  From theory, the standard deviation for the binomial distribution is: <br>  S = sqrt (p * (1 - p) / N) </p><br><p>  Where <br>  p - conversion rate <br>  N - sample size <br>  S - standard deviation </p><br><p>  I will not take the confidence interval directly from the theory.  There is a rather complicated and tangled mat, which ultimately relates the standard deviation and the final estimate of the confidence interval. </p><br><p>  Let's develop an "intuition" about the standard deviation formula: </p><br><ol><li>  The larger the sample size, the smaller the error.  In this case, the error falls in the inverse quadratic dependence, i.e.  an increase in the sample by 4 times increases the accuracy only 2 times.  This means that at some point, increasing the sample size will not give special advantages, and also means that a fairly high accuracy can be obtained with a rather small sample. </li></ol><br><p><img src="https://habrastorage.org/webt/gw/e-/mc/gwe-mczmjmsdsq8ezxuulsf6ito.png"></p><br><ol><li>  There is an error dependence on the conversion rate.  The relative error (i.e., the ratio of the error to the magnitude of the conversion rate) has the ‚Äúnasty‚Äù tendency to be the greater, the lower the conversion rate: </li></ol><br><p><img src="https://habrastorage.org/webt/4x/9y/0t/4x9y0t_ornj-056s43ejtdovfle.png"></p><br><ol><li>  As we can see, the error "flies up" into the sky with a low conversion rate.  This means that if you sample rare events, then you need large sample sizes, otherwise you will get a conversion estimate with a very large error. </li></ol><br><h2 id="modelirovanie">  Modeling </h2><br><p>  We can completely move away from the theoretical solution and solve the problem "head on."  Thanks to the R language, this is now very easy to do.  To answer the question of which error we get in sampling, you can simply do a thousand samples and see what error we get. </p><br><p>  The approach is as follows: </p><br><ol><li>  We take different conversion rates (from 0.01% to 50%). </li><li>  We take 1000 samples of 10, 100, 1000, 10000, 50000, 100000, 250000, 500000 elements in the sample </li><li>  We count the conversion rate for each group of samples (1000 coefficients) </li><li>  We build a histogram for each group of samples and determine the extent to which 60%, 80% and 90% of the observed conversion rates lie. </li></ol><br><p>  Code on R that generates data: </p><br><pre><code class="plaintext hljs">sample.size &lt;- c(10, 100, 1000, 10000, 50000, 100000, 250000, 500000) bootstrap = 1000 Error &lt;- NULL len = 1000000 for (prob in c(0.0001, 0.001, 0.01, 0.1, 0.5)){ CRsub &lt;- data.table(sample_size = 0, CR = 0) v1 = seq(1,len) v2 = rbinom(len, 1, prob) set = data.table(index = v1, conv = v2) print(paste('probability is: ', prob)) for (j in 1:length(sample.size)){ for(i in 1:bootstrap){ ss &lt;- sample.size[j] subset &lt;- set[round(runif(ss, min = 1, max = len),0),] CRsample &lt;- sum(subset$conv)/dim(subset)[1] CRsub &lt;- rbind(CRsub, data.table(sample_size = ss, CR = CRsample)) } print(paste('sample size is:', sample.size[j])) q &lt;- quantile(CRsub[sample_size == ss, CR], probs = c(0.05,0.1, 0.2, 0.8, 0.9, 0.95)) Error &lt;- rbind(Error, cbind(prob,ss,t(q))) }</code> </pre> <br><p>  As a result, we get the following table (more will be the graphics, but the details are better seen in the table). </p><br><div class="scrollable-table"><table><thead><tr><th>  Conversion rate </th><th>  Sample size </th><th>  five% </th><th>  ten% </th><th>  20% </th><th>  80% </th><th>  90% </th><th>  95% </th></tr></thead><tbody><tr><td>  0.0001 </td><td>  ten </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td></tr><tr><td>  0.0001 </td><td>  100 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td></tr><tr><td>  0.0001 </td><td>  1000 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0.001 </td></tr><tr><td>  0.0001 </td><td>  10,000 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0.0002 </td><td>  0.0002 </td><td>  0.0003 </td></tr><tr><td>  0.0001 </td><td>  50,000 </td><td>  0.00004 </td><td>  0.00004 </td><td>  0.00006 </td><td>  0.00014 </td><td>  0.00016 </td><td>  0.00018 </td></tr><tr><td>  0.0001 </td><td>  100,000 </td><td>  0.00005 </td><td>  0.00006 </td><td>  0.00007 </td><td>  0.00013 </td><td>  0.00014 </td><td>  0.00016 </td></tr><tr><td>  0.0001 </td><td>  250,000 </td><td>  0.000072 </td><td>  0.0000796 </td><td>  0.000088 </td><td>  0.00012 </td><td>  0.000128 </td><td>  0.000136 </td></tr><tr><td>  0.0001 </td><td>  500,000 </td><td>  0.00008 </td><td>  0.000084 </td><td>  0.000092 </td><td>  0.000114 </td><td>  0.000122 </td><td>  0.000128 </td></tr><tr><td>  0.001 </td><td>  ten </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td></tr><tr><td>  0.001 </td><td>  100 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0.01 </td></tr><tr><td>  0.001 </td><td>  1000 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0.002 </td><td>  0.002 </td><td>  0.003 </td></tr><tr><td>  0.001 </td><td>  10,000 </td><td>  0.0005 </td><td>  0.0006 </td><td>  0.0007 </td><td>  0.0013 </td><td>  0.0014 </td><td>  0.0016 </td></tr><tr><td>  0.001 </td><td>  50,000 </td><td>  0.0008 </td><td>  0.000858 </td><td>  0.00092 </td><td>  0.00116 </td><td>  0.00122 </td><td>  0.00126 </td></tr><tr><td>  0.001 </td><td>  100,000 </td><td>  0.00087 </td><td>  0.00091 </td><td>  0.00095 </td><td>  0.00112 </td><td>  0.00116 </td><td>  0.0012105 </td></tr><tr><td>  0.001 </td><td>  250,000 </td><td>  0.00092 </td><td>  0.000948 </td><td>  0.000972 </td><td>  0.001084 </td><td>  0.001116 </td><td>  0.0011362 </td></tr><tr><td>  0.001 </td><td>  500,000 </td><td>  0.000952 </td><td>  0.0009698 </td><td>  0.000988 </td><td>  0.001066 </td><td>  0.001086 </td><td>  0.0011041 </td></tr><tr><td>  0.01 </td><td>  ten </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0.1 </td></tr><tr><td>  0.01 </td><td>  100 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0.02 </td><td>  0.02 </td><td>  0.03 </td></tr><tr><td>  0.01 </td><td>  1000 </td><td>  0.006 </td><td>  0.006 </td><td>  0.008 </td><td>  0.013 </td><td>  0.014 </td><td>  0.015 </td></tr><tr><td>  0.01 </td><td>  10,000 </td><td>  0.0086 </td><td>  0.0089 </td><td>  0.0092 </td><td>  0.0109 </td><td>  0.0114 </td><td>  0.0118 </td></tr><tr><td>  0.01 </td><td>  50,000 </td><td>  0.0093 </td><td>  0.0095 </td><td>  0.0097 </td><td>  0.0104 </td><td>  0.0106 </td><td>  0.0108 </td></tr><tr><td>  0.01 </td><td>  100,000 </td><td>  0.0095 </td><td>  0.0096 </td><td>  0.0098 </td><td>  0.0103 </td><td>  0.0104 </td><td>  0.0106 </td></tr><tr><td>  0.01 </td><td>  250,000 </td><td>  0.0097 </td><td>  0.0098 </td><td>  0.0099 </td><td>  0.0102 </td><td>  0.0103 </td><td>  0.0104 </td></tr><tr><td>  0.01 </td><td>  500,000 </td><td>  0.0098 </td><td>  0.0099 </td><td>  0.0099 </td><td>  0.0102 </td><td>  0.0102 </td><td>  0.0103 </td></tr><tr><td>  0.1 </td><td>  ten </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0.2 </td><td>  0.2 </td><td>  0.3 </td></tr><tr><td>  0.1 </td><td>  100 </td><td>  0.05 </td><td>  0.06 </td><td>  0.07 </td><td>  0.13 </td><td>  0.14 </td><td>  0.15 </td></tr><tr><td>  0.1 </td><td>  1000 </td><td>  0.086 </td><td>  0.0889 </td><td>  0.093 </td><td>  0.108 </td><td>  0.1121 </td><td>  0.117 </td></tr><tr><td>  0.1 </td><td>  10,000 </td><td>  0.0954 </td><td>  0.0963 </td><td>  0.0979 </td><td>  0.1028 </td><td>  0.1041 </td><td>  0.1055 </td></tr><tr><td>  0.1 </td><td>  50,000 </td><td>  0.098 </td><td>  0.0986 </td><td>  0.0992 </td><td>  0.1014 </td><td>  0.1019 </td><td>  0.1024 </td></tr><tr><td>  0.1 </td><td>  100,000 </td><td>  0.0987 </td><td>  0.099 </td><td>  0.0994 </td><td>  0.1011 </td><td>  0.1014 </td><td>  0.1018 </td></tr><tr><td>  0.1 </td><td>  250,000 </td><td>  0.0993 </td><td>  0.0995 </td><td>  0.0998 </td><td>  0.1008 </td><td>  0.1011 </td><td>  0.1013 </td></tr><tr><td>  0.1 </td><td>  500,000 </td><td>  0.0996 </td><td>  0.0998 </td><td>  0.1 </td><td>  0.1007 </td><td>  0.1009 </td><td>  0.101 </td></tr><tr><td>  0.5 </td><td>  ten </td><td>  0.2 </td><td>  0.3 </td><td>  0.4 </td><td>  0.6 </td><td>  0.7 </td><td>  0.8 </td></tr><tr><td>  0.5 </td><td>  100 </td><td>  0.42 </td><td>  0.44 </td><td>  0.46 </td><td>  0.54 </td><td>  0.56 </td><td>  0.58 </td></tr><tr><td>  0.5 </td><td>  1000 </td><td>  0.473 </td><td>  0.478 </td><td>  0.486 </td><td>  0.513 </td><td>  0.52 </td><td>  0.525 </td></tr><tr><td>  0.5 </td><td>  10,000 </td><td>  0.4922 </td><td>  0.4939 </td><td>  0.4959 </td><td>  0.5044 </td><td>  0.5061 </td><td>  0.5078 </td></tr><tr><td>  0.5 </td><td>  50,000 </td><td>  0.4962 </td><td>  0.4968 </td><td>  0.4978 </td><td>  0.5018 </td><td>  0.5028 </td><td>  0.5036 </td></tr><tr><td>  0.5 </td><td>  100,000 </td><td>  0.4974 </td><td>  0.4979 </td><td>  0.4986 </td><td>  0.5014 </td><td>  0.5021 </td><td>  0.5027 </td></tr><tr><td>  0.5 </td><td>  250,000 </td><td>  0.4984 </td><td>  0.4987 </td><td>  0.4992 </td><td>  0.5008 </td><td>  0.5013 </td><td>  0.5017 </td></tr><tr><td>  0.5 </td><td>  500,000 </td><td>  0.4988 </td><td>  0.4991 </td><td>  0.4994 </td><td>  0.5006 </td><td>  0.5009 </td><td>  0.5011 </td></tr></tbody></table></div><br><p>  Consider cases with 10% conversion and low 0.01% conversion, since  they are clearly visible all the features of working with sampling. </p><br><p>  At 10% conversion, the picture looks pretty simple: </p><br><p><img src="https://habrastorage.org/webt/qz/n-/k7/qzn-k7kgvtlilgfg1yqjfuj7vog.png"></p><br><p>  The points are the edges of the 5-95% confidence interval, i.e.  making a sample in 90% of cases we will receive CR on a sample within this interval.  The vertical scale is the sample size (logarithmic scale), the horizontal one is the value of the conversion rate.  The vertical bar is the "true" CR. </p><br><p>  Here we see the same thing that we saw from the theoretical model: accuracy increases as the sample size grows, while one fairly "converges" and the sample gets a result close to the "true" one.  A total of 1000 samples, we have 8.6% - 11.7%, which for a number of tasks will be enough.  And on 10 thousand already 9.5% - 10.55%. </p><br><p>  Things are worse with rare events and this is consistent with the theory: </p><br><p><img src="https://habrastorage.org/webt/bu/rt/cy/burtcyycddxkmqy4kmgyoirmboc.png"></p><br><p>  A low conversion rate of 0.01% has a problem with statistics of 1 million observations, and with samples the situation is even worse.  The error becomes simply gigantic.  In samples up to 10,000, the metric is not valid in principle.  For example, in a sample of 10 observations, my generator simply received 0 times a 1000 conversion, so there is only 1 point.  On 100 thousand we have a range from 0.005% to 0.0016%, that is, we can make a mistake by almost half the coefficient with this sampling. </p><br><p>  It is also worth noting that when you see conversion of such a small scale per 1 million tests, then you have just a big natural error.  From this it follows that conclusions on the dynamics of such rare events should be made on really large samples, otherwise you just chase ghosts, random fluctuations in the data. </p><br><p>  Findings: </p><br><ol><li>  Sampling working method to get estimates </li><li>  The accuracy of the samples increases with increasing sample size and decreases with a decrease in the conversion rate. </li><li>  The accuracy of the estimates can be modeled for your task and thus choose the best sampling for yourself. </li><li>  It is important to remember that rare events sample badly. </li><li>  In general, rare events are difficult to analyze, they require large data samples without samples. </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/458890/">https://habr.com/ru/post/458890/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458880/index.html">Linux development in Windows with WSL and Visual Studio Code Remote</a></li>
<li><a href="../458882/index.html">Public performance. Briefly about the main thing</a></li>
<li><a href="../458884/index.html">A little about the standards of space communications</a></li>
<li><a href="../458886/index.html">The most useful reports of Mail.ru Design Conf √ó Dribbble Meetup 2019 according to True Engineering</a></li>
<li><a href="../458888/index.html">Summer droid meetup</a></li>
<li><a href="../458892/index.html">Suggestions for vulnerabilities and protecting machine learning models</a></li>
<li><a href="../458894/index.html">Typical people and the networks in which they inhabit</a></li>
<li><a href="../458896/index.html">Functional JavaScript: What are higher order functions and why are they needed?</a></li>
<li><a href="../4589/index.html">Packaging zune</a></li>
<li><a href="../458900/index.html">Console cartridges as modems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>