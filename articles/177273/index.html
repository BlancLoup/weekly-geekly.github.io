<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Client with Linq support for Microsoft Dynamics CRM (alternative to client from sdk)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing one of the projects, I needed integration with MS CRM ... Looking at the standard query mechanisms in msdn, I realized that it was a b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Client with Linq support for Microsoft Dynamics CRM (alternative to client from sdk)</h1><div class="post__text post__text-html js-mediator-article">  When developing one of the projects, I needed integration with MS CRM ... Looking at the standard query mechanisms in msdn, I realized that it was a bit inconvenient, and since the project promises to be long and even endless (internal automation), I decided that using QueryExpression in a pure form will lead to a serious increase in labor costs and will become a breeding ground for careless mistakes (as the developers of the project will often change - whoever has the time will do it). <br><br>  So, it was decided to write a wrapper over QueryExpression and add the ability to build fluent queries like in EF.  Immediately I would like to say that when writing this wrapper (somewhere in the middle) I found a library from sdk which provides such an opportunity - <a href="http://rostacik.net/2011/08/11/how-to-read-create-update-and-detele-objects-in-microsoft-crm-2011-on-premise-via-wcf-service/">sdk crm client,</a> but after looking at it more closely I realized that there is no documentation (!!!) and several useful features, for example : use in in where, adding conditions to join and a few more smaller ones.  I will give a comparative table later. <br><br>  Since the project promises to be long, I still decided to finish my implementation ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h4>  Tasks: </h4><br><ul><li>  Make it possible to define DataContract for the necessary CRM entities, so that when changing / deleting / adding fields you need to take this into account only in one place. </li><li>  Provide the ability to write fluent requests to CRM to support strong typing, and to identify the maximum number of problems from deleting or changing the field type at the compilation stage </li><li>  Provide the ability to customize the result set received from CRM so that it is convenient to minimize traffic (Select, Join, Where, etc.) </li><li>  Provide security and role-based access to data in CRM (ASP.NET Impersonation in my case) </li></ul><br><h4>  What eventually happened: </h4><br>  The project is an assembly, with just one additional dependency - microsoft.xrm.sdk.dll, which is easy to connect to the project. <br><br><h5>  Customer </h5><br>  The assembly provides an abstract base class for creating a client - CrmClientBase.  This class has one abstract field that needs to be redefined: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> IWcfCrmClient WcfClient { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; }</code> </pre> <br>  IWcfCrmClient is an interface for interacting with a client reference added to a WCF project (Service Reference). <br><br>  How to create a client class is better to show with an example (In most cases, it is enough just to copy it into a project, correct using and everything should work): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> CrmClient; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Xrm.Sdk; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Xrm.Sdk.Query; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> MsCrmClientTest.MSCRM; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrgCrmClient</span></span> : <span class="hljs-title"><span class="hljs-title">CrmClientBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WcfCrmClient</span></span> : <span class="hljs-title"><span class="hljs-title">IWcfCrmClient</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> OrganizationServiceClient _client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Guid </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Entity entity</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _client.Create(entity); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Entity entity</span></span></span><span class="hljs-function">)</span></span> { _client.Update(entity); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> entityName, Guid id</span></span></span><span class="hljs-function">)</span></span> { _client.Delete(entityName, id); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> EntityCollection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RetrieveMultiple</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QueryBase query</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _client.RetrieveMultiple(query); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> OrganizationResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OrganizationRequest request</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _client.Execute(request); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Close</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _client.Close(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WcfCrmClient</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrganizationServiceClient(); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IWcfCrmClient _wcfClient; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> IWcfCrmClient WcfClient { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_wcfClient == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _wcfClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WcfCrmClient(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _wcfClient; } } }</code> </pre><br>  OrganizationServiceClient is a client from the Service Reference <br><br><h5>  Mapping </h5><br>  To work with CRM entities, you need to apply them to classes (define a data contract).  There are 2 attributes for this (standard attributes from the microsoft.xrm.sdk.dll assembly) <br><ul><li>  <b>EntityLogicalNameAttribute (string name)</b> - defines the name of the entity in CRM </li><li>  <b>AttributeLogicalNameAttribute (string name)</b> - defines the name of the entity field in CRM </li></ul><br>  If attributes are not specified, then the class name / property name is used as the name of the entity / field in CRM. <br><br>  Each data contract must be inherited from the base class CrmDataContractBase.  This is an abstract class with one abstract property. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> Guid Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre><br>  which you need to override and also mark the attribute AttributeLogicalName. <br>  Example data contract: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">EntityLogicalName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"systemuser"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span> : <span class="hljs-title"><span class="hljs-title">CrmDataContractBase</span></span> { [AttributeLogicalName(<span class="hljs-string"><span class="hljs-string">"systemuserid"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> Guid Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [AttributeLogicalName(<span class="hljs-string"><span class="hljs-string">"fullname"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [AttributeLogicalName(<span class="hljs-string"><span class="hljs-string">"parentsystemuserid"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EntityReference hief { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [AttributeLogicalName(<span class="hljs-string"><span class="hljs-string">"caltype"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> OptionSetValue CALType }</code> </pre><br>  <i><b>IMPORTANT!</b></i> <br><ul><li>  If the property is a link to another CRM entity (like hief in the example), it should be of type EntityReference </li><li>  If the property is a value from the CRM enumeration (as CALType in the example), it should be of type OptionSetValue </li></ul><br><h5>  CRM transfers mapping </h5><br>  To replace CRM enums, you need to define a class, inherit it from CrmOptionsSetBase and mark it with the EntityLogicalName attribute, in which you specify the name of the enumeration in CRM: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">EntityLogicalName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"connectionrole_category"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConnectionRoleCategoryEnum</span></span> : <span class="hljs-title"><span class="hljs-title">CrmOptionsSetBase</span></span> { }</code> </pre><br>  CrmOptionsSetBase implements an IEnumerable interface of type CrmOption, i.e.  they can immediately be used as a data source for controls. <br>  The CrmOption class contains 2 properties: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Label { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> OptionSetValue Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre><br>  The label contains the display name of the element, and Value is the same OptionSetValue used in the data contract CRM entities. <br><br><h4>  Customer use </h4><br><h5>  Add, edit, delete CRM entities </h5><br>  These are simple operations, everything should be clear from the example: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">EntityLogicalName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"new_nsi"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NSI</span></span> : <span class="hljs-title"><span class="hljs-title">ICrmDataContract</span></span> { [AttributeLogicalName(<span class="hljs-string"><span class="hljs-string">"new_nsiid"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> Guid Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [AttributeLogicalName(<span class="hljs-string"><span class="hljs-string">"new_name"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-comment"><span class="hljs-comment">// var newnsi = new NSI { Name = "Test NSI" }; _client.Add(newnsi); // 'Add'   'Id'   ,   EF // newnsi.Name = "Test NSI 2"; _client.Update(newnsi); // _client.Delete(newnsi);</span></span></code> </pre><br>  <i><b>IMPORTANT!</b></i>  All changes are applied to CRM right away.  No transaction (I haven't figured it out yet) <br><br><h5>  Getting CRM transfers </h5><br>  The client has a special method for receiving transfers. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T OptionsSet&lt;T&gt;()</code> </pre><br>  Where T is the data contract listing.  An example (data contarct is described above): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> optionSet = _client.OptionsSet&lt;ConnectionRoleCategoryEnum&gt;();</code> </pre><br><br><h4>  CRM queries using Linq </h4><br>  The namespace CrmClient.Linq defines the following extension methods for generating fluent requests to CRM: <br><ul><li>  Crmselect </li><li>  Crmwehere </li><li>  Crmjoin </li><li>  Crmorder </li><li>  Crmpaging </li><li>  Crmdistinct </li></ul><br>  The methods from this namespace begin with Crm, so that you can immediately see where a request to CRM is being formed and where work is being done with objects that have already been uploaded. <br>  Starting method of forming a query to CRM - Query: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ICrmQueryable&lt;T&gt; Query&lt;T&gt;()</code> </pre><br>  after it other methods of query formation can be used. <br>  The request itself to the CRM is executed.  when calling the GetEnumerator () method, that is, when trying to enumerate data (as in EF). <br><br><h5>  Select </h5><br>  Anonymous type <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = _client.Query&lt;CrmUser&gt;() .CrmSelect(u =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { u.Id, u.Name, Test = <span class="hljs-number"><span class="hljs-number">1</span></span> }) .ToList();</code> </pre><br>  Class (as in EF, a class must have a constructor without parameters) <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users2 = _client.Query&lt;CrmUser&gt;() .CrmSelect(u =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestUser() { Id = u.Id, FullName = u.Name, Test = <span class="hljs-number"><span class="hljs-number">1</span></span> }) .ToList();</code> </pre><br><h5>  Where </h5><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// var user = _client.Query&lt;CrmUser&gt;() .CrmWhere(i =&gt; i.Id == _directorUserId) .Single(); var list = new[] { _directorUserId }; // in var filteredUsers = _client.Query&lt;CrmUser&gt;() .CrmWhere(i =&gt; list.Contains(i.Id)) .ToList(); // not in filteredUsers = _client.Query&lt;CrmUser&gt;() .CrmWhere(i =&gt; !list.Contains(i.Id)) .ToList(); //like var users = _client.Query&lt;CrmUser&gt;().ToList(); var firstUser = users.First(i =&gt; i.Name.Contains(" ")).Name.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries); // like text% var user = _client.Query&lt;CrmUser&gt;() .CrmWhere(i =&gt; i.Name.StartsWith(firstUser[0])) .ToList(); // like %text user = _client.Query&lt;CrmUser&gt;() .CrmWhere(i =&gt; i.Name.EndsWith(firstUser[0])) .ToList(); // like %text% user = _client.Query&lt;CrmUser&gt;() .CrmWhere(i =&gt; i.Name.Contains(firstUser[0])) .ToList(); // not like text% user = _client.Query&lt;CrmUser&gt;() .CrmWhere(i =&gt; !i.Name.StartsWith(firstUser[0])) .ToList(); // not like %text user = _client.Query&lt;CrmUser&gt;() .CrmWhere(i =&gt; !i.Name.EndsWith(firstUser[0])) .ToList(); // not like %text% user = _client.Query&lt;CrmUser&gt;() .CrmWhere(i =&gt; !i.Name.Contains(firstUser[0])) .ToList();</span></span></code> </pre><br>  <i><b>IMPORTANT!</b></i>  For the 'in' construction, only an array needs to be passed.  I will remove this restriction later. <br><br>  There is also support for composite conditions (as in my extension for EF <a href="http://habrahabr.ru/post/152417/">The ‚ÄúWHERE‚Äù condition for composite keys in the Entity Framework</a> ): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = _client.Query&lt;CrmUser&gt;().ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> directors = users.Where(u =&gt; u.Director != <span class="hljs-literal"><span class="hljs-literal">null</span></span>).Select(u =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { u.Director.Id, u.Director.Name }).Take(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users2 = _client.Query&lt;CrmUser&gt;() .CrmWhere(ExpressionType.Or, directors, (u, d) =&gt; u.Id == d.Id &amp;&amp; u.Name == d.Name, (pn, o) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (pn) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"Id"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> o.Id; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> o.Name; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }) .ToList();</code> </pre><br><h5>  Order </h5><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = _client.Query&lt;CrmUser&gt;() .CrmOrderBy(i =&gt; i.Name) .CrmOrderByDescending(i =&gt; i.Id) .ToList();</code> </pre><br>  The result will be sorted by Name asc, then by Id desc <br><br><h5>  Distinct </h5><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = _client.Query&lt;CrmUser&gt;() .CrmDistinct() .ToList();</code> </pre><br><h5>  Join </h5><br>  With Join, things are a bit more complicated ... For example, you need to make users join their leaders: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = _client.Query&lt;CrmUser&gt;() .CrmJoin(_client.Query&lt;CrmUser&gt;(), s =&gt; s.Chief.Id, d =&gt; d.Id, (s, d) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { s.Id, s.Name, ChiefId = d.Id, ChiefFullName = d.Name }) .ToList(); or <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = _client.Query&lt;CrmUser&gt;() .CrmLeftJoin(_client.Query&lt;CrmUser&gt;(), s =&gt; s.Chief.Id, d =&gt; d.Id, (s, d) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { s.Id, s.Name, ChiefId = d.Id, ChiefFullName = d.Name }) .ToList();</code> </pre><br>  The request will execute correctly.  But if you take a closer look, the Id property of s.Chief is not buried anywhere, since this is the property of the EntityReference class ... But the s.Chief property itself is mapped onto the CRM 'parent systemuserid' we need ... The client resolves this situation by substituting the CRM request into the parent systemuserid 'from s.Chief, and the entry s =&gt; s.Chief.Id, d =&gt; d.Id is needed for type compatibility. <br><br>  Another problem is specifying the conditions for a join request.  In a CRM request, this condition is specified in the Link class itself, so in order to specify this condition, it must be specified in the join request itself: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = _client.Query&lt;CrmUser&gt;() .CrmJoin(_client.Query&lt;CrmUser&gt;().CrmWhere(u =&gt; u.Id == _directorUserId), s =&gt; s.Chief.Id, d =&gt; d.Id, (s, d) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { s.Id, s.Name, ChiefId = d.Id, ChiefFullName = d.Name }) .ToList(); or <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = _client.Query&lt;CrmUser&gt;() .CrmLeftJoin(_client.Query&lt;CrmUser&gt;().CrmWhere(u =&gt; u.Id == _directorUserId), s =&gt; s.Chief.Id, d =&gt; d.Id, (s, d) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { s.Id, s.Name, ChiefId = d.Id, ChiefFullName = d.Name }) .ToList();</code> </pre><br>  _client.Query (). CrmWhere (u =&gt; u.Id == _directorUserId) - this is the condition for the join.  Those.  if this is an inner join, then only users whose director is with id _directorUserId will return.  Here you can specify other conditions, for example Order, but this will have no effect, only the Where condition is taken into account. <br><br><h5>  Nolock </h5><br>  This method is needed so that requests on the CRM side are executed with the with option (nolock) useful for obtaining data for reporting over the past period.  Example: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = _client.Query&lt;CrmUser&gt;() .CrmNoLock() .ToList();</code> </pre><br><h5>  Paging </h5><br>  CRM query supports paginated output of results.  There is a method for paginated query <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CrmGetPage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pageNumber, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pageSize, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> totalCount, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> moreRecordsExists</span></span></span><span class="hljs-function">)</span></span></code> </pre><br><br>  It returns immediately to the List, which means that its call immediately executes a request to CRM. <br>  This method returns the total number of records, and a sign that there is still data to get on the CRM side.  Example: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> total; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> moreExists; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = _client.Query&lt;CrmUser&gt;().CrmGetPage(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> total, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> moreExists);</code> </pre><br><br>  <i><b>(All examples can be found in the test project)</b></i> <br><br><h4>  Customer features </h4><br>  The client uses reflection only to initially receive mapping data, and this data is cached in memory.  Because of this, the first request will be slow ... <br>  The code for instantiating classes is compiled dynamically, so that the time to get the result depends only on the execution time of the request on the CRM side and network delays.  Type creation code is compiled into memory - one assembly per type.  But there is one caveat: the <i>creation of anonymous types occurs through the constructor through reflection.</i>  <i>This is due to the fact that in different assemblies anonymous types have a different internal type and coercion is impossible</i> .  If anyone knows how to overcome this limitation, please write, I will correct it. <br><br><h4>  Comparison with client from SDK </h4><br>  In terms of speed, this client and the client from the SDK are almost the same (the difference is within the network delays when performing the test).  Due to the small amount of data on the test CRM, I did not find out whether the client from the SDK does everything on the CRM side or something already on the application side (for example, sorting ...), this is not understood from the test code, as it uses standard IQueryable and standard Linq extension methods. <br><br>  Sam comparative test is in the source.  The results of its implementation are as follows: <br><br><pre> <code class="cs hljs">Operation ThisCrmClient SdkCrmClient Query <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">25.6005598</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">01.1291123</span></span> Select <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.5173517</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.6273627</span></span> Order <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">08.2558255</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">08.2338233</span></span> Where <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04.1074107</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.9203920</span></span> WhereIn <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05.3745374</span></span> not supported %Like% <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.3983398</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.4093409</span></span> %Like <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.4403440</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.4163416</span></span> Like% <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.3093309</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.3033303</span></span> Join <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.4313431</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.4143414</span></span> JoinFilter <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03.3833383</span></span> not supported NoLock <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">09.6899689</span></span> not supported Distinct <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">07.9847984</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">08.0328032</span></span></code> </pre><br><br><h4>  Build and source </h4><br>  You can download the build and see the source codeplex - <a href="https://mscrmclient.codeplex.com/">mscrmclient</a> .  Solution consists of 3 projects: <br><ul><li>  <b>MsCrmClient</b> - the client itself </li><li>  <b>MsCrmClientTest</b> - tests for the client </li><li>  <b>PerfomanceTest</b> is a console application for comparing performance with client from SDK </li></ul><br><h4>  Instead of conclusion </h4><br>  On the codeplex I wrote the documentation in English, the Russian version of the documentation - this article. <br><br>  All the errors that I find in the process of using this client, I will immediately correct and upload the update to the codeplex.  If you decide to use this client in your projects, and find an error, create an issue on the project page.  I subscribed to receive notifications.  I will try to correct all errors as soon as possible (it is in my interest, if only because I also use this client in my projects). </div><p>Source: <a href="https://habr.com/ru/post/177273/">https://habr.com/ru/post/177273/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177259/index.html">HP Moonshot Server 1500</a></li>
<li><a href="../177263/index.html">Client VPN to VMware vCloud Director 5.1</a></li>
<li><a href="../177265/index.html">EMET v4 released in beta</a></li>
<li><a href="../177267/index.html">Cross-platform development on Adobe Air: a special case</a></li>
<li><a href="../177269/index.html">A new Adobe sharpen filter will be paid.</a></li>
<li><a href="../177277/index.html">App Annie Index: Mobile Application Market Report, Q1 '13</a></li>
<li><a href="../177279/index.html">Toshiba Satellite U920t Ultrabook Transformer Video Review</a></li>
<li><a href="../177283/index.html">Cisco UCS Manager. Management Interface Overview</a></li>
<li><a href="../177285/index.html">My way to freelancing</a></li>
<li><a href="../177289/index.html">The head of the Russian Post was dismissed!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>