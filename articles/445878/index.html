<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We get rid of duplicate packages in bundles</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are many webpack packages that find duplicates in the bundle, the most popular of them is duplicate-package-checker-webpack-plugin , but it requ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We get rid of duplicate packages in bundles</h1><div class="post__text post__text-html js-mediator-article"><p>  There are many webpack packages that find duplicates in the bundle, the most popular of them is <a href="https://www.npmjs.com/package/duplicate-package-checker-webpack-plugin">duplicate-package-checker-webpack-plugin</a> , but it requires rebuilding the project, and since the task was to automate the selection of the optimal version of the packages, it turned out to be an alternative solution. </p><br><p>  Well, or my story how to reduce the bundle by 15% in a few seconds. </p><br><p><img src="https://habrastorage.org/webt/1a/li/xr/1alixr4sfm2ufpvf1qeylqwqqzi.png" alt="pain"></p><a name="habracut"></a><br><p>  As in many large companies that have a huge code base, a lot of common logic, as a result we use common components published in your npm repository.  They are published via <a href="https://github.com/lerna/lerna">lerna</a> , respectively, before each installation or update of common components, the question arises as to which version to install.  lerna re-uses all components that use the published component (if the version was previously the latest).  Accordingly, there are always versions of several components that are better suited to each other, since they do not compete with dependencies. </p><br><p>  From open source projects in this way, publish <a href="https://github.com/plouc/nivo">nivo</a> , here is <a href="">their lerna config</a> . </p><br><p>  <strong>How then duplicate dependencies appear?</strong>  <strong>And how to eliminate them?</strong> </p><br><p> Suppose you have a simple project with the following <code>package.json</code> : </p><br><pre> <code class="plaintext hljs">{ "name": "demo-project", "version": "1.0.0", "dependencies": { "@nivo/bar": "0.54.0", "@nivo/core": "0.53.0", "@nivo/pie": "0.54.0", "@nivo/stream": "0.54.0" } }</code> </pre> <br><p>  Let's see where <code>@nivo/core</code> : </p><br><pre> <code class="plaintext hljs">npm list @nivo/core</code> </pre> <br><p><img src="https://habrastorage.org/webt/np/ga/f5/npgaf5b--_drxpqpvw1zos5cdso.png"></p><br><p>  We see 4 copies of <code>@nivo/core</code> (3 copies of <code>0.54.0</code> and 1 - <code>0.53.0</code> ).  But if we change the minor version of <code>@nivo/core</code> to <code>0.54.0</code> , the duplicates will be eliminated. </p><br><p><img src="https://habrastorage.org/webt/nj/v-/2y/njv-2yvwvis9qq3qgjz5dgqixjy.png"></p><br><p>  The current example is simple, but in practice, of course, each package has more dependencies, and the subdependencies still need to be considered further, which increases the complexity of the task. </p><br><p>  And once again, when I saw the huge size of the bundle, I was tired of manually removing duplicate packages. </p><br><p>  In general, it is right to immediately update the packages to the latest version, but there is no time, as always, to change the major versions, and it‚Äôs long and difficult to select the appropriate package for the blind one.  After all, you need to update the dependency version in <code>package.json</code> , install new dependencies, and then check whether duplicates in the build have disappeared, if not - repeat, for a long time, on average 3-4 minutes per iteration. </p><br><p>  All this is monotonous and requires care, so I decided to automate. </p><br><p>  I would like to find out duplicates without reinstalling dependencies, and rebuilding the project, ideally cli application outputting optimization options in 10 seconds and all existing duplicates in the project. </p><br><p>  <strong>Elimination of duplicates</strong> can be divided into several subtasks, we consider them in order. </p><br><p>  <strong>The first task.</strong>  It is necessary to simulate the future dependency tree of the bundle only by package.json, given the standard dedupe, quickly, in no more than 100ms. </p><br><p>  I decided to use <a href="https://www.npmjs.com/package/package-json">package-json</a> to get information on packages and <a href="https://www.npmjs.com/package/semver">semver</a> to compare different versions. </p><br><p>  As a result, the npm package <a href="https://github.com/itwillwork/dependencies-tree-builder">dependencies-tree-builder</a> was obtained, which quickly modeled the bundle dependency tree only by package.json. </p><br><p>  Allocated in a separate component, because maybe someone reuse it in combinatorial tasks with package.json. </p><br><p>  <strong>The second task.</strong>  A combinatorial problem, an effective search through dependency changes, and a comparison of several tree variants, and of course the choice of the optimal one. </p><br><p>  It was necessary to somehow compare the quality of the resulting trees, and we had to borrow the idea of ‚Äã‚Äãentropy, as a quantitative measure of disorder, took the sum of copies of duplicates (from the example above it is equal to 3). </p><br><p>  It would be great to take into account the weight of the packages (in KB), but unfortunately, I did not find a package that would quickly work with weights, and those that are there work about half a minute per package, for example <a href="https://www.npmjs.com/package/package-size">package-size</a> .  Since they work according to the following principle: they create a project with a single dependency, install dependencies, then the total weight of the folder is measured.  As a result, I did not invent another criterion, as the number of duplicate copies. </p><br><p>  To understand which package to change, the reasons for duplicates, the source and effect specifically are considered.  Brute force eliminates duplicate effects as much as possible, and since the effects are eliminated, duplicates are subsequently also. </p><br><p>  <strong>The result</strong> was a small cli ostap application that recommends optimal versions to reduce the number of duplicate copies in the bundle. </p><br><p>  It is started simply by pointing to the package.json of your project. </p><br><pre> <code class="plaintext hljs">ostap ./package.json</code> </pre> <br><p><img src="https://habrastorage.org/webt/kq/oc/4n/kqoc4nkk9dzeurzn5lkpc5q3ev0.png"></p><br><p>  You can also use it to quickly view all future duplicates without rebuilding the project by changing only the versions in package.json. </p><br><pre> <code class="plaintext hljs">ostap ./package.json -s</code> </pre> <br><p><img src="https://habrastorage.org/webt/ek/tx/rz/ektxrzk9owtl-xpm55x06sz6xvy.png"></p><br><p>  As a result, in my project, the total weight of bundles decreased by 15%. </p><br><p>  The <a href="https://github.com/itwillwork/ostap">repository</a> has a quick start section. </p><br><p>  If you use route-splitting, it may seem that some bundles have increased in weight, but the distribution of components may have changed.  That is, instead of copies of dependencies on each page, the only version went into a common bundle for all pages, so you need to estimate the total weight of bundles on all pages. </p><br><p>  Hope the article was helpful.  And someone will save information.  Thank. </p><br><p>  Once again, reference for convenience: </p><br><ul><li>  Package modeling tree of dependences of bundle by package.json <br>  <a href="https://github.com/itwillwork/dependencies-tree-builder">Github</a> ; </li><li>  Dependency Optimizer to eliminate duplicate bandl <br>  <a href="https://github.com/itwillwork/ostap">Github</a> </li></ul><br><p>  If you have interesting ideas, write in issue on github, we will discuss. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/445878/">https://habr.com/ru/post/445878/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445852/index.html">How to make a DAG trigger in Airflow using Experimental API</a></li>
<li><a href="../445854/index.html">Search JS framework for generating UI</a></li>
<li><a href="../445858/index.html">Antiquities: when phones were weird</a></li>
<li><a href="../445862/index.html">JS from all sides: the top 10 reports of HolyJS 2018 Moscow</a></li>
<li><a href="../445868/index.html">Termux Step by Step (Part 2)</a></li>
<li><a href="../445880/index.html">Interview in English: how to tell about yourself</a></li>
<li><a href="../445884/index.html">Moonlight mission "Bereshit" - eight milestones of success and $ 1 million from the "XPRIZE Foundation" (assuming a successful landing)</a></li>
<li><a href="../445886/index.html">"How to stop burning", or the problems of the incoming flow of information of modern man</a></li>
<li><a href="../445890/index.html">PyTest Neo</a></li>
<li><a href="../445892/index.html">Theory of large and small explosions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>