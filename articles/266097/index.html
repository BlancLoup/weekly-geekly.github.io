<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Script to calculate the space occupied by Hyper-V virtual machines</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I discovered a discrepancy in the data about the virtual disk space occupied by the virtual machines displayed in the System Center Virtual ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Script to calculate the space occupied by Hyper-V virtual machines</h1><div class="post__text post__text-html js-mediator-article">  Recently, I discovered a discrepancy in the data about the virtual disk space occupied by the virtual machines displayed in the System Center Virtual Machine Manager console with data obtained using <i>Get-SCVirtualMachine</i> and decided to find out what was wrong.  I obtained the data on disk space using the popular <i>Get-SCVirtualMachine cmdlet</i> .  To do this, I used a cycle in which I went through all the virtual machines and accumulated the size of their disks in a variable: <br><br><pre><code class="hljs mel">$totalhdd = <span class="hljs-number"><span class="hljs-number">0</span></span> $vms = Get-SCVirtualMachine #| where {$_.Name -eq <span class="hljs-string"><span class="hljs-string">"VM Name"</span></span>} #   foreach ($vm <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $vms) { $totalhdd += ($vm.VirtualHardDisks.Size -as [double]) / <span class="hljs-number"><span class="hljs-number">1</span></span>TB} }</code> </pre> <br>  Similar designs are replicated many times on the technet forums and in <a href="http://vniklas.djungeln.se/2012/02/13/vm-inventory-function-with-powershell-on-scvmm-2012/">all sorts of blogs</a> , so I had no doubts about their correctness. <a name="habracut"></a>  After detecting discrepancies, I added debug information to the loop: <i>$ vm.VirtualHardDisks.Size</i> for each VM and its name.  The output of the modified script showed that some VMs had a volume of 0. I was sure that <i>$ vm.VirtualHardDisks.Size</i> shows the sum, but this turned out to be wrong - the team returned two numbers (for two vhd).  Obviously, powershell was not able to divide the array into 1TB, and therefore gave 0: <br><br><pre> <code class="hljs tex">PS D:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Scripts</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IT</span></span></span></span>_git&gt; <span class="hljs-formula"><span class="hljs-formula">$vm.VirtualHardDisks.Size 3547332608 4194304 PS D:</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Scripts</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IT</span></span></span></span></span><span class="hljs-formula">_git&gt; ($</span></span>vm.VirtualHardDisks.Size -as [double]) / 1TB 0</code> </pre><br>  I do not even know in this case, to say thanks to the flexibility of the version for not being <i>ERROR</i> , or to say to him anti-thank you for such a disservice.  Forgives a lot of mistakes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then I decided to loop through all the disks and changed the original construction to a slightly more complicated, but also more correct: <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($vm in $vms) { $vhds = $vm.VirtualHardDisks <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($vhd in $vhds) { $totalhdd += ($vhd.Size -<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [double]) / <span class="hljs-number"><span class="hljs-number">1</span></span>TB} }</code> </pre><br>  Fine!  Now VMs with two or more virtual disks were counted correctly, BUT!  The amount of all the virtuals still did not match, although it was close to the readings of the console. <br>  I drove my script and so on.  I looked, aligned, and saw that for some VMs the amount coincides to a penny, and for some there is a significant discrepancy.  Climbed into the properties, and there ... snapshots!  We didn‚Äôt count them. <br>  Then again, Google, again questionable scripts, down to very exotic <a href="http://www.ivobeerens.nl/2013/09/17/list-hyper-v-snapshot-file-sizes-on-cluster-shared-volumes-with-powershell/">methods</a> with file search by mask. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  The method with the search <i>* avhdx</i> , at the same time, is fundamentally wrong, since the current data is written to avhd, and the snapshot is in vhdx.  However, I met him with <a href="http://blog.fedenko.info/2015/07/scvmm-powershel-checkpoints-size.html">other authors.</a> <br></div></div><br>  I had to write myself.  At first, I tried to select all disks using <i>Get-SCVirtualHardDisk</i> without going through virtual machines, but I managed to list only those disks that I received using <i>$ vm.VirtualHardDisks</i> .  So I had to dig a little deeper.  The virtual machine has a <i>VMCheckpoints</i> property, which lists all control points.  From this property, you can get, in fact, the <i>VMSnapshot</i> object (I did not understand how Snapshot differs from Checkpoint in terms of SCVMM).  This object also has the <i>VirtualDiskDrives</i> property, but for some reason it does not have the <i>Size</i> property, so we had to insert a crutch: from <i>VirtualDiskDrives</i> we take the <i>VirtualHardDiskID</i> property and with this ID we make <i>Get-SCVirtualHardDisk</i> : <br><br><pre> <code class="hljs mel">... # Snapshots search foreach ($vmc <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $vm.VMCheckpoints) { foreach ($vdd <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $vmc.VirtualDiskDrives) { $vhd = Get-SCVirtualHardDisk -ID $vdd.VirtualHardDiskID $snapshotshdd += ($vhd.Size -as [double]) / <span class="hljs-number"><span class="hljs-number">1</span></span>TB } } ...</code> </pre><br>  After that, a small discrepancy still remained, and a colleague prompted me to also calculate the service files <i>.bin</i> and <i>.vsv</i> , in which the service information is stored like memory dump.  Once again, looking through the list of available virtual machine options, I came across ... <b><i>$ vm.TotalSize</i></b> .  Who would have thought that all the work for me had already been done and you just need to sum up this parameter for all virtual machines! <br>  So, through thorns, crutches and rakes, I found a really beautiful solution: <br><br><pre> <code class="hljs mel">$totalsize = <span class="hljs-number"><span class="hljs-number">0</span></span> $vms = Get-SCVirtualMachine #| where {$_.Name -eq <span class="hljs-string"><span class="hljs-string">"VM Name"</span></span>} #   foreach ($vm <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $vms) { $totalsize += ($vm.TotalSize -as [double]) / <span class="hljs-number"><span class="hljs-number">1</span></span>TB }</code> </pre><br>  It was so funny that I decided not to delete snapshot data obtained from such a script from the script. <br>  Filled gallery.technet.microsoft.com/scriptcenter/Script-to-calculate-the-36a9314f here <a href="https://gallery.technet.microsoft.com/scriptcenter/Script-to-calculate-the-36a9314f">.</a> <br><div class="spoiler">  <b class="spoiler_title">Maths are joking</b> <div class="spoiler_text"><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/U-4af2_un3E%3Ffeature%3Doembed&amp;xid=17259,1500004,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgrdF4vRWR7Qyya7jPKODY7yzQDfA" frameborder="0" allowfullscreen=""></iframe><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/266097/">https://habr.com/ru/post/266097/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266087/index.html">Broadband Method (Class Library)</a></li>
<li><a href="../266089/index.html">Linux container developers meeting</a></li>
<li><a href="../266091/index.html">We integrate Paypal payment into web-application</a></li>
<li><a href="../266093/index.html">Healthcare IT: or how to exceed the budget by 420%</a></li>
<li><a href="../266095/index.html">How many downloads do you need for the TOP-10 free games of the App Store</a></li>
<li><a href="../266099/index.html">Intel invites to Droidcon. Moscow, September 25-27</a></li>
<li><a href="../266101/index.html">Color Deconvolution at Wolfram Mathematica</a></li>
<li><a href="../266103/index.html">Akka, actors and reactive programming</a></li>
<li><a href="../266105/index.html">Autumn Rambler.iOS Meeting</a></li>
<li><a href="../266107/index.html">3CX API - what are they and what to do with them? Third Party Plugins (Part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>