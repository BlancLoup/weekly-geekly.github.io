<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Computing Graphs, Speculative Locks and Arenas for Tasks at Intel¬Æ Threading Building Blocks (continued)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is a continuation of the translation of the article ‚ÄúFlow Graphs, Speculative Locks, and Task Arenas in Intel Threading Building Blocks‚Äù fro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Computing Graphs, Speculative Locks and Arenas for Tasks at Intel¬Æ Threading Building Blocks (continued)</h1><div class="post__text post__text-html js-mediator-article">  This post is a <a href="http://habrahabr.ru/company/intel/blog/228433/">continuation of the translation of the article</a> ‚ÄúFlow Graphs, Speculative Locks, and Task Arenas in Intel Threading Building Blocks‚Äù from Parallel Universe Magazine, Issue 18, 2014. In this half of the article we will look at speculative locks that take advantage of Intel technology Transactional Synchronization Extensions and user-managed arenas for tasks (user-managed tasks arenas) that provide enhanced control and management of the level of concurrency and task isolation.  If you are interested - welcome under cat. <br><a name="habracut"></a><br><h4>  Speculative Locks </h4><br>  Intel TBB 4.2 offers speculative locks: New synchronization classes based on Intel Transactional Synchronization Extensions (Intel TSX) technology. <br>  Speculative locks can allow critical sections protected by this lock to run simultaneously, making the assumption that data access and modification does not conflict with each other.  In practice, if a conflict occurs over the data, one or more speculative execution must be canceled without touching the protected data and, thus, without affecting other flows.  Then the threads involved in the data conflict repeat their critical sections and can take a real lock to protect the data (Intel TSX technology does not guarantee that the speculative execution will complete successfully, after all). <br>  In the implementation of speculative locks in the Intel TBB library [6, 7], all these steps occur unnoticed by the user, and the programmer can simply use the special mutex API.  Moreover, on a processor that does not support Intel TSX technology, the implementation will immediately use a regular lock.  Those.  developers can write portable programs that can take advantage of transactional synchronization. <br>  Now the Intel TBB library provides 2 classes of mutexes that support Intel TSX technology: <i>speculative_spin_mutex</i> and <i>speculative_spin_rw_mutex</i> ;  the latter was added as a ‚Äúpreview feature‚Äù in Intel TBB 4.2 Update 2. <br>  The <i>speculative_spin_mutex</i> class is very similar to the <i>spin_mutex</i> class;  and both are located in the same tbb / spin_mutex.h header file.  The main difference between <i>speculative_spin_mutex</i> , of course, besides Intel TSX support, is its size.  In order to avoid sharing the cache with other data, which with a high probability led to a conflict and loss of performance, the <i>speculative_spin_mutex</i> object instance occupies 2 cache lines. <br>  An example of using a speculative castle: <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;tbb/spin_mutex.h&gt; #include &lt;set&gt; tbb::speculative_spin_mutex tsx_mtx; std::set&lt;int&gt; g_Set; void thread_safe_add_to_set( int value ) { tbb::speculative_spin_mutex::scoped_lock lock(tsx_mtx); g_Set.insert(value); }</span></span></span></span></code> </pre> <br>  The <i>speculative_spin_rw_mutex</i> class, as you can guess from its name, implements a RW spinlock with a speculative execution.  Someone might have noticed that any speculative castle is not exclusive by definition, allowing not only to read at the same time, but also to write if there are no conflicts.  That is, ‚Äúspeculative RW-lock‚Äù may sound like a tautology.  However, it must be recalled that the flow can capture the lock "for real".  In this case, <i>speculative_spin_mutex</i> should provide exclusive access to the stream, no matter what the stream does ‚Äî read or modify data;  therefore, it is not a real RW-lock.  On the other hand, <i>speculative_spin_mutex</i> allows many data readers to run.  Moreover, ‚Äúreal‚Äù and speculative readers can be executed simultaneously.  But there are additional overheads: the internal data fields of the class must be stored on different cache lines, in order to avoid simultaneous access to the cache lines from several cores (false sharing).  Because of this, each instance of the class <i>speculative_spin_rw_mutex</i> occupies three cache lines. <br>  Although <i>speculative_spin_rw_mutex</i> is currently in the tbb / spin_rw_mutex.h header file, and even uses <i>spin_rw_mutex</i> as part of the implementation, these two classes are not fully compatible.  There are no <i>lock ()</i> or <i>unlock ()</i> methods in <i>speculative_spin_rw_mutex</i> .  It forces you to use the scope template, ie, it must be accessible through the class <i>speculative_spin_rw_mutex :: scoped_lock</i> .  Since this is a preview feature class, the TBB_PREVIEW_SPECULATIVE_SPIN_RW_MUTEX macro must be set to a non-zero value before including this header file. <br>  Unfortunately, the use and benefits of speculative locks is very dependent on the task.  Do not think that these new classes are ‚Äúimproved locks‚Äù.  Careful performance studies are needed in order to decide on a case-by-case basis that speculative locks are the right tool. <br><br><h4>  User-Managed Task Arenas User-Managed Task Arenas </h4><br>  Another significant part of the new functionality recently added to the library is managed arenas for tasks.  In our terminology, an arena is a place for streams, where they share tasks and take tasks for execution.  Initially, the library supported one global arena for the application.  Then we changed it, allowing it to support different arenas for each application flow, based on user feedback that the work launched to perform by various threads should be isolated from each other.  We then received requests so that concurrency control and job isolation were not associated with application threads.  To satisfy these requests, you have entered user-controlled arenas for tasks.  At the moment, this is still a class for preview (preview feature) and for use it requires setting the TBB_PREVIEW_TASK_ARENA macro to a non-zero value.  But we are working to make it fully supported later this year (2014). <br>  The API for user-managed arenas for tasks is implemented through the <i>task_arena</i> class.  When setting the <i>task_arena</i> class, the user can specify the desired parallelism and how much of this parallelism should be reserved for the application threads. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TBB_PREVIEW_TASK_ARENA 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;tbb/task_arena.h&gt; tbb::task_arena my_arena(4, 1);</span></span></span></span></code> </pre><br>  In this example, an arena is created for 4 threads and one place is reserved behind the application stream.  This means that up to 3 workflows managed by the Intel TBB library can join this arena and work on the tasks that are in this arena.  There is no limit on how many application threads can add work to this arena, but the overall parallelism will be limited to 4;  All the "extra" streams will not be able to join the arena and perform tasks there. <br>  In order to send the work to the arena, you must call the <i>execute ()</i> or <i>enqueue ()</i> methods: <br><pre> <code class="cpp hljs">my_arena.enqueue( a_job_functor ); my_arena.execute( a_job_functor2 );</code> </pre><br>  The work for any of these methods can be represented by lambda expressions from C ++ 11 or a functor.  These two methods differ in the method of sending work to the arena.  <i>task_arena :: enqueue ()</i> is an asynchronous call for sending work like ‚Äúfire-and-forget‚Äù (sent-and-forgotten);  the thread that called <i>task_arena :: enqueue ()</i> does not join the arena and immediately returns from this call.  <i>task_arena :: execute ()</i> , on the other hand, does not return until the submitted work is completed;  if possible, the thread that called <i>task_arena :: execute ()</i> joins the arena and performs its tasks.  If not, the thread is blocked until the task is completed. <br>  You can send many consecutive tasks to <i>task_arena</i> , but this is not what it was designed for.  Usually, a <i>task is</i> sent to <i>task_arena</i> that creates enough parallelism, for example, calling <i>parallel_for</i> : <br><pre> <code class="cpp hljs">my_arena.execute( [&amp;]{ tbb::parallel_for(<span class="hljs-number"><span class="hljs-number">0</span></span>,N,iteration_functor()); });</code> </pre><br>  or flow graph: <br><pre> <code class="cpp hljs">tbb::flow::graph g; ... <span class="hljs-comment"><span class="hljs-comment">// create the graph here my_arena.enqueue( [&amp;]{ ... // start graph computations }); ... // do something else my_arena.execute( [&amp;]{ g.wait_for_all(); }); // does not return until the flow graph finishes</span></span></code> </pre><br>  More information about the arenas for the tasks can be found in the Intel TBB Reference Manual. <br><br><h4>  Conclusion </h4><br>  The C ++ Template Library The Intel Threading Building Blocks offers a rich set of components to use efficient high-level, task-based concurrency development and the development of portable applications that can use the full power of multi-core architectures in the future.  The library allows application developers to focus on the parallelism of algorithms in an application without having to focus on low-level details on how to manage this parallelism.  In addition to highly efficient implementations of the most used high-level parallel algorithms and thread-safe containers, the library provides such low-level building blocks as a thread-safe scalable memory manager, locks, and atomic operations. <br>  Despite the fact that the Intel TBB library is already quite complete and recognized by the community, we continue to improve its performance and expand its functionality.  In the Intel TBB 4.0 version, we released a computational graph support in order to enable developers to more easily implement algorithms that are based on dependency graphs for data or execution.  In the release of Intel TBB 4.2, we supported the benefits of Intel Transactional Synchronization Extensions technology with new synchronization classes and responded to user requests for enhanced control and management of the level of parallelism and task isolation by introducing user-controlled task arenas. <br>  You can find the latest versions of Intel TBB and further information on our sites: <br><ul><li>  Official website <a href="http://software.intel.com/en-us/intel-tbb">software.intel.com/en-us/intel-tbb</a> </li><li>  Open source version <a href="http://threadingbuildingblocks.org/">threadingbuildingblocks.org</a> </li><li>  Documentation <a href="">software.intel.com/en-us/tbb_4.2_ug</a> </li><li>  Forum <a href="http://software.intel.com/en-us/forums/intel-threading-building-blocks">software.intel.com/en-us/forums/intel-threading-building-blocks</a> </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Bibliography</b> <div class="spoiler_text">  [1] Michael McCool, Arch Robison, James Reinders ‚ÄúStructured Parallel Programming‚Äù <a href="http://parallelbook.com/">parallelbook.com</a> <br>  [2] Vladimir Polin, ‚ÄúAndroid * Tutorial: Writing a Multithreaded Application using Intel Threading Building Blocks‚Äù.  <a href="http://software.intel.com/en-us/android/articles/android-tutorial-writing-a-multithreaded-application-using-intel-threading-building-blocks">software.intel.com/en-us/android/articles/android-tutorial-writing-a-multithreaded-application-using-intel-threading-building-blocks</a> <br>  [3] Vladimir Polin, ‚ÄúWindows * 8 Tutorial: Writing a Multithreaded Application for the Windows Store * using Intel Threading Building Blocks‚Äù.  <a href="http://software.intel.com/en-us/blogs/2013/01/14/windows-8-tutorial-writing-a-multithreaded-application-for-the-windows-store-using">software.intel.com/en-us/blogs/2013/01/14/windows-8-tutorial-writing-a-multithreaded-application-for-the-windows-store-using</a> <br>  [4] Michael J. Voss, ‚ÄúThe Intel Threading Building Blocks Flow Graph‚Äù, <br>  Dr.  Dobb's, October 2011, <a href="http://www.drdobbs.com/tools/the-intel-threading-building-blocks-flow/231900177">www.drdobbs.com/tools/the-intel-threading-building-blocks-flow/231900177</a> . <br>  [5] Aparna Chandramowlishwaran, Kathleen Knobe, and Richard Vuduc, ‚ÄúPerformance <br>  Evaluation of Concurrent Collections on High-Performance Multicore Computing Systems ‚Äù, <br>  2010 Symposium on Parallel &amp; Distributed Processing (IPDPS), April 2010. <br>  [6] Christopher Huson, ‚ÄúTransactional memory support: the speculative_spin_mutex‚Äù.  <a href="http://software.intel.com/en-us/blogs/2013/10/07/transactional-memory-support-the-speculative-spin-mutex">software.intel.com/en-us/blogs/2013/10/07/transactional-memory-support-the-speculative-spin-mutex</a> <br>  [7] Christopher Huson, ‚ÄúTransactional Memory Support: the speculative_spin_rw_mutex‚Äù.  <a href="http://software.intel.com/en-us/blogs/2014/03/07/transactional-memory-support-the-speculative-spin-rw-mutex-community-preview">software.intel.com/en-us/blogs/2014/03/07/transactional-memory-support-the-speculative-spin-rw-mutex-community-preview</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/228469/">https://habr.com/ru/post/228469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228455/index.html">Some benchmark performance of network frameworks</a></li>
<li><a href="../228457/index.html">Universal web GUI for arbitrary RESTful services</a></li>
<li><a href="../228461/index.html">Vkontakte launched unpromising mobile gaming platform?</a></li>
<li><a href="../228463/index.html">Digest photo news # 6: the best materials of the end of June</a></li>
<li><a href="../228465/index.html">Through the eyes of Moscow subscribers. Rating of mobile operators for the 2nd quarter in dynamics</a></li>
<li><a href="../228477/index.html">Cluster analysis (for example, consumer segmentation) Part 1</a></li>
<li><a href="../228479/index.html">Musical programmable school bell "Schoolboy-4"</a></li>
<li><a href="../228481/index.html">Dyn-DNS Services: Microsoft blocks ‚Äúgood‚Äù and ‚Äúbad‚Äù users</a></li>
<li><a href="../228483/index.html">The line of "smart" watches Samsung Gear Live will be released on the platform Android Wear</a></li>
<li><a href="../228485/index.html">Rust 0.11.0 released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>