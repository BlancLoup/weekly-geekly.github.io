<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expand linux working image with minimal interactivity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This publication may be of interest to those lazy system administrators who use any of the following: 


- Linux - based system on client machines; 
-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expand linux working image with minimal interactivity</h1><div class="post__text post__text-html js-mediator-article">  This publication may be of interest to those <s>lazy</s> system administrators who use any of the following: <br><ul><li>  Linux - based system on client machines; </li><li>  Thin / fat clients of the same type on different hardware; </li><li>  Network storage of client data; </li><li>  The preset regulated software; </li><li>  Openvpn / rdp to application servers. </li><li>  Plush (soft and fluffy) monitoring of linux clients like Nagios. </li></ul><br>  It will be about how to install a ready system with a set of software, customized network services, predefined configs, etc. with minimal effort from the user or the staff enikeyschik.  The article focuses primarily on enthusiasts and beginners linuksoidov, but the techniques and scripts may well be used in the combat deployment of a group of dozens of machines daily. <br><a name="habracut"></a><br>  For a start we will decide on the distribution kit.  This, of course, depends primarily on the tasks.  I chose xubuntu 14.04 for three simple reasons: <br><br>  1. ubuntu - deb based system with the broadest support and a huge number of forums; <br>  2. xubuntu - a lightweight version without ruches and ponts, which does not slow down on machines from 512MB of RAM (there are such dinosaurs in my park); <br>  3. April 14 is the LTS (Long Term Support) version with support until 2019. <br><br>  There are, of course, faster and smaller options, but for a number of reasons, the choice was made and does not cause regrets over the course of a year. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Looking ahead, I‚Äôll note: to repeat this, you will need a configured vpn server or a ‚Äúconfig-monitoring server‚Äù in the local network, a pair of virtual or real machines, a couple of hours of free time and attention to detail. <br><br>  So, first, the preparation of the image.  All stages are important, but the first is the foundation.  Install the system from the cd / dvd / usb / network and select the disk partitioning.  It is important to understand that our image will not support dynamic resizing prior to deployment.  And after, most likely such a resize is not required.  At the root it makes sense to give 6-10 GB. <br><br>  Most of the volume is justified in the case when it is known that a) the disks on the client machines will not be less than this volume and b) many different necessary packages will actually be installed. <br><br>  Mark / home and finally swap partitions.  In the aggregate, all three sections of the author do not crawl out for 30GB (in order to comfortably fit on ssd 30 Gb, this is the minimum disk configuration for my clients).  In case the minimum disk size of the receiver is known in advance, it makes sense to fit partitions for it.  I recommend to mark the swap right after the disk root, / home immediately after the swap, so that in case of a resize, do not ‚Äúdrag them across the disk in the console‚Äù, but make it elegantly with one command.  Set the locale, username, password, hostname and go to the new Linux.  To continue, you will need x11vnc, ssh, rsync, openvpn, mc packages (I love mcedit, it's my darling, like Norton from the nineties). <br><br><pre><code class="bash hljs">sudo apt-get install x11vnc ssh rsync openvpn mc ntp</code> </pre> <br>  I added skype, icedove (thunderbird), iceweasel (firefox), chromium-browser, rdesktop calculator, resource monitor, viber, libre office, wine and a couple of windows-based applications to my base to my taste (of course, I‚Äôm burning in hell , but there are no analogues and is not expected).  We adjust slowly and slowly the whole thing.  We check that everything starts and works. <br><br>  Configure vpn.  I have a distributed network, two or three computers per geolocation, more than 50 locations in Russia, you are not hitting.  We create an ssh-key to the server and on the server to the client (who needs to enter these passwords, details, for example, <a href="http://habrahabr.ru/post/39116/">here</a> ).  On the server, we create a directory of unconditional synchronization (for me these are working scripts, openvpn keys, client cron, service scripts in python, C ++ binaries).  In the working example, this is / var / sync / in, / var / sync / in / cron, / var / sync / out.  In the out there will be logs and any information we need from clients: screenshots, process reports, etc.  In there will be synchronization scripts, cron jobs, heartbeat scripts for monitoring, numerous system service configs (same cups or openvpn). <br><br>  Preparing this whole thing for replication <s>does not</s> take <s>much</s> longer than installing the system to a single user, but careful study of the details can significantly reduce the time that the admin will spend on scripts ‚Äúdopilivayuschie‚Äù all images in battle in the future.  <a href="http://habrahabr.ru/post/233971/">Configure openvpn on the client</a> and make sure that the user key [and] work [by it] t.  Not be superfluous and configure grub2. <br><br><ul><li>  Hint1: It‚Äôs good when the hostname, ip in openvpn and user certificate contain their unique id, for example user10.key, xyz10 and vladivostok_10 as the hostname; </li><li>  Hint2: Well, when copies of these files are at hand, say / var / sync / hostname, / var / sync / id, / var / sync / location; </li><li>  Hint3: Reserve 5-10 addresses for unregistered users will also be useful. </li></ul><br>  We will not intentionally create files from Hint2, by their absence it will be clear when the "new ones" connect to our vpn. <br><br>  So, everything is rustling, the office is running, the calculator is running, for rdp with the application server there is already a tab on the desktop. <br><br>  It's time to make an image. <br><br>  Allow myself to be distracted.  I tried a lot of ways to make an image with a finished system.  This article does not claim to be the best way, I can only say that the method is the best for me and <u>I will</u> comment <u>very briefly</u> on other methods and their disadvantages. <br><br>  Clonezilla is a great thing, but interactively enters into a stupor any enikeyschik for three hundred miles from the admin. <br>  dd if = / dev / sda of = img.img is a magic thing, but together with the data we get garbage from an empty part of the disk, the volume and speed of the method are terrifying. <br><br>  Norton ghost - does not support ext4. <br><br>  Partition copy from gparted is a cool thing, but, alas, also not for beginners. <br><br>  I have been asking myself for a long time how I see the perfect deployment.  Here we come to the topic of the article, from which the order has already been distracted. <br><br><ul><li>  The image should fit on a small (in my case 2GB) flash drive; </li><li>  The image must be placed by pressing one or two buttons; </li><li>  After deployment, the image itself must be synchronized and ‚Äúreport‚Äù to the admin that the new machine is ‚Äúin service‚Äù; </li><li>  Registering a new car should not take a lot of time; </li><li>  (Important!) The image will most likely be written to a USB flash drive from under windows by a non-professional according to the instructions; </li><li>  (ArchiveImportant!) The image is likely to develop versionally, and it needs to be periodically completed and quickly distributed. </li></ul><br>  It was necessary to invent a small bicycle, or rather, to write an unfolding script.  For the above tasks, the PartedMagic distribution was chosen.  Unetbootin + partedmagic or any live-cd (usb) with linux and tar + b [g] zip on board will be required to wrap the image.  We assume that the image we downloaded PartedMagic ‚Äúrun from ram‚Äù and the flash drive is mounted in / media / sdb1 (FAT32). <br><br><div class="spoiler">  <b class="spoiler_title">A couple of reminders about fat / ntfs on flash drives</b> <div class="spoiler_text"><ul><li>  Achtung1 I remind you that the file section in fat32 should not be more than 4GB, watch the size of the image or select the ext4 partition. </li><li>  Akhtung2 NTFS partition of the flash drive under linux though works, but takes a huge amount of CPU time. </li></ul><br></div></div><br>  After booting we mount our disk (most likely / dev / sda1) and click all our system directly from it, and we don‚Äôt forget about the / home partition: <br><br><pre> <code class="bash hljs"> mount /dev/sda1 /media/sda1</code> </pre> <br>  Then we will create an archive with all the contents of our disk: <br><br><pre> <code class="bash hljs">tar -czvpf /media/sdb1/image.tgz /media/sda1</code> </pre> <br>  Same for the / home section: <br><br><pre> <code class="bash hljs">mount /dev/sda5 /media/sda5 tar -czvpf /media/sdb1/home.tgz /media/sda5</code> </pre> <br>  Then dump the partition table into a file on our superflashka: <br><br><pre> <code class="bash hljs">sfdisk /dev/sda1 -d &gt;parts.txt</code> </pre> <br><br>  Thus, on a flash drive, we will have archives and a file with a table of sections of the reference image. <br><br>  Well, for dessert.  Below is a script with a talking name that was assembled in parts from different parts of the Internet literally along the line. <br><br>  Comments of the author directly in the text of the script.  Nothing supernatural, just like in a computer science class, but debugged with bloody tears, even once killed a home system with a flash drive with this script.  I do not recommend leaving it as it is.  This is his unconditional non-interactive version. <br><br>  <i>cat /pmagic/pmodules/scripts/kill_your_hdd_data.sh</i> (path for autoloading script in PartedMagic) <br><pre> <code class="bash hljs">!<span class="hljs-comment"><span class="hljs-comment">#/bin/bash # ,    ,     ,  " " . #      //    PartedMagic     . #        / , .. home       #   ,         (, ) #        ,          #2014 (c) Urban Software LLC under GPLv3 urbansoftware.ru, usrbb.ru dd if=/dev/zero of=/dev/sda bs=512 count=1 #         sleep 1s sfdisk /dev/sda &lt; /media/sdb1/parts.txt #           sleep 1s mkfs.ext4 -L "" /dev/sda1 -F #    sleep 1s mkdir /media/sda1 fsck.ext4 /dev/sda1 #         (    home) sleep 5s mount /dev/sda1 /media/sda1 #mount /dev/sdb1 /media/sdb1 sleep 1s mkdir /media/sda1/tmp tar -xzvpf /media/sdb1/image.tgz -C / #   sleep 5s echo "This script damn work!" #   ,    mount --bind /dev /media/sda1/dev mount --bind /sys /media/sda1/sys mount --bind /proc /media/sda1/proc chroot /media/sda1/ /bin/bash -c 'grub-install /dev/sda' #      chroot /media/sda1/ /bin/bash -c 'update-grub2' sleep 5s umount /dev/sda1 umount /dev/sdb1 echo 'done, remove media, system will reboot in 30s' sleep 30s reboot exit 0</span></span></code> </pre><br><br><h6>  Instead of an epilogue: </h6><br>  This method is used in Urban Software to fill information touch kiosks with web applications running under linux.  Most often, these are keyboardless machines that are deployed dozens far from the <s>civilization of</s> our technical support, so it is important not to create problems initially when monitoring them and putting them to work. <br><br>  PS The article turned out great.  The second part will be written about how to ‚Äúmeet‚Äù newly deployed computers, manage a remote cron, synchronize scripts and receive monitoring heartbits, if, of course, the first one ever comes out of the sandbox. </div><p>Source: <a href="https://habr.com/ru/post/253193/">https://habr.com/ru/post/253193/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253179/index.html">Weekly io.js, March 13, 2015</a></li>
<li><a href="../253181/index.html">How to build an application on android in 15 minutes</a></li>
<li><a href="../253183/index.html">Rex Black at SQA Days-17: ‚ÄúDo not chase after empty fantasies, but focus on gaining experience‚Äù</a></li>
<li><a href="../253189/index.html">MIDI player on eight floppy. Or how the electronics engineer went crazy</a></li>
<li><a href="../253191/index.html">How to facilitate hosting clients to create private networks and virtual servers: 1cloud project experience</a></li>
<li><a href="../253199/index.html">QIWI terminals. Alternative way</a></li>
<li><a href="../253201/index.html">Unloading the conditions of public procurement contests with the EP. Zakupki.gov.ru</a></li>
<li><a href="../253207/index.html">Simple PHP complex HTML table generator</a></li>
<li><a href="../253209/index.html">Bash Booster - SCM tool on a clean bash</a></li>
<li><a href="../253211/index.html">Why I don‚Äôt dislike Git: hidden integrity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>