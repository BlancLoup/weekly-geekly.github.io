<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TorrentLocker - a new modification of the FileCoder cryptographer, part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last part of our study on the TorrentLocker cipher, we described the general mechanisms of its operation, and also considered possible scenario...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TorrentLocker - a new modification of the FileCoder cryptographer, part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/company/eset/blog/246945/">last part of</a> our study on the TorrentLocker cipher, we described the general mechanisms of its operation, and also considered possible scenarios for its distribution.  The second part is devoted to the analysis of this malware, its work with a remote C &amp; C server, as well as statistics on infections in various countries. <br><br><img src="https://habrastorage.org/files/e83/017/3f7/e830173f758a48d2b64d2383eaa45883.jpeg"><br><br><a name="habracut"></a>  Before the payload is executed directly, TorrentLocker injects its code (injection) into other processes.  This process is carried out in two stages.  At the first stage, the dropper starts a special process - the loader.  The loader decrypts the auxiliary code, which is then embedded in the explorer.exe process.  TorrentLocker remotely creates a stream in explorer.exe, with the exported <i>__remote_entry</i> function <i>being the</i> starting function. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/632/359/aed/632359aed9294b208b6b4ecc82bb2ccf.png"><br><br>  We observed several different versions of the dropper, but this analysis is devoted to one of these versions, which has a compilation date of October 15, 2014 (SHA-1 hash of this sample begins with 40B1D84B). <br><br>  Dropper contains several well-known tricks to complicate the analysis of the executable file.  One such trick is to use dynamic exports.  It also uses an anti-debugging technique, which is to reuse the <i>OutputDebugString</i> API function.  When calling <i>OutputDebugString</i> from the context of a process to which the debugger is not connected, it does not perform any useful functions.  However, if a debugger is connected to the process, it sends it a string for output.  The dropper code calls this function 320,500 times, which causes the debugger to hang.  This method also allows a malicious program to bypass the sandbox mechanism (sandbox), which runs the program in debug mode. <br><br><img src="https://habrastorage.org/files/4f9/660/a12/4f9660a122b7445ca396111e932201c2.png"><br>  Fig.  The dropper code calls the <i>OutputDebugString</i> function 320,500 times. <br><br>  The dropper packer uses two executable PE file resources to extract the payload.  The first resource contains a 16-bit key at the beginning of its data.  This key is used to decrypt the rest of the data for this resource.  This part contains the key that will be used to decrypt the second resource.  The second resource is the packer configuration.  The configuration can set the behavior of the packer itself, for example, set for it the use of detection techniques of virtual machines through the use of <i>in</i> and <i>vpcext instructions</i> .  Both instructions are used to detect VMWare and VirtualPC. <br><br>  The above resources are encrypted using a modified version of the RC4 algorithm.  The decryption process contains an error, since one of the variables, which must be initialized to zero, remains intact.  A similar error in the code of the decryptor is contained in one of the versions of the malicious software MiniDuke, which was <a href="https://www.f-secure.com/documents/996508/1030745/cosmicduke_whitepaper.pdf">described</a> by F-Secure experts. <br><br>  The data of the second section after proper decryption is a PE file.  At the same time, the dropper creates a new process in a suspended state (suspended), allocates a region of memory in this new process, and writes the contents of this PE file to this region.  Then the process resumes its work from the entry point in the copied PE file.  We call this process the launcher. <br><br>  The TorrentLocker component, called the bootloader, is quite simple.  It performs two functions: it copies the dropper file to another directory and launches another component of the malicious program called ‚Äúcore‚Äù.  The core component is located in the body of the malware in compressed and encrypted form.  The loader unpacks it using the aPlib library and injects its code into the system processes explorer.exe and svchost.exe.  If the loader does not have enough privileges to perform this operation (administrator), he will request these privileges and restart his executable file. <br><br>  TorrentLocker stores some configuration information in the system.  To do this, use the registry key.  Newer versions of the malware can also store configuration data within a directory with an arbitrary name within the System <i>Data Application</i> system directories or the <i>Programs</i> directory in <i>All Users</i> .  Files located there are encrypted using the AES-256-CBC algorithm.  The decryption key is hard-wired in the body of the executable file of the malicious program and differs depending on the campaign used by attackers.  Dropper also contains a code to generate an AES key.  It is formed based on the date of the OS installation on the computer.  However, this code is not used by the malware itself, it may be reserved for future use. <br><br><img src="https://habrastorage.org/files/df4/8d3/f12/df48d3f123044471aa7f97d370d18ed0.png"><br><br>  TorrentLocker specializes in collecting information used by the user mail client.  It can steal authentication data for the victim's SMTP server and address book.  Various email clients are supported, including Thunderbird, Outlook, Outlook Express, Windows Mail. <br><br><img src="https://habrastorage.org/files/b82/75a/139/b8275a1392304c0094b5ed8127f6abc0.png"><br>  Fig.  TorrentLocker uses the Protected Storage API to get mail client configuration. <br><br><img src="https://habrastorage.org/files/fb1/c81/d69/fb1c81d693774c13aa1fea1a841953c9.png"><br>  Fig.  The part of the TorrentLocker code that is responsible for parsing the address book of the Thunderbird email client. <br><br>  Given the fact that attackers use e-mail as the main vector for delivering malware, stealing information such as a list of contacts can make it much easier to distribute TorrentLocker.  They can also use stolen SMTP information to use a legitimate server to send phishing messages. <br><br>  The TorrentLocker malware interacts with the C &amp; C server manager using a URL that is hard-coded into the dropper body.  It can use various modifications of its network protocol to work with C &amp; C and the modification described below was used in samples that were distributed by attackers from October to December 2014. If the C &amp; C server is unavailable at the URL specified in the body of the malicious program Generation Algorithm (DGA) for obtaining an auxiliary list of 30 new domains.  The DGA engine for getting new C &amp; C addresses was added to the TorrentLocker samples that were discovered in October 2014. <br><br>  In fact, TorrentLocker uses a fairly simple protocol to interact with the C &amp; C server.  However, as mentioned in the previous paragraph, it can vary depending on the version of the malware.  To work with C &amp; C, the SSL protocol is used, which uses encryption for the transmitted traffic.  Some modifications instead of using SSL to encrypt so-called.  chain XOR algorithm.  Each HTTPS POST request to a C &amp; C server by a malicious program has the following format. <br><br><img src="https://habrastorage.org/files/44a/5af/645/44a5af6451e54a2e904e1c54fc585457.png"><br><br><img src="https://habrastorage.org/files/8a6/b56/b2d/8a6b56b2dfe2446dad19568a9fe3e80f.png"><br>  Fig.  An example of a message that a malicious program sends to a C &amp; C server. <br><br><img src="https://habrastorage.org/files/641/c30/310/641c30310d364b399ba2710acc777356.png"><br>  Fig.  Correspondence to the fields of the request with the data from the message, which is given above. <br><br>  When a TorrentLocker on an infected computer contacts its C &amp; C server, a special ‚Äúuser ID‚Äù or ‚Äúuser code‚Äù is generated.  This ID is then used to identify the victim and, based on this, the C &amp; C server sends the TorrentLocker a URL link to the ransom payment page and the file decryption tool.  This URL has the following form. <br><br><img src="https://habrastorage.org/files/d5a/7d2/89a/d5a7d289a73d4d5a9467b705dc72a1c0.png"><br><br>  For easier access to the .onion domain, the ransom request web page contains links to websites with access through <a href="">Tor2Web</a> .  Using this mechanism allows the victim to access the ransom payment web page even from a browser that does not support Tor. <br><br>  The user ID mentioned above is a string of six randomly selected characters.  However, if two malware infections occur at the same time, the IDs of the infected systems may be similar.  Further analysis of this algorithm showed that the code for generating identifiers is predictable.  As an example, consider three identifiers selected by the C &amp; C server. <br><br><img src="https://habrastorage.org/files/61c/400/c27/61c400c2736f479cbf7942ca324c1db2.png"><br><br>  For the identifier, a thirty-six-hex base is used (base 36).  After converting to the decimal system (base 10), the identifier appears as a usual combination of numbers from zero to ten.  If you separate the last five digits, you get two series.  At the same time it is clear that increment operations are applied to the older series, when decrementing is applied to the younger series.  It can be seen that if you add two numbers according to this scheme, then the total will always be 99999. This allows you to verify the correctness of the identifier by the malicious program operator.  Knowing the identifier generation algorithm, we were able to get all possible web pages from the remote server with a ransom requirement.  What has this been done for various C &amp; C servers. <br><br>  In September 2014, Nixu security <a href="http://digital-forensics.sans.org/blog/2014/09/09/torrentlocker-unlocked">reseller</a> published a post describing various tricks that allowed to decrypt files encrypted by TorrentLocker.  A special GUI <a href="http://www.bleepingcomputer.com/forums/t/547708/torrentlocker-ransomware-cracked-and-decrypter-has-been-made/">tool</a> was also released that allowed the decryption operation to be performed automatically.  Such a situation with ‚Äúunauthorized‚Äù decryption has become possible due to the AES-256 algorithm used by the malware in the Counter Mode encryption mode (CTR).  In this case, the same key was used for all files, as well as the initialization vector (IV), which made the algorithm vulnerable.  Newer versions of TorrentLocker use AES in CBC encryption mode (Cipher Block Chaining), which excludes the possible decryption of files.  To work with this cryptographic algorithm, the malware code uses the <a href="http/www.libtom.org/">LibTomCrypt</a> library. <br><br>  The only AES-256 key for file encryption is generated when the dropper is executed.  It is used to encrypt all files in the system.  In this case, the key generation procedure itself uses the pseudo-random number generator Yarrow and the following Windows API functions (the values ‚Äã‚Äãreturned by them). <br><br><ol><li>  <i>Gettickcount</i> </li><li>  <i>GetCurrentProcessId</i> </li><li>  <i>GetCurrentThreadId</i> </li><li>  <i>GetDesktopWindow</i> </li><li>  <i>Get foregroundwindow</i> </li><li>  <i>GetShellWindow</i> </li><li>  <i>Getcapture</i> </li><li>  <i>GetClipboardOwner</i> </li><li>  <i>GetOpenClipboardOwner</i> </li><li>  <i>Getfocus</i> </li><li>  <i>GetActiveWindow</i> </li><li>  <i>GetKBCodePage</i> </li><li>  <i>Getprocessheap</i> </li><li>  <i>GetThreadTimes (GetCurrentThread ())</i> </li><li>  <i>GetProcessTimes (GetCurrentProcess ())</i> </li></ol><br>  Before directly encrypting files, the AES key is encrypted with the RSA public key, which is located in the malware file.  It is then sent to the remote C &amp; C server with the request type set to one. <br><br>  To avoid performance overhead, TorrentLocker encrypts only the first 2MB files.  Obviously, even in the case of large files, such a length is enough to make the file completely inoperative or unusable.  The malware adds three special fields to the end of each encrypted file, the format of which is indicated below. <br><br><img src="https://habrastorage.org/files/3cf/255/6fc/3cf2556fc87e43ce9b683ef07b6728e9.png"><br><br>  The Adler-32 checksum, which is listed in the table, may be used to verify the AES key and the fact that the file itself is TorrentLocker encrypted.  This way of storing an AES key in an encrypted file allows TorrentLocker operators or another RSA private key holder to easily decrypt the contents of the file without accessing other sources.  It can also be used to restore the AES key in case the C &amp; C server is unavailable. <br><br>  <b>Similarities TorrentLocker and Hesperbot</b> <br><br>  The Hesperbot banking trojan was <a href="http://habrahabr.ru/company/eset/blog/192684/">discovered by</a> ESET analysts in 2013 and is a sophisticated malicious tool used by cybercriminals to steal money from online banking accounts of users in different countries around the world.  He used the embedding of his malicious HTML and JavaScript code in the web pages of the launched browser.  We found similarities between TorrentLocker and Hesperbot.  It seems that the authorship of the code of both malicious programs belongs to one criminal group, which also deals with campaigns for their distribution.  Spam campaigns to spread both Trojans are aimed at the same countries, for example, Turkey, the Czech Republic, and Australia. <br><br>  The web pages that were used to distribute Hesperbot in early 2014 were very similar to those that were used for distribution in the case of TorrentLocker.  In March of this year, one of the security writers, Zoltan Balazs, published information on the Hesperbot distribution web pages, which contained the CAPTCHA mechanism.  This is very similar to the TorrentLocker distribution method.  The URL pattern, in some cases, ended in <i>.php? Id = [digits]</i> . <br><br><img src="https://habrastorage.org/files/053/009/4ed/0530094ed53f4e509c5ba2587edb2eae.png"><br>  Fig.  Compare URLs that were used to distribute malware. <br><br>  It is worth noting that the IP addresses of the C &amp; C servers of both malicious programs also coincide.  Hesperbot used as a remote C &amp; C server a domain updatesecurehost1.ru with IP address 46.149.111.178.  The same IP address was used by the TorrentLocker sample in September 2014. The domain was nigerianpride.net. <br><br>  In both families of malware, their earlier versions contained the string path to the PDB file.  In order to see this path, the sample must be unpacked.  For Hesperbot (procblock module), the path to pdb looked like. <br><br><img src="https://habrastorage.org/files/d11/717/294/d11717294d3249eb9339f49c432cc5d2.png"><br><br>  In August 2014, the TorrentLocker sample, which contained a very similar path (rack-core module), came into our hands. <br><br><img src="https://habrastorage.org/files/dc4/60b/f6a/dc460bf6a9464dac8715eeaec4f222fa.png"><br><br>  Another sample contained the path to the rack-dropper module. <br><br><img src="https://habrastorage.org/files/67c/166/7f0/67c1667f0af34ca590065bb02ce8614c.png"><br><br>  The identity of the directory hierarchy in the paths may indicate that the executable files were compiled by one group of persons or on one computer. <br><br>  <b>Statistics</b> <br><br>  Above, we described the mechanism for generating user IDs, which was used by the authors of a malicious program to identify computers infected with TorrentLocker.  Using these identifiers, we were able to extract information about the victims from a remote C &amp; C server.  This experiment was conducted on November 24, 2014. Below is a list of remote C &amp; C servers that were used to extract the referenced information. <br><br><img src="https://habrastorage.org/files/460/f10/c57/460f10c57a4c4e91981c4fd9dad64ba5.png"><br><br>  We received 47.365 redemption web pages from five different C &amp; C servers.  Of this number, 39,670 web pages represented the real users, whose IDs were generated by the infected system.  Other identifiers were removed from the database by operators, because they were already outdated or were not at all the result of successful infection of the user with a malware (they could have been created by malware researchers).  Of the mentioned number of real victims, 570 users paid the ransom to the attackers and received a link to the file decryption software.  Also, 20 web pages indicate that the amount of the ransom was not fully received. <br><br><img src="https://habrastorage.org/files/24a/7b0/98d/24a7b098d18c42e08bf18fad04d21db1.png"><br>  Fig.  Statistics buyout payment TorrentLocker. <br><br>  The ransom payment web pages are translated to the appropriate language for the region.  A total of 13 different countries are supported.  Below is a statistic that clearly demonstrates the number of TorrentLocker infections in different countries. <br><br><img src="https://habrastorage.org/files/415/3f4/75e/4153f475e6b64606ba0ca67e7b767c82.png"><br>  Fig.  Statistics of infections by country. <br><br>  <b>Conclusion</b> <br><br>  Cybercriminals have been distributing TorrentLocker since at least February 2014. They managed to collect a large number of bitcoins from their victims.  Users were ready to lay out their money to restore access to their files.  The use of cryptocurrency Bitcoins makes intruders virtually invulnerable to law enforcement agencies who can not set the destination address during the payment. <br><br>  The authors of TorrentLocker switched to using the CBC mode of the AES symmetric encryption algorithm, instead of the previously used CTR.  Thus, they nullified the possibility of "unauthorized" decryption of files.  Decryption is possible only in the case of obtaining the RSA private key from intruders, with which you can decrypt the AES key.  This encrypted public RSA key AES key is stored at the end of the encrypted file and is used to directly decrypt the file (or its first 2 MB).  As we described above, the public RSA key is located in the body of the malware. <br><br>  As a basic protective measure against the effects of TorrentLocker infection and file encryption, you should use backup files on your hard drive.  It should be remembered that TorrentLocker specializes in encrypting files located on network drives that are connected to an infected computer.  In this case, files with backup data are best stored on a remote device that is not connected to the computer, otherwise, they may also be compromised by TorrentLocker. <br><br><img src="https://habrastorage.org/files/13a/325/e19/13a325e1925b4dd79036cc519c45dd20.png"><br>  Fig.  The types of files that TorrentLocker encrypts. </div><p>Source: <a href="https://habr.com/ru/post/247031/">https://habr.com/ru/post/247031/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247021/index.html">For those who failed to write plans</a></li>
<li><a href="../247023/index.html">Calculate CLV in the online store</a></li>
<li><a href="../247025/index.html">GDG DevFest Voronezh 2014: photo report and impressions</a></li>
<li><a href="../247027/index.html">Path of the Lark 2: At the End of the Rainbow</a></li>
<li><a href="../247029/index.html">jQuery for mobile devices, all the pros and cons</a></li>
<li><a href="../247033/index.html">Hacker's guide to neural networks. Chapter 2: Machine Learning. More traditional approach: Loss functions</a></li>
<li><a href="../247039/index.html">How Iceland becomes a data center paradise</a></li>
<li><a href="../247041/index.html">VNC Roulette. Srsly?</a></li>
<li><a href="../247045/index.html">Plotter based on the Makeblock constructor</a></li>
<li><a href="../247047/index.html">C #: Internal structure of array initializers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>