<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recover Apache Derby without backup</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For my own pleasure, a robot for Wikipedia is spinning on my personal computer ( account1 , account2 , source code ). The bot keeps a local cache of W...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recover Apache Derby without backup</h1><div class="post__text post__text-html js-mediator-article">  For my own pleasure, a robot for Wikipedia is spinning on my personal computer ( <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D1%2587%25D0%25B0%25D1%2581%25D1%2582%25D0%25BD%25D0%25B8%25D0%25BA:Secretary">account1</a> , <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D1%2587%25D0%25B0%25D1%2581%25D1%2582%25D0%25BD%25D0%25B8%25D0%25BA:WebCite_Archiver">account2</a> , <a href="https://github.com/vlsergey/Secretary/">source code</a> ).  The bot keeps a local cache of Wikipedia versions ‚Äî in order not to go to the remote server each time, as well as a set of specific data that has been collected for the last couple of years and is very important for the bot to work.  The data is collected into a database running Apache Derby, and, along with the cache, the database takes about 50 GB. <br><br>  And so, one fine day, when the bot processed the data in 8 threads on 4 CPUs, Abbyy Finereader recognized the 14th volume of the Russian biographical dictionary edited by A. A. Polovtsev, and the opponents made their move in Civilization Age of Kings ... he appeared - the blue screen of death.  Long time no see, I thought, restarting the computer.  Okay, with a reason - most likely problems with a video adapter on hardware.  It was only when the computer was booted up and I tried to start the bot again, this appeared: <br><blockquote>  ERROR XSDG2: Invalid checksum on Page </blockquote><br>  And the last backup, as usual, is dated March ... <br><a name="habracut"></a><br>  Having spent half an hour-hour to investigate the problem (read - Google search), I found out that: <br><ul><li>  Utilities for data recovery is not.  None  Use backups - this is the official only way. </li><li>  There are suggested patches that allow you to bypass the checksum for a specific page.  For example, <a href="https://issues.apache.org/jira/browse/DERBY-1648">DERBY-1648</a> </li><li>  Finally, there is a way to just ignore data recovery.  Yes, your eyes do not deceive you - it is recovery.  The fact is that after an abnormal termination, Apache Derby reads the transaction log and, like any self-respecting ACID-compatible DBMS, tries to roll back the incomplete transactions.  That just does not go with her - so she swears. </li></ul><br>  How to do the last?  Just remove the logs!  However, as <a href="http://www-01.ibm.com/support/docview.wss%3Fuid%3Dswg21261294">IBM warns us</a> (the Cloudscape developer is what became Derby later): <br><br><blockquote>  Never delete or manipulate * ANY * files in a database directory structure.  Doing so will corrupt the database. </blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, what did I do on the night from Saturday to Sunday? <br><ol><li>  I made sure that there is more space on the hard disk than 3 times the current base size. </li><li>  I made a backup of the broken database.  Better late than never. </li><li>  After offering the prayer to the Flying Spaghetti Monster, deleted all the files from the logs folder (the folder itself must be left - it won't load without it). </li><li>  I went through the SQuirreL SQL Client to the database and made sure that it works. </li></ol><br>  But this, of course, not all.  It should be understood that deleting transaction logs, especially with recovery errors in the database, cannot lead to anything good.  Such a base will work, but not for long - until the first oncoming jamb in the structure.  It is necessary to somehow force the database to dig through all the data in all the tables, it is desirable to overwrite them into new files line by line (in the Derby terminology, new conglomerates). <br><br>  The <a href="http://db.apache.org/derby/docs/10.1/adminguide/cadminhubbkup98797.html">mechanism</a> built into Apache Derby <a href="http://db.apache.org/derby/docs/10.1/adminguide/cadminhubbkup98797.html">backup-restore</a> does not help us - it stupidly copies data files without checking their structure in any way.  However, the delivery includes an interesting utility called <a href="http://db.apache.org/derby/papers/DerbyTut/ij_intro.html">ij</a> .  Besides the fact that it gives console access to the database, it also allows you to call functions that are not available when accessing the database from other applications.  We need two such functions from the <a href="http://db.apache.org/derby/docs/10.8/adminguide/cadminimport16245.html">Export &amp; Import</a> kit: <br><ul><li>  SYSCS_UTIL.SYSCS_EXPORT_QUERY_LOBS_TO_EXTFILE </li><li>  SYSCS_UTIL.SYSCS_IMPORT_TABLE_LOBS_FROM_EXTFILE </li></ul><br>  These functions do export (and import) data into a standard text format.  The additional prefix LOBS_FROM_EXTFILE indicates that binary and simply large text fields will be saved in a separate file.  This is convenient if you want to see the correctness data at least at the edge of the eye. <br><br>  Therefore, the next step was to launch ij ... <br> <code>java -cp "derby.jar;derbytools.jar" -Dij.maximumDisplayWidth=120 org.apache.derby.tools.ij</code> <br>  connect to the database (don't forget the semicolon at the end of the ij command) <br> <code>ij&gt;connect secretarydb;</code> <br>  export of all application data (separate commands for each table) <br> <code>ij&gt;CALL SYSCS_UTIL.SYSCS_EXPORT_TABLE_LOBS_TO_EXTFILE(null,'TABLENAME','c:\data\TABLENAME.del',null,null,'UTF-8', 'c:\data\TABLENAME.dat');</code> <br>  By the way, the ‚ÄúSHOW TABLES‚Äù command in ij <a href="http://db.apache.org/derby/docs/10.9/tools/rtoolsijcomrefshow.html">is</a> . <br><br>  After the export is complete, you can take your favorite text editor, which would support the appropriate data sizes, and check the readability of at least the beginning and end of the file.  Extra lines can be removed from the .del file, if something turns out to be wrong ... well, don‚Äôt deny yourself anything - this is the moment when you can edit the balance on the account of a couple of subscribers. <br><br>  After completion, remove the database.  If anything, we have a backup.  Then it was enough for me to run the bot again, and, made on hibernate, he restored the table structure at startup.  After that, immediately stop the application and run ij to import data: <br> <code>java -cp "derby.jar;derbytools.jar" -Dij.maximumDisplayWidth=120 org.apache.derby.tools.ij</code> <br> <code>ij&gt;connect secretarydb;</code> <br> <code>ij&gt;CALL SYSCS_UTIL.SYSCS_IMPORT_TABLE_LOBS_TO_EXTFILE(null,'TABLENAME','c:\data\TABLENAME.del',null,null,'UTF-8', 1);</code> <br>  The one at the end indicates that the data in the table needs to be overwritten if something is already there.  You do not need to specify the name of the file with LOB data - there are links to it in the main file. <br><br>  That's all.  Data restored.  But, of course, the next function that will be in the bot is automatic archiving of the most important data at each launch. </div><p>Source: <a href="https://habr.com/ru/post/188238/">https://habr.com/ru/post/188238/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188224/index.html">Visual overview of optical transmitters</a></li>
<li><a href="../188226/index.html">New sensory material for measuring strain, humidity, temperature, pressure ... and then what?</a></li>
<li><a href="../188230/index.html">SOINN - self-learning algorithm for robots</a></li>
<li><a href="../188232/index.html">New kind of mozilla vlc plugin</a></li>
<li><a href="../188236/index.html">SIM-cards of passengers of the Moscow metro will be subjected to contactless reading</a></li>
<li><a href="../188240/index.html">AWS: Cloudwatch + SNS</a></li>
<li><a href="../188242/index.html">Search through sphinx in django 1.6 admin</a></li>
<li><a href="../188244/index.html">Hidden Markov chains, Bauma-Welch algorithm</a></li>
<li><a href="../188246/index.html">Sample Exam at the Faculty of Computer Science at TU Dresden</a></li>
<li><a href="../188248/index.html">Editing Configs in Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>