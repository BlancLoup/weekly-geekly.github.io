<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Metrix has you ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For many developers, the process of releasing their product is like throwing a blind kitten into the mouth of wild dogs. After this, the main task of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The Metrix has you ...</h1><div class="post__text post__text-html js-mediator-article"><p>  For many developers, the process of releasing their product is like throwing a blind kitten into the mouth of wild dogs.  After this, the main task of the authors is to fight off the bugs that have accidentally reached them.  In fact, the application does not end its life journey in the teeth of users, but only starts it.  And he needs the help of developers no less than during the formation and testing. </p><br><p>  In this article, we will look at how to observe the work of the product and its combat environment, learn how to collect vital metrics and present them in a digestible form.  We learn what Time Series is and how they can help our and third-party applications in the diagnostic process.  We will get acquainted in detail with the market leaders for monitoring tools, the specialized InfluxDB repository and the Grafana data visualization system. </p><br><p>  The prototype of the article is the <a href="http://2017.dotnext-moscow.ru/2017/msk/talks/2wij6mss4oea0mqi2g0ewk/">report of Anatoly Kulakov</a> on DotNext 2017 Moscow.  Anatoly was educated as an information security specialist, then earned as a harsh C ++ developer for Linux.  When I got tired of coding and wanted to create, I switched to C #.  Writes to .NET from its first versions.  Engaged in the design and construction of business applications, distributed and fault-tolerant systems.  Resting with ES, CQRS and DDD. </p><br><p>  <a href="http://assets.ctfassets.net/9n3x4rtjlya6/54Kgic0iRaacIYm00Uyq6o/fef98abb5cfc5747cc3808ed6c1b594b/Anatoly_Kulakov_Metrix.pdf">Before viewing, you can download slides in PDF format.</a> </p><br><blockquote>  Caution traffic!  In this post there is a huge number of pictures - slides and screenshots from a video in 720p format.  On the slides there is an important code for understanding the article. </blockquote><br><iframe width="560" height="315" src="https://www.youtube.com/embed/AFB89L8DLpE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><p>  Let's talk about metrics.  Why precisely about them?  The fact is that in my practice I came across a lot of projects, and I was always outraged by the situation that most of the teams do not even think about what is happening in their production now.  They just released a product, and, in their opinion, it flies.  In reality, this is not at all the case; the server can be choked by the influx of users, disks can fail, anything can happen.  And, in most cases, nobody suspects and does not know about it. </p><br><p>  Unfortunately, this is how our culture of developers has developed, which for us the main point is the process of writing code.  But this is just a small part of the living product, so this trend is changing with time, and I am very pleased.  We already know such terrible abusive words like CI and DI; they no longer cause a shiver in the knees.  We are used to the fact that version control systems, task management, the planning and testing process are an integral part of a modern project. </p><br><p>  The next big step in this direction is going beyond the perimeter of your cozy team and applying good on the territory of the direct user.  And this is a very interesting process, because almost always users do not behave with our programs as we had planned, and usually our programs are not prepared for the insanity of ideas that these geniuses of thought are capable of.  Therefore, after we began to observe the real use of our products, we definitely discovered a large, interesting and fascinating world full of madness and unpredictability.  It turned out that all our optimizations were not used due to random nonsense, the main load falls on the service we were counting on, malicious administrators artificially limit resources for our application, load balancer distributes requests unevenly, etc.  A huge number of unpredictable situations gives us life. </p><br><p>  Most of them are deposited in the hot psyche of tired users.  The rest are recorded in vague bugs describing the result, which makes it completely impossible to understand the reasons for what happened.  It is much better from all sides to have constant monitoring of important services in real time and understand what they are doing now. </p><br><p>  Monitoring can not only tell you about the problems and pressures, it is also an excellent platform for analytics and predictions.  This is what we are going to do.  We will understand how and by what means you can realize absolutely any of your voyeuristic fantasies. </p><br><p> I am sure that when I described the essence of the problem, many thought about logging.  Indeed, you can remotely collect logs, analyze them and draw conclusions, but what is there going on in this production of yours?  And it is not far from the truth.  In fact, these are related tools that solve similar problems.  If you are interested in listening to the introduction on the correct modern logging, I recommend paying attention to the " <a href="https://www.youtube.com/watch%3Fv%3Dwy9YbBqhHqQ">Structured logging</a> " report. </p><br><p>  But in this article we will focus on metrics.  What is the difference between metrics and logging?  So, the main content of the logs is any information about the world, business process, expectations and errors.  If you know how to prepare them correctly, then you can easily make analytics on their content.  But there is a huge reservoir of tasks in which the flexibility and power of logging are redundant, and even more - they are harmful. </p><br><img src="https://habrastorage.org/webt/tk/bt/py/tkbtpyj-zn2eq8tbx0vxkfr3crk.png"><br><p>  For example, you want to constantly monitor the CPU usage.  Of course, you can write this information every second to the logs, and then analyze it.  But here we are faced with a number of problems, the main of which is the amount of data and the speed of their processing.  The number of counters for which we want to observe easily begins with dozens (processor, memory, GC, requests, responses).  And in large projects effortlessly reaches hundreds. </p><br><img src="https://habrastorage.org/webt/tl/o6/dk/tlo6dkhtipaytvyyzdkd69a8hei.png"><br><p>  Imagine that you have two hundred hosts, and they take a hundred metrics every ten seconds.  Provided that we have 86,400 seconds per day, we will receive 172,800,000 values ‚Äã‚Äãin our logs daily. </p><br><p>  Just imagine what your logs will turn into if every second you merge thousands of metrics into them with low-level, faceless, uninteresting information.  Firstly, human readability and consistency of narration, rather than a mountain of infrastructural noise, are expected from the logs.  But this problem is easily solved with the help of semantic filters.  But the amount of information that is now obliged to process tools created for other purposes is already a problem.  Performance problems will be at all levels: in processing, transfer, storage, analytics.  And this is pure ordinariness, there are a lot of other areas with disproportionately large appetites, such as nuclear power plants, factories, or, for example, the Internet of things, where, according to bearded analysts, by 2020 there will be six devices for each person, which will need to be constantly monitored. </p><br><img src="https://habrastorage.org/webt/br/im/cs/brimcs5ro9lgcfw36yyzuctrwxi.png"><br><p>  And if we are talking about absolute volume, then the size of the data necessary for working with metrics is much higher than the size of regular logs.  All this suggests that it is impossible to use the same solutions for logs and metrics.  Therefore, humanity has isolated from the logs such a thing as metrics.  And it divided the work with this data into two independent parts, with its own tools, algorithms and approaches.  And, as the trend of the last 2 years shows, the decision was absolutely correct. </p><br><p>  If you have ever heard of the growing popularity of graph or document-oriented databases, all this is childish babbling compared to the hyip that occurs around databases for metrics.  Metrics are described by time series (Time Series).  A time series is a sequence of some values ‚Äã‚Äãtaken from one source at a certain time interval.  Those.  these are the results of periodic measurements of something in time.  For example, this graph represents the results of periodic measurements of the popularity of databases, grouped by storage model: </p><br><img src="https://habrastorage.org/webt/tj/mh/cn/tjmhcnvwpqfjcgzq1zwtvntb2rm.png"><br><p>  A typical indicator that this graph relates to the Time Series is the presence of a time axis.  If it is, then almost always the schedule is TS.  To confirm, let's look at other examples: </p><br><img src="https://habrastorage.org/webt/eh/sz/z-/ehszz-0lzbjcdo42bbqyun1jwcs.png"><br><p>  Another typical example is Yandex.Metrica, which shows your site traffic. </p><br><p>  Let's take a closer look at what time series consist of using the example of a network interface: </p><br><img src="https://habrastorage.org/webt/nk/2s/wh/nk2swhfkk70_z2njupentfozon0.png"><br><ol><li>  First of all, it is, of course, the time at which values ‚Äã‚Äãare read. <br></li><li>  The values ‚Äã‚Äãthemselves.  There may be several values, in this case, the number of incoming / outgoing packets. <br></li><li>  It is also very useful to add meta-information to your meaning, describing the context in which the action took place.  For this there are tags.  You can assign anything to them, for example, the name of the host or the network interface on which we did the measurement. <br></li></ol><br><p>  If we draw an analogy with relational databases, then the totality of all these three parameters can be represented in the form of the ‚ÄúNetwork‚Äù table. </p><br><img src="https://habrastorage.org/webt/he/2m/p6/he2mp66d2ibjotpb6s4zt0y0dpe.png"><br><p>  In this case, time will always be its main key, clustered index.  Tags will be indexed columns, aggregates are very well built on them and filters are made.  The values ‚Äã‚Äãthemselves are non-indexed columns. </p><br><p>  But, unlike public databases, TSDBs have unique information ‚Äî they know about the nature of this data, which allows them to do incredible optimizations.  That is why public databases will always be far, far behind.  For example, between the authors of Time Series bases there is an interesting metric, with the help of which they are measured against each other in the size of their own superiority: the average size necessary to store one record.  Let's estimate right away: </p><br><img src="https://habrastorage.org/webt/qt/wq/cy/qtwqcyi7un4bvrn5hcnvptraudq.png"><br><p>  Date and time are usually stored in nanoseconds, occupy eight bytes.  Tags can easily pass over 20 bytes, and a data field, say double (the most common type for values ‚Äã‚Äãthat are stored in TSDB), takes eight bytes.  Well, if you store it so ingenuously, then one record will occupy about 40 bytes.  What do you think, what figures do the leaders brag about?  Two bytes. </p><br><img src="https://habrastorage.org/webt/cj/nz/ik/cjnzikvvjgpb86by1a_f79scvmg.png"><br><p>  Only two bytes to pack all our values.  And this is not the limit, the best fight in the region of one byte.  How is this even possible?  How, knowing the specifics of the origin of the data, can you put all this in two bytes? </p><br><p>  The first thing that comes to mind is the use of standard compression algorithms.  This is usually a bad idea, because they were created for completely different amounts of information, and they require much more context for their work than we can afford.  Well, they work 30-40 times slower. </p><br><p>  We will go another way.  Let's start with the tags.  Their size in a constant data stream can be reduced to zero.  How is this done?  We simply multiply the name of the metric with all the keys and values ‚Äã‚Äãof the tags and get several storage slots (in example two): </p><br><img src="https://habrastorage.org/webt/4c/gv/9b/4cgv9bffhdsphterj3vp6bzm9zo.png"><br><p>  Thus, we transfer tags from the data area to the schema area.  That is why tag values ‚Äã‚Äãshould not be represented by random numbers, but should fit into the final dictionary.  This part of the time series is called the ‚ÄúSeries‚Äù.  The series itself does not store any data, it is constant in time, which allows you to simply neglect its size.  In this way, our tags collapse to zero. </p><br><p>  If the series does not take place, then it is occupied by a timestamp and value.  Let's start with the time.  All compression algorithms that work on Time Series are based on the same principle as column databases.  They work with one column, with a continuous stream of the same type data.  Time is usually stored with nanoseconds accuracy.  In 8 bytes.  Delta-of-delta compression can be used to compress a column over time.  This is an algorithm that relies on the fact that the data from the counters are usually removed periodically at regular intervals.  For example, every 5 seconds.  We can calculate the delta between these times and find the interval.  Having a start time and interval, we can predict the next value in the column. </p><br><img src="https://habrastorage.org/webt/89/q_/ec/89q_ecaop06crzxy0kjeko3obsa.png"><br><p>  Usually the interval does not change, so we can calculate once again the delta above the value of the first delta.  And usually it turns out zero.  For storing such a special, frequently occurring value, one bit is enough (we have zero in the second delta or not zero). </p><br><img src="https://habrastorage.org/webt/mv/n2/5y/mvn25yaqeephn16b7qjikagxrey.png"><br><p>  Do not think that these are too big assumptions and in the real world there is no such thing.  According to Facebook, they were able to pack 96% of their time in this one zero bit.  Naturally, there are algorithms for eliminating small rattling of time, passes, etc. </p><br><img src="https://habrastorage.org/webt/5r/-s/iz/5r-sizhjc5brsryzouhnsndndh0.png"><br><p>  The values ‚Äã‚Äãof the counters can be of any type.  But in practice, these are almost always floating point numbers.  It is on them that the main magic is aimed at reducing the size of the fields. <br>  Values ‚Äã‚Äãcan be scattered unpredictably, so the previous trick with a double delta will not work here.  Another technique is based on the knowledge that all values ‚Äã‚Äãcome from the same source, and therefore have the same accuracy and similar dimension.  In practice, this means that their binary representation will be very similar.  Those.  if we trivialize the neighboring values, we get a very small number of significant characters: </p><br><img src="https://habrastorage.org/webt/lc/gb/ea/lcgbeac2agjpbmatcrncmtrqroc.png"><br><p>  It can be saved using far fewer bits than the original value.  And next to him keep the number of zeros from the smallest side.  But in practice it is still more fun.  According to Facebook statistics, 51% of all values ‚Äã‚Äãare the same as the previous one, i.e.  their XOR will give zero. </p><br><img src="https://habrastorage.org/webt/pg/0h/fs/pg0hfs4uvzfiwkes-n6plo5i_ti.png"><br><p>  And as you probably guessed, one bit is enough to store this special case.  And that's not all, XOR in this example is only the most trivial predictor.  There are other predictors that dynamically adjust to your current data and thus are able to predict values ‚Äã‚Äãwith a very high probability, which as a result allows even very nontrivial vibrations to be packed into 1 bit. <br>  Accordingly, if the data will arrive at the same interval and never change, we can pack it in two bits.  Of course, this does not happen in the real world, and in practice the data changes, which causes Facebook to spend 1.37 bytes per value.  And this is only with the help of those primitive algorithms that we have just considered. </p><br><p>  These are quite interesting algorithms, you can talk about them for hours, but let's go back from heaven to earth and look at our application and its environment. </p><br><img src="https://habrastorage.org/webt/ez/qc/-0/ezqc-0ono6ojnaogpaidnrmdjvc.png"><br><ul><li>  For our application, first of all, the metrics that make it work are important.  That is, hardware, operating system.  The source of these metrics are Performance Counters.  In them you will find a lot of useful information, ranging from CPU, disk space, memory, and ending with higher-level platforms such as: .NET, Garbage Collector, JIT, IIS, SignalR, and so on. <br><br><img src="https://habrastorage.org/webt/kz/cw/bd/kzcwbd2oaecds8gdfxp5nmruzdk.png"><br><br></li><li>  There are usually third-party components with which we interact.  And all normal third-party players must have a statistics API that we can subtract: Seq, MongoDB, MS SQL - all these products have an API with which you can come, query their status and see, for example, how they feel now . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/dd/wf/y3/ddwfy3kil80txpyaa6wzoo11sjw.png"><br><br></li><li>  Also, let's not forget about our beloved ETWs, there are also many interesting things there, if suddenly you didn‚Äôt find what you were looking for in the first paragraphs, contact them. <br></li><li>  And the most important, highest-level metrics that we have are, of course, the metrics of our own application, your business domain.  What size the document opens the user, how many users logged in, the average time of a business transaction - that's all. <br></li></ul><br><p>  As you can see, there are quite a lot of sources of information, and it is not surprising that there are special software tools that allow you to conveniently collect this information, aggregate it and save it.  One such tool is the Telegraf agent.  Its standard delivery includes more than a hundred plug-ins for monitoring a wide range of popular programs.  System counters, popular databases, web servers, queues and a whole lot more. </p><br><img src="https://habrastorage.org/webt/zt/ma/ux/ztmauxkqz_tunpdpvvfeepeo3sw.png"><br><p>  A large community, flexible settings, an excellent system of plug-ins make this tool an indispensable tool in monitoring.  Telegraf can not only collect information from different sources and formats, but also can process and aggregate it on the client, which can greatly reduce the volume and load on the central server. </p><br><p>  Let's take a practical look at how Telegraf works.  Let's start, oddly enough, with Grafana. </p><br><img src="https://habrastorage.org/webt/xc/1m/6n/xc1m6n4h_vl1ihfngy_rm6yn8lm.png"><br><p>  I did not specifically mention Grafana up to this point, so that you understand how low the threshold of entry is.  All you need to know: Grafana is a graphical web-based interface that can visualize time series from TSDB.  Grafana has a repository that contains many different plug-ins, ready-made dashboards for existing popular systems, different data sources, and so on, we will use one of them now. </p><br><img src="https://habrastorage.org/webt/c-/-h/zu/c--hzupl1t4nzvvjypyrjkkow6m.png"><br><p>  Let's find a dashboard, which is called Influx Windows Host Overview, it is needed just to make a dashboard for Telegraf under Windows. </p><br><img src="https://habrastorage.org/webt/u_/5j/jv/u_5jjvu8gl6tsmvgr2srnk_7f2m.png"><br><p>  This dashboard consists of two parts: the first is the settings of Telegraf itself, it describes what Performance Counters and in what formats it should report in order for it to be picked up by Grafana. </p><br><img src="https://habrastorage.org/webt/g9/fl/p8/g9flp83_dhgm9npbsunzmg22edi.png"><br><p>  We copy these settings, paste them into the settings of Telegraf itself: </p><br><img src="https://habrastorage.org/webt/dv/cu/-f/dvcu-fqp2pqswp9dwbmcagi1dqk.png"><br><p>  As you can see, the settings are quite intuitive and clear, you specify the name of the performance counter and configure the polling period: </p><br><img src="https://habrastorage.org/webt/tl/13/3u/tl133u_jqwy6oxiqrhoebcl5jce.png"><br><p>  All this Telegraf collects and sends to Influx. </p><br><p>  Let's return to our dashboard.  As I said, it consists of two parts, now let's talk about the second.  The second part is a unique dashboard number, copy it, go to our local Grafana, import the dashboard 19:04 to this unique number, at this moment Grafana goes to the Internet, download the dashboard and the next second will show us a lot of interesting information about our system. </p><br><img src="https://habrastorage.org/webt/r4/jl/08/r4jl08oowzw5_sc_9lz-ajhazq4.png"><br><p>  Here you can find complete information about threads, processes, CPU, memory, disks, your network interfaces, how many packets came to you, how many were spent, the number of handles, and so on.  I specifically pledged all the processes in the system, but in your production code you need to limit yourself only to those processes that are necessary for your work. <br>  As I said, Telegraf does not directly interact with Grafana, there is Influx between them.  InfluxDB is the most popular time series database at the moment. </p><br><img src="https://habrastorage.org/webt/ur/pq/sy/urpqsyhmn3uwusfqf3rp8bypeae.png"><br><p>  She very quickly overtook all her competitors and is not going to slow down now.  And our tests have shown that this is well deserved. <br>  Using the example of Influx, let's look at the specifics of the data TSDB usually works with and what distinguishes them from relational databases: </p><br><img src="https://habrastorage.org/webt/ia/hk/ee/iahkee5nvavkp-xgyqulbomgjcs.png"><br><ul><li>  First, there are millions of data points and millions of series.  It‚Äôs as if you‚Äôve started creating millions of tables and filling them with millions of values ‚Äã‚Äãin your relational database, this is quite rare in practice.  And for Influx this is the standard situation. <br></li><li>  Frequent entry.  The fact is that the data in the metrics are written constantly, even if the user does nothing.  Metrics are written that he does nothing, still does nothing and so on. <br></li><li>  The same situation with reading.  Analytics, dashboards, alerts, all require constant reading, so there are also very large loads. <br></li><li>  Uninstall.  It occurs in large batches, because the main reason for deletion is simply the ‚Äúswelling‚Äù of the data. <br></li><li>  There are almost no updates, and they can be neglected. <br></li></ul><br><p>  In terms of CRUD, Influx is a CR-system; fast data creation and reading is very important to it.  Updates and deletions happen very rarely and in quite specific and well-optimized situations. <br>  Under the hood, it stores data in its own time-structured merge-tree format. </p><br><img src="https://habrastorage.org/webt/vo/oe/ua/vooeuamwxdlcls85vb8umur4uwk.png"><br><p>  This is an optimization of the well-known log-structured merge-tree (LSM-tree) as applied to time series, which has worked well in practice.  This is a data structure optimized for fast index access with frequent inserts.  Used, for example, in the transaction logs of almost all modern databases. <br>  Another big advantage of Influx is the SQL-like query syntax. </p><br><img src="https://habrastorage.org/webt/ww/d3/sa/wwd3sa-z-2y9yl0hbsoh-bjutiw.png"><br><p>  Why is it important?  His previous opponents very much sinned with a poor elaboration of this aspect, they asked us to make inquiries from such a godless mixture, like regular expressions, JSON and a sick psyche of authors.  It was generally impossible to maintain, somewhere in a week you come, look at your requests, and your eyes are leaking.  And it was the normal query syntax that allowed Influx to shoot at the mass public. </p><br><p>  If we are talking about the fact that we constantly accumulate data, it is necessary to understand what we are doing with them.  For this there is the Retention policy (a special mechanism that involves deleting data after a certain period of time, if you do not need them).  But this is too trite.  If you cross it with a feature such as Continuous Queries (this is something like a materialized view, a precomputation of complex aggregates on the server), you get such an interesting mechanism as downsampling.  Let's give an example. </p><br><img src="https://habrastorage.org/webt/jw/jc/py/jwjcpyauqofyxyuigjvtvdnszt0.png"><br><p>  Suppose you want to measure the number of requests coming to your site.  You can do it in real time, watch the download of all of this in the charts and react to it somehow.  In a day, real-time values ‚Äã‚Äãfor you are redundant, and you can easily aggregate them to ten-second intervals, calculate the aggregates (min, max, count, which ones you are interested in) and save the same data set, only in a much smaller size, therefore, you will use much less space.  After a week, you can increase the period to one minute, in a month - up to an hour, and leave this data in the archive, for example, to compare the performance of your application in a year. </p><br><p>   :     ,   ,          :  ,  ,  ,   ,    Influx    .    ‚Äî     ,     ,    .  -    ,   ,     : </p><br><img src="https://habrastorage.org/webt/ws/xj/qw/wsxjqwv59w0j-zwhh-rdi8tuywi.png"><br><p>    250         ,          32    .    .       ,     .        Influx-     ,           ,      . </p><br><p>    time series    ?  ,     : </p><br><img src="https://habrastorage.org/webt/hp/qz/4w/hpqz4w6onrcvwhr8g-zzot-b4eq.png"><br><p>       TSDB ‚Äî  InfluxDB  OpenTSDB. OpenTSDB ‚Äî     TSDB,      . </p><br><p>   ‚Äî    . </p><br><p>  ,  ,   ,       ,    ,   .   ,    ,             .    ,     ,      . </p><br><p>  elastic     (,    ),      . </p><br><p> , .   Influx    5  27 : </p><br><img src="https://habrastorage.org/webt/rs/_h/b5/rs_hb5ps2y3cmmdj1k3dech-aog.png"><br><p>      9  84  ,   : </p><br><img src="https://habrastorage.org/webt/mi/df/wg/midfwgnaggok5pcyacotog_p2tq.png"><br><p>       MongoDB,      168   Cassandra. </p><br><img src="https://habrastorage.org/webt/v9/lq/x0/v9lqx04p4w_wqfdxzvvmaiixcu4.png"><br><p>              . </p><br><p>   , Influx       . ,       .    ,   App Metrics,   ,         WebAPI-,        Grafana.  ,   : </p><br><img src="https://habrastorage.org/webt/ap/bh/gu/apbhguxd6louemh4h-phfpkjx-w.png"><br><p> ,  Owin-,    ,  ,   ,   ,   App Metrics: </p><br><img src="https://habrastorage.org/webt/jb/br/3w/jbbr3wigx01nmzyhhcmb4dgzjtg.png"><br><p> ,   ,  InfluxDB    : </p><br><img src="https://habrastorage.org/webt/gc/-l/v2/gc-lv2gpvh7tajac8n--osh1spi.png"><br><p>    , HealthChecks: </p><br><img src="https://habrastorage.org/webt/bz/ln/q_/bzlnq__d7al_butzupk8rc-ku6o.png"><br><p> HealthChecks ‚Äî   ¬´¬ª  ,      .     ,   . <br>   ,     ,     ,    -  : </p><br><img src="https://habrastorage.org/webt/bm/vs/pa/bmvspaqg9luwmmld7kiu9weqbfs.png"><br><p>   AppMetrics  ,   ,   ,  ,      . </p><br><p>    . </p><br><img src="https://habrastorage.org/webt/un/-g/9d/un-g9dn3kt__ssjkpo8ux7riuye.png"><br><p>     ,     ,     ,   ,           API-: </p><br><img src="https://habrastorage.org/webt/a7/q5/9r/a7q59rogxv82xfu4yrsz2t7vzri.png"><br><p>  ,  ,   ,   ,   ,     ,      .      ,     ,  ‚Äî    . , ,  HealthCheckers: </p><br><img src="https://habrastorage.org/webt/at/ae/tb/ataetbfiakdpsmaxmg50lkzerkk.png"><br><p>  ,       ,   ‚Äî . </p><br><p>  ,  ,    ,   ,       .          ,       ?     : </p><br><ul><li> -,  Telegraf  ,    .           . <br></li><li>  App Metrics  ,    .       Web API,       . <br></li><li>   .   .    , ,     ,        body.  ,    ,   . <br></li><li>   ,          . <br></li><li>        ,      ,           -. <br></li></ul><br><p>  ,    ,     -,       ,     .   ,           .      ,       Influx        Grafana. </p><br><p>         ,       BenchmarkDotNet. ,   -:   .   ,    ,    .      , ,        ,     -,        Influx.   ,     ,   Grafana    ,    ,  , , . </p><br><p>    ?  ,  .       ,   influx.exe: </p><br><img src="https://habrastorage.org/webt/ok/za/jq/okzajqty_wdya09vpfrkh0fumik.png"><br><p>       Influx         . ,    benchmarks,       . </p><br><img src="https://habrastorage.org/webt/pa/hr/ho/pahrhowuwysfe4dwikmn6xudabk.png"><br><p>     :    ,     ,     . </p><br><p>    : </p><br><img src="https://habrastorage.org/webt/uc/oi/yb/ucoiybgm89fukavsit8xktgxtsw.png"><br><p>  : </p><br><img src="https://habrastorage.org/webt/dt/vn/xx/dtvnxxocercn1ghjwhwi2jfkv1q.png"><br><p>      BenchmarkDotNet,           .   ,    ‚Äî  InfluxExporter,    : </p><br><img src="https://habrastorage.org/webt/x-/cl/06/x-cl06r2hteybe-dgqsgileqmmo.png"><br><p>           .    : </p><br><img src="https://habrastorage.org/webt/3j/vl/nj/3jvlnjznnfyyba-yzms3ezksk6u.png"><br><p>       IExporter,   BenchmarkDotNet,    ,       . </p><br><p>      MetricsCollector: </p><br><img src="https://habrastorage.org/webt/9i/4m/zh/9i4mzhmldovxqquodktpmxvcczw.png"><br><p>  ,     InfluxDBCollector.   ,       . </p><br><img src="https://habrastorage.org/webt/6f/i3/ao/6fi3aoqp7ueqhwuzhfnjkyz1q5q.png"><br><p>         .        ,       ,    real time. <br> , , : </p><br><img src="https://habrastorage.org/webt/d0/mr/k1/d0mrk1jasnvohjrszbittjgmirs.png"><br><p>    . </p><br><p>  InfluxDB        LineProtocol,          : </p><br><img src="https://habrastorage.org/webt/pj/bt/7y/pjbt7ye2cwbecvwpdy5wzx-iyzq.png"><br><p>    ,      . <br>   Grafana.    ,    Data Source. </p><br><img src="https://habrastorage.org/webt/b_/kt/jl/b_ktjlteeeb9_y64mk4vzyyxbnk.png"><br><p>   ,   InfluxDB,  Influx     (    ). Data Source ,        . <br>  Influx    ,         . </p><br><img src="https://habrastorage.org/webt/rd/yx/r6/rdyxr6gnusq7wcd3gnc3blqd7dg.png"><br><p>  Data Source  ,  Influx     .  ,   ,           : </p><br><img src="https://habrastorage.org/webt/w2/qt/gf/w2qtgfpwxtmveidrm2cybwa57vk.png"><br><p>   ,        .         .      :     ,   ,        Grafana   . </p><br><img src="https://habrastorage.org/webt/pu/ym/is/puymis2gyivgt-wxzgvtqgipo48.png"><br><p>       ,  ,          . </p><br><img src="https://habrastorage.org/webt/k-/j3/ed/k-j3edhxcme_wgm2rf9tuo3vhr4.png"><br><p>       ,      Grafana     Telegram.  ,  . </p><br><img src="https://habrastorage.org/webt/kd/ac/m4/kdacm4irxuzcnq2lfyha8i2cq58.png"><br><p> ,     ,  Telegram.        ,               .     . </p><br><p>      <a href="https://github.com/AnatolyKulakov/Samples/tree/master/Metrix/Demo/ArchBenchmark">  </a> . </p><br><p> ,   . </p><br><p>      .   ,   ,   ,      .         .        . ,       ,        . ,        ,   .    . </p><br><p>   ,      ,   .        ,   ,     ,    .    . </p><br><p>   Dynamic Time Warping.        . , ¬´¬ª    .       ,    ,   , ,   ..           : ,     ,  ,   API gateway.   API gateway  DDoS-. ,    ,  .      100%  CPU,  ‚Äî -    ,  ‚Äî -  . ,    ,    ,            .     .  DTW            . </p><br><p>   ,          ,     ,    . ,     ,  ,   ,     .  , , , ,  ‚Äî     . </p><br><p>   ‚Äî   .        . <br>         . </p><br><img src="https://habrastorage.org/webt/np/9h/bl/np9hblmhs4pyrserbitplrafdwc.png"><br><p> It turns out that this is also a time series.  Analyzing this graph, it is possible to predict the possibility of an accident and to warn the sad outcomes in advance.  The most interesting is that all this analysis takes place on the driver‚Äôs mobile device. </p><br><p>  Let's go down to our realities and look at the tools.  InfluxData provides you with a set of several tools that can help you in your application.  All of them are united under the common name TICK and are perfectly integrated with each other. </p><br><img src="https://habrastorage.org/webt/yc/dx/vo/ycdxvovbqw_dy44rxsecdskj4g0.png"><br><p>  We are already familiar with Telegraf.  This is a metric collector that can aggregate data and send it to the server. </p><br><img src="https://habrastorage.org/webt/sy/pa/en/sypaeno5j8msslcem_jkks3npsy.png"><br><p>  InfluxDB.  Basically, InfluxDB is beautiful, its free version should be enough if you make less than a million records per second.  The only significant limitation of the free version is the lack of clustering.  Therefore, if you need the resiliency and reliability of the metrics system, you need a paid version, where all this is.  Influx is available in both cloud and self-hosted solutions. </p><br><img src="https://habrastorage.org/webt/kx/am/zd/kxamzdhapxxocn4lvcwzdyeteug.png"><br><p>  Chronograph is a web UI, which should unite all this family.  He is terrible, so I did not tell about him.  But, unfortunately, we have no other tool.  If you just need to go to Influx and see what kind of data is there, what metrics are created, what retention policy is, then this mess will help you.  In principle, it is developing well, there is hope that in the near future it will even be possible to use it. </p><br><img src="https://habrastorage.org/webt/el/4m/f_/el4mf_brijkubj3u1b-isy7ivtm.png"><br><p>  Kapacitor is positioned as a tool for detecting anomalies using machine learning.  But he has a lot of bugs and the brain-consuming syntax of queries, so it is completely unrealistic to use it in practice in the coming years, do not even try.  If you really need to detect anomalies using machine learning, the following bundle works: you also store data in Influx in the same way, but read it using your own application, which you write with regard to the existing domain, and use standard machine libraries as analyzers learning.  Here it works great.  If you need, look this way. </p><br><img src="https://habrastorage.org/webt/rt/yt/08/rtyt089ocafav7qgc46lbbwbtx0.png"><br><p>  If the Influx competitor can somehow be found, then Grafana is out of competition.  Great visualization, the minimum number of bugs.  Having a visual query editor that makes the entry threshold flat.  A flexible system of plug-ins that ensures the existence of: heaps of data sources, non-standard panels and ready-made dashboards for all popular needs.  This is the only web application whose responsiveness does not make me want to break the monitor with a chair.  In general, here do not even try to look for an alternative in the coming years. </p><br><p>  Such a moment is interesting in conjunction with Grafana and Influx: this scheme is rather autonomous.  What does it mean?  After you install these tools, you give the developer just two URLs.  The first is from Influx, and the developer, implementing another feature, begins to write his own metrics to this URL.  He does not need to know anything about Influx, because there is a dynamic scheme, Influx will adjust to it.  The second URL is from Grafana.  The developer recorded the data in Influx, enters Grafana, and, using the visual editor, easily and quickly plots himself with nice graphics, immediately sees the results of his immediate work, and this is very important in the development practice.  Thus, there is a very large metric coverage of your application, which in the future may very well play into your hands. </p><br><img src="https://habrastorage.org/webt/ld/0q/nh/ld0qnhodvdh26yqpyjcdsyeawd4.png"><br><p>  Unfortunately, a lot of tools in the modern world come with the Linux-first approach.  This means that, first of all, the program is developed for Linux, and then transferred as a residual to Windows.  The same fate befell our heroes.  Grafana is easier, it has a web interface, she doesn‚Äôt care where to run, but Influx, despite the fact that it has been developed for more than five years, received the distribution kit for Windows only six months ago (I‚Äôm one of those old fart who collected it from source) ).  At the moment, the only thing left of such heredity is that these tools are console applications and cannot run as Windows services, which is a standard deployment unit on our Windows systems.  A tool like NS Service Manager will help you solve this problem; it takes a console application and makes a full-fledged Windows service out of it.  Small and good utility, works without interruption and complaints. </p><br><img src="https://habrastorage.org/webt/r3/iv/jk/r3ivjkiqjnbfjfua702w6wjsfdy.png"><br><p>  Let's look at alternative approaches.  So: </p><br><ul><li>  if instant insertion and fast reading are not important to you; <br></li><li>  if you do not run into bandwidth; <br></li><li>  if you don‚Äôt dream of transparent downsampling; <br></li><li>  if you don't know how Continuous Queries can help; <br></li><li>  if you do not need built-in statistics and extended aggregation functions; <br></li><li>  if you want to personally delete every outdated entry; <br></li><li>  if you are not afraid of the size of the base; <br></li><li>  if you are confident in the absence of high loads on your system; <br></li><li>  if you are ready to lose analysis in real time. <br></li></ul><br><p>  So you, in principle, can use standard databases to store metrics in them.  And this is not so funny as it seems at first glance, because the finished examination in a team that has already worked with these old footers can exceed the threshold of risk that is needed to bring some new tools into your project. </p><br><img src="https://habrastorage.org/webt/pp/v6/mn/ppv6mndve3cjoe5jf6ysugcwebs.png"><br><p>  I have met many projects for which this method turned out to be the most viable, so do not hesitate, this is normal, it happens. </p><br><p>  The bundle that I showed you today (Telegraf, Influx and Grafana) is the lowest-level, most optimal system in terms of performance and flexibility.  Naturally, not everyone needs such a low level.  Many do not want to bother about it and want to choose higher-level solutions, they are also full on the market, they also work, and they can also suit you, try. </p><br><img src="https://habrastorage.org/webt/qk/1m/6t/qk1m6tiddu-kwkfukhfxbecxdca.png"><br><p>  Also, if you are not ashamed of the clouds, there are a lot of paid solutions that are pretty good. </p><br><img src="https://habrastorage.org/webt/sh/dr/dg/shdrdg3m9qdlfpqdmdgmnsunxic.png"><br><p>  Usually, all these high-level solutions work with metrics and logs together to try to correlate them into one scheme, one dashboards. <br>  Unfortunately, one cannot be recommended.  When we talk about high-level solutions, you need to look specifically at your project, at your workload, at your approach to development.  InfluxDB and Grafana are a kind of basic level that you should be guided by, if you suddenly decide to search for alternatives. </p><br><p>  As you probably noticed, one of the great opportunities when working with TSDB is familiarity with their algorithms.  Algorithms are quite interesting: </p><br><ul><li>  <a href="http://www.vldb.org/pvldb/vol8/p1816-teller.pdf">Gorilla paper</a> </li><li>  <a href="http://akumuli.org/">Akumuli</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Run-length_encoding">Run-length encoding</a> </li><li>  <a href="https://developers.google.com/protocol-buffers/docs/encoding">Varints</a> </li><li>  <a href="https://developers.google.com/protocol-buffers/docs/encoding">Zigzag</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Dynamic_time_warping">Dynamic time warping</a> </li><li>  <a href="https://dl.acm.org/citation.cfm%3Fid%3D948236">Sketch-based change detection</a> </li><li>  <a href="https://www.slideshare.net/nagarajc007/mobile-drunk-driver-detection">Mobile Phone Based Drunk driving detection</a> </li></ul><br><p>  Here are links to help you get a little insight into this topic.  If you're suddenly a fan of some bit magic, elegant solutions, or just cool and good compression, read this minimum at night before bed, I think you will sleep well. </p><br><p>  If we want to get acquainted with the detailed information about our heroes, it‚Äôs enough standard information on their official website: </p><br><ul><li>  <a href="https://www.influxdata.com/">InfluxData site</a> </li><li>  <a href="https://grafana.com/">Grafana site</a> </li><li>  <a href="https://www.app-metrics.io/">App Metrics site</a> </li><li>  <a href="https://www.app-metrics.io/">Non-Sucking Service Manager</a> </li></ul><br><p>  It is very well written, of course, always relevant. </p><br><p>  If, after reading the article, you have questions, feel free to email me about how you use metrics, what interesting graphics you have: </p><br><ul><li>  <a href="">Anatoly.Kulakov@outlook.com</a> </li><li>  <a href="http://twitter.com/KulakovT">twitter.com/KulakovT</a> </li><li>  <a href="http://github.com/AnatolyKulakov">github.com/AnatolyKulakov</a> </li><li>  <a href="http://spbdotnet.org/">SpbDotNet.org</a> </li></ul><br><p>  I will deal with this topic for a long time and much, because, as the classic said: "Optimism is a lack of information."  Therefore, friends, be realistic, know what your application does.  Thanks for attention. </p><br><blockquote>  Minute advertising.  As you probably know, we do conferences.  The nearest .NET conference - <a href="https://dotnext-piter.ru/">DotNext 2018 Piter</a> .  It will be held April 22-23, 2018 in St. Petersburg.  What reports are there - you can see in <a href="https://www.youtube.com/watch%3Fv%3DMpFEkVPbgiU%26list%3DPLtWrKx3nUGBeYn-pSCjEgBPL90SvpylZL">our archive on YouTube</a> .  At the conference, it will be possible to chat live with the speakers and the best experts on .NET in special discussion zones after each report.  In short, come in, we are waiting for you. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/352624/">https://habr.com/ru/post/352624/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352614/index.html">How to solve 90% of NLP tasks: a step-by-step guide to natural language processing</a></li>
<li><a href="../352616/index.html">Ansible is not so simple</a></li>
<li><a href="../352618/index.html">How to switch to microservices and not break production</a></li>
<li><a href="../352620/index.html">We open the history of the Bolshoi Theater. Part one</a></li>
<li><a href="../352622/index.html">Performance analysis of the drive Intel Optane SSD 750GB</a></li>
<li><a href="../352626/index.html">Storage options for cryptographic keys</a></li>
<li><a href="../352628/index.html">Rumors about the cancellation of the Kotelnikov theorem are greatly exaggerated</a></li>
<li><a href="../352630/index.html">As Google Adwords experts helped me to throw away 150,000 UAH (about $ 6000) per month or why I will not ...</a></li>
<li><a href="../352632/index.html">True implementation of a neural network from scratch. Part 2. Recognition of numbers</a></li>
<li><a href="../352634/index.html">Network Optimization for Unreal Engine 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>