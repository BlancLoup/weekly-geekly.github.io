<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience in developing an Unity asset for finding a path in 3D space</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Welcome to the Graceful Algorithms Team! 

 As an experiment, we made a decision to keep ‚Äúdiaries‚Äù of developers, in which we will share our experienc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience in developing an Unity asset for finding a path in 3D space</h1><div class="post__text post__text-html js-mediator-article">  Welcome to the Graceful Algorithms Team! <br><br>  As an experiment, we made a decision to keep ‚Äúdiaries‚Äù of developers, in which we will share our experience and highlight some interesting results of our experiments.  This is our debut article on the project ‚ÄúPathfinder 3D‚Äù - an asset for the Unity game engine, which allows you to search for a path in three-dimensional space.  In it, we will talk about the path from the inception of the idea to the full-fledged product and about some of the problems we encountered.  This material will be useful for people who want to start their project and support it in the future, as well as for those who want to realize the search for a path in space. <br><a name="habracut"></a><br>  The team of two people began work on the asset.  The first one had some groundwork to speed up the process of finding the shortest path on complex graphs sufficiently for real-time work and the desire to find practical application for them, the second one had some experience with Unity and was looking for an idea for a startup.  Since they often communicated with each other, it is not surprising that at a certain point an idea arose about the possibility of creating an asset for finding a path in three-dimensional space. <br><br>  When studying the Unity asset directory, a number of solutions were found for finding a path in two-dimensional space, but none in three-dimensional.  It became obvious that this is a great opportunity to enter the market for software add-ins for Unity, especially given the visibility and spectacularity of the expected result. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/webt/sl/g0/mm/slg0mmebuga20hyrv4hiic-j2ho.jpeg"></div><br>  The goal was to implement directly search for a path in three-dimensional space and the typical capabilities of existing solutions for finding a path in a two-dimensional space.  We started to work: one developed directly the path finding mechanism, the second classes and methods for managing the path finding process, configuration interfaces, test scenes, documentation, the project website, and also registered and configured service accounts for selling assets. <br><br>  Shortly after the start of work, it became clear that a common resource is needed for the team to keep notes: a list of tasks and problems that need to be solved, information about the decisions made, interesting ideas in the future, and research results.  After analyzing the existing solutions, we stopped at the <a href="https://trello.com/">Trello</a> , because of its functionality, simplicity, convenience and pleasant appearance.  As practice has shown, this service is very convenient for small teams.  If the team has more than 5 people, we would advise using a full-fledged project management system. <br><br>  Next, we describe the decisions taken during the development of the first version of the asset, and the logic that we followed when making them.  People who have experience with Unity and are familiar with path finding algorithms will immediately understand where problems will arise in the future.  In these places, we took advantage of a simple solution in favor of reducing the development time before getting the first working version of an asset, so as not to get bogged down, because the enthusiasm is a limited and inconstant piece.  Thus, we coped with one of the most common reasons for the closure of such startups, because of which many projects die without being born.  All problem areas were corrected after the publication of the asset. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jk/ri/sp/jkrisph5ng_tz1slmdzfttxdoie.gif"></div><br>  For the search of the path, the algorithm <a href="https://www.redblobgames.com/pathfinding/a-star/introduction.html">A * (A star)</a> was chosen because of its high speed in large open spaces.  Most path finding algorithms work on graphs represented by a discrete matrix.  It would be possible to build this matrix in advance, but the one-time process of its construction along three-dimensional space with obstacles looked at that moment as a rather difficult task.  In addition, it was not clear how this could be done without sacrificing performance, since at the time we started working on the asset, there was no experience with background processes and multithreading in Unity.  The graph was formed in real time by probing the space with physical rays (Physics.BoxCast) in the search direction.  The found trajectories were reduced to broken lines, with a smaller number of intermediate points, and then smoothed by splines. <br><br>  The main difficulty was the impossibility of asynchronous use of the physical methods of the engine, since they can work exclusively in the main thread.  On not too complicated scenes, the use of the search function at the same time by no more than twenty agents did not strongly influence the frame rate.  To get rid of the rare strong FPS drawdowns, the computational load was separated in time using corutines.  This slowed down the search, but only slightly. <br><br>  Before submitting an asset for moderation, you need to put the code in order and compile detailed documentation, in accordance with the <a href="https://unity3d.com/ru/asset-store/sell-assets/submission-guidelines">requirements</a> , register and set up support mail.  It is also desirable to create a project site where development news and demo examples will be conveniently displayed.  This will be a big plus as with the passage of moderation, and when examining your asset by the user before purchase.  Hosting and postal services were ordered by us from <a href="https://beget.com/">BeGet</a> , as it offered the most advantageous offers at that time, and cost us 1000r / year. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7u/h4/7q/7uh47qdtjz_vkhribjsh19_xcc8.png"></div><br>  The asset moderation lasted 22 days and passed the first time, since we very carefully approached the documentation and design of the asset page in the Unity store.  After the publication, the asset immediately hit the top places in the Scripting / AI category.  From this point on, letters began to come to the support mail asking for help in solving various problems.  Sometimes several per day, sometimes none per month.  If we average, then in a month 2 people turned to questions, the correspondence with which took a total of 2-3 hours.  Not so much, but keep in mind that regardless of your current workload, you need to respond very promptly, so that angry users do not write bad reviews about the product, but, on the contrary, enthusiastic with quality support, left positive.  Also, quite a lot of questions come to the mail like ‚Äúwill your asset work if ...‚Äù.  Such letters should not be ignored either, because this is a potential buyer who can leave. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/x8/3b/kd/x83bkdcsm3bxsxmeor0yhe8xij0.jpeg"></div><br>  As we received complaints from the first customers, it became clear that many users use an asset on complex scenes that have a maze or other connected cavity configuration.  In such projects, the path finding scheme we used, based on collision checking, and even in the main stream, was not effective enough.  Therefore, we started to implement the early construction of the graph in order to make it possible to search for a path in the sidestream without using physics and referring to objects in the scene. <br><br>  Discretization of three-dimensional space breaks it into cubes.  Storing information about all cubes of the partition is redundant and is very expensive in memory.  Therefore, it is logical to store only the coordinates of impassable cells, which was done. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2k/kl/5p/2kkl5pn7lgswpe_7bwixkioulpw.jpeg"></div><br>  Game obstacles are polygonal shapes and consist of triangles.  To take into account the obstacles in the search graph, it is necessary to find all the cubes of the partition intersecting a triangle of any obstacle.  Already at this stage, the possibility of dynamically removing and adding obstacles on the stage was laid, and not only the coordinates of the occupied cubes were saved, but also the identifiers of the obstacles that were in them.  Now it became possible to build a navigation graph before the start of the game process and, by eliminating a large number of complex calculations during the search for a path, more than two hundred agents could perform it simultaneously without sacrificing performance. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6o/yn/bd/6oynbdbckmzfhtzu289blvzhqcu.jpeg"></div><br>  Another problem known to us also manifested itself: the A * algorithm and its modifications work extremely poorly in closed spaces on high-power graphs.  Since their algorithm gives preference to the direction of the route in the direction of approaching the target point, any impasse leading to the target slowed down the search for a path, because, before choosing another direction of ‚Äúgermination,‚Äù the algorithm first ‚Äúfills‚Äù all the space inside the impasse. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ff/ph/is/ffphis2un_0wdpsehrnwra1fiha.gif"></div><br>  In such situations, the <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC_%25D0%259B%25D0%25B8">wave search algorithm (Lie algorithm)</a> shows itself to be very effective due to the <a href="https://www.youtube.com/watch%3Fv%3D8Jgn_mB6Yb8">smaller number of operations</a> required to ‚Äúfill‚Äù the space.  Therefore, it was added to the asset as an alternative.  When testing on a stage that is a labyrinth, the time to search for a path has been reduced by more than 30 times. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/eq/lt/nd/eqltndonsivsvukp1t6lhn_awmo.jpeg"></div><br>  To speed up the pre-processing of the scene and search for the path into the asset, the possibility of parallel execution of processes was added, but the efficiency of parallelism was extremely low, because when working with a container that stores the coordinates of occupied cells, it is necessary to synchronize the flows, which was performed using mutexes, since competitive collections and many other means to ensure effective synchronization <a href="https://devblogs.microsoft.com/pfxteam/whats-new-for-parallelism-in-net-4-5/">were implemented</a> only in the .NET Framework 4.5 standard, and the .NE version was used in Unity until the 2018 release  T Framework 3.5.  We tried to solve this problem with the help of available means, but they had a very mediocre speed, and we got the desired result only after switching to the 2018 release of Unity.  The use of competitive collections also opened up the possibility of implementing dynamic change of obstacles on the stage. <br><br>  At a certain stage, a team began to disagree about the distribution of profits, and a third person joined the team, who introduced a system for evaluating the time investments of each team member, and also began to do code inspection and testing, which markedly improved the quality of the product. <br><br>  The time evaluation system is currently implemented in the form of an Excel spreadsheet and is an automated system, in which once a month you need to enter information about sales and tasks completed over the past month.  Team members need to estimate how much time they would need to complete a task.  Thus, when evaluating the time complexity of tasks, the speed of each participant is taken into account.  Anomalous overestimation or underestimation by any of the participants immediately becomes apparent from the accumulated statistics of his previous assessments.  And, in the absence of a satisfactory explanation, this issue is resolved by the whole team.  This approach showed itself well in six months of use and allowed us to collect interesting statistics.  We did not find a ready-made free solution that would provide the described opportunities.  Therefore, at the moment for small teams, the implementation in the form of Excel tables seems to be optimal.  For relatively large teams, you will most likely have to design your database, develop the server part and the client, or implement an extension for one of the existing project management systems. <br><br>  <strong>Let's sum up.</strong>  Since the start of development to the first version with the minimum necessary functionality and sufficient performance for use in real projects, a year has passed.  Another half a year was spent on improving the speed and implementation of multi-threaded asset work.  At the moment, the time spent on this project was estimated by us at 1065 man-hours (this is quite an optimistic estimate), and the average monthly profit is 9.5 tr.  It is easy to calculate that the average cost of an hour of work at the moment is about 160 rubles, which is not so much.  However, the main thing in this event is the experience gained by each participant.  Including teamwork experience and software product support experience.  The project can be considered successful. <br><br>  Now our team has started implementation of additional useful functionality: algorithmic accessibility check;  the ability to assign game objects portals;  support for dynamic obstacles;  local navigation between agents, for collision avoidance and local route planning. <br><br>  We hope this material will help someone to bring their project to the finish line. </div><p>Source: <a href="https://habr.com/ru/post/450854/">https://habr.com/ru/post/450854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450844/index.html">Introduction to Example Mapping</a></li>
<li><a href="../450846/index.html">Microsoft's packaging wonders: Linux kernel in Windows 10 and IE engine inside Chromium Edge</a></li>
<li><a href="../450848/index.html">About yellow phosphorus and human panic nature</a></li>
<li><a href="../45085/index.html">Google should look like this:</a></li>
<li><a href="../450850/index.html">Towards a brighter future for smart compilers</a></li>
<li><a href="../450858/index.html">Open Source Networking meet-up - now in Yandex.Cloud # 3.2019</a></li>
<li><a href="../450860/index.html">Smart socket REDMOND SkyPort 100S</a></li>
<li><a href="../450862/index.html">Selection @pythonetc, April 2019</a></li>
<li><a href="../450868/index.html">Video reports from FunTech QA-automation meetup</a></li>
<li><a href="../450870/index.html">How Netflix Uses Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>