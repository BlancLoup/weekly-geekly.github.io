<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Postgres Tips for Rails Developers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In April, on RailsConf in Phoenix, we discussed a huge amount of advice on using Postgres with Rails, and thought it would be useful to write and shar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Postgres Tips for Rails Developers</h1><div class="post__text post__text-html js-mediator-article"><p>  In April, on RailsConf in Phoenix, we discussed a huge amount of advice on using Postgres with Rails, and thought it would be useful to write and share them with a wider audience.  Here you will find some of them related to debugging and improving the database performance of your Rails application. </p><a name="habracut"></a><br><h3 id="upravlenie-dolgimi-zaprosami-s-pomoschyu-taymautov">  Manage long queries with timeouts </h3><br><p>  Long queries can have all kinds of negative effects on your database.  Regardless of whether requests work for hours or just a few seconds, they can hold locks, overwhelm the WAL, or simply consume a huge amount of system resources.  With Postgres, it‚Äôs easier to achieve greater stability by setting a timeout for requests.  Conveniently, you can set a default value, for example, 5 seconds, as shown in the example below, and then any query that lasts longer than 5 seconds will be killed: </p><br><pre><code class="hljs mel">production: url: &lt;%= DATABASE_URL %&gt; variables: statement_timeout: <span class="hljs-number"><span class="hljs-number">5000</span></span></code> </pre> <br><p>  If you want the request to run longer within the session, you can set a timeout that is valid only for the current connection: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyAnalyticsJob</span></span></span><span class="hljs-class"> &lt; ActiveJob::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queue_as</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">analytics</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">perform</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActiveRecord::Base</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">connection</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">execute</span></span></span><span class="hljs-class"> ‚Äú</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SET</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">statement_timeout</span></span></span><span class="hljs-class"> = 600000‚Äù </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># 10  # ... ensure ActiveRecord::Base.connection.execute ‚ÄúSET statement_timeout = 5000‚Äù # 5  end end</span></span></span></span></code> </pre><br><h3 id="poisk-plohih-zaprosov">  Search for ‚Äúbad‚Äù queries </h3><br><p>  Rails abstracts a lot when interacting with your database.  This can be both good and bad.  Postgres itself allows you to track long requests, but as your Rails application grows, this may not be enough.  To find out the origin of the request, there is an extremely convenient gem marginalia that will log exactly where your request came from.  Now, when you see the wrong request, too slow, or which can be simply removed, you know exactly where to fix this in the code: </p><br><pre> <code class="hljs sql">Account <span class="hljs-keyword"><span class="hljs-keyword">Load</span></span> (<span class="hljs-number"><span class="hljs-number">0.3</span></span>ms) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`accounts`</span></span>.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`accounts`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">`accounts`</span></span>.<span class="hljs-string"><span class="hljs-string">`queenbee_id`</span></span> = <span class="hljs-number"><span class="hljs-number">1234567890</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">/*application:BCX,controller:project_imports,action:show*/</span></span></code> </pre> <br><p>  <em>Attention to the comment - comment.</em> </p><br><h3 id="vysokourovnevyy-obzor-situacii-s-zaprosami-k-baze">  High-level overview of the situation with database queries </h3><br><p>  Often, a general picture of what is happening in your database is required.  pg_stat_statements is a Postgres extension that is often pre-installed in cloud environments such as Citus Cloud.  It allows you to see which queries have been executed since the last reset of the statistics and how they behaved. </p><br><p>  For example, to see the 10 longest running queries and their average time, do the following: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> query, total_time / calls <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> avg_time <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_statements <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> total_time <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br><p>  If you enable "track_io_timing" in the <a href="https://www.postgresql.org/docs/9.3/static/runtime-config-statistics.html">Postgres statistics collector</a> , you can understand what the bottleneck is - the processor or I / O.  You can learn more about <a href="http://www.craigkerstiens.com/2013/01/10/more-on-postgres-performance/">pg_stat_statements here</a> <em>(or in <a href="https://habrahabr.ru/company/okmeter/blog/311028/">another article</a> okmeter.io on Habre - comment. Per.)</em> . </p><br><h3 id="ispolzovanie-prodvinutyh-fich">  Using advanced features </h3><br><p>  By default, Rails uses the ‚Äúschema.rb‚Äù file to store a copy of the database schema, usually used to initialize the database before running the tests.  Unfortunately, many of the advanced features of Postgres, such as functional and partial indexes, as well as composite primary keys, cannot be represented in this DSL. </p><br><p>  Instead, it makes sense to switch to the ‚Äúdb / structure.sql‚Äù file generated and used by Rails, which can be done as follows: </p><br><pre> <code class="hljs pgsql"># Use <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">instead</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> Active <span class="hljs-type"><span class="hljs-type">Record</span></span><span class="hljs-string"><span class="hljs-string">'s schema dumper when creating the database. # This is necessary if your schema can'</span></span>t be completely dumped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> dumper, # <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you have constraints <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>-specific <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-keyword"><span class="hljs-keyword">types</span></span> config.active_record.schema_format = :<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span></code> </pre> <br><p>  Inside, the Postgres ‚Äúpg_dump‚Äù format is used, which can sometimes be too detailed, but it guarantees getting a fully restored database structure.  If you encounter the problem of excessively long diffs, you can take a look at the <a href="https://github.com/lfittl/activerecord-clean-db-structure">activerecord-clean-db-structure</a> . </p><br><h3 id="sledite-za-tem-chtoby-slozhnye-tranzakcii-ne-blokirovali-drug-druga">  Ensure that complex transactions do not block each other. </h3><br><p>  Rails likes to put everything in a transaction, especially when using ‚Äúbefore_save‚Äù hooks and multi-level relationships between models.  There is one important caution that should be considered when transactions that may cause problems when scaling.  For example, in such a transaction: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> organizations <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> updated_at = <span class="hljs-string"><span class="hljs-string">'2017-04-27 11:31:03 -0700'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">123</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> products <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> store_id = <span class="hljs-number"><span class="hljs-number">456</span></span>; <span class="hljs-comment"><span class="hljs-comment">---   statement'  COMMIT;</span></span></code> </pre> <br><p>  The first UPDATE statement will hold the lock on the "organizations" line with id "123" from the very beginning to the transaction COMMIT. </p><br><p>  Submit another request to the same "organization", which came, for example, from another user, and performs a similar transaction.  As a rule, to execute, this other request will have to wait for the commit of the first transaction, which will increase the response time.  To fix this, you can reorder the transaction so that the UPDATE is executed near the end, and also consider the possibility of grouping updates to the timestamp fields outside the transaction after the main work has been completed. </p><br><p>  To detect similar problems in advance, you can set log_lock_waits = on in PostgreSQL. </p><br><h3 id="kontroliruyte-podklyucheniya-k-baze-dannyh">  Monitor database connections </h3><br><p>  Rails by default supports database connection pooling.  When a new request arrives, it takes one connection from the pool and passes it to the application.  As your Rails application scales up, this can lead to hundreds of open connections to the database, although in fact only some of them do the work.  The key to this is using the connection manager to reduce active connections to the database, such as <a href="https://pgbouncer.github.io/">pgBouncer</a> , for example.  The connection manager will open connections when transactions are active, and do not skip idle connections that do not perform any work. </p><br><p>  <em>From the translator - and you can also use our <a href="https://okmeter.io/">monitoring</a> , which will track the number of connections to Postgres and to pgBouncer and much more, and will help prevent and resolve problem situations.</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/330628/">https://habr.com/ru/post/330628/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330614/index.html">Heisenbag 2.0: how was the testing conference in St. Petersburg</a></li>
<li><a href="../330616/index.html">We invite you to the official workshop on UE4 from Epic Games</a></li>
<li><a href="../330618/index.html">SQL Server Integration Services (SSIS) for Beginners - Part 1</a></li>
<li><a href="../330624/index.html">Russian language specification Java</a></li>
<li><a href="../330626/index.html">Security Week 23: EternalBlue ported to Win10, CIA attacks from file servers, marketers quietly infected the whole world</a></li>
<li><a href="../330630/index.html">Naively. Super. Review of the book by Jean Zelazny "Speak in the language of diagrams"</a></li>
<li><a href="../330632/index.html">Solving linear diophantine equations with any number of unknowns.</a></li>
<li><a href="../330634/index.html">Redux: trying to get rid of the need to think during requests to the API, part 2</a></li>
<li><a href="../330636/index.html">Service of the future: opportunities and risks</a></li>
<li><a href="../330638/index.html">By magic ... (Pike programming language)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>