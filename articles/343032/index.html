<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>First HighLoad Cup: how we survived</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Not so long ago ended HighLoad Cup . Many participants received a lot of questions about the organization of the champ from the inside. We, the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>First HighLoad Cup: how we survived</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  Not so long ago ended <a href="https://highloadcup.ru/">HighLoad Cup</a> .  Many participants received a lot of questions about the organization of the champ from the inside.  We, the team of development of championships and educational projects of Mail.Ru Group, in this article will tell about the device of a champ, about internal mechanics and a little about the history of the first HighLoad Cup! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tj/d8/6g/tjd86g3bs5wvyda8atpw7i6868s.jpeg"></div><a name="habracut"></a><br><p>  First of all, on behalf of the developers, we thank all the participants of the championship.  Yes, it was three weeks zhegova not only for you.  Several nights were spent in the DC, a few weekends - in the office.  The fire!  Thanks you! </p><br><p>  The idea of ‚Äã‚Äãthe championship came from life, from everyday life.  Most of our (our) web-products - public "public" projects.  Their life on the Internet is somewhat different from their life on the developer‚Äôs computer.  That search engine, then visitors crowd. </p><br><p>  When developing the server part of the application, one has to work out the speed of the application.  It happens that something is overlooked, and the project is at the limit of server capacity (or outside).  Throwing a badly written application with expensive equipment is how to treat a healthy, not the best solution.  The right decision is to write the application correctly, correctly implement the architecture and backend. </p><br><p>  We hold Russian Code Cup, MLBootCamp, Russian Ai Cup, Russian Design Cup and a number of other championships.  Everything about them is good, except that the real life of a real backend developer is not enough.  In the HighLoad Cup, we tried to bring this reality of development to the masses. </p><br><h2 id="kak-eto-vsyo-rabotaet">  How does all this work? </h2><br><p>  The main question in the development of the championship was: where and how to turn the decision?  We considered several options: </p><br><ol><li>  The participant himself finds iron. </li><li>  We provide a virtual user with full access. </li><li>  We scroll git and ask to write a script that will launch the solution. </li><li>  Docker. </li><li>  Vagrant. </li><li>  Ejudge </li><li>  Member provides a KVM or VirtualBox image. </li><li>  Derivatives from versions 1-7 and their combinations. </li></ol><br><p>  When considering the implementation of the key were two points: </p><br><ol><li>  Same conditions for all participants. </li><li>  Security. </li></ol><br><p>  It is impossible that the result is dependent on iron.  In our case, it turns out, it was necessary to turn all the solutions on absolutely identical machines.  Better on one, but it is enough for 48 decisions (participants) per day.  Therefore, we need a fleet of identical cars. </p><br><p>  Yes, they chose Docker.  As a compromise between performance, simplicity and convenience, while ensuring safety.  Variations without a docker got fewer votes at the developers' council.  Either they did not meet the conditions, or they demanded great efforts for implementation, or they were excessively complex.  Although the docker itself is not very transparent: the three options of the docker compose config are already worth something. </p><br><p>  The architecture is as follows: </p><br><ol><li>  Site.  Web application.  Gives you (visitors) a page. </li><li>  Storage.  Based on docker-registry + special proxy server. </li><li>  Runner.  Special washing machines include containers with Tank. </li><li>  Hub  An application that implements all the mechanics.  The site looks into the hub.  The hub looks into the stack and runners.  It starts what you need where it is necessary and gives the results to the site. </li></ol><br><p>  Least of all questions with the site.  Registration, authorization, challenge, round.  Everything is standard and typical. </p><br><p>  Storage.  The Docker-registry out of the box works well, but it does not implement the delimitation of access and limits on the amount of storage.  Run it unlimited cool, but we can not afford it.  The decisions of one participant should not be available to others.  We have developed a proxy for storazhu to control access and the limit on storage volumes. </p><br><p>  Hub  Actually, this component steers everything that happens.  Starting from the formation of a queue for "shelling" and ending with the processing of results.  She knows about all the runners, calls on them to run the test and for the results.  Gives them to the site at his request. </p><br><p>  Runners.  Here is the launch of everything together, the collection and processing of results, their temporary storage.  Separate cars, the same up to the chassis vendor, cut off from the whole world and working in one direction.  Yes, requests can only be to them and only from the hub.  B - security.  Single components run in duplicate with database replication and apload.  O - fault tolerance.  Runners in the initial configuration - two. </p><br><p>  Now more. </p><br><p>  On the development side, runners are a set of servers interacting with the ‚Äúhub‚Äù via JSON and with the docker registry.  According to hub commands, a set of servers forms a docker-compose and launches the required tank-solution pairs, processes and stores the result, provides it on demand.  Our task is to provide the same conditions for all.  Same and good enough for the highload.  For this we: </p><br><ul><li>  disable Intel TurboBoost; </li><li>  we fix the processor frequencies just below the nominal values; </li><li>  nailing processes (vcpupin) to the physical nuclei, separating the tank from the solution; </li><li>  we allocate a separate partition on the disk to expand the containers; </li><li>  tyunim sysctl, ulimit; </li><li>  To heighten fenshui, we fix processes to numanodes. </li></ul><br><p>  These measures together provide greater stability, greater productivity and less jitter in the shelling results. </p><br><p>  Deploying and testing this complex, we decided to wrap it all in a KVM container.  This gives the following profits: </p><br><p>  A. Be on the safe side in case of kernel panic (virtualku reboot, but not host), attempts to flash bios, hardware, attempts to change something on the host, etc. <br>  B. Limit the disk by read and write kbps.  There are no two identical disks.  They always work differently.  To ensure consistency, you can use the iotune limits of virtual disks. <br>  B. Quickly transfer, transfer or incline container. <br>  D. Additionally, from above, limit the network on the host machine. </p><br><p>  The benefits of such a decision are infrastructural.  It does not give any additional advantages to the participants, and for operation it simplifies a number of questions.  An overhead of kvm-virtualization for our case is not a loss: the main thing is that the conditions are the same. </p><br><p>  In docker containers, they also made an un-privileged REMAP.  You do not run a web server with root rights, right? </p><br><p>  Time to develop slowly but surely ended.  We didn‚Äôt know at all what interest in the championship there would be and whether it was necessary to spend more energy on it.  Tasks, in addition to this championship, the car and a small truck.  We decided to launch it.  Launched the first trial.  We will try quietly.  MVP is ready.  Works.  Let's try, but we'll see.  Maybe all this is in vain and uninteresting? </p><br><p>  Go. </p><br><p>  We prepare a simple task, some data.  Data generator.  Announce, do a couple of posts.  We look at the empty rating.  We are experiencing.  We love to monitor everything.  From voltages in sockets to smartctl parameters.  That was the day of the announcement. </p><br><p><img src="https://habrastorage.org/webt/_j/nh/hq/_jnhhqelsgeb6eqmjrpx_owfjvi.png"></p><br><p>  Yielding to doubts that ‚Äúsomething has broken,‚Äù we push our decision, we see it in the top and we are afraid that it will win.  We are experiencing again.  The first participants appear.  Rejoice!  But our solution is still in the top.  Still experiencing. </p><br><p>  We didn‚Äôt have long to worry about ‚Äúnot take off‚Äù.  Since the technologies are relatively non-standard for the IT-championship, the participants began to actively try test runs.  Ratings are limited to one per day and take half an hour, and test ones are not limited in any way.  It is somehow unfair to limit them. </p><br><p>  A queue of test runs formed.  Two runners began to be missed.  Already in the morning of the next day we were looking for equipment to deploy more runners, in the evening of the next day we sat in the DC and set up two new cars, trying not to miss anything from the fine settings of each.  Four cars in service.  While we set up the above two, it became clear that no less than eight of them needed exactly. </p><br><p>  The place in the storehouse ends.  200 GB should have been enough for 40 planned participants in the estimated conditions.  Participants in the first five days came ten times more.  But everything is worse, almost before the launch, the conditions changed: the number of requests to the solution and the amount of data were increased.  We understand that we need a couple of terabytes, we order.  In the meantime, the storage space for the results flowed.  We are dumping a bit out of stock, but this is not enough for long. </p><br><p><img src="https://habrastorage.org/webt/-g/zd/jq/-gzdjqdwhj6xeub7vtjk2ec0chs.png"></p><br><p>  Modest virtualka site begins to smoke, throws non-stop on the process.  In the meantime, we get discs under stand.  For a hot change at all.  Not provided.  No slots.  We are preparing a new car, asking for half an hour downtime and pouring. </p><br><p><img src="https://habrastorage.org/webt/ar/u4/sm/aru4smxxa7avgh9cdxx62besnbk.png"></p><br><p>  Participants are asking for more data.  Like, yes.  There is only 20 MB.  Well this is about anything.  Need 1 GB.  It sounds easy.  In fact, this is a hundredfold increase in both the resources required for processing and the space for storing the results. </p><br><p>  We understand that eight runners are not enough.  We are looking for more.  We remove four cars from another project in exactly the same configuration and we coax them.  Twelve runners.  Everything.  There are no more such cars. </p><br><p>  Several times we find ourselves on the brink of a foul.  Several times we are saved on the go.  And the participants more and more. </p><br><h2 id="piki">  Peaks </h2><br><p> It seems that this is the most frequent word in the championship chat.  It would be possible not to attach importance to them.  This may well be due to the application implementation curve.  That GC, for example.  Meanwhile, the RPSs have reached 10K values, and at such speeds any sneeze in the system can lead to microbursts in the operation of applications.  Peaks were almost all. </p><br><p>  At this stage, we remembered (in fact, participants suggested to us) about the architectural omission: the tank writes to the disk.  He writes a lot.  Disk operations performed by the tank itself are likely to cause the very sneezes in the system.  What were the options to solve this?  Move to RAM disk: </p><br><p>  a) the entire runner disk; <br>  b) the section where the tank writes. </p><br><p>  First of all, on the test machine, we carried the entire runner disk into RAM.  This ensured no disk operations, but most of the solutions in this configuration fell from OOM.  We did not manage to find out the reasons.  Memory was with a reserve.  Probably, the decisions somehow referred to the total available memory on the machine, which became four times as large when the limit on the solution did not change.  This could lead to erroneous consumption of memory by the solution and its subsequent OOM Kill. </p><br><p>  In parallel, we conducted an experiment with the removal of the section with the tank in the RAM disk.  He managed, the top 50 worked consistently.  This was the solution.  Such a move did not solve all the problems with peaks.  They have become smaller, they have become less significant, but their presence is still being studied. </p><br><p>  Meanwhile, the deadlines expire.  In the top C / C ++ bicycles, phoned the eyes of PHP in the top 25, the final in a day, and we have not slept for three weeks. </p><br><h2 id="final">  The final </h2><br><p>  Initially, the final was planned as a regular round, launching each solution one by one and identifying the best.  This did not guarantee justice: the same solution in different launches showed a run with a decent result.  In order to honestly and fairly reveal the best solution, the method proposed by the participants themselves to hold the final: to get rid of all decisions many times (in waves).  For the result we take the best (minimum) time.  Thus we equalize the chances of each.  Writing day, testing night.  We start.  It was the longest final among our championships.  The decisions of the finalists were tested for a day and a half. </p><br><p>  Summing up, we note: </p><br><ol><li>  A number of mistakes in planning computational (iron) resources made our life more fun.  We have become a little more experienced. </li><li>  Peaks are inevitable on large RPS.  It is necessary, of course, to level them. </li><li>  The original invented task was too simple.  We think. </li></ol><br><p>  But, actually, that's all.  Through the eyes of the development team it was three weeks of fierce hardcore.  On behalf of the developers, I want to thank the participants!  Without you, we would not get that much drive.  We participated in the championship on the other side of the screen with you!  Thanks you!  For you tried Maxim <a href="https://habrahabr.ru/users/xammi-1/" class="user_link">xammi-1</a> Kislenko, Boris <a href="https://habrahabr.ru/users/bkolganov/" class="user_link">bkolganov</a> Kolganov, Egor <a href="https://habrahabr.ru/users/geoolekom/" class="user_link">geoolekom</a> Komarov, Ilya <a href="https://habrahabr.ru/users/liofz/" class="user_link">liofz</a> Lebedev, Ilya <a href="https://habrahabr.ru/users/sat2707/" class="user_link">sat2707</a> Stytsenko. </p><br><p><img src="https://habrastorage.org/webt/kg/zf/wg/kgzfwgrfrue6v0s3hvkirjgmvj4.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/343032/">https://habr.com/ru/post/343032/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343020/index.html">Heisenbug 2017 Moscow Program Review: How many testers are needed to run tests at a nuclear power plant?</a></li>
<li><a href="../343022/index.html">Basics of React: everything you need to know to get started</a></li>
<li><a href="../343024/index.html">Seminar "Clouds for Critical Systems", November 30, St. Petersburg</a></li>
<li><a href="../343026/index.html">Stanford Courses "iOS Application Development" 2017 - voice acting in Russian</a></li>
<li><a href="../343030/index.html">Future release of symfony 4.0 and a project using symfony flex</a></li>
<li><a href="../343034/index.html">BDSL-2017: Tanya Bibikova on data visualization</a></li>
<li><a href="../343036/index.html">[Video] Java Jam: the truth about Java in Badoo, realtime coding under Vert.x, its own API and spring-starters</a></li>
<li><a href="../343040/index.html">This black-black friday</a></li>
<li><a href="../343042/index.html">How SAP quietly changed strategy for HANA and Oracle</a></li>
<li><a href="../343046/index.html">Dream job and entering a university without exams. Olympiad "I am a professional" track "Computer Science"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>