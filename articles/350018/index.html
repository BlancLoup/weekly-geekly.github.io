<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>You may not need Rust to speed up your JS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few weeks ago, I discovered the post "Oxidize Source Maps with Rust and WebAssembly" 
 spreading on Twitter and telling about performance gains from...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>You may not need Rust to speed up your JS</h1><div class="post__text post__text-html js-mediator-article"><p> A few weeks ago, I discovered the post <a href="https://hacks.mozilla.org/2018/01/oxidizing-source-maps-with-rust-and-webassembly/">"Oxidize Source Maps with Rust and WebAssembly"</a> <br>  spreading on Twitter and telling about performance gains from replacing regular JavaScript in the <code>source-map</code> library with Rust compiled into WebAssembly. </p><br><p>  Post excited my interest not because I was a big fan of Rust or WASM, rather because I was always interested in the features of languages ‚Äã‚Äãand optimizations that Javascript lacks in order to achieve similar performance. </p><br><p>  So I downloaded the library from GitHub and went into a little performance study, which I document here almost verbatim. </p><a name="habracut"></a><br><h1 id="soderzhanie">  Content </h1><br><ul><li>  <a href="https://habr.com/ru/post/350018/">Getting the code</a> </li><li>  <a href="https://habr.com/ru/post/350018/">We profile the version on pure JavaScript</a> </li><li>  <a href="https://habr.com/ru/post/350018/">Optimizing sorting - Adapting arguments</a> </li><li>  <a href="https://habr.com/ru/post/350018/">Optimizing sorting - Monomorphization</a> </li><li>  <a href="https://habr.com/ru/post/350018/">We optimize analysis - We delete a cache of segments</a> </li><li>  <a href="https://habr.com/ru/post/350018/">Optimizing sorting - Improvements in algorithms</a> </li><li>  <a href="https://habr.com/ru/post/350018/">Optimizing the sort of generatedMappings</a> </li><li>  <a href="https://habr.com/ru/post/350018/">Optimizing parsing - Reducing the load on the GC</a> </li><li>  <a href="https://habr.com/ru/post/350018/">Optimizing parsing - Using Uint8Array instead of string</a> </li><li>  <a href="https://habr.com/ru/post/350018/">General improvements from start</a> </li><li>  <a href="https://habr.com/ru/post/350018/">Comparison with the "oxidized" version of the source-map</a> </li><li>  <a href="https://habr.com/ru/post/350018/">Lessons learned</a> </li><li>  <a href="https://habr.com/ru/post/350018/">Afterword</a> </li></ul><br><h1 id="poluchenie-koda">  Getting the code </h1><br><p>  For my research, I use an <em>almost</em> standard x64.release V8 build, with <a href="https://chromium.googlesource.com/v8/v8/%2B/69abb960c97606df99408e6869d66e014aa0fb51">committer 69abb960c97606df99408e6869d66e014aa0fb51</a> of January 20th.  My discrepancy with the standard configuration is only that I turned on the disassembler through the GN-flags in order to dive deeper into the generated machine code, if necessary. </p><br><pre> <code class="hljs objectivec">‚ï≠‚îÄ ~/src/v8/v8 ‚Äπmaster‚Ä∫ ‚ï∞‚îÄ$ gn args <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.gn/x64.release --list --<span class="hljs-keyword"><span class="hljs-keyword">short</span></span> --overrides-only is_debug = <span class="hljs-literal"><span class="hljs-literal">false</span></span> target_cpu = <span class="hljs-string"><span class="hljs-string">"x64"</span></span> use_goma = <span class="hljs-literal"><span class="hljs-literal">true</span></span> v8_enable_disassembler = <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  Then I got the source code for the <a href="https://github.com/mozilla/source-map"><code>source-map</code></a> module from: </p><br><ul><li>  <a href="https://github.com/mozilla/source-map/commit/c97d38b70de088d87b051f81b95c138a74032a43">the c97d38b commit</a> , which was the last to update <code>dist/source-map.js</code> before the Rust / WASM implementation; </li><li>  <a href="https://github.com/mozilla/source-map/commit/51cf7708dd70d067dfe04ce36d546f3262b48da3">commit 51cf770</a> , which was the last commit at the time of the study; </li></ul><br><h1 id="profiliruem-versiyu-na-chistom-javascript">  We profile the version on pure JavaScript </h1><br><p>  Running the benchmark for a clean JS version was simple: </p><br><pre> <code class="hljs javascript">‚ï≠‚îÄ ~<span class="hljs-regexp"><span class="hljs-regexp">/src/</span></span>source-map/bench ‚Äπ c97d38b‚Ä∫ ‚ï∞‚îÄ$ d8 bench-shell-bindings.js Parsing source map <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4655.638000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4751.122000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4820.566000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4996.942000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4644.619000</span></span> [Stats samples: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">total</span></span>: <span class="hljs-number"><span class="hljs-number">23868</span></span> ms, <span class="hljs-attr"><span class="hljs-attr">mean</span></span>: <span class="hljs-number"><span class="hljs-number">4773.6</span></span> ms, <span class="hljs-attr"><span class="hljs-attr">stddev</span></span>: <span class="hljs-number"><span class="hljs-number">161.22112144505135</span></span> ms]</code> </pre> <br><p>  The first thing I did was turn off the serialization part of the benchmark: </p><br><pre> <code class="diff hljs">diff --git a/bench/bench-shell-bindings.js b/bench/bench-shell-bindings.js index 811df40..c97d38b 100644 --- a/bench/bench-shell-bindings.js +++ b/bench/bench-shell-bindings.js @@ -19,5 +19,5 @@ load("./bench.js"); print("Parsing source map"); print(benchmarkParseSourceMap()); print(); -print("Serializing source map"); -print(benchmarkSerializeSourceMap()); +// print("Serializing source map"); +// print(benchmarkSerializeSourceMap());</code> </pre> <br><p>  Then I threw it into the Linux <code>perf</code> profiler: </p><br><pre> <code class="hljs delphi">‚ï≠‚îÄ ~/src/source-map/bench ‚Äπperf-work‚Ä∫ ‚ï∞‚îÄ$ perf <span class="hljs-keyword"><span class="hljs-keyword">record</span></span> -g d8 --perf-basic-prof bench-shell-bindings.js Parsing source map console.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4984.464000</span></span> ^C[ perf <span class="hljs-keyword"><span class="hljs-keyword">record</span></span>: Woken up <span class="hljs-number"><span class="hljs-number">90</span></span> times <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> data ] [ perf <span class="hljs-keyword"><span class="hljs-keyword">record</span></span>: Captured <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> wrote <span class="hljs-number"><span class="hljs-number">24.659</span></span> MB perf.data (~<span class="hljs-number"><span class="hljs-number">1077375</span></span> samples) ]</code> </pre> <br><p>  Notice that I pass the <code>--perf-basic-prof</code> flag to the <code>d8</code> binary, which causes V8 to generate an auxiliary mapping file <code>/tmp/perf-$pid.map</code> .  This file allows <code>perf report</code> to understand JIT-generated machine code. </p><br><p>  This is what I get from the <code>perf report --no-children</code> later when viewing the main thread of performance: </p><br><pre> <code class="hljs cpp">Overhead Symbol <span class="hljs-number"><span class="hljs-number">17.02</span></span>% *doQuickSort ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">2752</span></span> <span class="hljs-number"><span class="hljs-number">11.20</span></span>% Builtin:ArgumentsAdaptorTrampoline <span class="hljs-number"><span class="hljs-number">7.17</span></span>% *compareByOriginalPositions ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-number"><span class="hljs-number">4.49</span></span>% Builtin:CallFunction_ReceiverIsNullOrUndefined <span class="hljs-number"><span class="hljs-number">3.58</span></span>% *compareByGeneratedPositionsDeflated ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1063</span></span> <span class="hljs-number"><span class="hljs-number">2.73</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> <span class="hljs-number"><span class="hljs-number">2.11</span></span>% Builtin:StringEqual <span class="hljs-number"><span class="hljs-number">1.93</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> <span class="hljs-number"><span class="hljs-number">1.66</span></span>% *doQuickSort ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">2752</span></span> <span class="hljs-number"><span class="hljs-number">1.25</span></span>% v8::internal::StringTable::LookupStringIfExists_NoAllocate <span class="hljs-number"><span class="hljs-number">1.22</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> <span class="hljs-number"><span class="hljs-number">1.21</span></span>% Builtin:StringCharAt <span class="hljs-number"><span class="hljs-number">1.16</span></span>% Builtin:Call_ReceiverIsNullOrUndefined <span class="hljs-number"><span class="hljs-number">1.14</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::StringTableNoAllocateKey::IsMatch <span class="hljs-number"><span class="hljs-number">0.90</span></span>% Builtin:StringPrototypeSlice <span class="hljs-number"><span class="hljs-number">0.86</span></span>% Builtin:KeyedLoadIC_Megamorphic <span class="hljs-number"><span class="hljs-number">0.82</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::MakeStringThin <span class="hljs-number"><span class="hljs-number">0.80</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::CopyObjectToObjectElements <span class="hljs-number"><span class="hljs-number">0.76</span></span>% v8::internal::Scavenger::ScavengeObject <span class="hljs-number"><span class="hljs-number">0.72</span></span>% v8::internal::String::VisitFlat&lt;v8::internal::IteratingStringHasher&gt; <span class="hljs-number"><span class="hljs-number">0.68</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> <span class="hljs-number"><span class="hljs-number">0.64</span></span>% *doQuickSort ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">2752</span></span> <span class="hljs-number"><span class="hljs-number">0.56</span></span>% v8::internal::IncrementalMarking::RecordWriteSlow</code> </pre> <br><p>  Indeed, as mentioned in the post <a href="https://hacks.mozilla.org/2018/01/oxidizing-source-maps-with-rust-and-webassembly/">‚ÄúOxidize Source Maps ...‚Äù</a> , this benchmark basically loads sorting: the <code>doQuickSort</code> function appears on the top of the profile, and also several times lower in the list (which means that it has been optimized and deoptimized several times) . </p><br><h1 id="optimiziruem-sortirovku--adaptaciya-argumentov">  We optimize sorting - adaptation of arguments </h1><br><p>  One thing that stands out in the profiler is suspicious entries, namely <code>Builtin:ArgumentsAdaptorTrampoline</code> and <code>Builtin:CallFunction_ReceiverIsNullOrUndefined</code> , which seem to be part of the V8 implementation.  If we ask <code>perf report</code> to reveal the call chains leading to them, we note that these functions are mainly called from the sort code: </p><br><pre> <code class="hljs swift">- <span class="hljs-type"><span class="hljs-type">Builtin</span></span>:<span class="hljs-type"><span class="hljs-type">ArgumentsAdaptorTrampoline</span></span> + <span class="hljs-number"><span class="hljs-number">96.87</span></span>% *doQuickSort ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">2752</span></span> + <span class="hljs-number"><span class="hljs-number">1.22</span></span>% *<span class="hljs-type"><span class="hljs-type">SourceMapConsumer_parseMappings</span></span> ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> + <span class="hljs-number"><span class="hljs-number">0.68</span></span>% *<span class="hljs-type"><span class="hljs-type">SourceMapConsumer_parseMappings</span></span> ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> + <span class="hljs-number"><span class="hljs-number">0.68</span></span>% <span class="hljs-type"><span class="hljs-type">Builtin</span></span>:<span class="hljs-type"><span class="hljs-type">InterpreterEntryTrampoline</span></span> + <span class="hljs-number"><span class="hljs-number">0.55</span></span>% *doQuickSort ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">2752</span></span> - <span class="hljs-type"><span class="hljs-type">Builtin</span></span>:<span class="hljs-type"><span class="hljs-type">CallFunction_ReceiverIsNullOrUndefined</span></span> + <span class="hljs-number"><span class="hljs-number">93.88</span></span>% *doQuickSort ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">2752</span></span> + <span class="hljs-number"><span class="hljs-number">2.24</span></span>% *<span class="hljs-type"><span class="hljs-type">SourceMapConsumer_parseMappings</span></span> ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> + <span class="hljs-number"><span class="hljs-number">2.01</span></span>% <span class="hljs-type"><span class="hljs-type">Builtin</span></span>:<span class="hljs-type"><span class="hljs-type">InterpreterEntryTrampoline</span></span> + <span class="hljs-number"><span class="hljs-number">1.49</span></span>% *<span class="hljs-type"><span class="hljs-type">SourceMapConsumer_parseMappings</span></span> ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span></code> </pre> <br><p>  And here is the time to look at the code.  The quick sort implementation is located in <a href=""><code>lib/quick-sort.js</code></a> and is called from the parser code in <a href=""><code>lib/source-map-consumer.js</code></a> . <br>  The comparison functions (comparators) used for sorting are <a href=""><code>compareByGeneratedPositionsDeflated</code></a> and <a href=""><code>compareByOriginalPositions</code></a> . </p><br><p>  Looking at the definitions of these comparison functions and on the way they are called in the quick sort implementation, it turns out that the call sites have a different arity: </p><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compareByOriginalPositions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mappingA, mappingB, onlyCompareOriginal)</span></span></span></span> { // ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compareByGeneratedPositionsDeflated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mappingA, mappingB, onlyCompareGenerated)</span></span></span></span> { // ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doQuickSort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ary, comparator, p, r)</span></span></span></span> { // ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (comparator(ary[j], pivot) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { // ... } // ... }</code> </pre> <br><p>  Browsing library sources shows that, outside of tests, <code>quickSort</code> is called only with these two functions. </p><br><p>  What if we correct the arity? </p><br><pre> <code class="diff hljs">diff --git a/dist/source-map.js b/dist/source-map.js index ade5bb2..2d39b28 100644 --- a/dist/source-map.js +++ b/dist/source-map.js @@ -2779,7 +2779,7 @@ return /* **** */ (function(modules) { // webpackBootstrap // // * Every element in `ary[i+1 .. j-1]` is greater than the pivot. for (var j = p; j &lt; r; j++) { - if (comparator(ary[j], pivot) &lt;= 0) { + if (comparator(ary[j], pivot, false) &lt;= 0) { i += 1; swap(ary, i, j); }</code> </pre> <br><p>  <sub>[Note: I am editing directly to <code>dist/source-map.js</code> because I didn‚Äôt want to waste time on the build process]</sub> </p><br><pre> <code class="hljs javascript">‚ï≠‚îÄ ~<span class="hljs-regexp"><span class="hljs-regexp">/src/</span></span>source-map/bench ‚Äπperf-work‚Ä∫ [Fix comparator invocation arity] ‚ï∞‚îÄ$ d8 bench-shell-bindings.js Parsing source map <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4037.084000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4249.258000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4241.165000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">3936.664000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4131.844000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4140.963000</span></span> [Stats samples: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-attr"><span class="hljs-attr">total</span></span>: <span class="hljs-number"><span class="hljs-number">24737</span></span> ms, <span class="hljs-attr"><span class="hljs-attr">mean</span></span>: <span class="hljs-number"><span class="hljs-number">4122.833333333333</span></span> ms, <span class="hljs-attr"><span class="hljs-attr">stddev</span></span>: <span class="hljs-number"><span class="hljs-number">132.18789657150916</span></span> ms]</code> </pre> <br><p>  By simply correcting the arity mismatch, we improved the V8 values ‚Äã‚Äãin the benchmark by 14% from 4774 ms to 4123 ms.  If we profile the benchmark again, we will find that the <code>ArgumentsAdaptorTrampoline</code> completely disappeared from there.  So why was he there for the first time? </p><br><p>  It turns out that <code>ArgumentsAdaptorTrampoline</code> is a V8 mechanism for supporting javascript script variability: you can call a function from three arguments with only two - in this case the third argument will be filled with the value <code>undefined</code> .  V8 does this by creating a new frame on the stack, copying the arguments there, then calling the target function: </p><br><p><img src="https://habrastorage.org/webt/bm/yt/sp/bmytspd4x3u5ymtabc26hcvbj9a.png" alt="Argument adaptation"></p><br><p>  <sub>[If you‚Äôve never heard of a <em>performance stack</em> , check out <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B5%25D0%25BA_%25D0%25B2%25D1%258B%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B2">Wikipedia</a> and the <a href="https://fhinkel.rocks/2017/10/30/Confused-about-Stack-and-Heap/">post of</a> Francis Hinkelmann.]</sub> <sub><br></sub> </p><br><p>  While such costs may be insignificant for a cold code, here the <code>comparator</code> was called a million times during the launch of the benchmark, which caused additional costs for the adaptation of the arguments. </p><br><p>  An attentive reader may also notice that we explicitly pass <code>false</code> to where previously implicit <code>undefined</code> .  This also seems to contribute to improved performance.  If we replace <code>false</code> with <code>void 0</code> , we get slightly worse values: </p><br><pre> <code class="hljs bash">diff --git a/dist/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-map.js b/dist/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-map.js index 2d39b28..243b2ef 100644 --- a/dist/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-map.js +++ b/dist/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-map.js @@ -2779,7 +2779,7 @@ <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> /* **** */ (<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(modules) { // webpackBootstrap // // * Every element <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> `ary[i+1 .. j-1]` is greater than the pivot. <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var j = p; j &lt; r; j++) { - <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (comparator(ary[j], pivot, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) &lt;= 0) { + <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (comparator(ary[j], pivot, void 0) &lt;= 0) { i += 1; swap(ary, i, j); }</code> </pre> <br><pre> <code class="hljs javascript">‚ï≠‚îÄ ~<span class="hljs-regexp"><span class="hljs-regexp">/src/</span></span>source-map/bench ‚Äπperf-work U‚Ä∫ [Fix comparator invocation arity] ‚ï∞‚îÄ$ ~<span class="hljs-regexp"><span class="hljs-regexp">/src/</span></span>v8/v8/out.gn/x64.release/d8 bench-shell-bindings.js Parsing source map <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4215.623000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4247.643000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4425.871000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4167.691000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4343.613000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">4209.427000</span></span> [Stats samples: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-attr"><span class="hljs-attr">total</span></span>: <span class="hljs-number"><span class="hljs-number">25610</span></span> ms, <span class="hljs-attr"><span class="hljs-attr">mean</span></span>: <span class="hljs-number"><span class="hljs-number">4268.333333333333</span></span> ms, <span class="hljs-attr"><span class="hljs-attr">stddev</span></span>: <span class="hljs-number"><span class="hljs-number">106.38947316346669</span></span> ms]</code> </pre> <br><p>  Be that as it may, the adaptation of the arguments seems very specific to the V8.  When I ran the benchmark for SpiderMonkey, I did not see any significant performance gain from matching arity: </p><br><pre> <code class="hljs vhdl">‚ï≠‚îÄ ~/src/source-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span>/bench ‚Äπ d052ea4‚Ä∫ [Disabled serialization part <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the benchmark] ‚ï∞‚îÄ$ sm bench-shell-bindings.js Parsing source <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> [Stats samples: <span class="hljs-number"><span class="hljs-number">8</span></span>, total: <span class="hljs-number"><span class="hljs-number">24751</span></span> ms, mean: <span class="hljs-number"><span class="hljs-number">3093.875</span></span> ms, stddev: <span class="hljs-number"><span class="hljs-number">327.27966571700836</span></span> ms] ‚ï≠‚îÄ ~/src/source-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span>/bench ‚Äπperf-work‚Ä∫ [Fix comparator invocation arity] ‚ï∞‚îÄ$ sm bench-shell-bindings.js Parsing source <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> [Stats samples: <span class="hljs-number"><span class="hljs-number">8</span></span>, total: <span class="hljs-number"><span class="hljs-number">25397</span></span> ms, mean: <span class="hljs-number"><span class="hljs-number">3174.625</span></span> ms, stddev: <span class="hljs-number"><span class="hljs-number">360.4636187025859</span></span> ms]</code> </pre> <br><p>  <sub>[The SpiderMonkey shell is now very easy to install, thanks to Matthias Bayens for the <a href="https://github.com/GoogleChromeLabs/jsvu">jsvu tool</a> ]</sub> </p><br><p>  Let's go back to the sort code.  If we populate the benchmark again, we notice that the <code>ArgumentsAdaptorTrampoline</code> disappeared from the profile, but <code>CallFunction_ReceiverIsNullOrUndefined</code> is still here.  This is not surprising, because we still call the <code>comparator</code> . </p><br><h1 id="optimiziruem-sortirovku---monomorfizaciya">  Optimizing sorting - Monomorphization </h1><br><p>  What usually executes faster than a function call?  His absence! </p><br><p>  The obvious option here is to try to embed the comparison function in <code>doQuickSort</code> .  However, we are getting in the way of the fact that <code>doQuickSort</code> is called with different functions. </p><br><p>  To get around this, we will try to monomorphize <code>doQuickSort</code> by cloning.  Here is how we do it. </p><br><p>  Let's start with wrapping <code>doQuickSort</code> and other utility tools in the <code>SortTemplate</code> function: </p><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SortTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comparator)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">swap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ary, x, y)</span></span></span></span> { // ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randomIntInRange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(low, high)</span></span></span></span> { // ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doQuickSort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ary, p, r)</span></span></span></span> { // ... } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> doQuickSort; }</code> </pre> <br><p>  Then we will be able to produce clones of our sorting procedures by converting the <code>SortTemplate</code> to a string, passing it and parsing it back to a function through the <code>Function</code> constructor: </p><br><pre> <code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cloneSort</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">comparator</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> template = SortTemplate.toString(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> templateFn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Function</span></span>(<span class="hljs-string"><span class="hljs-string">`return </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${template}</span></span></span><span class="hljs-string">`</span></span>)(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> templateFn(comparator); <span class="hljs-comment"><span class="hljs-comment">// Invoke template to get doQuickSort }</span></span></code> </pre> <br><p>  Now we can use <code>cloneSort</code> to produce a sort function for each comparator used: </p><br><pre> <code class="hljs lua">let sortCache = new WeakMap(); // Cache <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> specialized sorts. exports.quickSort = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ary, comparator)</span></span></span></span> { let doQuickSort = sortCache.get(comparator); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (doQuickSort === void <span class="hljs-number"><span class="hljs-number">0</span></span>) { doQuickSort = cloneSort(comparator); sortCache.set(comparator, doQuickSort); } doQuickSort(ary, <span class="hljs-number"><span class="hljs-number">0</span></span>, ary.length - <span class="hljs-number"><span class="hljs-number">1</span></span>); };</code> </pre> <br><p>  Restarting the benchmark gives us: </p><br><pre> <code class="hljs javascript">‚ï≠‚îÄ ~<span class="hljs-regexp"><span class="hljs-regexp">/src/</span></span>source-map/bench ‚Äπperf-work‚Ä∫ [Clone sorting functions <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> each comparator] ‚ï∞‚îÄ$ d8 bench-shell-bindings.js Parsing source map <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">2955.199000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">3084.979000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">3193.134000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">3480.459000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">3115.011000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">3216.344000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">3343.459000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.timeEnd: iteration, <span class="hljs-number"><span class="hljs-number">3036.211000</span></span> [Stats samples: <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-attr"><span class="hljs-attr">total</span></span>: <span class="hljs-number"><span class="hljs-number">25423</span></span> ms, <span class="hljs-attr"><span class="hljs-attr">mean</span></span>: <span class="hljs-number"><span class="hljs-number">3177.875</span></span> ms, <span class="hljs-attr"><span class="hljs-attr">stddev</span></span>: <span class="hljs-number"><span class="hljs-number">181.87633161024556</span></span> ms]</code> </pre> <br><p>  We see that the average time has dropped from 4268 ms to 3177 ms (25% improvement). </p><br><p>  Profiling shows the following picture: </p><br><pre> <code class="hljs cpp"> Overhead Symbol <span class="hljs-number"><span class="hljs-number">14.95</span></span>% *doQuickSort :<span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">11.49</span></span>% *doQuickSort :<span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">3.29</span></span>% Builtin:StringEqual <span class="hljs-number"><span class="hljs-number">3.13</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> <span class="hljs-number"><span class="hljs-number">1.86</span></span>% v8::internal::StringTable::LookupStringIfExists_NoAllocate <span class="hljs-number"><span class="hljs-number">1.86</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> <span class="hljs-number"><span class="hljs-number">1.72</span></span>% Builtin:StringCharAt <span class="hljs-number"><span class="hljs-number">1.67</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> <span class="hljs-number"><span class="hljs-number">1.61</span></span>% v8::internal::Scavenger::ScavengeObject <span class="hljs-number"><span class="hljs-number">1.45</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::StringTableNoAllocateKey::IsMatch <span class="hljs-number"><span class="hljs-number">1.23</span></span>% Builtin:StringPrototypeSlice <span class="hljs-number"><span class="hljs-number">1.17</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::MakeStringThin <span class="hljs-number"><span class="hljs-number">1.08</span></span>% Builtin:KeyedLoadIC_Megamorphic <span class="hljs-number"><span class="hljs-number">1.05</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::CopyObjectToObjectElements <span class="hljs-number"><span class="hljs-number">0.99</span></span>% v8::internal::String::VisitFlat&lt;v8::internal::IteratingStringHasher&gt; <span class="hljs-number"><span class="hljs-number">0.86</span></span>% clear_page_c_e <span class="hljs-number"><span class="hljs-number">0.77</span></span>% v8::internal::IncrementalMarking::RecordWriteSlow <span class="hljs-number"><span class="hljs-number">0.48</span></span>% Builtin:MathRandom <span class="hljs-number"><span class="hljs-number">0.41</span></span>% Builtin:RecordWrite <span class="hljs-number"><span class="hljs-number">0.39</span></span>% Builtin:KeyedLoadIC</code> </pre> <br><p>  The overhead costs associated with calling the <code>comparator</code> now completely disappeared from the profile. </p><br><p>  At this point, I wondered how much more time we spend on <em>parsing</em> mappings compared to <em>sorting</em> them.  I went to the parsing code and added a few calls to <code>Date.now()</code> : </p><br><p>  <sub>[I‚Äôd like to add <code>performance.now()</code> , but SpiderMonkey doesn‚Äôt support this.]</sub> </p><br><pre> <code class="diff hljs">diff --git a/dist/source-map.js b/dist/source-map.js index 75ebbdf..7312058 100644 --- a/dist/source-map.js +++ b/dist/source-map.js @@ -1906,6 +1906,8 @@ return /* **** */ (function(modules) { // webpackBootstrap var generatedMappings = []; var mapping, str, segment, end, value; + + var startParsing = Date.now(); while (index &lt; length) { if (aStr.charAt(index) <span class="hljs-comment"><span class="hljs-comment">=== ';') { generatedLine++; @@ -1986,12 +1988,20 @@ return /* **** */ (function(modules) { // webpackBootstrap } } } + var endParsing = Date.now(); + var startSortGenerated = Date.now(); quickSort(generatedMappings, util.compareByGeneratedPositionsDeflated); this.__generatedMappings = generatedMappings; + var endSortGenerated = Date.now(); + var startSortOriginal = Date.now(); quickSort(originalMappings, util.compareByOriginalPositions); this.__originalMappings = originalMappings; + var endSortOriginal = Date.now(); + + console.log(`${}, ${endSortGenerated - startSortGenerated}, ${endSortOriginal - startSortOriginal}`); + console.log(`sortGenerated: `); + console.log(`sortOriginal: `); };</span></span></code> </pre> <br><p>  The result was the following: </p><br><pre> <code class="hljs pgsql">‚ï≠‚îÄ ~/src/source-map/bench ‚Äπperf-<span class="hljs-keyword"><span class="hljs-keyword">work</span></span> U‚Ä∫ [Clone sorting <span class="hljs-keyword"><span class="hljs-keyword">functions</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> comparator] ‚ï∞‚îÄ$ d8 bench-shell-bindings.js Parsing source map parse: <span class="hljs-number"><span class="hljs-number">1911.846</span></span> sortGenerated: <span class="hljs-number"><span class="hljs-number">619.5990000000002</span></span> sortOriginal: <span class="hljs-number"><span class="hljs-number">905.8220000000001</span></span> parse: <span class="hljs-number"><span class="hljs-number">1965.4820000000004</span></span> sortGenerated: <span class="hljs-number"><span class="hljs-number">602.1939999999995</span></span> sortOriginal: <span class="hljs-number"><span class="hljs-number">896.3589999999995</span></span> ^C</code> </pre> <br><p>  And so the parsing and sorting times look in V8 and SpiderMonkey for each iteration of the benchmark launch: </p><br><p><img src="https://habrastorage.org/webt/f6/09/2y/f6092yvornc_6eo_rsfjbuvr4_c.png" alt="Parse and Sort times"></p><br><p>  In V8, we seem to spend about as much time analyzing the mappings as we did on sorting them.  In SpiderMonkey, parsing is much faster - but slower sorting.  It made me look at the parsing code. </p><br><h1 id="optimiziruem-razbor---udalyaem-kesh-segmentov">  We optimize analysis - We delete a cache of segments </h1><br><p>  Let's look at the profile again: </p><br><pre> <code class="hljs cpp">Overhead Symbol <span class="hljs-number"><span class="hljs-number">18.23</span></span>% *doQuickSort :<span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">12.36</span></span>% *doQuickSort :<span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">3.84</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> <span class="hljs-number"><span class="hljs-number">3.07</span></span>% Builtin:StringEqual <span class="hljs-number"><span class="hljs-number">1.92</span></span>% v8::internal::StringTable::LookupStringIfExists_NoAllocate <span class="hljs-number"><span class="hljs-number">1.85</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> <span class="hljs-number"><span class="hljs-number">1.59</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> <span class="hljs-number"><span class="hljs-number">1.54</span></span>% Builtin:StringCharAt <span class="hljs-number"><span class="hljs-number">1.52</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::StringTableNoAllocateKey::IsMatch <span class="hljs-number"><span class="hljs-number">1.38</span></span>% v8::internal::Scavenger::ScavengeObject <span class="hljs-number"><span class="hljs-number">1.27</span></span>% Builtin:KeyedLoadIC_Megamorphic <span class="hljs-number"><span class="hljs-number">1.22</span></span>% Builtin:StringPrototypeSlice <span class="hljs-number"><span class="hljs-number">1.10</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::MakeStringThin <span class="hljs-number"><span class="hljs-number">1.05</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::CopyObjectToObjectElements <span class="hljs-number"><span class="hljs-number">1.03</span></span>% v8::internal::String::VisitFlat&lt;v8::internal::IteratingStringHasher&gt; <span class="hljs-number"><span class="hljs-number">0.88</span></span>% clear_page_c_e <span class="hljs-number"><span class="hljs-number">0.51</span></span>% Builtin:MathRandom <span class="hljs-number"><span class="hljs-number">0.48</span></span>% Builtin:KeyedLoadIC <span class="hljs-number"><span class="hljs-number">0.46</span></span>% v8::internal::IteratingStringHasher::Hash <span class="hljs-number"><span class="hljs-number">0.41</span></span>% Builtin:RecordWrite</code> </pre> <br><p>  Removing the JavaScript code that we already know leaves us with the following: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Overhead</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Symbol</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.07</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">Builtin</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:StringEqual</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.92</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">v8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::internal</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::StringTable</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::LookupStringIfExists_NoAllocate</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.54</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">Builtin</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:StringCharAt</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.52</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">v8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::internal</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::(anonymous</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">namespace</span></span>)<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::StringTableNoAllocateKey</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::IsMatch</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.38</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">v8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::internal</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Scavenger</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::ScavengeObject</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.27</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">Builtin</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:KeyedLoadIC_Megamorphic</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.22</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">Builtin</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:StringPrototypeSlice</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">v8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::internal</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::(anonymous</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">namespace</span></span>)<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::MakeStringThin</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.05</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">v8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::internal</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::(anonymous</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">namespace</span></span>)<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::CopyObjectToObjectElements</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.03</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">v8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::internal</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::String</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::VisitFlat</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">v8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::internal</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::IteratingStringHasher</span></span>&gt; 0<span class="hljs-selector-class"><span class="hljs-selector-class">.88</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">clear_page_c_e</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.51</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">Builtin</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:MathRandom</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.48</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">Builtin</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:KeyedLoadIC</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.46</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">v8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::internal</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::IteratingStringHasher</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Hash</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.41</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">Builtin</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:RecordWrite</span></span></code> </pre> <br><p>  When I began to look at the call chains for individual entries, I found that quite a few of them go through <code>KeyedLoadIC_Megamorphic</code> in <code>SourceMapConsumer_parseMappings</code> . </p><br><pre> <code class="hljs cpp">- <span class="hljs-number"><span class="hljs-number">1.92</span></span>% v8::internal::StringTable::LookupStringIfExists_NoAllocate - v8::internal::StringTable::LookupStringIfExists_NoAllocate + <span class="hljs-number"><span class="hljs-number">99.80</span></span>% Builtin:KeyedLoadIC_Megamorphic - <span class="hljs-number"><span class="hljs-number">1.52</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::StringTableNoAllocateKey::IsMatch - v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::StringTableNoAllocateKey::IsMatch - <span class="hljs-number"><span class="hljs-number">98.32</span></span>% v8::internal::StringTable::LookupStringIfExists_NoAllocate + Builtin:KeyedLoadIC_Megamorphic + <span class="hljs-number"><span class="hljs-number">1.68</span></span>% Builtin:KeyedLoadIC_Megamorphic - <span class="hljs-number"><span class="hljs-number">1.27</span></span>% Builtin:KeyedLoadIC_Megamorphic - Builtin:KeyedLoadIC_Megamorphic + <span class="hljs-number"><span class="hljs-number">57.65</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> + <span class="hljs-number"><span class="hljs-number">22.62</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> + <span class="hljs-number"><span class="hljs-number">15.91</span></span>% *SourceMapConsumer_parseMappings ../dist/source-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.js:<span class="hljs-number"><span class="hljs-number">1894</span></span> + <span class="hljs-number"><span class="hljs-number">2.46</span></span>% Builtin:InterpreterEntryTrampoline + <span class="hljs-number"><span class="hljs-number">0.61</span></span>% BytecodeHandler:Mul + <span class="hljs-number"><span class="hljs-number">0.57</span></span>% *doQuickSort :<span class="hljs-number"><span class="hljs-number">44</span></span> - <span class="hljs-number"><span class="hljs-number">1.10</span></span>% v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::MakeStringThin - v8::internal::(anonymous <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>)::MakeStringThin - <span class="hljs-number"><span class="hljs-number">94.72</span></span>% v8::internal::StringTable::LookupStringIfExists_NoAllocate + Builtin:KeyedLoadIC_Megamorphic + <span class="hljs-number"><span class="hljs-number">3.63</span></span>% Builtin:KeyedLoadIC_Megamorphic + <span class="hljs-number"><span class="hljs-number">1.66</span></span>% v8::internal::StringTable::LookupString</code> </pre> <br><p>  This sorting of call stacks signaled to me that the code executes multiple key mappings in the form of <code>obj[key]</code> , where <code>key</code> is a dynamically generated string.  When I looked at the source, I found the <a href="">following code</a> : </p><br><pre> <code class="hljs perl">// Because <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> offset is encoded relative to the previous one, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> many segments often have the same encoding. We can exploit this // fact by caching the parsed variable <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> fields of <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> segment, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> allowing us to avoid a second parse <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> we encounter the same // segment again. <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (end = <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>; end &lt; <span class="hljs-keyword"><span class="hljs-keyword">length</span></span>; end++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this._charIsMappingSeparator(aStr, end)) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } str = aStr.slice(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>, end); segment = cachedSegments[str]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segment) { <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> += str.length; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { segment = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> &lt; end) { base64VLQ.decode(aStr, <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>, temp); value = temp.value; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = temp.rest; segment.push(value); } // ... cachedSegments[str] = segment; }</code> </pre> <br><p>  This code is responsible for decoding Base64 VLQ-coded sequences, that is, line <code>A</code> will be decoded as <code>[0]</code> , and <code>UAAAA</code> decoded into <code>[10,0,0,0,0]</code> .  I suggest looking at <a href="https://blogs.msdn.microsoft.com/davidni/2016/03/14/source-maps-under-the-hood-vlq-base64-and-yoda/">this post</a> about source maps inside, if you want to better understand the coding process itself. </p><br><p>  Instead of decoding each sequence independently, this code tries to cache decrypted segments: looks ahead to the separator ( <code>,</code> or <code>;</code> ), then extracts the substring from the current position to the separator and checks if we already have such a segment in the cache - and if so , then returns the cached segment, otherwise, it parses it and puts it in the cache. </p><br><p>  Caching (it‚Äôs also <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D0%25BC%25D0%25BE%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">memoisation</a> ) is a very powerful optimization technique - however, it only makes sense if the maintenance of the cache itself and the search for results there turn out to be cheaper than the actual calculation itself again. </p><br><h2 id="abstraktnyy-analiz">  Abstract analysis </h2><br><p>  Let's try to abstractly compare these two operations: </p><br><p>  <strong>On the one hand, a pure analysis:</strong> </p><br><p>  When analyzing a segment, we look at each symbol once.  For each symbol, several comparisons and arithmetic operations are performed in order to convert the base64 character to an integer value.  Then several bitwise operations are performed to combine these numerical values ‚Äã‚Äãinto one large one.  Then the declassified value is saved into an array and we move to the next part of the segment.  Segments are limited to five elements. </p><br><p>  <strong>On the other hand, caching:</strong> </p><br><ol><li>  To find a cached value, we go around all the characters of a segment once to find its end; </li><li>  We extract the substring that requires placement and, possibly, copying, depending on how the strings are implemented in the JS VM. </li><li>  We use this line as a key for a dictionary that: <br><ol><li>  It first requires the VM to calculate the hash for this string (by passing it again and performing various bitwise operations on characters), this may also require the VM to internalize the string (depending on the implementation). </li><li>  The VM must then perform a hash mapping on the table, which requires accessing and comparing the key by value with other keys (this may require viewing the individual characters again); </li></ol></li></ol><br><p>  In general, it looks like direct parsing will be faster, implying that the JS VM works well with separate arithmetic and bitwise operations, simply because it looks at each character only once, while caching requires 2-4 times traversal , just to establish whether we got into the cache or not. </p><br><p>  Profiling seems to confirm this too: <code>KeyedLoadIC_Megamorphic</code> used in V8 to implement <code>cachedSegments[str]</code> , like <code>cachedSegments[str]</code> in the code above. </p><br><p>  Based on these observations, I conducted several experiments.  First, I checked how big the <code>cachedSegments</code> cache <code>cachedSegments</code> at the end of parsing.  The smaller it is, the more efficient the caching could be. </p><br><p>  It turns out that he grows up quite strongly: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>.keys(cachedSegments).length = <span class="hljs-number"><span class="hljs-number">155478</span></span></code> </pre> <br><h2 id="otdelnye-mikrobenchmarki">  Selected microbench marks </h2><br><p>  Now I decided to write a small separate benchmark: </p><br><pre> <code class="hljs lua">//    [n] ,      [v], // ..  <span class="hljs-number"><span class="hljs-number">0</span></span>, v, <span class="hljs-number"><span class="hljs-number">2</span></span>*v, ... ,     <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> + v, <span class="hljs-number"><span class="hljs-number">1</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>*v, ... // [base]      -    //    // // :   [v],    [cachedSegments] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n, v, base)</span></span></span></span> { var arr = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; n; i++) { arr.push([<span class="hljs-number"><span class="hljs-number">0</span></span>, base + (i % v), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>].map(base64VLQ.encode).join(<span class="hljs-string"><span class="hljs-string">''</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arr.join(<span class="hljs-string"><span class="hljs-string">';'</span></span>) + <span class="hljs-string"><span class="hljs-string">';'</span></span>; } //   [f]   [str]. <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bench</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f, str)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1000</span></span>; i++) { f(str); } } //     [f]  [str]. //    [v]   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">measure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(v, str, f)</span></span></span></span> { var start = Date.now(); bench(f, str); var <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> = Date.now(); report(`${v}, ${f.name}, ${(<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> - start).toFixed(<span class="hljs-number"><span class="hljs-number">2</span></span>)}`); } async <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">measureAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (let v = <span class="hljs-number"><span class="hljs-number">1</span></span>; v &lt;= <span class="hljs-number"><span class="hljs-number">256</span></span>; v *= <span class="hljs-number"><span class="hljs-number">2</span></span>) { //    <span class="hljs-number"><span class="hljs-number">1000</span></span>     [v] , //   [cachedSegments]   [v]  . let str = makeString(<span class="hljs-number"><span class="hljs-number">1000</span></span>, v, <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>); let arr = encoder.encode(str); //  <span class="hljs-number"><span class="hljs-number">10</span></span>     . <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; j++) { measure(j, i, str, decodeCached); measure(j, i, str, decodeNoCaching); measure(j, i, str, decodeNoCachingNoStrings); measure(j, i, arr, decodeNoCachingNoStringsPreEncoded); await nextTick(); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextTick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new Promise((resolve) =&gt; setTimeout(resolve)); }</code> </pre> <br><p>        Base64 VLQ,   . </p><br><p>  ‚Äî <code>decodeCached</code>    ,      <code>source-map</code> ‚Äî     : </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> decodeCached(aStr) { var length = aStr.length; var cachedSegments = {}; var <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, str, segment, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span> = {<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, rest: <span class="hljs-number"><span class="hljs-number">0</span></span>}; const decode = base64VLQ.decode; var <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> &lt; length) { // Because <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> encoded relative <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the previous one, // many segments often have the same <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>. We can exploit this // fact <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> caching the parsed variable length fields <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> segment, // allowing us <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> avoid a second parse <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> we encounter the same // segment again. <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (end = <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> &lt; length; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_charIsMappingSeparator(aStr, <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>)) { break; } } str = aStr.<span class="hljs-keyword"><span class="hljs-keyword">slice</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>); segment = cachedSegments[str]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segment) { <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> += str.length; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { segment = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) { decode(aStr, <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>.rest; segment.push(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segment.length === <span class="hljs-number"><span class="hljs-number">2</span></span>) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Error(<span class="hljs-string"><span class="hljs-string">'Found a source, but no line and column'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segment.length === <span class="hljs-number"><span class="hljs-number">3</span></span>) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Error(<span class="hljs-string"><span class="hljs-string">'Found a source and line, but no column'</span></span>); } cachedSegments[str] = segment; } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>++; } }</code> </pre> <br><p>   ‚Äî  <code>decodeNoCaching</code> .     ,   <code>decodeCached</code> ,   .    .    <code>Array</code>  <code>Int32Array</code>   <code>segment</code> . </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> decodeNoCaching(aStr) { var length = aStr.length; var cachedSegments = {}; var <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, str, segment, <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span> = {<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, rest: <span class="hljs-number"><span class="hljs-number">0</span></span>}; const decode = base64VLQ.decode; var <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; var segment = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Int32Array(<span class="hljs-number"><span class="hljs-number">5</span></span>); var segmentLength = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> &lt; length) { segmentLength = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!_charIsMappingSeparator(aStr, <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>)) { decode(aStr, <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>.rest; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segmentLength &gt;= <span class="hljs-number"><span class="hljs-number">5</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Error(<span class="hljs-string"><span class="hljs-string">'Too many segments'</span></span>); segment[segmentLength++] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segmentLength === <span class="hljs-number"><span class="hljs-number">2</span></span>) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Error(<span class="hljs-string"><span class="hljs-string">'Found a source, but no line and column'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segmentLength === <span class="hljs-number"><span class="hljs-number">3</span></span>) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Error(<span class="hljs-string"><span class="hljs-string">'Found a source and line, but no column'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>++; } }</code> </pre> <br><p> , ,   <code>decodeNoCachingNoString</code>     JavaScript- ,     utf8- <code>Uint8Array</code> .    , ,  , JS VM        .  <code>String.prototype.charCodeAt</code>      ,      ,  JS VM. </p><br><p>     :       utf8   ,        .    ""    ,      ,      <em>typed array ‚áí string ‚áí typed array</em> .    ,     source map   array buffer       ,       . </p><br><pre> <code class="hljs pgsql">let encoder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TextEncoder(); <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> decodeNoCachingNoString(aStr) { decodeNoCachingNoStringPreEncoded(encoder.encode(aStr)); } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> decodeNoCachingNoStringPreEncoded(arr) { var length = arr.length; var cachedSegments = {}; var <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, str, segment, <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span> = {<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, rest: <span class="hljs-number"><span class="hljs-number">0</span></span>}; const decode2 = base64VLQ.decode2; var <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; var segment = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Int32Array(<span class="hljs-number"><span class="hljs-number">5</span></span>); var segmentLength = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> &lt; length) { segmentLength = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (arr[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>] != <span class="hljs-number"><span class="hljs-number">59</span></span> &amp;&amp; arr[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>] != <span class="hljs-number"><span class="hljs-number">44</span></span>) { decode2(arr, <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>.rest; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segmentLength &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) { segment[segmentLength++] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segmentLength === <span class="hljs-number"><span class="hljs-number">2</span></span>) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Error(<span class="hljs-string"><span class="hljs-string">'Found a source, but no line and column'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segmentLength === <span class="hljs-number"><span class="hljs-number">3</span></span>) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Error(<span class="hljs-string"><span class="hljs-string">'Found a source and line, but no column'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>++; } }</code> </pre> <br><p>  ,        Chrome Dev <br> <code>66.0.3343.3</code> (V8 <code>6.6.189</code> )  Firefox Nightly <code>60.0a1 (2018-02-11)</code> : </p><br><p><img src="https://habrastorage.org/webt/pn/_t/pz/pn_tpzezcohetpqupkztddg815y.png" alt="Different Decodes"></p><br><p>     : </p><br><ul><li> ,   ,     V8,   SpiderMonkey.          ‚Äî            ; </li><li>  SpiderMonkey         , ,  V8      ‚Äî          "--"    (..          ); </li></ul><br><p>   ,     V8  -    <code>charCodeAt</code> ‚Äì    , Crankshaft     <code>charCodeAt</code>       ,     <code>charCodeAt</code> ,    ,      ,     . </p><br><p>    - V8     : </p><br><ul><li> <a href="https://bugs.chromium.org/p/v8/issues/detail%3Fid%3D6391">Issue 6391: StringCharCodeAt slower than Crankshaft</a> ; </li><li> <a href="https://bugs.chromium.org/p/v8/issues/detail%3Fid%3D7092">Issue 7092: High overhead of String.prototype.charCodeAt in typescript test</a> ; </li><li> <a href="https://bugs.chromium.org/p/v8/issues/detail%3Fid%3D7326">Issue 7326: Performance degradation when looping across character codes of a string</a> ; </li></ul><br><p>           2018   ,    ,   <code>charCodeAt</code>  .         Chrome Beta    Chrome Dev. </p><br><p><img src="https://habrastorage.org/webt/sb/0e/ng/sb0engqsoe1hxpqronzajgxuw7g.png" alt="Different Decodes"></p><br><p>    ,       V8   :  <code>charCodeAt</code>     <code>6.5.254.21</code>  <code>6.6.189</code> .   "no cache"  "using array",   ,  <code>charCodeAt</code>   V8    ,        <code>Uint8Array</code> ,     . ,              V8. </p><br><p> ,       ,       .  Why is that?   ,      V8: </p><br><pre> <code class="hljs rust">function foo(<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, i) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>.charCodeAt(i); } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span> = <span class="hljs-string"><span class="hljs-string">"fisk"</span></span>; foo(<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); foo(<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); foo(<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); %OptimizeFunctionOnNextCall(foo); foo(<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><pre> <code class="hljs pgsql">‚ï≠‚îÄ ~/src/v8/v8 ‚Äπmaster‚Ä∫ ‚ï∞‚îÄ$ <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.gn/x64.<span class="hljs-keyword"><span class="hljs-keyword">release</span></span>/d8 <span class="hljs-comment"><span class="hljs-comment">--allow-natives-syntax --print-opt-code --code-comments x.js</span></span></code> </pre> <br><p>   <a href="https://gist.github.com/mraleph/a1f36a67676a8dfef0af081f27f3eb6a">  </a> ,   ,  V8     <code>charCodeAt</code>    . , ,   <a href=""> </a>   V8,   ,          <code>charCodeAt</code> . </p><br><h2 id="uluchsheniya-v-razbore">    </h2><br><p>    ,        <code>source-map</code>   . </p><br><p><img src="https://habrastorage.org/webt/zw/oq/u3/zwoqu3buvgdplsnu8qjmfyxaves.png" alt="Parse and Sort times"></p><br><p>      ,     ,  :         . </p><br><h1 id="optimiziruem-sortirovku--uluchsheniya-v-algoritmah">   ‚Äì    </h1><br><p>       ,      . </p><br><p>    : </p><br><ol><li> <code>originalMappings</code>     <code>compareByOriginalPositions</code> ; </li><li> <code>generatedMappings</code>    <code>compareByGeneratedPositionsDeflated</code> . </li></ol><br><h2 id="optimiziruem-sortirovku-originalmappings">   <code>originalMappings</code> </h2><br><p>     <code>compareByOriginalPositions</code> . </p><br><pre> <code class="hljs kotlin">function compareByOriginalPositions(mappingA, mappingB, onlyCompareOriginal) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmp = strcmp(mappingA.source, mappingB.source); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = mappingA.originalLine - mappingB.originalLine; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = mappingA.originalColumn - mappingB.originalColumn; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span> || onlyCompareOriginal) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = mappingA.generatedColumn - mappingB.generatedColumn; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = mappingA.generatedLine - mappingB.generatedLine; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> strcmp(mappingA.name, mappingB.name); }</code> </pre> <br><p>  ,      <code>source</code> ,      . <code>source</code> ,      .   ,       <code>originalMappings</code> ,       ,    <code>originalMappings</code>   : <code>originalMappings[i]</code>         <code>i</code> .  ,        <code>originalMappings[i]</code>  ,   ,      . </p><br><p> <sub>[ ,  ‚Äì <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25BB%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D0%25BE%25D1%2580%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0"> </a> ]</sub> </p><br><p>       : </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (typeof <span class="hljs-keyword"><span class="hljs-keyword">mapping</span></span>.originalLine === <span class="hljs-string"><span class="hljs-string">'number'</span></span>) { //      originalMappings.push(<span class="hljs-keyword"><span class="hljs-keyword">mapping</span></span>). //            . let currentSource = <span class="hljs-keyword"><span class="hljs-keyword">mapping</span></span>.source; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (originalMappings.length &lt;= currentSource) { originalMappings.push(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (originalMappings[currentSource] === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { originalMappings[currentSource] = []; } originalMappings[currentSource].push(<span class="hljs-keyword"><span class="hljs-keyword">mapping</span></span>); }</code> </pre> <br><p>   : </p><br><pre> <code class="hljs pgsql">var startSortOriginal = <span class="hljs-type"><span class="hljs-type">Date</span></span>.now(); //    : // quickSort(originalMappings, util.compareByOriginalPositions); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; originalMappings.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (originalMappings[i] != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { quickSort(originalMappings[i], util.compareByOriginalPositionsNoSource); } } var endSortOriginal = <span class="hljs-type"><span class="hljs-type">Date</span></span>.now();</code> </pre> <br><p>  <code>compareByOriginalPositionsNoSource</code>      <code>compareByOriginalPositions</code>   ,       <code>source</code>  ‚Äî     ,      <code>originalMappings[i]</code> . </p><br><p><img src="https://habrastorage.org/webt/e5/sg/lq/e5sglq4kxzroui-1y9g7ijiu1hm.png" alt="Parse and Sort times"></p><br><p>         V8,   SpiderMonkey,        V8. </p><br><p> <sub>[           <code>originalMappings</code> :     <code>originalMappings</code>  ,     <code>originalMappings[i]</code>  .      ,      .]</sub> </p><br><h2 id="optimiziruem-sortirovku-generatedmappings">   <code>generatedMappings</code> </h2><br><p>    <code>generatedMappings</code>    <code>compareByGeneratedPositionsDeflated</code> . </p><br><pre> <code class="hljs kotlin">function compareByGeneratedPositionsDeflated(mappingA, mappingB, onlyCompareGenerated) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmp = mappingA.generatedLine - mappingB.generatedLine; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = mappingA.generatedColumn - mappingB.generatedColumn; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span> || onlyCompareGenerated) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = strcmp(mappingA.source, mappingB.source); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = mappingA.originalLine - mappingB.originalLine; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = mappingA.originalColumn - mappingB.originalColumn; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> strcmp(mappingA.name, mappingB.name); }</code> </pre> <br><p>       <code>generatedLine</code> . ,  ,    ,   ,        <code>generatedMappings</code>    . </p><br><p> ,         : </p><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">length</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aStr.charAt(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) === <span class="hljs-string"><span class="hljs-string">';'</span></span>) { generatedLine++; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aStr.charAt(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) === <span class="hljs-string"><span class="hljs-string">','</span></span>) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mapping = new Mapping(); mapping.generatedLine = generatedLine; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... } }</code> </pre> <br><p>    <code>generatedLine</code>   ,  ,  <code>generatedLine</code>  ,  ,  <code>generatedMappings</code>    <code>generatedLine</code> ,      .        .     : </p><br><pre> <code class="hljs perl">let subarrayStart = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">length</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aStr.charAt(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) === <span class="hljs-string"><span class="hljs-string">';'</span></span>) { generatedLine++; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... //   [subarrayStart, generatedMappings.length]. sortGenerated(generatedMappings, subarrayStart); subarrayStart = generatedMappings.length; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aStr.charAt(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) === <span class="hljs-string"><span class="hljs-string">','</span></span>) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mapping = new Mapping(); mapping.generatedLine = generatedLine; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... } } //    sortGenerated(generatedMappings, subarrayStart);</code> </pre> <br><p>            <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BE%25D1%2580%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0_%25D0%25B2%25D1%2581%25D1%2582%25D0%25B0%25D0%25B2%25D0%25BA%25D0%25B0%25D0%25BC%25D0%25B8"> </a> ,    ,   VM  <code>Array.prototype.sort</code> . </p><br><p> <sub>[:        ,     ‚Ä¶  ,      <em></em> .   ,  <code>generatedMappings</code>      ,       ,   <code>generatedMappings</code> ,      .]</sub> </p><br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> compareGenerated = util.compareByGeneratedPositionsDeflatedNoLine; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> sortGenerated(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>, start) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> l = <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>.length; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> n = <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>.length - start; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) { return; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n == <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> a = <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[start]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> b = <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[start + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareGenerated(a, b) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[start] = b; <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[start + <span class="hljs-number"><span class="hljs-number">1</span></span>] = a; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = start; i &lt; l; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> j = i; j &gt; start; j--) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> a = <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[j - <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> b = <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[j]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareGenerated(a, b) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { break; } <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[j - <span class="hljs-number"><span class="hljs-number">1</span></span>] = b; <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[j] = a; } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { quickSort(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>, compareGenerated, start); } }</code> </pre> <br><p>    : </p><br><p><img src="https://habrastorage.org/webt/lp/sd/dy/lpsddyk5hxefvimn4jxn6owi9ww.png" alt="Parse and Sort times"></p><br><p>    ,         ‚Äì  ,     <code>generatedMappings</code>    ,     .     (   ) </p><br><h2 id="uluchsheniya-k-obschemu-vremeni">     </h2><br><p><img src="https://habrastorage.org/webt/jf/rs/qe/jfrsqeptlfs1bdo-tlvi_3yqlo8.png" alt="Parse and Sort times"></p><br><p>   ,        . </p><br><p>    - ,       ? </p><br><p> , :         asm.js / WASM,     Rust   JavaScript . </p><br><h1 id="optimiziruem-razbor--umenshaem-nagruzku-na-gc">   ‚Äì    GC </h1><br><p>      <code>Mapping</code> ,        (GC) ‚Äì ,         ‚Äì       .  This is how I did it. </p><br><p> <sub>[          <a href="https://github.com/nikomatsakis/typed-objects-explainer"> </a> ,    JavaScript-         ,      .  , ,    ,      ,    :   ,   C++ :-(]</sub> </p><br><p>    <code>Mapping</code>     ,      ,    . </p><br><pre> <code class="hljs kotlin">function Mapping(memory) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory = memory; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer = <span class="hljs-number"><span class="hljs-number">0</span></span>; } Mapping.prototype = { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> generatedLine () { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">0</span></span>]; }, <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> generatedColumn () { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">1</span></span>]; }, <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> source () { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">2</span></span>]; }, <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> originalLine () { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">3</span></span>]; }, <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> originalColumn () { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">4</span></span>]; }, <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> name () { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">5</span></span>]; }, <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> generatedLine (value) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">0</span></span>] = value; }, <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> generatedColumn (value) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">1</span></span>] = value; }, <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> source (value) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">2</span></span>] = value; }, <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> originalLine (value) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">3</span></span>] = value; }, <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> originalColumn (value) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">4</span></span>] = value; }, <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> name (value) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointer + <span class="hljs-number"><span class="hljs-number">5</span></span>] = value; }, };</code> </pre> <br><p>       ,     : </p><br><pre> <code class="hljs coffeescript">BasicSourceMapConsumer.prototype._parseMappings = function (aStr, aSourceRoot) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-number"><span class="hljs-number">4</span></span>    .     <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  aStr        <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Int32Array(<span class="hljs-number"><span class="hljs-number">1</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._allocationFinger = <span class="hljs-number"><span class="hljs-number">0</span></span>; let mapping = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mapping(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (index &lt; length) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aStr.charAt(index) === <span class="hljs-string"><span class="hljs-string">';'</span></span>) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,        , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>         sortGenerated(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory, generatedMappings, previousGeneratedLineStart); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._allocateMapping(mapping); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-string"><span class="hljs-string">""</span></span>   . generatedMappings.push(mapping.pointer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (segmentLength &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... originalMappings[currentSource].push(mapping.pointer); } } } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; originalMappings.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (originalMappings[i] != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { quickSort(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory, originalMappings[i], util.compareByOriginalPositionsNoSource); } } }; BasicSourceMapConsumer.prototype._allocateMapping = function (mapping) { let start = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._allocationFinger; let end = start + <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (end &gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory.length) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Do we need to grow memory buffer? let memory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Int32Array(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory.length * <span class="hljs-number"><span class="hljs-number">2</span></span>); memory.set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory = memory; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._allocationFinger = end; let memory = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._memory; mapping._memory = memory; mapping.pointer = start; mapping.name = <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Instead <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> use INT32_MAX. mapping.source = <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Instead <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> use INT32_MAX. }; exports.compareByOriginalPositionsNoSource = function (memory, mappingA, mappingB, onlyCompareOriginal) { var cmp = memory[mappingA + <span class="hljs-number"><span class="hljs-number">3</span></span>] - memory[mappingB + <span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> originalLine <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = memory[mappingA + <span class="hljs-number"><span class="hljs-number">4</span></span>] - memory[mappingB + <span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> originalColumn <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span> || onlyCompareOriginal) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = memory[mappingA + <span class="hljs-number"><span class="hljs-number">1</span></span>] - memory[mappingB + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> generatedColumn <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } cmp = memory[mappingA + <span class="hljs-number"><span class="hljs-number">0</span></span>] - memory[mappingB + <span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> generatedLine <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cmp; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> memory[mappingA + <span class="hljs-number"><span class="hljs-number">5</span></span>] - memory[mappingB + <span class="hljs-number"><span class="hljs-number">5</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> name };</code> </pre> <br><p>   ,   .         <code>Mapping</code> ,  ,        .          VM      <em>allocation sinking</em> , <em>scalar replacement</em>    .  ,    SpiderMonkey        ,         . </p><br><p> <sub>[  <em></em>       JS.   ,   ,  "" <code>source-map</code>    <a href="https://github.com/mozilla/source-map">    </a>   ,      WASM]</sub> </p><br><p>   ,     GC   : </p><br><p><img src="https://habrastorage.org/webt/4h/hx/so/4hhxso27ggc2x5dqqmrbtvbczye.png" alt="After reworking allocation"></p><br><p><img src="https://habrastorage.org/webt/bo/kh/ws/bokhws5elftdehh3sm17wbea1ya.png" alt="After reworking allocation"></p><br><p>  ,  SpiderMonkey       , <em></em> ,     . </p><br><h2 id="ustup-proizvoditelnosti-v-spidermonkey">    SpiderMonkey </h2><br><p>   ,        SpiderMonkey:          4  64 ,     ,        7 . </p><br><p><img src="https://habrastorage.org/webt/ov/yx/h-/ovyxh-zyjmb1pi2wmlpnp6-edp0.png" alt="After reworking allocation"></p><br><p>    -  ,       ,         . </p><br><p>      SpiderMonkey <a href="https://twitter.com/jandemooij">Jan de Mooij</a> ,   <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D1437471"> </a>  ‚Äì   asm.js   2012 ‚Ä¶        SpiderMonkey,          . </p><br><h1 id="optimiziruem-razbor--ispolzovanie-uint8array-vmesto-stroki">   ‚Äì  <code>Uint8Array</code>  . </h1><br><p>   ,      <code>Uint8Array</code>    ,       . </p><br><p><img src="https://habrastorage.org/webt/8z/l4/nt/8zl4ntf37p4wuqbl04ivat5nfm0.png" alt="After reworking allocation"></p><br><p> <sub>[     <code>source-map</code>       ,   JavaScript-      <code>JSON.decode</code> .     ,      .]</sub> </p><br><h1 id="obschie-uluchsheniya-po-sravneniyu-s-nachalnym-sostoyaniem">        </h1><br><p>    : </p><br><pre> <code class="hljs matlab">$ d8 bench-shell-bindings.js ... [Stats samples: <span class="hljs-number"><span class="hljs-number">5</span></span>, total: <span class="hljs-number"><span class="hljs-number">24050</span></span> ms, <span class="hljs-built_in"><span class="hljs-built_in">mean</span></span>: <span class="hljs-number"><span class="hljs-number">4810</span></span> ms, stddev: <span class="hljs-number"><span class="hljs-number">155.91063145276527</span></span> ms] $ sm bench-shell-bindings.js ... [Stats samples: <span class="hljs-number"><span class="hljs-number">7</span></span>, total: <span class="hljs-number"><span class="hljs-number">22925</span></span> ms, <span class="hljs-built_in"><span class="hljs-built_in">mean</span></span>: <span class="hljs-number"><span class="hljs-number">3275</span></span> ms, stddev: <span class="hljs-number"><span class="hljs-number">269.5999093306804</span></span> ms]</code> </pre> <br><p>      </p><br><pre> <code class="hljs matlab">$ d8 bench-shell-bindings.js ... [Stats samples: <span class="hljs-number"><span class="hljs-number">22</span></span>, total: <span class="hljs-number"><span class="hljs-number">25158</span></span> ms, <span class="hljs-built_in"><span class="hljs-built_in">mean</span></span>: <span class="hljs-number"><span class="hljs-number">1143.5454545454545</span></span> ms, stddev: <span class="hljs-number"><span class="hljs-number">16.59358125226469</span></span> ms] $ sm bench-shell-bindings.js ... [Stats samples: <span class="hljs-number"><span class="hljs-number">31</span></span>, total: <span class="hljs-number"><span class="hljs-number">25247</span></span> ms, <span class="hljs-built_in"><span class="hljs-built_in">mean</span></span>: <span class="hljs-number"><span class="hljs-number">814.4193548387096</span></span> ms, stddev: <span class="hljs-number"><span class="hljs-number">5.591064299397745</span></span> ms]</code> </pre> <br><p><img src="https://habrastorage.org/webt/su/mu/ft/sumuftxc3mdtwgut7uwte062qy0.png" alt="After reworking allocation"></p><br><p><img src="https://habrastorage.org/webt/qc/re/82/qcre8264rqmgprcqkfnki693g7y.png" alt="After reworking allocation"></p><br><p>    4 ! </p><br><p>  ,   ,        <code>originalMappings</code> ,        .     ,   <code>originalMappings</code> : </p><br><ul><li> <code>allGeneratedPositionsFor</code> ,           ; </li><li> <code>eachMapping(..., ORIGINAL_ORDER)</code> ,        . </li></ul><br><p>   ,  <code>allGeneratedPositionsFor</code>             <code>originalMappings[i]</code> ,       ,          -     . </p><br><p>  ,  V8  19 ,  V8  19          ( <a href="https://github.com/v8/v8/wiki/Untrusted-code-mitigations">untrusted code mitigations</a> ). </p><br><p><img src="https://habrastorage.org/webt/ll/y5/1u/lly51uheo7a-urp1zclusq_mkk4.png" alt="After reworking allocation"></p><br><h1 id="sravnenie-s-okislennoy-versiey-source-map">   ""  <code>source-map</code> </h1><br><p>     19 ,      <code>source-map</code>       <code>source-map</code> ,   Rust  WASM. </p><br><p>      Rust  <a href=""><code>parse_mappings</code></a> ,  Rust-     ,       <code>generatedMappings</code> .        JS-,    <code>originalMappings[i]</code> . </p><br><p>       (    <code>generatedMappings</code> )        <code>generatedMappings</code> . </p><br><p><img src="https://habrastorage.org/webt/q2/ho/pr/q2hopr2ryjlwgg4nkjxrkr9lk0o.png" alt="Parse only times"></p><br><p><img src="https://habrastorage.org/webt/zc/it/wc/zcitwcnb4tjuufy0gp7_ftdsbn0.png" alt="Parse and iterate times"></p><br><p> <strong>,     ,   Rust-    <code>generatedMappings</code>   ,     JS-.</strong> </p><br><p>         <em>"     Rust+WASM "</em> . ,         ,      Rust  <code>source-map</code> . </p><br><h2 id="obnovlenie-27-02-2018">  (27-02-2018) </h2><br><p>  ,  <code>source-map</code> <a href="http://fitzgeraldnick.com/2018/02/26/speed-without-wizardry.html"></a>   Rust+WASM,        .         <em>  </em> : </p><br><p><img src="https://habrastorage.org/webt/am/4p/gr/am4pgrzkzlrwk3lnk_dxrd-5tb4.png" alt="Parse and iterate times"></p><br><p>    ,    WASM+Rust   15%   SpiderMonkey        V8. </p><br><h1 id="usvoennye-uroki">   </h1><br><h2 id="dlya-javascript-razrabotchika">  JavaScript  </h2><br><h3 id="profilirovschik--tvoy-drug">  ‚Äì   </h3><br><p>         ‚Äì       .               .             <code>perf</code> ‚Äì ""       ,     . </p><br><p>            . ,        . </p><br><h3 id="algoritmy-vazhny">   </h3><br><p>          ‚Äì   .  ,       100  ,  3333   30 ? </p><br><p>       <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>100000</mn><mi>log</mi><mo>&amp;#x2061;</mo><mn>100000</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="17.695ex" height="2.419ex" viewBox="0 -780.1 7618.8 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="2502" y="0"></use><g transform="translate(3169,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-6C"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-6F" x="278" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-67" x="779" y="0"></use></g><g transform="translate(4615,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="2502" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>100000</mn><mi>log</mi><mo>‚Å°</mo><mn>100000</mn></math></span></span><script type="math/tex" id="MathJax-Element-1">100000 \log 100000</script>  3    <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>3333</mn><mo>&amp;#x00D7;</mo><mn>30</mn><mi>log</mi><mo>&amp;#x2061;</mo><mn>30</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.886ex" height="2.419ex" viewBox="0 -780.1 6839.8 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-33"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-33" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-33" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-33" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-D7" x="2224" y="0"></use><g transform="translate(3224,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-33"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="500" y="0"></use></g><g transform="translate(4392,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-6C"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-6F" x="278" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-67" x="779" y="0"></use></g><g transform="translate(5838,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-33"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/350018/&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjx8XN81TnPnH93SK9DOhWeWfZ5hA#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3333</mn><mo>√ó</mo><mn>30</mn><mi>log</mi><mo>‚Å°</mo><mn>30</mn></math></span></span><script type="math/tex" id="MathJax-Element-2">3333 \times 30 \log 30</script> ‚Äì     ,         . </p><br><p>               ,          :   ,      ,      ? </p><br><h3 id="vm-eschyo-v-processe-razrabotki-dostavayte-razrabotchikov"> VM    .  ! </h3><br><p>          .           .    : <em>"   !"</em>  .    (VM) ‚Äì  ,    ,    .        ,     .                 C++ . </p><br><h3 id="vm-vse-esche-nuzhno-nemnogo-pomoschi"> VM      </h3><br><p>          ,       JavaScript. </p><br><p>        ,   ,      ,   -   . </p><br><h2 id="dlya-razrabotchikadizaynera-yazyka">  /  </h2><br><h3 id="umnye-optimizacii-dolzhny-byt-diagnostiruemy">      </h3><br><p>        ,        ,    ,     . </p><br><p>     JavaScript    ,           ,  ,     VM,    ‚Äì    . </p><br><p>          VM   ,        .       ,     DevTools. </p><br><h3 id="yazyk-i-optimizacii-dolzhny-byt-druzyami">       </h3><br><p>  ,       ,    ,        .         ?  ,  .      ,             .     ,             (..            Rust). </p><br><p>      :      - , ,           ,      .        ,  ,           . </p><br><h1 id="posleslovie">  Afterword </h1><br><p>  ,         : </p><br><ol><li>  ; </li><li>    ,   ,     ; </li><li>   ,   V8. </li></ol><br><p> ,     ,       .  ,         "" ,        ""    ,    .         : </p><br><ul><li>        ; </li><li>      . </li></ul><br><p>     .         V8 .      JS .          .   (Rust, )       . </p><br><p>        . </p><br><p>  , ,       (      )     .            .       JS VM      . </p><br><p> ‚Ä¶ <strong>    ?</strong>  ,   ,      ,      .     ,       . </p><br><p> ,          <code>N</code>    ,      JavaScript ,   <code>M</code>        <code>X</code> . </p><br><p> : ()     ,      ;  ()       ,         ‚Äì             " #3" . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/350018/">https://habr.com/ru/post/350018/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350008/index.html">Learn OpenGL. Lesson 4.7 - Advanced data handling</a></li>
<li><a href="../350010/index.html">YouTrack 2018.1 release: dependent task fields, personal localization and much more</a></li>
<li><a href="../350012/index.html">Analysis of the consensus algorithm in Tendermint</a></li>
<li><a href="../350014/index.html">How to make an adequate display of the horizontal scroll bar in a QTreeWidget with one column</a></li>
<li><a href="../350016/index.html">Digital events in Moscow from February 26 to March 4</a></li>
<li><a href="../350022/index.html">FastTrack Training. "Network Basics". "Basics of switching or switches." Part two. Eddie Martin December 2012</a></li>
<li><a href="../350026/index.html">(Non) security monitoring systems: Zabbix</a></li>
<li><a href="../350028/index.html">Code Integrity Protection with PGP. Part 2. Creating a master key</a></li>
<li><a href="../350030/index.html">Searchless method for calculating controller settings using Python</a></li>
<li><a href="../350032/index.html">Additional factors for evaluating spam activity IP / Email addresses in the Anti-Spam / Anti-Fraud API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>