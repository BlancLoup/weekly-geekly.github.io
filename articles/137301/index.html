<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Restore individual pages in the database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Gail Shaw article ‚ÄúHelp, my database is corrupt. Now what? ‚Äù , The translation of which I posted last week, seemed to cause some interest, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Restore individual pages in the database</h1><div class="post__text post__text-html js-mediator-article"><h5>  Foreword </h5><br>  Gail Shaw article <a href="http://www.sqlservercentral.com/articles/Corruption/65804/">‚ÄúHelp, my database is corrupt.</a>  <a href="http://www.sqlservercentral.com/articles/Corruption/65804/">Now what? ‚Äù</a> , The <a href="http://habrahabr.ru/blogs/mssql/136979/">translation of</a> which I posted last week, seemed to cause some interest, but, alas, it did not contain‚Äú practice ‚Äù.  Yes, it says how to save the data, but there are no examples. <br>  Initially, I wanted to make another translation of the same author, but, on reflection, decided to write a post ‚Äúfrom myself‚Äù, as if ‚Äúbased on‚Äù.  The reasons that prompted me to do so, I will describe at the end of the post, in the notes. <br><br><h4>  Database Recovery in SQL Server </h4><br>  As already mentioned in the previous article, in the event that the clustered index or heap pages are damaged, the data contained on these pages is lost and the only option to restore them is to directly restore the database. <br><a name="habracut"></a><br>  SQL Server provides many features for recovering databases.  Firstly, it is the recovery of the entire database - it can take quite a lot of time (depending on the size of the database and the speed of the hard drives).  Secondly, the restoration of individual file groups, or files, if your database consists of several file groups (or, respectively, files).  In this case, it is possible to restore only damaged parts of the database without affecting the rest.  These two types of database recovery are used quite often and will not be affected further. <br>  Thirdly, SQL Server 2005 now has the ability to restore individual database pages - in this case, only the specified pages will be restored from the backup.  Such a recovery will be especially relevant if DBCC CHECKDB finds several damaged pages in some huge table that is ‚Äúlying‚Äù in a hefty file.  Due to the fact that not the entire file, or even the entire table, but only a few pages will be restored, the idle time can be significantly reduced. <br><br><h4>  Requirements and limitations </h4><br><h5>  Recovery Model and Availability of Transaction Log Backups </h5><br>  The most important thing to remember is to restore individual pages, the database must use the full (full) recovery model, or the recovery model with incomplete logging (bulk-logged).  If your databases are in a simple (simple) recovery model - then you can no longer read. <br>  The second requirement is that your full backups and transaction log backups must form an indissoluble <a href="http://msdn.microsoft.com/ru-ru/library/ms190440.aspx">log chain</a> .  If you never run the BACKUP LOG WITH TRUNCATE_ONLY (NO_LOG) command and do not switch to the simple recovery model in order to reduce the transaction log, and you have ALL transaction log backups since the last full backup without any damaged pages (including this one) the most complete backup) - you can not worry about the chain of journals. <br>  In the recovery model with incomplete logging, theoretically, the recovery of individual pages should work normally if the conditions described above are met and the pages being restored are not modified by <a href="http://msdn.microsoft.com/ru-ru/library/ms191244.aspx">operations performed with minimal logging</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  SQL Server Editions </h5><br>  Page recovery is possible in any edition of SQL Server, but for Enterprise Editions and Developer Edition editions, it is possible to restore damaged pages on-line, i.e.  You can refer to the database during recovery (and moreover, you can even refer to the table to which the pages being restored are currently located, if these pages themselves are not ‚Äúaffected‚Äù - otherwise, the query will fail).  For editions ‚Äúbelow‚Äù Enterprise Edition, page recovery takes place off-line and the database becomes inaccessible for the duration of the recovery. <br><br><h5>  Type of damaged page </h5><br>  In the event that the index pages or data are damaged, their recovery is possible online in the Enterprise Edition. <br>  Pages that provide critical system tables can be restored, but the database, when restored, will be unavailable in any edition of SQL Server. <br>  "Placement cards" cannot be restored "separately."  If GAM, SGAM, PFS, ML, DIFF pages are damaged, you need to restore the entire database.  The only exceptions are IAM pages.  Although they refer to ‚Äúallocation maps‚Äù, they describe only one table, not the entire database, and their recovery is possible. <br>  The database loading page (the 9th page in the 1st database file) and the file header page (the 0th page in each file) cannot be restored ‚Äúseparately‚Äù, if they are damaged, you will have to restore the entire database. <br><br><h4>  Actually, recovery </h4><br>  Now, finally, we move from theory to practice. <br>  First of all, for training, you need a corrupted database. <br><br><h5>  Portim DB </h5><br>  For experiments, I will use the AdventureWorks database that comes with SQL Server.  If you have not installed it, you can download it <a href="http://sqlserversamples.codeplex.com/">here</a> if you wish.  I transfer it to the full recovery model: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> AdventureWorks <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECOVERY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span></code> </pre>  make sure there are no errors yet: <br><pre> <code class="sql hljs">DBCC CHECKDB('AdventureWorks') <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NO_INFOMSGS, ALL_ERRORMSGS, DATA_PURITY</code> </pre>  and create a full backup: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> AdventureWorks <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK = <span class="hljs-string"><span class="hljs-string">'D:\tmp\aw_backups\aw_full_ok1.bak'</span></span></code> </pre> <br><img src="https://habrastorage.org/storage2/1ac/3e2/52a/1ac3e252accf0fe9957ba7172ce40790.png"><br>  In this database, I create a crash table. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> crash (txt <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>))</code> </pre>  We will spoil the varchar type field in order to check what will happen if SQL Server suddenly detects in it the wrong data that he himself wrote there. <br>  Before spoiling something, you need to fill it with something.  I hammer in the created table the left data. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @i <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i&lt;<span class="hljs-number"><span class="hljs-number">100000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> crash <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLICATE</span></span>(<span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @i = @i + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span></code> </pre>  Now I back up the transaction log: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span> AdventureWorks <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK = <span class="hljs-string"><span class="hljs-string">'D:\tmp\aw_backups\aw_log_ok1.trn'</span></span></code> </pre> <br><img src="http://habrastorage.org/storage2/161/75b/af4/16175baf42d15ed01933abaffc57cd1f.png"><br>  Now let's change the data a bit: <br><img src="http://habrastorage.org/storage2/3dd/50b/b98/3dd50bb9880830209ff826b91d298f09.png"><br>  So, everything is ready.  Disconnect the database and open the mdf file with FAR (or which is more convenient for you), look for the string ‚Äúzzzzzzz‚Äù in it and replace several 'z' with arbitrary characters: <br><img src="http://habrastorage.org/storage2/cbc/4b9/e47/cbc4b9e47c7ac76d05abcc3029746191.png"><br>  Now that the database is corrupted, we connect it.  And yes, I remember that in the previous article it was clearly stated that you should not detach / attach the database.  But in our case it is absolutely ‚Äúsafe‚Äù - the database in ‚Äúsuspect‚Äù will not fall. <br><br><h5>  We are looking for errors </h5><br>  So, the damaged database successfully returned to the system.  Run the integrity check again: <br><pre> <code class="sql hljs">DBCC CHECKDB('AdventureWorks') <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NO_INFOMSGS, ALL_ERRORMSGS, DATA_PURITY</code> </pre>  As a result, what we were waiting for ( <b>be sure to remember the numbers of the damaged pages!</b> ): <br><br> <code>Msg 8928, Level 16, State 1, Line 1 <br> Object ID 1883153754, index ID 0, partition ID 72057594054246400, alloc unit ID 72057594061651968 (type In-row data): Page (1:20455) could not be processed. See other errors for details. <br> Msg 8939, Level 16, State 98, Line 1 <br> Table error: Object ID 1883153754, index ID 0, partition ID 72057594054246400, alloc unit ID 72057594061651968 (type In-row data), page (1:20455). Test (IS_OFF (BUF_IOERR, pBUF-&gt;bstat)) failed. Values are 29493257 and -4. <br> CHECKDB found 0 allocation errors and 2 consistency errors in table 'crash' (object ID 1883153754). <br> CHECKDB found 0 allocation errors and 2 consistency errors in database 'AdventureWorks'. <br> repair_allow_data_loss is the minimum repair level for the errors found by DBCC CHECKDB (AdventureWorks). <br></code>  In this case, the data in the heap itself is damaged (index id = 0), therefore SQL Server cannot recover this data. <br>  Now we have three options: <br><ol><li>  Accept data loss and perform DBCC CHECKDB ('AdventureWorks', REPAIR_ALLOW_DATA_LOSS) </li><li>  Make a backup of the active part of the transaction log and restore the entire database - as a result of data loss will not, but it will take a long time </li><li>  Make a backup of the active part of the transaction log and restore only one (!) Damaged page </li></ol>  With the second option, everything should be clear, but what happens if you run DBCC CHECKDB or how individual pages are restored - I will show further. <br><br><h5>  We recover the damaged page </h5><br>  First of all, we need to backup the final fragment of the transaction log ( <a href="http://msdn.microsoft.com/ru-ru/library/ms179314.aspx">tail backup</a> ).  At the same time, if you have Enterprise Edition, you can not add the NORECOVERY parameter, which will transfer the database to the ‚Äúrestoring‚Äù state, since this edition supports on-line page recovery.  Moreover, if your transaction log backups are performed on a regular basis so as not to break the chain of journals, in the Enterprise Edition edition, you can make a COPY_ONLY backup. <br>  I follow the path of off-line recovery and perform: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span> AdventureWorks <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK = <span class="hljs-string"><span class="hljs-string">'D:\tmp\aw_backups\aw_log_fail3.trn'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NORECOVERY</code> </pre> <br><img src="http://habrastorage.org/storage2/f84/f17/daa/f84f17daa87d72eb12724635cb7c8f9d.png"><br>  Now, you can repair the damaged page.  First of all, we use full backup (aw_full_ok1.bak): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">RESTORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> AdventureWorks PAGE = <span class="hljs-string"><span class="hljs-string">'1:20455'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DISK = <span class="hljs-string"><span class="hljs-string">'D:\tmp\aw_backups\aw_full_ok1.bak'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NORECOVERY</code> </pre> <br>  As a result, we have: <br><img src="http://habrastorage.org/storage2/937/ee0/b57/937ee0b576ecabee2eb882521f1816cb.png"><br>  Please note that you need to use the NORECOVERY option, because we still have to roll back the transaction log backups. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">RESTORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span> AdventureWorks <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DISK = <span class="hljs-string"><span class="hljs-string">'D:\tmp\aw_backups\aw_log_ok1.trn'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NORECOVERY</code> </pre>  and <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">RESTORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span> AdventureWorks <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DISK = <span class="hljs-string"><span class="hljs-string">'D:\tmp\aw_backups\aw_log_fail3.trn'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECOVERY</span></span></code> </pre> <br><img src="http://habrastorage.org/storage2/64a/af6/c31/64aaf6c3147838277a31be5fbc9e3a8f.png"><br>  It seems that everything went well, we run DBCC CHECKDB and ... <br><img src="http://habrastorage.org/storage2/ab6/b7b/2f8/ab6b7b2f8aa4b0ed2acdcbfa3402ce83.png"><br>  Recovery was successful. <br>  Please note that idle time is reduced due to the fact that we do not restore the entire database from the full backup, but only the damaged pages (if I restored the entire backup, the backup would recover in 8.5 seconds, but the larger the database size more will be the time difference).  The lucky ones with SQL Server Enterprise Edition, who use on-line recovery, will also save time on recovering from the log backups, and with an off-line recovery, alas, the logs will be processed entirely. <br>  It is also worth adding that in SQL Server 2005, 2008, 2008 R2, the restoration of a separate page is possible only with the help of T-SQL, Denali has the opportunity to do this through the GUI. <br><br><h5>  And if all the same DBCC CHECKDB? </h5><br>  Just in case, I decided to check what SQL Server would do if I run DBCC CHECKDB with the REPAIR_ALLOW_DATA_LOSS option.  All the same error: <br><img src="http://habrastorage.org/storage2/e0e/dae/154/e0edae154df37a0677113b56a9a3615d.png"><br>  First we convert the database to SINGLE_USER mode: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> AdventureWorks <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> SINGLE_USER</code> </pre>  And then, start the recovery: <br><pre> <code class="sql hljs">DBCC CHECKDB('AdventureWorks', REPAIR_ALLOW_DATA_LOSS) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NO_INFOMSGS, ALL_ERRORMSGS, DATA_PURITY</code> </pre>  Eventually: <br> <code>Repair: The page (1:20455) has been deallocated from object ID 1883153754, index ID 0, partition ID 72057594054246400, alloc unit ID 72057594061651968 (type In-row data). <br></code>  Yeah, SQL Server deleted the ‚Äúspoiled‚Äù page.  We transfer the database to the MULTI_USER mode so that it becomes accessible to everyone and check that it is gone: <br><img src="http://habrastorage.org/storage2/244/8b0/1ee/2448b01ee92bd0aa77d65fcf435a3e48.png"><br>  Given that the page size in SQL Server is 8KB, and a little less is available for user data, then everything is natural, the table is ‚Äúthinner‚Äù by 7 records (at the beginning there were 99999).  Since this table did not have a clustered index, data could be stored in a random order, i.e.  we could not even know what data would be lost. <br><br><h4>  So why, after all, not a translation? </h4><br>  So, why is this still not a translation, but a post ‚Äúbased on‚Äù.  The fact is that in the open access article "Page Restore" by Gail Shaw is not.  There is such a section in the book SQL Server MVP Deep Dives vol.2, which is sold for quite tangible money (but, of course, is easily on the Internet) and I‚Äôm not sure that publishing a translation is uh ... right or wrong. <br>  In general, I read the article, took note of the main points, and then I wrote the text myself and, along the way, conducted an experiment on restoration.  I hope someone this experience was useful. <br>  And, gentlemen, I sincerely hope that if you decide to repeat this experiment, you will be extremely careful (for example, you will not experiment with the main database on the production-server).  Remember that I am not responsible for your actions. </div><p>Source: <a href="https://habr.com/ru/post/137301/">https://habr.com/ru/post/137301/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137296/index.html">Htmlspecialchars () improvements in version 5.4</a></li>
<li><a href="../137297/index.html">Man-computer interface - myth or reality?</a></li>
<li><a href="../137298/index.html">The design of search engine algorithms - the path to the success of website design and optimization</a></li>
<li><a href="../137299/index.html">Google+ demography in Russia</a></li>
<li><a href="../137300/index.html">Making the library written in .Net understandable for Unmanaged code</a></li>
<li><a href="../137302/index.html">MegaUpload files want to delete this week</a></li>
<li><a href="../137303/index.html">High-quality interface for Microsoft</a></li>
<li><a href="../137304/index.html">Batniki against exploits</a></li>
<li><a href="../137305/index.html">Learning foreign languages: live teachers or the Internet?</a></li>
<li><a href="../137306/index.html">Authentication in OpenVPN using Rutoken EDS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>