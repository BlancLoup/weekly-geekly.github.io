<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overclocking Swift build project in Xcode</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="An article on how to fix Xcode incremental compilation for Swift projects and speed up the build phases for Cocoapods and Carthage without breaking an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Overclocking Swift build project in Xcode</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://cloud.kilograpp.com/f/54a6286b80/?dl=1" alt="image"><br>  An article on how to fix Xcode incremental compilation for Swift projects and speed up the build phases for Cocoapods and Carthage without breaking anything. </p><br><p>  A small spoiler: on three different projects it was possible to reduce the incremental build time by 9 times! </p><br><p>  Tutorial is purely practical with a minimum of water.  Be sure to read for existing iOS developers. </p><br><a name="habracut"></a><br><h3 id="problema">  Problem </h3><br><p>  We have several parallel Swift projects in the company and, practically, everywhere there was difficulty with sequential assembly.  For each repeated 'Run' took from 30 to 50 seconds.  Minute code is written, wait half a minute until the project is assembled.  You have time to go for tea, smoke, count taxes and sometimes take a nap. </p><br><p>  Definitely had to change something.  In my previous articles, where the actual problems of the compiler are described and how to solve them, we were able to achieve some success.  However, this did not eliminate the difficulties with incremental compilation, which ate most of the time, constantly knocking out its slowness from the workflow.  I am sure everyone faces this regularly, taking it as part of the workflow. </p><br><p>  But we didn‚Äôt put up with it, having decided to investigate all the circumstances of the case and in the end got a good result.  What I will be glad to tell you. </p><br><p>  PS The picture in the cap does not mean that we 'skewed' Xcode.  This is his supposedly accelerating. </p><br><h3 id="inkrementalnaya-kompilyaciya">  Incremental compilation </h3><br><p>  If someone is not familiar with the term, this is a way to build only changed places of the code without total recompilation of the entire project.  And this is something that doesn‚Äôt normally work in Xcode. </p><br><p>  In the last post, Comrade <a href="https://habrahabr.ru/users/gxost/" class="user_link">Gxost</a> <a href="https://habrahabr.ru/post/317298/">suggested an idea</a> that solved the problem for a while.  We have already begun to open the champagne with the whole team and hang a portrait <del>  the emperor </del>  deliverer on the wall, but unfortunately, at this moment the problem resumed. </p><br><p>  Apparently, we are not alone.  Recurrences are also written <a href="http://stackoverflow.com/questions/39456223/xcode-8-does-full-project-rebuild">on StackOverflow</a> under the answer, as well as in the original thread on the Apple forums. </p><br><p>  This is by no means a stick in the vegetable garden.  Quite the contrary - thanks, it all pushed to continue to dig.  If even temporarily, but the problem was solved, then the truth is somewhere nearby. </p><br><p>  What exactly is this header map for which we set the flag on the recommendation of Apple? <br>  Some <a href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Reference/XcodeBuildSettingRef/1-Build_Setting_Reference/build_setting_ref.html">web archeology</a> on apple documentation: </p><br><blockquote>  Header maps (also known as ‚Äúheader maps‚Äù) are files used in a target. </blockquote><p>  In its own words, header maps are an Xcode index file with project header locations.  File about all the headers that we use. </p><br><p>  Since I promised not to dive too deeply into theory, here‚Äôs <a href="https://habrahabr.ru/post/144834/">an excellent article</a> on this topic.  Easy to read, highly recommended. </p><br><p>  The main <em>thing is</em> that <em>something</em> in these header maps (or what uses them) provokes the unfair work of incremental compilation.  If we have found such a technical tumor, then let's proceed without half measures and simply turn them off. </p><br><p>  Go to the build settings and <del>  remove extra parts </del>  set the existing <strong>USE_HEADER_MAPS</strong> flag to <strong>NO</strong> : </p><br><p><img src="https://cloud.kilograpp.com/f/90f4927450/?dl=1" alt="image"></p><br><p>  Now we need to compensate for the lost functionality and manually add the location of all project headers. </p><br><p>  Nowhere do we leave the settings and with our hands we prescribe paths to folders with headers in the field 'user header search paths': </p><br><p><img src="https://cloud.kilograpp.com/f/161ac8386c/?dl=1" alt="image"></p><br><p>  In the Swift project, they should be small, only your custom Obj-C things. </p><br><p>  Again we do a full clean and try to start a project.  If you flew into the following error </p><br><p><img src="https://cloud.kilograpp.com/f/78d65446d5/?dl=1" alt="image"></p><br><p>  it means you just forgot to mention the path to one or several header files.  After correcting them, everything should come together without complications, since apart from that we did not make any changes. </p><br><p>  As a bonus, we note that incremental compilation works best with the whole-module-optimization (WMO) turned off, which we talked about <a href="https://habrahabr.ru/post/317298/">last time</a> .  This does not mean that the solution does not work for a full-modular optimization, it just goes without a few seconds faster.  Let the assembly with a clean slate and stretch for ages. <br>  Here everyone decides for himself that he is more comfortable, faster and better suited.  If you decide to opt out of WMO, then it is enough to remove the SWIFT_WHOLE_MODULE_OPTIMIZATION flag from the project settings; there should be no difficulty whatsoever. </p><br><p>  <strong>Result</strong> : we successfully fixed the incremental compilation.  From now on, no more than a few seconds should be spent on the very fact of Swift build, not counting codesign, linking and various build scripts (we'll talk about them below).  Inside the company, we tested this method on three different projects, several versions of OSX and in general many configurations in general, which also applies to Xcode.  And now, for a long time, we do not observe relapses. </p><br><h3 id="razgon-cocoapods-i-carthage">  Overclocking Cocoapods and Carthage </h3><br><p>  Probably, many have noticed that, apart from the compilation itself, a lot of time is spent on different 'shell scripts': </p><br><p><img src="https://cloud.kilograpp.com/f/481e8c700b/?dl=1" alt="image"></p><br><p>  When using cocoapods and / or carthage there are even several of them.  Their execution takes from 3 to 10 seconds each time depending on the speed of your disk, processor and the position of the stars in the sky.  Cocoapods registers itself there automatically, and for Carthage you have to do it <a href="https://github.com/Carthage/Carthage">manually</a> . <br>  Having studied the content a bit, we found out that these scripts do nothing more than copying their resources into the project's build directory.  However, they do not care about whether these files were already copied or not.  Although it would be much more logical to check the availability of the necessary resources before copying them again. </p><br><p>  What we will do. </p><br><h4 id="nachnem-s-carthage">  Let's start with Carthage. </h4><br><p>  The inspiration for this decision was an underestimated <a href="http://stackoverflow.com/a/40512275/1092100">response to StackOverflow</a> , where a disposable crutch was adopted and covered with huskies.  By the way, if you suddenly decide to use an approved solution, you will catch wild and hot mistakes in Runtime if you make a full clean. </p><br><p>  We will not do this, so let's go the right way and modify our Copy Carthage Frameworks build phase: </p><br><pre><code class="bash hljs">FILE=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${TARGET_BUILD_DIR}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${UNLOCALIZED_RESOURCES_FOLDER_PATH}</span></span></span><span class="hljs-string">/Carthage-Installation-Flag"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FILE</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> touch <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FILE</span></span></span><span class="hljs-string">"</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/carthage copy-frameworks</code> </pre> <br><p>  This script additionally copies together with the resources one more empty file, which serves as a beacon that the operation was successful.  It does not take place, does not give side effects. <del>  and allowed for children from 3 years </del>  .  The next time the script is launched, it will first check for the presence of this file, and if there is a file, the operation will automatically complete without unnecessary gestures. </p><br><p>  To be sure, a screenshot of the result that we should get: </p><br><p><img src="https://cloud.kilograpp.com/f/86e587601c/?dl=1" alt="image"></p><br><p>  <strong>Important!</strong>  If you decide to add or remove a dependency from Carthage, then before assembling the project you should definitely perform a full clean.  Otherwise, the script will assume that it has already installed everything for a long time.  And you will be trying to find an explanation for what is happening. </p><br><p>  By the way, you can find the clean function in the menu along the path Product ‚Üí Clean. </p><br><p><img src="https://cloud.kilograpp.com/f/dfa6c35c46/?dl=1" alt="image"></p><br><p>  If you also hold down the option (alt), then you can make a <em><a href="http://stackoverflow.com/a/14706272/1092100">special</a></em> clean, which also <del>  expels demons from project </del>  removes various local settings, cache, and often failing other nonsense. </p><br><h5 id="teper-cocoapods">  Now cocoapods </h5><br><p>  For beans, the principle is the same, but since the scripts are automatically generated, you have to add a little magic to the Podfile.  To do this, we do the following lines at the very end of the file: </p><br><pre> <code class="ruby hljs">post_install <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|installer|</span></span> Dir.glob(installer.sandbox.target_support_files_root + <span class="hljs-string"><span class="hljs-string">"Pods-*/*.sh"</span></span>).each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|script|</span></span> flag_name = File.basename(script, <span class="hljs-string"><span class="hljs-string">".sh"</span></span>) + <span class="hljs-string"><span class="hljs-string">"-Installation-Flag"</span></span> folder = <span class="hljs-string"><span class="hljs-string">"${TARGET_BUILD_DIR}/${UNLOCALIZED_RESOURCES_FOLDER_PATH}"</span></span> file = File.join(folder, flag_name) content = File.read(script) content.gsub!(<span class="hljs-regexp"><span class="hljs-regexp">/set -e/</span></span>, <span class="hljs-string"><span class="hljs-string">"set -e\nKG_FILE=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{file}</span></span></span><span class="hljs-string">\"\nif [ -f \"$KG_FILE\" ]; then exit 0; fi\nmkdir -p \"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{folder}</span></span></span><span class="hljs-string">\"\ntouch \"$KG_FILE\""</span></span>) File.write(script, content) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  The principle of operation of this script is the same: it adds a check for a file flag to resource copy scripts.  It does not change the build phases, unlike Carthage, but immediately modifies the cocoapods script itself. </p><br><p>  <strong>By the way</strong> , if you already had the post_install block involved, then you do not need to create another one, just place the script inside the existing one.  The latest versions of Cocoapods (1.1.1) display a warning if you screw up, but earlier ones just silently swallow the error, providing you with a fun debugging. </p><br><p>  Now you can make ' <strong>pod install</strong> ' for the changes to take effect.  As in the case of Carthage, when editing a Podfile, you also need a full clean project before launching. </p><br><p><img src="https://cloud.kilograpp.com/f/a64fb5efd2/?dl=1" alt="image"><br>  <strong>PS</strong> Ruby is not my native language, hold sneakers. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  Thus, we managed to reduce the project build time from 45 seconds to 5 seconds. </p><br><p>  I almost forgot proofs.  Assembly time to: </p><br><p><img src="https://cloud.kilograpp.com/f/7b3e1436f1/?dl=1" alt="image"></p><br><p>  Screenshot taken from the <a href="https://www.youtube.com/watch%3Fv%3DxY8LvAsprqs">video</a> to the last article. </p><br><p>  Assembly time after: </p><br><p><img src="https://cloud.kilograpp.com/f/2d8c4f0829/?dl=1&amp;t=1" alt="image"></p><br><p>  In my opinion, extremely significant result.  The cost reduction approach must necessarily be in the arsenal of each company and developer. </p><br><p>  I am sure that among you there are people with Xcode optimization experience who are ready to supplement and share their thoughts.  And in general, I would like to see questions in the comments so that in my next articles I mention you, your experience, the experience of your colleagues and highlight the topic, since  for me it is a hobby, life and work. </p><br><p>  Finally, I will share the utility I used to measure the compile time of methods: <a href="https://github.com/RobertGummesson/BuildTimeAnalyzer-for-Xcode">https://github.com/RobertGummesson/BuildTimeAnalyzer-for-Xcode</a> <br>  Shows individually each function and the total time spent on its assembly. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/317650/">https://habr.com/ru/post/317650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317638/index.html">Overcoming difficulties: Gravity Defied on sed</a></li>
<li><a href="../317640/index.html">How does Netflix streaming work</a></li>
<li><a href="../317642/index.html">One tool for all subscriptions - newsletters, RSS, telegram feeds, social networking pages</a></li>
<li><a href="../317644/index.html">Ransomware Trojans - security theme of the year</a></li>
<li><a href="../317648/index.html">How we solved the problem of parental committees and earned a million rubles.</a></li>
<li><a href="../317652/index.html">We supplement Scrum with architectural processes. Part 1. Requirements</a></li>
<li><a href="../317654/index.html">Another story about migration to the EU</a></li>
<li><a href="../317656/index.html">Frogger game development for Vectrex computer</a></li>
<li><a href="../317660/index.html">PostgreSQL slave + btrfs and systemd = hot test database</a></li>
<li><a href="../317662/index.html">Using Github as a user data store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>