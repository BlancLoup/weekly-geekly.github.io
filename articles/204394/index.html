<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows Azure Mobile Services custom API on the example of a whiteboard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I want to share the experience of creating a simple bike skramboard with a backend in the cloud based on Windows Azure Mobile Service...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows Azure Mobile Services custom API on the example of a whiteboard</h1><div class="post__text post__text-html js-mediator-article">  In this article, I want to share the experience of creating <s>a</s> simple <s>bike</s> skramboard with a backend in the cloud based on Windows Azure Mobile Services and Azure Cloud Storage. <br><a name="habracut"></a><br><br>  It is necessary to immediately warn picky readers that the main priority was simplicity and time minimization.  In the end, this important artifact of agile development is just a white board with pieces of paper, therefore, in the virtual analog there will be only basic functionality. <br>  Windows Azure platform was not chosen by chance.  Despite the fact that Azure, like any other cloud platform, is not cheap, in our scenario, when a small agile team will use the board, this decision will cost almost nothing. <br>  The article is more about what you can get from Windows Azure, especially if you already have a subscription. <br>  All source code is available in the open source project at <a href="https://bitbucket.org/savamura/scrumboard">https://bitbucket.org/savamura/scrumboard</a> . <br><br>  Look at the UI without backend <a href="http://scrumboardstorage.blob.core.windows.net/uitest/index.html">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Client part </h5><br>  The main part of the application is the client code.  It was his writing that took the most time (in fact, it took the most time to write an article).  Despite this, I will not describe the implementation in too much detail, relying on clear code.  The client will need <a href="http://h5bp.com/">HTML5 Boilerplate</a> , <a href="http://jquery.com/">jQuery</a> , <a href="http://api.jqueryui.com/">jQuery UI</a> , <a href="http://knockoutjs.com/">knockout.js</a> , <a href="http://underscorejs.org/">underscore.js</a> , a little <a href="http://backbonejs.org/">Backbone.js</a> .  Mix all together in MVVM salad, add salt to taste. <br>  View (View) is one html page with two buttons (new sticker, save board), a dialog with the properties of the sticker and, in fact, the field where these stickers are ‚Äúpasted‚Äù.  Above is a strip with phases under which you can place a sticker. <br>  The data model is extremely simple - it is the coordinates of the sticker, the inscription, additional information, as well as a link to the task in your favorite task management system.  The coordinates of the sticker are changed by dragging it, and the associated data via the dialog box.  Drag and drop stickers and dialog boxes are effortlessly obtained using jQuery.UI.  Using knockout.js allows you to separate the presentation logic from the elements of this representation.  In the entire application, there are three ViewModel: BoardViewModel, StickerViewModel and StickerPropertiesDialogViewModel. <br>  We will return to the client a little later.  First, create a backend mobile service. <br><br><h5>  Azure Mobile Service and Custom API </h5><br>  Windows Azure Mobile Services is a specialized cloud hosting for node.js applications.  In addition to the REST API, Push notifications to the main mobile platforms are available, authentication using identity providers (Google, Facebook, Twitter, Microsoft), launching scheduled tasks.  You can create your application directly in the web console, and you can configure the synchronization of the application with the git repository.  Let's try both. <br>  First, create a new Mobile Service in the Azure web console.  You must select a unique name, region, as well as the option ‚ÄúCreate a free 20 MB SQL database‚Äù.  You cannot immediately abandon the database, but you can delete it after it is created, or not use it.  The fact is that out of the box there are two types of REST API available: the base CRUD API for managing data in SQL tables and the Custom API in which you can do anything.  It is a little strange that the SQL database is so annoyingly proposed for use in the cloud service (although if you compare its cost with the cost of no-SQL storage, then everything becomes clear).  We could, of course, store data in the SQL database, and, most likely, 20 megabytes would be enough for our board, but it seems to me that in the cloud service it is better to use cloud storage, besides, it is perfect for our task.  That is why we will write a Custom API in which we will save and load data into Azure Table Storage. <br>  So, go to the API tab and create a new one.  Set the name ‚Äúboard‚Äù and leave the default access settings for HTTP requests: ‚ÄúAnybody with the Application Key‚Äù.  Later these values ‚Äã‚Äãcan be changed.  Clicking on the newly created API will open the online code editor with the Hello World application.  On this, we will probably finish our acquaintance with the online editor. <br>  To be able to access the API from the local machine during debugging, you need to remember to write the cross-origin resource sharing (CORS) rule in the ‚Äúconfigure‚Äù tab.  You can specify localhost or simply *, thereby allowing access to the API from anywhere. <br><br><h5>  Deploy to the cloud using git </h5><br>  Azure Mobile Services allows you to deploy a web application using a private git repository.  Let's try to take advantage of this cool feature, besides, it will give us an easy way to edit the code in your favorite IDE. <br>  Go to the ‚ÄúDashboard‚Äù tab and in the ‚ÄúQuick glance‚Äù column click on ‚ÄúSetup source control‚Äù.  At the time of this writing, this option was in a preview state. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e8/b5f/53f/7e8b5f53f4736b711f491b4dad71347b.png"><br><br>  You will be asked to come up with a username and password for the git repository, after which Azure thinks a bit and in the ‚ÄúConfigure‚Äù tab you will see the path to the private repository and the secret URL, the synchronization code of the repository with the running application, but I synchronized automatically.  Now you can clone the created repository locally using your favorite git client, for example, SourceTree.  Also clone <a href="">bitbucket.org/savamura/scrumboard.git</a> .  Inside you will find the service folder, which needs to be synchronized with the one that was obtained as a result of the cloning of the Azure repository.  Before you change the changes back to the cloud, let's deal with the server code. <br><br><h5>  Server side code </h5><br>  There are four subfolders in the service folder: api with a custom API code, a scheduler with a code of tasks running according to a schedule, shared may contain common code, npm modules.  The table folder is intended for scripts that modify data in the corresponding SQL table. <br>  Each js script inside the api folder should have a paired json file with the same name.  It contains access settings for our API. <br>  Board.js is a node.js module that is used by the <a href="http://expressjs.com/">express</a> web engine inside Azure Mobile Services. <br>  Our application will require express, azure, and underscore modules: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"express"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> azure = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"azure"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"underscore"</span></span>);</code> </pre> <br><br>  Since we will store the data in Table Storage, we need to prepare it.  Return to the Azure web-based management console, create a separate Cloud Storage and copy the Access Key.  To access the repository, we use the TableService client written by Microsoft. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createTableService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> azure.createTableService( <span class="hljs-string"><span class="hljs-string">"your_storage_acount"</span></span>, <span class="hljs-string"><span class="hljs-string">"your_storage_account_key"</span></span>); }</code> </pre><br><br>  The table in which the stickers will be stored can be created both in the web console and from the code.  Our application is not too heavy, and for illustration I have included the code that checks the existence of the table, but it is easier to prepare it in advance so as not to complicate the processing of requests. <br>  Our API will handle only two types of requests: get (will return the entire board) and post (save it). <br>  Inside the methods, you can use console.log tracing.  Logs are available in the web console.  Not very convenient, but at least you can debug it. <br>  Since the application runs in node.js, all code is asynchronous.  You need to be careful and do not forget to complete the request (request.respond or response.send).  Full <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj554226.aspx">documentation is available on MSDN</a> .  First we check the existence of the table and create it using the createTableIfNotExists method.  The method passes the name of the table and the callback function. <br><pre> <code class="javascript hljs">exports.post = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(request.body); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableService = createTableService(); tableService.createTableIfNotExists(<span class="hljs-string"><span class="hljs-string">"Stickers"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Table Stickers created or existed"</span></span>); saveBoard(tableService, request.body, response); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); response.send( statusCodes.INTERNAL_SERVER_ERROR, { <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">"Table creation failed. "</span></span> + error }); } }); };</code> </pre><br>  If the table exists, save the data: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveBoard</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tableService, boardModel, response</span></span></span><span class="hljs-function">) </span></span>{ tableService.beginBatch(); _.each( boardModel.stickers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sticker</span></span></span><span class="hljs-function">) </span></span>{ sticker.PartitionKey = boardModel.boardId; sticker.RowKey = sticker.id; tableService.insertOrReplaceEntity(stickersTableName, sticker); }); tableService.commitBatch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, operationResponses, batchResponse</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> batchErrors = <span class="hljs-string"><span class="hljs-string">""</span></span>; _.each( operationResponses, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">opresp</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (opresp.error) batchErrors += opresp.error }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Stickers saved. Error: "</span></span> + error + <span class="hljs-string"><span class="hljs-string">" "</span></span> + batchErrors); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(operationResponses); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(batchResponse); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error || batchErrors !== <span class="hljs-string"><span class="hljs-string">""</span></span>) { response.send( statusCodes.INTERNAL_SERVER_ERROR, { <span class="hljs-attr"><span class="hljs-attr">message</span></span> : error + <span class="hljs-string"><span class="hljs-string">" "</span></span> + batchErrors }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.send(statusCodes.OK, { <span class="hljs-attr"><span class="hljs-attr">message</span></span> : <span class="hljs-string"><span class="hljs-string">'Batch commited!'</span></span> }); } }); }</code> </pre><br>  Please note that a batch is used to save these stickers.  It must be remembered that the batches have some limitations, for example, the PartitionKey should be the same for all entries, and the number of entries should not exceed 100. In this example, there is no splitting of all entries into batchies of 100 pieces. <br>  In order to save a record to a table, the object hierarchy must be linearized.  In other words, unlike, for example, from MongoDB, the tree object structure cannot be saved.  Linearization occurs on the client.  As the PartitionKey, the board identifier (guid) is used, which is now reserved in the client, but in the general case can be anything.  The RowKey uses stickerId (guid), which is also created on the client. <br>  In order to extract data from a table, it is enough to correctly form a query: <br><pre> <code class="javascript hljs">exports.get = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(request); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> boardId = request.query.boardId; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!boardId) { response.send(statusCodes.BAD_REQUEST, { <span class="hljs-attr"><span class="hljs-attr">message</span></span> : <span class="hljs-string"><span class="hljs-string">'boardId is undefined.'</span></span> }); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = azure.TableQuery.select() .from(stickersTableName) .where(<span class="hljs-string"><span class="hljs-string">'PartitionKey eq ?'</span></span>, boardId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableService = createTableService(); tableService.queryEntities( query, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, entities</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!error) { response.send(statusCodes.OK, entities); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.send(statusCodes.INTERNAL_SERVER_ERROR, error); } }); };</code> </pre><br>  Here, in fact, the entire base server code.  Of course, there must also be validation of the input data, error handling and access checking.  Also, it would not hurt to implement the removal of stickers and protection against xss-attacks.  All these problems we address in the next versions.  The main thing is to provide basic functionality. <br>  We only need to bind the client and server code. <br><br><h5>  MobileServicesClient </h5><br>  The code that makes server-side calls is encapsulated in the StorageClient hotel wrapper class and, of course, can be replaced.  There are only two methods: load the board and save the board.  Information about all the stickers is immediately linearized, serialized and transmitted to the server.  Of course, it would be possible to transfer only the changed data, but this will complicate the code somewhat. <br>  To make custom API remote calls, you can use the WindowsAzure.MobileServicesClient client provided by Microsoft.  It will be available at your_custom_api.azure-mobile.net/client/MobileServices.Web-1.0.3.min.js (version may vary).  The link to it can also be copied from the Azure web console, if you click on the cloud icon with a lightning bolt next to ‚ÄúDashboard‚Äù, then select the HTML / JavaScript platform and Connect an existing HTML app.  There you can also get an API access key (below the manage keys button is the application key).  The key can be re-created, while the old one will stop working. <br>  StorageClient Constructor: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> StorageClient = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.azureClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WindowsAzure.MobileServiceClient( <span class="hljs-string"><span class="hljs-string">'https://your_custom_api.azure-mobile.net/'</span></span>, <span class="hljs-string"><span class="hljs-string">'your_application_key_goes_here'</span></span>); };</code> </pre><br>  Our custom API is called board, so to save the board data, you need to do the following: <br><pre> <code class="javascript hljs">StorageClient.prototype.saveBoard = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.azureClient .invokeApi( <span class="hljs-string"><span class="hljs-string">"board"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: data }) .done( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(response); $.jGrowl(<span class="hljs-string"><span class="hljs-string">"Board saved!"</span></span>); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = error.request; $.jGrowl(<span class="hljs-string"><span class="hljs-string">"Error calling azure API "</span></span> + xhr.status + <span class="hljs-string"><span class="hljs-string">" "</span></span> + xhr.responseText); }); };</code> </pre><br>  azureClient.invokeApi returns a promise, to complete which, you can subscribe. <br>  The method of loading data looks the same, however, we additionally pass in it methods that will need to be called upon completion of the download. <br><pre> <code class="javascript hljs">StorageClient.prototype.loadBoard = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">boardId, onBoardLoaded, onBoardLoadFailed</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.azureClient .invokeApi( <span class="hljs-string"><span class="hljs-string">"board"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-attr"><span class="hljs-attr">parameters</span></span>: { <span class="hljs-attr"><span class="hljs-attr">boardId</span></span>: boardId } }) .done( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xmlHttpRequest</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(xmlHttpRequest); onBoardLoaded(xmlHttpRequest); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = error.request; onBoardLoadFailed(xhr); }); };</code> </pre><br><br><h5>  Client Deploy in Blob Storage </h5><br>  We assume that we have debugged our application locally.  It's time to embark him.  As you may have guessed, hosting static content is best in Azure Blob Storage.  To do this, you need a container that you can create, for example, via the Azure web console.  During creation, specify the level of access to Public Blob, which will mean that access to all blobs in the container will be public, but the metadata of the container itself will remain private. <br>  Now you need to upload files with client code to the cloud.  The console utility AzCopy, which can be <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D40893">downloaded from the Microsoft Download Center, is</a> perfect for this task.  Click Download and select WindowsAzureStorageTools.msi.  After installation, copy all the files you need to upload to the cloud in a separate folder. <br>  Execute <br>  AzCopy &lt;project folder&gt; &lt;container path&gt; / destKey: &lt;access key&gt; / S <br><br>  If immediately after this you try to open your application in the browser (index.html), you will find that the browser opens a dialog box for selecting the path to save the file.  This is due to the blob's content type, which by default is set to application / octet-stream. <br>  This needs to be fixed by writing a small console application in C #.  In it, we will go over all the blobs in the container and set them to the standard Content Type depending on the extension.  Don't forget to plug in the nuget Windows Azure Storage package. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BlobMetadataChanger</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> containerName = args[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storageAccount = CloudStorageAccount.Parse(connectionString); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blobClient = storageAccount.CreateCloudBlobClient(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> container = blobClient.GetContainerReference(containerName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blobs = container.ListBlobs(useFlatBlobListing: <span class="hljs-literal"><span class="hljs-literal">true</span></span>).Cast&lt;CloudBlockBlob&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blob <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> blobs) { UpdateBlobContentTypeIfExtensionMatch(blob, <span class="hljs-string"><span class="hljs-string">".html"</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html; charset=UTF-8"</span></span>); UpdateBlobContentTypeIfExtensionMatch(blob, <span class="hljs-string"><span class="hljs-string">".css"</span></span>, <span class="hljs-string"><span class="hljs-string">"text/css; charset=UTF-8"</span></span>); UpdateBlobContentTypeIfExtensionMatch(blob, <span class="hljs-string"><span class="hljs-string">".js"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/javascript"</span></span>); UpdateBlobContentTypeIfExtensionMatch(blob, <span class="hljs-string"><span class="hljs-string">".png"</span></span>, <span class="hljs-string"><span class="hljs-string">"image/png"</span></span>); UpdateBlobContentTypeIfExtensionMatch(blob, <span class="hljs-string"><span class="hljs-string">".gif"</span></span>, <span class="hljs-string"><span class="hljs-string">"image/gif"</span></span>); UpdateBlobContentTypeIfExtensionMatch(blob, <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, <span class="hljs-string"><span class="hljs-string">"image/jpg"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateBlobContentTypeIfExtensionMatch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> CloudBlockBlob blob, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> extension, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> contentType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (blob.Name.EndsWith(extension)) { blob.Properties.ContentType = contentType; blob.SetProperties(); } } } }</code> </pre><br>  Everything, after executing this utility with the correct parameters, you can open the application through a browser. <br><br><h5>  Access control </h5><br>  On this, perhaps, it was possible to finish, but we missed one important detail: access control.  Now anyone with a link to the application can see the tasks you need to complete in order to take over the world.  In truth, your plans are most likely not interesting to anyone, and if you choose guid as the container name, then you need not worry.  However, anything can happen, and if you want to control the situation, you will have to make a little more effort. <br>  Open the Azure web console, find your mobile app and go to the ‚ÄúIdentity‚Äù tab.  Let's say that everyone in the team has a twitter account, so we will register our board as a web application there: <a href="https://dev.twitter.com/apps/new">https://dev.twitter.com/apps/new</a> .  After filling in all the fields, you will receive the coveted Consumer Key and Consumer Secret, which must be copied to the appropriate fields in the ‚ÄúIdentity‚Äù tab.  In addition, it is very important to specify the main URL of your mobile service as the Callback URL in the twitter settings of the application, as well as put a check mark in front of ‚ÄúAllow this application to be used.‚Äù  I did not understand this immediately, so I had to suffer. <br>  Now it is enough, in the http application, after creating the MobileServiceClient client and before sending the request for receiving the board data, call <br><pre> <code class="javascript hljs">azureClient.login(<span class="hljs-string"><span class="hljs-string">"twitter"</span></span>).then(loadBoard, onError);</code> </pre><br>  The process is described in detail in this <a href="http://www.windowsazure.com/en-us/develop/mobile/tutorials/get-started-with-users-html/">lesson</a> . <br>  In the web application code, at the beginning of each of the custom API methods, you need to check the userId. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> allowedUsers = [ ‚ÄúTwitter:<span class="hljs-number"><span class="hljs-number">1111111</span></span>‚Äù, ‚ÄúTwitter:<span class="hljs-number"><span class="hljs-number">22222222</span></span>‚Äù ]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.find( allowedUsers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">allowedUser</span></span></span><span class="hljs-function">) </span></span>{ request.user.userId == allowedUser }) !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>; }</code> </pre><br><br><h5>  Conclusion </h5><br>  So we got to the end of this article, but not to the end of the topic.  Last week, a new batch of updates to the Azure cloud service came out, including the emergence of support for CORS in Cloud Storage.  This means that by rewriting the storageClient client code and setting the CORS rules as necessary, you can save the data in Table Storage directly from the browser.  In this case, you do not even need to write the server part in the form of the Azure Mobile Service, since its main function is to save the data to a table.  Of course, we will lose the ability to authenticate users, but we will get a working application consisting only of the browser client code.  <a href="http://habrahabr.ru/post/204966/">Habrastia</a> has already appeared on this topic. <br></div><p>Source: <a href="https://habr.com/ru/post/204394/">https://habr.com/ru/post/204394/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204376/index.html">Heavy lonely indie burden</a></li>
<li><a href="../204380/index.html">Finding periodic solutions of a class of non-autonomous systems of differential equations</a></li>
<li><a href="../204384/index.html">Chips for Android</a></li>
<li><a href="../204390/index.html">Akenori 1080 X Review: How to Turn the Recorder into an Integrated Security System</a></li>
<li><a href="../204392/index.html">MongoDB Is Web Scale</a></li>
<li><a href="../204396/index.html">China sent its moon rover to the moon</a></li>
<li><a href="../204400/index.html">DARPA Director Speech</a></li>
<li><a href="../204414/index.html">Embedded Technology 2013 - From Japan with Love</a></li>
<li><a href="../204416/index.html">The reasons for the partial inaccessibility of "Vkontakte" in Ukraine</a></li>
<li><a href="../204418/index.html">Need more chaos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>