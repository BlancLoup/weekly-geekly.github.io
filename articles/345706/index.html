<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Distributed backends for 2GIS video advertising on .NET Core and Kubernetes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 We continue to talk about development companies that use Microsoft technology in their projects. In today's issue is the company 2GIS , whos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Distributed backends for 2GIS video advertising on .NET Core and Kubernetes</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  We continue to talk about development companies that use Microsoft technology in their projects.  In today's issue is the company <a href="http://2gis.ru/">2GIS</a> , whose main office is located in cold Novosibirsk and to which the author of the article feeds the warmest feelings. <br><br>  2GIS recently completed a large project using the core functionality of <b>.NET Core, Kubernetes and many Linux</b> .  I often get questions about whether .NET Core can be used in production, what is our experience of using it in a fully open source environment.  I asked the guys to tell you how.  Read more under the cut, it's worth it - this is one of the first public and large projects that are built on .NET Core, and even in the full Open Source around. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/webt/ex/02/rn/ex02rnwje0_ukjf3xsb86p28odu.jpeg"></div><br><a name="habracut"></a><br>  It is on behalf of the architect of the project, Denis Ivanov (on the <a href="https://habr.com/ru/users/denisivanov/" class="user_link">DenisIvanov habr</a> ), Microsoft MVP on .NET, the human back-end of the famous <a href="http://codefest.ru/">CodeFest</a> conference.  Inna Savchkova (on the <a href="https://habr.com/ru/users/innasavchkova/" class="user_link">InnaSavchkova habr</a> ), Tech PR Manager 2GIS, provided our conversation with a beautiful and understandable language and, of course, a dash instead of hyphens.  Questions asked <a href="https://habr.com/ru/users/ahriman/" class="user_link">ahriman</a> . <br><br>  <b>Hello!</b>  <b>What is 2GIS?</b> <br><br>  <a href="http://2gis.ru/">2GIS</a> is a company that provides complete and accurate information about 330+ cities in 9 countries.  This is all that may be needed in the city: streets, houses, companies operating in different areas, their contacts and useful information about them (such as, working hours and average bill in a restaurant or user reviews of travel companies), entrances to buildings , ways to travel and much more.  Now 2GIS "knows" everything about all 2.3 million firms in Russia with an accuracy of 95%. <br><br>  The company has a separate product team, which constantly analyzes what users are telling us, verifying the applicability of new ideas, some of which later become the basis for new 2GIS product features. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0z/em/mz/0zemmzuybbekh1mteuaniaz0qlq.jpeg"></div><br><br>  2GIS uses a wide range of technologies to build its systems and products.  However, this is mainly Open Source.  It's simple - it works on all platforms <i>(and 2GIS also has a bunch of projects on GitHub - <a href="https://github.com/2gis">https://github.com/2gis</a> . Author's note)</i> <br><br>  The RnD-department of the company has more than 20 teams that create tools for collecting and organizing information, cartographic systems and services, tools for selling and placing advertising, online, offline and mobile applications. <br><br>  <b>Microsoft recently released an <a href="http://customers.microsoft.com/en-US/story/2gis-professional-services-asp-net-core">official press release about your project</a> .</b>  <b>So you decided to make a new project with a small team on .NET Core, Kubernetes &amp; Linux.</b>  <b>Who decided to use such a bundle?</b>  <b>Why?</b>  <b>What for?</b>  <b>What benefits have you seen?</b>  <b>What are the potential problems?</b> <br><br>  Profit 2GIS receives from the sale of advertising opportunities to companies that want to be more visible to users of 2GIS products. <br><br>  One of the ideas that needed to be tested was the hypothesis of advertisers' interest in placing videos.  Prior to this, only text or graphic advertising could be placed in 2GIS. <br><br>  The main goal was to bring the tools for the sale and placement of video advertising to the market as soon as possible.  It was decided to entrust this task to developers from a team that knows the subject area well and has extensive experience in developing internal advertising sales tools.  Internal systems are implemented on the .NET Framework and use the Windows platform for deployment.  However, the requirements for high availability, resiliency and performance of video advertising services prompted the use of the same infrastructure and operating systems as 2GIS online products.  Fortunately, at the time of development, the cross-platform .NET Core was already half a year released for widespread use, and after testing and creating a prototype, it was decided to use the .NET Core bundle, Kubernetes &amp; Linux to implement video advertising services. <br><br>  This made it possible for two programmers and an analyst to complete a task in just 2 months.  This time includes all the work: starting with a detailed study of requirements and ending with release into the combat infrastructure.  In addition, it became possible to use any convenient development tools and operating systems, including Windows and macOS. <br><br><img src="https://habrastorage.org/webt/fv/k9/wh/fvk9whgcler56auqiuzvwgqcsra.jpeg"><br>  Project team - from left to right engineers and project manager <br><br>  <b>Where is the ‚Äúheart‚Äù of the project?</b>  <b>How do you ensure that global customers get the same level of service in this structure?</b> <br><br>  Kubernetes cluster is used in 2GIS as a platform on which many services of the company are launched.  In fact, there are three such clusters - two in Russia and one in Europe.  This is a well-managed infrastructure with all the necessary properties: balancing, multi-level fault tolerance, detailed monitoring and the ability to receive and analyze any logs and custom telemetry from applications.  Therefore, the choice of where to deploy backend video advertising services, in fact, did not stand. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/el/qr/mv/elqrmvzhf55ap81_1g6dbsfxig4.jpeg"></div><br>  Project architecture <br><br>  From the point of view of storage, transcoding and sharing video files, everything is a little different.  To solve these problems, we use the services provided by the cloud partner, specializing only in working with video.  In terms of classic 3-layer architectures, the video advertising service we created at 2GIS is business logic, the API for storing, transcoding and uploading video files (CDN) is data storage, and all 2GIS products are frontend. <br><br>  In this scheme, all our backends are geographically distributed, so all customers receive approximately the same level of service. <br><br>  <b>Returning to the general details of the project - tell us about the current indicators (users, workload).</b>  <b>Is the project already in production or still being tested?</b> <br><br>  Service in production since April 2017, and now we have about 20,000 video ad requests per day.  More than 80% of them we answer from the cache.  This gives us the opportunity to keep quite high loads, although at the current stage we have no more than 100 RPS at the peak. <br><br>  <b>What architectural solutions used in the project?</b> <br><br>  If this is a global project, then the architecture should be suitable for high loads from different places.  What do you think, what architectural patterns / approaches of the masthead for such a project?  What tools are used to monitor what is happening, have you experienced difficulties?  DDOS? <br><br>  As for the used architectural solutions and approaches, video advertising service is not much different from other distributed applications designed for uninterrupted work with a large audience of users.  There is a whole set of best practices for building distributed applications, for example, you should pay attention to the <a href="https://www.youtube.com/watch%3Fv%3DxJMbkZvuVO0%26list%3DPL9XzOCngAkqs0Q8ZRdafnSYExKQurZrBY">course of Jeffrey Richter</a> . <br><br>  The very first thing to consider is the <b>proper use of server resources</b> .  The threads used should not be blocked for long; this is achieved by writing asynchronous code.  If the same data is often requested, you need to use a cache.  If there is little such data, then even a cache in memory will suffice.  You should always keep in mind that short-term failures are possible in distributed systems (network ‚Äúflashing‚Äù, restarting infrastructure services, etc.).  Here quite simple patterns in use, such as Timeout, Retry, Fallback and their combinations, help.  There is an excellent <a href="https://github.com/App-vNext/Polly">Polly</a> library that provides a collection of similar off-the-shelf tools. <br><br>  Difficulties, of course, are.  They occur when any of the infrastructure or partner services go to prevention or when there is a disruption in the work of the network of providers.  Despite the ‚Äúyouth‚Äù of .NET Core and the relatively small number of uses of this platform for building such solutions, we have a particularly positive experience - we did not encounter any ‚Äúspecial effects‚Äù or strange behavior of the application due to the JIT compiler, garbage collection or other CLR components.  We really hope that this trend will continue. <br><br>  A few words about DDoS or similar attacks.  Since  we use the common infrastructure of the company, we did not have to solve all these issues.  Here we completely rely on the high qualifications of our infrastructure engineers and their tracking and protection solutions. <br><br>  <b>What are the growth plans?</b> <br><br>  Video advertising is now becoming one of the basic tools for attracting users' attention to advertisers, along with text and graphic advertising.  There are already several advertising positions where video advertising is used. <br><br>  We are thinking about using our own infrastructure for storing source videos in order to reduce, first of all, legal risks.  We also continue to improve internal processes and systems for managing and selling advertising in general, and video advertising in particular.  All this provides increased efficiency within 2GIS. <br><br>  <b>The growth is fraught with the danger of a service dropping under a heavy load.</b>  <b>Whats up?</b> <br><br>  2GIS built all the necessary infrastructure for load testing services based on Gatling.  All that is needed to use it is to deploy the application on special ‚Äúiron‚Äù servers running Kubernetes, and to write scripts of load tests on Scala.  All necessary metrics, comparisons of results between launches, reports and graphs are provided by the platform for load testing. <br><br>  Thank! <br><br>  You can read more about the technologies used in <a href="https://habrahabr.ru/company/2gis/">2GIS</a> in the company's corporate blog.  Technical reports, in which there is a lot of real experience of all that is listed above, are <a href="http://techno.2gis.ru/lectures/">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/345706/">https://habr.com/ru/post/345706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345696/index.html">Do you want a 6.5 deposit? Calculation of the rate of return on shares and full return using the Moex API and the dividend parser</a></li>
<li><a href="../345698/index.html">We turn speakers into speakers on the example of HighLoad ++</a></li>
<li><a href="../345700/index.html">Mobile retargeting - the main tool for promoting mobile applications in 2018</a></li>
<li><a href="../345702/index.html">The story of the emergence of financial accounting in my life</a></li>
<li><a href="../345704/index.html">Amazon EC2 vs Atlex Cloud VDC: Performance Comparison</a></li>
<li><a href="../345708/index.html">Cross-platform New Year's demo on .NET Core and Avalonia</a></li>
<li><a href="../345710/index.html">Unity newbie bugs tested in their own skin</a></li>
<li><a href="../345712/index.html">New to the New Year: a review of Veeam Backup & Replication 9.5 Update 3</a></li>
<li><a href="../345714/index.html">Mathematical models of relay-pulse regulators</a></li>
<li><a href="../345716/index.html">SAP Cloud Platform Webinar Library: from Internet of Things services to machine learning and UX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>