<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Java 10 migration notes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr. As you remember, the official release of Java 10 recently occurred . Considering that almost everyone now uses mostly 8-ku, with the rele...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Java 10 migration notes</h1><div class="post__text post__text-html js-mediator-article">  Hello, Habr.  As you remember, the <a href="http://openjdk.java.net/projects/jdk/10/">official release of</a> Java 10 recently <a href="http://openjdk.java.net/projects/jdk/10/">occurred</a> . Considering that almost everyone now uses mostly 8-ku, with the release of 10-ki, we are waiting for such goodies as modularity (entered 9-ku) and <a href="http://openjdk.java.net/jeps/286">local variable type inference</a> .  It sounds good, you can try to experiment with the transfer of some existing project to 10-ku. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f4b/ece/954/f4bece954ed0e3ed290e0b1e6880740d.png" alt="image"></div><br>  About what kinds of pain are waiting for us, you can find out under the cut. <br><a name="habracut"></a><br>  I <s>‚Äôll just leave it here.</s> I‚Äôm not aiming to present here all possible problems with the migration of java-projects from the 8th Java version to the 9th or 10th.  I want to fix my little experience of first contact with new versions of Java somehow except in oral discussions with colleagues.  Maybe he <s>will stop</s> someone will be useful. <br><div style="text-align:center;"><img width="400" src="https://habrastorage.org/getpro/habr/post_images/348/c0d/5cc/348c0d5cc2c7d40417b4c863f1843125.jpg" alt="image"></div><br><br>  To begin with, IDEA version 2018.1 refused to work on JVM versions 9 and 10, and on 2 different machines.  It looked like the absence of a part of the GUI elements and the lack of a theme for a part of the remaining elements.  This was a small problem, since IDEA can specify a specific JVM to run. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  1. Problems with the implementation of modularity </h2><br>  To begin with, let's make our application modular (it‚Äôs not for nothing that the JDK developers tried and <a href="https://mreinhold.org/blog/late-for-the-train">suffered</a> over the Jigsaw project)? <br><br><h3>  1.1.  Jdeps utility issues </h3><br>  To get the java module from the existing class hierarchy, we <a href="https://guides.gradle.org/building-java-9-modules/">will need</a> : <br><br><ul><li>  write 1 or more module-info.java files with the names of modules, dependencies and exported packages in them </li><li>  add arguments to the compiler (--module-path and others) </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/049/e11/0fb/049e110fb509e3d6f49e2a63a4a82452.gif" alt="image"></div><br>  It seems that everything looks pretty simple at first glance. <br><br><h4>  1.1.1.  Dependencies on external libraries no longer work without special spells. </h4><br>  Nothing is going to happen.  If you want to build a modular application, then your dependencies must also be modular.  Otherwise, it will simply not be possible to add them to module-info.java.  You can add something more precisely - old-fashioned jar-files of libraries are considered as so-called ‚Äúautomatic modules‚Äù.  However, the problem is that automatic modules cannot be used during assembly.  Yes, in popular repositories so far there are very few libraries assembled as modules and you simply cannot use them.  Nobody cares. <br><br>  This is where the jdeps utility was needed, which can parse the jar file and generate module-info.java for it to make an old-fashioned jar module.  As a workaround <s>crutch</s> , it was decided to simply take and <s>leave to</s> unpack all the dependencies in one pile and make a single jar from which you can try to make a fashionable module-with-all-dependencies.  The example on stackoverflow is <a href="https://stackoverflow.com/questions/47727869/creating-module-info-for-automatic-modules-with-jdeps-in-java-9">attached</a> . <br><br><h4>  1.1.2.  You will need <i>to include</i> significantly more dependencies than you really need. </h4><br>  Jdeps resolves dependencies recursively, and even dependencies that Maven / Gradle consider optional are required to be resolved.  As a result, the dependency tree of even a small experimental project grows several times.  A module with dependencies, which was decided to produce in paragraph (1.1.1), <s>drains the Internet floor</s> becomes very heavy.  An example of the presentation of this pain <a href="http://mail.openjdk.java.net/pipermail/jigsaw-dev/2016-September/009317.html">here</a> .  Suddenly, it turns out that log4j requires AWT, OSGI, ZeroMQ, Kafka or something else like this. <br><br><h4>  1.1.3.  Unexpected public [Roskomnadzor] utilities </h4><br>  It was found that in a situation where some classes are duplicated in different modules, jdeps fall out with the IllegalStateException stack path from somewhere in the depths of their code without any explanation of what went wrong.  Only one small hook is the message ‚Äúdependency on self‚Äù as an argument to the exception constructor.  At some point it seemed to me that this disgrace <i>seemed to hint</i> that everything (application classes, dependency classes, ‚Äúoptional‚Äù dependency classes) should be dumped into one jar file.  And really - it worked. <br><br><h3>  1.2.  Runtime issues </h3><br>  Even when everything was already miraculously gathered, modularly attached, and even a custom JRE image to it, it turned out that the most important surprises are still to come.  That is, in runtime. <br><br><h4>  1.2.1.  Now it is impossible to determine the path to the start file / directory </h4><br>  In a Java application, there is often a need to determine the path to the directory where <s>the pheasant sits a</s> jar file from which the application was launched (for example, a jar file containing an entry point).  This is usually necessary to understand where to look for application files ‚Äî configuration, plug-ins, and so on.  Such things usually lie in the neighborhood (which is quite logical).  To determine this path, a spell of the form usually helps: <br><br><pre><code class="java hljs">Main.getProtectionDomain().getCodeSource().getLocation().toURI()</code> </pre> <br>  What was my surprise when I discovered that in new versions of Java this spell no longer works and I see something like ‚Äújrt: //com.example.myapp‚Äù instead of the path to the file.  I began to frantically google and overflow the stack.  I tried to identify the module and somehow find out which files belong to it.  Attempts to access the classpath also brought me to nothing, because modularly the application starts with the so-called module path instead of the old-fashioned classpath.  It was the finish.  It was at that moment that I decided to minimize my experiment on moving to Java 10. No, of course, one could pass the directory path on the command line or force the user to run only from the correct directory.  But for myself, I personally decided that I had enough for now. <br><br><h4>  1.2.2.  Failure when trying to determine the file MIME type. </h4><br>  It turned out that the cherry on the cake was not one.  For experiments with a ten, I installed it and configured it as the default JVM in the system.  Therefore, surprises continued.  Code like <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String mimeType = Files.probeContentType(itemInputFilePath);</code> </pre><br>  began to cause null to be returned if the argument was a regular CSV file with the appropriate extension.  ‚ÄúHow so?‚Äù - I thought, ‚Äúis it really impossible for the JVM to determine the MIME type for a regular CSV file?‚Äù.  I did a little bang and found that the view call <br><br><pre> <code class="java hljs">Files.readAllLines(<span class="hljs-string"><span class="hljs-string">"/etc/mime.types"</span></span>, Charset.defaultCharset())</code> </pre><br>  completely impudently throws an unintelligible exception with a message like "malformed input". <br>  Deeper in the reasons for this outrage, I did not understand yet.  Just checked the file /etc/mime.types - the <s>cracks are not found, it</s> seems, a normal text file.  That is, the JVM could not read the lines from the text file. <br><br><h4>  1.2.3.  Non-working mechanism Service Providers </h4><br>  Starting from version 9, Java also offers a new mechanism for Service Providers to replace the old one.  The thing is not bad, it allows you to make plugins that are resolved at runtime.  A new mechanism implies the declaration of an extension in module-info.java using the keywords ‚Äúprovides‚Äù and ‚Äúwith‚Äù.  It would seem that it could be easier.  In practice, this did not work, unlike the old mechanism (using the resources / META-INF / services / ... files).  Understand what the problem is not enough time.  However, the mark that does not take off without special spells, I probably will do it here. <br><br><h2>  2. Reflections on the implementation of local variable type inference </h2><br>  In the case of the local variable type inference, we have a new keyword "var" (variable, variable), which hints at the influence of Scala.  However, personally it seemed to me strange, why they also did not add ‚Äúval‚Äù (value, value).  Instead, you have to write ‚Äúfinal var‚Äù, which is read by the eyes as a ‚Äúfinal variable‚Äù or even as a ‚Äúconstant variable‚Äù - and this is not only less concise, but also somehow slightly contradictory, in my opinion <s>, used to a good</s> look. <br><br>  Also found some pretty funny things.  For example: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> someStrings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;String&gt;();</code> </pre><br>  Here, the JVM ‚Äúremembers‚Äù behind the name ‚ÄúsomeStrings‚Äù the type ArrayList &lt;String&gt;.  <s>Sometimes, with <s>full moon</s> clever syntax highlighting, you can see a warning that the type of a constant is redundant, and in Java it is common to use interfaces in this place, such as List &lt;String&gt; or even Collection &lt;String&gt;.</s>  <s>This warning from an extremely smart editor can be avoided by declaring a constant like this:</s> This type is redundant, since it is common to use the minimally necessary interface to reduce potential connectivity (so that no one will begin to pull ArrayList-specific methods, for example).  Local variable type inference violates this principle.  This can be avoided in the following way: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> someStrings = (List&lt;String&gt;) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;();</code> </pre><br>  but it already looks somehow not very concise.  This moment does not claim to be the title of some fatal flaw, but it demonstrates a slight patina of inconsistency. <br><br><h2>  3. Disappointing conclusions </h2><br>  Some of the problems voiced in this note emerged as early as version 9.  Given that they have not been fixed so far, there is an unpleasant feeling that this whole mess will be in the 11th version and even further.  I would not like to click into the world, but something else follows from this subjective feeling: Java, as a programming language, begins to experience its decline.  Maybe I'm wrong, and maybe it is, and then to replace Java, you need to look for another tool. <br><br><h2>  UPDATE </h2><br>  Unfortunately, I am writing from memory, so some details are missing.  I also remembered another great thing.  This is an annotachka <a href="https://stackoverflow.com/questions/34529036/what-is-sun-misc-contended-annotations-value">sun.misc.Contended</a> , which appeared in the 8th version and was safely cut out in subsequent ones.  Despite her short life, she managed to get into one of the used <a href="https://mvnrepository.com/artifact/com.conversantmedia/disruptor">libraries</a> , which also caused a lot of trouble.  It is not in 10-ke and everything, do what you want, but for building the module it is required, since there is a link to the class.  It all ended with the fact that I, remembering that the conversantmedia disruptor library is not a mandatory dependency, I simply replaced the required classes from it with empty ones in my source code.  And this is one of the little things that did not have a number ... </div><p>Source: <a href="https://habr.com/ru/post/354114/">https://habr.com/ru/post/354114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354104/index.html">React HoC in TypeScript. Typing without pain</a></li>
<li><a href="../354106/index.html">How to get rid of the difficulty in managing a state in React - report on the results of a trip to React Amsterdam</a></li>
<li><a href="../354108/index.html">How to create a neural network with just 30 lines of JavaScript code</a></li>
<li><a href="../354110/index.html">Urgent Relocation from Amazon Web Services - Two Customer Stories</a></li>
<li><a href="../354112/index.html">Own Goal We are testing DDoS protection.</a></li>
<li><a href="../354116/index.html">Inventions for smugglers and pharmacists + training your research institute</a></li>
<li><a href="../354118/index.html">True XP / TDD in Pivotal from the inside: how does it look and is it possible?</a></li>
<li><a href="../354120/index.html">Checking the source code of the free graphical editor Krita 4.0</a></li>
<li><a href="../354122/index.html">The million question</a></li>
<li><a href="../354124/index.html">Review of materials on machine learning ‚Ññ 3 (April 16 - 23, 2018)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>