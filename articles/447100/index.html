<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with MS SQL from Powershell on Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is purely practical and is dedicated to my sad story. 
 Preparing for Zero Touch PROD for RDS (MS SQL), about which we had all our ears b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with MS SQL from Powershell on Linux</h1><div class="post__text post__text-html js-mediator-article"><h2>  This article is purely practical and is dedicated to my sad story. </h2><br>  Preparing for <b>Zero Touch PROD</b> for RDS (MS SQL), about which we had all our ears buzzed, I made a presentation (POC - Proof Of Concept) of automation: a set of powershell scripts.  After the presentation, when the stormy, prolonged applause, turning into an incessant applause, subsided, I was told that everything is fine, but for ideological reasons, all Jenkins slaves work under Linux! <br><br>  Is it possible?  Take such a warm, lamp DBA from under Windows and stick it into the thick of powershell under Linux?  Isn't that cruel? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/no/ah/qm/noahqmkdy7zdvyywgyno-gzeh6e.jpeg" width="500"></div><br>  I had to immerse myself in this strange combination of technology.  Of course, all my 30+ scripts have stopped working.  To my surprise, I managed to fix everything in one working day.  I am writing in hot pursuit.  So, what pitfalls can you encounter when transferring powershell scripts from Windows to Linux? <br><a name="habracut"></a><br><h2>  sqlcmd vs Invoke-SqlCmd </h2><br>  I recall the main difference between them.  The good old utility <b>sqlcmd</b> works under Linux, with almost identical functionality.  For the execution, we pass -Q, the input file as -i, and the output -o.  That's just the file names, of course, are made case-sensitive.  If you use -i, write at the end in the file: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs">GO EXIT</code> </pre> <br>  If at the end there is no EXIT, then sqlcmd will go to waiting for input, and if there is no <b>GO</b> before <b>EXIT</b> , then the last command will not work.  All output, selects, messages, print and so on gets into the output file. <br><br>  Invoke-SqlCmd returns the result as a DataSet, DataTables, or DataRows.  Therefore, if you can process the result of a simple select using <b>sqlcmd</b> and <b>parse</b> its output, then it is almost impossible to derive something complex: for this there is <b>Invoke-SqlCmd</b> .  But this team also has its own jokes: <br><br><ul><li>  If you pass it a file through <b>-InputFile</b> , then <b>EXIT is</b> not needed, moreover, it gives a syntax error </li><li>  <b>-OutputFile</b> no, the command returns the result to you as an object </li><li>  There are two syntaxes for specifying a server: <b>-ServerInstance -Username -Password -Database</b> and via <b>-ConnectionString</b> .  Oddly enough, in the first case, specify a port other than 1433, it does not work. </li><li>  text output, such as PRINT, which is <b>just</b> ‚Äúcaught‚Äù by <b>sqlcmd</b> , <a href="https://stackoverflow.com/questions/4511498/powershell-invoke-sqlcmd-capture-verbose-output">is a problem</a> for <b>Invoke-SqlCmd</b> </li><li>  And most importantly: <a href="https://stackoverflow.com/questions/52210823/invoke-sqlcmd-cmlet-missing-in-powershell-core-sqlserver-module-for-linux">most likely in your Linux this cmdlet is not!</a> </li></ul><br>  And this is the main problem.  Only in March this cmdlet <a href="http://sqlvariant.com/2019/03/invoke-sqlcmd-is-now-available-cross-platform-in-the-sqlserver-module/">became available for non-windows platforms</a> , and finally we can move forward! <br><br><h2>  Variable substitution </h2><br>  In sqlcmd, there is variable substitution with -v, for example, like this: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># $conn    sqlcmd $cmd = $conn + " -i D:\apps\SlaveJobs\KillSpid.sql -o killspid.res -v spid =`"" + $spid + "`" -v age =`"" + $age + "`"" Invoke-Expression $cmd</span></span></code> </pre> <br>  In the script in SQL, we use substitutions: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @spid=$(spid) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @age=$(age)</code> </pre> <br>  So here.  In * nix <b>, variable substitution does not work</b> .  The <b>-v option is</b> ignored.  <b>Invoke-SqlCmd is</b> ignored by <b>-Variables</b> .  Although the parameter that sets the variables themselves is ignored, the substitutions themselves work - you can use any variables from Shell.  However, I was offended by the variables and decided not to depend on them at all, and acted roughly and primitively, since the scripts in sql are short: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># prepend the parameters "declare @age int, @spid int" | Add-Content "q.sql" "set @spid=" + $spid | Add-Content "q.sql" "set @age=" + $age | Add-Content "q.sql" foreach ($line in Get-Content "Sqlserver/Automation/KillSpid.sql") { $line | Add-Content "q.sql" } $cmd = "/opt/mssql-tools/bin/" + $conn + " -i q.sql -o res.log"</span></span></code> </pre> <br>  This, as you understand, is already a test from the Unix version. <br><br><h2>  File upload </h2><br>  In the Windows version, I had any operation accompanied by an audit: we executed sqlcmd, got some abuse in the output file, attached this file to the audit label.  Fortunately, the SQL server worked on the same server as Jenkins, it was done like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> AuditUpload @<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @filename <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#multi (filer NVARCHAR(MAX)) set @sql='BULK INSERT #multi FROM '''+@filename +''' WITH (ROWTERMINATOR = ''\0'',CODEPAGE = ''ACP'')' exec (@sql) select @sql=filer from #multi update JenkinsAudit set multiliner=@sql where ID=@id return</span></span></code> </pre> <br>  So we swallow the whole BCP file, and shove it into the nvarchar (max) field of the audit table.  Of course, this whole system crumbled, because instead of a SQL server, I got RDS, and BULK INSERT generally does not work on \\ UNC because of an attempt to take an exclusive file on the file, and with RDS it was initially doomed.  So I decided to change the system design, keeping the audit line by line: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> AuditOut ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, TextLine <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, n <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> )</code> </pre> <br>  And write in this table like this: <br><br><pre> <code class="python hljs">function WriteAudit([string]$Filename, [string]$ConnStr, [string]$Tabname, [string]$Jobname) { <span class="hljs-comment"><span class="hljs-comment"># get $lastid of the last execution --    #create grid and populate it with data from file $audit = Get-Content $Filename $DT = new-object Data.DataTable $COL1 = new-object Data.DataColumn; $COL1.ColumnName = "ID"; $COL1.DataType = [System.Type]::GetType("System.Int32") $COL2 = new-object Data.DataColumn; $COL2.ColumnName = "TextLine"; $COL2.DataType = [System.Type]::GetType("System.String") $DT.Columns.Add($COL1) $DT.Columns.Add($COL2) foreach ($line in $audit) { $DR = $dt.NewRow() $DR.Item("ID") = $lastid $DR.Item("TextLine") = $line $DT.Rows.Add($DR) } # write it to table $conn=new-object System.Data.SqlClient.SQLConnection $conn.ConnectionString = $ConnStr $conn.Open() $bulkCopy = new-object ("Data.SqlClient.SqlBulkCopy") $ConnStr $bulkCopy.DestinationTableName = $Tabname $bulkCopy.BatchSize = 50000 $bulkCopy.BulkCopyTimeout = 0 $bulkCopy.WriteToServer($DT) $conn.Close() }</span></span></code> </pre><br>  To select content, select by ID, choosing n (identity) in order. <br><br>  In the next article I will focus on how this all interacts with Jenkins. </div><p>Source: <a href="https://habr.com/ru/post/447100/">https://habr.com/ru/post/447100/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447090/index.html">Reference: how the process of continuous integration is arranged</a></li>
<li><a href="../447092/index.html">What range is this antenna? Measure antenna performance</a></li>
<li><a href="../447094/index.html">Machine learning for managers: the sacrament of separation</a></li>
<li><a href="../447096/index.html">This year there will be no robots, whatever Ilon tells</a></li>
<li><a href="../447098/index.html">Transferring the project from Swift 4.2 to Swift 5.0</a></li>
<li><a href="../447102/index.html">Record "Progress MS-11": the most interesting to come</a></li>
<li><a href="../447104/index.html">How I implanted RFID into my hand, and then NFC. Part 2</a></li>
<li><a href="../447106/index.html">Low, high, last. GLC - the fifth element of Lakhta Center</a></li>
<li><a href="../447108/index.html">Decentralization: a big problem for Blockchain</a></li>
<li><a href="../447110/index.html">The digest of interesting materials for the mobile developer # 293 (April 1 - 7)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>