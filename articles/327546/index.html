<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we "Miss Russia" in the hands of endured</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On April 15, the Miss Russia 2017 contest was held. After the site was completely reworked, the page loading speed began to fit within one second, eve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we "Miss Russia" in the hands of endured</h1><div class="post__text post__text-html js-mediator-article">  On April 15, the Miss Russia 2017 contest was held. After the site was completely reworked, the page loading speed began to fit within one second, even at times of peak loads.  Our partners from <a href="http://byndyusoft.com/">Byndyusoft</a> , represented by Alexander Bindyu ( <a href="https://habrahabr.ru/users/alexanderbyndyu/">@alexanderbyndyu</a> ), the architect of the entire system, told how they did it, shared the details of the platform transfer to the cloud, and also told why they had to change the entire internal infrastructure of the project. <br><br><img src="https://habrastorage.org/files/31d/9bd/30f/31d9bd30f4774ae597ba0a09fec3640f.jpg"><br><br>  <i>Information about the company: <a href="http://byndyusoft.com/">Byndyusoft</a> is a company that implements projects on the .NET platform for various subject areas around the world.</i> <br><a name="habracut"></a><br><h2>  <b>About competition</b> <b><br></b> </h2><br>  The national contest "Miss Russia" is the country's largest project in the field of beauty.  Currently, the competition is supported by the Ministry of Culture of the Russian Federation.  This year the contest celebrated its 25th anniversary. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The qualifying rounds of "Miss Russia" are held in 85 regions of the Russian Federation, each year more than 75,000 girls take part in castings. <br><br>  The contest "Miss Russia" has unique rights to represent our country at the largest international beauty contests "Miss World" and "Miss Universe". <br><br><img src="https://habrastorage.org/files/99e/554/7f1/99e5547f1eed4a528c8511f5911f370c.PNG"><br><br>  The peculiarity of the contest site is that 97% of the traffic and 100% of the voting take place within two weeks in April.  Compared with the April load the rest of the year passes without loads. <br><br><img src="https://habrastorage.org/files/b7a/7a2/06c/b7a7a206cfa9477ca5b0185685d19a8c.png"><br><br><h3>  What is the problem </h3><br><br>  Over the past few years, the Miss Russia site has been constantly refurbished and reworked, updated each year to a new competition.  By the 25th anniversary, ‚ÄúMission Russia‚Äù arrived with a design from Studio Lebedev, who lived on the <a href="https://www.plesk.com/">CMS ‚ÄúSplash‚Äù</a> <i>(correction, 10.05.2017 - Cubique CMS, not Plesk)</i> . <br><br>  During the contest, users constantly complained that the pages open slowly, give a 500-error and voting does not work.  There were attempts to ‚Äúoverclock‚Äù the site, but they ended unsuccessfully. <br><br>  The site was hosted on a dedicated server.  Adding iron to the server has ceased to be beneficial.  When the customer conducted load testing, the site dropped 150 requests per second. <br><br><img src="https://habrastorage.org/files/83e/3a1/f09/83e3a1f0980c4d8fb5d99dfb52d02d4e.png"><br>  <i>Load tests of the first version</i> <br><br>  <b>First try</b> <br><br>  At first, customers tried to transfer the site from a dedicated server to the cloud - they copied the virtual machine and launched it on Azure.  Despite the increased power and hope for the "clouds", the <b>speed dropped</b> , the site went down at 90 requests per second. <br><br><img src="https://habrastorage.org/files/b77/cb4/f16/b77cb4f1616f4c0fb30f3f6c04fa470a.png"><br>  <i>The first version on Azure</i> <br><br>  The competition site could not be scaled horizontally.  You add 5 times more iron, and productivity increases by 30%;  you increase two times more - it increases by another 2%.  A typical problem of monolithic systems. <br><br><img src="https://habrastorage.org/files/99c/bbd/db6/99cbbddb652849c4a799ffeadec7197f.png"><br>  <i>Old Version Architecture</i> <br><br>  Of course, the old Miss Russia could be tricky.  For example, add a CDN or raise a few virtual locks through the balancer.  But each such move would have rested against the problems of the old code and the CMS, and still would not bring the desired flexibility in scaling. <br>  It became clear that it needs to be redone completely under the new architecture and cloud infrastructure. <br><br>  <b>Second try</b> <br><br>  The customer came to us with a task: you need to transfer ‚ÄúMiss Russia‚Äù to the cloud and achieve sufficient speed.  We looked under the hood and realized that with the current architecture it would not be possible to achieve business goals.  We decided to redo everything from scratch. <br><br>  <b>Layout</b> <br><br>  First we turned the site.  He began to weigh less and open faster.  Previously, the site could meet some tiny avatar, which actually loaded highres and weighed 3 MB.  As a result, achieved such results for the new site: <br><br><ol><li>  <b>2..13 times</b> less requests per page. </li><li>  <b>5..16 times</b> less traffic. </li><li>  <b>8 times</b> less time for full load. </li></ol><br>  Analyzed the Metric and it turned out that 60% of visitors go through mobile devices.  The site has been redesigned so that everything becomes adaptive and responsive. <br><br>  <b>It was</b> <br><br><img src="https://habrastorage.org/files/470/aff/9d7/470aff9d7d8140fa8d59986ef327f308.png"><br><br>  <b>It became</b> <br><br><div class="oembed"><div><div style="left: 0px; width: 100%; height: 0px; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0px; left: 0px; width: 100%; height: 100%; position: absolute;">  Your browser does not support HTML5 video. <source src="http://miss-russia.surge.sh/photos-after.mp4" type="video/mp4"></video></div></div></div><br><br><h3>  <b>Architecture</b> </h3><br>  Instead of a monolithic backend, they implemented a distributed microservice architecture so that in order to increase capacity, it was not necessary to flood the site with server capacity, but it was enough to add load on the necessary service at the right time. <br><br>  For the new architecture, we took as the basis the ideas that would lead to the achievement of business goals: <br><br><ol><li>  Split the app into (micro) responsibility. </li><li>  Each part will perfectly fulfill its role. </li><li>  Each part will take care of scaling itself. </li><li>  Total automation. </li></ol><br>  As a result, came to this architecture: <br><br><img src="https://habrastorage.org/files/3b5/113/047/3b5113047c2f4dc9a2af32c6b04e1ad7.png"><br><br><h3>  <b>New architecture</b> </h3><br><br>  Previously, all requests from the site fell into the monolith block, which was responsible for processing votes and generating content.  When overloading one module, others also began to slow down.  Now each part works and scales independently. <br><br>  The new result of load testing inspired optimism: <br><br><ol><li>  Loaded through a network with a bandwidth of 1 Gbit / s. </li><li>  After ~ 5450 RPS we see the first problems with server responses. </li><li>  Response time did not exceed 1000 ms </li></ol><br><br><img src="https://habrastorage.org/files/04e/ada/b00/04eadab00c1641129115552c58faf347.png"><br><br><h3>  <b>Technology</b> </h3><br>  Azure provides a choice in technology and solutions.  For example, which CDN to take?  Akamai or Verizon?  We set up experiments and selected the most appropriate tools, finding a couple of critical problems along the way. <br><br>  <b>.NET Core and Kestrel</b> <br><br>  New competition site written in .NET Core.  We have been working with him in production on other projects for half a year - we see no problems. <br><br>  The only unpleasant problem arose with Kestrel, which, under load, began to respond with code 502.3.  At the same time, the application fell and did not come to life until restart. <br><br>  The problem was in the version of Kestrel 1.1.0.  Description in <a href="https://github.com/aspnet/IISIntegration/issues/323">Issue323</a> and <a href="https://github.com/aspnet/IISIntegration/issues/311">Issue311</a> .  We were lucky that two weeks before the competition, Microsoft.AspNetCore.Server.Kestrel version 1.1.1 came out and the problem was gone. <br><br>  <b>CDN</b> <br><br>  We chose between Akamai and Verizone.  Chose Akamai, because  they have a cache server in Russia, which is important for the competition audience. <br><br>  CDN generally used the standard approach: <br><br><ol><li>  Pictures are cached for 7 days, HTML is updated 1 time per hour. </li><li>  JavaScript and CSS of new versions automatically fall into the CDN, each version is cached separately. </li><li>  Compression enabled. </li><li>  You can manually reset the cache. </li></ol><br>  If you want to cache HTML, please note that Akamai CDN only supports 3rd level domains.  For caching we had to redirect from <a href="http://missrussia.ru/">missrussia.ru</a> to <a href="http://www.missrussia.ru/">www.missrussia.ru</a> . <br><br>  <b>Webapp</b> <br><br>  We deployed the main site and API in separate WebApps.  When changing the load, we had a choice according to the scaling method: <br><br><ul><li>  Scale Up: increase / decrease the capacity by changing the tariff. </li><li>  Scale Out: increase the number of instances.  At the same time, Azure itself balances the load between working copies of the service. </li></ul><br>  During the contest, both WebApps worked at the S3 tariff, after the competition at the S1 tariff, in order not to burn money when there is no load. <br><br>  <b>Service bus</b> <br><br>  We chose a queue between Service Bus and Storage Queues.  Here is what we needed: <br><br><ol><li>  Small messaging with short processing time. </li><li>  No need for transactions and support for the order of processing messages. </li><li>  Client availability under .NET Core. </li></ol><br>  Chose Service Bus with <a href="https://github.com/Azure/azure-service-bus-dotnet">.NET Standard client library for Azure Service Bus</a> . <br><br>  If the queue is slow and drops when sending a message, then check that you: <br><br><ul><li>  Raised queues in the same region as the services that read and publish messages. </li><li>  Registered client <a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-performance-improvements">ServiceBus as Singleton</a> , so that every time not to connect. </li></ul><br>  <b>WebJob and vote checking</b> <br><br>  When solving the problem with voting, it was necessary to take into account that the influx of voters did not affect the speed of response of the main site.  In addition, it was important to strengthen the algorithms for eliminating bots, because in the past year ‚Äúcheating‚Äù votes was a problem.  That is, the voting system should work faster and at the same time make a more complex analysis. <br><br>  We smashed in time the definition of voice quality and voice increment.  When a person votes, they always answer: ‚ÄúThank you, your vote has been counted!‚Äù.  At this point, a message is generated about the voice, the message is sent to the queue, where it waits for its turn to parse in the voice processing service.  The processed voices fall into the database, and then, a few hours later, to the site.  The vote count is added at once to hundreds and thousands of units. <br><br>  This approach allowed us to remove the feedback for those who tried to pick up the parameters of the API call for cheating votes.  Now it was not clear to them how the system responded to a POST request formed manually. <br><br>  In terms of horizontal scaling, the solution is also excellent.  The Service Bus queue is scaled horizontally, and in order to speed up the heavy analysis of the voice, it is enough to lift several dozen voice processing services.  In Azure, you can raise several WebJobs either manually with a couple of mouse clicks or automatically. <br><br>  There is a technical nuance, why we chose WebJob for the voice processing service, rather than the Service Fabric. <br><br>  To work via Service Fabric under .NET Core, you need to <a href="">install the SDK</a> from a special Ubuntu repository.  This creates problems both with the deployment and during the development.  And WebJob is ready to work with .NET Core without any extra movement. <br><br>  <b>Pure PaaS</b> <br><br>  The whole project was made by our two developers in four weeks.  It turned out so quickly in part due to the fact that the entire infrastructure clicked on the mouse in the Microsoft Azure web interface is pure PaaS.  We have not created or configured any virtual machine. <br><br>  Scaling vertical and horizontal was also done with the mouse. <br><br>  <b>Microservices</b> <br><br>  Although the project is small and there are only three micro-responsibilities, but we adhered to the <a href="http://blog.byndyu.ru/2016/11/it.html%3Fm%3D1">basic ideas of</a> microservice architecture.  In the project, we have identified three microservices: a voice processor (service), a voice receiver (API), and a content creator (Web). <br><br>  Microservices are completely independent.  If any of them turns off, the rest will continue to work.  If any of them experience a load and begin to slow down, others will not know about it. <br><br>  If, after processing the vote, we would like to send an SMS to the girl with a greeting that they voted for her, then another microservice connected to the Service Bus would appear on the diagram.  This microservice would consume the events that were formed for it at the moment the voice processing was completed.  Thus, the architecture is expandable almost infinitely. <br><br>  The only thing that distinguishes the new architecture of the Miss Russia contest site from the canonical microservice is a common database for all microservices.  In this case, we specifically made this simplification in order to save time and money.  The base is small, there is not much data and they are divided in the database so that they almost do not overlap.  If ever the logic in the project becomes complicated, which is unlikely, then we will give each microservice in the repository. <br><br><h2>  <b>Result</b> </h2><br>  <b>Site speed</b> <br><br>  The site runs fast and smooth, even on mobile.  All content is cached in the CDN, which coped with 5500 requests per second.  Caching in the browser, in the CDN and in the web application allowed 99.7% of users to open the page of the Miss Russia contest in less than one second. <br><br><img src="https://habrastorage.org/files/20c/153/582/20c1535821e942b18a2da32fabac8be1.png"><br><br>  <b>Load flexibility</b> <br><br>  Due to the flexibility of allocating capacity in Azure, the cost of a new infrastructure during voting (two weeks a year) is equal to the cost of a dedicated server for a previous version of the site.  But after the vote, we removed unnecessary power in a couple of clicks and the cost was 3 times cheaper. <br><br>  On large projects, we usually create an automated system, which in the case of load itself adds instances of services, when there is no load, it reduces their number.  Peaks are not only in connection with well-known events (Black Friday, March 8), but also per diem (at night, at rush day), weekly (at the weekend, no one, on weekly peaks), random (someone mentioned the site on a popular forum) therefore automation is necessary. <br><br>  <b>Voting</b> <br><br>  Voting fulfilled 100% of requests, no user received a 500-error.  Of the 750K votes, the algorithm eliminated approximately 500K as bots, and the remaining votes were credited to the girls. <br><br>  The contest organizers received transparent reporting on the voting process: who and how many votes were received, who tried to wind up the results. <br><br>  <b>findings</b> <br><br>  Literate architecture allowed: <br><br>  - Giving more resources to the loaded parts, less to the unloaded. <br>  - Remove the influence of parts of the system on each other. <br>  - For each part, resources are allocated only when it is required. <br><br>  <b>Additional materials on architecture:</b> <br><br><ul><li>  Slides of the report from the <a href="https://events.techdays.ru/Modern-Architecture/2017-04/schedule">architectural conference DevCon</a> : <a href="https://www.slideshare.net/AlexanderByndyu/paas-75250917">Microservices, pure PaaS and the Miss Russia contest</a> </li><li>  <a href="https://blog.byndyusoft.com/useful-tools-for-managing-complexity-of-microservice-architecture-109a2289acc">Useful Tools for Managing Complexity of Microservice Architecture</a> </li><li>  <a href="https://blog.byndyusoft.com/clouds-ipaas-citizen-integrator-and-why-indias-outsourcing-is-loosing-money-924eeafb1b97">Clouds, iPaaS, Citizen Integrator and Why India's Outsourcing Is Losing Money</a> </li></ul><br><br><h2>  The author of the material </h2><br><img src="https://habrastorage.org/files/a32/618/04f/a3261804fb2f4077a6225805daef9057.jpeg" align="left" width="120">  <b>Alexander Bindju ( <a href="https://habrahabr.ru/users/alexanderbyndyu/">@alexanderbyndyu</a> )</b> - Owner of Byndyusoft, expert in Agile and Lean, IT-architect. <br><br>  <i>The project was completed with the connection of expert support CSP-provider <a href="https://infoboxcloud.ru/">InfoboxCloud</a> , which promptly answered all questions about Azure.</i> </div><p>Source: <a href="https://habr.com/ru/post/327546/">https://habr.com/ru/post/327546/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327534/index.html">‚ÄúFriday format‚Äù: demotivation, or love [for work] cannot be bought for money</a></li>
<li><a href="../327536/index.html">What is a service mesh and why do I need it [for a cloud microservice application]?</a></li>
<li><a href="../327540/index.html">Apple Music: not trying to hide the pain</a></li>
<li><a href="../327542/index.html">Threats to the WPA2-Enterprise wireless corporate network and how to protect</a></li>
<li><a href="../327544/index.html">Friday JS: the only true way to calculate factorial</a></li>
<li><a href="../327548/index.html">How to take care of sites during the holidays</a></li>
<li><a href="../327550/index.html">Trend Hyper Convergence: Cisco HyperFlex</a></li>
<li><a href="../327552/index.html">What I learned from the 90s games</a></li>
<li><a href="../327554/index.html">Rise of the Machines: How robots captured accounting</a></li>
<li><a href="../327556/index.html">Configuring Spark on YARN</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>