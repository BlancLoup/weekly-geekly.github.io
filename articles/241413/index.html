<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How does safe payment acceptance in the online store</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The information provided is valid for any payment system. This includes for DSS PCI systems, simple acquiring (accepting payments by bank cards), virt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How does safe payment acceptance in the online store</h1><div class="post__text post__text-html js-mediator-article">  The information provided is valid for any payment system.  This includes for DSS PCI systems, simple acquiring (accepting payments by bank cards), virtual payment systems (Yandex.Money, WebMoney, Robocash, etc.). <br><br>  Discussion of the article <a href="http://habrahabr.ru/post/241101">‚ÄúCompromised transactions of RBK Money payers‚Äù</a> showed the critical ignorance of some commentators.  Usually, the light of knowledge in ignorance causes fear and irritation, which is interesting to track by comments.  I tried to clarify there in the discussions, for which I paid. <br><br>  How to program secure payment acceptance?  I will share my experience, tell and show.  For those in need, references to proofs are given at the end of the article. <br><a name="habracut"></a><br><h1>  Characters </h1><br>  There are three of them. <br>  1. The user is generally a live person who uses the services. <br>  2. Online store (IM) - browser CMS or APP with the payment function.  He must have an owner who has the right to engage in commercial activities (in accordance with the Civil Code of the Russian Federation - IP or the legal entity is a commercial organization).  The owner of the IM must enter into a legal agreement with the PS and fulfill the requirements of the latter for technical connection. <br>  3. Payment system (PS) - a service that provides the ability to make payments.  It must be owned by a financial institution (a legal entity that has legal capacity to carry out this type of activity). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  User action </h1><br>  1. The user selects some goods or services in IM. <br>  2. The user expresses the desire to buy and pay for the purchase in IM. <br>  3. MI sends the user to the PS. <br>  4. The user makes a payment in PS.  The user sees that the payment is successful or not successful. <br>  5. PS prompts the user to return to IM. <br>  6. If the payment was successful, the user can receive the paid goods or services.  If the payment was not successful, the user is notified accordingly. <br><br><h1>  MI actions </h1><br>  1. IM allows the user to place an order.  This is usually one or more ordered goods and services.  The goods and services should be clearly marked with the price and terms on which they are sold. <br>  2. IM forms an invoice. <br>  3. MI sends the user to the UA, while informing the invoice data for payment - the identifier, the amount. <br>  4. MI receives a notification from the PS about the success or failure of the payment.  For this, a special message is sent - past the user!  The user does not know about this message.  The message format is usually XML or JSON. <br>  5. IM responds to the PS about the successful receipt of notification of the status of payment.  The PS will not accept the money if the IM does not work, or does not wish to recognize the success of the payment (for example, the account has expired, or other events have occurred that do not allow the IM to recognize this payment).  I repeat - in this case, the PS will not accept payment from the user! <br>  6. MI welcomes the user after visiting the PS, informing the status of the account for payment.  In this case, the MS informs the IM number of the account - in the link or in the data received by the POST.  User must be logged in!  It is not necessary to report invoice data to pay to unauthorized persons (nonsense, which was discussed in the notorious comments!).  The authorization mechanism should be programmed in such a way that if an unauthorized user gets to the invoice page for payment, he should receive an ‚ÄúAccess denied‚Äù message and an invitation to log in.  Authorization for success must return (or not lead) to the current page of the site.  If the authorized user is the owner of the account, then he has the right to view his page.  If the authorized user does not own the account (and is not an employee of the MI), instead of the data, show him ACCESS DENIED. <br><br><h1>  PS actions </h1><br>  1. Accept the user from the MI along with the account data for payment. <br>  2. Accept payment from the user, in accordance with the data of the invoice for payment (amount, valid until, currency). <br>  3. Report to IM about the success or failure of payment (this is a message for IM, and not for the user!). <br>  4. Receive a message from the IM that the IM has successfully received and confirmed the message about the success of the payment!  If the IM does not respond, the PS will not accept payment from the user (will refund the money and notify that payment is denied). <br>  5. Inform the user about the success or failure of the payment (this is a message for the user, not for MI!). <br>  6. Return the user to the MI by transferring the account number (so that the user can get to the necessary page of the MI website). <br><br><img src="https://habrastorage.org/files/ff5/d5f/225/ff5d5f225ecb4b31ad643ee7b1deab85.png"><br><br><h1>  Invoice for payment </h1><br>  Add this entity to your CMS if it does not already exist. <br><br>  The invoice must have required properties: <br>  1. Identifier.  This is usually a positive integer.  MI must necessarily inform his PS when requesting payment action! <br>  2. Date when account is created <br>  3. The time during which the account is valid.  This is an optional feature, but it will avoid a lot of stupid situations. <br>  4. Amount <br>  5. User ID.  Whose account is this?  This is important information that is also used to ensure safety. <br>  6. Sign of the validity of the account. <br>  7. Other data. <br><br>  In IT, besides the invoice, there are other entities: an order, order statuses (sometimes it is not a separate entity, but simply denormalized data), goods and services in the order. <br>  No need to make an order and an invoice for payment by one entity.  There are technological reasons for this, use cases: <br>  - the user can make several payment attempts; <br>  - the validity (I mean the time of relevance) of the order may differ from the validity of the invoice, and this is normal; <br>  - the results of malfunctions (including problems of a non-technical nature) and break-ins are well documented.  Logs do not store user data (userdata).  And in this essence they are just there; <br>  - other reasons known to developers. <br><br>  Small offtopic. <br><br>  If we only talked about programming an IM, then it would be worth mentioning the following. <br>  1. Prices should be kept in essence ‚Äúgoods and services in order‚Äù.  Prices are changing and this is normal.  At the same time, the old data should not suffer - prices that were previously in effect at the time of placing orders. <br>  2. You can not make a real removal of goods and services in IM.  They should be displayed as connected data - for correct display of old orders, when they were available, were in catalogs, etc. <br><br><h1>  MI actions with account payable </h1><br>  1. Creation.  At this stage, the order must be fully formed, since data editing during the payment process is not allowed. <br>  2. The invoice for payment should not be edited during the payment process.  If the content of the order is changed and it has not yet been paid - a new invoice must be created for payment, and the old one is declared invalid. <br>  3. Changing the status of the account for payment, in accordance with the signal received from the PS.  The invoice must be valid (the date of the invoice creation and the validity period or the validity date of the invoice are checked - this can be done either way).  In this case, the IM receives a message from the PS in JSON, XML format or a POST data packet.  This message page (imposed in HTML, DOC, PDF, RTF) is by no means affected.  Moreover, it is generally not intended for people. <br>  4. Account page for the user.  Must be protected by user session.  On this page, the user who owns the account (or an employee of the IM) can see information about the status of the account: paid, unpaid, unsuccessful payment, expired, etc. <br>  When the account status changes, the trigger should trigger, which should change the status of the order.  This makes it possible to process the online store and its related modules: CRM, warehouse, etc. <br><br><h1>  Security </h1><br>  1. The user must be authorized in the MI before payment. <br>  2. It is good when user actions in IM are hidden from prying eyes via SSL. <br>  3. Messages exchanged between PS and IM are accompanied by hashes, salted secret codes, which are unique for each IM partner of PS.  The hashes are generated from the account data.  Thus, an attempt to distort the data of the original IM account will lead to failure of payment. <br>  4. All personal data, including information about the status and other details of accounts, must be protected by the user session!  Protecting them with a single hash, as discussed in the notorious comments, is not enough.  But the reasons are just there disclosed. <br><br><h1>  Sources </h1><br>  Here are the promised branches. <br>  Yandex.Money <a href="">api.yandex.ru/money/doc/dg/concepts/About.xml</a> <br>  PayPal <a href="https://developer.paypal.com/webapps/developer/docs/classic/products/">developer.paypal.com/webapps/developer/docs/classic/products</a> <br>  WebMoney <a href="http://wiki.webmoney.ru/projects/webmoney/wiki/Web_Merchant_Interface">wiki.webmoney.ru/projects/webmoney/wiki/Web_Merchant_Interface</a> <br>  Robokassa <a href="https://www.robokassa.ru/ru/Doc/Ru/Interface.aspx">www.robokassa.ru/ru/Doc/Ru/Interface.aspx</a> </div><p>Source: <a href="https://habr.com/ru/post/241413/">https://habr.com/ru/post/241413/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241395/index.html">First look at System Center Virtual Machine Manager Technical Preview</a></li>
<li><a href="../241399/index.html">Textolite - a static site management system</a></li>
<li><a href="../241407/index.html">System for "My game"</a></li>
<li><a href="../241409/index.html">STM32 Nucleo. We connect TFT LCD based on ILI9341 chip</a></li>
<li><a href="../241411/index.html">Watch Translation in Russia October 26 and Java</a></li>
<li><a href="../241415/index.html">Droidutils - a set of solutions that accelerate the development of applications for Android</a></li>
<li><a href="../241419/index.html">My little story of the development and publication of mobile games</a></li>
<li><a href="../241421/index.html">Endorphin flow mechanics on the example of three space games</a></li>
<li><a href="../241423/index.html">Create a package for Laravel</a></li>
<li><a href="../241427/index.html">VexorCI - What's new?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>