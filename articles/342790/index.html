<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Spring WebSocket. How it works?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear habravchane. At my current place of work, it was decided to transfer the interaction with the web client to WebSocket. The server part ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Spring WebSocket. How it works?</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear habravchane.  At my current place of work, it was decided to transfer the interaction with the web client to WebSocket.  The server part is written in Java using the Spring framework.  In this article, I wanted to share a feature of the Spring WebSocket device. <br><a name="habracut"></a><br>  WebSocket provides two-way communication between the client and the server using a single TCP connection. <br><br>  The protocol consists of two phases: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ay/0s/4n/ay0s4n4qoiwfx06-8psuqn58x4q.jpeg"></div><br>  For a Handshake request, an HTTP GET request is used, which results in the connection being updated to WebSocket. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article, we will examine in detail the mechanism for establishing a connection between the client and the server, pumping the connection to the WebSocket and forwarding the message to the Spring application. <br>  In the analysis we will use the Spring-WebSocket and Annotation based configuration. <br><br><h4>  Creating a configuration class </h4><br>  So, first we need to declare an access point to which the client will contact to create a connection and send data. <br><br>  To use WebSocket in the configuration class, we need to use the @EnableWebSocket annotation.  From the description of this annotation should be the need to implement the interface WebSocketConfigurer our configuration class.  The WebSocketConfigurer interface contains a single <i>registerWebSocketHandlers</i> method <i>(WebSocketHandlerRegistry registry)</i> .  Using the WebSocketHandlerRegistry input parameter, we add handlers (WebSocketHandler) of incoming messages to a specific url. <br><br>  Consider the work of the @EnableWebSocket annotation in more detail. <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Target</span></span>(ElementType.TYPE) <span class="hljs-meta"><span class="hljs-meta">@Documented</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>(DelegatingWebSocketConfiguration.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> EnableWebSocket { }</code> </pre> <br>  The main task of this annotation is to import the configuration class DelegatingWebSocketConfiguration, which with the help of @Autowired will receive instances of the WebSocketConfigurer interface (our configuration class).  These WebSocketConfigurer instances are used in the parent WebSocketConfigurationSupport class to create the HandlerMapping bean. <br><br>  Creating the HandlerMapping bean is necessary so that in the future DispatcherServlet can determine the handler for this url. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rz/d4/cy/rzd4cyagogqruzemrtxoshfpwuu.jpeg"></div><br>  To convert a WebSocketHandler into a HandlerMapping instance, we need the WebSocketHttpRequestHandler and WebSocketHandlerMapping adapters. <br><br>  Using WebSocketHttpRequestHandler, we will cast WebSocketHandler to HttpRequestHandler.  And then using the url bundle, for which we are waiting for a request to open a WebSocket, and HttpRequestHandler create an instance of WebSocketHandlerMapping, which will be registered with the DispatcherServlet to process the HTTP request. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4y/yg/ix/4yygixknolgy-8mrygs4sajqcni.jpeg"></div><br>  When a client sends a request to open a WebSocket connection, the request via DispatcherServlet comes to the <i>handleRequest</i> method <i>(HttpServletRequest servletRequest, HttpServletResponse servletResponse) of</i> our decorator WebSocketHttpRequestHandler. <br><br>  This method calls Interceptors declared in the configuration class when setting WebSocketHandlers, and calling the doHandshake method, default or user instance of HandshakeHandler. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m8/hu/4i/m8hu4iul0t6eewc71znha3upbim.jpeg"></div><br><h4>  Handshake Handling Request </h4><br>  We will dwell on the work of the doHandshake method in a bit more detail.  This is where all the magic of connection conversion to WebSockets happens.  But first, let's look at the parameters of the user request and server response. <br><br>  A typical example of a custom query is as follows: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /chat HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> Host: <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.example.com Upgrade: websocket <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span>: Upgrade Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ== Origin: http://example.com Sec-WebSocket-Protocol: chat, superchat Sec-WebSocket-<span class="hljs-keyword"><span class="hljs-keyword">Version</span></span>: <span class="hljs-number"><span class="hljs-number">13</span></span> Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits</code> </pre><br><ul><li>  Origin - contains the url from which the request is made.  Used to verify valid addresses. </li><li>  Sec-WebSocket-Protocol defines a set of sub-protocols, for example, STOMP, which will be discussed in the following articles. </li><li>  Sec-WebSocket-Key is a random key that is generated by the browser: 16 bytes in Base64 encoding. </li><li>  Sec-WebSocket-Version - protocol version. </li><li>  Sec-WebSocket-Extensions - additional extensions, for example, permessage-deflate says that messages will be transmitted in a compressed form. </li></ul><br>  Typical response from the server: <br><br><pre> <code class="hljs pgsql">HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">101</span></span> Switching Protocols Upgrade: websocket <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span>: Upgrade Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</code> </pre><br>  The HTTP 101 response code indicates a protocol switch, in our case, to a WebSocket. <br>  Sec-WebSocket-Accept is a calculated value based on the transmitted Sec-WebSocket-Key and the constant "258EAFA5-E914-47DA-95CA-C5AB0DC85B11" ‚Äîin fact, this is a confirmation from the server that it is ready to initiate a WebSocket connection. <br><br>  The work of the doHandshake method can be schematically presented as follows: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tv/aq/2s/tvaq2shyowde1_kicsjcxsnucnm.jpeg"></div><br><h4>  Request Update Strategy to WebSocket </h4><br>  Connection update strategies are currently available. <br><br><ul><li>  TomcatRequestUpgradeStrategy </li><li>  JettyRequestUpgradeStrategy </li><li>  UndertowRequestUpgradeStrategy </li><li>  GlassFishRequestUpgradeStrategy </li><li>  WebLogicRequestUpgradeStrategy </li><li>  WebSphereRequestUpgradeStrategy </li></ul><br>  The strategy update process consists of the following steps: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xr/uu/f5/xruuf5b7s4cscdy2rlcs_xa5-sy.jpeg"></div><br>  * An EndPoint instance is created by wrapping a WebSocketHandler in the StandardWebSocketHandlerAdapter, which is the EndPoint heir.  To create a session, use StandardWebSocketSession. <br><br>  ** To update HttpServletRequest, use the standard method of this interface update, to which we pass the implementation of HttpUpgradeHandler, <br>  in the case of working with Tomcat, this is a WsHttpUpgradeHandler.  When the HttpUpgradeHandler instance is initialized, the EndPonit is created and registered in the WebSocketContainer. <br><br>  After these settings, our implementation of WebSocketHandler is ready to accept incoming messages, and using WebSocketSession we were able to send messages to the client. <br><br>  Thank you very much for your attention.  In the following articles, we will consider the work of the fallback mechanism using SockJS and the capabilities of the STOMP sub-protocol. <br><br>  Used sources: <br><br>  ‚Üí <a href="https://tools.ietf.org/html/rfc6455">The WebSocket Protocol</a> <br>  ‚Üí <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html">Spring WebSocket</a> </div><p>Source: <a href="https://habr.com/ru/post/342790/">https://habr.com/ru/post/342790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342778/index.html">10 techniques for creating beautiful business presentations from 2017</a></li>
<li><a href="../342780/index.html">When should I move to test automation</a></li>
<li><a href="../342782/index.html">SensioLabs closed multiple vulnerabilities in all supported symfony versions</a></li>
<li><a href="../342786/index.html">Hedgehogs on wheels: how do we maintain the quality of communication in Moscow</a></li>
<li><a href="../342788/index.html">6 lines of deep learning</a></li>
<li><a href="../342792/index.html">United company Yandex.Taxi and Uber plans to hold an IPO in 2019</a></li>
<li><a href="../342794/index.html">Example of implementation of a general performance indicator of MS SQL Server</a></li>
<li><a href="../342796/index.html">Machine learning do-it-yourself (part 2). Service for the classification of calls to those. support</a></li>
<li><a href="../342798/index.html">JBreak 2018 Java Conference Announcement: Connecting the Dots</a></li>
<li><a href="../342800/index.html">YouTrack 2017.4 Release: Time Evaluation Report, Markdown Support, and more</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>