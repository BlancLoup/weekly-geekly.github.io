<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Budget debugger for ESP-32 and its configuration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, when writing a library for ESP-32, it became necessary to catch deadlocks, which sometimes arose because of my curvature, which necessitated...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Budget debugger for ESP-32 and its configuration</h1><div class="post__text post__text-html js-mediator-article"><p>  Recently, when writing a library for ESP-32, it became necessary to catch deadlocks, which sometimes arose because of my curvature, which necessitated the purchase of a debugger board with a JTAG interface.  What came of it - read under the cut. </p><a name="habracut"></a><br><h2 id="pribory-i-materialy">  Devices <del>  and materials </del></h2><br><p>  Our main character, or rather the goal of debugging: </p><br><img src="https://habrastorage.org/webt/ns/fa/sr/nsfasr1isbpmeuqi3smkmvjr6dc.jpeg" width="200"><br><p>  <em>Board based on the ESP-WROOM-32 chip.</em>  <em>I will not give the link, because in that place everything has already been bought up.</em> </p><br><p>  Now - the debug board itself: </p><br><img src="https://habrastorage.org/webt/jk/fa/eu/jkfaeubciptoppkc-eshrdmitz4.jpeg" width="200"><br><img src="https://habrastorage.org/webt/ny/zz/u3/nyzzu3_m8pvpffzb3ynrx3lio1m.jpeg" width="200"><br><p>  <em>CJMCU FT232H</em> </p><br><p>  I did not bother and <a href="https://aliexpress.com/item/CJMCU-FT232H-High-Speed-Multifunction-USB-to-JTAG-UART-FIFO-SPI-I2C/32814913865.html">ordered on aliexpress</a> for 740.08 rubles.  together with the delivery of ePacket.  The fee comes with non-soldered legs, which we only have to hand, because we do not need them. </p><br><p>  A set of wires, 6 pieces: one end to solder, the other to ESP-32. </p><br><p>  I also highly recommend the USB extension cable, it will be tight without it ... </p><br><p>  Computer with (X) Ubuntu 18.04. </p><br><h2 id="nastroyka">  Customization </h2><br><h3 id="ustanovka-openocd-dlya-esp-32">  Installing OpenOCD for ESP-32 </h3><br><p>  Here you can safely refer to the esp-idf docks themselves: </p><br><pre><code class="bash hljs">sudo apt-get install make libtool pkg-config autoconf automake texinfo libusb-1.0 libftdi1-2 git git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> --recursive https://github.com/espressif/openocd-esp32.git <span class="hljs-comment"><span class="hljs-comment">#     https://github.com/espressif/openocd-esp32/releases cd openocd-esp32 ./bootstrap ./configure # ,  FTDI-based adapters  make -j6 sudo make install</span></span></code> </pre> <br><p>  Separately, I note that I put this version of OpenOCD in the system ( <code>sudo make install</code> ), which is unacceptable when you have different OpenOCD for different devices. </p><br><h3 id="nastroyka-openocd-pod-nas">  OpenOCD setup for us </h3><br><p>  At this stage, I divided the config for the debug card and the ESP-32 itself.  It turned out like this: <br>  board.cfg: </p><br><pre> <code class="hljs swift">transport select jtag adapter_khz <span class="hljs-number"><span class="hljs-number">20000</span></span> #     # <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-type"><span class="hljs-type">ESP32_ONLYCPU</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> #    # <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-type"><span class="hljs-type">ESP32_RTOS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> #   <span class="hljs-type"><span class="hljs-type">RTOS</span></span> source [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> target/esp32.cfg]</code> </pre> <br><p>  interface.cfg: </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ftdi</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ftdi_vid_pid</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x0403</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x6014</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ftdi_layout_init</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x0c08</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x0f1b</span></span></span></span></code> </pre> <br><h3 id="pishem-pravilo-udev">  Writing a Udev rule </h3><br><p>  Due to rights issues, we will not be able to access the USB device.  This can be fixed with one line of the udev rule: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'SUBSYSTEM=="usb", ATTR{idVendor}=="0403", ATTR{idProduct}=="6014", GROUP="plugdev, MODE="0666"'</span></span> | sudo tee /etc/udev/rules.d/99-JTAG.rules sudo systemctl restart udev.service sudo udevadm control --reload-rules</code> </pre> <br><h3 id="vspomogatelnyy-skript">  Helper script </h3><br><p>  Among other things, a script like this is very convenient: </p><br><p>  openocd_command: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash echo "$@" | telnet localhost 4444</span></span></code> </pre> <br><p>  It allows you to quickly send commands directly to the OpenOCD daemon.  But more about that later. </p><br><h2 id="podklyuchaem-platu-cjmcu-k-esp-32">  We connect the CJMCU board to the ESP-32 </h2><br><p>  Here we need wires and a soldering iron, without this in any way.  Below is a table of what to connect and why. </p><br><table><thead><tr><th>  Contact CJMCU </th><th>  JTAG Assignment </th><th>  Contact ESP-32 </th></tr></thead><tbody><tr><td>  AD0 </td><td>  TCK </td><td>  13 </td></tr><tr><td>  AD1 </td><td>  TDI </td><td>  12 </td></tr><tr><td>  AD2 </td><td>  Tdo </td><td>  15 </td></tr><tr><td>  AD3 </td><td>  Tms </td><td>  14 </td></tr><tr><td>  + 5V </td><td></td><td>  VIN (read in detail!) </td></tr><tr><td>  + 3.3V </td><td></td><td>  3V3 (read in detail!) </td></tr><tr><td>  GND </td><td></td><td>  GND (suddenly) </td></tr></tbody></table><br><h3 id="pro-vin-i-3v3">  About VIN and 3V3 </h3><br><p>  If you do not want to pull a separate wire from the computer to ESP-32 devkit, then you can connect + 5V to the VIN.  The firmware will go through JTAG, which, as personal experience has shown, is much faster.  One minus of this option is that it is not possible to watch the UART log, but IMHO debugger completely removes the need for this action. </p><br><p>  <em>As noted in the comments, the ESP-32 itself cannot be used for 5V, only on devkits.</em>  <em>If you need to debug a separate chip, you can power up the converter from the CJMCU itself by connecting + 3.3V on it to 3V3 on ESP-32.</em>  <em>But I can‚Äôt say anything about whether the power of the converter is enough. Better take a separate power supply.</em>  <em>And yes, it‚Äôs not worth connecting 5V and 3.3V at the same time.</em> </p><br><p>  <strong>At the same time, GND must always be connected!</strong> </p><br><h2 id="proveryaem-openocd">  Checking OpenOCD </h2><br><p>  Run OpenOCD like this: </p><br><pre> <code class="bash hljs">openocd -s <span class="hljs-string"><span class="hljs-string">'   interface.cfg  board.cfg'</span></span> -f interface.cfg -f board.cfg</code> </pre> <br><p>  If everything went well, you‚Äôll be shown something like this: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">On</span></span>-Chip Debugger <span class="hljs-number"><span class="hljs-number">0.10</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>-dev (<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-22</span></span><span class="hljs-number"><span class="hljs-number">-14</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>) Licensed under GNU GPL v2 <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> bug reports, <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> http://openocd.org/doc/doxygen/bugs.html adapter speed: <span class="hljs-number"><span class="hljs-number">20000</span></span> kHz esp32 interrupt mask <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : ftdi: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you experience problems at higher adapter clocks, try the command "ftdi_tdo_sample_edge falling" <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : clock speed <span class="hljs-number"><span class="hljs-number">20000</span></span> kHz <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : JTAG tap: esp32.cpu0 tap/device <span class="hljs-built_in"><span class="hljs-built_in">found</span></span>: <span class="hljs-number"><span class="hljs-number">0x120034e5</span></span> (mfg: <span class="hljs-number"><span class="hljs-number">0x272</span></span> (Tensilica), part: <span class="hljs-number"><span class="hljs-number">0x2003</span></span>, ver: <span class="hljs-number"><span class="hljs-number">0x1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : JTAG tap: esp32.cpu1 tap/device <span class="hljs-built_in"><span class="hljs-built_in">found</span></span>: <span class="hljs-number"><span class="hljs-number">0x120034e5</span></span> (mfg: <span class="hljs-number"><span class="hljs-number">0x272</span></span> (Tensilica), part: <span class="hljs-number"><span class="hljs-number">0x2003</span></span>, ver: <span class="hljs-number"><span class="hljs-number">0x1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : esp32: <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span> controller was <span class="hljs-keyword"><span class="hljs-keyword">reset</span></span> (pwrstat=<span class="hljs-number"><span class="hljs-number">0x5F</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> clear <span class="hljs-number"><span class="hljs-number">0x0F</span></span>). <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : esp32: Core was <span class="hljs-keyword"><span class="hljs-keyword">reset</span></span> (pwrstat=<span class="hljs-number"><span class="hljs-number">0x5F</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> clear <span class="hljs-number"><span class="hljs-number">0x0F</span></span>). <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : Detected <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> stubs @ <span class="hljs-number"><span class="hljs-number">3</span></span>ffb3134 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> core0 <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> target <span class="hljs-string"><span class="hljs-string">'esp32'</span></span> cpu0: <span class="hljs-keyword"><span class="hljs-keyword">Current</span></span> bits <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>: BreakIn BreakOut RunStallIn cpu1: <span class="hljs-keyword"><span class="hljs-keyword">Current</span></span> bits <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>: BreakIn BreakOut RunStallIn</code> </pre> <br><p>  This suggests that it all worked! </p><br><p>  <strong>Important</strong> : the OpenOCD process should spin as long as you are busy debugging. </p><br><h2 id="zadeystvuem-eclipse">  Enable Eclipse </h2><br><p>  There are a number of steps that are beautifully described in the <a href="https://esp-idf.readthedocs.io/en/latest/api-guides/jtag-debugging/using-debugger.html">official documentation</a> , and I will not repeat them. </p><br><h3 id="sovety-po-otladke-v-eclipse">  Debugging Tips in Eclipse </h3><br><ol><li><p>  Forget about the EN button aki reset on the board.  Restart do <strong>only</strong> through "Terminate and relaunch". </p><br></li><li><p>  For firmware use </p><br><pre> <code class="bash hljs">openocd_command <span class="hljs-string"><span class="hljs-string">'program_esp32 _/.bin 0x10000 verify'</span></span></code> </pre> <br><p>  You can add this as an assembly target by placing the <code>openocd_command</code> custom command, and in the "name of the target" field, enter the arguments (without quotes). </p><br></li><li><p>  You may not get what you expected after stopping and resuming.  My library to play the sound after this makes no sense of how abnormal jokes with a timer. </p><br></li></ol><br><p>  This is where my current experience with this system ends.  I wish you a fruitful debugging (let's be honest, it does not happen to be pleasant)! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/421291/">https://habr.com/ru/post/421291/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421281/index.html">Technical support 3CX responds: setting your own logo on the IP phone display</a></li>
<li><a href="../421283/index.html">The book about the "Paragraph" on Habr√©. Chapter One: The Watchman</a></li>
<li><a href="../421285/index.html">Optical trackers: ASEF and MOSSE</a></li>
<li><a href="../421287/index.html">Moon bricks from the solar furnace</a></li>
<li><a href="../421289/index.html">The number of electric cars in Russia increased from 920 to 2500 in a year and a half</a></li>
<li><a href="../421293/index.html">Richard Hamming: Chapter 22. Computer-Aided Learning (CAI)</a></li>
<li><a href="../421295/index.html">Attackers can get full remote access to an Android device through a public USB charging port.</a></li>
<li><a href="../421297/index.html">GUI Psychology. Our perception of information and images</a></li>
<li><a href="../421299/index.html">Mask R-CNN: Modern Neural Network Architecture for the Segmentation of Objects in Images</a></li>
<li><a href="../421301/index.html">YouTube introduces non-switchable ads for all</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>