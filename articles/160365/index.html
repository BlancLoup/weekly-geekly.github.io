<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>EventMachine ‚áí collection of information from various sources with subsequent processing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The easiest way to step on a rake is to use asynchrony. I am familiar with programmers who have proven themselves to be strong professionals who liter...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>EventMachine ‚áí collection of information from various sources with subsequent processing</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/596/eec/1da/596eec1daad6768b0ebee7a2c0ff71a8.jpeg" align="left"><br>  The easiest way to step on a rake is to use asynchrony.  I am familiar with programmers who have proven themselves to be strong professionals who literally succumb to multithreading.  For starters, I will tell my favorite story about deadlock (I apologize for the slaughter, but it is painfully good).  About ten years ago, the <a href="http://ap.org/">Associated Press</a> told the world how a pilot tried to land a passenger plane at the airport in the Swedish city of Christianstad, but none of the dispatchers responded to his request.  It turned out that the dispatcher had not yet returned from vacation.  As a result, the plane circled over the airport until an emergency dispatcher was urgently called in, which <br>  put the plane in half an hour.  Debriefing showed that the reason was the lateness of the aircraft.  On board which was the same dispatcher, hurrying to work from vacation. <br><br>  So, when we are confronted with asynchrony, we have to break the familiar picture in our head: the world around us is subjectively one-point.  If we sent a letter, and after a week received an answer, for us everything happens within one stream;  we do not have to be responsible for the actions of the respondent and the postman.  And our code has to. <br>  To simplify the life of a programmer, you can use the <a href="http://en.wikipedia.org/wiki/Reactor_pattern">Reactor</a> pattern.  The best (in my opinion) its implementation for Ruby is <a href="https://github.com/eventmachine/eventmachine/wiki">EventMachine</a> .  But with her there are not obvious moments.  I plan to briefly tell about one of them. <br><a name="habracut"></a><br><br><h4>  Eventmachine </h4><br><pre><code class="ruby hljs">gem install eventmachine</code> </pre> <br>  The <code>EventMachine</code> class <code>EventMachine</code> more or less <a href="http://eventmachine.rubyforge.org/">documented</a> and it‚Äôs easy to figure out simple queries.  Usually it happens something like this ( <code>EM</code> is an alias for <code>EventMachine</code> ): <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> EM.run <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ‚Ä¶ <span class="hljs-comment"><span class="hljs-comment"># -   , , EM.connect (‚Ä¶) #     EM.add_periodic_timer(1) { puts "on tick" } end ensure EM.stop #     ,     end</span></span></code> </pre><br>  At the reactor shutdown, you can hang the hook ( <a href="http://eventmachine.rubyforge.org/EventMachine.html">EventMachine.add_shutdown_hook {puts "Exiting ..."}</a> ).  Well, of course, you can create <a href="http://eventmachine.rubyforge.org/EventMachine/Connection.html">asynchronous connections</a> on the fly.  Documentation, again, is.  Mostly even intelligible. <br>  But enough tediousness. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Collection of results </h4><br>  As long as everything is limited to the ‚Äúrequest ‚Üí response processing‚Äù model, there are no problems.  But what if we need to send the next request, depending on the result of the previous one?  In order not to make the note too long and not to chew very simple moments, I will immediately proceed to the task: <br><br><blockquote>  find the component we need on the server through the discovery server and communicate with it </blockquote><br>  In words, it happens something like this: we send a request to the discovery, we get a list of components, we poll each component for its capabilities.  If there is ours in the list of features, we carry out initialization. <br>  Here‚Äôs what it looks like with <code>EventMachine</code> (I‚Äôve removed everything that doesn‚Äôt directly concern working with <code>EM</code> ): <br><pre> <code class="ruby hljs">@stream.write_with_handler(disco) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|result|</span></span> ‚Ä¶ <span class="hljs-comment"><span class="hljs-comment"># iterate thru disco results and wait until all collected EM::Iterator.new(result.items).map proc{ |c, it_disco| ‚Ä¶ </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@stream</span></span></span><span class="hljs-comment">.write_with_handler(info) do |reply| ‚Ä¶ # iterate thru discoinfo results and wait until all collected, # then switch the parent's iterator EM::Iterator.new(reply.features).map proc{ |f, it_info| it_info.return ‚Ä¶ }, proc{ |comps| # one more disco item was utilized it_disco.return ‚Ä¶ } ‚Ä¶ end ‚Ä¶ }, proc{ |compss| # yielding # compss.init or smth like that ‚Ä¶ } end</span></span></code> </pre><br>  All the work will be done for us by iterators and their magic <a href="http://eventmachine.rubyforge.org/EventMachine/Iterator.html">map</a> function.  The lambda code under the last parentheses (comment ‚Äúyielding‚Äù) will be executed only when all the discoinfo for each component found are collected. <br><br>  I apologize if it will seem obvious to someone, but Google didn‚Äôt give me a quick solution, and the fuss with <code>Fiber</code> ‚Äôs here turns into pure hell. </div><p>Source: <a href="https://habr.com/ru/post/160365/">https://habr.com/ru/post/160365/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160355/index.html">GPL Vesta Server Control Panel</a></li>
<li><a href="../160357/index.html">A huge colony on Mars through the eyes of SpaceX founder Elon Mask</a></li>
<li><a href="../160359/index.html">Email gateway in 7 minutes</a></li>
<li><a href="../160361/index.html">TechEd Russia 2012 - Microsoft's largest online conference!</a></li>
<li><a href="../160363/index.html">And which task tracker do you use in a small team?</a></li>
<li><a href="../160367/index.html">IBM launched an initiative to develop future power systems</a></li>
<li><a href="../160369/index.html">nanoCAD Heating 1.0 Beta - a new solution in the product line based on nanoCAD</a></li>
<li><a href="../160371/index.html">Ruby on your server may be 2 times slower due to RVM</a></li>
<li><a href="../160373/index.html">Introduction to R-project</a></li>
<li><a href="../160375/index.html">Mobile home transformers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>