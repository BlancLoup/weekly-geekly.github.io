<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transactional hell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In previous articles, we have already mentioned transaction management in our platform . This article will tell you more about the implementation of t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transactional hell</h1><div class="post__text post__text-html js-mediator-article">  In previous articles, we have already mentioned transaction management in <a href="http://www.ultimabusinessware.com/">our platform</a> .  This article will tell you more about the implementation of transactions, their management and so on. <br><br>  From the very beginning, we decided that the application server should support ‚Äútransactional integrity‚Äù.  By this term, we understand that any access to the application server must either complete successfully or all changes must be reverted.  Accordingly, at the beginning of the server call processing, a transaction is created (to be precise, it occurs when the database is first changed) and is fixed (or canceled) when the call returns: <br><img src="https://habrastorage.org/files/f49/eb2/bb0/f49eb2bb0cf24b94b89948491c1fd6e5.png"><br><a name="habracut"></a><br>  At the same time, the application developer does not have direct access to the database connection, and all communication takes place through the appropriate layer.  As a result, of course, an application developer can try to perform fixing requests (for example, perform a procedure in which a truncate is performed), but such developers are never insured from a shot in the foot. <br>  Yes, such an implementation, theoretically, increases the time and, as a result, the probability of excessive blocking.  <a href="http://www.ultimaecommerceerp.com/results/without_brakes/">In practice,</a> this is quite easy to avoid.  Transactional integrity allows us to maintain data in a consistent state in the face of frequent changes in large (about 5MB) source code (in the application part).  In turn, its absence often leads to a violation of consistency, usually as a result of the following scenario: <br>  Suppose we have some functionality implemented in the UpdateDocument function: <br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateDocument</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Document doc</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// -       Database.Commit(); } catch (Exception ex) { Log("   : ", ex); Database.Rollback(); } }</span></span></code> </pre> <br>  Suppose we have a command on a document that calls the UpdateDocument method: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Command</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Document doc</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { UpdateDocument(doc); <span class="hljs-comment"><span class="hljs-comment">//  -  if (somethingWrong) { throw new Exception(" !"); } Database.Commit(); } catch (Exception e) { Log("    : ", ex); Database.Rollback(); } }</span></span></code> </pre> <br>  when these 2 functions are written side by side and do not change, it is easy to notice the problem - after calling UpdateDocument in the Command function, some of the changes made before this call will be fixed.  If in the future something goes wrong, only those changes that have been made after the UpdateDocument call have been rolled back! <br>  It is less obvious that after calling the UpdateDocument a new transaction will begin.  This has many consequences, for example, the temporary tables will be empty, or the locks set before the changes will be released, and, therefore, in the new transaction, the requests will return values ‚Äã‚Äãother than expected. <br>  Errors of this kind are extremely difficult to diagnose, moreover, they can lead to gradual corrosion of data that no one will notice during the days, months, or even years when the problem is very serious. <br>  That is why we chose an implementation variant with transactional integrity.  However, there are situations when it is necessary to do intermediate fixations.  For example - one of the tasks in the solution involved in the "removal of reserves."  In fact, it goes through the documents and changes them consistently.  By tradition, we‚Äôll give it as it was implemented in the first versions (all the extra code for understanding is removed): <br><pre> <code class="cs hljs">.... <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(docId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> docs) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> doc = DocumentManager.GetDocument(docId); doc.state = DocStateCancelled; DocumentManager.Save(doc); Server.Commit(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception e) { LogManager.Log(<span class="hljs-string"><span class="hljs-string">"something is wrong"</span></span>); } } ...</code> </pre><br>  Everything worked well, until the logic changed and the Save method did not start throwing an exception.  This led to the fact that strange artifacts began to appear in the data, and it was extremely difficult to determine their origin. <br>  And this is what happened - at some iteration an exception was thrown, which was recorded in the log.  And on the next, successful iteration, the changes made before the exclusion were thrown! <br>  As a solution, it was proposed to abandon the ability to gain access to the current connection, but to provide the ability to request a new connection, for which you can already commit changes.  At the same time, all nested calls that do not explicitly request a new connection work with the connection received above on the call stack. <br>  The code looks like this: <br><pre> <code class="cs hljs">.... <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(docId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> docs) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionScope()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> doc = DocumentManager.GetDocument(docId); doc.state = DocStateCancelled; DocumentManager.Save(doc); ts.Complete(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception e) { LogManager.Log(<span class="hljs-string"><span class="hljs-string">"something is wrong"</span></span>); } } } ...</code> </pre><br>  All calls (including nested) inside using use the transaction created in the call to CreateTransactionScope.  As you can see, the developer does not need to worry about getting the connection, moreover, he does not have the tools for this.  An application developer in nested calls, if it is necessary to capture intermediate data, can only request a new transaction.  Thus, practically at the level of language constructs, we are spared from intermediate fixations, resulting in corrosion of the data. <br><br><h4>  As a conclusion </h4><br>  There are other options that lead to corrosion data that can be dealt with similar methods.  We will try to talk about them in future articles. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/243245/">https://habr.com/ru/post/243245/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243233/index.html">Calling a non-predefined method in a category after overriding it</a></li>
<li><a href="../243235/index.html">Fight for the buyer or how to buy loyalty?</a></li>
<li><a href="../243237/index.html">Localization of the button "Build"</a></li>
<li><a href="../243241/index.html">From the life of the usability lab Mail.Ru Group</a></li>
<li><a href="../243243/index.html">What to read at your leisure: the gaming industry news digest for October</a></li>
<li><a href="../243247/index.html">9 basic principles of responsive web design</a></li>
<li><a href="../243249/index.html">xbmcswift2 - micro-framework for writing plug-ins to Kodi (XBMC)</a></li>
<li><a href="../243253/index.html">16 fun projects for your new Raspberry Pi</a></li>
<li><a href="../243255/index.html">Russian App Day - November 21 - Technopolis "Moscow"</a></li>
<li><a href="../243257/index.html">Google: recommendations for apps on Google Play</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>