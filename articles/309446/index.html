<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>View requests to the apache web server in real time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The load on the server is an important part of web server administration, tracking requests helps to quickly search for erroneous requests and elimina...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>View requests to the apache web server in real time</h1><div class="post__text post__text-html js-mediator-article">  The load on the server is an important part of web server administration, tracking requests helps to quickly search for erroneous requests and eliminate them before they return to you with webmaster statistics.  By default, the host‚Äôs Apache configuration file has a commented definition of the host in dns, which in turn makes it even more difficult to understand what comes to the site.  It was possible to simplify all this by writing a script that displays all requests to the web server in real time.  Saving a few hundred requests it was possible to calculate the load time.  This is a percentage of the actual elapsed time of the amount of time spent on the withdrawal of resources.  Convenient display of time spent on the execution of each page of the site has become indispensable in finding weaknesses.  A small array with a list of search engine templates made it possible to highlight them in a separate color in the feed of requests. <br><a name="habracut"></a><br>  Output is started using the Linux console by forwarding over ssh logging.  The plus was the minimum load on the server, since all the calculations occur on the local page.  A small php script helps to calculate the input to which data is being output from /var/log/apache2/access.log, which at one time highlights important parts of the log with a bright backlight. <br><br>  Unfortunately, I did not find the standard logging levels suitable for my conditions. In my case, the important parameter was the host name where the request arrived, but the% V parameter that is responsible for displaying the full host name in the standard settings was missing.  Had to add the necessary parameters to common <br><br><pre><code class="hljs perl">LogFormat <span class="hljs-string"><span class="hljs-string">"%h %V %l %u %t \"%r\" %&gt;s %O %D"</span></span> common</code> </pre> <br>  It is important to see in such a bots ribbon, this task was solved by setting the output in the DNS log of the client name.  This setting is also disabled by default in the configuration file. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs pgsql">HostnameLookups <span class="hljs-keyword"><span class="hljs-keyword">On</span></span></code> </pre> <br>  The script itself is a small php file that parses all the incoming data on it in parts and highlights processes important for further output.  It looks like this.  For security reasons, all local hosts and addresses in the video are replaced.  In addition, it may be convenient to add important pages to your list of interesting addresses.  The script highlights these addresses in the request feed.  The video in the second parameter displays the average number of requests per second, while the third is the time taken to issue resources, taking into account the last thousand requests. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/vkcRFf9Y2o8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Well, the script itself that displays this output. <br><br><pre> <code class="hljs pgsql">/usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/bin/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.php</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $colors = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"200"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"[0;32m"</span></span>, <span class="hljs-string"><span class="hljs-string">"404"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"[1;31m"</span></span>, <span class="hljs-string"><span class="hljs-string">"410"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"[0;31m"</span></span>, <span class="hljs-string"><span class="hljs-string">"403"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"[0;91m"</span></span>, <span class="hljs-string"><span class="hljs-string">"301"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"[1;33m"</span></span>, <span class="hljs-string"><span class="hljs-string">"302"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"[1;36m"</span></span>, <span class="hljs-string"><span class="hljs-string">"304"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"[1;36m"</span></span>, ); <span class="hljs-comment"><span class="hljs-comment">#   $bots = array("localhost", "googlebot", "yandex", "spider", "ahrefs", "mail.ru", "bot"); #   ,    $url = ["login", "admin"]; #       require "/home/mpak2/www/idna_convert.class.inc"; $idna = new idna_convert(); $in = fopen('php://stdin', 'r'); $tm = []; $t = microtime(true); $nn = 0; $microtime = microtime(true); while($str = fgets($in)){ if(!$ar = explode(" ", $str)){ print_r("   "); }elseif(!$n = number_format($nt = (100*(count($tm)-1)+($nn%100))/(microtime(true)-$t), 2)){ print_r("    "); }elseif(!($percent = number_format((array_sum(array_column($tm, 'msec'))/1e6)/(microtime(true)-$t)*100, 2)) &amp; false){ print_r("   "); }elseif(!$mtime = $ar[11]/1e6){ print_r("    "); }elseif(!$mtm = (($_tm = number_format($mtime, 3)) &gt; 1 ? "\e[1;31m{$_tm}\e[0m" : $_tm)){ print_r("  "); }elseif(!$uri = urldecode($ar[7])){ mpre("   "); }elseif(!$uri = (array_filter(array_map(function($u) use($uri){ return strpos($uri, $u); }, $url)) ? "\e[1;37m". urldecode($ar[7]). "\e[0m" : urldecode($ar[7]))){ print_r("   "); # }elseif(!$uri = "/-/"){ mpre(" "); }elseif(!$status = (array_key_exists($ar[9], $colors) ? "\e{$colors[$ar[9]]}{$ar[9]}\e[0m" : $ar[9])){ print_r("  "); }elseif(!$host = "\e[1;34m". $idna-&gt;decode($ar[1]). "\e[0m"){ print_r("   "); # }elseif(!$host = "-."){ print_r("    "); }elseif(!$bot = ((array_filter(array_map(function($b) use($ar){ return (strpos($ar[0], $b) !== false ? $b : false); }, $bots))) ? "\e[1;35m{$ar[0]}\e[0m" : "\e[1;32m{$ar[0]}\e[0m")){ print_r("  "); }elseif(!$size = number_format($ar[10]/1024, 2). ""){ print_r("   "); }else{// print_r($ar); if(($nn++ % 100) == 0){ array_unshift($tm, ['msec'=&gt;0, 'microtime'=&gt;microtime(true)]); if(count($tm) &gt; 10){ $t = array_pop($tm)['microtime']; } } if(!($nn % 1000) &amp;&amp; ($cmd = "echo '". strtr($n, ['.'=&gt;' ']). "' | festival --tts --language russian &amp;")){ passthru($cmd); } $tm[0]['msec'] += $ar[10]; passthru("echo '{$nn} {$n} {$percent}% {$mtm}c {$status} http://{$host}{$uri} ({$bot}) {$size}'"); } };</span></span></code> </pre><br>  Run by the command: ssh root@khabrakhabr.rf 'tail -f /var/log/apache2/access.log' |  php -f /usr/local/bin/log.php </div><p>Source: <a href="https://habr.com/ru/post/309446/">https://habr.com/ru/post/309446/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309436/index.html">Did not put favicon on the site - get double traffic from Chrome</a></li>
<li><a href="../309438/index.html">Panoramic overview: How to evaluate employee performance</a></li>
<li><a href="../309440/index.html">Not all programming languages ‚Äã‚Äãare equally useful.</a></li>
<li><a href="../309442/index.html">Umbrella monitoring: periscope for business</a></li>
<li><a href="../309444/index.html">Analytics for game designers and producers. Part I</a></li>
<li><a href="../309448/index.html">Visualization and work with historical data: interactive maps and linked data of the knowledge base for studying history</a></li>
<li><a href="../309450/index.html">30 harmful tips for php-developers</a></li>
<li><a href="../309452/index.html">Digest of materials about email-mailing: Useful guides from the world of email</a></li>
<li><a href="../309454/index.html">The final release of Vivaldi 1.4 or 50 shades of different. In a day</a></li>
<li><a href="../309456/index.html">Dewy calculations "for dummies"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>