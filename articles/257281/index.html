<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We spread PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The day will come, and you will understand that a single thread in PHP is not enough for you. 

 First you optimize the code, then you try to change t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We spread PHP</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/792/be3/314/792be3314e0b4fa98823cac4f2c46545.jpg" alt="image"><br><br>  The day will come, and you will understand that a single thread in PHP is not enough for you. <br><a name="habracut"></a><br>  First you optimize the code, then you try to change the mind to an asynchronous reactor, but the whole PHP world does not want to understand such a desire.  You look at phthreads, but after java concurrency you feel that you have been ‚Äúdeceived‚Äù somewhere.  And when you conceive to leave the process and start to choke in forks exec'ah and signals, you will understand that it is impossible to dive further.  And finally, emerging from all this, you will sail to the island of MOM (message-oriented middleware). <br><br>  Ohhh, but what kind of sellers are there only Kirbies: RabbitMQ, ActiveMQ, Kafka, Kestrel and even Redis pub / sub podbryzhivaet.  And everyone is doing well: all the best, fast, trouble-free.  But there is a small misfortune - a step to the side and, hello, now you are among the crowd of whiners on stackoverflow in search of work rounds and strange schemes.  And this will continue until you find ZeroMQ. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What is it?  ZeroMQ is a high-performance asynchronous message-oriented library designed for use in scalable distributed or parallel applications.  But unlike other message-oriented middleware, it is broker-free and works without a server as such. <br><br><img src="https://habrastorage.org/files/ba1/a55/7a6/ba1a557a663446e4ac6ab2f832a1c521.jpg"><br><br>  And what is being offered then?  And these guys offer a set of sockets on steroids optimized for basic message patterns and we can use them as we want.  With their help, we can build a network with any topology and complexity. <br><br>  They also have their own sectarian dock <a href="http://zguide.zeromq.org/page:all">http://zguide.zeromq.org/page:all</a> .  Well sets the brain in the right direction, regardless of whether you use 0mq or not, however, if you can in multi-threaded programming, you can partially scroll through. <br><br><h5>  <b>The bottom line:</b> </h5><br><ul><li>  Steroid Socket Set </li><li>  Damn fast </li><li>  Work via IPC, TCP, multicast, inproc </li><li>  Asynchronous </li><li>  Easy start </li><li>  Over 40 40 programming languages </li></ul><br><br>  It sounds all very cool!  Enough of the theories go to <a href="https://www.gliffy.com/">www.gliffy.com</a> and violently architect the system.  And we want the following: <br><br><img src="https://habrastorage.org/files/241/ac9/ccd/241ac9ccdb3d45409c0d9d304d60cfa8.png" alt="image"><br><br><ul><li>  <b>Auth + task generator</b> <br>  Responsible for authorization on the server and distributes non-stop tasks for parsing. </li><li>  <b>Parse worker</b> <br>  Gets the authorization key and the task to parse after completion returns the result to the generator. </li><li>  <b>Parsed data publisher</b> <br>  Having received the result from the worker, it will be published to all subscriber. </li><li>  <b>Alert system subscriber</b> <br>  Receives data and sends alerts if needed. </li><li>  <b>Upload system subscriber</b> <br>  Receives data and uploads it to the server. </li><li>  <b>Data upload worker</b> <br>  Enkodit, zipuet and applaud the data on the server. </li><li>  <b>System monitor</b> <br>  Collects system statistics in real time. </li></ul><br><br>  The architecture turned out to be simple, all components were written separately from the business logic, decorated in a package for a composer and filled in on the githab: <br><br>  <a href="https://github.com/limitium/zmq">https://github.com/limitium/zmq</a> <br><br><h5>  <b>To pick it up, you need (for example, Debian):</b> </h5><br><h6>  <b>1. Install ZeroMQ</b> </h6><br><pre><code class="bash hljs">sudo apt-get update -qq sudo apt-get install -y libzmq3-dev</code> </pre> <br><h6>  <b>2. Install binding php-zmq</b> </h6><br><pre> <code class="bash hljs"> git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/mkoppanen/php-zmq.git sh -c <span class="hljs-string"><span class="hljs-string">"cd php-zmq &amp;&amp; phpize &amp;&amp; ./configure &amp;&amp; make --silent &amp;&amp; sudo make install"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"extension=zmq.so"</span></span> &gt;&gt; `php --ini | grep <span class="hljs-string"><span class="hljs-string">"Loaded Configuration"</span></span> | sed -e <span class="hljs-string"><span class="hljs-string">"s|.*:\s*||"</span></span>`</code> </pre><br><h6>  <b>3. Install via composer</b> </h6><br><pre> <code class="bash hljs"> composer require limitium/zmq</code> </pre><br><br>  Next, take, for example, psr-3 logger and see how it works: <br>  Logger <br><pre> <code class="php hljs"> $logger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ZLogger(<span class="hljs-string"><span class="hljs-string">'my_service_1'</span></span>, <span class="hljs-string"><span class="hljs-string">'tcp://127.0.0.1:5555'</span></span>); $logger-&gt;info(<span class="hljs-string"><span class="hljs-string">"core is stable"</span></span>); $logger-&gt;emergency(<span class="hljs-string"><span class="hljs-string">"we're all going to die!"</span></span>);</code> </pre><br>  Log collector <br><pre> <code class="php hljs"> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Concentrator(<span class="hljs-string"><span class="hljs-string">'tcp://127.0.0.1:5555'</span></span>)) -&gt;setReceiver(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($logMsg)</span></span></span><span class="hljs-function"> </span></span>{ $serviceName = $logMsg[<span class="hljs-number"><span class="hljs-number">0</span></span>]; $time = $logMsg[<span class="hljs-number"><span class="hljs-number">1</span></span>]; $logLevel = $logMsg[<span class="hljs-number"><span class="hljs-number">2</span></span>]; $logMsg = $logMsg[<span class="hljs-number"><span class="hljs-number">3</span></span>]; }) -&gt;listen();</code> </pre><br>  Everything is simple, while the logger, thanks to the ZeroMQ buns, can work both within one process and collect information from 100,500 servers. <br><br>  Example of task generator and worker <br>  Generator <br><pre> <code class="php hljs"> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ventilator(<span class="hljs-string"><span class="hljs-string">'tcp://127.0.0.1:5555'</span></span>)) -&gt;setGenerator(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rand(); }) -&gt;setResponder(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($msg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $msg; }) -&gt;listen();</code> </pre><br>  Worker <br><pre> <code class="php hljs"> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">'tcp://127.0.0.1:5555'</span></span>)) -&gt;setExecutor(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($msg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $msg + $msg; }) -&gt;work();</code> </pre><br><br>  And at the end of the banal pub / sub <br>  Publisher <br><pre> <code class="php hljs"> $pub = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Publisher(<span class="hljs-string"><span class="hljs-string">'tcp://127.0.0.1:5555'</span></span>); $pub-&gt;send(<span class="hljs-string"><span class="hljs-string">'azaza'</span></span>);</code> </pre><br>  Subscriber <br><pre> <code class="php hljs"> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Subscriber(<span class="hljs-string"><span class="hljs-string">'tcp://127.0.0.1:5555'</span></span>)) -&gt;setListener(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($msg)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $msg; }) -&gt;listen();</code> </pre><br><br>  The only minus of ZeroMQ, which is worth noting - the more interpticity you want from the system, the more code you have to write.  But who cares when everything runs in 2 lines of code? </div><p>Source: <a href="https://habr.com/ru/post/257281/">https://habr.com/ru/post/257281/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257269/index.html">Changing the partitioning scheme for a rented VPS</a></li>
<li><a href="../257271/index.html">3D pen: prototyping or not?</a></li>
<li><a href="../257273/index.html">High-performance DEFLATE compression with optimized genomic data sets</a></li>
<li><a href="../257275/index.html">Creating a gulp-plugin on the example of building a dependency graph for Angular JS modules</a></li>
<li><a href="../257279/index.html">STM32. We connect ISO7816 smart cards</a></li>
<li><a href="../257283/index.html">What prepares us for C # 7 (Part 2. Pattern matching)</a></li>
<li><a href="../257285/index.html">Cards, money, two stars</a></li>
<li><a href="../257287/index.html">Head Unit - as a target for a hacker</a></li>
<li><a href="../257291/index.html">Fix corrupted MySQL tables with myisamchk</a></li>
<li><a href="../257293/index.html">Attackers use Linux / Mumblehard to compromise servers, part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>