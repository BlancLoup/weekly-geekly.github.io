<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring HP EVA status from icinga / nagios. Plugin check_eva.py</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I promised to talk about all sorts of unusual equipment from a monitoring point of view, and in this article I will talk about remote control of a fai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring HP EVA status from icinga / nagios. Plugin check_eva.py</h1><div class="post__text post__text-html js-mediator-article">  I promised to talk about all sorts of unusual equipment from a monitoring point of view, and in this article I will talk about remote control of a fairly common array of HP EVA virtual disks.  In order to ‚Äúpractice on cats‚Äù let's take a Hewlett-Packard EVA4400 with an HSV300 controller and two disk shelves, since it stands through the wall and it is possible to take all the screenshots and data from a live system. <br><a name="habracut"></a><br>  The most unexpected thing about this device is the way to work with SNMP.  Sometimes they start saying that it supports SNMP and even gives a <a href="http://h10032.www1.hp.com/ctg/Manual/c00605846.pdf">link</a> to the documentation.  Even more confusing is that you can go to Command View / System Options / Configure Event Notification and see that from there you can download the MIB for the device. <br><br><img src="https://habrastorage.org/storage2/ba0/9a8/021/ba09a8021f9a887001f6ad701f585692.png"><br><br>  So - this is not the MIB.  "Not Penny's boat!" 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      HP has done on this device only SNMP notifications, in common parlance - SNMP traps, which it sends to the SNMP server itself.  It does not process external SNMP requests ‚Äî snmpwalk cannot walk through it, alas. <br><br>  Someone Pall Sigurdsson (palli@opensource.is) wrote the check_eva.py script (download <a href="http://exchange.nagios.org/directory/Plugins/Hardware/Storage-Systems/SAN-and-NAS/check_eva/details">here</a> ), which somehow collects as much as we need all the data about the system state by polling the device controller. <br><br><h5>  Secret of focus </h5><br>  If the focus is explained, then all the magic disappears.  In fact, the script works through SSSU - this is the HP Storage System Scripting Utility. <br><br>  We will need sssu_linux_x86.  You can find it on the disk where we have the EVA Command View control software itself or download it from the HP website ( <a href="http://h20000.www2.hp.com/bizsupport/TechSupport/SoftwareDescription.jsp%3Flang%3Den%26cc%3Dus%26prodTypeId%3D18964%26prodSeriesId%3D471497%26prodNameId%3D3185481%26swEnvOID%3D1080%26swLang%3D8%26mode%3D2%26taskId%3D135%26swItem%3Dco-47019-1">here</a> or a direct link <a href="">here</a> ). <br><br>  This is not the newest version of the utility (version 6.0.2, 2007), but it works.  Moreover, we don't need the newest one. <br><br>  For the plugin to work, on the OS where our monitoring server is deployed, two things need to be done: <br><br>  1.to make sure that python is installed <br><pre><code class="bash hljs">icinga<span class="hljs-comment"><span class="hljs-comment"># python Python 2.7.3 (default, Sep 11 2012, 11:58:26) [GCC 4.2.1 20070831 patched [FreeBSD]] on freebsd9 Type "help", "copyright", "credits" or "license" for more information. &gt;&gt;&gt;</span></span></code> </pre> <br>  If not, then we put it in our favorite way for our OS. <br><br>  2. Install the SSSU utility (actually copy to the search path and make a symlink in / usr / local / bin /, where the script wants to find it). <br><br>  If we have Red Hat Enterprise Linux 2.1, Red Hat Enterprise Linux 3 (x86), Red Hat Enterprise Linux 4 (x86), SUSE Linux Enterprise Server 10 (x86), SUSE Linux Enterprise Server 9 (x86), or any other system, supported by Hewlett-Packard, we don‚Äôt need any further steps, you can go directly to the section ‚ÄúPreparing the script for work‚Äù. <br><br>  But since we are not looking for simple ways, and we have a monitoring system running on another OS (FreeBSD 9.0), we will also understand how to run the Linux binary on FreeBSD.  Here, too, there is nothing complicated, the way is <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/linuxemu-lbc-install.html">documented</a> . <br><br><h5>  Ensuring binary compatibility of FreeBSD with Linux. </h5><br>  By default, binary compatibility with Linux is disabled in FreeBSD.  To enable it, from under the root enter the command: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># kldload linux</span></span></code> </pre><br>  In order for it to be active when the system is rebooted, then in /etc/rc.conf you should add: <br><pre> <code class="bash hljs">linux_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre><br>  To make sure that the KLD (kernel dynamic linker) has loaded, enter: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># kldstat Id Refs Address Size Name 1 2 0xc0100000 16bdb8 kernel 7 1 0xc24db000 d000 linux.ko</span></span></code> </pre><br>  linux.ko is present.  After running the utility, we get the error: <br><pre> <code class="bash hljs">icinga<span class="hljs-comment"><span class="hljs-comment"># ./sssu_linux_x86 ELF interpreter /lib/ld-linux.so.2 not found</span></span></code> </pre><br>  We do the following: install an emulator for linux libraries: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /usr/ports/emulators/linux_base-f10 # make install distclean</span></span></code> </pre><br>  But sssu again swears, most likely, the emulator libraries are few, something else is needed.  Enter: <br><pre> <code class="bash hljs">ldd sssu_linux_x86</code> </pre><br>  ldd will show dependencies on libraries, as well as their presence in the system: <br><pre> <code class="bash hljs">./sssu_linux_x86: librt.so.1 =&gt; /lib/librt.so.1 (0x281c8000) libpthread.so.0 =&gt; /lib/libpthread.so.0 (0x281d2000) libdl.so.2 =&gt; /lib/libdl.so.2 (0x281ec000) libstdc++.so.5 =&gt; /usr/lib/libstdc++.so.5 (0x281f1000) libm.so.6 =&gt; /lib/libm.so.6 (0x282a7000) libgcc_s.so.1 =&gt; /lib/libgcc_s.so.1 (0x282d0000) libc.so.6 =&gt; /lib/libc.so.6 (0x282df000) /lib/ld-linux.so.2 (0x2819a000) libpam.so.0 =&gt; not found libaudit.so.0 =&gt; not found</code> </pre><br>  The libpam.so.0 and libaudit.so.0 libraries were not found.  You can see what rpm they are in, for example, through this site - <a href="http://rpm.pbone.net/">rpm.pbone.net</a> .  The search shows that libpam is in rpm from Fedora: pam-0.79-8.i386.rpm, and libaudit.so.0 in rpm from Mandriva: libaudit0-1.7.13-9.1.3.i586.rpm.  Download them to yourself and get them from rpm using rpm2cpio: <br><pre> <code class="bash hljs">rpm2cpio &lt; pam-0.79-8.i386.rpm | cpio -ivd ./lib/libpam.so.0.79 rpm2cpio &lt; libaudit0-1.7.13-9.1.3.i586.rpm | cpio ‚Äìivd</code> </pre><br>  Then we copy both libraries to the directory where the linux / compat / linux / lib compatibility libraries are located, and make symlinks so that the system knows which one to pick up: <br><pre> <code class="bash hljs">ln -s /compat/linux/lib/libpam.so.0.79 /compat/linux/lib/libpam.so.0 ln -s /compat/linux/lib/libaudit.so.0.0.0 /compat/linux/lib/libaudit.so.0</code> </pre><br>  We start, we check.  We see on the monitor: <br><pre> <code class="bash hljs">SSSU <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> HP StorageWorks Command View EVA Version: 6.0.2 Build: 5 Manager:</code> </pre><br>  What we needed.  You can enter it: Manager - specify the IP or host name of the EVA Command View, username, password - respectively.  The utility works. <br><br>  sssu_linux_x86 need to be put in / usr / local / bin and make a symlink on it so that the script knows where to find it: <br><pre> <code class="bash hljs">ln -s /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/sssu_linux_x86 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/sssu</code> </pre><br>  For FreeBSD everything. <br><br><h5>  Preparing the script to work. </h5><br>  Happy users of Linux systems who have sssu_linux_x86 planted in the search path and have made a symlink on it continue from this point.  So, python and SSSU work for us. <br><br>  Run the script it with the key --help <br><pre> <code class="bash hljs">icinga<span class="hljs-comment"><span class="hljs-comment"># ./check_eva.py --help check_eva version 1.0 This plugin checks HP EVA Array with the sssu command Usage: ./check_eva.py [OPTIONS] OPTIONS: [--host &lt;host&gt;] [--username &lt;user&gt;] [--password &lt;password] [--path &lt;/path/to/sssu&gt;] [--mode &lt;mode&gt;] [--test] [--debug] [--help] Valid modes are: check_systems, check_controllers, check_diskgroups, check_disks, check_diskshelfs, check_diskshelves Example: ./check_eva.py --host commandview.example.net --username eva --password myPassword --mode check_systems</span></span></code> </pre><br><br>  With options, everything is clear: <br><br><pre> <code class="bash hljs">--host &lt;    &gt; --username &lt; Command View&gt; --password &lt; &gt; --path &lt;  sssu,       &gt; --mode &lt;&gt; --<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> --debug --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span></code> </pre><br>  Modes: <br><pre> <code class="bash hljs">check_systems ‚Äì     check_controllers ‚Äì    check_diskgroups ‚Äì     check_disks ‚Äì    check_diskshelfs, check_diskshelves ‚Äì    .</code> </pre><br>  Checking: <br><pre> <code class="bash hljs">icinga<span class="hljs-comment"><span class="hljs-comment"># ./check_eva.py --host ip.ad.dr.es --username user --password pass OK - 1 objects found | '/Eva_totalstoragespace'=7539.91 '/Eva_usedstoragespace'=4737.25 '/Eva_availablestoragespace'=2802.66 /Eva = good (initialized_ok) - licensestate = good - systemtype = HSV300 - firmwareversion = 09534000 - nscfwversion = CR18CBlep-09534000 - totalstoragespace = 7539.91 - usedstoragespace = 4737.25 - availablestoragespace = 2802.66</span></span></code> </pre><br>  EVA responds. <br><br>  Further details vary from the configurator used, but this sequence of steps is the same for nagios / icinga: <br><br>  1. Create a verification team. <br><br>  If we do not want to shine the passwords in the configurator, then in the system file nagios / icinga with the name resource.cfg we write: <br><br>  $ USER7 $ = user_name_for_EVA, <br>  $ USER8 $ = password_for_EVA <br><br>  Numbers - any that you have free. <br>  Our verification team is: <br><br>  $ USER1 $ / check_eva.py --host $ HOSTADDRESS $ --username $ USER7 $ --password $ USER8 $ --mode $ ARG1 $ <br><br>  2. Then, for each request mode, we create services, bind them to our verification team, for which only the $ ARG1 $ argument changes. <br>  3. We assign services to the hosts directly or include them in the template, and assign the template to the hosts (if we have a lot of racks) <br>  4.Save the configuration, wait for the polling of new devices to end: <br><br>  We look at the picture.  All information about our storage system in full view: <br><img src="http://habrastorage.org/storage2/dc8/8cd/01a/dc88cd01a269c5139d14ac92439936bc.png"><br>  Gray color is a sign that the cursor is on this line, there, in fact, everything is also OK. <br><br><h5>  Known limitations </h5><br>  1.Skript will not work with SSSU version 10.2 and newer.  Works great with versions 9.4 and older.  Perhaps the new EVA models will not work with older versions of SSSU - this has not been verified. <br>  2. The author has not been in touch for a long time.  But the source code of the script is, so you can always spend a little time and finish to fit your needs.  "Open software! = Closed software." <br><br>  <b>Sometimes SSSU gives an error that it is impossible to create an https connection.</b>  <b>Overload control interface on EVA</b> <br><br>  PS I would very much like the experts to tell whether it is possible to achieve a similar result in the zabbix monitoring system and what sequence of steps is needed, considering that there are no HP EVA templates in the system out of the box, SSSU is not included in the list of supported agents, but is SNMP targeted. the system does not respond. <br><br>  Hint: The problem can be solved.  But in a different, longer way. <br></div><p>Source: <a href="https://habr.com/ru/post/170903/">https://habr.com/ru/post/170903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170889/index.html">Airspace app store from Leap Motion announced</a></li>
<li><a href="../170891/index.html">Toshiba Satellite U840W Ultrabook Video Review</a></li>
<li><a href="../170895/index.html">Networks for the smallest. Part Seven. VPN</a></li>
<li><a href="../170897/index.html">Runetology (187): Vladimir Gorbunov, founder of Workle.ru</a></li>
<li><a href="../170901/index.html">How to make your server for receiving, processing and sending SMS</a></li>
<li><a href="../170905/index.html">OPPO Finder X907 - Thin Facts</a></li>
<li><a href="../170907/index.html">Mobility is a guide to business change.</a></li>
<li><a href="../170909/index.html">Using OpenCV in Delphi</a></li>
<li><a href="../170911/index.html">New geolocation service Maptrix</a></li>
<li><a href="../170915/index.html">How to change the structure of the site without losing positions?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>