<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Script for centralized backup of configurations of Mikrotik routers on Powershell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After fouling of the infrastructure with a large number of routers of this manufacturer, the question of configuration backups in one storage has come...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Script for centralized backup of configurations of Mikrotik routers on Powershell</h1><div class="post__text post__text-html js-mediator-article">  After fouling of the infrastructure with a large number of routers of this manufacturer, the question of configuration backups in one storage has come up.  Came across solutions of scripts executed on routers with unloading on ftp, but this is somewhat inconvenient, since  requires setting up scripts on all routers is identical. <br><br>  I decided to do this centrally by running a backup on the router using the ssh command to a temporary file temp.backup and downloading it via FTP. <br><a name="habracut"></a><br><pre><code class="hljs mel">#  ,       Set-ExecutionPolicy remotesigned -scope currentuser #     ssh Install-Module -Name Posh-SSH Import-Module posh-ssh $curDir = $MyInvocation.MyCommand.Definition | split-path -<span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> function bkprtr { param($ipaddr) #          ftp  ssh. $secpasswd = ConvertTo-SecureString <span class="hljs-string"><span class="hljs-string">"___"</span></span> -AsPlainText -Force $mycreds = New-Object System.Management.Automation.PSCredential (<span class="hljs-string"><span class="hljs-string">"___"</span></span>, $secpasswd) $error.<span class="hljs-keyword"><span class="hljs-keyword">clear</span></span>() #  ssh      New-SSHSession -ComputerName $ipaddr -Credential $mycreds -Force Invoke-SshCommand -index <span class="hljs-number"><span class="hljs-number">0</span></span> -Command <span class="hljs-string"><span class="hljs-string">"system backup save name temp.backup"</span></span> Get-SSHSession | Remove-SshSession; $Cdate=get-<span class="hljs-keyword"><span class="hljs-keyword">date</span></span> -Uformat %Y%m%d $rptpath = <span class="hljs-string"><span class="hljs-string">"$curDir\backup\$cdate"</span></span> #    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(test-path -path $rptpath)) {new-item -path $rptpath -itemtype directory} #  wget -Uri <span class="hljs-string"><span class="hljs-string">"ftp://$ipaddr/temp.backup"</span></span> -OutFile <span class="hljs-string"><span class="hljs-string">"$rptpath\$ipaddr.backup"</span></span> -Credential $mycreds #     If ($error.count -gt <span class="hljs-number"><span class="hljs-number">0</span></span>) { get-<span class="hljs-keyword"><span class="hljs-keyword">date</span></span> | out-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-string"><span class="hljs-string">"$curDir\error.log"</span></span> -append $ipaddr | out-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-string"><span class="hljs-string">"$curDir\error.log"</span></span> -append $error | out-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-string"><span class="hljs-string">"$curDir\error.log"</span></span> -append $error.<span class="hljs-keyword"><span class="hljs-keyword">clear</span></span>() } } #  list.txt  foreach ($ip <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gc $curDir\list.txt ){bkprtr($ip)}</code> </pre> <br>  The list of addresses of the list.txt routers should be placed in the script directory.  Backups will be added to the backup folder in a subdirectory with the launch date of the script.  The backups themselves are named by the address of the router. <br><br>  Perhaps someone will come in handy. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      upd. <br>  second version without intermediate files <br><br><pre> <code class="hljs mel">#  ,       Set-ExecutionPolicy remotesigned -scope currentuser #     ssh Install-Module -Name Posh-SSH Import-Module posh-ssh $curDir = $MyInvocation.MyCommand.Definition | split-path -<span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> function bkprtr { param($ipaddr) #          ftp  ssh. $secpasswd = ConvertTo-SecureString <span class="hljs-string"><span class="hljs-string">"___"</span></span> -AsPlainText -Force $mycreds = New-Object System.Management.Automation.PSCredential (<span class="hljs-string"><span class="hljs-string">"___+ct"</span></span>, $secpasswd) $error.<span class="hljs-keyword"><span class="hljs-keyword">clear</span></span>() $Cdate=get-<span class="hljs-keyword"><span class="hljs-keyword">date</span></span> -Uformat %Y%m%d $rptpath = <span class="hljs-string"><span class="hljs-string">"$curDir\backup\$cdate"</span></span> #    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(test-path -path $rptpath)) {new-item -path $rptpath -itemtype directory} #  #  ssh      $sshsession=New-SSHSession -ComputerName $ipaddr -Credential $mycreds -Force $ssh = $sshSession | New-SSHShellStream start-sleep -s <span class="hljs-number"><span class="hljs-number">5</span></span> $ssh.read() | out-null $ssh.WriteLine( <span class="hljs-string"><span class="hljs-string">"export"</span></span> ) start-sleep -s <span class="hljs-number"><span class="hljs-number">15</span></span> $ssh.read() | sc <span class="hljs-string"><span class="hljs-string">"$rptpath\$ipaddr.backup"</span></span> $tfileproc=gc <span class="hljs-string"><span class="hljs-string">"$rptpath\$ipaddr.backup"</span></span> $tfileproc[<span class="hljs-number"><span class="hljs-number">2.</span></span>.($tfileproc.count<span class="hljs-number"><span class="hljs-number">-2</span></span>)]|sc <span class="hljs-string"><span class="hljs-string">"$rptpath\$ipaddr.backup"</span></span> Get-SSHSession | Remove-SshSession; #     If ($error.count -gt <span class="hljs-number"><span class="hljs-number">0</span></span>) { get-<span class="hljs-keyword"><span class="hljs-keyword">date</span></span> | out-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-string"><span class="hljs-string">"$curDir\error.log"</span></span> -append $ipaddr | out-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-string"><span class="hljs-string">"$curDir\error.log"</span></span> -append $error | out-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-string"><span class="hljs-string">"$curDir\error.log"</span></span> -append $error.<span class="hljs-keyword"><span class="hljs-keyword">clear</span></span>() } }</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/351108/">https://habr.com/ru/post/351108/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351094/index.html">How to build a GSM phone based on SDR</a></li>
<li><a href="../351096/index.html">dev || bet - the battle of programmers and technology</a></li>
<li><a href="../351098/index.html">Apache Ignite 2.4 Release - Distributed Database and Caching Platform</a></li>
<li><a href="../351102/index.html">People do not want something really new - they want something they‚Äôve done, but they‚Äôve done differently.</a></li>
<li><a href="../351104/index.html">Test Automation and Agile</a></li>
<li><a href="../351112/index.html">Efficient use of memory with parallel input-output operations in Python</a></li>
<li><a href="../351114/index.html">How not to get the phone (almost) any beauty in Moscow, or an interesting feature MT_FREE</a></li>
<li><a href="../351116/index.html">Security Basics: Keychain and Hashing</a></li>
<li><a href="../351118/index.html">As i blakecoin miner did</a></li>
<li><a href="../351122/index.html">Dimnie: from geeks with github to corporate accountants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>