<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>One Definition Rule, inline and unexpected consequences of their combination</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="C ++ requires that any function be defined no more than once - One Definition Rule, ODR. As soon as you define a function with the same name and signa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>One Definition Rule, inline and unexpected consequences of their combination</h1><div class="post__text post__text-html js-mediator-article">  C ++ requires that any function be defined no more than once - One Definition Rule, ODR.  As soon as you define a function with the same name and signature in different translation units (.cpp files), you receive an error indication at the linking stage. <br><br>  inline functions are usually defined in header files (.h) so that all translation units can see the implementation of the function and substitute it at the call site.  Accordingly, as soon as you include a header file with such a function in more than one translation unit, the ODR will be formally broken, but ... you will not receive any error indication. <br><br>  Why and what unexpected consequences could this have? <a name="habracut"></a><br>  Why is the question relatively well-known ( <a href="http://habrahabr.ru/blogs/cpp/50775/">for example</a> ).  On the one hand, it is impossible to prohibit the situation described above for practical reasons - it is necessary that the implementation of the function be available from all translation units causing it, otherwise substitution may be impossible.  On the other hand, the ODR is broken and it would be good to respond to it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can respond in two ways - by an error message or by silence.  In this particular case, the linker selects the second.  As soon as the linker sees more than one inline function with the same name and the same signature, it considers that it <i><b>is the same function</b> ,</i> and selects <i><b>one of them at its discretion</b></i> . <br><br>  So a formal violation of ODR is formally eliminated. <br><br>  Suddenly, there is a wide scope for difficult-to-detect defects.  The policy used by the linker assumes that the function is really the same, i.e.  identical implemented.  We are waiting for an example - stock up on chips and read on. <br><br>  <s>Slowly stirring,</s> add a little preprocessor (for example, this is <a href="http://blogs.msdn.com/b/aszego/archive/2010/05/12/override-atlthrow-with-care.aspx">done for the error handler in ATL</a> ): <br><br><blockquote><pre> <code class="hljs pgsql"><code class="cpp">//CommonFile.h __declspec( noinline ) //  noinline <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> HandleErrorCondition( <span class="hljs-type"><span class="hljs-type">int</span></span> condition ) { #ifndef OVERRIDE_STANDARD_HANDLING _exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); #<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> CustomHandleErrorCondition( condition ); #endif } //StaticLib.h #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;CommonFile.h&gt; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SomeUsefulFunction() { //blahblahblah HandleErrorCondition( <span class="hljs-number"><span class="hljs-number">0</span></span> ); } //StaticLib.cpp #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;StaticLib.h&gt; blahblahblah,  SomeUsefulFunction() //Executable.cpp <span class="hljs-type"><span class="hljs-type">void</span></span> CustomHandleErrorCondition( <span class="hljs-type"><span class="hljs-type">int</span></span> condition ) { throw MyCustomException( condition ); } #define OVERRIDE_STANDARD_HANDLING #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;StaticLib.h&gt; blahblahblah,  SomeUsefulFunction() //V2UncmUgaGlyaW5nIC0gd3d3LmFiYnl5LnJ1L3ZhY2FuY3k=</code></code> </pre></blockquote><br>  StaticLib.cpp is compiled into the StaticLib.lib static library, then Executable.cpp is compiled into an executable file (.exe or .dll is all the same) and statically links StaticLib.lib. <br><br>  The HandleErrorCondition () signature contains __declspec (noinline), a Visual C ++ attribute that tells the compiler that you never need to substitute the implementation of this function.  This is done specifically so that the compiler does not substitute the implementation of the function and the implementation can be replaced later.  Visual C ++ obeys. <br><br>  The cunning plan ‚Ñ¢ for which this kitchen is needed is obvious: if the developer is satisfied, the default handler will be used.  If the default handler is not satisfied, you can install your own. <br><br>  Will this work?  Which implementation of HandleErrorCondition () - with a _exit () call or with a CustomHandleErrorCondition () call - will be called? <br><br>  Unknown. <br><br>  When the compiler compiles StaticLib.cpp, it includes the first implementation in the object file (StaticLib.obj) with the _exit () call.  When the compiler compiles Executable.cpp, it includes in the object file (Executable.obj) a second implementation with a call to CustomHandleErrorCondition (). <br><br>  When linking, the situation described above with violation of ODR occurs, but now two inline functions that are identical from the point of view of the policy used by the linker have different implementations.  The linker will choose some one and not the fact that the choice will not change from one link to another. <br><br>  Suddenly your program does not work as you planned.  What is especially nice is that the behavior in this example will differ only in error handling, i.e.  in relatively rare situations and not the fact that they will not forget to check. <br><br>  The described behavior (the choice of one of the functions) is demonstrated by Visual C ++.  Some readers are already preparing to write a caustic comment, but in vain.  In accordance with standard C ++ ISO / IEC 14882: 2003 (E), paragraph 3.2 / 5, in the described situation, the behavior is undefined.  Accordingly, the linker is not obliged to give any reasonable results, nor to give the same results when re-linking the same object files.  In some cases, the behavior will be what you expected, in some, perhaps not.  So Visual C ++ is innocent. <br><br>  It is time to note that the example looks rather artificial and curved.  Again, __declspec (noinline) is a feature specific to Visual C ++.  There are lots of other ways to be exactly in the same situation. <br><br>  For example, in two different headers there may randomly be different inline functions with the same signature.  If there is no situation where both headers are included in the same .cpp file, you will not get a compilation error and you will find yourself in a situation of breaking the ODR.  Still different .cpp files can be compiled with different values ‚Äã‚Äãof any compiler settings that change the behavior of the code.  Again the same situation.  #pragma pack can also make a contribution. <br><br>  Finally, if __declspec (noinline) is missing, in some cases the compiler may substitute the implementation of the function corresponding to the settings of the compiler and the preprocessor symbols specified for the corresponding translation unit. <br><br>  The scope for defects in this direction is endless.  Detecting such defects when they are already in your code is extremely difficult.  The behavior of the program can change during perelinkovka, and can remain the same - respectively, the defect can be difficult to even reproduce. <br><br>  The solution is one - if your code uses inline functions, make sure that the compilation of different translation units is performed in such a way that the behavior of these functions remains unchanged.  The compilation settings must be the same, the preprocessor characters must be the same. <br><br>  In the case described above, you need to define OVERRIDE_STANDARD_HANDLING in the StaticLib project and rebuild it. <br><br>  Take care of yourself. <br><br>  <i>Dmitry Mescheryakov</i> <i><br></i>  <i>Department of Data Entry Products</i> </div><p>Source: <a href="https://habr.com/ru/post/108166/">https://habr.com/ru/post/108166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../108157/index.html">Digest 6 interesting concepts and ideas of the past week</a></li>
<li><a href="../108161/index.html">About Yota and "Zhzhzh"</a></li>
<li><a href="../108163/index.html">Mentors: how does it work?</a></li>
<li><a href="../108164/index.html">Looking for projects on the 4th Startup Crash Test</a></li>
<li><a href="../108165/index.html">Quick download images on habraeffekt</a></li>
<li><a href="../108167/index.html">HP Envy 14 - Wired Computer of the Year</a></li>
<li><a href="../108168/index.html">Yandex.Direct General recommendations on strategies depending on advertising budgets</a></li>
<li><a href="../108169/index.html">Amazon Cluster GPU: A New Word in the World of Cloud Hosting</a></li>
<li><a href="../108175/index.html">AgilePiter meetings in St. Petersburg are resuming!</a></li>
<li><a href="../108176/index.html">562 applications were received for the domain Avto.rf</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>