<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Secure upload images to the server. Part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the second part of the translation. Start reading better with the first . 

 So, after applying the methods described in the first part, can w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Secure upload images to the server. Part two</h1><div class="post__text post__text-html js-mediator-article">  <i>This is the second part of the translation.</i>  <i>Start reading better with the <a href="http://habrahabr.ru/blogs/php/44610/">first</a> .</i> <br><br>  So, after applying the methods described in the first part, can we stop worrying?  Unfortunately not.  Which file extensions will be transferred to the PHP translator will depend on the server configuration.  The developer often does not know and does not control the configuration of the web server.  We saw web servers with a configuration such that .html and .js files were executed as php.  Some web applications may require that .gif or .jpeg files be interpreted by PHP (this often happens when images, such as graphs and charts, are dynamically built on the server by PHP itself). <br><br>  Even if we know exactly which file extensions are interpreted by PHP, we have no guarantee that this will not change in the future when other applications are installed on the server.  By that time, you can forget that the security of our server depends on these changes. <br><a name="habracut"></a><br>  If you have a web server based on Microsoft IIS, then you need to keep a few more points in mind.  Unlike Apache, the Microsoft IIS server supports the execution of ‚ÄúPUT‚Äù requests that allow users to upload files directly, bypassing PHP.  PUT requests can be used to upload files to the server if system permissions allow it to be done by IIS (it is running as IUSR_MACHINENAME).  This can be configured using the Services Manager: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://img223.imageshack.us/img223/6490/f3kf5.jpg" alt="image"><br><br>  To allow PHP to upload files, you must change the file system permissions to make the directory writable.  It is very important to make sure that the permissions of IIS do not allow writing files.  Otherwise, users will be able to upload arbitrary files using PUT requests, bypassing any checks you make in PHP. <br><br><h1>  Indirect access to downloaded files </h1>  Sometimes it is impossible to give direct access to the download directory.  This may be due to the fact that this directory is not under the root of the site or its access is restricted using server settings or .htaccess. <br><br>  Consider the following example (upload5.php): <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> $uploaddir = <font color="#A31515">'/var/spool/uploads/'</font> ; # Outside of web root <br> $uploadfile = $uploaddir . basename($_FILES[ <font color="#A31515">'userfile'</font> ][ <font color="#A31515">'name'</font> ]); <br> <br> <font color="#0000ff">if</font> (move_uploaded_file($_FILES[ <font color="#A31515">'userfile'</font> ][ <font color="#A31515">'tmp_name'</font> ], $uploadfile)) { <br> echo <font color="#A31515">"File is valid, and was successfully uploaded.\n"</font> ; <br> } <font color="#0000ff">else</font> { <br> echo <font color="#A31515">"File uploading failed.\n"</font> ; <br> } <br> ?&gt; <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Users cannot simply refer to / uploads / to upload files, and we must provide an additional opportunity for this (view5.php): <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> $uploaddir = <font color="#A31515">'/var/spool/uploads/'</font> ; <br> $name = $_GET[ <font color="#A31515">'name'</font> ]; <br> readfile($uploaddir.$name); <br> ?&gt;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The view5.php code has a serious vulnerability.  An attacker can use this code to read any file that can be read at the rights level of the web server.  For example, if you call <br>  <i><a href="http://www.example.com/view5.php%3Fname%3D../../../etc/passwd">www.example.com/view5.php?name=../../../etc/passwd</a></i> , you may be able to read the password file. <br><br>  <i>This bug can be fixed using the result function dirname (realpath ()), which returns the actual path to the file.</i>  <i>Thus, if this path is incorrect, then we do not show the file.</i>  <i>Similarly, with basename (), we get only the file name, which is already attached to the correct download directory.</i>  <i>- Approx.</i>  <i>translator.</i> <br><br><h1>  Uses of local include (Local file inclusion attacks) </h1>  <i>This is one of the most terrible security holes on sites.</i>  <i>It is so well known that in reality it almost does not manifest itself.</i>  <i>But, as they say - ‚Äúrepetition is the mother of learning‚Äù.</i>  <i>- Approx.</i>  <i>translator.</i> <br><br>  The last example stores the downloaded files outside the root, where they cannot be accessed directly and executed.  Although it is safe, an attacker may have a chance to take advantage of this if another vulnerability is present in the code - use include.  Suppose that we have some other page that contains the following code (local_include.php): <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> <font color="#008000">// ... some code here</font> <br> <br> <font color="#0000ff">if</font> (isset($_COOKIE[ <font color="#A31515">'lang'</font> ])) { <br> $lang = $_COOKIE[ <font color="#A31515">'lang'</font> ]; <br> } elseif (isset($_GET[ <font color="#A31515">'lang'</font> ])) { <br> $lang = $_GET[ <font color="#A31515">'lang'</font> ]; <br> } <font color="#0000ff">else</font> { <br> $lang = <font color="#A31515">'english'</font> ; <br> } <br> <br> include( <font color="#A31515">"language/$lang.php"</font> ); <br> <br> <font color="#008000">// ... some more code here</font> <br> ?&gt; <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  This is a common piece of code that usually occurs in multilingual web applications.  Such code can provide different include files depending on user preferences. <br><br>  The code has an include-vulnerability.  The attacker may force this page to include any file from the file system, for example: <br><br><img src="http://img223.imageshack.us/img223/3251/f4bd6.jpg" alt="image"><br><br>  This request causes local_include.php to include and execute ‚Äúlanguage /../../../../../../../../ tmp / phpinfo‚Äù, which is simply / tmp / phpinfo.  The attacker can only execute files that are already on the server side, thus its capabilities are limited. <br><br>  But, if an attacker is able to upload files, even outside the root of the site, and he knows the name and location of the downloaded file, using a similar vulnerability, he can execute arbitrary code on the server. <br><br>  <i>Previously, there was a php setting that allowed you to include files by url, so you could execute code that might not be on the server.</i>  <i>In recent versions of php, there is no such possibility in principle for security reasons.</i>  <i>- Approx.</i>  <i>translator</i> <i><br></i> <br><br><h1>  Eventually </h1>  When providing protection, it is important to prevent the attacker from knowing the name of the downloaded file.  This can be done by randomly generating the names of the downloaded files, while preserving the original ones in the database. <br><br>  Consider an example (upload6.php): <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> require_once <font color="#A31515">'DB.php'</font> ; <font color="#008000">// We are using PEAR::DB module</font> <br> $uploaddir = <font color="#A31515">'/var/spool/uploads/'</font> ; <font color="#008000">// Outside of web root</font> <br> $uploadfile = tempnam($uploaddir, <font color="#A31515">"upload_"</font> ); <br> <br> <font color="#0000ff">if</font> (move_uploaded_file($_FILES[ <font color="#A31515">'userfile'</font> ][ <font color="#A31515">'tmp_name'</font> ], $uploadfile)) { <br> <font color="#008000">// Saving information about this file in the DB</font> <br> $db =&amp; DB::connect( <font color="#A31515">"mysql://username:password@localhost/database"</font> ); <br> <br> <font color="#0000ff">if</font> (PEAR::isError($db)) { <br> unlink($uploadfile); <br> die <font color="#A31515">"Error connecting to the database"</font> ; <br> } <br> <br> $res = $db-&gt;query( <font color="#A31515">"INSERT INTO uploads SET name=?, original_name=?, mime_type=?"</font> , <br> array(basename($uploadfile, <br> basename($_FILES[ <font color="#A31515">'userfile'</font> ][ <font color="#A31515">'name'</font> ]), <br> $_FILES[ <font color="#A31515">'userfile'</font> ][ <font color="#A31515">'type'</font> ])); <br> <br> <font color="#0000ff">if</font> (PEAR::isError($res)) { <br> unlink($uploadfile); <br> die <font color="#A31515">"Error saving data to the database. The file was not uploaded"</font> ; <br> } <br> <br> $id = $db-&gt;getOne( <font color="#A31515">'SELECT LAST_INSERT_ID() FROM uploads'</font> ); <font color="#008000">// MySQL specific</font> <br> <br> echo <font color="#A31515">"File is valid, and was successfully uploaded. You can view it &lt;a <br> href=\"view6.php?id=$id\"&gt;here&lt;/a&gt;\n"</font> ; <br> } <font color="#0000ff">else</font> { <br> echo <font color="#A31515">"File uploading failed.\n"</font> ; <br> } <br> ?&gt; <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  View the downloaded file (view6.php): <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> require_once <font color="#A31515">'DB.php'</font> ; <br> $uploaddir = <font color="#A31515">'/var/spool/uploads/'</font> ; <br> $id = $_GET[ <font color="#A31515">'id'</font> ]; <br> <br> <font color="#0000ff">if</font> (!is_numeric($id)) { <br> die( <font color="#A31515">"File id must be numeric"</font> ); <br> } <br> <br> $db =&amp; DB::connect( <font color="#A31515">"mysql://root@localhost/db"</font> ); <br> <br> <font color="#0000ff">if</font> (PEAR::isError($db)) { <br> die( <font color="#A31515">"Error connecting to the database"</font> ); <br> } <br> <br> $file = $db-&gt;getRow( <font color="#A31515">'SELECT name, mime_type FROM uploads WHERE id=?'</font> , <br> array($id), DB_FETCHMODE_ASSOC); <br> <br> <font color="#0000ff">if</font> (PEAR::isError($file)) { <br> die( <font color="#A31515">"Error fetching data from the database"</font> ); <br> } <br> <br> <font color="#0000ff">if</font> (is_null($file) || count($file)==0) { <br> die( <font color="#A31515">"File not found"</font> ); <br> } <br> <br> header( <font color="#A31515">"Content-Type: "</font> . $file[ <font color="#A31515">'mime_type'</font> ]); <br> readfile($uploaddir.$file[ <font color="#A31515">'name'</font> ]); <br> ?&gt; <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now downloaded files cannot be directly executed (because they are stored outside the root).  They cannot be used in include-vulnerabilities, because the attacker does not have the ability to find out the name of the downloaded file in the file system on the server.  There is some problem with the "intersection" of files, because the files are tied to a numeric index, and not to its name.  I would also like to indicate the use of PEAR :: DB for SQL queries.  In our SQL, question marks are used as spaces for query variables.  When data received from a user is transferred to a query, their types are automatically placed, preventing problems with SQL injections. <br><br>  An alternative to storing files in the file system is to store files directly in the database using BLOB fields.  This approach also has its advantages, but in most cases it does not apply, because of its huge resource intensity. <br><br><h1>  Other problems </h1>  There are many more things that you should pay attention to when developing systems with uploading files to the server, namely: <br><ol><li>  <b>Denial of service.</b>  The user can upload several large files, thereby occupying all the free space on the server.  This is solved by setting a limit on the size of the uploaded file and on the number of uploaded files from one user per day. </li><li>  <b>Performance.</b>  In the last example, with frequent requests to display a file, the view may be a bottleneck.  If the server is heavily loaded, then it is recommended to use another one, intended only for storing static content on which the php code cannot be executed.  Another way to improve performance is to use a caching proxy server, which prevents repeated processing of static content on the server side by issuing appropriate headers. </li><li>  <b>Access control.</b>  In all the examples above, we assumed that any user could view any downloaded file.  However, it may be necessary that only the user who downloaded the file could view it.  In this case, the file owner information should be saved during the download.  When viewing the file should be an appropriate check. </li></ol><br><h1>  Conclusion </h1>  When developing uploading files to a server, it is necessary to take into account the vulnerabilities described in the article in order not to become a victim of malicious users. <br><br>  It is best not to allow users to directly access downloadable files.  This can be done by storing the downloaded files outside the root of the site or by denying access to this directory using the web server configuration. <br><br>  Another important security measure is not to store files on the server under the original file names.  This will prevent the possibility of include-vulnerabilities, even if they exist, as well as make any manipulation of the file names for the attacker impossible. <br><br>  Checking the image format via PHP does not give any guarantee that this file cannot be executed as a php script.  You can create a valid image, which at the same time will be an executable php-script. <br><br>  Data from the client, such as Content-Type and file extension, cannot be trusted at all.  They are very easy to fake.  Moreover, the list of executable extensions depends entirely on the web server, and there is no guarantee that it will not change over time. <br><br>  Performance is very important, but it‚Äôs absolutely impossible to ensure safe uploading of files to the server without harming it. </div><p>Source: <a href="https://habr.com/ru/post/44615/">https://habr.com/ru/post/44615/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446136/index.html">My Marble Machine, printed on a 3D printer</a></li>
<li><a href="../446138/index.html">How easy it is to legally organize your startup in the form of a simple partnership</a></li>
<li><a href="../446142/index.html">Flat Earth: Experiments and Evidence</a></li>
<li><a href="../446144/index.html">The digest of interesting materials for the mobile developer # 292 (March 25 - March 31)</a></li>
<li><a href="../446148/index.html">Linux Kernel 5.0 - we write Simple Block Device under blk-mq</a></li>
<li><a href="../446150/index.html">Machine learning without Python, Anaconda and other reptiles</a></li>
<li><a href="../446152/index.html">Commando VM - an alternative to Kali Linux for Windows</a></li>
<li><a href="../446162/index.html">How to become a "sensible junior". Personal experience</a></li>
<li><a href="../446166/index.html">A simple sprintf-based ASN1 codec</a></li>
<li><a href="../446172/index.html">Limit Messages API VK - what to do</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>