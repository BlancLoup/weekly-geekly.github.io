<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Magic formula or how to see the threat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every system works according to a unique algorithm, without an algorithm it is not a system. Flexible, rigid, linear, branching, deterministic, stocha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Magic formula or how to see the threat</h1><div class="post__text post__text-html js-mediator-article"> Every system works according to a unique algorithm, without an algorithm it is not a system.  Flexible, rigid, linear, branching, deterministic, stochastic - it does not matter.  It is important that in order to achieve the best result, the system obeys certain rules.  We are often asked a question about the algorithms of our product, in particular: how do we manage to better competitors to calculate future threats?  For obvious reasons, all the details of this magic formula cannot be revealed, but you can slightly open the door of our <a href="http://eugene.kaspersky.ru/tag/technology/">technological kitchen</a> and learn something. <br><a name="habracut"></a><br>  In general, we use the deductive method, that is, we go from the general to the particular.  In our case, it could look something like this: all malware does this -&gt; this file does this too -&gt; therefore, the file is malicious.  But in practice, not everything is so simple and smooth. <br><br>  First of all, it is impossible to identify specific actions that clearly indicate the harmfulness of the object.  The classic example with <a href="http://eugene.kaspersky.ru/2014/02/03/heuristic-proactive-protection/">access to the MBR</a> is that everything that pulls this command malicious cannot be considered, there are many other applications for peaceful purposes.  The same applies to all other actions.  After all, in the original, all the teams were created to perform some useful things. <br><br>  In other words, the task ‚Äúto separate the wheat from the chaff‚Äù is irrelevant here.  Another thing is to estimate the proportions and composition of grains and chaff, estimate the same parameters in the adjacent barn, analyze the results and then make an informed decision about setting a comma in the phrase ‚Äútreat not to be missed‚Äù.  To do this, we use technology with a straightforward name SR (Security Rating) - a sort of spreading self-learning system of weights, which helps to better understand the true nature of an object in the process of its formal evaluation and <a href="http://eugene.kaspersky.ru/2012/03/07/emulator/">emulation</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The analysis takes into account the composition and density of the events generated by the object and its external attributes (name, size, location, compression, etc.).  Based on a set of rules, each of the parameters receives an individual hazard rating (0-100%).  The first package of rules (and there are more than 500 of them now) was the result of a ‚Äúmanual‚Äù study of more than 80 thousand unique malware of various families.  Now the rules are developed mainly automatically, and expert analysts only ‚Äútwist‚Äù self-learning algorithms. <br><br>  For ease of testing and maintenance, the rules are divided into groups (for example, the Internet, Passwords, Registry, etc.) and if the object is ‚Äúinherited‚Äù by appropriate behavior in one or more of them, appropriate sanctions are taken to it. <br><br>  Examples of the simplest rules: <br>  <i>The rule ‚ÄúDriver loading via the low-level ntdll.dll API‚Äù</i> <br>  API function: <b>Driver loading (NtLoadDriver)</b> <br>  Argument 1: <b>*</b> <br>  Argument 2: <b>*</b> <br>  Argument 3..N: <b>*</b> <br>  Evaluation: single operation - <b>40%</b> , 2-3 operations - <b>50%</b> ,&gt; 3 operations - <b>60%</b> <br>  Harmfulness: <b>No</b> <br>  <i>Rule "Analysis of machine kernel code (removal of hooks)"</i> <br>  API function: <b>Create / open file (CreateFile)</b> <br>  Argument 1: <b>Contains the entry "ntoskrnl.exe"</b> <br>  Argument 2: <b>*</b> <br>  Argument 3..N: <b>*</b> <br>  Evaluation: single operation - <b>100%</b> , 2-3 operations - <b>100%</b> ,&gt; 3 operations - <b>100%</b> <br>  Harmfulness: <b>Yes</b> <br><br>  The final object rating is the sum of all private ratings after checking the entire database of rules.  In other words, this is a typical <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D1%2581%25D0%25BA%25D1%2583%25D1%2581%25D1%2581%25D1%2582%25D0%25B2%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BD%25D0%25B5%25D0%25B9%25D1%2580%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D0%25B5%25D1%2582%25D1%258C">neural network</a> that collects signals from a variety of sensors, analyzes their qualitative and quantitative characteristics, examines connections and issues a verdict.  Approximately in this form the SR took over the watch in 2007.  (patent <a href="http://www.google.ru/patents/US7530106">US7530106</a> ).  As you guessed, we immediately counted the technology to feed, educate and pump. <br><br>  Problem Number One was that the analyzed file can generate a huge number of minor events that can not affect the final verdict of its harmfulness.  For example, a Delphi application generates up to 500 such events at startup.  They will be identical in any application written in this language and at the same time do not carry any useful information about the real intentions of the file.  This "noise" not only consumed computer resources, but also made analysis difficult. <br>  To eliminate such noise, we made a filter.  Moreover, unlike the usual rules, there is a sufficiently Boolean feature.  Thus, the rule is greatly simplified and, accordingly, its work is accelerated.  As a result, the rules contain only the name of the API function and masks for its arguments. <br><br>  For example: <br>  <i><b>SysAllocString (*, - NULL -, - NULL-)</b></i> <br><br>  Here, if the first argument of the function has any value, and the rest are missing, the event will be considered insignificant. <br><br>  For automatic generation of rules for filtering minor events, we used three methods. <br><br>  The first is the "fruit fly method".  We are preparing an application of the ‚ÄúHello World‚Äù type using the X development environment, where possible we use its most popular libraries.  We feed the compiled application to the emulator, and write all the events generated by the ‚ÄúDrosophila‚Äù into the ‚Äúinsignificant‚Äù column. <br><br>  The second is the "packed fruit fly method".  Similar to the first, except that we are interested in the behavior of the packer / protector.  To do this, we process the soother assembly in turn with all sorts of packers and protectors, feed the emulator and ... well, then you guessed it. <br><br>  The third method is statistical.  We analyze the behavior of a large number of legitimate and malicious files, and select the API calls that are often found in the behavior of those and others.  This method complements the first two and is effective if it is not possible to create a ‚Äúfruit fly‚Äù.  A typical example of functions identified in this way is functions for working with GUI and memory allocation. <br><br>  But it was one of the <i>smallest</i> Challenges.  Further - more interesting. <br><br>  The first version of SR worked on a specific protected computer practically in isolation.  We did not have a global picture, we did not understand what the rules are, how often and how exactly they work and we could not quickly change their ratings.  The result is a large unused potential for improving efficiency :) At the same time, the <a href="http://blog.kaspersky.ru/ksn/">KSN cloud was</a> developing at full speed and we had already hooked the <a href="http://eugene.kaspersky.ru/2012/11/15/nayti-vse/">Astraea</a> expert system to it to analyze the huge volume of signals from protected computers and to give reasonable conclusions about the epidemiological situation in the world. <br><br>  In 2009, to everyone's joy, the next version of SR (SR2, <a href="http://www.google.com/patents/US8640245">US8640245</a> ) merged with KSN and Astraea. <br><br>  And a bigdat with a good expert superstructure is in our field a "materiel" of the formula for success! <br><br>  In essence, we obtained a lever for (i) ‚Äúshooting off‚Äù ineffective and ‚Äúdead‚Äù rules, (ii) temporarily turning off or testing rules, (iii) practically real-time correction of rule ratings using coefficients.  At the same time, the size of the coefficient base amounted to funny kilobytes and its updating, even in those years, practically did not burden the Internet channel. <br><br>  Astraea also expanded the statistical base for calculating ratings: this process involved not only signals from various emulators, but also many other sensors, which also reported to KSN.  In addition, the product could receive from the cloud an already well-known verdict and make a decision, without bringing the emulation process to the end (and in some cases not launching it at all).  And another nice plus is that we can, with a high degree of certainty, pull out of the stream for manual research of unknown ‚Äúanimals‚Äù who did not gain the threshold value of the rating, but were very suspicious. <br><br>  It is important that Astraea makes the correction of the rules automatically - it is up to the person to regularly evaluate the effectiveness of the mathematical model used and optimize it (patent application <a href="https://www.google.com/patents/US20140096184">US20140096184</a> ). <br><br>  The presence of global bigdats immediately rolled our lip into new ideas for solving old problems.  First of all - <a href="http://eugene.kaspersky.ru/2012/06/20/robota-nad-ashypkamy/">falssy</a> .  In principle, we twisted this topic from the very first day of the implementation of SR in products.  But in 2011.  rolled out several new features at once to minimize false positives. <br><br>  There are many operations that are performed by legitimate software with completely peaceful purposes.  For example, installers delete files in the System32 folder.  Auto-adjusting the rating of this operation will lead to its unreasonable degradation and we will start to skip real malware.  Some compromise is required here so that the wolves are full and the sheep are safe.  And then we decided to divide the rating calculation mechanism into 3 parts. <br><br>  First, the calculation described above: the more dangerous the behavior and the more common, the higher the rating.  Secondly, a kind of <a href="http://eugene.kaspersky.ru/2011/12/08/fichi-nevidimogo-fronta-3/">whitelist</a> rules that cancel or correct the actions of ordinary rules apply to specific situations or files.  Thirdly, the rules of detecting legitimate applications that reduce the hazard rating when detecting characteristic behavior and can even form a safety rating. <br><br>  Example: <br>  <i>Rule "Create startup key"</i> <br>  API function: <b>Registry: setting a parameter value (RegSetValueEx)</b> <br>  Argument 1: <b>Contains the entry "\ Registry \ Machine \ Software \ Classes \ * \ shellex \ ContextMenuHandlers \ Notepad ++"</b> <br>  Argument 2: <b>*</b> <br>  Argument 3..N: <b>*</b> <br>  Evaluation: single operation - <b>1%</b> , 2-3 operations - <b>1%</b> ,&gt; 3 operations - <b>1%</b> <br>  Harmfulness: <b>No</b> <br><br>  Here you can clearly see that the registry key is twitching, but this is just Notepad ++ throwing its library.  The rule argument removes the Fols, while the main rule remains unchanged and for other attempts to change the key will work as expected. <br><br>  And in 2011, we introduced another useful feature.  As mentioned above, in the SR, the rules worked autonomously from each other, and thus we could not study complex dependencies such as ‚Äúfile upload‚Äù - ‚Äúsave file to disk‚Äù - ‚Äúprescription to autorun‚Äù.  After all, if you trace such a dependence, you can give a rating much more than the sum of the ratings of individual events.  Or less :) And then we decided to implement event correlation in SR2 for more accurate detection of unknown malware. <br><br>  Made it in two ways.  First, we created bit masks that distinguish groups of rules or individual rules on OR and AND.  The basic description is a bit classification index of behavior.  Initially, this was invented for clustering malware according to the characteristics of their behavior, but a similar approach can be used to refine the rating score - using masks to implement a function like (RULE76 or RULE151) and (RULE270 or RULE540).  The advantage of such masks is compactness and speed of work, the disadvantage is low flexibility. <br><br>  Secondly, they made special scripts that conduct a global analysis after calculating the SR (patent <a href="http://www.google.com/patents/US8607349">US8607349</a> ).  Scripts can be launched one by one, both independently and when a rule is triggered.  Each of them has access to a database of accumulated statistics of previously triggered rules and groups of rules.  As a result, we have the opportunity to (i) use complex logic - conditions, calculations, cycles, subroutine calls;  (ii) maximize the use of neural networks;  (iii) to form a script not only a clarification to the SR rating, but also new knowledge that will be applied by subsequent scripts. <br><br>  For example, the first script, based on an analysis of a dozen rules, concludes that ‚Äúthe application is trying to obtain passwords for other programs‚Äù.  The second script likewise concludes that ‚Äúthe application is transmitting something to the Internet.‚Äù  The third script makes a conclusion like ‚Äúif the application is interested in passwords AND transmits something to the Internet, THEN + 100% rating‚Äù. <br><br>  In addition, the scripts can be ‚Äúhooked‚Äù to any rule, in total, the rule becomes a kind of ‚Äútrigger‚Äù for some algorithm. <br><br>  Sample script: <br><pre><code class="bash hljs">Var S : string; begin <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> copy(ExtractFilePath(APIArg[1]), 2, 100)=<span class="hljs-string"><span class="hljs-string">':\'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> begin AddSR(20); s := LowerCase(ExtractFileExt(APIArg[1]));  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> S = <span class="hljs-string"><span class="hljs-string">'.exe'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> AddSR(40); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> S = <span class="hljs-string"><span class="hljs-string">'.com'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> AddSR(50); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> S = <span class="hljs-string"><span class="hljs-string">'.pif'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> AddSR(60); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> S = <span class="hljs-string"><span class="hljs-string">'.zip'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> AddSR(-20); end;  end.</code> </pre> <br><br>  In this example, the script evaluates the file creation operation.  We check the fact of creating the file in the root of the disk, and for this we immediately charge 20% SR.  Further, depending on the file extension, we make an additional rating charge with a ‚Äú+‚Äù or ‚Äú-‚Äù sign. <br><br>  The given example demonstrates the main plus of scripts - the possibility of complex differentiated evaluation of function arguments with setting an individual SR rating based on the results of various checks.  Moreover, some checks can increase the rating, some - lower, which allows you to do complex checks and complex analysis, aimed at additional suppression of falss. <br><br>  As a bonus - the hand of the author of the technology described above.  As it is, almost on a napkin: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f07/3c7/3a0/f073c73a064c3b8d64c92a816979e731.png"><br><br>  And now a little about the future. <br><br>  The <a href="http://www.kaspersky.ru/home-security">personal product line</a> 2015 is coming out very soon.  In general, we thought-weighed and decided to completely abandon the local SR and completely transfer the calculation of the rating to the cloud.  This approach has many advantages at once.  The quality of analysis will not suffer, but the <b>resource consumption of the protected computer will decrease by an order of magnitude</b> - all calculations will occur in our infrastructure.  At the same time, the delay in delivery of the verdict will be ... mneee ... yes, practically nothing will be: only framed software will be able to notice these fractions of milliseconds. <br><br>  Well, like this briefly about our magic formula, only 10 thousand characters.  And this is really only a ‚Äúslightly opened door‚Äù: in fact, acquaintance with the detailed description of the technology will take several days and a lot of clarifications. <br><br>  By the way, you can clarify right now, below, in the comments. </div><p>Source: <a href="https://habr.com/ru/post/228427/">https://habr.com/ru/post/228427/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228415/index.html">Transoceanic Submarine Communication Cables</a></li>
<li><a href="../228417/index.html">Published a single rating of seo-companies in 2014</a></li>
<li><a href="../228419/index.html">Features of using Sails for beginners (Part 2)</a></li>
<li><a href="../228421/index.html">Dynamic magnetic stripe as the main element of an electronic card</a></li>
<li><a href="../228425/index.html">Overview cover for smartphone Pocketbook CoverReader</a></li>
<li><a href="../228429/index.html">Popularization of technical creativity in China</a></li>
<li><a href="../228431/index.html">How to build a spacecraft without leaving the office</a></li>
<li><a href="../228433/index.html">Computing Graphs, Speculative Locks and Arenas for Tasks at Intel¬Æ Threading Building Blocks</a></li>
<li><a href="../228435/index.html">Spiral Ulam, the area of ‚Äã‚Äãthe prohibition of primes</a></li>
<li><a href="../228437/index.html">Promotional Wars: Search Engines vs. Internet Providers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>