<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Position-independent code (PIC) in x64 shared libraries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, I'm still Marco and still a system programmer at Badoo. Last week I published a translation about PIC in shared libraries, but there is a second p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Position-independent code (PIC) in x64 shared libraries</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/e35/61b/1b6/e3561b1b6a9f4c9683f72937fa9a2c5c.jpg" alt="enter image description here"></p><br><p>  <em>Hi, I'm still Marco and still a system programmer at Badoo.</em>  <em><a href="https://habrahabr.ru/company/badoo/blog/323904/">Last week I published a translation</a> about PIC in shared libraries, but there is a second part - about shared libraries on x64, so I decided not to leave the case unfinished.</em> </p><a name="habracut"></a><br><p>  The previous article explained how addressing does not depend on an address (Position Independent Code, PIC) using examples compiled for x86 architecture.  I promised to talk about PIC on x64 <a href="https://habrahabr.ru/company/badoo/blog/324616/">[1]</a> in a separate article.  Here she is.  This article will have far fewer details, since it is implied that you already understand how the PIC works in theory.  In essence, the idea is the same for both architectures, but some details differ because of their features. </p><br><h3 id="adresaciya-otnositelno-rip">  RIP Addressing </h3><br><p>  On x86 functions calls (using the call instruction) use offsets relative to IP, however data calls (using the mov instruction) support only absolute addresses.  From the previous article, you know that this makes the PIC a little less efficient, since the PIC in essence requires that all offsets are relative.  Absolute addresses and address independence do not go hand in hand. </p><br><p>  x64 solves this problem with a new type of addressing relative to RIP, which is the default address for all 64-bit mov-instructions accessing memory (it is used for other instructions, such as, for example, lea).  Here is a quote from the "Intel Architecture Manual vol 2a" (one of the main documents on the Intel-architecture): </p><br><blockquote>  RIP (relative instruction-pointer or relative to the pointer to the current instruction) is a new type of addressing implemented in 64-bit mode.  The final address is formed by adding an offset to the 64-bit pointer to the next instruction. </blockquote><p>  The offset used in the RIP-relative mode has a size of 32 bits, since it can be used both in a negative and in a positive direction.  It turns out that the maximum offset relative to the RIP, which is supported in this addressing mode, is ¬± 2GB. </p><br><h3 id="x64-pic-s-obrascheniem-k-dannym-primer">  x64 PIC with access to data.  Example </h3><br><p>  For a simpler comparison, I will use the same C example as in the example in the previous article: </p><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> myglob = <span class="hljs-number"><span class="hljs-number">42</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ml_func</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> myglob + a + b; }</code> </pre> <br><p>  Let's look at <code>ml_func</code> disassembled view: </p><br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">00000000000005</span></span>ec &lt;ml_func&gt;: <span class="hljs-number"><span class="hljs-number">5</span></span>ec: <span class="hljs-number"><span class="hljs-number">55</span></span> push rbp <span class="hljs-number"><span class="hljs-number">5</span></span>ed: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> e5 mov rbp,rsp <span class="hljs-number"><span class="hljs-number">5f</span></span>0: <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">7d</span></span> fc mov DWORD PTR [rbp<span class="hljs-number"><span class="hljs-number">-0x4</span></span>],edi <span class="hljs-number"><span class="hljs-number">5f</span></span>3: <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">75</span></span> f8 mov DWORD PTR [rbp<span class="hljs-number"><span class="hljs-number">-0x8</span></span>],esi <span class="hljs-number"><span class="hljs-number">5f</span></span>6: <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">05</span></span> db <span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov rax,QWORD PTR [rip+<span class="hljs-number"><span class="hljs-number">0x2009d</span></span>b] <span class="hljs-number"><span class="hljs-number">5f</span></span>d: <span class="hljs-number"><span class="hljs-number">8</span></span>b <span class="hljs-number"><span class="hljs-number">00</span></span> mov eax,DWORD PTR [rax] <span class="hljs-number"><span class="hljs-number">5f</span></span>f: <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">45</span></span> fc add eax,DWORD PTR [rbp<span class="hljs-number"><span class="hljs-number">-0x4</span></span>] <span class="hljs-number"><span class="hljs-number">602</span></span>: <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">45</span></span> f8 add eax,DWORD PTR [rbp<span class="hljs-number"><span class="hljs-number">-0x8</span></span>] <span class="hljs-number"><span class="hljs-number">605</span></span>: c9 leave <span class="hljs-number"><span class="hljs-number">606</span></span>: c3 ret</code> </pre> <br><p>  The most interesting instruction here is at <code>0x5f6</code> : it places the address myglob in rax, referring to the element from the GOT.  As we can see, it uses RIP-relative addressing.  Since it is relative to the address of the next instruction, we actually get <code>0x5fd + 0x2009db = 0x200fd8</code> .  Thus, the GOT element, which contains the address myglob, is located at <code>0x200fd8</code> .  Let's check how far our calculations are far from reality: </p><br><pre> <code class="hljs dos">$ readelf -S libmlpic_dataonly.so There are <span class="hljs-number"><span class="hljs-number">35</span></span> section headers, starting <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> offset <span class="hljs-number"><span class="hljs-number">0</span></span>x13a8: Section Headers: [Nr] Name <span class="hljs-built_in"><span class="hljs-built_in">Type</span></span> Address Offset Size EntSize Flags Link Info Align [...] [<span class="hljs-number"><span class="hljs-number">20</span></span>] .got PROGBITS <span class="hljs-number"><span class="hljs-number">0000000000200</span></span>fc8 <span class="hljs-number"><span class="hljs-number">00000</span></span>fc8 <span class="hljs-number"><span class="hljs-number">0000000000000020</span></span> <span class="hljs-number"><span class="hljs-number">0000000000000008</span></span> WA <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> [...]</code> </pre> <br><p>  GOT starts at <code>0x200fc8</code> , so myglob is in the third element.  And we can see the relocation added to the myglob binary: </p><br><pre> <code class="hljs delphi">$ readelf -r libmlpic_dataonly.so Relocation section <span class="hljs-string"><span class="hljs-string">'.rela.dyn'</span></span> at offset <span class="hljs-number"><span class="hljs-number">0</span></span>x450 contains <span class="hljs-number"><span class="hljs-number">5</span></span> entries: Offset Info <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> Sym. Value Sym. <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + Addend [...] <span class="hljs-number"><span class="hljs-number">000000200</span></span>fd8 <span class="hljs-number"><span class="hljs-number">000500000006</span></span> R_X86_64_GLOB_DAT <span class="hljs-number"><span class="hljs-number">0000000000201010</span></span> myglob + <span class="hljs-number"><span class="hljs-number">0</span></span> [...]</code> </pre> <br><p>  We see a relocation entry for the address <code>0x200fd8</code> , telling the linker to add the address myglob there when it knows the final address for the symbol. </p><br><p>  Now it should be clear how the address of myglob is obtained in the code.  The following instruction at address <code>0x5fd</code> dereferences the pointer in order to get the final address, and puts it in eax <a href="https://habrahabr.ru/company/badoo/blog/324616/">[2]</a> . </p><br><h3 id="x64-pic-s-obrascheniem-k-funkciyam-primer">  x64 PIC with access to functions.  Example </h3><br><p>  Let's now see how function calls work with the PIC on x64.  And let's use the same example as in the previous article: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> myglob = <span class="hljs-number"><span class="hljs-number">42</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ml_util_func</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ml_func</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = b + ml_util_func(a); myglob += c; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> b + myglob; }</code> </pre> <br><p>  Disassembling <code>ml_func</code> , we get: </p><br><pre> <code class="hljs css">000000000000064<span class="hljs-selector-tag"><span class="hljs-selector-tag">b</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">ml_func</span></span>&gt;: 64<span class="hljs-selector-tag"><span class="hljs-selector-tag">b</span></span>: 55 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span> 64<span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span>: 48 89 <span class="hljs-selector-tag"><span class="hljs-selector-tag">e5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span> 64<span class="hljs-selector-tag"><span class="hljs-selector-tag">f</span></span>: 48 83 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ec</span></span> 20 <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span>,0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x20</span></span> 653: 89 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">d</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ec</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x14]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">edi</span></span> 656: 89 75 <span class="hljs-selector-tag"><span class="hljs-selector-tag">e8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x18]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">esi</span></span> 659: 8<span class="hljs-selector-tag"><span class="hljs-selector-tag">b</span></span> 45 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ec</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x14]</span></span> 65<span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span>: 89 <span class="hljs-selector-tag"><span class="hljs-selector-tag">c7</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edi</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> 65<span class="hljs-selector-tag"><span class="hljs-selector-tag">e</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">e8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">fd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">fe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> 560 &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">ml_util_func</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">plt</span></span>&gt; [... snip more code ...]</code> </pre> <br><p>  The call, as before, looks like <code>ml_util_func@plt</code> .  Let's see what is there: </p><br><pre> <code class="hljs xml">0000000000000560 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ml_util_func@plt</span></span></span><span class="hljs-tag">&gt;</span></span>: 560: ff 25 a2 0a 20 00 jmp QWORD PTR [rip+0x200aa2] 566: 68 01 00 00 00 push 0x1 56b: e9 d0 ff ff ff jmp 540 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">_init+0x18</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  It turns out that the GOT record containing the real address <code>ml_util_func</code> is located at <code>0x200aa2 + 0x566 = 0x201008</code> .  And the relocation record is also in place, as expected: </p><br><pre> <code class="hljs delphi">$ readelf -r libmlpic.so Relocation section <span class="hljs-string"><span class="hljs-string">'.rela.dyn'</span></span> at offset <span class="hljs-number"><span class="hljs-number">0</span></span>x480 contains <span class="hljs-number"><span class="hljs-number">5</span></span> entries: [...] Relocation section <span class="hljs-string"><span class="hljs-string">'.rela.plt'</span></span> at offset <span class="hljs-number"><span class="hljs-number">0</span></span>x4f8 contains <span class="hljs-number"><span class="hljs-number">2</span></span> entries: Offset Info <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> Sym. Value Sym. <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + Addend [...] <span class="hljs-number"><span class="hljs-number">000000201008</span></span> <span class="hljs-number"><span class="hljs-number">000600000007</span></span> R_X86_64_JUMP_SLO <span class="hljs-number"><span class="hljs-number">000000000000063</span></span>c ml_util_func + <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><h3 id="proizvoditelnost">  Performance </h3><br><p>  In both examples, you can see that a PIC on x64 requires less instructions than the same code on x86.  On x86, the GOT address is loaded into the register (ebx according to the agreement) in two stages: first, we receive the instruction address with a special call, and then we add the offset to the GOT.  None of these stages is needed on x64, since the relative offset to GOT is known to the linker and it can simply be used in the instruction with RIP-relative addressing. </p><br><p>  When we call a function, there is also no need to prepare the GOT address in ebx for the springboard, unlike x86, since the springboard simply accesses the element in the GOT directly through RIP-relative addressing. </p><br><p>  It turns out that the PIC on x64 still requires additional instructions compared to the code without the PIC, but the overhead projector is smaller.  The costs involved in using the whole register to store the pointer to the GOT are also no longer necessary.  RIP-relative addressing does not require additional registers <a href="https://habrahabr.ru/company/badoo/blog/324616/">[3]</a> .  As a result, the overhead for PIC on x64 is much smaller compared to x86 and this makes the PIC even more popular.  So popular that PIC is the default choice when creating shared libraries on this architecture. </p><br><h3 id="dlya-lyubopytnyh-ne-pic-kod-na-x64">  For the curious: not PIC x64 </h3><br><p>  GCC not only encourages you to use PIC for x64 shared libraries, but it does require it by default.  For example, if we compile the first example without -fpic <a href="https://habrahabr.ru/company/badoo/blog/324616/">[4]</a> and try to build a shared library with -shared, we get an error from the linker: </p><br><pre> <code class="hljs sql">/usr/bin/ld: ml_nopic_dataonly.o: relocation R_X86_64_PC32 against symbol `myglob' can not be used when making a shared object; recompile <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> -fPIC /usr/<span class="hljs-keyword"><span class="hljs-keyword">bin</span></span>/ld: <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> <span class="hljs-keyword"><span class="hljs-keyword">failed</span></span>: Bad <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> collect2: ld returned <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span></code> </pre> <br><p>  What's happening?  Let's look at the disassembled view of <code>ml_nopic_dataonly.o</code> <a href="https://habrahabr.ru/company/badoo/blog/324616/">[5]</a> : </p><br><pre> <code class="hljs css">0000000000000000 &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">ml_func</span></span>&gt;: 0: 55 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span> 1: 48 89 <span class="hljs-selector-tag"><span class="hljs-selector-tag">e5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span> 4: 89 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">d</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">fc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x4]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">edi</span></span> 7: 89 75 <span class="hljs-selector-tag"><span class="hljs-selector-tag">f8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x8]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">esi</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a</span></span>: 8<span class="hljs-selector-tag"><span class="hljs-selector-tag">b</span></span> 05 00 00 00 00 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rip+0x0]</span></span> 10: 03 45 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x4]</span></span> 13: 03 45 <span class="hljs-selector-tag"><span class="hljs-selector-tag">f8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x8]</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">c9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">leave</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">c3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br><p>  Notice how myglob is accessed here in the instructions at 0xa.  The linker is expected to put the real address on myglob in the operand (that is, without GOT): </p><br><pre> <code class="hljs delphi">$ readelf -r ml_nopic_dataonly.o Relocation section <span class="hljs-string"><span class="hljs-string">'.rela.text'</span></span> at offset <span class="hljs-number"><span class="hljs-number">0</span></span>xb38 contains <span class="hljs-number"><span class="hljs-number">1</span></span> entries: Offset Info <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> Sym. Value Sym. <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + Addend <span class="hljs-number"><span class="hljs-number">00000000000</span></span>c <span class="hljs-number"><span class="hljs-number">000</span></span>f00000002 R_X86_64_PC32 <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> myglob - <span class="hljs-number"><span class="hljs-number">4</span></span> [...]</code> </pre> <br><p>  But the relocation <code>R_X86_64_PC32</code> , which the linker complained about.  It cannot link an object with such a relocation to a shared library.  Why?  Because the offset we are making relative to rip must fit in 32 bits, and we cannot say that this is always enough.  After all, we have a full-fledged 64-bit architecture with a huge address space.  The symbol may eventually end up in some shared library that is so far away and we don‚Äôt have enough 32 bits to access it.  So relocation <code>R_X86_64_PC32</code> not suitable for shared libraries on x64. </p><br><p>  But can we somehow create a non-PIC x64 code?  We can!  We need to tell the compiler to use the so-called ‚Äúlarge code model‚Äù.  This is done by adding the <code>-mcmodel=large</code> flag.  The topic of code models is certainly interesting, but its explanation will take us too far from the goal of this article <a href="https://habrahabr.ru/company/badoo/blog/324616/">[6]</a> .  So I‚Äôll briefly say that the code model is something like an agreement between the programmer and the compiler, in which the programmer makes some promises to the compiler as to what size of offsets will be used in the program.  In exchange, the compiler will be able to generate better code. </p><br><p>  It turns out that in order for the compiler to generate non-PIC code on x64, which would suit the linker, only the ‚Äúlarge code model‚Äù is suitable as the most undemanding.  Remember my explanation of why simple relocation is not good enough on x64 due to the fact that the offset can be more than 32 bits?  Here, the ‚Äúlarge code model‚Äù simply assumes nothing and uses the largest 64-bit offset for all data accesses.  This makes it possible to say that relocations are safe, and not to use an x64 PIC code.  Let's look at the disassembled view of the first example, compiled without <code>-fpic</code> and with <code>-mcmodel=large:</code> </p><br><pre> <code class="hljs css">0000000000000000 &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">ml_func</span></span>&gt;: 0: 55 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span> 1: 48 89 <span class="hljs-selector-tag"><span class="hljs-selector-tag">e5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbp</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span> 4: 89 7<span class="hljs-selector-tag"><span class="hljs-selector-tag">d</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">fc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x4]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">edi</span></span> 7: 89 75 <span class="hljs-selector-tag"><span class="hljs-selector-tag">f8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x8]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">esi</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a</span></span>: 48 <span class="hljs-selector-tag"><span class="hljs-selector-tag">b8</span></span> 00 00 00 00 00 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>,0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x0</span></span> 11: 00 00 00 14: 8<span class="hljs-selector-tag"><span class="hljs-selector-tag">b</span></span> 00 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax]</span></span> 16: 03 45 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x4]</span></span> 19: 03 45 <span class="hljs-selector-tag"><span class="hljs-selector-tag">f8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rbp-0x8]</span></span> 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">c9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">leave</span></span> 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">d</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">c3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br><p>  The instruction at address 0xa puts the address on myglob in eax.  Notice that her argument is still zero, and this suggests that you should expect relocation here.  In addition, it has a full 64-bit argument.  Absolute, not RIP-relative <a href="https://habrahabr.ru/company/badoo/blog/324616/">[7]</a> .  Well, notice that the two instructions here are needed to put the value of <code>myglob</code> in eax.  This is one of the reasons why the ‚Äúlarge code model‚Äù is less effective than alternatives. <br>  Now let's look at relocation: </p><br><pre> <code class="hljs delphi">$ readelf -r ml_nopic_dataonly.o Relocation section <span class="hljs-string"><span class="hljs-string">'.rela.text'</span></span> at offset <span class="hljs-number"><span class="hljs-number">0</span></span>xb40 contains <span class="hljs-number"><span class="hljs-number">1</span></span> entries: Offset Info <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> Sym. Value Sym. <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + Addend <span class="hljs-number"><span class="hljs-number">00000000000</span></span>c <span class="hljs-number"><span class="hljs-number">000</span></span>f00000001 R_X86_64_64 <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> myglob + <span class="hljs-number"><span class="hljs-number">0</span></span> [...]</code> </pre> <br><p>  Relocation type changed to <code>R_X86_64_64</code> .  This is a relocation with an absolute address, having a 64-bit value.  Linker is now happy and happily agrees to link this object to the shared library. </p><br><p>  Some critical thoughts may lead you to the question of why this compiler generates code that is not suitable by default for relocation during loading.  The answer is very simple.  Do not forget that the code is usually linked directly into a binary, which does not require any relocations.  And by default, the compiler assumes a ‚Äúsmall code model‚Äù to create the most efficient code.  If you know that your code will be in the shared library and you do not want to use the PIC, just explicitly tell the compiler.  It seems to me that the behavior of gcc is quite appropriate. </p><br><p>  Another question is why there are no problems with the PIC when using the ‚Äúsmall code model‚Äù?  The reason is that the GOT is always in the same shared library, where the code that refers to it is.  And, if the shared library is not large enough to fit in a 32-bit address space, there should be no problems with addressing.  Such large shared libraries are unlikely, but if you have one, the ABI for AMD64 has a ‚Äúbig code model with a PIC‚Äù. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  This article complements the <a href="https://habrahabr.ru/company/badoo/blog/323904/">previous one</a> , telling how the PIC works on x64 architecture.  This architecture uses a new addressing model, which helps make the PIC faster and is therefore more preferable for shared libraries (compared to x86).  This is very important to know, since x64 is the most popular architecture for servers, desktops and laptops at the moment. </p><br><h6 id="1">  [one] </h6><br><p>  As always, I use x64 as a convenient short name for an architecture known as x86-64, AMD64 or Intel 64. </p><br><h6 id="2">  [2] </h6><br><p>  In <code>eax</code> , not <code>rax</code> , since <code>myglob</code> an <code>int</code> type, which is also 32-bit on x64. </p><br><h6 id="3">  [3] </h6><br><p>  By the way, using the register would be much less problematic in x64, because it has twice as many registers as compared to x86. </p><br><h6 id="4">  [four] </h6><br><p>  This also happens if we explicitly indicate that we do not want the PIC to be passed as <code>-fno-pic</code> as an argument to <code>gcc</code> . </p><br><h6 id="5">  [five] </h6><br><p>  Please note that unlike other disassembler pins, which we discussed in this and last article, this is an object file, not a library or a binary.  So it will contain relocations for the linker. </p><br><h6 id="6">  [6] </h6><br><p>  More detailed information is available in <code>AMD64 ABI</code> and <code>man gcc</code> . </p><br><h6 id="7">  [7] </h6><br><p>  Some assemblers call this instruction <code>movabs</code> to distinguish it from other mov-instructions accepting relative addresses.  The manual for Intel architectures nonetheless calls it simply <code>mov</code> .  Its opcode format is <code>REX.W + B8 + rd</code> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/324616/">https://habr.com/ru/post/324616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324604/index.html">Detection and elimination of hacker attacks: how the system GOSPKA works</a></li>
<li><a href="../324606/index.html">Definition of development vector in the project</a></li>
<li><a href="../324608/index.html">Intel strengthens its position in HPC</a></li>
<li><a href="../324610/index.html">Monitoring of engineering infrastructure in the data center. Part 2. Power supply system</a></li>
<li><a href="../324612/index.html">How we started to develop our own project management system and what came out of it</a></li>
<li><a href="../324618/index.html">Encrypted mail services: what to choose?</a></li>
<li><a href="../324620/index.html">We make a more or less universal calculator of services for the site.</a></li>
<li><a href="../324622/index.html">Data Science Weekend Review</a></li>
<li><a href="../324624/index.html">Why in the mobile development team appeared safe running Windows 10</a></li>
<li><a href="../324626/index.html">About biology, mega constructions and magical animals</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>