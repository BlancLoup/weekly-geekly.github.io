<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CAN or not CAN? Or why do I need a network of microcontrollers?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I had to ask myself this question ten years ago or more. The work that had to be done was to donate a second life to the control panel. This is such a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CAN or not CAN? Or why do I need a network of microcontrollers?</h1><div class="post__text post__text-html js-mediator-article"><p>  I had to ask myself this question ten years ago or more.  The work that had to be done was to donate a second life to the control panel.  This is such a thing in the whole wall, consisting of light bulbs and switches with switches.  I think I will not be mistaken, assuming that the shields began to be made since the light bulbs appeared, since by that time the switches were probably already known.  A craving for beauty, in general, came to people from ancient times. </p><br><p>  Now many will prefer display panels to shields.  But whether display lovers will be in the majority depends on a lot of things unknown to us.  But now it's not about that. </p><br><p>  Anyone who can keep up the conversation about electrical wiring for five minutes will immediately tell me that the shield consists of flat panels on which switches and light bulbs are placed, as well as a box with many wires.  After all, a light bulb without wires is only for the purpose of either breaking it or stupidly or, if you come creatively and turn on the imagination, place it near the most inquisitive in your mouth and quickly find out where the emergency room is located. </p><a name="habracut"></a><br><p>  Everything was so, a bunch of wires leaving the box to the switches and light bulbs, only the light bulbs are small.  Apparently, the granddaughter of the famous light bulb Ilyich. </p><br><p>  And now, I remember, I looked out the window, and there the 21st century.  So you have to do everything anew and differently.  Instead of light bulbs - cost-effective LEDs.  Instead of wires - wiring.  Instead of one box, there are many, many small boxes, controllers, therefore. </p><br><p>  It turned out that if each controller can service four LEDs and two switches, then it will look optimal.  I mean, not so terrifying.  And if the power bus and the information bus, just four wires, pass through all the controllers, a certain elegance will appear.  It also turned out that 104 controllers would be required.  In an amicable way, here it would be necessary to set and solve the traveling salesman problem.  And then, perhaps, controllers would spend less.  But it was not good. </p><br><p>  By that time, I already knew what CAN is and the level of my respect for Bosch was much higher than that of a decent restaurant chef or neat housewife.  And BMW car manufacturers, I'm sure, even went to visit Bosch engineers. </p><br><p>  The Controller Area Network, as foreigners would say, in my opinion, as a technical solution, arose from the desire to do something, finally, well.  I will not conceal that you will not feel all the delights of the results of the work of engineers as soon as you master two volumes of the standard, and much later.  When you communicate with eyewitnesses, interview witnesses.  Now the volumes have increased, but maybe you can immediately start from the third, since now it is called CAN_FD.  However, let me continue. </p><br><p>  Even before the collision with the shield, I had to deal with other people's engineering solutions on the use of CAN, as well as make some mistakes.  Errors usually occur in the intervals between reading instructions and studying descriptions.  It is good that only from the second time they look like a rake. </p><br><p>  Now a few thousand words for the reader who is tolerant of boring and does not consider them enemies. </p><br><p>  CAN can be installed where RS485 previously worked on twisted pair.  Twisted pair is not an indispensable condition, it is just convenient to compare.  Using twisted pair, via CAN, like RS485, you can send messages from the controlling controller to the slave and get a response.  The similarity is striking, but let's better focus on the differences.  Some of the differences may carry a minus sign for some of the readers.  But I would advise them not to be upset, but to recall the law of Lomonosov. </p><br><p>  Thanks to the synchronous organization of the protocol, resolution of collisions on the bus is implemented by hardware, on the fly, so to speak.  The following points out what this leads to and what it gives the restless engineer. </p><br><p>  You can receive a message without asking. <br>  No need to wait until the answer is ready, you can ask someone else at this time. <br>  The slave controller can also ask and get an answer. <br>  Due to synchronous operation, the CAN bus length is inversely proportional to the transmission speed or the like. <br>  The maximum speed is 1 Mbaud (10 - on the way). <br>  The fact that the message was not corrupted during transmission, the sender knows immediately after the last bit.  More precisely, everyone knows this on the bus. <br>  If the message is corrupted for one, the attempt is not counted by all. <br>  If the message was able to pass to the bus, the subscriber will not receive it only on the condition that it is broken. <br>  The number of controllers on the bus should not exceed 127. </p><br><p>  Messages are limited in length.  They consist of an identifier, a length pointer in bytes and a data block with exactly as many bytes as indicated.  There are a few more service bits, but let's keep silent about them, as the service should be unobtrusive.  The identifier can be 11 or 29 bits.  The data block can contain from 0 to 8 bytes (64 is on the way). </p><br><p>  For specifics, here are a few numbers.  If you want to work at a speed of 1Mbaud, then the length of the tire should not be more than 35 meters (some prefer 40, that is, hotter).  If it is necessary to transmit something over a distance of 8 km, then the speed should not exceed 5 Kbaud.  By the way, the reader is entitled to ask why the kilobod, and not the kilobit?  Because not all baud become bits.  Something like this. </p><br><p>  How can you dispose of all these completely non-secret ingredients?  Those who see the game of cubes in everything will immediately remember that there is such a wonderful thing as CANopen and many more beautiful combinations and abbreviations and nothing to reinvent the wheel.  So I often want to answer: ‚ÄúDoesn‚Äôt the bicycle like two eggs that many cook for breakfast do not look like a bicycle?  Why not go to a public catering and not to take an omelet? ‚Äù.  But I'd rather not say anything and continue, without being distracted by shouts from the audience. </p><br><p>  At the time when the 29-bit identifier had not yet come up with, only 11-bit existed.  Some began to use it to push the name (number) of the desired type of data there.  Others used as the address of the controller being accessed.  Both made sense.  For example, you can ask: </p><br><ul><li>  And give us, my dear, chateau of the thirteenth year in a liter paper package. </li></ul><br><p>  Or so: </p><br><ul><li><p>  Wrap me, please, what is hidden on your bottom shelf to the right. <br>  By the way, such a construction can also work in CAN: </p><br></li><li><p> All lie!  And you quickly fold everything from the shelves into my bag. <br>  But you often don‚Äôt use this construction, because you‚Äôll have to wait some time afterwards. <br>  Wait until all the answers are lined up one by one and will not be available to the requesting controller.  We have already left the cinema, if that. <br>  In my case, I would accept an identifier variant as an address.  Of the 11 bits, 7 were required, and another 4 remained to make some messages more urgent than others, and also to mark some of the controllers as main ones. <br>  Some inconvenience migrated here from RS485, namely, the addresses had to be set manually on each controller.  Then check and reinstall.  And, perhaps, go back to the previous step and repeat. <br>  Fortunately, by that time two circumstances already existed. </p><br></li></ul><br><p>  First, a 29 bit identifier has already appeared.  And the second is that many manufacturers of microcontrollers began to consider it a good condition for each chip to have its own unique and rather long number. </p><br><p>  Now, in the long identifier, 24 bits could be boldly allocated for a unique address.  Another 5 remained, to ensure that trains differed in urgency, direction (there, back), the presence of the dining car and cars with increased comfort. </p><br><p>  If you stop fooling around and become serious, call the subordinate controllers agents, and the rest bosses, then you can make a table.  It will be shown later. </p><br><p>  A little more about addressing.  The unique number of the chip, as a rule, occupies the number of bits considerably exceeding 24, for example, 96 in STM32FXXX.  Therefore, you need to somehow get 24 out of 96. I chose the XOR operation.  You can choose something else, but a small problem will remain.  These are address matches after reduction. </p><br><p>  The likelihood of this problem is extremely small, but it is.  It is solved, but adds work to the service men.  Here we must remember that CAN messages may not contain data at all.  This is what we need when deciding.  It consists of the following actions. </p><br><p>  The managing controller (boss) sends a broadcast request to which all agents must respond (this is a request with a zero address).  Response messages with zero data length and matching addresses will not spoil each other, but will reach the boss as one. </p><br><p>  Now it remains to calculate how many responses are received and how many should be.  If these two numbers are the same, then everything is in order.  If there are fewer answers than controllers, then there is a coincidence of addresses and service engineers have a job.  And if there are more answers than controllers, then you need to think about a thesis, since you are on the verge of discovery. </p><br><p>  If the change in the length of a message is considered as some variations of its meaning, then you can get additional features, which I will tell you later if mom does not call for food. </p><br><p>  Even from the interesting, if you use both short and long identifiers at the same time, you can get, for example, group addressing or partially broadcast requests.  But we will not go deep yet. </p><br><p>  Let's return to coding of the identifier. </p><br><p>  For addressing purposes, 24 bits are allocated in the extended identifier, and six in the standard one.  An address with a value of 0x000000 is a broadcast for the extended identifier.  For a standard identifier, a zero address (6 bits) is also considered a broadcast.  The five leading (most significant) bits in the long and short identifier, called the header, affect the meaning of the message and are denoted by the letters NVADR: </p><br><p><img src="https://habrastorage.org/webt/5a/ir/yt/5airytjd4ojg3bn15xhoh9qo5jw.jpeg"></p><br><p>  Of course, for the dispatch board it was necessary to implement only a part of this scheme.  In the first project with a shield (or on a shield, how correctly?), Cortex chips from NXP were used, and in the following projects (there were such ones) M0 from STMicroelectronics was already used. </p><br><p>  A few words about the use of short identifiers.  Those six bits that are assigned for addressing address not the controller, but the group.  At start, this group is initially zero for everyone.  Next, the agents are configured, after which some or all of them become owned by their group.  Now by a request to the group, we get the answers of those agents that we have collected in this group. </p><br><p>  Now, a little about what is added, if we interpret messages with different lengths of data in different ways.  For example, a query with a zero length is good at debugging, as mentioned above.  A request with a length of 3 serves the space of byte variables of size 16384. A request with a length of 4 does the same, but is intended for a gateway agent that serves a second level CAN bus.  This tire may consist of one or two agents, but remote for a couple of kilometers. </p><br><p>  A query with a length of 5 and 6, similarly, is intended for a two-byte variable space of size 4194304. Two bits are not used for addressing.  One bit controls write-read.  Another signals an error. </p><br><p>  Next, 7 and 8 serve four byte words.  They are also 4194304. </p><br><p>  These spaces are common to all agents.  Each of them, depending on the destination, uses only a segment of the space of variables.  The controller for measuring the temperature at two points is shown in the photo.  This is for debugging and testing. </p><br><p><img src="https://habrastorage.org/webt/eq/tc/8z/eqtc8z-q-gmhha4cyzqqceqdtjc.jpeg"></p><br><p>  Controllers are connected by a flat cable for 6 cores.  On food are doubled.  The twenty-foot chip is STM32F042. </p><br><p>  On the reverse side, there is a MAX3051, a CAN driver in the SOT23-8 package. <br>  Well, my mother is calling for food. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/455620/">https://habr.com/ru/post/455620/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455610/index.html">Legendary Intel Core i7-2600K: Sandy Bridge Testing in 2019 (Part 1)</a></li>
<li><a href="../455612/index.html">We think over characters of games and dialogues on the advice of writers and on the example of supporters of the theory of a flat Earth</a></li>
<li><a href="../455616/index.html">Why go to the "Industrial Programming" in the Petersburg HSE?</a></li>
<li><a href="../455618/index.html">DevOps LEGO: how we layered pipelines</a></li>
<li><a href="../45562/index.html">For the first time in history, the turnover of online stores has decreased</a></li>
<li><a href="../455622/index.html">Legendary Intel Core i7-2600K: Sandy Bridge Testing in 2019 (Part 2)</a></li>
<li><a href="../455624/index.html">Hyper-kazualki and what game designers can learn from them</a></li>
<li><a href="../455626/index.html">Wallarm Offzone2019 HackQuest</a></li>
<li><a href="../45563/index.html">Internet business vs crisis. Who will win?</a></li>
<li><a href="../455630/index.html">Digital events in Moscow from 11 to 16 June</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>