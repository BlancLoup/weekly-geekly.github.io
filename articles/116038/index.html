<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ICQ bug informer for PHP + ActiveMQ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am the developer and caretaker of a fairly large system of online booking of one of the Moscow tour operators. Since this system has very high requi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ICQ bug informer for PHP + ActiveMQ</h1><div class="post__text post__text-html js-mediator-article">  I am the developer and caretaker of a fairly large system of online booking of one of the Moscow tour operators.  Since this system has very high requirements in terms of reliability and security, I have to keep track of all the errors that occur in it, but to constantly go in and see if there are any new reports is not very convenient and therefore I need some kind of instant notification tool, and it should support the ability to send messages from both the web part and desktop applications. <br><br>  In this article I want to talk about my experience in writing a script for instant notification of errors in the system through ICQ messages.  The ActiveMQ message broker is used as an intermediate link and report accumulator; I will tell you how to install and configure it to work with MySQL.  The main part is an ICQ-bot written in PHP, its duties include listening to a specific channel in the broker and sending messages to the specified ICQ numbers.  I will also tell you how to run this PHP script as a Windows service. <br><a name="habracut"></a><br><br>  The operation of this system is as follows: when an error occurs, an application (web or desktop) generates an XML message containing a brief description of the error and the recipient's ICQ number.  This message is sent via the STOMP protocol to the ActiveMQ broker and enters the queue.  At the other end of the world, or on the same machine, there is an ICQ bot, which listens to this queue and, if it receives a message, immediately sends it to the specified address.  And now in the details. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Install and configure ActiveMQ </h4><br>  All programs will be installed under Windows.  A few words about ActiceMQ itself, it is a message broker, in which there are 2 basic concepts: queues and topics (Topic). <br>  <b>Topic is</b> designed to notify a large number of subscribers about any event, such as news or the release of the next patch. <br>  <b>Queue</b> is a queue of tasks, several listeners can subscribe to it, but any message will be received by only one of the subscribers, this is exactly what suits us. <br><br>  First, download the <a href="">distribution kit</a> .  Installation is reduced to unpacking the archive into some distant folder.  For convenience, install it as a Windows service, for this you need to run the ActiveMQ script \ bin \ win32 \ InstallService.bat, the presence of the installed JAVA machine is assumed by itself. <br>  You can check the operation via ‚ÄúAdministration‚Äù -&gt; ‚ÄúServices‚Äù, but just wait 10 seconds after launch and update the list, on Win 2003 server I had a problem: the service seemed to start, but immediately fell, a long digging in logs and Google led to a simple solution is to create a work folder in the ActiveMQ \ bin \ win32 directory. <br><br>  To configure ActiveMQ, you must open the file \ conf \ activemq.xml <br>  We describe our broker: <br> <code><a href="http://activemq.apache.org/schema/core%2522"></a> <font color="#009900"><font color="#000000">&lt;broker</font> <font color="#000066">xmlns</font> = <font color="#ff0000">"activemq.apache.org/schema/core"</font> <font color="#000066">brokerName</font> = <font color="#ff0000">"localhost"</font> <font color="#000066">dataDirectory</font> = <font color="#ff0000">"${activemq.base}/data"</font> <font color="#000066">destroyApplicationContextOnStop</font> = <font color="#ff0000">"true"</font> <font color="#000066">persistent</font> = <font color="#ff0000">"true"</font> <font color="#000066">useShutdownHook</font> = <font color="#ff0000">"false"</font> <font color="#000000">&gt;</font></font></code> <blockquote> <code><font color="#009900"><a href="http://activemq.apache.org/schema/core%2522"></a> <font color="#000000">&lt;broker</font> <font color="#000066">xmlns</font> = <font color="#ff0000">"activemq.apache.org/schema/core"</font> <font color="#000066">brokerName</font> = <font color="#ff0000">"localhost"</font> <font color="#000066">dataDirectory</font> = <font color="#ff0000">"${activemq.base}/data"</font> <font color="#000066">destroyApplicationContextOnStop</font> = <font color="#ff0000">"true"</font> <font color="#000066">persistent</font> = <font color="#ff0000">"true"</font> <font color="#000066">useShutdownHook</font> = <font color="#ff0000">"false"</font> <font color="#000000">&gt;</font></font></code> </blockquote> <br>  Pay attention to the persistent parameter, it is responsible for the fact that all your messages will be stored in the database and will not be lost after the service is restarted.  Whether you have to decide it yourself or not, I have connected this function, and I reconfigured it with built-in kahaDB to a more understandable and transparent MySQL.  This is done as follows: <br>  Download the <a href="http://dev.mysql.com/downloads/connector/j">connector for Java</a> , take mysql-connector-java-5.1.14-bin.jar from it and drop it into the \ lib folder.  In MySQL itself, we create a database called activemq, for it we will create an activemq user with the same password.  We describe it all in the config: <br><blockquote> <code><font color="#009900"><font color="#000000">&lt;persistenceAdapter <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;jdbcPersistenceAdapter</font> <font color="#000066">dataSource</font> = <font color="#ff0000">"#mysql-ds"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;/persistenceAdapter <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;bean</font> <font color="#000066">id</font> = <font color="#ff0000">"mysql-ds"</font> <font color="#000066">class</font> = <font color="#ff0000">"org.apache.commons.dbcp.BasicDataSource"</font> <font color="#000066">destroy-method</font> = <font color="#ff0000">"close"</font> <font color="#000000">&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;property</font> <font color="#000066">name</font> = <font color="#ff0000">"driverClassName"</font> <font color="#000066">value</font> = <font color="#ff0000">"com.mysql.jdbc.Driver"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;property</font> <font color="#000066">name</font> = <font color="#ff0000">"url"</font> <font color="#000066">value</font> = <font color="#ff0000">"jdbc:mysql://localhost/activemq?relaxAutoCommit=true"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;property</font> <font color="#000066">name</font> = <font color="#ff0000">"username"</font> <font color="#000066">value</font> = <font color="#ff0000">"activemq"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;property</font> <font color="#000066">name</font> = <font color="#ff0000">"password"</font> <font color="#000066">value</font> = <font color="#ff0000">"activemq"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;property</font> <font color="#000066">name</font> = <font color="#ff0000">"poolPreparedStatements"</font> <font color="#000066">value</font> = <font color="#ff0000">"true"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;/bean <font color="#000000">&gt;</font></font></font></code> </blockquote> <br>  The block must be located outside the tag.  After restarting the service, 3 tables will have to be created in the database, if it happened, then everything was done correctly. <br><br>  Go ahead to configure, configure the possible connections: <br><blockquote> <code><font color="#009900"><font color="#000000">&lt;transportConnectors <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;transportConnector</font> <font color="#000066">name</font> = <font color="#ff0000">"openwire"</font> <font color="#000066">uri</font> = <font color="#ff0000">"tcp://0.0.0.0:61616"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;transportConnector</font> <font color="#000066">name</font> = <font color="#ff0000">"openwire2"</font> <font color="#000066">uri</font> = <font color="#ff0000">"stomp://0.0.0.0:61613"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;/transportConnectors <font color="#000000">&gt;</font></font></font></code> </blockquote>  Here I asked 2 different connections for different protocols, this is due to the fact that I use the STOMP library to connect to PHP, and under Delphi I managed to find a component that works steadily over TCP. <br><br>  Next, let's do authorization, add the following piece to the block: <br><blockquote> <code><font color="#009900"><font color="#000000">&lt;plugins <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;jaasAuthenticationPlugin</font> <font color="#000066">configuration</font> = <font color="#ff0000">"activemq-domain"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;authorizationPlugin <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;map <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;authorizationMap <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;authorizationEntries <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;authorizationEntry</font> <font color="#000066">queue</font> = <font color="#ff0000">"&gt;"</font> <font color="#000066">read</font> = <font color="#ff0000">"admins"</font> <font color="#000066">write</font> = <font color="#ff0000">"admins"</font> <font color="#000066">admin</font> = <font color="#ff0000">"admins"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;authorizationEntry</font> <font color="#000066">queue</font> = <font color="#ff0000">"icq.&gt;"</font> <font color="#000066">read</font> = <font color="#ff0000">"users"</font> <font color="#000066">write</font> = <font color="#ff0000">"users"</font> <font color="#000066">admin</font> = <font color="#ff0000">"admins"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;authorizationEntry</font> <font color="#000066">topic</font> = <font color="#ff0000">"ActiveMQ.Advisory.&gt;"</font> <font color="#000066">read</font> = <font color="#ff0000">"guests,users"</font> <font color="#000066">write</font> = <font color="#ff0000">"guests,users"</font> <font color="#000066">admin</font> = <font color="#ff0000">"guests,users"</font> <font color="#000000">/&gt;</font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;/authorizationEntries <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;/authorizationMap <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;/map <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;/authorizationPlugin <font color="#000000">&gt;</font></font></font> &lt;br/&gt; <br> <font color="#009900"><font color="#000000">&lt;/plugins <font color="#000000">&gt;</font></font></font></code> </blockquote> <br>  Now create the groups.properties file in the / conf folder with the following contents: <blockquote> <code>admins=system,sslclient,client,broker1,broker2 <br> users=icq <br> guests=guest <br></code> </blockquote><br>  In the same place, create the users.properties file and enter it into it: <blockquote> <code>system=password <br> icq=secret</code> </blockquote>  You will also need a login.config file, it is easier to <a href="http://narod.ru/disk/7767835001/amq_conf.zip.html">download it</a> entirely and drop it into the / conf folder.  After all the settings, restart the service and go to the address <a href="http://localhost:8161/admin/">http: // localhost: 8161 / admin /</a> , if everything is done correctly, you will be met by the control panel, if so, go to Queues and create a queue called icq. <br><br><h4>  ICQ bot script </h4><br>  I took <a href="http://wip.asminog.com/workshop/webicqpro/webicqpro.html">the WebIcqPro library as the</a> basis of the bot, it is fairly simple and stable.  You will also need a library to send messages to the broker, I found a quite stable <a href="http://svn.stomp.codehaus.org/browse/stomp/trunk/php/Stomp.php">solution on the STOMP protocol</a> , but when the connection was broken, it knocked it out, so I had to modify it a bit to make it possible to reconnect.  I will not give here all the bot code, to whom it is really interesting you can download the <a href="http://narod.ru/disk/7767838001/icqbot.zip.html">archive.</a> <br><br>  To test the functionality, run the bot via the command line: <br>  <i>"C: \ Program Files \ PHP \ php" C: \ icqbot \ icq.php</i> <br>  If everything is in order with the settings, he should establish a connection with ActiveMQ and the ICQ server, and then start listening to the ‚Äú* Waiting for messages ...‚Äù channel.  To send a test message, you can use the send.php script from the archive: <br><blockquote> <code><font color="#000000">&lt;?php</font> &lt;br/&gt; <br> <font color="#b1b100">require_once</font> <font color="#0000ff">'Stomp.php'</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$c</font> <font color="#339933">=</font> <font color="#000000">new</font> StompConnection <font color="#009900">(</font> <font color="#0000ff">"localhost"</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$result</font> <font color="#339933">=</font> <font color="#000088">$c</font> <font color="#339933">-&gt;</font> <font color="#004000">connect</font> <font color="#009900">(</font> <font color="#0000ff">"icq"</font> <font color="#339933">,</font> <font color="#0000ff">"bot"</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#000088">$mess</font> <font color="#339933">=</font> <font color="#0000ff">'&lt;?xml version="1.0" encoding="windows-1251"?&gt;&lt;br/&gt; <br> &lt;reference&gt;&lt;br/&gt; <br> &lt;type&gt;send&lt;/type&gt;&lt;br/&gt; <br> &lt;to&gt;111111111&lt;/to&gt;&lt;br/&gt; <br> &lt;from&gt;Test send:&lt;/from&gt;&lt;br/&gt; <br> &lt;mes&gt;  message&lt;/mes&gt;&lt;br/&gt; <br> &lt;/reference&gt;'</font> <font color="#339933">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#000088">$mess</font> <font color="#339933">=</font> <font color="#990000">iconv</font> <font color="#009900">(</font> <font color="#0000ff">'cp1251'</font> <font color="#339933">,</font> <font color="#0000ff">'UTF-8'</font> <font color="#339933">,</font> <font color="#000088">$mess</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$c</font> <font color="#339933">-&gt;</font> <font color="#004000">send</font> <font color="#009900">(</font> <font color="#0000ff">"/queue/icq"</font> <font color="#339933">,</font> <font color="#000088">$mess</font> <font color="#339933">,</font> <font color="#990000">array</font> <font color="#009900">(</font> <font color="#0000ff">'persistent'</font> <font color="#339933">=&gt;</font> <font color="#0000ff">'true'</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$c</font> <font color="#339933">-&gt;</font> <font color="#004000">disconnect</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000000">?&gt;</font></code> </blockquote>  I had to mess around with encodings for quite a while so that I could send messages with Russian text, so don‚Äôt be surprised when you see cascading conversions to different encodings in scripts, otherwise it didn‚Äôt want to work.  After calling send.php, a message will be sent to the specified UIN and this fact will also be reflected in the logs. <br><br><h4>  Run the bot as a Windows service </h4><br>  For this we need a set of Windows NT Resource Kit, who do not have to <a href="http://www.microsoft.com/downloads/en/details.aspx%3FFamilyID%3D9d467a69-57ff-4ae7-96ee-b18c4790cffd%26displaylang%3Den">download</a> .  Suppose all the bot files we have are in the <i>C: \ icqbot folder</i> .  Open the console and write <br>  <i>‚ÄúC: \ Program Files \ Windows Resource Kits \ Instsrv.exe‚Äù ICQBot ‚ÄúC: \ Program Files \ Windows Resource Kits \ Srvany.exe‚Äù</i> <br>  Next, run regedit and go to the <i>HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Services \ ICQBot section</i> inside it create the <i>Parameters</i> section and in it the Application parameter type REG_SZ with the value <i>"C: \ Program Files \ PHP \ php.exe" C: \ icqbot \ icq. php</i> <br>  Next, go to the service and run our bot from there, now it is completely autonomous. <br><br><h4>  Error catcher for the site </h4><br>  Our ultimate goal is to catch all the errors, make a detailed report and send a notification about this to ICQ.  Thus, it remains to describe only the script for catching these errors, for me it looks like this and is connected to all scripts where control is required: <br><blockquote> <code><font color="#000000">&lt;?php</font> &lt;br/&gt; <br> <font color="#990000">ini_set</font> <font color="#009900">(</font> <font color="#0000ff">'display_errors'</font> <font color="#339933">,</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#990000">error_reporting</font> <font color="#009900">(</font> <font color="#cc66cc">2</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$send_report</font> <font color="#009900">)</font> <font color="#009900">{</font> &lt;br/&gt; <br> <font color="#b1b100">include_once</font> <font color="#009900">(</font> <font color="#0000ff">"Stomp.php"</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#000000">function</font> send_report <font color="#009900">(</font> <font color="#000088">$message</font> <font color="#339933">,</font> <font color="#000088">$to</font> <font color="#339933">=</font> <font color="#0000ff">'1212312'</font> <font color="#339933">,</font> <font color="#000088">$from</font> <font color="#339933">=</font> <font color="#0000ff">'SENDER'</font> <font color="#009900">)</font> <font color="#009900">{</font> &lt;br/&gt; <br> <font color="#000000">global</font> <font color="#000088">$send_report</font> <font color="#339933">,</font> <font color="#000088">$stomp_server</font> <font color="#339933">,</font> <font color="#000088">$stomp_url</font> <font color="#339933">,</font> <font color="#000088">$stomp_user</font> <font color="#339933">,</font> <font color="#000088">$stomp_psw</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#000088">$send_report</font> <font color="#009900">)</font> <font color="#b1b100">return</font> <font color="#009900">false</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$c</font> <font color="#339933">=</font> <font color="#000000">new</font> StompConnection <font color="#009900">(</font> <font color="#000088">$stomp_server</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$result</font> <font color="#339933">=</font> <font color="#000088">$c</font> <font color="#339933">-&gt;</font> <font color="#004000">connect</font> <font color="#009900">(</font> <font color="#000088">$stomp_user</font> <font color="#339933">,</font> <font color="#000088">$stomp_psw</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#990000">is_array</font> <font color="#009900">(</font> <font color="#000088">$to</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#000088">$to</font> <font color="#339933">=</font> <font color="#990000">array</font> <font color="#009900">(</font> <font color="#000088">$to</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#000088">$to</font> <font color="#b1b100">as</font> <font color="#000088">$i</font> <font color="#009900">)</font> <font color="#009900">{</font> &lt;br/&gt; <br> <font color="#000088">$mess</font> <font color="#339933">=</font> <font color="#0000ff">'&lt;?xml version="1.0" encoding="windows-1251"?&gt;&lt;br/&gt; <br> &lt;reference&gt;&lt;br/&gt; <br> &lt;type&gt;send&lt;/type&gt;&lt;br/&gt; <br> &lt;to&gt;'</font> <font color="#339933">.</font> <font color="#000088">$i</font> <font color="#339933">.</font> <font color="#0000ff">'&lt;/to&gt;&lt;br/&gt; <br> &lt;from&gt;'</font> <font color="#339933">.</font> <font color="#000088">$from</font> <font color="#339933">.</font> <font color="#0000ff">'&lt;/from&gt;&lt;br/&gt; <br> &lt;mes&gt;'</font> <font color="#339933">.</font> <font color="#000088">$message</font> <font color="#339933">.</font> <font color="#0000ff">'&lt;/mes&gt;&lt;br/&gt; <br> &lt;/reference&gt;'</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$c</font> <font color="#339933">-&gt;</font> <font color="#004000">send</font> <font color="#009900">(</font> <font color="#000088">$stomp_url</font> <font color="#339933">,</font> <font color="#990000">iconv</font> <font color="#009900">(</font> <font color="#0000ff">'cp1251'</font> <font color="#339933">,</font> <font color="#0000ff">'UTF-8'</font> <font color="#339933">,</font> <font color="#000088">$mess</font> <font color="#009900">)</font> <font color="#339933">,</font> <font color="#990000">array</font> <font color="#009900">(</font> <font color="#0000ff">'persistent'</font> <font color="#339933">=&gt;</font> <font color="#0000ff">'true'</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#009900">}</font> &lt;br/&gt; <br> <font color="#000088">$c</font> <font color="#339933">-&gt;</font> <font color="#004000">disconnect</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#009900">}</font> &lt;br/&gt; <br> <font color="#009900">}</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#000000">function</font> user_log <font color="#009900">(</font> <font color="#000088">$errno</font> <font color="#339933">,</font> <font color="#000088">$errmsg</font> <font color="#339933">,</font> <font color="#000088">$file</font> <font color="#339933">,</font> <font color="#000088">$line</font> <font color="#009900">)</font> <font color="#009900">{</font> &lt;br/&gt; <br> <font color="#000000">global</font> <font color="#000088">$send_report</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$errno</font> <font color="#339933">==</font> <font color="#cc66cc">2</font> <font color="#009900">)</font> <font color="#009900">{</font> &lt;br/&gt; <br> <font color="#000088">$filename</font> <font color="#339933">=</font> <font color="#990000">strftime</font> <font color="#009900">(</font> <font color="#0000ff">'%d.%m.%Y %H-%M-%S_'</font> <font color="#009900">)</font> <font color="#339933">.</font> <font color="#000088">$_REQUEST</font> <font color="#009900">[</font> <font color="#0000ff">'PHPSESSID'</font> <font color="#009900">]</font> <font color="#339933">.</font> <font color="#0000ff">'.err'</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$fl</font> <font color="#339933">=</font> <font color="#990000">fopen</font> <font color="#009900">(</font> <font color="#0000ff">'errors/'</font> <font color="#339933">.</font> <font color="#000088">$filename</font> <font color="#339933">,</font> <font color="#0000ff">'w'</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$_SESSION</font> <font color="#009900">[</font> <font color="#0000ff">'ERROR_TEXT'</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#0000ff">'WARNING: '</font> <font color="#339933">.</font> <font color="#000088">$errmsg</font> <font color="#339933">.</font> <font color="#0000ff">' in '</font> <font color="#339933">.</font> <font color="#000088">$file</font> <font color="#339933">.</font> <font color="#0000ff">' on line '</font> <font color="#339933">.</font> <font color="#000088">$line</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$_SESSION</font> <font color="#009900">[</font> <font color="#0000ff">'ERROR_TIME'</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#990000">strftime</font> <font color="#009900">(</font> <font color="#0000ff">'%d.%m.%Y %H-%M-%S'</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$_SESSION</font> <font color="#009900">[</font> <font color="#0000ff">'ERROR_PHPSESSID'</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#000088">$_REQUEST</font> <font color="#009900">[</font> <font color="#0000ff">'PHPSESSID'</font> <font color="#009900">]</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000088">$_SESSION</font> <font color="#009900">[</font> <font color="#0000ff">'ERROR_TYPE'</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#0000ff">'PHP SCRIPT ERROR'</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#990000">fwrite</font> <font color="#009900">(</font> <font color="#000088">$fl</font> <font color="#339933">,</font> <font color="#990000">serialize</font> <font color="#009900">(</font> <font color="#000088">$_SESSION</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#990000">fclose</font> <font color="#009900">(</font> <font color="#000088">$fl</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$send_report</font> <font color="#009900">)</font> send_report <font color="#009900">(</font> <font color="#000088">$_SESSION</font> <font color="#009900">[</font> <font color="#0000ff">'ERROR_TEXT'</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#009900">}</font> &lt;br/&gt; <br> <font color="#009900">}</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#990000">set_error_handler</font> <font color="#009900">(</font> <font color="#0000ff">'user_log'</font> <font color="#009900">)</font> <font color="#339933">;</font> &lt;br/&gt; <br> <font color="#000000">?&gt;</font></code> </blockquote>  For understandable causal reasons, I crypt the entire contents of these reports, which I advise everyone to do. <br><br>  Thus, a fairly stable, simple and universal notification scheme was obtained, allowing you to send messages to ICQ from any application in any language, if one of the <a href="http://activemq.apache.org/connectivity.html">protocols for interacting</a> with ActiveMQ is described for it. <br><br><h5>  List of used files </h5><ol><li>  <a href="">ActiveMQ 5.4.2</a> </li><li>  <a href="http://narod.ru/disk/7767835001/amq_conf.zip.html">Configs for ActiveMQ</a> </li><li>  <a href="http://dev.mysql.com/downloads/connector/j">MySQL Connector</a> </li><li>  <a href="http://wip.asminog.com/workshop/webicqpro/webicqpro.html">WebICQPro library</a> for PHP </li><li>  <a href="http://svn.stomp.codehaus.org/browse/stomp/trunk/php/Stomp.php">STOMP library</a> for PHP </li><li>  <a href="http://narod.ru/disk/7767838001/icqbot.zip.html">A complete set of bot scripts and error interceptor</a> </li><li>  <a href="http://www.microsoft.com/downloads/en/details.aspx%3FFamilyID%3D9d467a69-57ff-4ae7-96ee-b18c4790cffd%26displaylang%3Den">Windows NT Resource Kit</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/116038/">https://habr.com/ru/post/116038/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116030/index.html">What PHP framework do you use? And why?</a></li>
<li><a href="../116031/index.html">Great themes for ADW Launcher, Go Launcher EX, MIUI ROM</a></li>
<li><a href="../116033/index.html">Django 1.3 release</a></li>
<li><a href="../116034/index.html">How to create your website from scratch using Orchard CMS. Part 1. Introduction to Orchard CMS (continued)</a></li>
<li><a href="../116035/index.html">Work with Google Fusion Tables - JS and PHP</a></li>
<li><a href="../116040/index.html">Facebook Places in Russia</a></li>
<li><a href="../116042/index.html">The combination of visual information flows on the example of YouTube</a></li>
<li><a href="../116043/index.html">Snappy (zippy), a data compression library from Bigtable</a></li>
<li><a href="../116044/index.html">Google has new problems with the book digitization project.</a></li>
<li><a href="../116045/index.html">Video review reader Barnes & Noble Nook Color</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>