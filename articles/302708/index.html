<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking the source code of 7-Zip with PVS-Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the programs that allows you to solve the problem of data compression is the popular file archiver 7-Zip, and I myself often use it. Readers ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking the source code of 7-Zip with PVS-Studio</h1><div class="post__text post__text-html js-mediator-article">  One of the programs that allows you to solve the problem of data compression is the popular file archiver 7-Zip, and I myself often use it.  Readers have long turned to us with a request to check the code of this application.  Well, it's time to look at its sources and see what PVS-Studio can find interesting. <br><br><img src="https://habrastorage.org/files/feb/328/b1f/feb328b1f6984c91b71b711b481a9c9d.png"><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Introduction </h2><br>  A few words about the project.  7-Zip is a free file archiver with a high degree of data compression, written in C and C ++.  It has a small size of 235 thousand lines of code.  It supports multiple compression algorithms and a variety of data formats, including the proprietary 7z format with the highly efficient LZMA compression algorithm.  The program has been developed since 1999, it is free and has open source code.  7-Zip is the winner of the 2007 SourceForge.net Community Choice Awards in the "Best Project" and "Best Technical Design" categories.  Version 16.00 was chosen for verification, the source code of which was downloaded from <a href="http://www.7-zip.org/download.html">http://www.7-zip.org/download.html</a> <br><br><h2>  Test results </h2><br>  To check the 7-Zip code, the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> v6.04 static code analyzer was used.  For the article, the most interesting analyzer messages were selected and analyzed.  Let's take a look at them. <br><br><h3>  Typos in conditional statements </h3><br>  Typos in conditional statements are often found in programs.  In the case of a large number of checks, their detection can cause a lot of trouble.  In such cases, a static code analyzer comes to the rescue. <br><br>  I will give a few examples of this error. <br><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions "Id == k_PPC"  operator.  7zupdate.cpp 41 <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetDelta</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Id == k_IA64) Delta = <span class="hljs-number"><span class="hljs-number">16</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Id == k_ARM || Id == k_PPC || Id == k_PPC) <span class="hljs-comment"><span class="hljs-comment">//&lt;== Delta = 4; else if (Id == k_ARMT) Delta = 2; else Delta = 0; }</span></span></code> </pre> <br>  The analyzer detected the same conditional expression.  At best, one of the conditions <i>Id == k_PPC</i> is redundant and does not affect the logic of the program.  To correct a typo, you just need to remove this condition, then the correct expression will look like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Id == k_IA64) Delta = <span class="hljs-number"><span class="hljs-number">16</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Id == k_ARM || Id == k_PPC) Delta = <span class="hljs-number"><span class="hljs-number">4</span></span>;</code> </pre> <br>  But even more serious consequences of such a typo are possible, if instead of the <i>k_PPC</i> constant, in one of the recurring conditions, there must be another constant.  In this case, the logic of the program may be violated. <br>  Here is another example of a typo in a conditional statement: <br>  V501 There are identical to the left and the right of the | ||  operator: offs&gt; = nodeSize ||  offs&gt; = nodeSize hfshandler.cpp 915 <br><pre> <code class="cpp hljs">HRESULT CDatabase::LoadCatalog(....) { .... UInt32 nodeSize = (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; hr.NodeSizeLog); UInt32 offs = Get16(p + nodeOffset + nodeSize - (i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">2</span></span>); UInt32 offsNext = Get16(p + nodeOffset + nodeSize - (i + <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">2</span></span>); UInt32 recSize = offsNext - offs; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (offs &gt;= nodeSize || offs &gt;= nodeSize <span class="hljs-comment"><span class="hljs-comment">//&lt;== || offsNext &lt; offs || recSize &lt; 6) return S_FALSE; .... }</span></span></code> </pre> <br>  Here the problem is in the repeated condition <i>offs&gt; = nodeSize</i> . <br><br>  Most likely, these typos were obtained when using Copy-Paste to duplicate the code.  It makes no sense to urge to abandon copying code sections  This is too convenient and useful to deprive yourself of such functionality in the editor.  You just need to more carefully check the result. <br><br><h3>  Identical comparisons </h3><br>  The analyzer detected a potential error in a construct consisting of conditional operators.  Here is her example: <br><br>  <a href="http://www.viva64.com/ru/d/0106/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 388, 390. archivecommandline.cpp 388 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddRenamePair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., NRecursedType::EEnum type, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type == NRecursedType::kRecursed) val.AddAscii(<span class="hljs-string"><span class="hljs-string">"-r"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type == NRecursedType::kRecursed) <span class="hljs-comment"><span class="hljs-comment">//&lt;== val.AddAscii("-r0"); .... }</span></span></code> </pre> <br>  In the code <i>NRecursedType</i> is defined as follows: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> NRecursedType { <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> EEnum { kRecursed, kWildcardOnlyRecursed, kNonRecursed }; }</code> </pre> <br>  It turns out that the second condition will never be fulfilled.  Let's try to understand this problem in more detail.  Based on the description of the command line parameters, the <i>-r</i> parameter indicates the use of recursion for subdirectories.  In the case of the <i>-r0</i> parameter <i>,</i> recursion is used only for wildcard names.  Comparing this with the definition of <i>NRecursedType,</i> we can conclude that in the second case the type <i>NRecursedType :: kWildcardOnlyRecursed</i> should be used <i>.</i>  Then the correct code will look like this: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddRenamePair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., NRecursedType::EEnum type, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type == NRecursedType::kRecursed) val.AddAscii(<span class="hljs-string"><span class="hljs-string">"-r"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type == NRecursedType::kWildcardOnlyRecursed) <span class="hljs-comment"><span class="hljs-comment">//&lt;== val.AddAscii("-r0"); .... }</span></span></code> </pre> <br><h3>  Conditions that are always true or false </h3><br>  It is necessary to closely monitor whether you work with a signed or unsigned type.  Ignoring these features can lead to unpleasant consequences. <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'newSize &lt;0' is always false.  Unsigned type value is never &lt;0. update.cpp 254 <br><br>  This is a sample code from a program in which this language feature was ignored: <br><pre> <code class="cpp hljs">STDMETHODIMP COutMultiVolStream::SetSize(UInt64 newSize) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newSize &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//&lt;== return E_INVALIDARG; .... }</span></span></code> </pre> <br>  The problem is that <i>newSize</i> is unsigned and the condition will never be met.  If a negative value is passed to the <i>SetSize</i> function, this error will be ignored and the function will start using the incorrect size.  In 7-Zip, there are 2 more conditions that, due to the confusion with signed / unsigned, are always true or always false. <ul><li>  V547 Expression 'rec. SiAttr.SecurityId&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. ntfshandler.cpp 2142 </li><li>  V547 Expression 's .Len ()&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. xarhandler.cpp 258 </li></ul><br><h3>  The same condition is checked twice. </h3><br>  The analyzer has detected a potential error related to the fact that the same condition is checked twice. <br><br>  <a href="http://www.viva64.com/ru/d/0169/">V571</a> Recurring check.  The 'if (Result! = ((HRESULT) 0L))' condition was already verified in line 56. extractengine.cpp 58 <br><br>  This is how the program code fragment looks <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Result != S_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Result != S_OK) <span class="hljs-comment"><span class="hljs-comment">//&lt;== ErrorMessage = kCantOpenArchive; return; } .... }</span></span></code> </pre> <br>  Most likely, in this situation, the second check is simply redundant, but a situation is also possible in which the programmer did not change the second condition after copying, and it turned out to be erroneous. <br><br>  Similar places in 7-Zip code: <ul><li>  V571 Recurring check.  The '! QuoteMode' condition was already verified in line 18. stringutils.cpp 20 </li><li>  V571 Recurring check.  The 'IsVarStr (params [1], 22)' condition was already verified in line 3377. nsisin.cpp 3381 </li></ul><br><h3>  Suspicious pointer handling </h3><br>  It occurs in the code 7-Zip and an error, when the pointer is dereferenced at the beginning, and only then is checked for equality to zero. <br><br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The 'outStreamSpec' pointer was used before it was verified against nullptr.  Check lines: 753, 755. lzmaalone.cpp 753. <br><br>  This is a very <a href="http://www.viva64.com/ru/examples/V595/">common mistake</a> in all programs.  It usually occurs because of inattention in the process of refactoring code.  A null pointer reference will result in undefined program behavior.  Consider an application code fragment containing an error of this type: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *args[])</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stdOutMode) Print_Size(<span class="hljs-string"><span class="hljs-string">"Output size: "</span></span>, outStreamSpec-&gt;ProcessedSize); <span class="hljs-comment"><span class="hljs-comment">//&lt;== if (outStreamSpec) //&lt;== { if (outStreamSpec-&gt;Close() != S_OK) throw "File closing error"; } .... }</span></span></code> </pre> <br>  The <i>outStreamSpec</i> pointer <i>is</i> dereferenceed in the <i>outStreamSpec-&gt; ProcessedSize</i> expression.  Then it is checked for equality to zero.  One must either check the pointer even higher or the check that occurs below is meaningless.  Here is a list of similar potential problem areas in the program code: <ul><li>  V595 The '_file' pointer was used before it was verified against nullptr.  Check lines: 2099, 2112. bench.cpp 2099 </li><li>  V595 'a a pointer pointer pointer  Check lines: 204, 214. updatepair.cpp 204 </li><li>  V595 'options ‚Äôpointer  Check lines: 631, 636. zipupdate.cpp 631 </li><li>  V595 The 'volStreamSpec' pointer was used before it was verified against nullptr.  Check lines: 856, 863. update.cpp 856 </li></ul><br><h3>  Exception inside destructor </h3><br>  If an exception occurs in the program, the stack collapses, during which objects are destroyed by calling destructors.  If the destructor of the object being destroyed when the stack collapses throws another exception and this exception leaves the destructor, the C ++ library immediately terminates the program by calling the <i>terminate ()</i> function.  It follows from this that destructors should never propagate exceptions.  The exception thrown inside the destructor must be processed inside the same destructor. <br><br>  The analyzer issued the following message: <br><br>  <a href="http://www.viva64.com/ru/d/0098/">V509</a> The 'throw' operator inside the destructor should be placed within the try..catch block.  Raising exception inside the destructor is illegal.  consoleclose.cpp 62 <br><br>  And here's what the destructor for generating an exception looks like: <br><pre> <code class="cpp hljs">CCtrlHandlerSetter::~CCtrlHandlerSetter() { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> !defined(UNDER_CE) &amp;&amp; defined(_WIN32) </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!SetConsoleCtrlHandler(HandlerRoutine, FALSE)) throw </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SetConsoleCtrlHandler fails"</span></span></span><span class="hljs-meta">; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//&lt;== #endif }</span></span></span></span></code> </pre> <br>  The V509 message warns that if the CCtrlHandlerSetter object is destroyed during exception handling, then a new exception will immediately crash the program.  This code should be rewritten in such a way as to report an error that occurred in the destructor, without using the exception mechanism.  If the error is not critical, then it can be ignored. <br><pre> <code class="cpp hljs">CCtrlHandlerSetter::~CCtrlHandlerSetter() { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> !defined(UNDER_CE) &amp;&amp; defined(_WIN32) try { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!SetConsoleCtrlHandler(HandlerRoutine, FALSE)) throw </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SetConsoleCtrlHandler fails"</span></span></span><span class="hljs-meta">; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//&lt;== } catch(...) { assert(false); } #endif }</span></span></span></span></code> </pre> <br><h3>  Bool variable increment </h3><br>  Historically, for variables of type <i>bool an</i> increment operation is allowed, it sets the variable to <i>true</i> .  This feature is related to the fact that earlier integer values ‚Äã‚Äãwere used to represent Boolean variables.  Subsequently, this feature remained to support backward compatibility programs.  Starting with C ++ 98 standard, it is marked as <i>deprecated</i> and is not recommended for use.  In the upcoming standard C ++ 17, the ability to use an increment for a boolean variable is marked for deletion. <br><br>  In the 7-Zip code, a couple of places were found where this outdated feature is used. <ul><li>  <a href="http://www.viva64.com/ru/d/0143/">V552</a> A bool type variable is being incremented: numMethods ++.  Perhaps another variable should be incremented instead.  wimhandler.cpp 308 </li><li>  V552 A bool type variable is being incremented: numMethods ++.  Perhaps another variable should be incremented instead.  wimhandler.cpp 318 </li></ul><br><pre> <code class="cpp hljs">STDMETHODIMP CHandler::GetArchiveProperty(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> numMethods = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ARRAY_SIZE(k_Methods); i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodMask &amp; ((UInt32)<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; i)) { res.Add_Space_if_NotEmpty(); res += k_Methods[i]; numMethods++; <span class="hljs-comment"><span class="hljs-comment">//&lt;== } } if (methodUnknown != 0) { char temp[32]; ConvertUInt32ToString(methodUnknown, temp); res.Add_Space_if_NotEmpty(); res += temp; numMethods++; //&lt;== } if (numMethods == 1 &amp;&amp; chunkSizeBits != 0) { .... } .... }</span></span></code> </pre> <br>  In this situation, there are two options.  Or the variable <i>numMethods</i> is a flag and in this case it is better to use initialization with the Boolean value <i>numMethods = true</i> .  Or, judging by the name of the variable, it is a counter that must be an integer. <br><br><h3>  Check for failed memory allocation </h3><br>  The analyzer detected a situation when the value of the pointer returned by the <i>new</i> operator is compared with zero.  As a rule, this means that the program, if it is impossible to allocate memory, will behave differently than the programmer expects. <br><br>  <a href="http://www.viva64.com/ru/d/0293/">This</a> is a <a href="http://www.viva64.com/ru/d/0293/">plug-</a> in.  The exception will be generated in the case of memory allocation error.  far.cpp 399 <br><br>  Here is how it looks in the program code: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> HANDLE </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyOpenFilePluginW</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">wchar_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *name)</span></span></span><span class="hljs-function"> </span></span>{ .... CPlugin *plugin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CPlugin( fullName, <span class="hljs-comment"><span class="hljs-comment">// defaultName, agent, (const wchar_t *)archiveType ); if (!plugin) return INVALID_HANDLE_VALUE; .... }</span></span></code> </pre> <br>  If the <i>new</i> operator could not allocate memory, then, according to the C ++ standard of the language, an exception is generated <i>std :: bad_alloc ()</i> .  Thus, it does not make sense to check for equality to zero.  The plugin pointer will never be zero.  The function will never return the constant value <i>INVALID_HANDLE_VALUE</i> .  If it is impossible to allocate memory, an exception occurs that is better handled at a higher level, and the test for equality to zero can simply be removed.  Well, or if exceptions in the application are undesirable, then you can use the <i>new</i> operator that does not generate exceptions; in this case, you can check the return value to zero.  In the application code, there are 3 more such checks: <ul><li>  V668 using using _ _ allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated _ _  The exception will be generated in the case of memory allocation error.  enumformatetc.cpp 46 </li><li>  V668 has been defined as the ‚Äúm_States‚Äù  The exception will be generated in the case of memory allocation error.  bzip2decoder.cpp 445 </li><li>  V668 has been set using the 'new' operator.  The exception will be generated in the case of memory allocation error.  bzip2encoder.cpp 170 </li></ul><br><h3>  Constructions requiring optimization </h3><br>  Now a little about the places that can potentially be optimized.  An object is passed to the function.  This object is passed by value, but it is not modified, since there is a keyword <i>const</i> .  Perhaps it would be rational to pass it using a constant reference in C ++ or using a pointer in C. <br><br>  Here is an example for a vector: <br><br>  <a href="http://www.viva64.com/ru/d/0135/">V801</a> Decreased performance.  It is better to redefine it.  Consider replacing 'const ... pathParts' with 'const ... &amp; pathParts'.  wildcard.cpp 487 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNumPrefixParts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UStringVector pathParts)</span></span></span><span class="hljs-function"> </span></span>{ .... }</code> </pre> <br>  Calling this function will call the copy constructor for the <i>UStringVector</i> class.  If such copying of objects occurs frequently, then this can significantly reduce application performance.  This code can be easily optimized by adding a link: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNumPrefixParts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UStringVector&amp; pathParts)</span></span></span><span class="hljs-function"> </span></span>{ .... }</code> </pre> <br>  Here are some more similar places: <ul><li>  V801 Decreased performance.  It is better to redefine it.  Consider replacing 'const ... props' with 'const ... &amp; props'.  benchmarkdialog.cpp 766 </li><li>  V801 Instantiate CRecordVector &lt;CAttribIconPair&gt;: Decreased performance.  It is better to redefine it.  Consider replacing 'const ... item' with 'const ... &amp; item'.  yvector.h 199 </li></ul><br><h2>  Conclusion </h2><br>  7-Zip is a small project that has been developing for quite some time and, of course, failed to find a large number of serious errors.  But there are still places in the code that need attention and the PVS-Studio static code analyzer will greatly facilitate this work.  If you are developing a project in C, C ++ or C #, I suggest you to download PVS-Studio without delay and check your project: <a href="http://www.viva64.com/ru/pvs-studio-download/">http://www.viva64.com/ru/pvs-studio-download/</a> <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0402/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Kirill Yudintsev.  <a href="http://www.viva64.com/en/b/0402/">Checking 7-Zip with PVS-Studio analyzer</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/302708/">https://habr.com/ru/post/302708/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302698/index.html">On Amazon, there is a war of algorithms for the position of the "best" product</a></li>
<li><a href="../302700/index.html">Migrate users from Asterisk (FreePBX) to 3CX Phone System</a></li>
<li><a href="../302702/index.html">Recommended systems in online education</a></li>
<li><a href="../302704/index.html">Communication in programming - in a dream and in reality</a></li>
<li><a href="../302706/index.html">The difference in the use of indexes in the condition 'OR' databases Mysql and PostgeSQL</a></li>
<li><a href="../302710/index.html">My Circle Results Report for May 2016</a></li>
<li><a href="../302714/index.html">A free test drive of Cisco Aironet 1832 and 1852 access points will be held in Kiev</a></li>
<li><a href="../302716/index.html">Service "Case of the Day" and two new ratings on Ruvard</a></li>
<li><a href="../302718/index.html">Intel Tools for Video Codec Makers</a></li>
<li><a href="../302720/index.html">Installing the Carbon + Graphite + Grafana + Nginx + MySQL bundle to collect and display metrics in Ubuntu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>