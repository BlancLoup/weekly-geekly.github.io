<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ACM ICPC 2010 Unofficial Broadcast - How It Was</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A post based on the ACM ICPC 2010 finals last Friday, about how to literally raise the mirror of a dying page under a load on the knee, fasten a chat ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ACM ICPC 2010 Unofficial Broadcast - How It Was</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/b5c/b2e/4c3/b5cb2e4c3a2dd7d6002a28d6c37e0726.png">  A post based on the ACM ICPC 2010 finals last Friday, about how to literally raise the mirror of a dying page under a load on the knee, fasten a chat to it with its discussion, and do not bend over the load yourself :) <br><br>  The post will be more interesting to web programmers than to Olympiads. <br><br>  Some statistics, nginx configs, useful tricks, as well as a number of rakes, which should be well known to people with experience, but which many still often attack ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h2>  Prehistory </h2><br>  A couple of days ago, one of the main events of the year in sports programming took place, which has already been <a href="http://habrahabr.ru/blogs/sport_programming/83197/">written on Habr√©</a> . <br>  In narrow circles of fans of these competitions (these are several thousand people all over the world) there is a tradition: during the final for 5 hours, gather around the screens of monitors and follow the ‚Äúlive‚Äù table of results.  Interest is akin to that with which normal people watch World Cup footballs :) (which Russia, alas, did not make it, unlike). <br><br>  Unfortunately, the <a href="http://icpc2010.csc.kth.se/">official page</a> with the cherished tablet annually falls under Habr-, Topcoder- and other effects, and is not very readable, so for the 4th time I made its <a href="http://zibada.ru/finals/">unofficial mirror</a> , with <s>blackjacks and whores</s> , with various additional bells and whistles - This year I screwed a simple real-time chat there.  As a result, this year my broadcast became almost more popular than the official one, for sure in Russia :) <br><br><h2>  Brief statistics </h2><br>  In just 5 hours: <br>  - 6000 unique IP (at the peak of the 10-minute interval - 2000) <br>  - 1M requests to static files <br>  - 500K long-poll requests <br><br>  The load on the server at peak time (9 am Moscow time - the beginning of the last hour of the competition, the table ‚Äúfreeze‚Äù time) - 1.5K connections to nginx, 50M of memory eaten by it, less than 1% of CPU load, outgoing traffic 7 Mbit / sec.  That is, VDS in close to the minimum configuration or even a laptop on your lap would be enough - the main thing is to allow the channel. <br><br>  A few graphs from cacti (data for 2 days, so that you can compare with the server load in "peacetime"): <br><img src="https://habrastorage.org/getpro/habr/post_images/f36/0b1/76c/f360b176c90efaf7cd8e231a64365d92.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/ae3/f0f/555/ae3f0f55576725783f002e894d5b1678.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/ee2/a7c/cde/ee2a7ccde573b7d51011ca564ba2c165.png"><br><br><h2>  Configuration </h2><br>  In the past years, the whole "face" - it was a simple page, pulling updates to its main part - the table, using ajax every 15-30 seconds (the period was configured by the user).  The banal Apache + php bundle with minimal caching coped with the entire load with a bang - the official table was downloaded no more than once every 10 seconds, parsed into json and then distributed to all those asking. <br><br>  This year, I wanted to try something new, having read a lot of articles about such things as long-polling, comet, etc., and decided to do something about it.  Yes, and long wanted to tie the chat ... <br><br>  Let me remind you that the essence of long-polling is ‚Äúhanging up‚Äù client requests until the arrival of new data on the server, as a result, clients receive a response as soon as this data appears.  To implement this function, <a href="http://pushmodule.slact.net/">nginx_http_push_module was</a> used. <br><br>  Why he, and not <a href="http://habrahabr.ru/blogs/hi/79189/">realplexor</a> , cometd or samopisny demon?  Because he knows exactly what he wanted, namely: <br>  - full control of the data format - a simple POST request is made on the server for updating the data, all of the content of which is sent to the waiting clients exactly as it is <br>  - there is no need to use additional libraries, the same ajax request is being made on the client, it is just executed too :) <br>  - support for analog gzip_static (compression is not at the time of issuance to the client, but preliminary), thanks to the first item <br><br>  To be safe, the client was able to work in the old mode, using regular timer ajax requests, and the new mode was turned on by the user by choosing ‚Äúreal-time‚Äù in the settings. <br>  Due to the flexibility of nginx_http_push_module, the mode change consisted only in changing the URL for polling and timers - the data came exactly the same. <br><br>  System components: <br>  - homepage - a shell with all client code, ideally loaded once <br>  - dynamic data in the form of two files - standings.js (table) and chat.js (last 30 chat messages) - their client pulls, either by timer or by long-poll requests <br>  - a daemon constantly running regardless of apache in php, downloading and downloading the official table every 3 seconds and saving it in standings.js <br>  - a php script that accepts (also Ajax) chat messages, recompiling chat.js <br>  - nginx_http_push_module, into which the two previous scripts also threw updates (the contents of the corresponding files compressed in gzip), and to which clients using the ‚Äúreal-time‚Äù mode were hooked. <br><br>  The nginx configuration that implements the above logic: <br><pre>	 location ~ ^ / fairy / post / ([a-z0-9 ._-] +) $ {
		 access_log /var/log/nginx-fairy.log main;
		 push_publisher;
		 set $ push_channel_id $ 1;  # so that the channels are named by file name
		 push_message_timeout 2h;  # longer storage time
		 push_min_message_recipients 0;
		 push_message_buffer_length 1;  # Advanced logic with a message queue is not needed, the last one will suffice
	 }
	 
	 location ~ ^ / fairy / ([a-z0-9 ._-] +) $ {
		 access_log /var/log/nginx-fairy.log main;
		 push_subscriber;
		 push_authorized_channels_only on;  # forbid to read from non-existent channels
		 push_subscriber_concurrency broadcast;  # channels are not personalized, but shared
		 set $ push_channel_id $ 1;           
		 default_type text / plain;
		 add_header Content-Encoding gzip;  # emulation gzip_static
		 expires epoch;  # see below about caching
	 }
	</pre><br>  (why / fairy? yes because the comet name annoys :)) <br><br>  It turned out that the "channels" emulated the usual js files, the same was given to the address /fairy/standings.js as to the address /standings.js (static file), but with the "hanging" before it was updated, and the update was done via POST /fairy/post/standings.js, such a simple and clear URL scheme. <br><br><h2>  Some thoughts on good and evil </h2><br><h4>  1. gzip - good </h4><br>  The official table (html weighing 50K, updated via meta refresh every 30 seconds) did not have any gzip at all, and as a result, the channel died. <br>  (to the credit of the organizers, they later made her a mirror, where gzip did appear) <br><br><h4>  2. gzip_static - welcome </h4><br>  Why compress all these megabits of outgoing traffic on the fly and spend on this CPU if you can create a file next to it along with the updated file .gz and tell nginx to give it away if the client supports it? <br><br><h4>  3. update the file by writing over (instead of writing next to + rename) - evil </h4><br>  If at this moment to swing it (and it WILL BE swing) - troubles begin. <br>  The official table was so updated, because of what users sometimes saw the ‚Äútorn‚Äù table, and if my script dragged it in this form ... everything would be fine, but he considered the difference between the new and previous versions of the tables and threw information about new ‚Äúpluses‚Äù in chat.  As a result, the chat periodically flooded with a wave of false positives, which caused shock to untrained viewers :) <br>  (somehow managed to fix it on the go by adding additional checks) <br><br><h4>  4. load time optimization - welcome </h4><br>  All client code weighs less than 15k in gzip - for this reason I did not use my favorite jquery and other frameworks - I do not like it when the framework weighs twice as much as everything else taken together :) <br>  Also, in order to avoid the ‚Äúloading ...‚Äù labels at the first entry, data files were added to the page via &lt;script src = "..."&gt; and loaded without waiting for onload / documentready. <br>  The result is a pre-assembled table + last chat messages I had loaded from scratch in 0.2‚Äì0.3 seconds, including ping to the server (according to firebug readings), came out faster than Google‚Äôs main page :) <br><br><h4>  5. properly configured client caching is good </h4><br>  Until now, very often I see crutches with the addition of something like &amp; random = 74925 to the query ... <br>  Meanwhile, it is enough to put the Expires header in the past tense so that the browser always makes a request (in nginx this is done in a single line - expires epoch), and teach the client script to handle the answer 304. <br>  You also need to make sure that when ajax requests are sent the correct If-Modified-Since, the same nginx_http_push_module uses it actively. <br>  I put the contents of the Last-Modified header from the last response I received to the same URL (in general, the browser does this itself, but if the user doesn‚Äôt have caching turned off, it‚Äôs not). <br><br><h4>  6. the lack of OpenID - evil </h4><br>  The chat participants had the opportunity to subscribe their nicknames to TopCoder (to highlight their names with the appropriate color), and I really did not have the opportunity to verify their authenticity without special registration (which is impossible for one-night script).  However, the majority of the participants behaved surprisingly culturally, but the most overdue personalities had to be treated with an IP ban :) <br>  Unfortunately, because of their presence, I was forced to turn off the chat at the end, when I finally decided to sleep a bit - I just did not dare to leave everything without moderation. <br><br><h4>  7. Failure to support IE6 - welcome </h4><br>  Finding shortly before the start that the chat is not working in all of our ‚Äúfavorite‚Äù browsers (it seems, because of the XMLHTTPRequest that is a little incompatible in details), I hung up a sign with a clear conscience in the spirit of ‚Äúsorry, in IE6 something may not work, update already finally "and engaged in more useful things for other users. <br>  I think that this is the way to do it, because  the main function ‚Äî displaying a table of results ‚Äî continued to work even there. <br><br><hr><br>  It seems to have turned out too many letters.  But I hope someone my experience will be useful. <br><br>  And yes, PPNH :) </div><p>Source: <a href="https://habr.com/ru/post/83385/">https://habr.com/ru/post/83385/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../83376/index.html">Xsplash - making a theme for yourself</a></li>
<li><a href="../83377/index.html">How do we sell software?</a></li>
<li><a href="../83378/index.html">Filling the database with test data using Populator and Faker</a></li>
<li><a href="../83381/index.html">Button and resistance</a></li>
<li><a href="../83384/index.html">Login to connect a specific flash drive</a></li>
<li><a href="../83387/index.html">Learn Japanese ABCs</a></li>
<li><a href="../83388/index.html">Are you ready to pass the exam on computer science?</a></li>
<li><a href="../83391/index.html">What is interesting to listen to IT person on the radio?</a></li>
<li><a href="../83394/index.html">Puzzles on the development of non-standard thinking</a></li>
<li><a href="../83396/index.html">ASA: network address translation troubles. Part 1. Dynamic translation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>