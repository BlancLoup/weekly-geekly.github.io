<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring of all web project layers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nikolay Sivko ( NikolaySivko , okmeter.io ) 
 This text is a transcript of a very old, but not losing relevance speeches Nicholas. 

 I would like to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring of all web project layers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/03c/cd4/d38/03ccd4d384871d043423adc7bd07677f.jpg" alt="Nikolay Sivko"><br><br><h2>  Nikolay Sivko ( <a href="https://habrahabr.ru/users/nikolaysivko/" class="user_link">NikolaySivko</a> , <a href="https://habrahabr.ru/company/okmeter/">okmeter.io</a> ) </h2><br>  <i>This text is a transcript of a very old, but not losing relevance speeches Nicholas.</i> <br><br>  I would like to talk about why, in general, we monitor, about the content.  The motivation is simple - if we have a resource for 1 minute (HeadHunter), we decided that this affects 30 thousand users in the afternoon on weekdays.  For comparison, this is 15 HighLoad ++ audiences this year.  Oleg said that there are about 2,000 people here, so these are 15 such audiences.  The task of the exploiters, in my opinion, is not to optimize monitoring, but to make their website work.  Those.  business problem to solve.  What tasks need to be addressed? <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/dce/501/dde/dce501dde36285e4c7345c701d9d9959.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  The first is to find out what has broken, i.e.  good / bad - these two states of the system should be able to be distinguished. </li><li>  The second is to quickly find out where it broke, in order to quickly run to fix it. </li><li>  After you have made any changes, returned everything as it was, it worked, you need to check that it works the same way as before the package. </li><li>  It is also possible to download several such tasks that are not entirely urgent, such as raking up incidents - this is capacity planning, i.e.  understand how much resources you have to serve new and new users. </li><li>  Plan optimizations to free up these resources.  When you understand that your iron resources will soon run out, either buy more, or understand that we can tighten up here, and then you will not have to buy iron. </li><li>  And, no less important, is to check that your optimization has worked. </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/573/3bd/5e2/5733bd5e2beb40f44d8b248daeba27ab.png"><br><br>  A little restrict scope.  We will talk about what metrics you need to look at in order to understand your system.  We will try to understand how to draw them better, we will talk about graphics, we will try to understand how to draw them correctly so that we can understand everything quickly.  Because on the chart with 10 thousand lines nothing is understood. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f34/e17/dd4/f34e17dd4d76c5521343e69149ff322a.png"><br><br>  We will not talk about how to draw charts, how to tune your monitoring, how to shard monitoring, how there is a proxy, everything.  We will not talk about specific alerts and methodologies, i.e.  workflow, who is responsible for what, what KPIs are in use ... I gave a report at the spring conference, here is a link.  There are slides, plus or minus, everything is clear. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d50/dcb/f81/d50dcbf81d953e23be74dc75ee35757b.png"><br><br>  So let's go.  What are we dealing with?  Simplified HH.ru looks like this.  From above - the browser, our user, he comes to look for work.  Falls to frontends.  There nginx, then static is given there, cached as far as possible, then the request comes to our collector server, we call it front-end.  Since  we have SOA, we need to collect the page of the pieces.  The front, as time, it is engaged.  It makes requests to different services, templates and gives the page to the user.  Then the front comes to services, but since  everything must be scalable, fault tolerant, it goes through balancers.  Our internal balancers are nginx + haproxy.  Next, figuratively, I painted three different services, in fact, there are about 40-50.  These services make some kind of business logic, go to some of their repositories, the vast majority are postgres, they also communicate with memcached, we even have a little cassandra, etc. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/850/41e/045/85041e04596514590f9c6d3873d861f5.png"><br><br>  What do we want to understand?  We want to understand how the user sees our site.  Moreover, since  we have many users, we want to understand everything at once.  Those.  who sees how, what percentage does not see well, what percentage sees well.  We want to see what is happening in each subsystem, because if something is broken here, you physically cannot read 40 different logs, each of them has 3-10-20-30 replicas. <br><br>  What resources are spent on is to be understood, because any monitoring of the state of an application is to understand where control is in the application at any given time.  Since  If we want historical data, then we need some stages of the application, etc.  I'll tell you more about this later.  And all this is not enough to understand in the form of a light bulb "good" / "bad."  We must understand in time, because sometimes we must be able to compare with how it was an hour ago, a minute ago, last Monday, Thursday, two weeks ago. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c3/ea4/1c6/7c3ea41c65cf141d8ec14f2dcf69a3f9.png"><br><br>  He promised by layers, we will by layers.  The first layer is the browser.  What can I get from the browser?  There is an opportunity to remove any timings - how many dns requests were made, how much our network connection was serviced, these are tcp connect, tss handshake, how many requests were sent to the server, how many the server thought, how many data was transferred, how many pictures were immersed, static, everything.  And finally, the code that works in the browser can be confusing - how much can all this be removed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/530/243/071/53024307148a1d10ffd39b22073a6879.png"><br><br>  I‚Äôm not a front-endander, so I‚Äôll tell you about this layer.  There is a Navigation timing API.  Practically all front-fenders know about him, about him, I think, there is a report at this conference.  The bottom line is that we remove the timings from the browser and shoot them with a get-request to our server.  On the server, you do not need to process anything in realtime, just hang up in nginx to return the 204th status, and write the entire get request to the url, and then parse. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8f8/1e6/768/8f81e67683f886ffe10d2965c96784d8.png"><br><br>  As a result, we get something like this.  Don't ask me why green is 20 seconds.  But we see, at least, interesting metrics for the exploiter - how the server works for us from the point of view of a particular browser, how the channel works for us, i.e.  how much is all transferred.  We see that it takes an acceptable time, there are no jumps - that's all, we have solved our task.  Then ask front-vendors what metrics they need, draw for them, or they will draw, not the point. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d2f/c48/689/d2fc48689c70abc4b7427f3639ba99d3.png"><br><br>  Next, the frontend layers begin.  We in the nginx log see everything that has flown to our data center.  Why can not fly?  Can not fly, because your domain is not resolved from some place.  It can not fly, because you simply lack connectivity.  In this case, you can do something - again, front-ends know, there is some mechanism, to shoot such things on some other host - I won‚Äôt tell you exactly, but there is, know about it, and that‚Äôs enough. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a91/427/f80/a91427f803dc26920342aef4416df6e8.png"><br><br>  What do we want to get on this layer?  We want a complete picture of how the site works.  Any bugs, no bugs?  If so, how much, what part of the users they affect - is it one user, 10%, 100%?  Is the site fast or slow?  Again, on what scale?  Does one tupit or tupit at all, or tupit at all from Voronezh?  How many requests do you have per second?  Because, there are cases when bots come, and then your rps increases.  It is necessary to know, it will help you to restore your system.  Or you went to the channel - there is a failure, there is nothing.  Or you have a third failure, because Rostelecom has unearthed something on the border, there, with Ukraine ... And it happens that the channel is dull, there are delays somewhere, losses ‚Äî I would also like to answer this question. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bb7/d64/b9b/bb7d64b9b9bb0160e55e2accaf26e435.png"><br><br>  All this is in the nginx log.  But not in the standard log format.  You need to add request_time there - this is the time from receiving the first byte from the client to sending the last byte of the response to the client socket.  Accordingly, somehow this metric reflects even the characteristics from the channel to the client - it is fast, slow.  Because we still have all the dudes on the modems.  Also, if you want to distinguish problems with the channel from the problem with the backend, there is upstream_response_time - this time spent waiting for the backend, one, several, is not important.  This does not include any delays to the client, and this is just the time you spent to calculate the page.  Optionally there are all sorts of useful options.  I will not read, this is for understanding what is happening there. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/91f/fec/2b5/91ffec2b508ce89bf9d976e696b9de02.png"><br><br>  How to look at it?  We look at it like this.  This is called in our terminology "traffic light".  Y axis - requests per second.  We have a little more than 2000 of them (some time ago I was preparing this presentation).  The green area is rps, which were processed for less than 500 ms.  Yellow - those that worked 500 ms and a second, red - more than a second, it is a long time.  And black - we added mistakes here, they are affectionately called "oil."  This rps pyatisotok.  Accordingly, the transfer for the client is included here, because this is request_time, which we talked about backwards. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/401/806/006/4018060066ca2e30c403f02229264e39.png"><br><br>  Upstream_response_time, firstly, it is less than rps, because something out of the cache has surrendered, something has gone somewhere.  Accordingly, we have upstream_response_time, as we see, there are fewer red ones, because the transfers are gone, i.e.  in fact, we work even better, but we have five hundred dollars with us. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5e4/9b7/113/5e49b711303920352e0fbafdcfcbadc7.png"><br><br>  We can only leave five hundred on the same chart.  We understand that we had two spikes.  One more than 400 rps, and the second - a little more than 100. Very convenient for understanding.  Those.  we, in principle, practically answered all the questions with two graphs.  And in a situation when we are only interested in the server, then one. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/17a/105/428/17a1054287828d3f499c0eb3c16b2cf0.png"><br><br>  Five hundred, we can lay out url'am in realtime.  We can see that all urls can be five hundred times immediately, in proportion to what we have rps.  And we can see specifically the url, if any handler, some service broke, or a specific query from the database was dulled. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b9a/baa/5d5/b9abaa5d54dd3ffa6ea3e19daefa93a7.png"><br><br>  Also there is such a schedule, it duplicates pyatisotki.  We look at it according to different logs.  The colors are the same in order to understand in the legend which one is five hundred.  We have an API for a mobile application, there is a main site HH, and there is a mobile site.  Separately, we allocate bots - these are requests that fall into the limit of the number of requests per second in nginx, then we give them the 429th status.  Here it is drawn.  We draw all the statuses, and here we only output the 429th, because anything has happened, it starts to blunt, we do not filter everything there, for example, the satellite was once young, it was often used to us until we banned it.  But to see the fact that bots came is very useful. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf2/57b/afb/bf257bafb5a4cccd119eca8efcb4c9d0.png"><br><br>  Then we can look at the traffic by url'am.  This is only static traffic, the speaker is not included here.  We see - the release was released, CCS, JS were updated, there was a surge, users started downloading the latest versions, then he calmed down and switched to normal mode.  It's cool to understand what is happening, because if you see an unfamiliar surge in traffic, you are: ‚ÄúDamn, what is this?‚Äù.  And then everything is immediately clear. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e2f/01a/98d/e2f01a98dcd5c23c6f15f7cf34ad73be.png"><br><br>  I will tell a little about urlah.  You can configure the parsing of logs so that you will say: "I know such and such URLs - vacancy, job search, etc.".  But this is all outdated instantly, because the application develops when developers rename urls or somehow redo them, no one will tell you about this, you will go to watch something on urla, and there pumpkin. <br><br>  What need to do?  It is necessary, first, to try to normalize urly.  Those.  remove all arguments, try to isolate some hashes or id from the URL, replace all this with some placeholders, no matter what, and build a dynamic top.  We have a dynamic top in the amount of $ upstream_response_time, i.e.  The urls that take the most real CPU time are in the top.  You can rps, you can make separately for errors.  But you definitely need to cut off the bottom, because requests from bots, as a rule, collect all your five hundred points, all four points, etc. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a52/717/a0e/a52717a0ecf53b4070759a22d19874f3.png"><br><br>  Also on the logs.  If you have several front-ends, and you collect metrics from everyone, you can aggregate it and see how balancing works for you - well, bad, where traffic flowed.  In this example, front2 was taken out of the cluster, there are some works, and several times.  We see that, first, the rest of the servers flowed from the load balancer.  Accordingly, the total rps was not affected in any way, i.e.  we have done it painlessly for users.  But such a picture is extremely useful. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/23a/139/c62/23a139c6276f47c5e1b2c5bc3977b013.png"><br><br>  Farther.  Let's go down.  We understand how it works, now we solve the problem ‚Äúto quickly understand what is broken.‚Äù  At the front we also have a log. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/81f/370/58c/81f37058c55b350409b908d08c6e4edd.png"><br><br>  This is one of the types of lines, looks like.  Here we are for each handler, in this case vacancy.Page, we write all the stages in milliseconds, how much we occupied.  A stage is some kind of code that is being executed.  All stages go sequentially.  Let's say a session is a trip to the session service and getting a session, we take a cookie, we do something there, we get a session, we know more about the user.  Then with this data we go to page - this is a parallel campaign for all services that need to be found for this handler.  Those.  inside this stage there are parallel queries.  But we are interested in total.  Xsl.  We are all xsl template.  Postprocess is the imposition of translations on all sorts of ... there the page is going, there are place holders, then a special process goes through the page, replaces place holders with translations. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f6/767/377/1f67673772c4fbacb867630b97616417.png"><br><br>  Here we have a picture from this log.  It can be seen, this is a stack of 95th percentiles of each stage.  The percentile has its advantages and disadvantages, but in this case it is convenient.  First, we understand that bummed.  In the middle of the chart, a blue shot is blunted session service.  If another stage fires, we will immediately find out.  That is, in principle, for each page there is such a picture.  You can somehow aggregate across all pages, across all handlers.  But this is the taste and color. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/347/c87/e4a/347c87e4abe18fe828d666055973dab6.png"><br><br>  Convenient reception is still - sum up the response time.  It would seem that the stupid metric "sum up the response time."  Actually, cool stuff.  We, summing up the response time on the topmost layer, we get in some units, I call it ‚Äúresource seconds per second‚Äù, how much and, in general, what the cluster does.  Those.  if we divide them by handlers, we get that 20-30% is blue - this is vacancy.Page.  Those.  cumulatively, regardless of anything or the number of requests, we are engaged in the delivery of a vacancy page.  Next is job search etc.  If we get any bjaka, which will be considered an hour, but in one stream, we will not see it here, and rightly so.  Those.  This is the real answer to the question of what the cluster is doing. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/76c/e4e/7b1/76ce4e7b1a66e8af57b3f0abdae16aef.png"><br><br>  Templates  The front also writes which template overlaps and how much. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/16b/6e7/c58/16b6e7c58fb15fa68b4a865e058bc7e0.png"><br><br>  It makes sense to make a graph out of this, we just get what template the CPU takes in seconds, because template making is a CPU task.  Accordingly, we can choose what to optimize.  We are not guided by rps, i.e.  how many times a specific template was called, superimposed, etc., and how much in total it gave the weight and how much, in principle, the CPU can be released. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4dc/a52/53d/4dca5253d59c71071076b63232006dba.png"><br><br>  Here is an example.  True, I'm here telling you about what template we have, but we‚Äôve got to optimize, we‚Äôve found out that we can optimize the menu generation piece that other templates include.  Here it is optimized, so collapsed.  Those.  if after this task optimization goes into the prod, we understand that the picture has not changed, it was necessary to roll it back and do nothing else, because if there is no effect, the task can be thrown out.  There is an effect here.  Cool, we appreciated how much.  We are on the basis of the heels of cars removed from the cluster of frontiers. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2fc/2ce/962/2fc2ce9621ce3d17040b83b775330284.png"><br><br>  Next on the balancers. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ab/cf4/255/9abcf425514dfe9986fc506501b3b513.png"><br><br>  There is the same nginx, the same pictures, but we have SOA, we have many services, the most usable schedule for us is the answer to the question ‚Äúwhich service is five hundred?‚Äù.  In this case, this is the top 5.  Dynamic.  Those.  if the service comes out, which has 2 rps, and it starts giving us 10 thousand five hundred per second, it will come out automatically here.  Accordingly, we see green - the session service pours about 70 requests per second.  We received the answer, at least we can already go to read the logs, if we have nothing on this service. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/435/c57/bfe/435c57bfe6901ea2149cede638e7daf3.png"><br><br>  But let's see what can be pulled out of each service? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4af/784/eac/4af784eac96e730f0e2e9cc00c997801.png"><br><br>  Again stage.  In principle, nothing except stages is necessary, because debugging on logs is still difficult.  Those.  These are separate logs.  If the programmer needs information on business logic, he writes it separately, and the agent pulls out of the log only what interests him.  We are interested in the stage, we are interested in where the time goes.  In this case, the request for the session was fulfilled 10 ms, 6 of which were spent on the campaign to the HHid service.  This is a service that knows the user and knows nothing more.  It enriches it, i.e.  the result of the response of this service, HhSession enriches from the database, it took the request to the database to take 3 ms. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0bd/b1f/c41/0bdb1fc41ce4df6effc23e6ce5aca8d2.png"><br><br>  Accordingly, the log is, there is a picture.  We see that the request ‚Äúbase latency‚Äù is constant, and we see that on this background, the Hhid response time jumps.  Those.  if the base suddenly blunts, we will see a surge at the base, i.e.  we get answers to our main questions - where to go next in the case of a fakap. <br><br>  My whole story is based on the fact that I want to quickly understand what happened.  Those.  This is the optimization of the exploiter‚Äôs work. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e0b/5d7/167/e0b5d71676c360599895983c27a8a3cb.png"><br><br>  According to the base.  Those.  You said: "Tupit base."  What can be done on the base? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f64/db2/626/f64db2626ba127685e14307b26bdf037.png"><br><br>  First, there is, as it is not trivial, the average base response time.  This is taken from postgres, from pg stat statements.  Because nothing more intelligible can be taken from there.  Therefore, the average time.  But it is significant.  Here are all four of our bases.  This is a particular piece.  We see that everything is working fine, but at night one blunts.  This is a master, and then we will try to understand what happened to him.  Those.  if suddenly you come, and you are told that the base is stupid, you look at this chart, and everything is the same as it was, you immediately say: "No, everything is fine with the base."  And it will be true. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/265/70c/bae/26570cbae825958d04e51e5575848109.png"><br><br>  If suddenly on the basis of the CPU jumped, in principle, from the pg stat statements we can understand exactly which query was calculated.  In this case, we see a rejection of red - this is a request to the database, hh_test, and is there all its text?  and with holder 's.  He is circumcised here, but you can just copy it and see where it comes from, remove, eject, anything. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7b6/507/c87/7b6507c87233633aca102e7a05d5c59b.png"><br><br>  The base also has a weak point - it drives.  Naturally, everything is there, all the data. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3e4/8dc/2aa/3e48dc2aafd99dbff6ee978a0dc64b7e.png"><br><br>  Who loaded the wheels?  In pg stat statements there are counters, how many were waiting for a response from the disk.  Accordingly, we see specific two requests that kill the disk.  We come, we deal with them, if necessary.  If this is a normal, regular situation, then we just know what the peak is.  Answering the question ‚Äúwhat was it?‚Äù Is the most important thing.  Those.  If there are any emissions in your system that you do not understand, you need to collect more detailed information about your system. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e1d/d0b/130/e1dd0b1300dc67afefd49c08ba449f81.png"><br><br>  And everything would be simple, if there was no network between all this.  We can say that therefore, including, we remove all timings from all services, even if they are repeated.  Because the measurement error in a web application can be quite substantial.  Because, for example, you have some asynchronous application that is built on an event loop, somewhere measures how much it waits for an answer and at the same time thinks something, the control has not returned to its loop, then it will count a lot of things . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56a/f4e/a25/56af4ea2535c8cfe19358d2df3980d47.png"><br><br>  Questions  Suppose we see in the session service log that he went to hhid 150 ms, we all have request_id, i.e.  we can tie them together according to the logs and match two specific requests, and say that it was a request - the session saw so much, so much hhid.  We go to hhid, he says: "I answered 5 ms, I know nothing."  Developers come and say: "Your network is tupit."  Well, damn it, got it!  And we decided to think about what to do.  At the same time, to ping all machines from all machines is somehow strange, to say the least.  And even more so, before the first fakapap it is not clear from what machines what to do.  It is necessary to exclude the network. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/810/8ea/396/8108ea39661624131c91872c1e33390d.png"><br><br>  There is such a thing TCP RTT - Round-Trip Time.  This is the time from the sending of the segment to the TCP network to the receipt of acknowledge.  But this time should not be compared with ping.  It should be considered as a trend, because TCP is not an easy thing, to say the least. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/80e/b95/262/80eb9526298939c7607298b14db0350f.png"><br><br>  I stole a slide from the presentation - this is some kind of course on the networks of an American university, it says here that in fact one TCP connection has only one RTT timer.  Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the first case, we measured the actual time from sending the segment to the ACK.</font></font> All is well.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we remove the error on the number of bytes transferred, then we approximately get a normal RTT. In the second case, RTT counted us sending 2.5 segments and receiving 2 ACKs. Because TCP has selective acknowledge and so on. There are a lot of bells and whistles, plus to everything, if any order of sending segments breaks there, and there the meat begins. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc5/8b5/4d3/dc58b54d33705c0b3078ab997e104957.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But still, we decided to try to measure it. We remove RTT of all connections from all hosts once a minute, but stupidly remove, aggregate around. We aggregate between two IP lokalki. If this IP is not from LAN, we say ‚ÄúAzer‚Äù and aggregate. If the IP is in LAN, then for each IP we have a metric from each host. And we also break down by listen_port, if listen is on our side. We are trying to see what can be said on these metrics.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/166/a10/fd7/166a10fd77f7b523a6e507a2f95d4ef7.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is an example of a picture. This is an RTT between replica and master. The replica is in the remote data center. On this day, there were works on data centers, the channel was completely extinguished twice. First, we see that TCP RTT with ping is less than a millisecond of 7 ms, but it's cool that it is constant, i.e. trend still reflects us. This picture shows two failures. At least, they will tell us: ‚ÄúThe network has disappeared‚Äù. We look at these and say: "Really disappeared." And after the recovery, we see that the network has dulled twice, everyone wanted to blunt, etc. And then everything came back to normal, which is also cool, we saw it. In principle, it became clearer, i.e. The metric is incomprehensible, because we do not know that under this RTT actually hides inside, but there is a trend, and this, I think, is 100 times better than nothing.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/98d/289/700/98d289700802041c7def5077b90d3f09.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And about the OS. It's all trite, like everyone else, except that I emphasize that everyone is looking at the swap and not looking at the swap i / o. Swap i / o is much more useful. If someone sits in your swap and does not read or write anything from there, then let him sit, don't mind. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/34f/f31/b06/34ff31b060534e54f18787c3b8f6a73d.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But having a CPU, it's hard to say what kind of garbage. Because we come to work at 10 am, we look at the schedule, what is it? </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/de0/01e/392/de001e392b78f1c117a679f8932ab27e.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also remove system metrics for each process from the user. The most useful of them are CPU, Disk i / o, Swap, Swap I / O and up to the heap (we are tired of the problem of too many open files), we remove for each process how many descriptors are opened, sockets, files are not important, and what limit.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/830/467/5f3/8304675f37ff7846bef048e5a9c3c6ac.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And we immediately see that at night there was a backup on the master, and pbzip ate CPU. In principle, a simple metric, just a good granularity, and we get all the answers. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/64c/662/c0e/64c662c0eda3494dd582d472d23e6f06.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's finish and summarize. I wanted to tell you about what you need to think not about how many points there are, how many hosts to monitor, what ports they have to check once a minute, but make good correct graphs for your system, and they can increase the speed of finding out the reasons for you fakapov.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is important not to stop, if ... Suppose we see the whole picture at the front end, we could not go further along the logs, but we realized that after we understand whether there is a problem or not, it takes us 10 minutes during the day to read the logs. But we monitored there and saw that this time was reduced by 10 times. Further, we see problems with base. We used to be: ‚ÄúWe have postgres consulting DB admins are outsourcing!‚Äù. We call and say: "Guys, look, what's with the base?". Now we, at least, understand whether there is anything on the basis of what. Because any communication between people is long, the computer is faster, and if you make the right metrics ... At least make the metrics not so that they give you answers, but do to exclude the most likely problems. And the more detailed the metric, the simplerbecause if we are all averaged there, take percents, histograms, etc., nothing will be clear, and you will still get into the logs. Try to make it so that you don‚Äôt need to go to the logs.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> That's all I wanted to tell you. </font></font> Thanks for attention! <br><br><h3>  Contacts </h3><br> <a href="https://habrahabr.ru/users/nikolaysivko/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NikolaySivko </font></font></a> <br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n.sivko@gmail.com </font></font></a> <br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sivko@hh.ru </font></font></a> <br> <a href="https://habrahabr.ru/company/hh/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HeadHunter </font></font></a> <br> <a href="https://habrahabr.ru/company/okmeter/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Company Blog okmeter.io Company Blog</font></font></a> <br><br><blockquote>  <font color="gray">This report is a transcript of one of the best speeches at the conference of developers of high-loaded <a href="http://highload.ru/%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommon">HighLoad ++</a> systems.</font> <font color="gray"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we are actively preparing a conference in 2017 - this year HighLoad ++ will be held in Skolkovo, on November 7 and 8. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The topic of monitoring is raised on HighLoad ++ every year, here, for example, some of the reports of 2017:</font></font><br></font> <ul><li> <a href="http://www.highload.ru/2017/abstracts/2503.html%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommo"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitoring the cloud CI system using the example of Jenkins</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / Alexander Akbashev (HERE Technologies);</font></font></li><li> <a href="http://www.highload.ru/2017/abstracts/2842.html%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommo"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logging and ranting</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / Vytis Valentinaviƒçius (Lamoda)</font></font></li><li> <a href="http://www.highload.ru/2017/abstracts/3007.html%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommo"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zabbix: high-performance monitoring recipes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / Alexey Vladyshev (Zabbix);</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and even </font></font><a href="http://www.highload.ru/2017/abstracts/2963.html%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommo"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitoring the performance of the frontend in Badoo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / Alexander Gutnikov (Badoo).</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, Nikolai himself is going to read a philosophical and systematizing report on the topic ‚Äú </font></font><a href="http://www.highload.ru/2017/abstracts/2899.html%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommo"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operation of container based infrastructures</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù.</font></font><br><br>  Also, some of these materials are used by us in an online training course on the development of high-load systems <a href="http://highload.guide/%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommon">HighLoad.Guide</a> is a chain of specially selected letters, articles, materials, videos.  Already, in our textbook more than 30 unique materials.  Get connected! </blockquote></div><p>Source: <a href="https://habr.com/ru/post/340114/">https://habr.com/ru/post/340114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340100/index.html">Hilbert curve vs Z-order</a></li>
<li><a href="../340104/index.html">Western Digital released the first 14 terabyte HDD</a></li>
<li><a href="../340106/index.html">How we drove drug dealers out of the runet</a></li>
<li><a href="../340108/index.html">Accelerate the vagrant shared-folder on the Windows host (UPD. Not everything is so smooth)</a></li>
<li><a href="../340110/index.html">Cocos2d-x - Scenes and special types of nodes</a></li>
<li><a href="../340116/index.html">ReactNative, Xamarin, PhoneGap, and Qt architectures. Part 1</a></li>
<li><a href="../340120/index.html">Splunk 7.0. What's new?</a></li>
<li><a href="../340122/index.html">ReactNative, Xamarin, PhoneGap, and Qt architectures. Part 2</a></li>
<li><a href="../340124/index.html">Crossing Task</a></li>
<li><a href="../340126/index.html">Automation of work with Logs API in AppMetrica. Lecture in Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>