<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Django + Sphinx = django-sphinx (?)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When we prepared our latest article about Django-batteries for Habr, it turned out that we still have something to tell about django-sphinx and our st...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Django + Sphinx = django-sphinx (?)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/364/5af/efd/3645afefd2cf9c646282c306e16d1ab7.png"><br><br>  When <a href="http://futurecolors.ru/">we</a> prepared our latest <a href="http://habrahabr.ru/blogs/django/136168/">article about Django-batteries</a> for Habr, it turned out that we still have something to tell about django-sphinx and our story draws to a separate post.  Actually, here it is, as promised. <br><br>  To date, there are several good solutions for organizing searches in Django.  Several are two: <a href="http://haystacksearch.org/">Haystack</a> and <a href="https://github.com/futurecolors/django-sphinx">django-sphinx</a> .  Haystack works with solr, whoosh and hapian backend engines and, alas, does not work with Sphinx for some abstract licensing reasons.  django-sphinx, as you might guess, works with Sphinx and only.  Haystack is a high-quality, well-documented and actively developed product, and we, no doubt, would use it if he supported Sphinx in any form.  But this, alas, has not yet happened.  And <a href="http://sphinxsearch.com/">Sphinx</a> is our everything, thanks to its speed, flexibility and, which is very important in our geographical latitudes, the ability to take into account the peculiarities of Russian morphology, which cannot be said about its closest competitors.  "Big, but 5 ... or small, but 3?" 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Since the quality of search results is still crucial, the question of choosing a search engine was not particularly.  And since, apart from django-sphinx, there is nothing ‚Äújangosphinx‚Äù in nature anymore, the choice of battery was predetermined.  So: <br><br><h6>  Good: </h6><ul><li>  full support for the Sphinx API &lt;= 0.9.9 </li><li>  Search queries through the model manager (SphinxSearch), you can specify parameters such as field weights or index names directly in the model class description </li><li>  based on the specified parameters, can automatically generate sphinx-config </li><li>  pseudo`queryset (SphinxQueryset) output, which is convenient for further work with the issue </li></ul><br><h6>  Poorly: </h6><ul><li>  chained methods do not generate new search query instances (example below) </li><li>  some annoying open bugs in the original django-sphinx package (for example, exception when using the exclude method), although they are fixed in our fork </li><li>  no tests at all, poor documentation </li><li>  the package is not supported and no longer developed by its author </li></ul><br><br>  You can, of course, use the Python API included in the Sphinx delivery itself, which magic4x just <a href="http://habrahabr.ru/blogs/django/136168/">offered</a> us.  There is, however, a third option - to write your own battery, with <s>blackjack</s> tests and documentation. <br><br>  On the other hand, everything is not so bad.  Django-sphinx is successfully used in many projects and, by and large, copes with the work.  Let's look at one example from the real world. <br><br>  There is a certain model for which we want to organize a search: <br><br><pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Post</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> ... title = models.CharField(_(<span class="hljs-string"><span class="hljs-string">u''</span></span>), max_length=<span class="hljs-number"><span class="hljs-number">1000</span></span>) teaser_text = models.TextField(_(<span class="hljs-string"><span class="hljs-string">u''</span></span>), blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) text = models.TextField(_(<span class="hljs-string"><span class="hljs-string">u''</span></span>)) ... <span class="hljs-comment"><span class="hljs-comment">#  django-sphinx search = SphinxSearch(weights={'title': 100, 'teaser_text': 80, 'text': 90}) ...</span></span></code> </pre> <br><br>  One of the main reasons why we use django-sphinx, rather than the Sphinx API, like real boys, is the ability of django-sphinx to automatically generate for us a sphinx-config based on the data we specified in the model.  For this there is a special management command <b>generate_sphinx_config</b> .  Using it is simple: <br><br><pre> <code class="bash hljs">$ ./manage.py generate_sphinx_config --all &gt; absolute_path_to_config_file.conf</code> </pre><br><br>  By the way, you can create your own set of templates by which the config will be formed.  In these templates, you can specify <a href="http://sphinxsearch.com/docs/manual-0.9.9.html">the search mode</a> , Russian <a href="http://sphinxsearch.com/docs/manual-0.9.9.html">stemming</a> , etc., then the config will not have to be tweaked by hand.  Conveniently. <br><br>  Now we need to run the search engine daemon itself.  This part of the django-sphinx settings is no longer relevant; the programs from the Sphinx box are used. <br><br><pre> <code class="bash hljs">$ sudo searchd --config absolute_path_to_our_config_file.conf</code> </pre><br><br>  When you first start, <b>searchd</b> swears that there are no indices and there is nothing to do.  To create index tables, we are provided with the <b>indexer</b> program, which in the simplest version runs like this: <br><br><pre> <code class="bash hljs">$ sudo indexer --config absolute_path_to_our_config_file.conf --all --rotate</code> </pre><br><br>  That's all.  Of course, you can write even simpler management teams for these simple actions that would create for each developer their own config and their own instance of sphinxd in the system.  Personally, we did. <br><br>  So how do you compile search queries?  What can django-sphinx except forming a config? <br><br>  For example, in some view you need to get a search query object.  It's very easy to do this: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span>user_query = self.request.GET[<span class="hljs-string"><span class="hljs-string">'query'</span></span>] <span class="hljs-comment"><span class="hljs-comment">#   result = Post.search.query(user_query) ...</span></span></code> </pre><br><br>  We get a pseudo-result query object with a search result and some useful methods and attributes.  For example, Sphinx is able to independently create search results snippets, which can even be slightly customized. <br><br><pre> <code class="python hljs">passages_opts = {<span class="hljs-string"><span class="hljs-string">'before_match'</span></span>: <span class="hljs-string"><span class="hljs-string">'&lt;span style="background-color: yellow"&gt;'</span></span>, <span class="hljs-string"><span class="hljs-string">'match'</span></span>: <span class="hljs-string"><span class="hljs-string">'&lt;/span&gt;'</span></span>, <span class="hljs-string"><span class="hljs-string">'chunk_separator'</span></span>: <span class="hljs-string"><span class="hljs-string">'...'</span></span>, <span class="hljs-string"><span class="hljs-string">'around'</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'single_passage'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'exact_phrase'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, } result = result.set_options(passages=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, passages_opts=passages_opts)</code> </pre><br><br>  What makes this code is not difficult to guess and there is nothing unusual in it.  However, if you need further filtering of the sample (which is almost certainly the case), here be dragons.  Everything starts working in a completely unexpected way. <br><br>  <b>BAGOFICHA number 1</b> <br>  To use the exclude and filter methods, you need to pre-assemble the id‚Äôs of the filtered objects and pass them as an unpacked attribute dictionary (easier to show with an example): <br><br><pre> <code class="python hljs">excluded_obj_id_list = [post.id <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> post <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> result <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> post.is_published] filtered_result = result.exclude(**{<span class="hljs-string"><span class="hljs-string">'@id__in'</span></span>: excluded_obj_id_list})</code> </pre><br><br>  And the most sudden thing about all this is that the last operation will not work as expected from it.  Honestly, it will not work at all, no exclud will happen. <br><br>  <b>BAGOFICHA number 2</b> <br>  Everything works as you would expect only within a single chain of methods. <br><br><pre> <code class="python hljs">filtered_result = Post.search.query(user_query).exclude(**{<span class="hljs-string"><span class="hljs-string">'@id__in'</span></span>: excluded_obj_id_list})</code> </pre><br><br>  And this, of course, generates not the most efficient and transparent code. <br><br>  <b>BAGOFICHA number 3</b> <br>  In the Sphinx there are various search modes.  For example, we want to set the mode to 'SPH_MATCH_ANY' (matches any of the query words).  If you do this in the model itself, everything works well. <br><br><pre> <code class="python hljs">search = SphinxSearch(weights={<span class="hljs-string"><span class="hljs-string">'title'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">'teaser_text'</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-string"><span class="hljs-string">'text'</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span>}, mode=<span class="hljs-string"><span class="hljs-string">'SPH_MATCH_ANY'</span></span>)</code> </pre><br><br>  If you do this in logic, where we enable the generation of snippets and their settings, everything also works well ... <br><br><pre> <code class="python hljs">result = Post.search\ .query(user_query)\ .exclude(**{<span class="hljs-string"><span class="hljs-string">'@id__in'</span></span>: excluded_obj_id_list})\ .set_options(passages=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, passages_opts=passages_opts, mode=<span class="hljs-string"><span class="hljs-string">'SPH_MATCH_ANY)</span></span></code> </pre><br><br>  ... but you won't see snippets.  Therefore, specify the search mode only in models. <br><br>  In templates, everything is rather trivial.  So, for example, snippets are displayed: <br><br><pre> <code class="html hljs xml">{% for post in search_results %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"g-content"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ post.get_absolute_url }}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"b-teaser__descr__snippet-link"</span></span></span><span class="hljs-tag">&gt;</span></span> {{ post.sphinx.passages.text|safe }} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {% endfor %}</code> </pre><br><br>  The mentioned ‚Äúfeatures‚Äù drank a lot of blood and I hope that this post will save some of you time and nerves. <br><br>  And finally.  In December 2011, <a href="http://sphinxsearch.com/news/49">the</a> first Sphinx release of the past few years was version 2.0.3.  django-sphinx works only with versions 0.9.7, 0.9.8 and 0.9.9. <br><br><hr><br>  1) Sphinx - <a href="http://sphinxsearch.com/">sphinxsearch.com</a> <br>  2) Original django-sphinx - <a href="https://github.com/dcramer/django-sphinx">github.com/dcramer/django-sphinx</a> <br>  3) Our fork with some bug fixes - <a href="https://github.com/futurecolors/django-sphinx">github.com/futurecolors/django-sphinx</a> </div><p>Source: <a href="https://habr.com/ru/post/136261/">https://habr.com/ru/post/136261/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136255/index.html">Explore Minecraft: Dungeon Keeper Ancestors</a></li>
<li><a href="../136256/index.html">Another phishing in LJ</a></li>
<li><a href="../136258/index.html">Election webcast tender completed</a></li>
<li><a href="../136259/index.html">Guy Kawasaki: What I learned from Steve Jobs</a></li>
<li><a href="../136260/index.html">British student lost extradition case for piracy</a></li>
<li><a href="../136262/index.html">AR-Go: do-it-yourself wearable computer</a></li>
<li><a href="../136265/index.html">Using Table View</a></li>
<li><a href="../136267/index.html">Android Input Validators</a></li>
<li><a href="../136268/index.html">SOHO router or comp? The issue of energy consumption and economy</a></li>
<li><a href="../136271/index.html">A fresh look at computer keyboards</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>