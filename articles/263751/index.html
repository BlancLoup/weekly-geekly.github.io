<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Secret constructor std :: shared_ptr</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This constructor is so secret, not even STL maintainers know about it ...  Stephan T. Lavavej 
 This constructor is so secret that even accompanying S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Secret constructor std :: shared_ptr</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  This constructor is so secret, not even STL maintainers know about it ... </blockquote>  <a href="https://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/ctfa8r5">Stephan T. Lavavej</a> <br><blockquote>  <i>This constructor is so secret that even accompanying STL do not know about it ...</i> </blockquote> lane: <a href="https://habrahabr.ru/users/door/" class="user_link">Door</a> <br><br>  <code>std::shared_ptr</code> has a small secret: a very useful constructor that most programmers haven‚Äôt even heard about.  It was added only in standard C ++ 11, and it was not even in the TR1 version of <code>shared_ptr</code> .  However, it is supported by gcc from version 4.3, and by the MSVC compiler from the time of Visual Studio 2010. It appeared in Boost from about 1.35.0. <br><br>  Most of the tutorials that describe <code>std::shared_ptr</code> have nothing about this constructor.  Scott Myers did not say a word about him in Effective Modern C ++, another author Nicolai Josuttis devoted to this designer about half a page in his book The C ++ Standard Library. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"> <a href="http://habrahabr.ru/post/263751/"><img src="https://habrastorage.org/files/e13/c98/ab8/e13c98ab89594042b7ccf47e51c8d5ea.jpeg"></a> </div><br><br>  So what is this secret constructor? <a name="habracut"></a><br><br>  This is a pseudonymous constructor (aliasing constructor). <br><br><h1>  Aliases shared_ptr </h1><br>  What does this constructor do?  It allows you to create <code>shared_ptr</code> , which shares ownership with another <code>shared_ptr</code> , but (attention!) Has a different pointer.  And I do not mean a pointer of another type, which was simply cast from one type to another, I am talking about a completely different value of the pointer.  That is, you can have both <code>shared_ptr&lt;std::string&gt;</code> and <code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code><code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code><code><code><code><code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code><code><code><code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code></code> at the same time <code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code><code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code><code><code><code><code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code><code><code><code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code></code> <code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code><code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code><code><code><code><code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code><code><code><code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> <h1> <code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code><code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code><code><code><code><code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code><code><code><code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> </h1> <code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code><code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code><code><code><code><code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code><code><code><code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cpp"><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,        (    -     ). <br> <br> ,     ,     <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span></code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class">{</span></span> Y y; };</code> <br>  ,      <code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span> .     :  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,      ,    ,    ,        Y.     ,    ,  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>   ,  px</code>    ? <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do_nothing_deleter</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T*)</span></span></span></span>{} }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">store_for_later</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;Y&gt;)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;X&gt; px(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt;X&gt;()); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } <span class="hljs-comment"><span class="hljs-comment">//  X </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><code><code><code><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       .   -          ,     </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .       X2,     Y,         </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">pimpl</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .   ,         ,   ,    .              .    X        ,     </span></span><code><code><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ). </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr  p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">*</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    .    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   .       </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">other.use_count()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   1. ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">get()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   -  </span></span><code><span class="hljs-comment"><span class="hljs-comment">static_cast&lt;T*&gt;(p)</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :  </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">use_count() == 0</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .      ,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    NULL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><br><span class="hljs-comment"><span class="hljs-comment">            </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,                . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,     ,          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/"><span class="hljs-comment"><span class="hljs-comment">  reddit</span></span></a><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr"><span class="hljs-comment"><span class="hljs-comment">   cppreference</span></span></a></code></code></code></code></code></code></code></code></code></code></code></code></code> </pre> <code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code><code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code><code><code><code><code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code><code><code><code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cpp"><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,        (    -     ). <br> <br> ,     ,     <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span></code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class">{</span></span> Y y; };</code> <br>  ,      <code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span> .     :  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,      ,    ,    ,        Y.     ,    ,  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>   ,  px</code>    ? <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do_nothing_deleter</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T*)</span></span></span></span>{} }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">store_for_later</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;Y&gt;)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;X&gt; px(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt;X&gt;()); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } <span class="hljs-comment"><span class="hljs-comment">//  X </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><code><code><code><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       .   -          ,     </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .       X2,     Y,         </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">pimpl</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .   ,         ,   ,    .              .    X        ,     </span></span><code><code><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ). </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr  p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">*</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    .    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   .       </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">other.use_count()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   1. ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">get()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   -  </span></span><code><span class="hljs-comment"><span class="hljs-comment">static_cast&lt;T*&gt;(p)</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :  </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">use_count() == 0</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .      ,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    NULL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><br><span class="hljs-comment"><span class="hljs-comment">            </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,                . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,     ,          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/"><span class="hljs-comment"><span class="hljs-comment">  reddit</span></span></a><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr"><span class="hljs-comment"><span class="hljs-comment">   cppreference</span></span></a></code></code></code></code></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code><code><code><code><code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code><code><code><code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cpp"><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,        (    -     ). <br> <br> ,     ,     <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span></code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class">{</span></span> Y y; };</code> <br>  ,      <code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span> .     :  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,      ,    ,    ,        Y.     ,    ,  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>   ,  px</code>    ? <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do_nothing_deleter</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T*)</span></span></span></span>{} }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">store_for_later</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;Y&gt;)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;X&gt; px(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt;X&gt;()); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } <span class="hljs-comment"><span class="hljs-comment">//  X </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><code><code><code><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       .   -          ,     </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .       X2,     Y,         </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">pimpl</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .   ,         ,   ,    .              .    X        ,     </span></span><code><code><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ). </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr  p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">*</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    .    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   .       </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">other.use_count()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   1. ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">get()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   -  </span></span><code><span class="hljs-comment"><span class="hljs-comment">static_cast&lt;T*&gt;(p)</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :  </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">use_count() == 0</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .      ,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    NULL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><br><span class="hljs-comment"><span class="hljs-comment">            </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,                . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,     ,          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/"><span class="hljs-comment"><span class="hljs-comment">  reddit</span></span></a><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr"><span class="hljs-comment"><span class="hljs-comment">   cppreference</span></span></a></code></code></code></code></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code><code><code><code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cpp"><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,        (    -     ). <br> <br> ,     ,     <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span></code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class">{</span></span> Y y; };</code> <br>  ,      <code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span> .     :  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,      ,    ,    ,        Y.     ,    ,  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>   ,  px</code>    ? <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do_nothing_deleter</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T*)</span></span></span></span>{} }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">store_for_later</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;Y&gt;)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;X&gt; px(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt;X&gt;()); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } <span class="hljs-comment"><span class="hljs-comment">//  X </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><code><code><code><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       .   -          ,     </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .       X2,     Y,         </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">pimpl</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .   ,         ,   ,    .              .    X        ,     </span></span><code><code><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ). </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr  p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">*</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    .    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   .       </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">other.use_count()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   1. ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">get()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   -  </span></span><code><span class="hljs-comment"><span class="hljs-comment">static_cast&lt;T*&gt;(p)</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :  </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">use_count() == 0</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .      ,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    NULL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><br><span class="hljs-comment"><span class="hljs-comment">            </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,                . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,     ,          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/"><span class="hljs-comment"><span class="hljs-comment">  reddit</span></span></a><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr"><span class="hljs-comment"><span class="hljs-comment">   cppreference</span></span></a></code></code></code></code></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code><code><code><code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> <h1> <code><code><code><code><code><code><code><code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> </h1> <code><code><code><code><code><code><code><code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cpp"><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,        (    -     ). <br> <br> ,     ,     <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span></code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class">{</span></span> Y y; };</code> <br>  ,      <code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span> .     :  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,      ,    ,    ,        Y.     ,    ,  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>   ,  px</code>    ? <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do_nothing_deleter</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T*)</span></span></span></span>{} }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">store_for_later</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;Y&gt;)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;X&gt; px(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt;X&gt;()); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } <span class="hljs-comment"><span class="hljs-comment">//  X </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><code><code><code><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       .   -          ,     </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .       X2,     Y,         </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">pimpl</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .   ,         ,   ,    .              .    X        ,     </span></span><code><code><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ). </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr  p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">*</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    .    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   .       </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">other.use_count()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   1. ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">get()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   -  </span></span><code><span class="hljs-comment"><span class="hljs-comment">static_cast&lt;T*&gt;(p)</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :  </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">use_count() == 0</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .      ,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    NULL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><br><span class="hljs-comment"><span class="hljs-comment">            </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,                . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,     ,          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/"><span class="hljs-comment"><span class="hljs-comment">  reddit</span></span></a><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr"><span class="hljs-comment"><span class="hljs-comment">   cppreference</span></span></a></code></code></code></code></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code><code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> <pre> <code class="hljs cpp"><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,        (    -     ). <br> <br> ,     ,     <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span></code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class">{</span></span> Y y; };</code> <br>  ,      <code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>, px</code>            <code>px-&gt;y</code> ,    <code><code><code><code><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span> .     :  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>,      ,    ,    ,        Y.     ,    ,  <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>   ,  px</code>    ? <br> <br> <code class="cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do_nothing_deleter</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T*)</span></span></span></span>{} }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">store_for_later</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;Y&gt;)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;X&gt; px(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt;X&gt;()); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } <span class="hljs-comment"><span class="hljs-comment">//  X </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><code><code><code><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       .   -          ,     </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .       X2,     Y,         </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">       ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">pimpl</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .   ,         ,   ,    .              .    X        ,     </span></span><code><code><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ). </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><code><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr  p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">*</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    .    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   .       </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">other.use_count()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   1. ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">get()</span></span></code><span class="hljs-comment"><span class="hljs-comment">   -  </span></span><code><span class="hljs-comment"><span class="hljs-comment">static_cast&lt;T*&gt;(p)</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :  </span></span><code><span class="hljs-comment"><span class="hljs-comment">other</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,   </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">use_count() == 0</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .      ,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">p</span></span></code><span class="hljs-comment"><span class="hljs-comment">    NULL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cpp"><span class="hljs-comment"><span class="hljs-comment">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     </span></span><br><span class="hljs-comment"><span class="hljs-comment">            </span></span><code><span class="hljs-comment"><span class="hljs-comment">shared_ptr</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,                . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,     ,          . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/"><span class="hljs-comment"><span class="hljs-comment">  reddit</span></span></a><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr"><span class="hljs-comment"><span class="hljs-comment">   cppreference</span></span></a></code></code></code></code></code></code></code></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code><code><code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code><code><code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code><code><code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code><code><code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code><code><code><code><code><code><code><code>shared_ptr,        (    -     ). <br> <br> ,     ,     shared_ptr'</code>   .       ,   ,  ,      . <br> <br>        ,      ?     <code>shared_ptr</code> ,     ( , )       . <br> <br>    <br> ,    X,    Y,      <br> <br> <code class="cpp">struct X{ Y y; };</code> <br>  ,      <code>shared_ptr, px</code>            <code>px-&gt;y</code> ,    <code>shared_ptr .     :  shared_ptr,      ,    ,    ,        Y.     ,    ,  shared_ptr   ,  px</code>    ? <br> <br> <code class="cpp">struct do_nothing_deleter{ template&lt;typename&gt; void operator()(T*){} }; void store_for_later(std::shared_ptr&lt;Y&gt;); void foo(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(&amp;px-&gt;y,do_nothing_deleter()); store_for_later(py); } //  X </code> <br>  <code class="cpp">shared_ptr     , ,  , .    ,    .  ,    ,    ,     shared_ptr  shared_ptr.  shared_ptr    . <br> <br> void bar(){ std::shared_ptr&lt;X&gt; px(std::make_shared&lt;X&gt;()); std::shared_ptr&lt;Y&gt; py(px,&amp;px-&gt;y); store_for_later(py); } //  X   </code> <br>       .   -          ,     <code>shared_ptr</code> .       X2,     Y,         <br> <br> <code class="cpp">struct X2{ std::unique_ptr&lt;Y&gt; y; X2():y(new Y){} }; void baz(){ std::shared_ptr&lt;X2&gt; px(std::make_shared&lt;X2&gt;()); std::shared_ptr&lt;Y&gt; py(px,px-&gt;y.get()); store_for_later(py); } //  X2   </code> <br>       ,    <code>pimpl</code> .   ,         ,   ,    .              .    X        ,     <code>shared_ptr,     shared_ptr      ,  shared_ptr      (..   reset()</code> ). <br> <br>  <br>  : <br> <br> <code class="cpp">template&lt;typename Other,typename Target&gt; shared_ptr(shared_ptr&lt;Other&gt; const&amp; other,Target* p);</code> <br>     <code>shared_ptr  p</code>    <code>*</code> ,    .    <code>Other</code>   .       <code>other</code> ,   <code>other.use_count()</code>   1. ,   <code>get()</code>   -  <code>static_cast&lt;T*&gt;(p)</code> . <br> <br>   :  <code>other</code>   <code>shared_ptr</code> , ,    ,   <code>shared_ptr</code>   ,    <code>use_count() == 0</code> .      ,  <code>p</code>    NULL. <br> <br> <code class="cpp">int i; shared_ptr&lt;int&gt; sp(shared_ptr&lt;X&gt;(),&amp;i); assert(sp.use_count()==0); assert(sp.get()==&amp;i);</code> <br>          . <br> <br>     <br>            <code>shared_ptr</code> ,                . <br> <br> ,     ,          . <br> <br>    <a href="http://www.reddit.com/r/cpp/comments/3eia29/stdshared_ptrs_secret_constructor/">  reddit</a> <br> <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr/shared_ptr">   cppreference</a></code></code></code></code></code></code></code></code></code></code></code></code></code> </div><p>Source: <a href="https://habr.com/ru/post/263751/">https://habr.com/ru/post/263751/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263739/index.html">Nutanix Cloud Connect - Backup to the AWS Cloud</a></li>
<li><a href="../263741/index.html">Angular.js persistent storage</a></li>
<li><a href="../263745/index.html">Microsoft Research grant for Azure cloud resources for research from Russia opened</a></li>
<li><a href="../263747/index.html">Switching audio tracks in Flash using Wowza2 RTMP server</a></li>
<li><a href="../263749/index.html">Inventing a bike on Scala - your ORM Framework, WebServer (RESTful and MVC)</a></li>
<li><a href="../263753/index.html">Search for similar groups and public Vkontakte</a></li>
<li><a href="../263755/index.html">Cybercriminals revived Darkode forum</a></li>
<li><a href="../263757/index.html">Skills of .NET-developer of Russia and the USA, what's the difference?</a></li>
<li><a href="../263759/index.html">Android found vulnerabilities that allow access to a smartphone via MMS</a></li>
<li><a href="../263761/index.html">GNS3 in the cloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>