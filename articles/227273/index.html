<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Interactive redirection to an exploit kit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Exploit kits are used by hackers to automatically install malicious code on a user's computer. In order for the user to be on the ‚Äúlanding page‚Äù itsel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Interactive redirection to an exploit kit</h1><div class="post__text post__text-html js-mediator-article">  Exploit kits are used by hackers to automatically install malicious code on a user's computer.  In order for the user to be on the ‚Äúlanding page‚Äù itself (landing page), which will select the desired type of exploit that corresponds to the user's browser environment, it must be redirected to it.  This redirection may occur from legitimate websites that have been compromised by malicious content (javascript or iframe). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e09/a8e/736/e09a8e736561d99f296c10afb4ecb88a.jpg"><br><br>  Thus, the usual scenario of using exploit kits by attackers is to compromise a legitimate web resource from which the user is redirected to malicious content.  This week we are faced with an interesting variation on how the user is redirected to the page of one of the exploit kits.  On the compromised web page, we found malicious code that can interact with the user, displaying a fake message about the browser‚Äôs work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><img src="https://habrastorage.org/getpro/habr/post_images/8f4/bdf/881/8f4bdf88114b48d030887df6dfb04998.png"><br>  Fig.  Fake message generated by malicious code. <br><br>  The code that is responsible for user interaction through such a message is executed in the form of an HTML form embedded in a web page.  The window is displayed only when the user views the page in Internet Explorer.  We also noticed that this form sends some data to the server in a POST request. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c4f/e73/447/c4fe734476b30173fab59c25b9c47ab8.png"><br>  Fig.  Malicious content embedded in a webpage. <br><br>  Regardless of which answer option the user chooses (Cancel or OK), he will be redirected to the Angler exploit kit exploit page.  To perform a redirect, a POST request specified in the screenshot will be sent via the form, which will return a small fragment of HTML and JavaScript code.  This code will redirect to the final URL. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/af5/fc6/be0/af5fc6be0771c0e765db683917f9d42b.png"><br>  Fig.  URL of the intermediate webpage. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/daa/f01/cd1/daaf01cd1e24ec32986b402fb40ca2ec.png"><br>  Fig.  Complete chain of redirects and end exploitation. <br><br>  Now back to the data that is sent in the POST request.  It can be seen that they are encoded in Base64 format.  Below is their transcript. <br><br>  The original string. <br><br>  ua_base64 = <br>  "TlP7Vt89hmr1vjdAW8YqmDT / sGFiyxROsPBX45R6HxinEeZC + YGrgEA0mmA3NDEJUYzgWm29EKShU2QPqxBXzVNMJvpfJN3Q <br>  cVGGehPCNNXOlxo0JE94z0RTBgCq0VubolrWHmAexV14 + cqx6qILC6z1EZDl4JFYd32wrMZrhNinl47lzpnvXwPluNsmh0CA ¬ª <br><br>  Decoded string <br><br>  base64.b64decode (ua_base64) = <br>  "\ xb6S \ xfbV \ xdf = \ x86j \ xf5 \ xbe7 @ [\ xc6 * \ x984 \ xff \ xb0ab \ xcb \ x14N \ xb0 \ xf0W \ xe3 \ x94z \ x1f \ x18 \ xa7 \ x11 \ xe6B \ xf9 \ x81 \ xab \ x80 @ 4 \ x9a`741 \ <br>  tQ \ x8c \ xe0Zm \ xbd \ x10 \ xa4 \ xa1Sd \ x0f \ xab \ x10W \ xcdSL &amp; \ xfa _ $ \ xdd \ xc24 \ xd5 \ xc \ xc \ xc \ xc \ x97 \ xd \ xd \ xx \ xc \ xd \ xc \ xc \ xd \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xc \ xd \ \ xaa \ xd1 [ <br>  \ x9b \ xa2Z \ xd6 \ x1e` \ x1e \ xc5] x \ xf9 \ xca \ xb1 \ xea \ xa2 \ x0b \ x0b \ xac \ xf5 \ x11 \ x90 \ xe5 \ xe0 \ x91Xw \ xb0 \ xac \ xc6k \ x84 \ xd8 \ xa7 \ x97 \ x8e \ xe5 \ xce \ x99 <br>  \ xef_ \ x03 \ xe5 \ xb8 \ xdb &amp; \ x87 @ \ x80 " <br><br>  By the name of the parameter ‚Äúua‚Äù, one can guess that this data is the encrypted User-Agent string used by the browser user.  In our example, it looks like this. <br><br>  Mozilla / 4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident / 4.0; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET4.0C; .NET4.0E; BOIE8; ENUSMSCOM). <br><br>  It can be assumed that the parameters specified in the HTML code of the form (see the screenshot above) are encrypted using XOR using the same keystream.  To do this, you can apply the XOR operation to the decoded via base64 string, which contains the User-Agent c keystream in the form of the User-Agent string already known to us (translated into lower case).  We can use the resulting value as a keystream to decrypt the furl parameter (see the screenshot above).  As a result of this operation, we get the original URL of the exploit kit web page.  To do this, you can use the following code in Python. <br><br><blockquote>  import base64 <br>  def xor (message, key): <br>  decrypted = "" <br>  for i in range (0, len (message)): <br>  decrypted + = chr (ord (message [i]) ^ ord (key [i% len (key)])) <br>  return (decrypted) <br><br>  ua = ‚ÄúMozilla / 4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident / 4.0; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET4.0C; .NET4.0E; BOIE8; ENUSMSCOM)‚Äù <br>  ua_plaintext = ua.lower () <br>  ua_base64 = "tlP7Vt89hmr1vjdAW8YqmDT / sGFiyxROsPBX45R6HxinEeZC + YGrgEA0mmA3NDEJUYzgWm29EKShU2QPqxBXzVNMJvpfJN3QcVGGehPCNNXOlxo0JE94z0RTBgCq0VubolrWHmAexV14 + cqx6qILC6z1EZDl4JFYd32wrMZrhNinl47lzpnvXwPluNsmh0CA" <br>  furl_base64 = ‚Äús0j1T4l + yCai5DANXd0gmz38sX5pwRVb / vhQpcU9Qlj8G6tQ5Nc =‚Äù <br>  keystream = xor (base64.b64decode (ua_base64), ua_plaintext) <br>  print ‚ÄúDecrypted furl:‚Äù <br>  print (xor (base64.b64decode (furl_base64), keystream)) </blockquote><br><br>  $ python angler-dexor.py <br><br>  Decrypted furl parameter: <br>  hxxp: //cct7m.xenybuvifd.net/4genk1met8 <br><br>  The cybercrime practice of interactivity (user interaction), when performing a redirection operation, is designed to avoid detection of the final URL of the payload by the automatic analysis systems. <br><br>  Malicious code that is installed on a computer using this set of exploits is detected by ESET antivirus products as <a href="http://www.virusradar.com/en/Win32_PSW.Papras.CX/description">Win32 / PSW.Papras.CX</a> . </div><p>Source: <a href="https://habr.com/ru/post/227273/">https://habr.com/ru/post/227273/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../227255/index.html">Automobile race and service testing</a></li>
<li><a href="../227257/index.html">Brave new world: mobile operators, as the largest providers of advertising data</a></li>
<li><a href="../227261/index.html">The government is ready to pay for Russian studies in foreign universities</a></li>
<li><a href="../227265/index.html">Data center cyclopic sizes and Tier IV, how can this be? Meet - SuperNAP 8</a></li>
<li><a href="../227267/index.html">How a startup can fly out of the index overnight</a></li>
<li><a href="../227275/index.html">City drones and smart cities</a></li>
<li><a href="../227277/index.html">How we wrote helpdesk</a></li>
<li><a href="../227279/index.html">Who and why is ‚Äúspying‚Äù on Yandex?</a></li>
<li><a href="../227281/index.html">GoogleDocs integration with Redmine</a></li>
<li><a href="../227283/index.html">Swift hackathon based on WWDC 2014 from CocoaHeads Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>