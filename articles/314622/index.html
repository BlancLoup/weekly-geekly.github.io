<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up email notifications in MS SQL Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 


 Often there is a need in some way to inform administrators about problems encountered on the server. And most of the notifications are di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up email notifications in MS SQL Server</h1><div class="post__text post__text-html js-mediator-article"><h3>  Foreword </h3><br><p>  Often there is a need in some way to inform administrators about problems encountered on the server.  And most of the notifications are divided into 2 types: </p><br><p>  1) real time, i.e. those that should come immediately when a problem occurs <br>  2) deferred time, i.e. those that arrive after a sufficiently long time (more than 1 hour) after the occurrence of the problem. </p><br><p>  In my work it was necessary to expand the functionality of the usual Database Mail. </p><br><p>  This article will look at an example of how to generate notifications in HTML tables and then mail them to administrators. </p><br><a name="habracut"></a><br><h3>  Decision </h3><br><p>  <strong>1.</strong> Set up <a href="https://msdn.microsoft.com/ru-ru/library/ms186358(v%3Dsql.120).aspx">Database Mail</a> <br>  <strong>2.</strong> Create a table for recipients: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[Recipient]( [Recipient_GUID] [uniqueidentifier] ROWGUIDCOL <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Recipient_Name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">--    [Recipient_Code] [nvarchar](10) NOT NULL, --  [IsDeleted] [bit] NOT NULL, --  (   ) [InsertUTCDate] [datetime] NOT NULL, CONSTRAINT [PK_Recipient] PRIMARY KEY CLUSTERED ( [Recipient_GUID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY], CONSTRAINT [AK_Recipient_Code] UNIQUE NONCLUSTERED ( [Recipient_Code] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY], CONSTRAINT [AK_Recipient_Name] UNIQUE NONCLUSTERED ( [Recipient_Name] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY] ) ON [PRIMARY] GO ALTER TABLE [srv].[Recipient] ADD CONSTRAINT [DF_Recipient_Recipient_GUID] DEFAULT (newsequentialid()) FOR [Recipient_GUID] GO ALTER TABLE [srv].[Recipient] ADD CONSTRAINT [DF_Recipient_IsDeleted] DEFAULT ((0)) FOR [IsDeleted] GO ALTER TABLE [srv].[Recipient] ADD CONSTRAINT [DF_Recipient_InsertUTCDate] DEFAULT (getutcdate()) FOR [InsertUTCDate] GO</span></span></code> </pre> </div></div><br><p>  <strong>3.</strong> Create a table for recipient addresses: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[Address]( [Address_GUID] [uniqueidentifier] ROWGUIDCOL <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Recipient_GUID] [uniqueidentifier] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- [Address] [nvarchar](255) NOT NULL, --  [IsDeleted] [bit] NOT NULL, --  (   ) [InsertUTCDate] [datetime] NOT NULL, CONSTRAINT [PK_Address] PRIMARY KEY CLUSTERED ( [Address_GUID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY], CONSTRAINT [AK_Address] UNIQUE NONCLUSTERED ( [Recipient_GUID] ASC, [Address] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY] ) ON [PRIMARY] GO ALTER TABLE [srv].[Address] ADD CONSTRAINT [DF_Address_Address_GUID] DEFAULT (newsequentialid()) FOR [Address_GUID] GO ALTER TABLE [srv].[Address] ADD CONSTRAINT [DF_Address_IsDeleted] DEFAULT ((0)) FOR [IsDeleted] GO ALTER TABLE [srv].[Address] ADD CONSTRAINT [DF_Address_InsertUTCDate] DEFAULT (getutcdate()) FOR [InsertUTCDate] GO</span></span></code> </pre> </div></div><br><p>  <strong>4.</strong> Create a table for the message queue: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ErrorInfo]( [ErrorInfo_GUID] [uniqueidentifier] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ERROR_TITLE] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- [ERROR_PRED_MESSAGE] [nvarchar](max) NULL, --  [ERROR_NUMBER] [nvarchar](max) NULL, --  () [ERROR_MESSAGE] [nvarchar](max) NULL, -- [ERROR_LINE] [nvarchar](max) NULL, --  [ERROR_PROCEDURE] [nvarchar](max) NULL, --  [ERROR_POST_MESSAGE] [nvarchar](max) NULL, --  [RECIPIENTS] [nvarchar](max) NULL, --  ';' [InsertDate] [datetime] NOT NULL, [StartDate] [datetime] NOT NULL, --    [FinishDate] [datetime] NOT NULL, --    [Count] [int] NOT NULL, ---  [UpdateDate] [datetime] NOT NULL, [IsRealTime] [bit] NOT NULL, --   [InsertUTCDate] [datetime] NULL, CONSTRAINT [PK_ErrorInfo] PRIMARY KEY CLUSTERED ( [ErrorInfo_GUID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY] ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] GO ALTER TABLE [srv].[ErrorInfo] ADD CONSTRAINT [DF_ErrorInfo_ErrorInfo_GUID] DEFAULT (newid()) FOR [ErrorInfo_GUID] GO ALTER TABLE [srv].[ErrorInfo] ADD CONSTRAINT [DF_ErrorInfo_InsertDate] DEFAULT (getdate()) FOR [InsertDate] GO ALTER TABLE [srv].[ErrorInfo] ADD CONSTRAINT [DF_ErrorInfo_StartDate] DEFAULT (getdate()) FOR [StartDate] GO ALTER TABLE [srv].[ErrorInfo] ADD CONSTRAINT [DF_ErrorInfo_FinishDate] DEFAULT (getdate()) FOR [FinishDate] GO ALTER TABLE [srv].[ErrorInfo] ADD CONSTRAINT [DF_ErrorInfo_Count] DEFAULT ((1)) FOR [Count] GO ALTER TABLE [srv].[ErrorInfo] ADD CONSTRAINT [DF__ErrorInfo__Updat__5FFEE747] DEFAULT (getdate()) FOR [UpdateDate] GO ALTER TABLE [srv].[ErrorInfo] ADD CONSTRAINT [DF_ErrorInfo_IsRealTime] DEFAULT ((0)) FOR [IsRealTime] GO ALTER TABLE [srv].[ErrorInfo] ADD CONSTRAINT [DF_ErrorInfo_InsertUTCDate] DEFAULT (getutcdate()) FOR [InsertUTCDate] GO</span></span></code> </pre> </div></div><br><p>  <strong>5.</strong> Create an archive table for sent messages from the message queue: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ErrorInfoArchive]( [ErrorInfo_GUID] [uniqueidentifier] ROWGUIDCOL <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ERROR_TITLE] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ERROR_PRED_MESSAGE] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ERROR_NUMBER] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ERROR_MESSAGE] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ERROR_LINE] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ERROR_PROCEDURE] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ERROR_POST_MESSAGE] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [RECIPIENTS] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [StartDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [FinishDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [UpdateDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [IsRealTime] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertUTCDate] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_ArchiveErrorInfo] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [ErrorInfo_GUID] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ErrorInfoArchive] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_ErrorInfoArchive_ErrorInfo_GUID] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (newsequentialid()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [ErrorInfo_GUID] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ErrorInfoArchive] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_ArchiveErrorInfo_InsertDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [InsertDate] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ErrorInfoArchive] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_ErrorInfoArchive_StartDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [StartDate] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ErrorInfoArchive] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_ErrorInfoArchive_FinishDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [FinishDate] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ErrorInfoArchive] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_ErrorInfoArchive_Count] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> ((<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ErrorInfoArchive] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_ErrorInfoArchive_UpdateDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [UpdateDate] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ErrorInfoArchive] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_ErrorInfoArchive_IsRealTime] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> ((<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [IsRealTime] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[ErrorInfoArchive] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_ErrorInfoArchive_InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> </div></div><br><p>  This information is needed for history.  But also this table should be cleaned from very old data (for example, older than a month). </p><br><p>  <strong>6.</strong> Create a stored procedure that registers a new message in the message queue: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[ErrorInfoIncUpd] @ERROR_TITLE <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @ERROR_PRED_MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @ERROR_NUMBER <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @ERROR_MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @ERROR_LINE <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @ERROR_PROCEDURE <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @ERROR_POST_MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @RECIPIENTS <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @StartDate datetime=<span class="hljs-literal"><span class="hljs-literal">null</span></span>, @FinishDate datetime=<span class="hljs-literal"><span class="hljs-literal">null</span></span>, @IsRealTime <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-comment"><span class="hljs-comment">/*                  ,    ,     ,   ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @ErrorInfo_GUID uniqueidentifier; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top <span class="hljs-number"><span class="hljs-number">1</span></span> @ErrorInfo_GUID=ErrorInfo_GUID <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> srv.ErrorInfo <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> (ERROR_TITLE=@ERROR_TITLE <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> @ERROR_TITLE <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> RECIPIENTS=@RECIPIENTS <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (ERROR_MESSAGE=@ERROR_MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> @ERROR_MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (ERROR_PRED_MESSAGE=@ERROR_PRED_MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> @ERROR_PRED_MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (ERROR_POST_MESSAGE=@ERROR_POST_MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> @ERROR_POST_MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (IsRealTime=@IsRealTime <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> @IsRealTime <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>); if(@ErrorInfo_GUID is null) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> srv.ErrorInfo ( ERROR_TITLE ,ERROR_PRED_MESSAGE ,ERROR_NUMBER ,ERROR_MESSAGE ,ERROR_LINE ,ERROR_PROCEDURE ,ERROR_POST_MESSAGE ,RECIPIENTS ,IsRealTime ,StartDate ,FinishDate ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @ERROR_TITLE ,@ERROR_PRED_MESSAGE ,@ERROR_NUMBER ,@ERROR_MESSAGE ,@ERROR_LINE ,@ERROR_PROCEDURE ,@ERROR_POST_MESSAGE ,@RECIPIENTS ,@IsRealTime ,<span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(@StartDate, <span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) ,<span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(@FinishDate,<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> srv.ErrorInfo <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> FinishDate=<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>(), [<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>]=[<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>]+<span class="hljs-number"><span class="hljs-number">1</span></span>, UpdateDate=<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ErrorInfo_GUID=@ErrorInfo_GUID; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> </div></div><br><p>  <strong>7.</strong> Create a stored procedure that returns a string from the addresses by the code or the main email address of the recipient: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[GetRecipients] @Recipient_Name <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @Recipient_Code <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @Recipients <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @Recipients=<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @Recipients=@Recipients+d.[Address]+<span class="hljs-string"><span class="hljs-string">';'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> srv.Recipient <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> srv.[Address] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> r.Recipient_GUID=d.Recipient_GUID <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> (r.Recipient_Name=@Recipient_Name <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> @Recipient_Name <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (r.Recipient_Code=@Recipient_Code <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> @Recipient_Code <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r.IsDeleted=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> d.IsDeleted=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">--order by r.InsertUTCDate desc, d.InsertUTCDate desc; if(len(@Recipients)&gt;0) set @Recipients=substring(@Recipients,1,len(@Recipients)-1); END GO</span></span></code> </pre> </div></div><br><p>  <strong>8.</strong> Create the necessary functions for working with date and time: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> [rep].[GetDateFormat] ( @dt datetime, <span class="hljs-comment"><span class="hljs-comment">--   @format int=0 --   ) RETURNS nvarchar(255) AS /*              :     0 17.4.2014 "17.04.2014" 1 17.4.2014 "04.2014" 1 8.11.2014 "11.2014" 2 17.04.2014 "2014" */ BEGIN DECLARE @res nvarchar(255); DECLARE @day int=DAY(@dt); DECLARE @month int=MONTH(@dt); DECLARE @year int=YEAR(@dt); if(@format=0) begin set @res=IIF(@day&lt;10,'0'+cast(@day as nvarchar(1)), cast(@day as nvarchar(2)))+'.'; set @res=@res+IIF(@month&lt;10,'0'+cast(@month as nvarchar(1)), cast(@month as nvarchar(2)))+'.'; set @res=@res+cast(@year as nvarchar(255)); end else if(@format=1) begin set @res=IIF(@month&lt;10,'0'+cast(@month as nvarchar(1)), cast(@month as nvarchar(2)))+'.'; set @res=@res+cast(@year as nvarchar(255)); end else if(@format=2) begin set @res=cast(@year as nvarchar(255)); end RETURN @res; END GO USE [__] GO SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE FUNCTION [rep].[GetTimeFormat] ( @dt datetime, --   @format int=0 --   ) RETURNS nvarchar(255) AS /*              :     0 17:04 "17:04:00" 1 17:04 "17:04" 1 8:04 "08:04" 2 17:04 "17" */ BEGIN DECLARE @res nvarchar(255); DECLARE @hour int=DATEPART(HOUR, @dt); DECLARE @min int=DATEPART(MINUTE, @dt); DECLARE @sec int=DATEPART(SECOND, @dt); if(@format=0) begin set @res=IIF(@hour&lt;10,'0'+cast(@hour as nvarchar(1)), cast(@hour as nvarchar(2)))+':'; set @res=@res+IIF(@min&lt;10,'0'+cast(@min as nvarchar(1)), cast(@min as nvarchar(2)))+':'; set @res=@res+IIF(@sec&lt;10,'0'+cast(@sec as nvarchar(1)), cast(@sec as nvarchar(2))); end else if(@format=1) begin set @res=IIF(@hour&lt;10,'0'+cast(@hour as nvarchar(1)), cast(@hour as nvarchar(2)))+':'; set @res=@res+IIF(@min&lt;10,'0'+cast(@min as nvarchar(1)), cast(@min as nvarchar(2))); end else if(@format=2) begin set @res=IIF(@hour&lt;10,'0'+cast(@hour as nvarchar(1)), cast(@hour as nvarchar(2))); end RETURN @res; END GO</span></span></code> </pre> </div></div><br><p>  <strong>9.</strong> Create a stored procedure that creates an HTML report in the form of a table by message: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[GetHTMLTable] @recipients <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) ,@dt datetime <span class="hljs-comment"><span class="hljs-comment">--     AS BEGIN /*  HTML-   */ SET NOCOUNT ON; declare @body nvarchar(max); declare @tbl table(ID int identity(1,1) ,[ERROR_TITLE] nvarchar(max) ,[ERROR_PRED_MESSAGE] nvarchar(max) ,[ERROR_NUMBER] nvarchar(max) ,[ERROR_MESSAGE] nvarchar(max) ,[ERROR_LINE] nvarchar(max) ,[ERROR_PROCEDURE] nvarchar(max) ,[ERROR_POST_MESSAGE] nvarchar(max) ,[InsertDate] datetime ,[StartDate] datetime ,[FinishDate] datetime ,[Count] int ); declare @ID int ,@ERROR_TITLE nvarchar(max) ,@ERROR_PRED_MESSAGE nvarchar(max) ,@ERROR_NUMBER nvarchar(max) ,@ERROR_MESSAGE nvarchar(max) ,@ERROR_LINE nvarchar(max) ,@ERROR_PROCEDURE nvarchar(max) ,@ERROR_POST_MESSAGE nvarchar(max) ,@InsertDate datetime ,@StartDate datetime ,@FinishDate datetime ,@Count int insert into @tbl( [ERROR_TITLE] ,[ERROR_PRED_MESSAGE] ,[ERROR_NUMBER] ,[ERROR_MESSAGE] ,[ERROR_LINE] ,[ERROR_PROCEDURE] ,[ERROR_POST_MESSAGE] ,[InsertDate] ,[StartDate] ,[FinishDate] ,[Count] ) select top 100 [ERROR_TITLE] ,[ERROR_PRED_MESSAGE] ,[ERROR_NUMBER] ,[ERROR_MESSAGE] ,[ERROR_LINE] ,[ERROR_PROCEDURE] ,[ERROR_POST_MESSAGE] ,[InsertDate] ,[StartDate] ,[FinishDate] ,[Count] from [srv].[ErrorInfo] where ([RECIPIENTS]=@recipients) or (@recipients IS NULL) and InsertDate&lt;=@dt --order by InsertDate asc; set @body='&lt;TABLE BORDER=5&gt;'; set @body=@body+'&lt;TR&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+'‚Ññ /'; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+' '; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+' '; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+''; set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;/TR&gt;'; while((select top 1 1 from @tbl)&gt;0) begin set @body=@body+'&lt;TR&gt;'; select top 1 @ID =[ID] ,@ERROR_TITLE =[ERROR_TITLE] ,@ERROR_PRED_MESSAGE=[ERROR_PRED_MESSAGE] ,@ERROR_NUMBER =[ERROR_NUMBER] ,@ERROR_MESSAGE =[ERROR_MESSAGE] ,@ERROR_LINE =[ERROR_LINE] ,@ERROR_PROCEDURE =[ERROR_PROCEDURE] ,@ERROR_POST_MESSAGE=[ERROR_POST_MESSAGE] ,@InsertDate =[InsertDate] ,@StartDate =[StartDate] ,@FinishDate =[FinishDate] ,@Count =[Count] from @tbl order by InsertDate asc; set @body=@body+'&lt;TD&gt;'; set @body=@body+cast(@ID as nvarchar(max)); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+rep.GetDateFormat(@InsertDate, default)+' '+rep.GetTimeFormat(@InsertDate, default);--cast(@InsertDate as nvarchar(max)); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+isnull(@ERROR_TITLE,''); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+isnull(@ERROR_PRED_MESSAGE,''); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+isnull(@ERROR_NUMBER,''); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+isnull(@ERROR_MESSAGE,''); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+rep.GetDateFormat(@StartDate, default)+' '+rep.GetTimeFormat(@StartDate, default);--cast(@StartDate as nvarchar(max)); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+rep.GetDateFormat(@FinishDate, default)+' '+rep.GetTimeFormat(@FinishDate, default);--cast(@FinishDate as nvarchar(max)); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+cast(@Count as nvarchar(max)); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+isnull(@ERROR_LINE,''); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+isnull(@ERROR_PROCEDURE,''); set @body=@body+'&lt;/TD&gt;'; set @body=@body+'&lt;TD&gt;'; set @body=@body+isnull(@ERROR_POST_MESSAGE,''); set @body=@body+'&lt;/TD&gt;'; delete from @tbl where ID=@ID; set @body=@body+'&lt;/TR&gt;'; end set @body=@body+'&lt;/TABLE&gt;'; select @body; END GO</span></span></code> </pre> </div></div><br><p>  <strong>10.</strong> Create a stored procedure that sends messages: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[RunErrorInfoProc] @IsRealTime <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span> =<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">--   (1- ) AS BEGIN /*         */ SET NOCOUNT ON; declare @dt datetime=getdate(); declare @tbl table(Recipients nvarchar(max)); declare @recipients nvarchar(max); declare @recipient nvarchar(255); declare @result nvarchar(max)=''; declare @recp nvarchar(max); declare @ind int; declare @recipients_key nvarchar(max); --    insert into @tbl(Recipients) select [RECIPIENTS] from srv.ErrorInfo where InsertDate&lt;=@dt and IsRealTime=@IsRealTime group by [RECIPIENTS]; declare @rec_body table(Body nvarchar(max)); declare @body nvarchar(max); declare @query nvarchar(max); --    while((select top 1 1 from @tbl)&gt;0) begin --  select top (1) @recipients=Recipients from @tbl; set @recipients_key=@recipients; set @result=''; --   while(len(@recipients)&gt;0) begin set @ind=CHARINDEX(';', @recipients); if(@ind&gt;0) begin set @recipient=substring(@recipients,1, @ind-1); set @recipients=substring(@recipients,@ind+1,len(@recipients)-@ind); end else begin set @recipient=@recipients; set @recipients=''; end; --   exec [srv].[GetRecipients] @Recipient_Code=@recipient, @Recipients=@recp out; if(len(@recp)=0) begin exec [srv].[GetRecipients] @Recipient_Name=@recipient, @Recipients=@recp out; if(len(@recp)=0) set @recp=@recipient; end --  ';' set @result=@result+@recp+';'; end set @result=substring(@result,1,len(@result)-1); set @recipients=@result; -- HTML-      insert into @rec_body(Body) exec srv.GetHTMLTable @recipients=@recipients_key, @dt=@dt; -- HTML- select top (1) @body=Body from @rec_body; --   EXEC msdb.dbo.sp_send_dbmail --       @profile_name = 'ALARM', --   @recipients = @recipients, --   @body = @body, --  @subject = N'   ', @body_format='HTML'--, --        SQL- --@query = @query--'SELECT TOP 10 name FROM sys.objects'; delete from @tbl where Recipients=@recipients_key; delete from @rec_body; end --     INSERT INTO [srv].[ErrorInfoArchive] ([ErrorInfo_GUID] ,[ERROR_TITLE] ,[ERROR_PRED_MESSAGE] ,[ERROR_NUMBER] ,[ERROR_MESSAGE] ,[ERROR_LINE] ,[ERROR_PROCEDURE] ,[ERROR_POST_MESSAGE] ,[RECIPIENTS] ,[StartDate] ,[FinishDate] ,[Count] ,IsRealTime ) SELECT [ErrorInfo_GUID] ,[ERROR_TITLE] ,[ERROR_PRED_MESSAGE] ,[ERROR_NUMBER] ,[ERROR_MESSAGE] ,[ERROR_LINE] ,[ERROR_PROCEDURE] ,[ERROR_POST_MESSAGE] ,[RECIPIENTS] ,[StartDate] ,[FinishDate] ,[Count] ,IsRealTime FROM [srv].[ErrorInfo] where IsRealTime=@IsRealTime and InsertDate&lt;=@dt --order by InsertDate; --      delete from [srv].[ErrorInfo] where IsRealTime=@IsRealTime and InsertDate&lt;=@dt; END GO</span></span></code> </pre> </div></div><br><p>  This stored procedure takes each message from the message queue and wraps it into a HTML report in a table.  For recipients, by their code or primary email address creates a string consisting of email addresses.  The message is sent to these addresses.  And so all selected messages are processed.  This uses the <a href="https://msdn.microsoft.com/ru-ru/library/ms190307(v%3Dsql.110).aspx">msdb.dbo.sp_send_dbmail</a> stored procedure </p><br><p>  <strong>11.</strong> Let's create two tasks in the Agent (the first is for real-time notifications (the schedule is 1 time per minute), the second is for simple notifications (the schedule is 1 time per hour)).  Add the following to the task code: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> [__].[srv].[RunErrorInfoProc] @IsRealTime=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">--0     1    </span></span></code> </pre> <br><p>  Here is an example of registering an error: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> try exec [__].[srv].[KillFullOldConnect]; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> try <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> catch <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @str_mess <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>)=ERROR_MESSAGE(), @str_num <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>)=<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(ERROR_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>)), @str_line <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>)=<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(ERROR_LINE() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>)), @str_proc <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>)=ERROR_PROCEDURE(), @str_title <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>)=<span class="hljs-string"><span class="hljs-string">'     '</span></span>+@@servername, @str_pred_mess <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>)=<span class="hljs-string"><span class="hljs-string">' '</span></span>+@@servername+<span class="hljs-string"><span class="hljs-string">'      '</span></span>; exec [__].srv.ErrorInfoIncUpd @ERROR_TITLE = @str_title, @ERROR_PRED_MESSAGE = @str_pred_mess, @ERROR_NUMBER = @str_num, @ERROR_MESSAGE = @str_mess, @ERROR_LINE = @str_line, @ERROR_PROCEDURE = @str_proc, @ERROR_POST_MESSAGE = NULL, @RECIPIENTS = '1;2;'; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @err <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>=@@<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>; raiserror(@str_mess,16,1); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> catch</code> </pre> </div></div><br><p>  This uses the <a href="https://habrahabr.ru/post/314632/">srv.KillFullOldConnect</a> stored procedure </p><br><h3>  Result </h3><br><p>  This article has reviewed an example of expanding the functionality of the usual Database Mail, as well as an example of how to create notifications in HTML tables and then send them by mail to administrators.  This approach allows administrators to be notified of various problems in real time or after some specific time.  Thus, this approach allows minimizing in the future the onset of a critical problem and stopping the operation of the DBMS and the server, which in turn protects production from stopping the workflow. </p><br><h3>  Sources: </h3><br><p>  ¬ª <a href="https://msdn.microsoft.com/ru-ru/library/ms190307(v%3Dsql.110).aspx">Sp_send_dbmail</a> <br>  ¬ª <a href="https://msdn.microsoft.com/ru-ru/library/ms186358(v%3Dsql.120).aspx">Database Mail</a> <br>  ¬ª <a href="https://habrahabr.ru/post/314632/">Srv.KillFullOldConnect</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/314622/">https://habr.com/ru/post/314622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314610/index.html">Update Vivaldi 1.4 for Linux - the hunt for flash plugin</a></li>
<li><a href="../314612/index.html">Data Center and Digital Transformation</a></li>
<li><a href="../314616/index.html">A person. Anders Hejlsberg - creator of Turbo Pascal, Delphi and C #</a></li>
<li><a href="../314618/index.html">Once executed block in an arbitrary place of code (C ++ 11 and higher)</a></li>
<li><a href="../314620/index.html">Product Design Digest October 2016</a></li>
<li><a href="../314624/index.html">EF Core: Setting the name of the generated models in Scaffolding</a></li>
<li><a href="../314628/index.html">Auto-collection of data on completed tasks in MS SQL Server</a></li>
<li><a href="../314630/index.html">Auto-collection of data about changes in database schemas in MS SQL Server</a></li>
<li><a href="../314632/index.html">Automatic removal of hung processes in MS SQL Server</a></li>
<li><a href="../314642/index.html">Remote work: 50 shades of freedom</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>