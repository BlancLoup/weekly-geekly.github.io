<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Translation: 30 days Windows Mobile - second day (Winforms / –° # vs WinAPI / C)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, we continue to translate a cycle of articles 30 days. NET [Windows Mobile]. I remind you that two articles are translated at once for greater inte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Translation: 30 days Windows Mobile - second day (Winforms / –° # vs WinAPI / C)</h1><div class="post__text post__text-html js-mediator-article">  So, we continue to translate a cycle of articles 30 days. NET [Windows Mobile].  I remind you that two articles are translated at once for greater interest - from Chris Kraft's blog (Windows Forms - C #) and Christopher Fairbairn (WinAPI - C).  The second day is next - <b>control of bluetooth</b> .  Previous article from the cycle - <br>  <a href="http://habrahabr.ru/blogs/mobiledev/61248/">http://habrahabr.ru/blogs/mobiledev/61248/</a> . <br><br><a name="habracut"></a><br><h1>  Chris Kraft.  C # </h1><br>  The original is <a href="http://www.cjcraft.com/blog/2008/06/03/30DaysOfNETWindowsMobileApplicationsDay02BluetoothManager.aspx">here</a> . <br><br>  As you know, constantly turned on Bluetooth considerably reduces the lifetime of the phone.  In the standard Windows Mobile, there is no convenient way to turn bluetooth on and off, and on the way to work you want to easily turn it on and off so that you can talk through the headset!  An important feature - for this switch, I really do not want to have to look at the screen. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I decided to develop a really convenient application that switches the bluetooth state on startup, then waits for one minute and is automatically unloaded from memory.  Thus, it is enough to assign a call to the application to one of the hardware buttons and get the desired result. <br><br>  So, according to the <a title="Countdown to midnight" href="http://habrahabr.ru/blogs/mobiledev/61248/">countdown to midnight</a> , I have 2 hours 21 minutes and 6 seconds to develop this application. <br><br><h2>  Bluetooth manager </h2><br><img src="http://www.cjcraft.com/blog/content/binary/WindowsLiveWriter/30D.NETWindowsMobileApplicationsDay02Blu_1269B/image_thumb.png" align="left" hspace="5"><br>  I always loved my applications to be at least a little pleasing to the eye.  That is why in the upper part of the application you can see the bluetooth logo.  It is colored when bluetooth is active, and gray when bluetooth is turned off. <br><br>  I added a text field with a few lines of logging.  Also, in addition to the main task to switch the bluetooth state at the start of the application, I added two buttons to explicitly switch the state after the start. <br><br>  The only difficulty in the development - the need to use P / Invoke to work with Bluetooth.  Here are the necessary announcements: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[DllImport( <font color="#A31515">"BthUtil.dll"</font> )] <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">extern</font> <font color="#0000ff">int</font> BthGetMode( <font color="#0000ff">out</font> RadioMode dwMode); <br> <br> [DllImport( <font color="#A31515">"BthUtil.dll"</font> )] <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">extern</font> <font color="#0000ff">int</font> BthSetMode(RadioMode dwMode);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In addition, I also used the <a href="http%253A%252F%252Fwww.developer.com%252Fws%252Fpc%252Farticle.php%252F3547381">State and Notification Broker (SNAPI)</a> .  The bottom line is that if the state of bluetooth changes outside of our application, we will not know about this without SNAPI.  You can subscribe to almost any notice.  We will only subscribe to bluetooth: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">SystemState bluetoothStatePowerOn = <font color="#0000ff">new</font> SystemState(SystemProperty.BluetoothStatePowerOn); <br> bluetoothStatePowerOn.Changed += <font color="#0000ff">new</font> ChangeEventHandler(bluetoothStatePowerOn_Changed); <br> <br> <font color="#0000ff">void</font> bluetoothStatePowerOn_Changed( <font color="#0000ff">object</font> sender, ChangeEventArgs args) <br> { <br> UpdateScreen(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  And finally, we need to deal with the automatic termination of the application.  Everything is very simple - there is a timer that waits a minute, after which a loop is executed, at each iteration of which Thread.Sleep (1000) is called.  This creates an excellent effect and allows the user to understand that the application has not ended abnormally.  ( <em>Note: to be honest, I didn‚Äôt understand at all how these 10 seconds can help the user and what :) <b>UPD: they</b> understood, within 10 seconds a message is displayed that the application will turn off after X seconds.</em>  ) <br><br>  Source Code C #: <a title="bluetoothManager.zip" href="http%253A%252F%252Fcid-0779b8ef58de4561.skydrive.live.com%252Fself.aspx%252FPublic%252FBluetoothManager.zip">bluetoothManager.zip</a> . <br><br><h1>  Christopher Fairbairn.  WinAPI - C </h1><br>  The original is <a href="http://www.christec.co.nz/blog/archives/353">here</a> . <br><br><h2>  Bluetooth access </h2><br>  To begin with, the application only works on devices that use the Microsoft Bluetooth Stack.  Unlike other aspects of the platform, there are no fixed standards for bluetooth.  Each equipment manufacturer can choose everything that he considers best for his purposes. <br><br>  To use the Microsoft Bluetooth API, you need to connect the header file ‚Äúbthutil.h‚Äù and the library ‚Äúbthutil.lib‚Äù - see the <a title="BthSetMode" href="http://msdn.microsoft.com/en-us/library/aa916815.aspx">documentation</a> . <br><br>  To change the Bluetooth status, use the <a title="BthSetMode" href="http://msdn.microsoft.com/en-us/library/aa916815.aspx">BthSetMode</a> function: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//  Bluetooth</font> &lt;br/&gt; <br> BthSetMode(BTH_POWER_OFF);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  This function accepts the following constants as a parameter: <br><table border="1"><tbody><tr><td>  <b>Constant</b> </td><td>  <b>Description</b> </td></tr><tr><td>  BTH_POWER_OFF </td><td>  Turn off Bluetooth </td></tr><tr><td>  BTH_CONNECTABLE </td><td>  Bluetooth is turned on and other devices can connect to the device. </td></tr><tr><td>  BTH_DISCOVERABLE </td><td>  Bluetooth is turned on and other devices can detect and connect to the device. </td></tr></tbody></table><br><br>  We can also get the current Bluetooth status using <a title="BthGetMode" href="http://msdn.microsoft.com/en-us/library/aa916277.aspx">BthGetMode</a> : <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">DWORD dwMode = BTH_POWER_OFF; <br> BthGetMode(&amp;dwMode); <br> <br> <font color="#0000ff">if</font> (dwMode == BTH_CONNECTABLE) <br> { <br> <font color="#008000">//  -,  bluetooth </font> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h2>  Using a state broker and notifications </h2><br>  Instead of polling the system using <a title="BthGetMode" href="http://msdn.microsoft.com/en-us/library/aa916277.aspx">BthGetMode</a> by <a title="BthGetMode" href="http://msdn.microsoft.com/en-us/library/aa916277.aspx">timer</a> , it is more logical to use the subscription mechanism for notifications provided by the system. <br><br>  <a title="State and Notification Broker (SNAPI)" href="http://msdn.microsoft.com/en-us/library/aa455748.aspx">State and Notification Broker (SNAPI) is</a> built using the registry key monitoring mechanism.  We will need the following header files: ‚Äúregext.h‚Äù, which provides monitoring of the registry, and ‚Äúsnapi.h‚Äù, containing the necessary keys with system information. <br><br>  Let's use the <a title="RegistryNotifyWindow" href="http://msdn.microsoft.com/en-us/library/bb154480.aspx">RegistryNotifyWindow</a> function from ‚Äúregext.h‚Äù.  It monitors the registry key and sends a message to the specified window in case a change in value has occurred. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">HREGNOTIFY hregNotify; <br> <br> <font color="#008000">//      .</font> &lt;br/&gt; <br> NOTIFICATIONCONDITION condition = { <br> REG_CT_ANYCHANGE, <br> SN_BLUETOOTHSTATEPOWERON_BITMASK, 0 <br> }; <br> <br> <font color="#008000">//      BLUETOOTHSTATEPOWERON</font> &lt;br/&gt; <br> <font color="#008000">//    WM_BLUETOOTH_STATE_CHANGE</font> &lt;br/&gt; <br> <font color="#008000">//   'hdlg'.</font> &lt;br/&gt; <br> RegistryNotifyWindow(SN_BLUETOOTHSTATEPOWERON_ROOT, <br> SN_BLUETOOTHSTATEPOWERON_PATH, <br> SN_BLUETOOTHSTATEPOWERON_VALUE, <br> hDlg, <br> WM_BLUETOOTH_STATE_CHANGED, <br> 0, <br> &amp;condition, <br> &amp;hregNotify);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  By changing the parameters of the NOTIFICATIONCONDITION structure, we can subscribe to more complex events, including receiving a notification in the case, for example, if a certain threshold is exceeded. <br><br><h2>  Using buttons on the screen </h2><br>  The application uses two buttons.  When a user clicks any of them, a <a href="http://msdn.microsoft.com/en-us/library/aa930761.aspx">WM_COMMAND</a> message is sent to the <a href="http://msdn.microsoft.com/en-us/library/aa930761.aspx">dialog</a> : <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">case</font> WM_COMMAND: <br> <font color="#008000">// ,   </font> &lt;br/&gt; <br> <font color="#0000ff">switch</font> (LOWORD(wParam)) <br> { <br> <font color="#0000ff">case</font> IDC_BUTTON_POWERON: <br> <font color="#008000">// </font> &lt;br/&gt; <br> <font color="#0000ff">break</font> ; <br> <br> <font color="#0000ff">case</font> IDC_BUTTON_POWEROFF: <br> <font color="#008000">// </font> &lt;br/&gt; <br> <font color="#0000ff">break</font> ; <br> } <br> <font color="#0000ff">break</font> ;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h2>  Text field </h2><br>  To change the value of a text field (TextBox), you can use the <a title="SetWindowText" href="http://msdn.microsoft.com/en-us/library/ms942609.aspx">SetWindowText</a> function, just like for a static control: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">HWND hWndCtrl = GetDlgItem(hDlg, IDC_EDIT_LOG); <br> SetWindowText(hWndCtrl, L <font color="#A31515">"This is the new content"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Adding text to the end consists of two stages.  First we need to move the selection (cursor) to the end of the text with the <a title="EM_SETSEL" href="http://msdn.microsoft.com/en-us/library/aa932540.aspx">EM_SETSEL</a> message, and then replace the contents of the selection ( <em>Approx.</em> <a title="EM_SETSEL" href="http://msdn.microsoft.com/en-us/library/aa932540.aspx">Ln</a> <em>.: essentially a block of zero length</em> ) with the necessary text with the message <a title="EM_REPLACESEL" href="http://msdn.microsoft.com/en-us/library/aa929135.aspx">EM_REPLACESEL</a> : <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//    </font> &lt;br/&gt; <br> SendMessage(hWndCtrl, EM_SETSEL, -1, -1); <br> <br> <font color="#008000">//    </font> &lt;br/&gt; <br> <font color="#008000">// to append to the end of the edit control</font> &lt;br/&gt; <br> SendMessage(hWndCtrl, EM_REPLACESEL, FALSE, <br> (LPARAM)L <font color="#A31515">"Text to add"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h2>  Display image </h2><br>  In the Compact Framework, you can do with <a title="Picturebox" href="http://msdn.microsoft.com/en-us/library/system.windows.forms.picturebox.aspx">PictureBox</a> controls.  We will continue to use the static control by sending the <a title="STM_SETIMAGE" href="http://msdn.microsoft.com/en-us/library/aa930092.aspx">STM_SETIMAGE</a> message to <a title="STM_SETIMAGE" href="http://msdn.microsoft.com/en-us/library/aa930092.aspx">it</a> : <br><br><blockquote> <code><font color="black"><font color="#008000">// </font> &lt;br/&gt; <br> HWND hWndCtrl = GetDlgItem(hDlg, IDC_STATUS_BITMAP); <br> <br> <font color="#008000">//    </font> &lt;br/&gt; <br> HBITMAP hBitmap = LoadBitmap(GetModuleHandle(NULL), <br> MAKEINTRESOURCE(IDB_POWER_OFF)); <br> <br> <font color="#008000">//   STM_SETIMAGE</font></font> <br> <font color="#008000">//  </font> &lt;br/&gt; <br> SendMessage(hWndCtrl, STM_SETIMAGE, IMAGE_BITMAP, <br> (LPARAM)hBitmap);</code> <br> <br>  <font color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  Finally we will make it so that the image can be clicked.  By default, static controls do not handle clicks.  To achieve this, in the resource editor it is necessary for the static control to set the value of the Notify property to true.  In this case, <a href="http://msdn.microsoft.com/en-us/library/aa930761.aspx">WM_COMMAND</a> will be sent when you click on the image. <br><br><h2>  Test application </h2><br>  Download: <a title="bluetoothmanager.zip - 99Kb" href="">bluetoothmanager.zip - 99Kb</a> <br><br>  Due to the fact that working with bluetooth through the <a title="State and Notification Broker (SNAPI)" href="http://msdn.microsoft.com/en-us/library/aa455748.aspx">state and notification broker (SNAPI)</a> became possible only in Windows Mobile 6.0, ideally it would be nice to set a limit on the minimum OS version in the installation cab file to avoid installation on older versions. <br><br>  Also, as a homework, try to download the <a title="Broadcom Bluetooth SDK" href="http://www.broadcom.com/products/bluetooth_sdk.php">Broadcom Bluetooth SDK</a> and modify the application to work on this Bluetooth protocol stack.  ( <em>Prim.per .: And better at once on both stacks! :)</em> ) <br><br></div><p>Source: <a href="https://habr.com/ru/post/61703/">https://habr.com/ru/post/61703/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../61697/index.html">Edge: Online MIDI Sequencer</a></li>
<li><a href="../61698/index.html">Viktor Ivannikov: about the goals and organization of the RASPO</a></li>
<li><a href="../61699/index.html">Illustration - as it is!</a></li>
<li><a href="../61700/index.html">New favorites. Now convenient and tagged</a></li>
<li><a href="../61701/index.html">Linux saves zoom settings in contrast to Windows. Do you have this error?</a></li>
<li><a href="../61705/index.html">Enlarge your timus now!</a></li>
<li><a href="../61706/index.html">ESET NOD32: installation operation</a></li>
<li><a href="../61708/index.html">Google latitude allows you to determine the location of a mobile device, from February in Belarus!</a></li>
<li><a href="../61709/index.html">Excel calculator of real password strength</a></li>
<li><a href="../61710/index.html">PHPUnit and its Database Extension. Quick look</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>