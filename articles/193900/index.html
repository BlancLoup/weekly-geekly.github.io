<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making your flying robot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About a year ago, there was a message about the competition from Flying Robots by CROC. It was interesting for me to participate and gain experience i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making your flying robot</h1><div class="post__text post__text-html js-mediator-article">  About a year ago, there was a message about the competition from <a href="http://www.robots.croc.ru/">Flying Robots</a> by CROC.  It was interesting for me to participate and gain experience in designing an autonomous flying robot.  Unfortunately, the competition had to be withdrawn due to lack of time, but interest in solving the problem remained.  The brief, if briefly, was to fly from point A to point B, flying through a hole in the wall, and return. <br><br><img src="https://habrastorage.org/storage2/fe5/472/9fe/fe54729fe13d214ddf7c09d74d68b7df.jpg"><br><br>  What and how it happened at this stage under the cut. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The solution to this problem is obviously divided into two parts.  The first is how to ‚Äúfly along the wall without bumping into it,‚Äù the second is landing.  To orient the robot in space, I decided to use ultrasonic range finders.  It turned out that you need at least 3 sensors (down, forward and left, forward and right).  It was planned to carry out the landing with the help of a camera, but this has not yet been the case. <br><br>  I wanted to build my robot completely autonomous, with all the logic on board.  Actually, the issue of aircraft carrying capacity, as well as ease of operation, resistance to falls and low price led me to the choice of a toy radio-controlled helicopter with a co-axle arrangement of screws, the Hawkspy LT-711 model.  At one of the sites stated that he can lift the goods up to 50 grams.  And as the experiment showed, indeed, not fully charged, he calmly picked up half the standard hundred-gram chocolate. <br><br>  In order to fly ‚Äúalong the wall‚Äù one must first of all be able to keep altitude.  Actually, I want to describe the solution to this subtask in this post. <br><br>  The helicopter body is easily removed and you can immediately see the electronics responsible for flight control.  After a close examination of the board, it turned out that it was possible to intervene in the transmission of the control signal by connecting between the radio output and the decoder input. <br><br><img src="https://habrastorage.org/storage2/b19/905/c9d/b19905c9d52df5d04717a4112581126f.jpg"><br>  1 - output of the radio receiver (the signal that was decoded);  2 - decoder input (where the signal is fed);  3 - land;  On the reverse side of the board, the track connecting pins 1 and 2 was cut. <br><br>  Thus, you can use the existing control circuit, and not to solder everything from scratch.  But for this it was necessary to deal with the control signal, i.e.  to solve the problem of reverse engineering signal. <br><br><img src="https://habrastorage.org/storage2/40f/e7b/74a/40fe7b74aed85ce15a39642f82fb8a16.png"><br><br>  After observing the signal, I was able to isolate characteristic patterns.  The picture shows a typical signal with a markup.  As a result, it became clear that the signal is encoded quite simply - in four bytes.  Playing with the control panel and observing the changes in the signal, we managed to restore which part of the signal is responsible for what.  It turned out the following: <br><br><img src="https://habrastorage.org/storage3/2cb/3be/8a2/2cb3be8a289e72b7ea7632ced5fc88e5.png"><br>  lt - enable / disable light bulbs on the helicopter body;  sm - turbo mode; <br><br>  The most difficult was to guess the checksum.  It turned out that the checksum is considered in two stages - first the signal is added by-byte, and then the result is summed up by the upper and lower half of a byte. <br><br>  At this stage, most of the preparatory actions were completed and it was time to start writing my own firmware for the microcontroller.  I had a stm32f4discovery microcontroller for a long time and I decided to try using it first.  A significant part of the time was taken to install and configure the environment.  I have MacOS, so I had to install Armchan's phone with linaro and openocd on my laptop.  The basis was taken and modified one of the examples from the library for working with peripheral devices.  The routines for decoding and encoding the signal were transferred to it.  The signal received by the receiver is decoded by the microcontroller program.  Controls up / down, turning left / right, moving forward / backward (and others) are represented as separate numbers.  At this stage it is easy to modify them.  Next, the encoding is performed in the original format and transferred to the regular decoder helicopter. <br><br>  To solve the problem of measuring height, an ultrasonic distance measuring sensor <a href="http://www.maxbotix.com/documents/MB1000_Datasheet.pdf">LV-MAXONAR-EZ0 was used</a> .  The sensor was connected to the microcontroller via the UART interface and gave the distance to the object in the cone of its visibility in inches. <br>  Thus, the firmware did the following: took readings from the height sensor, and controlled the rotation speed of the screws using the <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%2598%25D0%2594-%25D1%2580%25D0%25B5%25D0%25B3%25D1%2583%25D0%25BB%25D1%258F%25D1%2582%25D0%25BE%25D1%2580">PID controller</a> . <br><br><img src="https://habrastorage.org/storage2/c5c/f41/8b4/c5cf418b4cdd3b73f9999c430d43b341.jpg"><br><br>  To debug the sensor, there is a very handy tool for STM microcontrollers, <a href="http://www.st.com/web/en/catalog/tools/PF251373">STM Studio</a> , which allows you to monitor the values ‚Äã‚Äãof variables without interrupting the work of the program.  True, it works only under Windows, but there was no problem with propping the USB device (debug board) and installing drivers in the virtual machine with Windows (I used <a href="http://www.parallels.com/ru/products/desktop/">PD</a> ).  The signal passes through the virtual shell completely, without changes and visible delays, thus online monitoring of the sensor's behavior greatly facilitated the understanding of what is happening. <br><br><img src="https://habrastorage.org/storage3/efc/fc9/aba/efcfc9aba1a1dc6d6344a4a506add4e6.png"><br><br>  When it came to test flights, it turned out that all the added electronics weighs more than 50 grams, so the helicopter took off low and almost immediately, slowly and sadly strove to the ground.  I had to think how to reduce the weight of all this electronics.  It is not possible for me to unsolder the chip on the board myself, so the problem was solved by replacing the debug board with a smaller and lighter MINI-m4 with the same chip.  I didn‚Äôt have to re-program the firmware: replace a couple of parameters and change the names of some of the pins used. <br><br><img src="https://habrastorage.org/storage2/122/ee2/8f3/122ee28f339a2696a48fa25b165cc56c.jpg"><br><br>  The debugging of the whole structure consisted in the selection of parameters for the PID controller, but by writing the simplest mathematical model of the helicopter, solved by the standard Euler method of the diffures, it was clear how the helicopter would behave.  It was clear that he would fluctuate and eventually go to a stationary state.  Therefore, the selection of parameters for the quickest exit from the oscillatory state did not take much time.  During the test flights, the helicopter sometimes had to be planted abruptly, so it took several parts to change.  Fortunately, for this model of a helicopter to find parts was not a problem.  The final step was to add filtering to the data taken from the height sensor.  From time to time, during the flight, the helicopter fell down a bit and then flew up sharply as well.  So, one of the first steps of further development will be the implementation of the telemetry removal function.  As it turned out, the sensor sometimes failed and showed obviously incorrect values, but the addition of filtering solved this problem. <br><br>  For convenience, the helicopter now has two modes.  If the joystick is in the upper half of the range, then the helicopter holds a height of one meter, if the joystick is in the lower half, then this is the landing mode. <br><br>  <a href="">Github code</a> <br><br>  <a href="http://youtu.be/G8G357P53XY">Video</a> <br><br><h6>  The simplest mathematical model </h6><br>  Mat model, with which you can imagine the behavior of a helicopter under the influence of the PID controller.  Since  I did not come across this before, then, looking at different schedules, you can predict the behavior of a helicopter on test flights.  It is also easier to twist the coefficients of the PID controller, and this greatly saves time, because  I had to recompile and rebuild every time. <br><br><img src="https://habrastorage.org/storage3/af9/a05/a30/af9a05a301561b8c2fa9d15ddee333ac.png"><br><br>  The model is quite primitive, one-dimensional.  If someone has ideas for improvement, I will be glad to hear. <br><br></div><p>Source: <a href="https://habr.com/ru/post/193900/">https://habr.com/ru/post/193900/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193888/index.html">Writing a platformer in Python using pygame</a></li>
<li><a href="../193890/index.html">Python memory usage</a></li>
<li><a href="../193892/index.html">A car dial tachometer for a beginner or some fixed-point shamanism on the AVR</a></li>
<li><a href="../193894/index.html">Review of modern heuristic optimization methods</a></li>
<li><a href="../193898/index.html">Cut off the finger does not help unlock the iPhone 5S</a></li>
<li><a href="../193902/index.html">QA Test Assignment</a></li>
<li><a href="../193904/index.html">In Belarus, problems with access to Dropbox and DigitalOcean</a></li>
<li><a href="../193906/index.html">Fault tolerance: how to provide reliable service in case of equipment failure</a></li>
<li><a href="../193908/index.html">YouBot robots have learned to ask for help from people</a></li>
<li><a href="../193910/index.html">The history of a single template or backdoor from myopencart.net</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>