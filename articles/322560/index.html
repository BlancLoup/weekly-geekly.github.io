<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bridge-domains and virtual-switch in JunOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Somewhere a year ago or earlier I wrote an article on routing-instance in JunOS, where I described the main types of routing instances, with the excep...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bridge-domains and virtual-switch in JunOS</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/18b/aa0/a75/18baa0a754a0426cb99bb186bb60b9fd.png" alt="image alt"></div><br>  Somewhere a year ago or earlier I wrote an article on routing-instance in JunOS, where I described the main types of routing instances, with the exception of virtual switch and evpn.  You can read about the latter in an article on EVPN, but virtual-switch has so far been ignored.  Many people underestimate the possibilities of this routing instance - and after all the functionality is decent.  In this small article we will look at what virtual-switch is, what it is eaten with and whether you need it. <br><a name="habracut"></a><br>  Before going directly to the discussion and configuration of a virtual switch, we need to highlight two very important issues: <br><br>  1. Method (style) of configuring a tagged interface in JunOS; <br>  2. What is a bridge-domain. <br><br>  JunOS provides us with two methods for configuring a tagged interface for use in a bridge domain: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. Service Provider <br>  2. Enterprise <br><br>  Let us dwell on them in more detail. <br><br><blockquote>  Note: all examples use flexible-ethernet-services encapsulation and flexible-vlan-tagging tagging, which gives maximum freedom in configuring interfaces: <br><br><pre><code class="javascript hljs">bormoglotx@RZN-PE1&gt; show configuration interfaces ae3 apply-groups-except CORE; description <span class="hljs-string"><span class="hljs-string">"to RZN-CE1 | ae0"</span></span>; flexible-vlan-tagging; encapsulation flexible-ethernet-services; aggregated-ether-options { minimum-links <span class="hljs-number"><span class="hljs-number">1</span></span>; link-speed <span class="hljs-number"><span class="hljs-number">1</span></span>g; lacp { active; periodic fast;</code> </pre> </blockquote><br>  <b>Service Provider.</b> <br><br>  This method of configuring the interface gives us complete freedom to manipulate the vlan tags, for which we use the pop (remove), push (add), swap (replace) tag, and two tag operations, for example pop-swap, to remove the top tag and replacing the bottom when using double tagging.  The easiest way to use this method of creating a tagged interface is as follows: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show interfaces ae3<span class="hljs-number"><span class="hljs-number">.10</span></span> encapsulation vlan-bridge; vlan-id <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br>  This is a simple tagged interface that allows only 10 vlan.  When adding interfaces configured by this method to the bridge-domain, you must explicitly specify this interface in the configuration of the bridge-domain itself: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show bridge-domains BRIDGE<span class="hljs-number"><span class="hljs-number">-10</span></span> domain-type bridge; vlan-id <span class="hljs-number"><span class="hljs-number">10</span></span>; interface ae3<span class="hljs-number"><span class="hljs-number">.10</span></span>;</code> </pre> <br>  You can use vlan-maps to manipulate vlan tags: input-vlan-map and output-vlan-map.  For example, let's rewrite tag 10 to tag 20: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show interfaces ae3<span class="hljs-number"><span class="hljs-number">.10</span></span> encapsulation vlan-bridge; vlan-id <span class="hljs-number"><span class="hljs-number">10</span></span>; input-vlan-map { swap; vlan-id <span class="hljs-number"><span class="hljs-number">20</span></span>; } output-vlan-map swap;</code> </pre> <br>  When using a vlan-map, do not forget to add a reverse action ‚Äî that is, if you specify only input-vlan-map and forget about output-vlan-map, you will receive that the tag will correspond to the reception, but not to the transmission. <br><blockquote>  Note: when using interfaces configured in bridge provider's domains configured in Service Provider with tag rewriting, you cannot specify vlan-id, you will get an error: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show bridge-domains BRIDGE<span class="hljs-number"><span class="hljs-number">-10</span></span> { domain-type bridge; vlan-id <span class="hljs-number"><span class="hljs-number">10</span></span>; ## ## Warning: interface <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> input/output vlan-maps cannot be added to a routing-instance <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> a vlan-id/vlan-tags configured ## interface ae3<span class="hljs-number"><span class="hljs-number">.10</span></span>;</code> </pre> </blockquote><br>  If you decide to use a vlan-map, you will have to remove the vlan-id from the bridge-domain and manage the tag numbers on each interface that belong to this bridge-domain manually.  But there is also a simpler way of rewriting tags, which we will look at later. <br><br>  <b>Enterprise:</b> <br><br>  This method is much simpler than the previous one.  When configuring the interface, we indicate that it is a trunked or aks interface.  Based on this, we can specify several tags (if the interface is trunked) or one (if the interface is an interface).  But for simplicity you have to pay for example with the following drawbacks - there is no possibility to overwrite the internal tag with QinQ - you can access only the external tag or, for example, manually rewrite the tag if it does not match the vlan-id in the bridge-domain, unlike the Service Provider model .  The configuration looks like this: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show interfaces ae0<span class="hljs-number"><span class="hljs-number">.10</span></span> encapsulation vlan-bridge; family bridge { interface-mode trunk; vlan-id-list <span class="hljs-number"><span class="hljs-number">10</span></span>; }</code> </pre> <br>  In the list of vlans, the vlan-id-list can contain more than one number of the vlan - up to 4094. This interface should not be added to the bridge-domain - it will be added to it automatically if the number of the vlan in the bridge-domain and on the configured interface matches.  For example, the configuration of a bridge-domain with vlan-id 10: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show configuration bridge-domains BRIDGE<span class="hljs-number"><span class="hljs-number">-10</span></span> domain-type bridge; vlan-id <span class="hljs-number"><span class="hljs-number">10</span></span>; interface ae3<span class="hljs-number"><span class="hljs-number">.10</span></span>;</code> </pre> <br>  The ae0.10 court interface has not been added (if you try to do this, JunOS will give you an error).  And now let's see the state of our bridge-domain: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge domain BRIDGE<span class="hljs-number"><span class="hljs-number">-10</span></span> Routing instance Bridge domain VLAN ID Interfaces <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> BRIDGE<span class="hljs-number"><span class="hljs-number">-10</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> ae0<span class="hljs-number"><span class="hljs-number">.10</span></span> ae3<span class="hljs-number"><span class="hljs-number">.10</span></span></code> </pre> <br>  The interface was automatically added to the bridge-domain, because its vlan number is equal to the configured vlan-id in the BRIDGE-10 bridge-domain.  If there are several vlans in the vlan-id-list, the interface will also be added to several bridge-domains <br><br>  This method of configuring the interface also allows you to manipulate vlan tags, although the configuration at first glance may seem somewhat confusing. <br><br>  Let's do the same as with the interface ae3.10 - rewrite the tag from 10 to 20: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show interfaces ae0<span class="hljs-number"><span class="hljs-number">.10</span></span> encapsulation vlan-bridge; family bridge { interface-mode trunk; vlan-id-list <span class="hljs-number"><span class="hljs-number">20</span></span>; vlan-rewrite { translate <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>; } }</code> </pre> <br>  Please note that the number of the vlan with which the package will arrive from the client is not indicated in the vlan-id-list (if specified, JunOS will generate an error).  But the most important thing to remember is that now this is an interface with vlan-id 20 and not 10, and it will be added to the bridge-domain with vlan-id 20, not 10. If you have several vlans on one interface (this is still trunk interface), then you can write several translation rules - for each vlan separately.  For those vlan, for which the translation rule is absent - the tag will remain the one with which it arrived from the client (of course, if this vlan is allowed on this interface). <br><br>  Above, I showed that this interface was automatically attached to the bridge-domain BRIDGE-10 because their vlan numbers matched.  Let's check now whether the interface has remained in this bridge domain or has been moved: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge domain BRIDGE<span class="hljs-number"><span class="hljs-number">-10</span></span> Routing instance Bridge domain VLAN ID Interfaces <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> BRIDGE<span class="hljs-number"><span class="hljs-number">-10</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> ae3<span class="hljs-number"><span class="hljs-number">.10</span></span></code> </pre> <br>  The interface has been removed from the BRIDGE-10 bridge-domain, as they now do not have vlan numbers.  Let's change the number of the vlan in this bridge-domain to 20 and check again whether ae0.10 will be added now: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge domain BRIDGE<span class="hljs-number"><span class="hljs-number">-10</span></span> Routing instance Bridge domain VLAN ID Interfaces <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> BRIDGE<span class="hljs-number"><span class="hljs-number">-10</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> ae0<span class="hljs-number"><span class="hljs-number">.10</span></span> ae3<span class="hljs-number"><span class="hljs-number">.10</span></span></code> </pre> <br>  As it should be, the interface got into this bridge-domain. <br><blockquote>  Note: we changed the number of the vlan in the bridge-domain itself, but here on ae3.10 the number of the vlan did not change, but it is still in the bridge-domain.  This is normal and how it works, we will look at a little later. </blockquote><br>  <b>Bridge-domain</b> <br><br>  Since we have dealt with the methods of configuring interfaces, we now proceed directly to the bridge-domains. <br><br>  Bridge-domain is a set of logical interfaces that have the same characteristics of learning MAC addresses and flooding.  Bridge-domain is a synonym for the word broadcast domain.  For example, imagine that we created a bridge-domain consisting of 3 interfaces.  When receiving a broadcast frame, the router will flood it to all interfaces, except for the one from which this frame is received (as you understand this is the split-horizon function), that is, in our case, if the packet is received from interface A, it will be sent to interface B and C. The router will not send the packet anywhere else, which ensures the isolation of one bridge-domain from another.  As a result, we get the definition that is written at the beginning of this paragraph - the study of MAC addresses and flood is limited only by the set of interfaces that are attached to this bridge-domain.  Under certain circumstances, the vlan will be synonymous with the bridge-domain, but this is the exception rather than the rule. <br><br>  Let's create a simple bridge-domain - in fact we will throw in vlan 100 between RZN-PE1 and RZN-PE2, as shown in the diagram below: <br><br><img src="https://habrastorage.org/files/5a3/b84/172/5a3b84172b1b439f865447e827b5d41a.png"><br><br>  Since in this case the configuration of the bridge-domain on both PEs is identical, I will only give conclusions from the first box.  To begin with, we‚Äôll check that now we don‚Äôt have a connectivity between RZN-CE1 and RZN-CE2 in 100: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-CE1&gt; show configuration interfaces ae0<span class="hljs-number"><span class="hljs-number">.100</span></span> vlan-id <span class="hljs-number"><span class="hljs-number">100</span></span>; family inet { address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>; } bormoglotx@RZN-CE1&gt; ping rapid routing-instance VR1 source <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> PING <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes ..... --- <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">0</span></span> packets received, <span class="hljs-number"><span class="hljs-number">100</span></span>% packet loss</code> </pre> <br>  Now let's switch to RZN-PE1 and add the interfaces we need and join them into the bridge-domain: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show | compare [edit interfaces ae0] + unit <span class="hljs-number"><span class="hljs-number">100</span></span> { + description <span class="hljs-string"><span class="hljs-string">"L2 for BRIDGE100"</span></span>; + encapsulation vlan-bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">100</span></span>; + } [edit interfaces ae3] + unit <span class="hljs-number"><span class="hljs-number">100</span></span> { + description <span class="hljs-string"><span class="hljs-string">"to VR1"</span></span>; + encapsulation vlan-bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">100</span></span>; + } [edit] + bridge-domains { + BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span> { + domain-type bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">100</span></span>; + interface ae0<span class="hljs-number"><span class="hljs-number">.100</span></span>; + interface ae3<span class="hljs-number"><span class="hljs-number">.100</span></span>; + } + }</code> </pre> <br>  As you remember, on the RZN-PE1 interface ae0 looks at its brother RZN-PE2, and ae3 towards RZN-CE1.  A similar config is used on RZN-PE2.  Now let's check the status of our bridge-domain: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge domain BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span> detail Routing instance: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> Bridge domain: BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span> State: Active Bridge VLAN ID: <span class="hljs-number"><span class="hljs-number">100</span></span> Interfaces: ae0<span class="hljs-number"><span class="hljs-number">.100</span></span> ae3<span class="hljs-number"><span class="hljs-number">.100</span></span> Total MAC count: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Everything as we planned - in our domain there are two interfaces and the 100th number of the vlan.  So far, no MAC addresses have been studied, since there has not yet been traffic exchange between RZN-CE1 / 2. <br>  We correct this mistake by running a ping between the addresses we need: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-CE1&gt; ping rapid routing-instance VR1 source <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> PING <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">3.451</span></span>/<span class="hljs-number"><span class="hljs-number">6.046</span></span>/<span class="hljs-number"><span class="hljs-number">13.350</span></span>/<span class="hljs-number"><span class="hljs-number">3.674</span></span> ms</code> </pre> <br>  Now we can check whether the MAC appeared in the forwarding table: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge domain BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span> detail | match mac Total MAC count: <span class="hljs-number"><span class="hljs-number">2</span></span> bormoglotx@RZN-PE1&gt; show bridge mac-table bridge-domain BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span> MAC flags (S -<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MAC, D -dynamic MAC, L -locally learned, C -Control MAC SE -Statistics enabled, NM -Non configured MAC, R -Remote PE MAC) Routing instance : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> Bridging domain : BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span>, <span class="hljs-attr"><span class="hljs-attr">VLAN</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span> MAC MAC Logical NH RTR address flags interface Index ID <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>c:c0 D ae0<span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:e5:c0 D ae3<span class="hljs-number"><span class="hljs-number">.100</span></span></code> </pre> <br>  Poppies are studied, there is connectivity - all we need is we did.  I would like to say a few words that a similar result could be achieved with the help of L2CKT.  But first, L2CKT is a completely different service using MPLS as a transport and not learning MAC addresses (essentially a pipe from port A to port B), and secondly, in L2CKT you cannot add a third interface (you will have to do VPLS), and most importantly, you will not be able to tie a routing interface (irb) to L2CKT and release hosts from your bridge-domain to an external network.  For clarity, add an irb interface to our bridge-domain, as shown in the diagram: <br><br><img src="https://habrastorage.org/files/021/a84/49b/021a8449b11649e7b5c9c3e1cd2bd750.png"><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1# show | compare [edit interfaces] + irb { + unit <span class="hljs-number"><span class="hljs-number">100</span></span> { + description <span class="hljs-string"><span class="hljs-string">"L3 for BRIDGE-100"</span></span>; + family inet { + address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>; + } + } + } [edit routing-instances] + VIRTUAL-ROUTER { + instance-type virtual-router; + interface irb<span class="hljs-number"><span class="hljs-number">.100</span></span>; + } [edit bridge-domains BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span>] + routing-interface irb<span class="hljs-number"><span class="hljs-number">.100</span></span>;</code> </pre> <br>  Since inside the labs between the MX-themselves is also the network 10.0.0.0/24, I moved the irb interface to the virtual router.  If the addressing did not overlap with us, then we could leave this interface in the GRT and thus release the hosts from our L2 domain to the outside world. <br><br><blockquote>  Note: The irb interface is not tagged, the unit number is set to 100 for ease of administration.  When sending traffic to the routing interface, the vlan tag is removed from the packet, if present. </blockquote><blockquote>  Note: The irb interface will be active only when it is added to the bridge-domain with at least one logical interface in the up state. <br></blockquote><blockquote>  Note: Only one routing interface can be added to one bridge domain. </blockquote><br>  Now let's run ping for example from RZN-CE2 to 10.0.0.254 and check the performance of our configuration: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-CE2&gt; ping routing-instance VR1 rapid source <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> PING <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> (<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">3.385</span></span>/<span class="hljs-number"><span class="hljs-number">19.526</span></span>/<span class="hljs-number"><span class="hljs-number">79.125</span></span>/<span class="hljs-number"><span class="hljs-number">29.821</span></span> ms</code> </pre> <br>  Now let's complicate the task a little and collect the following scheme: <br><br><img src="https://habrastorage.org/files/9bb/300/a83/9bb300a83ac448dabd0bc199d3fdd6c1.png"><br><br>  In the new scenario, we need to throw L2 between our REs again, but the problem is that 101 VLANs are terminated on RZN-PE1, but 1001 Vlan on RZN-PE2.  When I wrote that under certain conditions a bridge-domain would be a synonym for the word vlan, I meant the case presented above (with the 100th vlan).  The case considered now will prove to you that the bridge-domain is not always the same and the same.  The first thing you probably thought was that you need to configure tag rewriting on some of the interfaces, for example, from 1001 to 101 on RZN-PE2.  But now I‚Äôll show you that JunOS will make it much easier for us.  Add the following config to RZN-PE1: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show | compare [edit interfaces ae0] + unit <span class="hljs-number"><span class="hljs-number">101</span></span> { + encapsulation vlan-bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">101</span></span>; + } [edit interfaces ae3] + unit <span class="hljs-number"><span class="hljs-number">101</span></span> { + encapsulation vlan-bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">101</span></span>; + } [edit bridge-domains] + BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span> { + domain-type bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">101</span></span>; + interface ae0<span class="hljs-number"><span class="hljs-number">.101</span></span>; + interface ae3<span class="hljs-number"><span class="hljs-number">.101</span></span>; + }</code> </pre> <br>  As a result, the use of this config will appear on the RZN-PE1 bridge-domain BRIDGE-101: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge domain BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span> Routing instance Bridge domain VLAN ID Interfaces <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span> <span class="hljs-number"><span class="hljs-number">101</span></span> ae0<span class="hljs-number"><span class="hljs-number">.101</span></span> ae3<span class="hljs-number"><span class="hljs-number">.101</span></span></code> </pre> <br>  We now turn to the configuration from RZN-PE2: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE2# show | compare [edit interfaces ae0] + unit <span class="hljs-number"><span class="hljs-number">101</span></span> { + encapsulation vlan-bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">101</span></span>; + } [edit interfaces ae3] + unit <span class="hljs-number"><span class="hljs-number">1001</span></span> { + encapsulation vlan-bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">1001</span></span>; + } [edit bridge-domains] + BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span> { + domain-type bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">101</span></span>; + interface ae3<span class="hljs-number"><span class="hljs-number">.1001</span></span>; + interface ae0<span class="hljs-number"><span class="hljs-number">.101</span></span>; + }</code> </pre> <br>  In the configuration, there are no rewriting of tags; if you look at the status of the bridge-domain, you can clearly see that the interface ae3.1001 is in the bridge-domain BRIDGE-101: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show bridge domain BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span> Routing instance Bridge domain VLAN ID Interfaces <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span> <span class="hljs-number"><span class="hljs-number">101</span></span> ae0<span class="hljs-number"><span class="hljs-number">.101</span></span> ae3<span class="hljs-number"><span class="hljs-number">.1001</span></span></code> </pre> <br>  For good, since rewriting a tag is not configured at our place, it will not work.  And let's check: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-CE1&gt; ping rapid routing-instance VR1 source <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> PING <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">11.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">5.033</span></span>/<span class="hljs-number"><span class="hljs-number">7.733</span></span>/<span class="hljs-number"><span class="hljs-number">13.904</span></span>/<span class="hljs-number"><span class="hljs-number">3.206</span></span> ms</code> </pre> <br>  Already interesting - there is connectivity, let's check the forwarding table for the presence of MAC addresses: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show bridge mac-table bridge-domain BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span> MAC flags (S -<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MAC, D -dynamic MAC, L -locally learned, C -Control MAC SE -Statistics enabled, NM -Non configured MAC, R -Remote PE MAC) Routing instance : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> Bridging domain : BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span>, <span class="hljs-attr"><span class="hljs-attr">VLAN</span></span> : <span class="hljs-number"><span class="hljs-number">101</span></span> MAC MAC Logical NH RTR address flags interface Index ID <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>c:c0 D ae3<span class="hljs-number"><span class="hljs-number">.1001</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:e5:c0 D ae0<span class="hljs-number"><span class="hljs-number">.101</span></span></code> </pre> <br>  With MAC in the forwarding table, everything is fine.  But why did the connectivity between different vlans appear without configuring tag rewriting?  The fact is that this is JunOS default behavior.  Let's return to the configuration of the BRIDGE-101 bridge-domain itself on RZN-PE2: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show configuration bridge-domains BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span> domain-type bridge; vlan-id <span class="hljs-number"><span class="hljs-number">101</span></span>; interface ae3<span class="hljs-number"><span class="hljs-number">.1001</span></span>; interface ae0<span class="hljs-number"><span class="hljs-number">.101</span></span>;</code> </pre> <br>  The thing is in the number of the vlan indicated by us: vlan-id 101. It works like this: for packets received in this bridge-domain with a tag that does not correspond to tag 101, JunOS automatically rewrites the tag.  This is easy to see on the interface itself: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show interfaces ae3<span class="hljs-number"><span class="hljs-number">.1001</span></span> Logical interface ae3<span class="hljs-number"><span class="hljs-number">.1001</span></span> (Index <span class="hljs-number"><span class="hljs-number">339</span></span>) (SNMP ifIndex <span class="hljs-number"><span class="hljs-number">580</span></span>) Flags: Up SNMP-Traps <span class="hljs-number"><span class="hljs-number">0x20004000</span></span> VLAN-Tag [ <span class="hljs-number"><span class="hljs-number">0x8100</span></span><span class="hljs-number"><span class="hljs-number">.1001</span></span> ] In(swap <span class="hljs-number"><span class="hljs-number">.101</span></span>) Out(swap <span class="hljs-number"><span class="hljs-number">.1001</span></span>) Encapsulation: VLAN-Bridge Statistics Packets pps Bytes bps Bundle: Input : <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">556</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Output: <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">570</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Adaptive Statistics: Adaptive Adjusts: <span class="hljs-number"><span class="hljs-number">0</span></span> Adaptive Scans : <span class="hljs-number"><span class="hljs-number">0</span></span> Adaptive Updates: <span class="hljs-number"><span class="hljs-number">0</span></span> Protocol bridge, <span class="hljs-attr"><span class="hljs-attr">MTU</span></span>: <span class="hljs-number"><span class="hljs-number">1522</span></span></code> </pre> <br>  I draw your attention to the line with the following content: <br><br><pre> <code class="javascript hljs"> VLAN-Tag [ <span class="hljs-number"><span class="hljs-number">0x8100</span></span><span class="hljs-number"><span class="hljs-number">.1001</span></span> ] In(swap <span class="hljs-number"><span class="hljs-number">.101</span></span>) Out(swap <span class="hljs-number"><span class="hljs-number">.1001</span></span>)</code> </pre> <br>  This line tells us what actions will be performed with the tag on reception from this interface (In (swap .101) - the tag changes to 101) and when transmitted to this interface (Out (swap .1001) - the tag changes to 1001) .  For example, I will change the bridge-domain configuration: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE2# show bridge-domains BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span> domain-type bridge; vlan-id none; interface ae3<span class="hljs-number"><span class="hljs-number">.1001</span></span>; interface ae0<span class="hljs-number"><span class="hljs-number">.101</span></span>;</code> </pre> <br>  And again, let's see what will be done with the tag on ae3.1001: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show interfaces ae3<span class="hljs-number"><span class="hljs-number">.1001</span></span> | match vlan-tag VLAN-Tag [ <span class="hljs-number"><span class="hljs-number">0x8100</span></span><span class="hljs-number"><span class="hljs-number">.1001</span></span> ] In(pop) Out(push <span class="hljs-number"><span class="hljs-number">0x0000</span></span><span class="hljs-number"><span class="hljs-number">.1001</span></span>)</code> </pre> <br>  Now the tag is removed for reception (rather than being rewritten), and tag 1001 is added to the transmission. But since the interface in the direction of RZN-PE1 is also tagged with us, in this case there will be manipulations with vlan numbers (only 101) : <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show interfaces ae0<span class="hljs-number"><span class="hljs-number">.101</span></span> | match vlan-tag VLAN-Tag [ <span class="hljs-number"><span class="hljs-number">0x8100</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span> ] In(pop) Out(push <span class="hljs-number"><span class="hljs-number">0x0000</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span>)</code> </pre> <br>  I think that some have figured out the bridge-domains.  Let's now try to create another bridge-domain on RZN-PE1 with a tag of 100: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show bridge-domains BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span> { domain-type bridge; vlan-id <span class="hljs-number"><span class="hljs-number">100</span></span>; interface ae0<span class="hljs-number"><span class="hljs-number">.100</span></span>; interface ae3<span class="hljs-number"><span class="hljs-number">.100</span></span>; } BRIDGE<span class="hljs-number"><span class="hljs-number">-101</span></span> { domain-type bridge; vlan-id <span class="hljs-number"><span class="hljs-number">101</span></span>; interface ae0<span class="hljs-number"><span class="hljs-number">.101</span></span>; interface ae3<span class="hljs-number"><span class="hljs-number">.101</span></span>; } VLAN100 { vlan-id <span class="hljs-number"><span class="hljs-number">100</span></span>; }</code> </pre> <br>  Check if the commit script will swear at the new configuration: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# commit check [edit bridge-domains] <span class="hljs-string"><span class="hljs-string">'VLAN100'</span></span> l2ald: Duplicate vlan-id exists <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> bridge domain BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span> [edit bridge-domains] Failed to parse bridge domain hierarchy completely error: configuration check-out failed</code> </pre> <br>  When we commit, we get an error - this vlan is already used in another bridge domain.  How to be in this situation ??  Yes, you can put none and everything will fly, but this is not a solution to the problem, but a crutch (although all the transport is kept on crutches and gags, but you still want a more viable solution).  There is a more elegant way - we just create another vlan space, which will be completely isolated from the existing one.  This is what a virtual switch will help us with. <br><br>  We will understand in more detail.  We have 4094 vlan for one router.  That is, in fact, you are limited in the creation of bridge-domains - a maximum of 4094 domains with a Vlan number.  JunOS will not allow you to make two domains with the same vlan number.  When I showed you the conclusion about the state of the bridge-domain, you probably noticed in this output the name of the routing-instance: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge domain BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span> detail Routing instance: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> Bridge domain: BRIDGE<span class="hljs-number"><span class="hljs-number">-100</span></span> State: Active Bridge VLAN ID: <span class="hljs-number"><span class="hljs-number">100</span></span> Interfaces: ae0<span class="hljs-number"><span class="hljs-number">.100</span></span> ae3<span class="hljs-number"><span class="hljs-number">.100</span></span> Total MAC count: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  We are interested in this line Routing instance: default-switch.  That is, even if you have not created any routing-instance with the type virtual-switch, then you will still have one such routing-instance, called default-switch.  All bridge domains that I configured earlier were added to this instance.  When you create a routing-instance of type virtual-switch, then you add another space from 4094 vlans that do not overlap in any way and do not affect already used vlan numbers.  That is, making for example two virtual switches you make it possible within the same router to create three bridge-domains with the same vlan number, all of which bridge-domains will be completely isolated from each other.  In addition, if your topology provides for backup paths that can lead to looping, the virtual switch allows you to run protocols of the stp family, although there is a restriction - you can add only the interface itself, not its units.  And if you have two virtual switches to which you want to add the same interface but different units, JunOS will give you an error when adding the interface to stp.  To use stp in this case you will have to use routing-instance layer2-control and mstp protocol. <br><br>  But the possibilities of a virtual switch do not end there.  In the previous cases of creating a bridge-domain, we used a direct link between RZN-PE1 and RZN-PE2, as a L2 link, and organized the connection with it.  But this does not have a very good impact on fault tolerance, since the termination of this link will break our stretched L2 domain into two parts.  To avoid this, you can use VPLS or EVPN, and we don‚Äôt have to do a separate routing-instance with vpls or evpn type - you can configure the VPLS / EVPN port in the virtual switch hierarchy and use it as a trunk port to organize L2 connectivity with remote PE. .  Next, we will configure a virtual switch and will use VPLS exclusively for connectivity between PE routers. <br><br>  Now we can proceed to the creation of a routing-instance with a virtual switch type.  We will collect three schemes that will differ from each other and show the main possibilities of the bridge-domains. <br><br>  1. Bridge-domain BRIDGE-2000 <br>  2. Bridge-domain BRIDGE-2001 <br>  3. Bridge domains BRIDGE-302 and BRIDGE-502 <br><br>  In the first scheme, we will use two vlans: 200 and 2000 (on the RZN-PE1 we will rewrite the tag 200 for 2000), in the second scheme, also two vlans: 201 and 2001 (but here we will use the Service Provider to configure the interface and not rewrite anything - JunOS it will do it for us), and in the third scheme we will use three vlans, manually rewrite the tags and configure different bridge-domains between RZN-PE1 and RZN-PE2 (one in the virtual switch, the second in the default switch). <br><br>  <b>BRIDGE-2000</b> <br>  Scheme of service is presented below. <br><br><img src="https://habrastorage.org/files/c18/3e2/4f1/c183e24f159449558acb60527e12ba8e.png"><br><br>  Configuring the interface on the RZN-PE1 side: <br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1# show interfaces ae3<span class="hljs-number"><span class="hljs-number">.200</span></span> description <span class="hljs-string"><span class="hljs-string">"to VR2"</span></span>; encapsulation vlan-bridge; family bridge { interface-mode trunk; vlan-id-list <span class="hljs-number"><span class="hljs-number">2000</span></span>; vlan-rewrite { translate <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>; } }</code> </pre> <br>  As indicated in the diagram, we make tag rewriting from 200 to 2000. On the RZN-PE2 side, the interface configuration looks simpler: <br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE2# show interfaces ae3<span class="hljs-number"><span class="hljs-number">.2000</span></span> description <span class="hljs-string"><span class="hljs-string">"to VR2"</span></span>; encapsulation vlan-bridge; family bridge { interface-mode trunk; vlan-id-list <span class="hljs-number"><span class="hljs-number">2000</span></span>; }</code> </pre> <br>  Now let's move on to creating a virtual switch.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The configuration will be approximately the same on RZN-PE1 and on RZN-PE2, therefore I will only give the config from the first RE: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show configuration routing-instances vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> instance-type virtual-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>; interface ae3<span class="hljs-number"><span class="hljs-number">.200</span></span>; route-distinguisher <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; vrf-target { <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; } protocols { vpls { site-range <span class="hljs-number"><span class="hljs-number">2</span></span>; no-tunnel-services; site SITE1 { site-identifier <span class="hljs-number"><span class="hljs-number">1</span></span>; } } } bridge-domains { BRIDGE<span class="hljs-number"><span class="hljs-number">-2000</span></span> { vlan-id <span class="hljs-number"><span class="hljs-number">2000</span></span>; } }</code> </pre> <br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: RD and RT values ‚Äã‚Äãare present in the configuration of the routing-instance. </font><font style="vertical-align: inherit;">This is not a required attribute of this routing-instance, but I used vpls Kompella, so I need RD / RT for the VPLS to work. </font><font style="vertical-align: inherit;">If you use, for example, Martini without auto-discovery, then you do not need to specify RT / RD.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now check the status of the bridge-domain BRIDGE-2000: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge domain instance vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> BRIDGE<span class="hljs-number"><span class="hljs-number">-2000</span></span> Routing instance Bridge domain VLAN ID Interfaces vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> BRIDGE<span class="hljs-number"><span class="hljs-number">-2000</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span> ae3<span class="hljs-number"><span class="hljs-number">.200</span></span> lsi<span class="hljs-number"><span class="hljs-number">.1048832</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Besides the fact that the ae3.200 interface was automatically added to the bridge-domain, the lsi interface, which is our vpls port, was also added here: </font></font><br><br><pre> <code class="javascript hljs">Instance: vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> Local site: SITE1 (<span class="hljs-number"><span class="hljs-number">1</span></span>) connection-site Type St Time last up # Up trans <span class="hljs-number"><span class="hljs-number">2</span></span> rmt Up Feb <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, Negotiated control-word: No Incoming label: <span class="hljs-number"><span class="hljs-number">262146</span></span>, Outgoing label: <span class="hljs-number"><span class="hljs-number">262145</span></span> Local interface: lsi<span class="hljs-number"><span class="hljs-number">.1048832</span></span>, <span class="hljs-attr"><span class="hljs-attr">Status</span></span>: Up, <span class="hljs-attr"><span class="hljs-attr">Encapsulation</span></span>: VPLS Description: Intf - vpls vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> local site <span class="hljs-number"><span class="hljs-number">1</span></span> remote site <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now RZN-PE2 in this bridge-domain is available to us through the VPLS port, and not as it was earlier through a direct link. </font><font style="vertical-align: inherit;">Check whether there is connectivity between our hosts and how things are with the forwarding table:</font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-CE1&gt; ping rapid routing-instance VR2 source <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> PING <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">4.571</span></span>/<span class="hljs-number"><span class="hljs-number">11.609</span></span>/<span class="hljs-number"><span class="hljs-number">37.058</span></span>/<span class="hljs-number"><span class="hljs-number">12.731</span></span> ms</code> </pre> <br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge mac-table instance vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> vlan-id <span class="hljs-number"><span class="hljs-number">2000</span></span> MAC flags (S -<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MAC, D -dynamic MAC, L -locally learned, C -Control MAC SE -Statistics enabled, NM -Non configured MAC, R -Remote PE MAC) Routing instance : vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> Bridging domain : BRIDGE<span class="hljs-number"><span class="hljs-number">-2000</span></span>, <span class="hljs-attr"><span class="hljs-attr">VLAN</span></span> : <span class="hljs-number"><span class="hljs-number">2000</span></span> MAC MAC Logical NH RTR address flags interface Index ID <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>c:c0 D lsi<span class="hljs-number"><span class="hljs-number">.1048832</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:e5:c0 D ae3<span class="hljs-number"><span class="hljs-number">.200</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything is in order - the scheme works. Please note that, as in the default switch, no interfaces have been added to the bridge-domain itself ‚Äî JunOS will automatically add them when the configuration is parsed (since we used the Enterprise configuration style). Our business in this scenario is to correctly specify which interfaces belong to the virtual switch and to correctly indicate the vlan-id in the bridge-domain (well, or vlan-id-range). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BRIDGE-2001</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we will assemble the scheme for vlan 201 and 2001. </font></font><br><br><img src="https://habrastorage.org/files/b33/13d/451/b3313d4517974fcfa066097a34751789.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will not make another virtual switch - I just add one more bridge-domain in vSwitch-1. As I said, we will use the Service Provider style in configuring interfaces without rewriting tags.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Note: within the virtual switch, as well as within the bridge-domain, no one forbids you to use interfaces configured using different methods - as it is easier for you - do so, the main thing then is not to get confused in the configuration yourself. </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface configurations look very simple. </font><font style="vertical-align: inherit;">On RZN-PE1:</font></font><br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show interfaces ae3<span class="hljs-number"><span class="hljs-number">.201</span></span> description <span class="hljs-string"><span class="hljs-string">"to VR2"</span></span>; encapsulation vlan-bridge; vlan-id <span class="hljs-number"><span class="hljs-number">201</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Counter-interface on the RZN-PE2 side: </font></font><br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE2# show interfaces ae3<span class="hljs-number"><span class="hljs-number">.2001</span></span> description <span class="hljs-string"><span class="hljs-string">"to VR2"</span></span>; encapsulation vlan-bridge; vlan-id <span class="hljs-number"><span class="hljs-number">2001</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we add interfaces to our virtual switch: </font></font><br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE2# show routing-instances vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> instance-type virtual-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>; interface ae3<span class="hljs-number"><span class="hljs-number">.2000</span></span>; ## ## Warning: Only interface <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-string"><span class="hljs-string">'interface-mode'</span></span> is allowed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a virtual-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ## interface ae3<span class="hljs-number"><span class="hljs-number">.2001</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Got an error. The fact is that a virtual switch can be added to the interface hierarchy (now and then the hierarchy [edit routing-instances vSwitch-1 interface]) can only add interfaces in trunk or accessory mode, that is, the interface must be configured in Enterprise style. This is another difference between these two methods of configuring interfaces. If our interface is configured in the Enterprise style, then we cannot specify the bridge-domain in the hierarchy - the interface will be added to the bridge-domain by the vlan number. Therefore, when configuring a virtual switch, we need to add all our interfaces to it, which are in trunk or access mode - then JunOS will automatically add them to the required bridge-domain. But the interfaces configured in the Service Provider style must be specified in the bridge-domain manually. Therefore,when configuring a virtual switch, such interfaces are not necessary to add to the virtual switch in the interface hierarchy - we immediately add them to the bridge-domain we need, after which the interface will automatically be tied to the virtual switch that contains this bridge-domain.</font></font><br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE2# show routing-instances vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> instance-type virtual-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>; interface ae3<span class="hljs-number"><span class="hljs-number">.2000</span></span>; route-distinguisher <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; vrf-target { <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; } protocols { vpls { site-range <span class="hljs-number"><span class="hljs-number">2</span></span>; no-tunnel-services; site SITE2 { site-identifier <span class="hljs-number"><span class="hljs-number">2</span></span>; } } } bridge-domains { BRIDGE<span class="hljs-number"><span class="hljs-number">-2000</span></span> { vlan-id <span class="hljs-number"><span class="hljs-number">2000</span></span>; } BRIDGE<span class="hljs-number"><span class="hljs-number">-2001</span></span> { vlan-id <span class="hljs-number"><span class="hljs-number">2001</span></span>; interface ae3<span class="hljs-number"><span class="hljs-number">.2001</span></span>; } }</code> </pre> <br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Note: VPLS or EVPN port is a trunk port and passes all vlans and will be added to all bridge domains automatically. </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The configuration on RZN-PE1 is similar to RZN-PE2 (only another interface has been added to the bridge-domain), so I will not show it. </font><font style="vertical-align: inherit;">Check the state of the bridge-domains on both PE-kah:</font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge domain instance vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> BRIDGE<span class="hljs-number"><span class="hljs-number">-2001</span></span> detail Routing instance: vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> Bridge domain: BRIDGE<span class="hljs-number"><span class="hljs-number">-2001</span></span> State: Active Bridge VLAN ID: <span class="hljs-number"><span class="hljs-number">2001</span></span> Interfaces: ae3<span class="hljs-number"><span class="hljs-number">.201</span></span> lsi<span class="hljs-number"><span class="hljs-number">.1048832</span></span> Total MAC count: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show bridge domain instance vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> BRIDGE<span class="hljs-number"><span class="hljs-number">-2001</span></span> detail Routing instance: vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> Bridge domain: BRIDGE<span class="hljs-number"><span class="hljs-number">-2001</span></span> State: Active Bridge VLAN ID: <span class="hljs-number"><span class="hljs-number">2001</span></span> Interfaces: ae3<span class="hljs-number"><span class="hljs-number">.2001</span></span> lsi<span class="hljs-number"><span class="hljs-number">.1048832</span></span> Total MAC count: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Check that tags are being overwritten on ae3.201: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show interfaces ae3<span class="hljs-number"><span class="hljs-number">.201</span></span> | match vlan-tag VLAN-Tag [ <span class="hljs-number"><span class="hljs-number">0x8100</span></span><span class="hljs-number"><span class="hljs-number">.201</span></span> ] In(swap <span class="hljs-number"><span class="hljs-number">.2001</span></span>) Out(swap <span class="hljs-number"><span class="hljs-number">.201</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And for verification, we will launch a ping between our hosts and check the forwarding table: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-CE1&gt; ping rapid routing-instance VR2 source <span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> PING <span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">7.026</span></span>/<span class="hljs-number"><span class="hljs-number">9.563</span></span>/<span class="hljs-number"><span class="hljs-number">15.398</span></span>/<span class="hljs-number"><span class="hljs-number">3.000</span></span> ms</code> </pre> <br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge mac-table instance vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> vlan-id <span class="hljs-number"><span class="hljs-number">2001</span></span> MAC flags (S -<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MAC, D -dynamic MAC, L -locally learned, C -Control MAC SE -Statistics enabled, NM -Non configured MAC, R -Remote PE MAC) Routing instance : vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> Bridging domain : BRIDGE<span class="hljs-number"><span class="hljs-number">-2001</span></span>, <span class="hljs-attr"><span class="hljs-attr">VLAN</span></span> : <span class="hljs-number"><span class="hljs-number">2001</span></span> MAC MAC Logical NH RTR address flags interface Index ID <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>c:c0 D lsi<span class="hljs-number"><span class="hljs-number">.1048832</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:e5:c0 D ae3<span class="hljs-number"><span class="hljs-number">.201</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well, for completeness, we‚Äôll add a routing interface to our virtual switch: </font></font><br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show | compare [edit interfaces irb] + unit <span class="hljs-number"><span class="hljs-number">2001</span></span> { + description <span class="hljs-string"><span class="hljs-string">"L3 for BRIDGE-2001 | vSwitch-1"</span></span>; + family inet { + address <span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>; + } + } [edit routing-instances vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> bridge-domains BRIDGE<span class="hljs-number"><span class="hljs-number">-2001</span></span>] + routing-interface irb<span class="hljs-number"><span class="hljs-number">.2001</span></span>;</code> </pre> <br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Note: the routing interface is added immediately to the virtual switch bridge domain we need, this interface should not be added to the virtual switch interface hierarchy. </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now check the availability of the irb interface with the RZN-CE2: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-CE2&gt; ping routing-instance VR2 rapid source <span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> PING <span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> (<span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">21.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">3.369</span></span>/<span class="hljs-number"><span class="hljs-number">10.704</span></span>/<span class="hljs-number"><span class="hljs-number">36.307</span></span>/<span class="hljs-number"><span class="hljs-number">12.813</span></span> ms</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There is connectivity, and in the forwarding table on RZN-PE2, the MAC address of the irb interface appeared, which is logically visible through the VPLS port: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show bridge mac-table instance vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> MAC flags (S -<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MAC, D -dynamic MAC, L -locally learned, C -Control MAC SE -Statistics enabled, NM -Non configured MAC, R -Remote PE MAC) Routing instance : vSwitch<span class="hljs-number"><span class="hljs-number">-1</span></span> Bridging domain : BRIDGE<span class="hljs-number"><span class="hljs-number">-2001</span></span>, <span class="hljs-attr"><span class="hljs-attr">VLAN</span></span> : <span class="hljs-number"><span class="hljs-number">2001</span></span> MAC MAC Logical NH RTR address flags interface Index ID <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:c0 D ae3<span class="hljs-number"><span class="hljs-number">.2001</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>:c0 D lsi<span class="hljs-number"><span class="hljs-number">.1048576</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>d:f0 D lsi<span class="hljs-number"><span class="hljs-number">.1048576</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For reference, here is the irb MAC address of the interface with RZN-PE1: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show interfaces irb | match current Current address: <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>d:f0, Hardware address: <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>d:f0</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BRIDGE-302 &gt;&gt;&gt; BRIDGE-502</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Finally, let's collect a scheme in which we will manually rewrite tags: </font></font><br><br><img src="https://habrastorage.org/files/a1e/65d/47b/a1e65d47b3f84a7eb1d27eb5a71d6ee8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the RZN-PE1 side, we have the bridge-domain DOMAIN-302, which is located in the virtual switch vSwitch-2:</font></font><br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# show | compare [edit interfaces ae0] + unit <span class="hljs-number"><span class="hljs-number">900</span></span> { + encapsulation vlan-bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">900</span></span>; + input-vlan-map pop; + output-vlan-map push; + } [edit interfaces ae3] + unit <span class="hljs-number"><span class="hljs-number">302</span></span> { + encapsulation vlan-bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">302</span></span>; + input-vlan-map pop; + output-vlan-map push; + } [edit routing-instances] + vSwitch<span class="hljs-number"><span class="hljs-number">-2</span></span> { + instance-type virtual-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>; + bridge-domains { + DOMAIN<span class="hljs-number"><span class="hljs-number">-302</span></span> { + interface ae3<span class="hljs-number"><span class="hljs-number">.302</span></span>; + interface ae0<span class="hljs-number"><span class="hljs-number">.900</span></span>; + } + } + }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the configuration it can be seen that at the reception the tag will be removed, and, which is logical, the transfer - tagging - nothing complicated. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the RZN-PE2 side, we will simply have the bridge-domain BRIDGE-502 without creating a virtual switch (that is, it will be in the default switch):</font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2# show | compare [edit interfaces ae0] + unit <span class="hljs-number"><span class="hljs-number">900</span></span> { + encapsulation vlan-bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">900</span></span>; + input-vlan-map pop; + output-vlan-map push; + } [edit interfaces ae3] + unit <span class="hljs-number"><span class="hljs-number">502</span></span> { + encapsulation vlan-bridge; + vlan-id <span class="hljs-number"><span class="hljs-number">502</span></span>; + input-vlan-map pop; + output-vlan-map push; + } [edit bridge-domains] + BRIDGE<span class="hljs-number"><span class="hljs-number">-502</span></span> { + domain-type bridge; + interface ae3<span class="hljs-number"><span class="hljs-number">.502</span></span>; + interface ae0<span class="hljs-number"><span class="hljs-number">.900</span></span>; + }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Naturally, and here we take off at the reception, and hang when sending vlan tags. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ultimately, our bridge domains on PE1 / 2 have the following state:</font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge domain instance vSwitch<span class="hljs-number"><span class="hljs-number">-2</span></span> Routing instance Bridge domain VLAN ID Interfaces vSwitch<span class="hljs-number"><span class="hljs-number">-2</span></span> DOMAIN<span class="hljs-number"><span class="hljs-number">-302</span></span> NA ae0<span class="hljs-number"><span class="hljs-number">.900</span></span> ae3<span class="hljs-number"><span class="hljs-number">.302</span></span></code> </pre> <br><pre> <code class="javascript hljs">bormoglotx@RZN-PE2&gt; show bridge domain BRIDGE<span class="hljs-number"><span class="hljs-number">-502</span></span> Routing instance Bridge domain VLAN ID Interfaces <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> BRIDGE<span class="hljs-number"><span class="hljs-number">-502</span></span> NA ae0<span class="hljs-number"><span class="hljs-number">.900</span></span> ae3<span class="hljs-number"><span class="hljs-number">.502</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instead of vlan-id, we have NA - since I have not defined the vlan-id, since I manually pass tags on the interfaces and cannot set this value. </font><font style="vertical-align: inherit;">For example, information about the work of manipulating vlan tags with RZN-PE1:</font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show interfaces ae3<span class="hljs-number"><span class="hljs-number">.302</span></span> | match vlan-tag VLAN-Tag [ <span class="hljs-number"><span class="hljs-number">0x8100</span></span><span class="hljs-number"><span class="hljs-number">.302</span></span> ] In(pop) Out(push <span class="hljs-number"><span class="hljs-number">0x0000</span></span><span class="hljs-number"><span class="hljs-number">.302</span></span>)</code> </pre> <br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show interfaces ae0<span class="hljs-number"><span class="hljs-number">.900</span></span> | match vlan-tag VLAN-Tag [ <span class="hljs-number"><span class="hljs-number">0x8100</span></span><span class="hljs-number"><span class="hljs-number">.900</span></span> ] In(pop) Out(push <span class="hljs-number"><span class="hljs-number">0x0000</span></span><span class="hljs-number"><span class="hljs-number">.900</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we‚Äôll run the ping between the hosts and check if we have connectivity: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-CE1&gt; ping routing-instance VR3 source <span class="hljs-number"><span class="hljs-number">32.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">32.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">32.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">32.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">32.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">5.982</span></span>/<span class="hljs-number"><span class="hljs-number">6.443</span></span>/<span class="hljs-number"><span class="hljs-number">7.162</span></span>/<span class="hljs-number"><span class="hljs-number">0.432</span></span> ms</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MAC addresses appear in the forwarding tables: </font></font><br><br><pre> <code class="javascript hljs">bormoglotx@RZN-PE1&gt; show bridge mac-table instance vSwitch<span class="hljs-number"><span class="hljs-number">-2</span></span> MAC flags (S -<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MAC, D -dynamic MAC, L -locally learned, C -Control MAC SE -Statistics enabled, NM -Non configured MAC, R -Remote PE MAC) Routing instance : vSwitch<span class="hljs-number"><span class="hljs-number">-2</span></span> Bridging domain : DOMAIN<span class="hljs-number"><span class="hljs-number">-302</span></span>, <span class="hljs-attr"><span class="hljs-attr">VLAN</span></span> : NA MAC MAC Logical NH RTR address flags interface Index ID <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:c0 D ae3<span class="hljs-number"><span class="hljs-number">.302</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">86</span></span>:<span class="hljs-number"><span class="hljs-number">71</span></span>:ed:c0 D ae0<span class="hljs-number"><span class="hljs-number">.900</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The truth is, in such a bridge-domain (without specifying a vlan-id) there is a very important limitation - you cannot add a routing interface to this bridge-domain. </font><font style="vertical-align: inherit;">If you try to do this, you will get an error:</font></font><br><br><pre> <code class="javascript hljs">[edit] bormoglotx@RZN-PE1# commit [edit routing-instances vSwitch<span class="hljs-number"><span class="hljs-number">-2</span></span> bridge-domains DOMAIN<span class="hljs-number"><span class="hljs-number">-302</span></span> routing-interface] <span class="hljs-string"><span class="hljs-string">'routing-interface irb.302'</span></span> routing-interface can be configured only under bridge-domain <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-string"><span class="hljs-string">'vlan-id'</span></span> or <span class="hljs-string"><span class="hljs-string">'vlan-tags'</span></span> error: commit failed: (statements constraint check failed)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This can be a very big problem if the L2 domain grows large and suddenly you need to release it to the outside world - in this case you will have to rewrite too much config. Therefore, it is not recommended to use the latest model, I collected it only to demonstrate the possibility of a bridge-domain in JunOS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's all that I wanted to tell. I tried to explain everything as simply as possible, I hope that everything is clear to the reader. If there are any additions / comments - write correct / add.</font></font> Thanks for attention! <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS&gt; The article did not touch on some important topics, such as several learning domains in the same bridge-domain (for an unprepared person, this would be a brain explosion), an indication of the range of vlans for the bridge-domain, and so on. </font><font style="vertical-align: inherit;">These topics are well described in the book Juniper MX-Series-Trio (book in English) - if you are interested in this topic - then this book will be an excellent educational tool.</font></font></div><p>Source: <a href="https://habr.com/ru/post/322560/">https://habr.com/ru/post/322560/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322548/index.html">How to add AppIcon and LaunchScreen to React Native App</a></li>
<li><a href="../322550/index.html">Difficult about simple: ESLint in a team</a></li>
<li><a href="../322552/index.html">How much will your mobile game earn?</a></li>
<li><a href="../322554/index.html">JPEG technology: decision space analysis</a></li>
<li><a href="../322558/index.html">Making a living by creating games</a></li>
<li><a href="../322562/index.html">Architecture of the growing project on the example of VKontakte</a></li>
<li><a href="../322564/index.html">Prospects for the development of public data</a></li>
<li><a href="../322566/index.html">Authorization in ASP.NET Core MVC</a></li>
<li><a href="../322570/index.html">Technical support 3CX responds: sound files are not played and iOS client does not ‚Äúwake up‚Äù</a></li>
<li><a href="../322572/index.html">"Moisten" objects using Cuckoo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>