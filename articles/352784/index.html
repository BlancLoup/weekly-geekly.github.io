<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ESET: Turla Mosquito backdoor used in Eastern Europe</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Turla is one of the most well-known cyber groups specializing in espionage. In its arsenal, an extensive set of tools , the most advanced of which are...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ESET: Turla Mosquito backdoor used in Eastern Europe</h1><div class="post__text post__text-html js-mediator-article">  Turla is one of the most well-known cyber groups specializing in espionage.  In its arsenal, an extensive <a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/">set of</a> <a href="https://habrahabr.ru/company/eset/blog/336804/">tools</a> , the most advanced of which are used to set the priority for attacking machines.  The espionage platform is primarily focused on Windows, but it can be used for macOS and Linux using various backdoors and rootkits. <br><br>  Not so long ago, we discovered a new method of compromising workstations that Turla uses.  This technique is used in attacks aimed at employees of embassies and consulates of the countries of the former Soviet Union. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pj/dr/_o/pjdr_omktt5v5nicu9-xw1mncko.jpeg"></div><br><a name="habracut"></a><h3>  1. Overview </h3><br>  For several years, Turla has used fake installers of the Adobe Flash Player to compromise victims.  Such a vector does not require complex exploits, success depends on the degree of trustfulness of the user who is persuaded to install the fake. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In recent months, we have seen unusual new behavior that leads to infection with one of the Turla backdoors.  It is not only packaged with a real Flash installer, but also looks like it‚Äôs being downloaded from adobe.com.  From the end user's point of view, the remote IP address belongs to Akamai, the official content distribution network (CDN) used by Adobe to distribute its legitimate Flash Player installers.  After examining the process, we found out that the fake Flash installers (including the Snake backdoor installer for macOS) performed a GET request at get.adobe.com URLs to exfiltrate data about new compromised machines.  According to our telemetry, the IP address is the legitimate IP address used by Adobe. <br><br>  In this report, we describe the methods that could lead to similar malicious behavior.  According to our data, the malware did not use legitimate updates of Adobe Flash Player and is not associated with known vulnerabilities of Adobe products.  <b>We can state with confidence that Adobe has not been compromised.</b>  <b>The attackers only used the brand to trick users.</b> <br><br>  We also discovered that the Turla group used a web application hosted on Google Apps Script as a command server (C &amp; C) for JavaScript-malware, which was downloaded by some versions of the fake Flash installer.  Obviously, the attackers tend to work as inconspicuously as possible, disguising their activity in the network traffic of the target organizations. <br><br>  According to telemetry, there is evidence that Turla programs have transmitted information to the get.adobe.com URL at least since July 2016.  The victims are on the territory of the former USSR.  As for <a href="https://habrahabr.ru/company/eset/blog/336804/">Gazer</a> , another malware developed by Turla, its targets are consulates and embassies of Eastern European countries.  We have seen several infections in private companies, but it is unlikely that they were the main targets of the attack.  Finally, some of the victims are infected with other malware that Turla is the author, including ComRAT or Gazer. <br><br><h3>  2. Why do we associate this campaign with a group of Turla? </h3><br>  Before analyzing the unusual network connections, we will explain why we attribute this campaign to Turla. <br><br>  First, some of the fake installers Adobe Flash Player downloads the Mosquito backdoor, which some security companies associate with Turla. <br><br>  Secondly, some C &amp; C servers associated with hosted backdoors use or have previously used <a href="">Turla-related</a> SATCOM IP addresses. <br><br>  Thirdly, malware has common features with other tools of the Turla group.  The similarity includes an identical obfuscation of lines (putting lines on the stack and applying XOR with 0x55) and the same API resolution. <br><br>  These elements allow you to determine with certainty the connection of the campaign with Turla. <br><br><h3>  3. The illegitimate use of Adobe Flash and domains associated with Flash </h3><br>  Using Flash fake installers is not a new tactic for Turla.  So, experts <a href="https://securelist.com/the-epic-turla-operation/65545/">documented</a> this behavior in 2014.  However, in our opinion, the malware is first downloaded via HTTP from legitimate URLs and Adobe IP.  This could be misleading, even for experienced users. <br><br><h4>  3.1.  Imitation of distribution through adobe.com </h4><br>  Since the beginning of August 2016, we have found several attempts to download the Turla installer from the address admdownload.adobe.com. <br><br>  At first glance it seemed that we would see a typical trick consisting in setting the Host header of the HTTP request, while the TCP socket is set to the IP address of the C &amp; C server.  But after deep analysis, we realized that the IP address is legitimate and belongs to Akamai, a large content delivery network (CDN) used by Adobe to distribute the legitimate Flash installer. <br><br>  Even if the executable file is loaded from a legitimate URL (for example, <code>http://admdownload.adobe.com/bin/live/flashplayer27_xa_install.exe</code> ), the referrer field looks changed.  We saw that the field was changed to <code>http://get.adobe.com/flashplayer/download/?installer=Flash_Player</code> , which is not similar to the URL pattern used by Adobe, which caused a 404 error when requested. <br><br>  It is important to note that all download attempts found in the collected data were made via HTTP, not HTTPS.  This allows you to perform a wide range of attacks on the way from the user's machine to Akamai servers. <br><br>  The following section discusses possible compromise scenarios.  <b>The question of what actually happened remains open.</b>  We would appreciate feedback if you have additional information. <br><br><h4>  3.2.  Compromise hypotheses </h4><br>  Figure 1 presents hypotheses that could explain how to force a user, possibly visiting the legitimate Adobe website via HTTP, to download the Turla malware. <br><br><img src="https://habrastorage.org/webt/ee/gf/eq/eegfeq53uwifc4y861vthgthh9k.png"><br>  <i>Figure 1. Possible interception points on the way between the machine of the potential victim and the Adobe servers</i> <br><br>  We quickly eliminated the unauthorized DNS server hypothesis, since the IP address corresponds to the servers used by Adobe to distribute Flash.  After discussing with Adobe and based on their investigations, scenario 5 seems unlikely, since the attackers <b>did not compromise the Flash Player download site</b> .  Thus, the following options remain: <br><br>  1) an attack with a ‚Äúman in the middle‚Äù (MitM) using a compromised machine in the local network, <br>  2) a compromised network gateway or proxy organization, <br>  3) MitM attack at the level of the Internet service provider (ISP), <br>  4) attack on BGP routers ( <a href="https://en.wikipedia.org/wiki/BGP_hijacking">Border Gateway Protocol hijacking</a> ) to redirect traffic to Turla-controlled servers. <br><br><h4>  3.2.1.  Local MitM Attack </h4><br>  Turla operators could use the already compromised machine on the victim‚Äôs network to carry out a local MitM attack.  With ARP spoofing, they could redirect traffic from the target machine to the compromised one on the fly.  And although we are not aware of the availability of such tools in the Turla arsenal, they are not difficult to develop, given the technical capabilities of this group. <br><br>  However, we found many victims in different organizations.  This means that Turla would have to compromise at least one computer in each of these organizations, more precisely, a computer in the subnet of a preferred target. <br><br><h4>  3.2.2.  Compromised gateway </h4><br>  This attack is similar to the previous one, but it is much more interesting for attackers - they can intercept traffic from the entire organization without ARP spoofing, since gateways and proxies usually see all incoming and outgoing traffic between the intranet and the Internet.  We do not know about the presence or absence of a tool for solving this problem with Turla, but their Uroburos rootkit has the ability to analyze packets.  It can be installed on servers and used as a proxy to distribute tasks for infected machines that <a href="http://artemonsecurity.com/snake_whitepaper.pdf">do not have a public IP address</a> .  Turla has sufficient expertise and resources to modify the Uroburos code to intercept traffic on the fly and introduce malicious components, or otherwise change unencrypted content. <br><br><h4>  3.2.3.  MitM provider-level attack </h4><br>  If traffic is not intercepted before leaving the organization‚Äôs internal network, it changes later, on the way to Adobe servers.  The main access point on this segment are Internet providers.  Earlier in ESET <a href="https://habrahabr.ru/company/eset/blog/338422/">announced</a> the spread of FinFisher spyware through the introduction of packages at the ISP level. <br><br>  All victims known to us are in the countries of the former USSR.  They use the services of at least four Internet service providers.  Thus, this scenario assumes that Turla has the ability to monitor traffic in different countries, or data transmission channels. <br><br><h4>  3.2.4.  BGP Router Attack </h4><br>  If the traffic is not changed by the service provider and does not reach the Adobe servers, it means that it is redirected to another server controlled by Turla operators.  This can be done by performing an attack on BGP routers in one of the following ways. <br><br>  On the one hand, Turla operators could use the Autonomous System (AS) to declare a prefix belonging to adobe.com.  Thus, traffic sent to adobe.com from places close to the controlled Turla AS will be sent to their server.  An example of such malicious activity was <a href="https://www.ripe.net/publications/news/industry-developments/youtube-hijacking-a-ripe-ncc-ris-case-study">analyzed by</a> RIPE.  However, this would be quickly noticed in Adobe or in a service that performs BGP monitoring.  In addition, we checked RIPEstat statistics and did not notice any suspicious route announcements for the Adobe IP addresses used in this campaign. <br><br>  On the other hand, Turla operators could use their AS to advertise a shorter path than any other AS to Adobe servers.  Thus, the traffic would also go through their routers and could be intercepted and changed in real time.  However, most of the traffic to Adobe servers would be redirected to an unauthorized router - it is difficult to disguise such tactics and there is a chance that after launching in August 2016, the campaign would soon be discovered. <br><br><h4>  3.2.5.  Total </h4><br>  Of the five scenarios presented in Figure 1, we considered only four, as we are sure that Adobe was not compromised.  The attack on BGP routers and the MitM attack at the service provider level are more difficult than others.  We assume that the Turla group uses a special tool installed on the local gateways of the target organizations, which allows you to intercept and modify traffic before it leaves the intranet. <br><br><h4>  3.3.  Getting information through the URL of get.adobe.com </h4><br>  After the user has downloaded and launched the fake Flash installer, the compromise process starts.  It starts with the introduction of the Turla backdoor.  It may be Mosquito, malware for 32-bit Windows, described in section 4;  a malicious javascript file that communicates with a web application on the Google Apps Script service, described in section 5;  or unknown file downloaded from Adobe fake URL: <br> <code>http://get.adobe.com/flashplayer/download/update/[x32|x64]</code> <br> <br>  In the latter case, since there is no such URL on the Adobe server, to transfer content through it to the Turla group, you need something like MitM on the path between compromised machines and Adobe servers. <br><br>  Next, a query is executed that displays information about the new compromised machine.  This is a GET request at <code>http://get.adobe.com/stats/AbfFcBebD/q=&lt;base64-encoded data&gt;</code> .  According to our data, the legitimate IP address of Adobe is used, but the URL pattern is not similar to that used by Adobe, which causes a 404 error upon request.  Since the request is executed via HTTP, the MitM attack scripts, mentioned earlier in section 3.2, are most likely used. <br><br><img src="https://habrastorage.org/webt/ey/wi/bm/eywibmgteqjkc5la1dpmtvwczjo.png"><br>  <i>Figure 2. Code making a request to the fake URL get.adobe.com</i> <br><br>  The base64-encrypted data contains confidential information about the victim‚Äôs machine.  It would be strange if she actually went to the Adobe server.  Figure 3 is an example of a decoded report.  The data includes a unique ID (the last 8 bytes of the fake Flash installer executable, as shown in Figure 4), the username, the list of installed security products, and the ARP table. <br><br><img src="https://habrastorage.org/webt/vr/aj/kj/vrajkjzhiadzce6gut2qibr8d6k.png"><br>  <i>Figure 3. Installation report sent to the dummy get.adobe.com URL</i> <br><br><img src="https://habrastorage.org/webt/oi/zv/o1/oizvo1xjo4vnvj1yte6tfsyt74g.png"><br>  <i>Figure 4. Unique ID at the end of the installer</i> <br><br>  Interestingly, <a href="https://blog.fox-it.com/2017/05/03/snake-coming-soon-in-mac-os-x-flavour/">the Snake installer for macOS</a> (the backdoor associated with Turla) uses the same URL as in Figure 5. The information transferred is somewhat different because it contains only the user name and the device name, although it is still encoded in base64.  However, this behavior was not documented by Fox-IT when publishing the analysis. <br><br><img src="https://habrastorage.org/webt/cv/o-/tm/cvo-tmcniryoxhnq1ang_hpuw5q.png"><br>  <i>Figure 5. The code that executes the request for the substitute URL URL get.adobe.com in the Snake installer for macOS</i> <br><br>  Finally, the fake installer injects or downloads, and then launches the legitimate Flash Player application.  The legitimate installer is either built into the fake installer, or downloaded via the following path to the Google Drive URL: <code>https://drive.google[.]com/uc?authuser=0&amp;id=0B_LlMiKUOIstM0RRekVEbnFfaXc&amp;export=download</code> <br><br><h3>  4. Win32 backdoor analysis </h3><br>  In this section, we describe samples found in-the-wild, mainly in 2017.  We found evidence that the campaign has been going on for several years, and the samples of 2017 are the result of the evolution of the backdoor into the file <code>InstructionerDLL.dll</code> .  Early samples were less obfuscated, they only had DLL backdoor without a loader, which appeared in later versions.  Some of the older samples have a compilation time stamp of 2009, but most likely they have been corrected. <br><br><h4>  4.1.  Installer </h4><br>  It comes as a fake Flash installer and is bundled with two additional components that are later dropped to disk.  As explained above, we found several users who downloaded the Flash fake installer from the URL and IP used by Adobe to distribute the legitimate installer. <br><br><h4>  4.1.1.  Encryption </h4><br>  In new versions, the installer is always obfuscated, as it seems to us, with the help of encryption.  Figure 6 shows an example of a function obfuscated with this tool. <br><br><img src="https://habrastorage.org/webt/xa/ec/99/xaec9943rvnrrz0p-z-kjnlg-fu.png"><br>  <i>Figure 6. Obfuscated function</i> <br><br>  First, this cryptographer widely uses fuzzy predicates together with arithmetic operations.  For example, an obfuscated function counts a number from hard-coded values ‚Äã‚Äãand then compares it in magnitude with another hard-coded value.  Thus, during each execution, the process will be the same, but emulation is required to determine the correct path.  Therefore, the code becomes too complicated for analysis both for analysts and for automated security software algorithms.  This can slow down the emulation to such an extent that the object will not be scanned due to time constraints, and as a result, the specified (if not obfuscated) malware will not be detected. <br><br>  Second, after the first deobfuscation step, a call is made to the Win32 API <code>SetupDiGetClassDevs(0,0,0,0xFFFFFFFF)</code> , and the cryptographer checks if the resulting value is 0xE000021A.  The function is usually used to obtain information about devices in the system.  Although a certain value of <code>Flags (0xFFFFFFFF)</code> not documented, according to our tests, the resulting value always corresponds to <code>0xE000021A</code> on Windows 7 and Windows 10 machines. We believe that similar API requests and subsequent testing are done to bypass the sandbox and emulation mode that are incorrect in a way. <br><br>  Thirdly, the present code is divided into several fragments, which are decrypted using a special function and are ordered at run time to create PE in memory.  It is then performed using the function of the PE bootloader encoder.  This PE bootloader contains several debug lines, as shown in Figure 7. <br><br><img src="https://habrastorage.org/webt/o7/lk/ar/o7lkarilc9nz-v3hcyneyrkmwpy.png"><br>  <i>Figure 7. Debug strings in PE loader function</i> <br><br><h4>  4.1.2.  Installation </h4><br>  After decryption, the installer searches for the <code>%APPDATA%</code> subfolder and drops two files into the folder with the longest path to it.  When searching for such a folder, it bypasses any name containing <code>AVAST</code> in the title.  He then uses the name of one of the non-hidden files in this folder with the cropped extension as the base name for the dumped files.  If all files in the directory are hidden, or if the directory is empty, it uses the name of the <code>%WINDIR%\System32</code> DLL.  The dump loader has the extension <code>.tlb</code> , and the main backdoor is <code>.pdb</code> .  Interestingly, it does not use <code>WriteFile</code> to reset two DLLs.  Instead, it creates a file, marks it in memory, and calls <code>memmove</code> to copy the data.  Perhaps this is done to bypass the hooks to <code>WriteFile</code> security products and sandboxes. <br><br>  We also saw earlier versions of the installer, which only downloaded one file with the extension <code>.tlb</code> .  In this case, the same file contains the functions of the loader and backdoor.  <code>DllMain</code> selects which code to execute. <br><br>  He writes a simple unencrypted log file in <code>%APPDATA%\kb6867.bin</code> .  The complete file is created in the same directory as these two DLLs and has the extension <code>.tnl</code> . <br><br><img src="https://habrastorage.org/webt/dn/zq/3l/dnzq3lpkhxyqpdhspmuenqptjqu.png"><br>  <i>Figure 8. Files created in the random% child directory% APPDATA%</i> <br><br>  It then provides persistence using the Run registry key, or <a href="https://www.gdatasoftware.com/blog/2014/10/23941-com-object-hijacking-the-discreet-way-of-persistence">COM interception</a> .  If the display name of the antivirus obtained by Windows Management Instrumentation (WMI) corresponds to Total Security, then it adds the entry <code>rundll32.exe</code> [path to backdoor], <code>StartRoutine</code> to the <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Run\auto_update</code> . <br><br>  Otherwise, it replaces the registry entry in <code>HKCR\CLSID\{D9144DCD-E998-4ECA-AB6A-DCD83CCBA16D}\InprocServer32</code> or <code>HKCR\CLSID\{08244EE6-92F0-47F2-9FC9-929BAA2E7235}\InprocServer32</code>  These CLSIDs are <code>EhStorShell.dll</code> and <code>ntshrui.dll</code> respectively.  These DLLs are legitimately started by many processes, including <code>explorer.exe</code> , a Windows graphical interface.  Thus, the bootloader will be called every time <code>explorer.exe</code> launched.  Finally, it adds a registry entry to store the path to the original intercepted DLL and the main backdoor, as shown in Figure 9. <br><br><img src="https://habrastorage.org/webt/hj/_f/fy/hj_ffypkgc2luq7-ooud33kn_58.png"><br>  <i>Figure 9. Registry modification for sustainability</i> <br><br>  The rest of the CLSIDs are hardcoded in a binary file, but we did not see them being used.  The full list is available in the section with compromise indicators. <br><br>  As explained in the previous section, the installer sends some information, such as a unique sample ID, username, or ARP table, to the Adobe <code>get.adobe.com</code> domain URL.  It also launches the real Adobe Flash installer, which is either downloaded from Google Drive or built into the fake installer. <br><br>  Before running the main backdoor, the installer creates a <code>HelpAssistant</code> administrator <code>HelpAssistant</code> (or <code>HelpAsistant</code> in some samples) with the password <code>sysQ!123</code> .  <code>LocalAccountTokenFilterPolicy</code> changed to <code>1</code> , allowing remote control actions.  We believe that this account name is necessary to go unnoticed, as this name is used during the legitimate session of <a href="https://technet.microsoft.com/en-us/library/dn745900(v%3Dws.11).aspx">remote assistance</a> . <br><br><h4>  4.2.  DebugParser (launcher) </h4><br>  A launcher called <code>DebugParser.dll</code> is called during the loading of a captured COM object.  It is responsible for starting the main backdoor and loading the intercepted COM object.  A simplified pseudo-component code is shown in Figure 10. <br><br><img src="https://habrastorage.org/webt/i6/q2/mo/i6q2motn2uh80u_hkzaniwmb5sa.png"><br>  <i>Figure 10. Launch pseudocode</i> <br><br>  However, he uses some tricks to load the intercepted library and return to the right address.  The process is described below: <br><br>  1. Get the original return address after a legitimate call to <code>LoadLibrary</code> .  At the beginning of the <code>DllMain</code> is stored registry value ESP.  It then checks <code>FF 15</code> (CALL call operation code) in ESP - 6. If it is present, the registry leaves the original return address. <br><br><img src="https://habrastorage.org/webt/9j/uo/qp/9juoqp7dk-7rbum6vrxdcx2ulxy.png"><br>  <i>Figure 11. Address lookup after calling LoadLibrary</i> <br><br>  2. Allocate RWX memory containing the following values: <br><br><img src="https://habrastorage.org/webt/2c/hn/hu/2chnhuknygmnbvtf6finmu4iexo.png"><br>  <i>Figure 12. Memory Allocation</i> <br><br>  3. Switch to the capture function by modifying the address of the <code>DllMain</code> response. <br><br>  4. In the interception function: <br>  a.  function call, which is responsible for loading <code>ntshrui.dll</code> (or any other intercepted library) <br>  b.  <code>FreeLibrary</code> call in <code>DebugParser.dll</code> (backdoor loader) <br>  c.  go to the original address of the reply before interception. <br><br>  Since the original DLL is loaded, the user will most likely not notice that the backdoor is running. <br><br>  In early versions, in which the loader and backdoor functions are combined in one file, <code>DllMain</code> chooses which code to execute, as shown in Figure 13. <br><br><img src="https://habrastorage.org/webt/2m/aw/6d/2maw6dep5jg_b9ypqydis41qxa0.png"><br>  <i>Figure 13. Loader and backdoor in one library</i> <br><br><h3>  4.3.  Main backdoor </h3><br>  The main backdoor of this campaign <code>CommanderDLL.dll</code> , so named by the authors, is launched either by the bootloader described above, or directly at launch, if the selected persistence mechanism is the Run key in the registry.  In both cases, the export of <code>StartRoutine</code> , as shown in Figure 14, but this export is not in the DLL export table. <br><br><img src="https://habrastorage.org/webt/m1/ol/x9/m1olx9x8jd4h6xr4muaeyot1c94.png"><br>  <i>Figure 14. In the DLL there is no EXPORT Address Table in the .reloc section</i> <br><br>  In the <code>DllMain</code> function, an export table is created to output it: <br>  1. It creates an <code>IMAGE_EXPORT_DIRECTORY</code> structure with <code>StartRoutine</code> as the name of a single export. <br>  2. Copies this structure after moving the partition located at the end of the PE image in memory <br>  3. Changes the header field of PE containing the Relative Virtual Address (RVA) of the export table to the address of the newly created export table <br><br>  With these edits in the memory library, there is an export called <code>StartRoutine</code> , as shown in Figures 15 and 16. Figure 17 is a screenshot from a Hex-Rays decompiler showing the code for the entire process of adding this export. <br><br><img src="https://habrastorage.org/webt/je/uq/jg/jeuqjgf-ibecr9zpo60t89geuyc.png"><br>  <i>Figure 15. Newly created export table</i> <br><br><img src="https://habrastorage.org/webt/mh/cl/u5/mhclu598y43yjthcpk6hw49n3a0.png"><br>  <i>Figure 16. New export name</i> <br><br><img src="https://habrastorage.org/webt/7k/th/xw/7kthxwg2ymajxoch_0cnsgpzvme.png"><br>  <i>Figure 17. Export table patching process</i> <br><br><h4>  4.3.1.  Customization </h4><br>  First, the <code>CommanderDLL</code> module deletes the dropper file (fake Flash installer).  The path is passed from the dropper through a named pipe called <code>\\.\pipe\namedpipe</code> .  Then, in the new process, it creates the second named pipe <code>\\.\pipe\ms32loc</code> , and waits until another process connects to this channel, after which the program ends. <br><br>  Secondly, CommanderDLL configures some internal structures and stores configuration values ‚Äã‚Äãin the registry.  Table 1 describes the various registry values ‚Äã‚Äãthat are stored in the <code>HKCU\Software\Microsoft\[dllname]</code> . <br><br>  <i>Table 1. Backdoor registry values</i> <br><img src="https://habrastorage.org/webt/mm/tu/7j/mmtu7j-7u8ykhsmrglzehri_t1q.png"><br><br>  All registry values, except for the layout record, are encrypted using a special algorithm, which is described in Section 4.3.2. <br><br>  Thirdly, the additional address of the C &amp; C server is loaded from a document stored in Google Docs <i>(https://docs.google [.] Com / uc? Authuser = 0 &amp; id = 0B_wY-Tu90pbjTDllRENWNkNma0k &amp; export = download)</i> .  It is encrypted using the algorithm described in 4.3.2. <br><br><h4>  4.3.1.  Encryption </h4><br>  The backdoor uses a special encryption algorithm.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each byte of plain text is added modulo 2 in a stream generated by a function similar to </font></font><a href="https://en.wikipedia.org/wiki/Blum_Blum_Shub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Blum Blum Shub algorithm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">For encryption or decryption, the key and the module are transferred to the encryption function. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Different samples use different keys and modules. </font><font style="vertical-align: inherit;">Some are hardcoded, some are generated during execution. </font><font style="vertical-align: inherit;">Table 2 describes the various keys and modules used by malware. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table 2. Encryption keys and modules</font></font></i> <br><img src="https://habrastorage.org/webt/wg/h6/gd/wgh6gdlrn5r_l18nsbfr3plmx9a.png"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.3.3. </font><font style="vertical-align: inherit;">Log</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The program maintains a log file called </font></font><code>[dllname].tnl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Interestingly, it contains a timestamp of each entry, which allows you to track the chain of events occurring on the compromised machine. </font><font style="vertical-align: inherit;">This can be useful for cybercriminals. </font><font style="vertical-align: inherit;">It is encrypted using the algorithm described above. </font><font style="vertical-align: inherit;">The key is located after the indent in 0x20 in the header of the log file, the module is always 0x5DEE0B89. </font><font style="vertical-align: inherit;">Figure 18 describes the structure of this file. </font></font><br><br><img src="https://habrastorage.org/webt/u7/w4/gf/u7w4gfrvf2tr-zpm4todoucnm00.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 18. Log file structure </font></font></i> <br><br><img src="https://habrastorage.org/webt/us/ic/xo/usicxovugcia0gpaqxq8kftqvfu.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 19. Log file start</font></font></i> <br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.3.4. </font><font style="vertical-align: inherit;">Data exchange C &amp; C server and backdoor commands</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The main backdoor loop is responsible for managing data exchange with the C &amp; C server and executing the commands it sends. At the beginning of each of them, it is in an inactive state for a random time period, but usually about 12 minutes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Request to server always uses the URL on the same scheme: </font></font><code>https://[C&amp;C server domain]/scripts/m/query.php?id=[base64(encrypted data)]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The user software agent is hard-coded in the samples and cannot be changed: </font></font><br> <code>Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Chrome 41 uses this default value. The parameter structure is </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">described in Figure 20. </font></font><br><br><img src="https://habrastorage.org/webt/-k/rb/cc/-krbcckxip3oejkbdjyebmcstwo.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 20. The structure of the request to the C &amp; C server ‚ÄìGET request with data in the id parameter</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Previous sample is the case where the </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET request </font><font style="vertical-align: inherit;">parameter </font><font style="vertical-align: inherit;">contains a structure</font></font><code>Data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. However, the data may also be contained within a cookie (with a full name) or a POST request. Figure 21 describes the various possibilities. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In all these cases, the encryption key is the first DWORD of the </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URL address </font><font style="vertical-align: inherit;">structure </font><font style="vertical-align: inherit;">. The key, in combination with the 0x7DFDC101 module, can decrypt the structure </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, POST data and cookie value. The payload is then decrypted from the data structure. </font></font><br><br><img src="https://habrastorage.org/webt/x_/lx/bq/x_lxbqm5epja4ry7y7k0ypz9bou.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 21. Selecting the request</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The original request contains general information on the compromised machine, such as the result of commands </font></font><code>ipconfig</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>set</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>whoami</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>tasklist</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The C &amp; C server then issues one of the instruction sets as a response. </font><font style="vertical-align: inherit;">The structure of this answer is shown in Figure 21. The packet is fully encrypted (except for the first four bytes) by the same algorithm borrowed from the Blum Blum Shub, described in section 4.3.2, which uses the first DWORD as the key and 0x7DFDC101 for the module. </font><font style="vertical-align: inherit;">Each instruction set is encrypted separately using 0x3EB13 for the key and 0x7DFDC101 for the module. </font></font><br><br><img src="https://habrastorage.org/webt/zp/hi/ky/zphikyl-udupxh22zyyot57qfmy.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 22. The structure of the C &amp; C response package.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backdoor can execute some predefined actions, hard-coded in a binary file. </font><font style="vertical-align: inherit;">Table 3 provides a brief description of the available commands. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table 3. Description of available backdoor commands</font></font></i> <br><img src="https://habrastorage.org/webt/di/rl/pz/dirlpzgzt24bnamsvsknhuvk1rq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In some analyzed samples, a backdoor can also run PowerShell scripts.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5. JavaScript backdoor analysis </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some fake Flash installers deliver two backdoors to JavaScript instead of Mosquito. These files are flushed to a folder </font></font><code>%APPDATA%\Microsoft\</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. They are called </font></font><code>google_update_checker.js  local_update_checker.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first interacts with a web application hosted on the Google Apps Script service at: </font></font><code>(https://script.google[.]com/macros/s/AKfycbwF_VS5wHqlHmi4EQoljEtIsjmglLBO69n_2n_k2KtBqWXLk3w/exec)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and waits for a response encoded on base64. It then executes the decoded content with eval. We do not know the exact purpose of the additional backdoor, but it can be used to download additional Malvar, or execute malicious JavaScript code directly. To ensure persistence, it adds value </font></font><code>Shell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second JavaScript file reads </font></font><code>%ProgramData%\1.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and executes the contents using the function </font></font><code>eval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. To ensure persistence, it adds value</font></font><code>local_update_check</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. Conclusion </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The campaign shows that Turla Cybergroups has many tools for masking malicious traffic under legitimate. The methods used can be misleading even by experienced users. Using HTTPs could reduce the effectiveness of such attacks ‚Äî in this protocol it is more difficult to intercept and replace encrypted traffic on the way from the machine to the remote server. File signature verification should be suspicious, because the files used by Turla are not signed, unlike Adobe installers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, the new campaign points to the interest of Turla in the staff of consulates and embassies located in Eastern European countries. The group makes a lot of effort to ensure access to these sources of information. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For questions related to the campaign, contact threatintel@eset.com.</font></font></i> <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. Indicators of compromise </font></font></h3><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.1. </font><font style="vertical-align: inherit;">Addresses of command servers (by year)</font></font></h4><br> <code>2017: smallcloud.ga <br> 2017: fleetwood.tk <br> 2017: docs.google.com/uc?authuser=0&amp;id=0B_wY-Tu90pbjTDllRENW <br> NkNma0k&amp;export=download (adstore.twilightparadox.com) <br> 2017: bigpen.ga <br> 2017: https://script.google.com/macros/s/AKfycbxxPPyGP3Z5wgwbs <br> mXDgaNcQ6DCDf63vih-Te_jKf9SMj8TkTie/exec <br> 2017: https://script.google.com/macros/s/AKfycbwF_VS5wHqlH <br> mi4EQoljEtIsjmglLBO69n_2n_k2KtBqWXLk3w/exec <br> 2017-2015: ebay-global.publicvm.com <br> 2017-2014: psychology-blog.ezua.com <br> 2016: agony.compress.to <br> 2016: gallop.mefound.com <br> 2016: auberdine.etowns.net <br> 2016: skyrim.3d-game.com <br> 2016: officebuild.4irc.com <br> 2016: sendmessage.mooo.com <br> 2016, 2014: robot.wikaba.com <br> 2015: tellmemore.4irc.com</code> <br> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2. </font><font style="vertical-align: inherit;">Fake adobe addresses</font></font></h4><br> <code>http://get.adobe[.]com/stats/AbfFcBebD/?q=&lt;base64-encoded data&gt; <br> http://get.adobe[.]com/flashplayer/download/update/x32 <br> http://get.adobe[.]com/flashplayer/download/update/x64</code> <br> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3. </font><font style="vertical-align: inherit;">Unofficial addresses of legitimate flash installers</font></font></h4><br> <code>https://drive.google[.]com/uc?authuser=0&amp;id=0B_LlMiKUOIsteEtraEJYM0QxQVE&amp;export=download <br> https://drive.google[.]com/uc?authuser=0&amp;id=0B_LlMiKUOIstM0RRekVEbnFfaXc&amp;export=download</code> <br> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.4. </font><font style="vertical-align: inherit;">Hashes</font></font></h4><br><img src="https://habrastorage.org/webt/26/xv/r8/26xvr8-llhtt50xqmaxlq_nrby8.png"><br><img src="https://habrastorage.org/webt/mz/kb/xg/mzkbxgreuxzy3iw3oaw2rdvkzio.png"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.5. </font><font style="vertical-align: inherit;">Windows artifacts</font></font></h4><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.5.1. </font><font style="vertical-align: inherit;">Intercepted CLSID</font></font></h4><br> <code>{D9144DCD-E998-4ECA-AB6A-DCD83CCBA16D} <br> {08244EE6-92F0-47F2-9FC9-929BAA2E7235} <br> {4E14FBA2-2E22-11D1-9964-00C04FBBB345} <br> {B5F8350B-0548-48B1-A6EE-88BD00B4A5E7} <br> {603D3801-BD81-11D0-A3A5-00C04FD706EC} <br> {F82B4EF1-93A9-4DDE-8015-F7950A1A6E31} <br> {9207D8C7-E7C8-412E-87F8-2E61171BD291} <br> {A3B3C46C-05D8-429B-BF66-87068B4CE563} <br> {0997898B-0713-11D2-A4AA-00C04F8EEB3E} <br> {603D3801-BD81-11D0-A3A5-00C04FD706EC} <br> {1299CF18-C4F5-4B6A-BB0F-2299F0398E27}</code> <br> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7.5.2. </font></font> Files </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Three files with the same name, but different extensions (.tlb, .pdb and .tnl) in the folder </font></font><code>%APPDATA%</code> <br> <code>%APPDATA%\kb6867.bin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(simplified log file)</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6. </font><font style="vertical-align: inherit;">Detection by ESET products</font></font></h4><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6.1. </font><font style="vertical-align: inherit;">Recent samples</font></font></h4><br> <code>Win32/Turla.CQ <br> Win32/Turla.CP <br> Win32/Turla.CR <br> Win32/Turla.CS <br> Win32/Turla.CT <br> Win32/Turla.CU <br> Win32/Turla.CV <br> Win32/Turla.CW <br> Win32/Turla.CX</code> <br> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6.2. </font><font style="vertical-align: inherit;">Old options</font></font></h4><br> <code>Win32/TrojanDownloader.CAM <br> Win32/TrojanDownloader.DMU</code> <br> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6.3. </font><font style="vertical-align: inherit;">JavaScript backdoor</font></font></h4><br> <code>JS/Agent.NWB <br> JS/TrojanDownloader.Agent.REG</code> </div><p>Source: <a href="https://habr.com/ru/post/352784/">https://habr.com/ru/post/352784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352772/index.html">Announcement of Moscow Spark # 4</a></li>
<li><a href="../352774/index.html">Is there any powder in the old dog? Hackathon Radio Canada 2018 (Part One, We Make a Team)</a></li>
<li><a href="../352776/index.html">What's new in LLVM</a></li>
<li><a href="../352778/index.html">Does the manager need to be able to program</a></li>
<li><a href="../352782/index.html">Debugging multithreaded programs based on FreeRTOS</a></li>
<li><a href="../352786/index.html">How to use Azure for free (life hacking for students)</a></li>
<li><a href="../352790/index.html">Public Key Infrastructure: Certification Center based on the OpenSSL utility, SQLite3 and Tcl / Tk</a></li>
<li><a href="../352792/index.html">Conference DEFCON 22. ‚ÄúTraveling on the dark side of the Internet. Introduction to Tor, Darknet and Bitcoin ¬ª</a></li>
<li><a href="../352794/index.html">Generative adversarial networks</a></li>
<li><a href="../352798/index.html">Reality of reuse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>