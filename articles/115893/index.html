<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Antipattern settings.py</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habrapitonam hello! 

 From time to time I come across development patterns that exist not because they solve a problem well, but because it is done i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Antipattern settings.py</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e15/0a4/474/e150a447454a21df5f43482cbd9e8260.jpg" align="right"><br><br>  Habrapitonam hello! <br><br>  From time to time I come across development patterns that exist not because they solve a problem well, but because it is done in the popular framework X, therefore, many people think that this is good. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now I want to celebrate the ‚Äúall settings - in settings.py‚Äù pattern.  It is clear that he gained popularity thanks to Django.  I now and again meet in projects that are not tied to this framework the same story: a large code base, small, pretty unrelated components, and here you are: all together from arbitrary places climb into the magic nedomodul settings for their constants. <br><br>  So, why is this approach in my opinion disgusting. <br><br><a name="habracut"></a><br><h4>  Problems with cascading settings </h4><br><br>  In real-life projects, as a rule, you need at least three sets of settings: to drive a project to localhost, to launch unittest, and to turn everything on combat servers.  In this case, most of the settings usually coincide in all cases, and some are different. <br><br>  For example, you use MongoDB as storage.  In general, you need to <code>my_project</code> to it on localhost and use a DB called <code>my_project</code> .  However, to launch unittest, you need to take DB with a different name so as not to hurt the combat data: say, <code>unittests</code> .  And in the case of production, you need to connect not to localhost, but to a well-defined IP, to a server sent under Mong. <br><br>  So how, depending on the external <code>settings.MONGODB_ADDRESS</code> of settings.py should take on different values?  Usually a voodoo-construction at the end consisting of <code>__import__</code> , <code>__dict__</code> , <code>vars()</code> , <code>try/except ImportError</code> , which tries to add and block the namespace with all the giblets of another module like settings_local.py. <br><br>  The fact that it is additionally necessary to load <code>_local.py</code> is specified either by a hardcode or through an environment variable.  In any case, so that the same unit tests, for example, enable their settings only at the time of launch, you have to dance with a tambourine and break the Zen of Python: Explicit is better than implicit. <br><br>  In addition, this solution involves another problem, described below. <br><br><h4>  Executable code </h4><br><br>  To store settings in the form of an executable py-code is creepy.  In fact, the entire pattern, apparently, originally appeared as a supposedly simple and elegant solution: ‚ÄúWhy do we need some cfg parsers if you can do everything right on the python?  And there are more opportunities! ‚Äù  In scenarios a little harder than a trivial solution turns sideways.  Consider, for example, such a snippet: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># settings.py BASE_PATH = os.path.dirname(__file__) PROJECT_HOSTNAME = 'localhost' SOME_JOB_COMMAND = '%s/bin/do_job.py -H %s' % (BASE_PATH, PROJECT_HOSTNAME) # settings_production.py PROJECT_HOSTNAME = 'my-project.ru'</span></span></code> </pre><br><br>  Do you understand what the problem is?  The fact that we have overlapped the value of <code>PROJECT_HOSTNAME</code> absolutely on the drum for the total value of <code>SOME_JOB_COMMAND</code> .  We could grit our teeth with copying the definition of <code>SOME_JOB_COMMAND</code> after overlapping, but even this is not possible: <code>BASE_PATH</code> is in another module.  Copy-paste it too?  Is it too? <br><br>  I'm not saying that the executable code as a configuration can simply lead to the difficult to <code>ImportError</code> when the application starts in a new environment. <br><br>  Therefore, I am sure that flies should be separately, cutlets separately: the basic values ‚Äã‚Äãin the text file, calculated in the py-module. <br><br><h4>  High-coupling </h4><br><br>  A good project is one project that can be disassembled into small cubes, and each cube is put on github as a full-fledged open-source project. <br><br>  When everything is the same, but with one BUT: ‚Äúbe so kind as to have settings.py in the root of the project and so that it contains the settings <code>FOO_BAR</code> , <code>FOO_BAZ</code> and <code>FOO_QUX</code> ‚Äù it looks like something absurd, isn't it?  And when something sounds ridiculous, it usually means that there are situations in which this nonsense is auditioned. <br><br>  In our case, the example does not force itself to invent for a long time.  Let our application work with the VKontakte API, and we have something like <code>VKontakteProfileCache</code> , which uses <code>settings.VK_API_KEY</code> and <code>settings.VK_API_SECRET</code> in the forehead.  Well used and enjoyed, and then again, and our project should start working immediately with several VKontakte applications.  And everything, <code>VKontakteProfileCache</code> designed so that it works only with one pair of credentials. <br><br>  Therefore, slimmer and more expedient to never ever access the settings module directly.  Let all consumers accept the necessary settings through the parameters of the constructor, through the dependency injection framework, whatever you like, but not directly.  And let the concrete settings let them pull out the very lowest level, like code in <code>if __name__ == '__main__'</code> .  And how could he take them - his personal problems.  With this approach, unit-testing is also extremely simplified: with what settings you need to run, with those we create. <br><br><h4>  Possible Solution </h4><br><br>  So, the ‚Äúsettings.py‚Äù pattern was covered with mud.  I feel better, thank you.  Now about a possible solution.  I have used a similar approach in several projects and find it convenient and devoid of the problems listed. <br><br>  Settings stored in text ini-style files.  For parsing, <a href="http://www.voidspace.org.uk/python/configobj.html">we</a> use <a href="http://www.voidspace.org.uk/python/configobj.html">ConfigObj</a> : it has richer possibilities in comparison with the standard ConfigParser, in particular, it is very easy to make cascades with it. <br><br>  In the project, we create the base settings file <code>default_settings.cfg</code> with all possible settings and their values ‚Äã‚Äãwith a reasonable default. <br><br>  We create the utils.config module with functions like <code>configure_from_files()</code> , <code>configure_for_unittests()</code> , which return an object with settings for different situations.  <code>configure_from_files()</code> organizes a cascading file search: <code>default_settings.cfg</code> , <code>~/.my-project.cfg</code> , <code>/etc/my-project.cfg</code> and probably somewhere else.  It all depends on the project. <br><br>  The calculated settings are evaluated by the last step of the assembly of the configuration object. <br><br>  The module itself is only used for launching processes or tests.  All classes interested in the settings receive ready-made values ‚Äã‚Äãvia injections, that is, they do not communicate with the settings directly.  In fact, it is not always convenient when the darkness is still better to transfer the entire configuration object, but this does not negate the fact that it needs <i>to</i> be <i>transmitted</i> - no appeal to the forehead. <br><br>  Perhaps I have written too much about such a ‚Äútrifle‚Äù as settings.  But if at least someone, after reading, thinks about blindly copying a far from perfect approach to something and makes it better, simpler, more fun, I will consider the mission of this post accomplished. </div><p>Source: <a href="https://habr.com/ru/post/115893/">https://habr.com/ru/post/115893/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115886/index.html">Using bash completion on the command line, your own scripts and applications. Part 2</a></li>
<li><a href="../115887/index.html">I can dig, I can not dig</a></li>
<li><a href="../115890/index.html">We find out who follows you mutually</a></li>
<li><a href="../115891/index.html">Layers in mobile Yandex.Maps</a></li>
<li><a href="../115892/index.html">From idea to prototype in two days: HackDay will arrive in Voronezh and Yaroslavl in early April</a></li>
<li><a href="../115896/index.html">Email, SaaS and Clouds</a></li>
<li><a href="../115897/index.html">100 per 100</a></li>
<li><a href="../115900/index.html">SE Xperia arc Review: Arc de Triomphe</a></li>
<li><a href="../115901/index.html">After Visual Studio 2010 SP1, New Developer Tools</a></li>
<li><a href="../115902/index.html">Black White</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>