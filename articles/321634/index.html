<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PROTEQ - multigigabit exchange protocol for Xilinx FPGA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Modern FPGAs contain multi-gigabit communication lines and there are a large number of protocols for exchange. However, upon closer examination, it is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PROTEQ - multigigabit exchange protocol for Xilinx FPGA</h1><div class="post__text post__text-html js-mediator-article">  Modern FPGAs contain multi-gigabit communication lines and there are a large number of protocols for exchange.  However, upon closer examination, it is not always convenient to use standard protocols in FPGA.  For example, for Xilinx FPGAs, PCI Express, RapidIO, Aurora;  Each of them has flaws.  PCI Express and RapidIO work with 8/10 encoding, which immediately limits throughput.  Aurora can work with 64/66 encoding but does not provide data recovery after a crash.  Taking into account the shortcomings of standard protocols and application features, I decided to implement my own exchange protocol. <br><a name="habracut"></a><br>  The PROTEQ name was inherited from the previous project for which a similar idea of ‚Äã‚Äãdata recovery after a crash was expressed. <br><br>  So the source data: <br><br>  ‚Ä¢ hardware - module FMC106P, two FPGA Virtex 6 LX130T-2 and LX240T-1 <br>  ‚Ä¢ transfer rate - 5 Gbit / s <br>  ‚Ä¢ number of lines - 8 <br>  ‚Ä¢ data source - ADC, there is no possibility to suspend the transfer <br>  ‚Ä¢ bidirectional data exchange <br>  ‚Ä¢ it is required to realize fast data recovery after failure <br>  ‚Ä¢ encoding - 64/67 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The basic idea is to implement a constant retransmission of data before the arrival of confirmation of the received packet.  This is the main feature of the protocol and it is this that allows you to speed up data recovery. <br><br>  Consider the implementation of one line: <br><br><img src="https://habrastorage.org/files/a52/79f/0b1/a5279f0b164e4f4d9ab2cb264c175d21.png"><br><br>  Four buffers are implemented on the transmitter.  The data source detects a free buffer and writes data to it.  Record goes in the strict order 0,1,2,3;  The transmission node also polls the buffer fill flag in a circle and starts transmitting data from the filled buffers.  When reception is received from the receiver, the buffer is marked free.  With a large data stream, the confirmation has time to come before the transfer of all four buffers and the transfer is at maximum speed.  With a small stream, the transmit node will have time to send a repeated packet, but it will be dropped on the receiving side. <br><br>  This solution greatly speeds up data recovery.  In the traditional scheme, the receiver must accept the packet, analyze it, and form a request for retransmission.  This is a long time. <br><br>  Four buffers are also implemented on the receiver.  The packet header contains the buffer number and the packet is immediately sent to the destination buffer.  In this decision there is a very big danger.  If the buffer number is corrupted, it is possible that two packets will be corrupted - both the current packet and the packet already received.  To avoid this, the package uses two checksums - one goes right after the heading, the second - at the end of the package. <br><br>  For the 5 Gbps speed on the GTX node, a 32-bit bus with a frequency of 156.25 MHz is used.  The exchange between the FIFO and internal buffers is at a frequency of 250 MHz.  This provides a speed margin for recovery.  For example, if an error occurred during transfer to buffer 1, and transfer to buffer 2 and 3 occurred without error, then writing to the output FIFO will be delayed until the packet comes back to buffer 1. But after that, packets from buffers 2 and 3 will be immediately written to the FIFO. <br><br>  The protocol uses a fixed packet length of 256 words 32 bits each.  There are two types of package: <br><br><ul><li>  Data packet </li><li>  Service pack </li></ul><br>  Data packet format: <br><br><ul><li>  CMD1 </li><li>  CRC1 </li><li>  DATA - 256 words </li><li>  CMD2 </li><li>  CRC2 </li></ul><br>  Service Package Format: <br><br><ul><li>  CMD1 </li><li>  CRC1 </li><li>  CMD2 </li><li>  CRC2 </li></ul><br>  Overhead is quite low - only four 32-bit words.  The total length of the data package is 260 words. <br><br>  Service packets are transmitted in the absence of data. <br><br>  To increase the speed of the transmission is implemented on several lines.  There is a node that works with the number of lines from 1 to 8. For each line, the width of the data bus is 32 bits.  When using 8 lines, the total data bus width is 256 bits. <br><br>  The estimated exchange rate for eight lines at a frequency of 5 GHz: <br><br><blockquote>  5000000000 * 64/67 * 256/260 * 8/8/1024/1024 = 4484.7 MB / s </blockquote><br>  It is this speed achieved as a result of experiments.  Errors occur periodically, but they are corrected by the protocol.  Fast recovery allows you to use a small FIFO size to connect the ADC. <br><br>  It is interesting to compare the effectiveness of PROTEQ with PCI Express v2.0 implemented on the same FPGA.  Both protocols use eight links at a speed of 5 Gbps.  The maximum exchange rate is: <br><br><blockquote>  5,000,000,000 / 8/1024/1024 * 8 = 4768 MB / s </blockquote><br>  PROTEQ Efficiency: <br><br><blockquote>  4484/4768 = 0.94;  those.  94% of maximum line speed. </blockquote><br>  PCI Express provides 3200 MB / s <br><br>  3200/4768 = 0.67;  those.  67% of maximum line speed. <br><br>  Of course, the main reason for the low performance of PCI Express v2.0 is the use of 8/10 encoding; <br><br>  It is also interesting to compare the FPGA resources occupied for the implementation of protocols.  The figure shows the areas that occupies PCI Express and PROTEQ with comparable functionality.  It should be borne in mind that PCI Express uses another HARD unit. <br><br><img src="https://habrastorage.org/files/dbf/801/4d5/dbf8014d5ced40c5a3897ab34fd4a67f.png"><br><br>  The main component is prq_transceiver_gtx_m1 <br><br><div class="spoiler">  <b class="spoiler_title">prq_transceiver_gtx_m1</b> <div class="spoiler_text"><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-function">component prq_transceiver_gtx_m1 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">is</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generic</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> is_simulation : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; -- </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -   LINES : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer; --  MGT  RECLK_EN : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; -- </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -     recclk -- </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -     txoutclk USE_REFCLK_IN : boolean:=FALSE; -- FALSE -   MGTCLK -- TRUE -   REFCLK_IN is_tx_dpram_use : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">; -- </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -     is_rx_dpram_use : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -- </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -     </span></span></span><span class="hljs-function">)</span></span>; port( clk : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; --    - <span class="hljs-number"><span class="hljs-number">266</span></span>  clk_tx_out : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; --    - <span class="hljs-number"><span class="hljs-number">156.25</span></span>  clk_rx_out : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; --    - <span class="hljs-number"><span class="hljs-number">156.25</span></span>  --- SYNC --- reset : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">0</span></span> -  sync_done : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   tx_enable : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -    rx_enable : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -    rst_buf : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -    transmitter_dis : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -    ---- DATA ---- tx_ready : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -      rx_ready : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -      tx_data : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">31</span></span></span></span><span class="hljs-function"><span class="hljs-params">+(LINES</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span></span><span class="hljs-function">)*32 downto 0 )</span></span>; --    tx_data_we : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   tx_data_title : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; --   tx_data_eof : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   tx_user_flag : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params">+(LINES</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span></span><span class="hljs-function">)*8 downto 0 )</span></span>; --   tx_inject_error : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> LINES</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">):</span></span>=(others=&gt;<span class="hljs-string"><span class="hljs-string">'0'</span></span>); -- <span class="hljs-number"><span class="hljs-number">1</span></span> -      rx_data : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">31</span></span></span></span><span class="hljs-function"><span class="hljs-params">+(LINES</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span></span><span class="hljs-function">)*32 downto 0 )</span></span>; --   rx_data_rd : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   rx_data_title : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; --    rx_data_eof : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   rx_user_flag : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params">+(LINES</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span></span><span class="hljs-function">)*8 downto 0 )</span></span>; --   rx_user_flag_we : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> (LINES</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span></span><span class="hljs-function">) downto 0 )</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -    rx_crc_error_adr: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">):</span></span>=<span class="hljs-string"><span class="hljs-string">"000"</span></span>; --    rx_crc_error : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; --      --- MGT --- rxp : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> LINES</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; rxn : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> LINES</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; txp : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> LINES</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; txn : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> LINES</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; refclk_in : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; mgtclk_p : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; mgtclk_n : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic ); end component;</code> </pre> <br></div></div><br>  A group of tx_ * signals organizes the transmission channel.  Pact Transfer Algorithm: <br><br><ul><li>  Wait tx_ready = 1 </li><li>  Write a packet on the tx_data bus using the gate tx_data_we = 1 </li><li>  Generate tx_data_eof = 1 per clock cycle - the packet will be sent </li></ul><br>  You can write from 1 to 256 words, but in any case, a packet of 256 words will be sent. <br><br>  Similarly, the rx_ * signal group organizes the receive channel.  Algorithm reception package: <br><br><ul><li>  Wait for rx_ready = 1 </li><li>  Read the packet on the rx_data bus using the rx_data_rd strobe </li><li>  Generate rx_data_eof = 1 </li></ul><br>  Also, as with recording, it is allowed to read not the entire package.  A four-bit header is transmitted along with the packet.  When transmitting along with the packet, the input value tx_data_title will be transmitted.  At reception, together with the readiness tx_ready = 1, a value will appear on rx_data_title.  This allows you to have multiple sources and data receivers with one channel of transmission. <br><br>  In addition, flags are transmitted in the channel.  Data at the input of the transmitter tx_user_flag is transmitted to the output of the receiver rx_user_flag.  This can be used to send FIFO status flags. <br><br>  The prq_transceiver_gtx_m1 component can transfer data across multiple lines.  The number of lines is configured via the LINES parameter;  The width of tires tx_data, rx_data depends on the number of lines. <br><br>  The tx_inject_error entry allows you to add an error during the transfer.  This allows you to check the data recovery mechanism. <br><br>  The next level is the component prq_connect_m1 <br><br><div class="spoiler">  <b class="spoiler_title">prq_connect_m1</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">component prq_connect_m1 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">is</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generic</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> is_simulation : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; -- </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -   RECLK_EN : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; -- </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -     recclk -- </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -     txoutclk is_tx_dpram_use : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">; -- </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -     is_rx_dpram_use : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">; -- </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> -     FIFO0_WITH : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">; --  FIFO0: </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> - , </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">32</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">64</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">128</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span><span class="hljs-function"><span class="hljs-params">  FIFO0_PAF : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">16</span></span></span></span><span class="hljs-function"><span class="hljs-params">; --    PAF FIFO0_DEPTH : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1024</span></span></span></span><span class="hljs-function"><span class="hljs-params">; --  FIFO0 FIFO1_WITH : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">; --  FIFO1: </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> - , </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">32</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">64</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">128</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span><span class="hljs-function"><span class="hljs-params">  FIFO1_PAF : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">16</span></span></span></span><span class="hljs-function"><span class="hljs-params">; --    PAF FIFO1_DEPTH : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> integer:=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1024</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --  FIFO0 </span></span></span><span class="hljs-function">)</span></span>; port( --- MGT --- rxp : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; rxn : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; txp : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; txn : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; mgtclk_p : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; mgtclk_n : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; ---- Tranceiver ---- clk : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; --    - <span class="hljs-number"><span class="hljs-number">266</span></span>  clk_tx_out : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; --    - <span class="hljs-number"><span class="hljs-number">156.25</span></span>  clk_rx_out : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; --    - <span class="hljs-number"><span class="hljs-number">156.25</span></span>  --- SYNC --- reset : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">0</span></span> -  sync_done : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   tx_enable : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -    rx_enable : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -    ---- FIFO0 ---- fi0_clk : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; --     FIFO fi0_data : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> FIFO0_WITH</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">):</span></span>=(others=&gt;<span class="hljs-string"><span class="hljs-string">'0'</span></span>); --   FIFO fi0_data_en : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   FIFO fi0_paf : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> - FIFO   fi0_id : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">):</span></span>=(others=&gt;<span class="hljs-string"><span class="hljs-string">'0'</span></span>); --  FIFO fi0_rstp : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -  FIFO fi0_enable : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   fi0_prs_en : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -     fi0_ovr : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -  FIFO fi0_rd_full_speed: <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -       ---- FIFO1 ---- fi1_clk : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; --     FIFO fi1_data : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> FIFO1_WITH</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">):</span></span>=(others=&gt;<span class="hljs-string"><span class="hljs-string">'0'</span></span>); --   FIFO fi1_data_en : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   FIFO fi1_paf : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> - FIFO   fi1_id : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">):</span></span>=(others=&gt;<span class="hljs-string"><span class="hljs-string">'0'</span></span>); --  FIFO fi1_rstp : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -  FIFO fi1_enable : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   fi1_prs_en : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -     fi1_ovr : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -  FIFO fi1_rd_full_speed: <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -       tx_inject_error : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">):</span></span>=(others=&gt;<span class="hljs-string"><span class="hljs-string">'0'</span></span>); -- <span class="hljs-number"><span class="hljs-number">1</span></span> -      tx_user_flag : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">63</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">):</span></span>=(others=&gt;<span class="hljs-string"><span class="hljs-string">'0'</span></span>); --   ----   ---- fifo_data : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">255</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; --  FIFO fifo_we : <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> std_logic; -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   fifo_id : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; --  FIFO fifo_rdy : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">15</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; --     rx_crc_error_adr: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">):</span></span>=<span class="hljs-string"><span class="hljs-string">"000"</span></span>; --    rx_crc_error : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; --      rx_user_flag : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">63</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; --   rx_user_flag_we : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">std_logic_vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params"> downto </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">) -- 1 -    )</span></span>; end component;</code> </pre><br></div></div><br>  He is already implementing a mechanism for transmitting data through the FIFO on eight lines.  Structural scheme: <br><br><img src="https://habrastorage.org/files/0a7/4d1/710/0a74d1710ec646829ebf3068daad0a55.png"><br><br>  It consists of two FIFOs, prq_transceiver, receive and transmit automata. <br><br>  The width of the input bus of each FIFO is configured through the FIFOx_WITH parameters, the word count and the trigger level of the almost full FIFO flag are also configured.  Writing to each FIFO is done at its own clock frequency.  Each FIFO is accompanied by its identifier fi0_id, fi1_id;  This allows you to split the data stream at the reception.  After the FIFO, a pseudo-random sequence generator is installed.  In the diagram, it is designated as a PSD. <br><br>  The generator implements three modes: <br><br><ol><li>  Skip data stream unchanged </li><li>  Substitute test sequence while maintaining data rate </li><li>  Substitute test sequence and transfer data at full speed </li></ol><br>  Testing in real projects is based on this generator.  This generator does not take up much space in the FPGA, it is in all projects and allows you to check the exchange channel at any time. <br><br>  The components prq_connect_m1 and prq_transceiver_gtx_m1 are basic.  They were designed for FPGA Virtex 6;  Subsequently, the components prq_transceiver_gtx_m4 and prq_transceiver_gtx_m6; <br><br><ul><li>  prq_transceiver_gtx_m4 - buffer 0 is allocated for transmitting the command </li><li>  prq_transceiver_gtx_m6 - for Kintex 7 FPGA </li></ul><br>  The project is fully modeled, a sequential test run via a tcl file is implemented <br>  And here I want to express my gratitude to Igor Kazinov.  He made a great contribution to the organization of modeling in this project. <br><br>  The overall result of the simulation is as follows: <br><br><div class="spoiler">  <b class="spoiler_title">Global_tc_summary.log file</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Global</span></span> PROTEQ TC <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>: tc_00_0 PASSED tc_00_1 PASSED tc_00_2 PASSED tc_00_3 PASSED tc_02_0 PASSED tc_02_1 PASSED tc_02_2 PASSED tc_02_3 PASSED tc_02_4 PASSED tc_02_5 PASSED tc_03_0 PASSED tc_05_0 PASSED tc_05_1 PASSED</code> </pre><br></div></div><br>  Each line in the file is the result of a single test.  tc is a Test Case - a test case.  For example, I will cite the tc_00_1 component - checking packet transmission and introducing a single error into the transmission process. <br><br><div class="spoiler">  <b class="spoiler_title">tc_00_1</b> <div class="spoiler_text"><pre> <code class="hljs rust">------------------------------------------------------------------------------- -- -- Title : tc_00_1 -- Author : Dmitry Smekhov -- Company : Instrumental Systems -- E-mail : dsmv@insys.ru -- -- Version : <span class="hljs-number"><span class="hljs-number">1.0</span></span> -- ------------------------------------------------------------------------------- -- -- Description :    prq_transceiver_tb -- --  <span class="hljs-number"><span class="hljs-number">32</span></span>- . --   -- ------------------------------------------------------------------------------- -- -- Rev0.<span class="hljs-number"><span class="hljs-number">1</span></span> - debug test #<span class="hljs-number"><span class="hljs-number">1</span></span> -- ------------------------------------------------------------------------------- library ieee; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> ieee.std_logic_1164.all; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> ieee.std_logic_arith.all; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> ieee.std_logic_unsigned.all; library std; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std.textio.all; library work; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> work.prq_transceiver_tb_pkg.all; -- to bind testbench and its procedures <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> work.utils_pkg.all; -- <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-string"><span class="hljs-string">"stop_simulation"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> work.pck_fio.all; entity tc_00_1 is end tc_00_1; architecture bhv of tc_00_1 is signal tx_err : std_logic; signal rx_err : std_logic; begin ---------------------------------------------------------------------------------- -- Instantiate TB TB : prq_transceiver_tb generic map( max_pkg =&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>, --  ,    max_time =&gt; <span class="hljs-number"><span class="hljs-number">100</span></span> us, --    tx_pause =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> ns, --       rx_pause =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> ns --       ) port map( tx_err =&gt; tx_err, --   m1-&gt;m2 rx_err =&gt; rx_err --   m2-&gt;m1 ); ---------------------------------------------------------------------------------- -- -- Define ERR at TIME# -- tx_err &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">27</span></span> us, <span class="hljs-string"><span class="hljs-string">'0'</span></span> after <span class="hljs-number"><span class="hljs-number">27.001</span></span> us; rx_err &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>; ---------------------------------------------------------------------------------- end bhv;</code> </pre><br></div></div><br>  The component is very simple.  It calls prq_transceiver_tb (and here it‚Äôs just complicated), adjusts the parameters and generates a tx_err signal which introduces an error to the transmission line. <br><br>  The remaining components from tc_00_1 to tc_00_5 are about the same, they differ in the configured parameters, which allows you to check the data transmission under different conditions. <br><br>  The prq_transceiver_tb component is much more complicated.  Actually, it forms a test sequence, transmits the stream between two prq_transceiver_gtx_m1 and checks the received data stream.  If necessary - introduces errors in the transfer process. <br><br>  The component itself is here: <br><br><div class="spoiler">  <b class="spoiler_title">prq_transceiver_tb</b> <div class="spoiler_text"><pre> <code class="hljs php">library ieee; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ieee</span></span>.<span class="hljs-title"><span class="hljs-title">std_logic_1164</span></span>.<span class="hljs-title"><span class="hljs-title">all</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ieee</span></span>.<span class="hljs-title"><span class="hljs-title">std_logic_arith</span></span>.<span class="hljs-title"><span class="hljs-title">all</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ieee</span></span>.<span class="hljs-title"><span class="hljs-title">std_logic_unsigned</span></span>.<span class="hljs-title"><span class="hljs-title">all</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">work</span></span>.<span class="hljs-title"><span class="hljs-title">prq_transceiver_gtx_m1_pkg</span></span>.<span class="hljs-title"><span class="hljs-title">all</span></span>; library std; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">std</span></span>.<span class="hljs-title"><span class="hljs-title">textio</span></span>.<span class="hljs-title"><span class="hljs-title">all</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">work</span></span>.<span class="hljs-title"><span class="hljs-title">pck_fio</span></span>.<span class="hljs-title"><span class="hljs-title">all</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">work</span></span>.<span class="hljs-title"><span class="hljs-title">utils_pkg</span></span>.<span class="hljs-title"><span class="hljs-title">all</span></span>; entity prq_transceiver_tb is generic( max_pkg : integer:=<span class="hljs-number"><span class="hljs-number">0</span></span>; --  ,    max_time : time:=<span class="hljs-number"><span class="hljs-number">100</span></span> us; --    tx_pause : time:=<span class="hljs-number"><span class="hljs-number">100</span></span> ns; --       rx_pause : time:=<span class="hljs-number"><span class="hljs-number">100</span></span> ns --       ); port( tx_err : in std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; --   m1-&gt;m2 rx_err : in std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span> --   m2-&gt;m1 ); end prq_transceiver_tb; architecture TB_ARCHITECTURE of prq_transceiver_tb is signal clk : std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; signal reset : STD_LOGIC; signal tx_data : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">31</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal tx_data_we : STD_LOGIC; signal tx_data_title : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">3</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal rx_data_rd : STD_LOGIC; signal rxp : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal rxn : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal mgtclk_p : STD_LOGIC; signal mgtclk_n : STD_LOGIC; signal mgtclk : std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; -- Observed signals - signals mapped to the output ports of tested entity signal clk_tx_out : STD_LOGIC; signal clk_rx_out : STD_LOGIC; signal sync_done : STD_LOGIC; signal tx_enable : STD_LOGIC; signal rx_enable : STD_LOGIC; signal tx_ready : STD_LOGIC; signal rx_ready : STD_LOGIC; signal rx_data : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">31</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal rx_data_title : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">3</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal txp : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal txn : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal m2_txp : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal m2_txn : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal m2_rxp : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal m2_rxn : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal tx_err_i : std_logic_vector( <span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span> ); signal rx_err_i : std_logic_vector( <span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span> ); signal tx_data_eof : std_logic; signal rx_data_eof : std_logic; signal m2_clk : std_logic:=<span class="hljs-string"><span class="hljs-string">'0'</span></span>; signal m2_tx_data : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">31</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal m2_tx_data_we : STD_LOGIC; signal m2_tx_data_title : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">3</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal m2_rx_data_rd : STD_LOGIC; signal m2_tx_data_eof : std_logic; signal m2_rx_data_eof : std_logic; -- Observed signals - signals mapped to the output ports of tested entity signal m2_clk_tx_out : STD_LOGIC; signal m2_clk_rx_out : STD_LOGIC; signal m2_sync_done : STD_LOGIC; signal m2_tx_enable : STD_LOGIC; signal m2_rx_enable : STD_LOGIC; signal m2_tx_ready : STD_LOGIC; signal m2_rx_ready : STD_LOGIC; signal m2_rx_data : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">31</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal m2_rx_data_title : STD_LOGIC_VECTOR(<span class="hljs-number"><span class="hljs-number">3</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span>); signal tx_user_flag : std_logic_vector( <span class="hljs-number"><span class="hljs-number">7</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span> ):=x<span class="hljs-string"><span class="hljs-string">"A0"</span></span>; signal rx_user_flag : std_logic_vector( <span class="hljs-number"><span class="hljs-number">7</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span> ); signal rx_user_flag_we : std_logic_vector( <span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span> ); signal m2_tx_user_flag : std_logic_vector( <span class="hljs-number"><span class="hljs-number">7</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span> ):=x<span class="hljs-string"><span class="hljs-string">"C0"</span></span>; signal m2_rx_user_flag : std_logic_vector( <span class="hljs-number"><span class="hljs-number">7</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span> ); signal m2_rx_user_flag_we : std_logic_vector( <span class="hljs-number"><span class="hljs-number">0</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span> ); signal m2_reset : std_logic; begin clk &lt;= not clk after <span class="hljs-number"><span class="hljs-number">1.9</span></span> ns; mgtclk &lt;= not mgtclk after <span class="hljs-number"><span class="hljs-number">3.2</span></span> ns; m2_clk &lt;= not m2_clk after <span class="hljs-number"><span class="hljs-number">1.8</span></span> ns; mgtclk_p &lt;= mgtclk; mgtclk_n &lt;= not mgtclk; -- Unit Under Test port map UUT : prq_transceiver_gtx_m1 generic map ( is_simulation =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   LINES =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, is_tx_dpram_use =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, -- <span class="hljs-number"><span class="hljs-number">1</span></span> -     is_rx_dpram_use =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> -- <span class="hljs-number"><span class="hljs-number">1</span></span> -     ) port map ( clk =&gt; clk, clk_tx_out =&gt; clk_tx_out, clk_rx_out =&gt; clk_rx_out, --- SYNC --- --- SYNC --- reset =&gt; reset, sync_done =&gt; sync_done, tx_enable =&gt; tx_enable, rx_enable =&gt; rx_enable, ---- DATA ---- ---- DATA ---- tx_ready =&gt; tx_ready, rx_ready =&gt; rx_ready, tx_data =&gt; tx_data, tx_data_we =&gt; tx_data_we, tx_data_title =&gt; tx_data_title, tx_data_eof =&gt; tx_data_eof, tx_user_flag =&gt; tx_user_flag, rx_data =&gt; rx_data, rx_data_rd =&gt; rx_data_rd, rx_data_title =&gt; rx_data_title, rx_data_eof =&gt; rx_data_eof, rx_user_flag =&gt; rx_user_flag, rx_user_flag_we =&gt; rx_user_flag_we, --- MGT --- --- MGT --- rxp =&gt; rxp, rxn =&gt; rxn, txp =&gt; txp, txn =&gt; txn, mgtclk_p =&gt; mgtclk_p, mgtclk_n =&gt; mgtclk_n ); UUT2 : prq_transceiver_gtx_m1 generic map ( is_simulation =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, -- <span class="hljs-number"><span class="hljs-number">1</span></span> -   LINES =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, is_tx_dpram_use =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, -- <span class="hljs-number"><span class="hljs-number">1</span></span> -     is_rx_dpram_use =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> -- <span class="hljs-number"><span class="hljs-number">1</span></span> -     ) port map ( clk =&gt; m2_clk, clk_tx_out =&gt; m2_clk_tx_out, clk_rx_out =&gt; m2_clk_rx_out, --- SYNC --- --- SYNC --- reset =&gt; m2_reset, sync_done =&gt; m2_sync_done, tx_enable =&gt; m2_tx_enable, rx_enable =&gt; m2_rx_enable, ---- DATA ---- ---- DATA ---- tx_ready =&gt; m2_tx_ready, rx_ready =&gt; m2_rx_ready, tx_data =&gt; m2_tx_data, tx_data_we =&gt; m2_tx_data_we, tx_data_title =&gt; m2_tx_data_title, tx_data_eof =&gt; m2_tx_data_eof, tx_user_flag =&gt; m2_tx_user_flag, rx_data =&gt; m2_rx_data, rx_data_rd =&gt; m2_rx_data_rd, rx_data_title =&gt; m2_rx_data_title, rx_data_eof =&gt; m2_rx_data_eof, rx_user_flag =&gt; m2_rx_user_flag, rx_user_flag_we =&gt; m2_rx_user_flag_we, --- MGT --- --- MGT --- rxp =&gt; m2_rxp, rxn =&gt; m2_rxn, txp =&gt; m2_txp, txn =&gt; m2_txn, mgtclk_p =&gt; mgtclk_p, mgtclk_n =&gt; mgtclk_n ); rx_err_i &lt;= (others=&gt;rx_err); tx_err_i &lt;= (others=&gt;tx_err); rxp &lt;= m2_txp <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rx_err_i; rxn &lt;= m2_txn <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rx_err_i; m2_rxp &lt;= txp <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> tx_err_i; m2_rxn &lt;= txn <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> tx_err_i; reset &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">1</span></span> us; m2_reset &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">2</span></span> us; tx_enable &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">22</span></span> us; rx_enable &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">22</span></span> us; m2_tx_enable &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">24</span></span> us; m2_rx_enable &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">24</span></span> us; m2_tx_data_we &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>; m2_tx_data &lt;= (others=&gt;<span class="hljs-string"><span class="hljs-string">'0'</span></span>); m2_tx_data_title &lt;= <span class="hljs-string"><span class="hljs-string">"0000"</span></span>; m2_tx_data_eof &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>; pr_tx_data: process begin tx_data_we &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>; tx_data_eof &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>; tx_data &lt;= x<span class="hljs-string"><span class="hljs-string">"AB000000"</span></span>; tx_data_title &lt;= <span class="hljs-string"><span class="hljs-string">"0010"</span></span>; loop wait until rising_edge( clk ) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tx_ready=<span class="hljs-string"><span class="hljs-string">'1'</span></span>; tx_data_we &lt;= <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">1</span></span> ns; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ii in <span class="hljs-number"><span class="hljs-number">0</span></span> to <span class="hljs-number"><span class="hljs-number">255</span></span> loop wait until rising_edge( clk ); tx_data &lt;= tx_data + <span class="hljs-number"><span class="hljs-number">1</span></span> after <span class="hljs-number"><span class="hljs-number">1</span></span> ns; end loop; tx_data_we &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span> after <span class="hljs-number"><span class="hljs-number">1</span></span> ns; wait until rising_edge( clk ); tx_data_eof &lt;= <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">1</span></span> ns; wait until rising_edge( clk ); tx_data_eof &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span> after <span class="hljs-number"><span class="hljs-number">1</span></span> ns; wait until rising_edge( clk ); wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tx_pause; end loop; end process; pr_rx_data: process variable expect_data : std_logic_vector( <span class="hljs-number"><span class="hljs-number">31</span></span> downto <span class="hljs-number"><span class="hljs-number">0</span></span> ):= x<span class="hljs-string"><span class="hljs-string">"AB000000"</span></span>; variable error_cnt : integer:=<span class="hljs-number"><span class="hljs-number">0</span></span>; variable pkg_cnt : integer:=<span class="hljs-number"><span class="hljs-number">0</span></span>; variable pkg_ok : integer:=<span class="hljs-number"><span class="hljs-number">0</span></span>; variable pkg_error : integer:=<span class="hljs-number"><span class="hljs-number">0</span></span>; variable index : integer; variable flag_error : integer; variable tm_start : time; variable tm_stop : time; variable byte_send : real; variable tm : real; variable velocity : real; variable tm_pkg : time:=<span class="hljs-number"><span class="hljs-number">0</span></span> ns; variable tm_pkg_delta : time:=<span class="hljs-number"><span class="hljs-number">0</span></span> ns; variable L : line; begin m2_rx_data_rd &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>; m2_rx_data_eof &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>; --fprint( output, L, <span class="hljs-string"><span class="hljs-string">" \n"</span></span> ); loop loop wait until rising_edge( m2_clk ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( m2_rx_ready=<span class="hljs-string"><span class="hljs-string">'1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> now&gt;max_time ) then <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; end loop; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( now&gt;max_time ) then <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pkg_cnt=<span class="hljs-number"><span class="hljs-number">0</span></span> ) then tm_start:=now; tm_pkg:=now; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; tm_pkg_delta := now - tm_pkg; fprint( output, L, <span class="hljs-string"><span class="hljs-string">"PKG=%3d %10r ns %10r ns\n"</span></span>, fo(pkg_cnt), fo(now), fo(tm_pkg_delta) ); tm_pkg:=now; index:=<span class="hljs-number"><span class="hljs-number">0</span></span>; flag_error:=<span class="hljs-number"><span class="hljs-number">0</span></span>; m2_rx_data_rd &lt;= <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">1</span></span> ns; wait until rising_edge( m2_clk ); loop wait until rising_edge( m2_clk ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( expect_data /= m2_rx_data ) then <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( error_cnt&lt;<span class="hljs-number"><span class="hljs-number">32</span></span> ) then fprint( output, L, <span class="hljs-string"><span class="hljs-string">"ERROR: pkg=%d index=%d expect=%r read=%r \n"</span></span>, fo(pkg_cnt), fo(index), fo(expect_data), fo(m2_rx_data) ); end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; error_cnt:=error_cnt+<span class="hljs-number"><span class="hljs-number">1</span></span>; flag_error:=<span class="hljs-number"><span class="hljs-number">1</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; index:=index+<span class="hljs-number"><span class="hljs-number">1</span></span>; expect_data:=expect_data+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( index=<span class="hljs-number"><span class="hljs-number">255</span></span> ) then m2_rx_data_rd &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span> after <span class="hljs-number"><span class="hljs-number">1</span></span> ns; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( index=<span class="hljs-number"><span class="hljs-number">256</span></span> ) then <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; end loop; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( flag_error=<span class="hljs-number"><span class="hljs-number">0</span></span> ) then pkg_ok:=pkg_ok+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pkg_error:=pkg_error+<span class="hljs-number"><span class="hljs-number">1</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; wait until rising_edge( m2_clk ); m2_rx_data_eof &lt;= <span class="hljs-string"><span class="hljs-string">'1'</span></span> after <span class="hljs-number"><span class="hljs-number">1</span></span> ns; wait until rising_edge( m2_clk ); m2_rx_data_eof &lt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span> after <span class="hljs-number"><span class="hljs-number">1</span></span> ns; wait until rising_edge( m2_clk ); --wait until rising_edge( m2_clk ); wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rx_pause; pkg_cnt:=pkg_cnt+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pkg_cnt=max_pkg ) then <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; end loop; tm_stop:=now; fprint( output, L, <span class="hljs-string"><span class="hljs-string">"  : %r ns\n"</span></span>, fo(now) ); fprint( output, L, <span class="hljs-string"><span class="hljs-string">"  : %d\n"</span></span>, fo( pkg_cnt ) ); fprint( output, L, <span class="hljs-string"><span class="hljs-string">" : %d\n"</span></span>, fo( pkg_ok ) ); fprint( output, L, <span class="hljs-string"><span class="hljs-string">" : %d\n"</span></span>, fo( pkg_error ) ); fprint( output, L, <span class="hljs-string"><span class="hljs-string">"   : %d\n"</span></span>, fo( error_cnt ) ); byte_send:=real(pkg_cnt)*<span class="hljs-number"><span class="hljs-number">256.0</span></span>*<span class="hljs-number"><span class="hljs-number">4.0</span></span>; tm := real(tm_stop/ <span class="hljs-number"><span class="hljs-number">1</span></span> ns )-real(tm_start/ <span class="hljs-number"><span class="hljs-number">1</span></span> ns); velocity := byte_send*<span class="hljs-number"><span class="hljs-number">1000000000.0</span></span>/(tm*<span class="hljs-number"><span class="hljs-number">1024.0</span></span>*<span class="hljs-number"><span class="hljs-number">1024.0</span></span>); fprint( output, L, <span class="hljs-string"><span class="hljs-string">"  : %r /\n"</span></span>, fo( integer(velocity) ) ); flag_error:=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( max_pkg&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pkg_cnt/=max_pkg ) then flag_error:=<span class="hljs-number"><span class="hljs-number">1</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( flag_error=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pkg_cnt&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> error_cnt=<span class="hljs-number"><span class="hljs-number">0</span></span> ) then --fprint( output, L, <span class="hljs-string"><span class="hljs-string">"\n\n  \n\n"</span></span> ); fprint( output, L, <span class="hljs-string"><span class="hljs-string">"\n\nTEST finished successfully\n\n"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> --fprint( output, L, <span class="hljs-string"><span class="hljs-string">"\n\n   \n\n"</span></span> ); fprint( output, L, <span class="hljs-string"><span class="hljs-string">"\n\nTEST finished with ERR\n\n"</span></span> ); end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; utils_stop_simulation; wait; end process; pr_tx_user_flag: process begin tx_user_flag &lt;= tx_user_flag + <span class="hljs-number"><span class="hljs-number">1</span></span>; wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> us; end process; pr_m2_tx_user_flag: process begin m2_tx_user_flag &lt;= m2_tx_user_flag + <span class="hljs-number"><span class="hljs-number">1</span></span>; wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">1.5</span></span> us; end process; end TB_ARCHITECTURE;</code> </pre><br></div></div><br>  The result of the test: <br><br><div class="spoiler">  <b class="spoiler_title">tc_00_1.log</b> <div class="spoiler_text"><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># KERNEL: PKG= 0 25068 ns 0 ns # KERNEL: PKG= 1 26814 ns 1746 ns # KERNEL: PKG= 2 35526 ns 8712 ns # KERNEL: PKG= 3 36480 ns 954 ns # KERNEL: PKG= 4 37434 ns 954 ns # KERNEL: PKG= 5 38388 ns 954 ns # KERNEL: PKG= 6 39342 ns 954 ns # KERNEL: PKG= 7 40858 ns 1515 ns # KERNEL: PKG= 8 42597 ns 1738 ns # KERNEL: PKG= 9 44339 ns 1742 ns # KERNEL: PKG= 10 46081 ns 1742 ns # KERNEL: PKG= 11 47827 ns 1746 ns # KERNEL: PKG= 12 49566 ns 1738 ns # KERNEL: PKG= 13 51309 ns 1742 ns # KERNEL: PKG= 14 53051 ns 1742 ns # KERNEL: PKG= 15 54790 ns 1738 ns # KERNEL: PKG= 16 56536 ns 1746 ns # KERNEL: PKG= 17 58278 ns 1742 ns # KERNEL: PKG= 18 60021 ns 1742 ns # KERNEL: PKG= 19 61759 ns 1738 ns # KERNEL: PKG= 20 63502 ns 1742 ns # KERNEL: PKG= 21 65248 ns 1746 ns # KERNEL: PKG= 22 66990 ns 1742 ns # KERNEL: PKG= 23 68729 ns 1738 ns # KERNEL: PKG= 24 70471 ns 1742 ns # KERNEL: PKG= 25 72210 ns 1738 ns # KERNEL: PKG= 26 73953 ns 1742 ns # KERNEL: PKG= 27 75699 ns 1746 ns # KERNEL: PKG= 28 77441 ns 1742 ns # KERNEL: PKG= 29 79180 ns 1738 ns # KERNEL: PKG= 30 80922 ns 1742 ns # KERNEL: PKG= 31 82661 ns 1738 ns # KERNEL:   : 83598 ns # KERNEL:  : 32 # KERNEL: : 32 # KERNEL: : 0 # KERNEL:   : 0 # KERNEL:  : 534 / # KERNEL: # KERNEL: # KERNEL: TEST finished successfully</span></span></code> </pre><br></div></div><br>  Pay attention to the right column.  This is the time between received packets.  The usual time is ~ 1740 ns, but packet 2 is received with a delay of 8712 ns.  This was just the error signal.  And also note that the following packets are taken with a delay of 954 ns.  This is due to the fact that only one packet was incorrectly received, while the others waited in the buffer memory for their turn. <br><br>  I want to note that automated test execution helped me a lot when debugging a protocol.  This allowed to keep all changes under control.  And small changes in the source code could not lead to the collapse of the project. <br><br>  The PROTEQ project is available as OpenSource.  Link to the site - in my profile. </div><p>Source: <a href="https://habr.com/ru/post/321634/">https://habr.com/ru/post/321634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321622/index.html">Corporations and startups: successful cooperation models</a></li>
<li><a href="../321626/index.html">How to start a startup and not break your own life</a></li>
<li><a href="../321628/index.html">Aggressive energy saving when running on Windows on battery</a></li>
<li><a href="../321630/index.html">Another Brainfuck interpreter</a></li>
<li><a href="../321632/index.html">OpenPapyrus: [yet another] ERP-system open source</a></li>
<li><a href="../321636/index.html">Automount afuse</a></li>
<li><a href="../321638/index.html">Continuous Integration UWP Applications in Visual Studio Team Services</a></li>
<li><a href="../321640/index.html">Facebook Audience Network - a new word in the monetization of sites and applications</a></li>
<li><a href="../321644/index.html">Using expressions to filter data from a database</a></li>
<li><a href="../321646/index.html">Automatic 3CX configuration using the setupconfig.xml answer file</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>