<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Plus one percent automation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the end of the last article, I focused on listing the endless list of technical solutions that I really want to implement in the automation of the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Plus one percent automation</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/zi/zb/3d/zizb3dvguspwkvbjbz-dhmfb4sa.png"><br><br>  At the end of the <a href="https://habr.com/company/wirenboard/blog/416091/">last article,</a> I focused on listing the endless list of technical solutions that I really want to implement in the automation of the whole, well, not the country, but the dacha. <br><br>  Previously, the total consumption was controlled by a single-phase meter with a Modbus interface.  It is useful to follow the current consumption indications in order not to exceed reasonable limits and not to wait for the disconnection of group automatons.  He coped with this task with a bang.  But it is much more interesting to follow each consumer individually.  For what and how to do this, I will try to tell in this article. <br><a name="habracut"></a><br>  First of all, I would like to say thank you very much, colleagues, for your interest in the previous article.  Responding to your comments was no less exciting than writing the article itself.  One observant reader noticed that the coarse water filter is installed upside down! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Wiren Board produces several models of multichannel modbus electricity meters: the four-channel three-phase monster <a href="https://wirenboard.com/ru/product/WB-MAP12H/">WB-MAP12H</a> (and its single-channel younger brother <a href="https://wirenboard.com/ru/product/WB-MAP3H/">WB-MAP3H</a> ), the six-channel single-phase <a href="https://wirenboard.com/ru/product/WB-MAP6S/">WB-MAP6S</a> and a separate model <a href="https://wirenboard.com/ru/product/WB-MAP3E/">WB-MAP3E</a> , which is used in special cases when you need to diagnose short and powerful voltage spikes. <br><br>  WB-MAP series meters measure a huge number of network parameters: instantaneous voltage, current, frequency, power (active, reactive, total), power factors, phase angles;  accumulated energy values ‚Äã‚Äãfor each channel.  Among other things, MAP meters allow you to measure the harmonic coefficients for voltage and current, which is important for assessing the quality of electricity in networks with ‚Äúevil‚Äù consumers. <br><br>  The voltage is applied directly to the meter terminals, and the current for each channel is measured by detachable current transformers.  This is very convenient when installing the counter in the finished shield. <br><br><img src="https://habrastorage.org/webt/fb/pn/ia/fbpniasb-wtfodesb_ifftwogs8.png" width="350" height="300"><br>  <i>Installation of counters</i> <br><table><tbody><tr><td><img src="https://habrastorage.org/webt/xr/ey/rp/xreyrpcn8dsawapw8fgxw4ejby8.png" width="300" height="200"></td><td><img src="https://habrastorage.org/webt/kx/by/6f/kxby6fq6zaejmuviwkuf_k8oizo.png" width="300" height="200"></td></tr></tbody></table>  <i>Installation of detachable current transformers.</i> <br><br>  In the demonstration boards, the current transformers look beautiful and neat (as in the picture in the post title), in real life you have to place the transformers where it turns out.  And yes, shields should be big! <br><br>  The project of automation of my summer house, as I described in detail in the previous article, was made on the basis of the previous version of our Wiren Board 5 controller, to which various relay modules, actuators and sensors are connected via the Modbus interface. <br><br>  Before the next weekend, I armed myself with two WB-MAP6S counters and one WB-MAP12H and started a business.  The initial estimations by the number of measurement channels turned out to be wrong, of course: there were more consumers who wanted to be monitored, so some time had to be spent thinking about which groups to measure consumption. <br><br>  General input, loads after the stabilizer and inverter, convectors and air conditioners (each separately), two boilers, a telecommunications closet, automatic gates, a refrigerator, a heated floor were selected. <br><br>  Counters collect a huge number of parameters (WB-MAP12H has more than a thousand registers), but even a constant survey of several dozens of parameters from each counter becomes a significant load on the RS-485 bus if polled too often.  I reduced the standard templates that come with the controller to the required minimum of parameters. <br><br>  I transferred the counters to the second RS-485 bus of the Wiren Board controller, so as not to interfere with the normal operation of the relay modules and sensors, and increased the speed to 115200 kbit / s.  In this configuration, the polling of counters began to be performed quite vigorously and did not interfere with the functioning of the rest of the automation. <br><br>  Before embarking on the practical use of the results, they must be analyzed from all sides.  The Wiren Board controller has a built-in database and simple visualization tools, but for serious tasks it is worth using more serious tools. <br><br>  Remembering that, after all, I did Zabbix CP, I decided to deploy monitoring on it, but I was overwhelmed by the craving for the new and I decided to try to use the popular Influxdb + Grafana to store and display data.  The controller transmits all the data in the form of mqtt-topics to a separate mqtt-broker on the server, where <a href="https://github.com/contactless/wbmqtt2influx">the Python script</a> processes it and stores it in Influx.  Grafana is also installed there to display everything. <br><br>  The first results did not disappoint me.  Here are some examples. <br><br><img src="https://habrastorage.org/webt/60/3x/6g/603x6gqnkbs3lbkagbs15gvoqxi.png"><br>  <i>Mains voltage</i> <br><br>  All the failures, with rare exceptions, occur at around 21:00 - 23:00 and on weekends are especially noticeable.  Peaks - early morning. <br><br>  This is how the work of two stabilizers looks (yellow and blue lines): <br><br><img src="https://habrastorage.org/webt/cc/zh/nk/cczhnkig80jc4ojl41cr9yibmdq.png"><br><br>  These are ordinary relay stabilizers of a widely known Latvian-Chinese manufacturer, with a sufficiently large step changing voltage at the output.  Nothing special, although it is clear that one of them is prone to switching to the very limit values ‚Äã‚Äã(which fit, however, within the scope of GOST) voltage values.  The first candidate to replace. <br><br>  Instant values ‚Äã‚Äãare displayed in the form of such graphan widgets: <br><br><img src="https://habrastorage.org/webt/qx/ag/eu/qxageuehzxgwz7dkm1nqmrmwr54.png"><br><br>  Simply and clearly, it is suitable for display on an information screen or tablet on the wall. <br><br>  The instantaneous power graph for all consumers looks very picturesque (click on the image to open in full scale): <br><br> <a href=""><img src="https://habrastorage.org/webt/ft/rf/bg/ftrfbgrskmyh3isa90ckiewlmv0.png"></a> <br><br>  Large and green - this is not a crocodile, but the total power at the entrance. <br><br>  Grafana allows you to select from a chart not only all, but one or more of the indicators of interest. <br><br>  Power factor (cos œÜ).  In modern household devices, he is quite well.  I researched the work of three consumers: air conditioner, refrigerator and water heater. <br><br>  At the water heater at the moment of active work the power factor 1 is ‚Äúhigh‚Äù (0.95 ... 1), and in the refrigerator 0.85 it is ‚Äúgood‚Äù (0.8 ... 0.95);  the power factor of the air conditioner (0.76) is located at the upper limit of the ‚Äúsatisfactory‚Äù range (0.65 ... 0.8). <br><br>  Inverter air conditioner: <br><table><tbody><tr><td><img src="https://habrastorage.org/webt/_r/zv/8q/_rzv8qtjho4fmckbrv1lou3y93m.png"></td><td><img src="https://habrastorage.org/webt/0g/w9/lo/0gw9loer2fsvdxf3zaenp3vzugm.png"></td></tr></tbody></table><br>  <i>Work in normal cooling mode and the structure of the individual peak compressor (right)</i> <br><br>  Visible are the peaks at the initial start-up of the compressor of the external unit, stable operation mode, standby mode. <br><br>  How does the refrigerator work?  ‚ÄúDr-dr-dr-dr-dr-dr-dr?‚Äù Almost.  The compressor starts up periodically, as it warms inside the chambers: <br><br><img src="https://habrastorage.org/webt/-0/2f/zt/-02fztfesqpqvmmxxeu5n_jynus.png"><br>  <i>Periodic on the compressor of the refrigerator</i> <br><br><img src="https://habrastorage.org/webt/vw/af/gc/vwafgcmfkhqqtu_bjfd9b13abic.png"><br>  <i>The structure of the individual peak power consumption</i> <br><br>  Separate cycle: a power surge is visible when the refrigerator compressor is turned on.  WB-MAP counters are quite sensitive: see these small peaks, about a dozen watts?  This light bulb ignited inside the refrigerator: someone climbed into it! <br><br>  The heated towel rail operates in a constant on / off cycle to maintain the set temperature: <br><table><tbody><tr><td><img src="https://habrastorage.org/webt/st/n3/mr/stn3mrsvwcsbeahfc4mrb3xpcx4.png"></td><td><img src="https://habrastorage.org/webt/aj/h2/rg/ajh2rg_v-32ncrz7o-5nc-yu0ey.png"></td></tr></tbody></table><br>  <i>To the right is a more detailed depiction of individual consumption peaks.</i> <br><br>  The hob works similarly: <br><br><img src="https://habrastorage.org/webt/1z/ez/hq/1zezhqbdevoxpcnewuygavpszu8.png"><br><br>  It seems that this was brewing my morning coffee. <br><br>  An interesting profile of energy consumption at automatic gates: <br><br><img src="https://habrastorage.org/webt/wi/mz/kz/wimzkzayo2vf00tv825u-4tup3w.png"><br><br>  They consume about 5 watts in standby mode, while operating, the energy consumption profile allows you to see the separate phases of the movement of the valves: the first begins to open, then the second begins, then they open together, and then they stop in turn and the drive motors are turned off. <br><br>  The boiler maintains the temperature of the water, the frequency and time of the inclusions depend on the consumption of hot water: <br><br><img src="https://habrastorage.org/webt/iy/o1/tx/iyo1txuwacaidp4qhmuorksn4ug.png"><br><br>  I will not tire further readers with graphs - I will show a sign!  (Grafana can not only build graphs, but also display data in tables and bar graphs.) <br><br><img src="https://habrastorage.org/webt/kn/zg/uz/knzguzes7leklkm9yptbxotaav0.png"><br><br>  The label is simple and allows you to track the total energy consumption by the hour, as well as to estimate how much it cost every hour in accordance with the current tariff.  The old version of Influxdb, which is placed from the repositories of the current version of Ubuntu on the server, does not know how to make the usual samples from the samples, so it was not possible to add a column with the value of each hour. <br><br>  In the diagram, the consumption looks like this: <br><br><img src="https://habrastorage.org/webt/qk/o3/ev/qko3evrab-xfwmw2jchzdlcnvac.png"><br><br>  Given that Gafana can generate alarm messages, the result is quite enough for the light-version of power monitoring. <br>  However, I want to solve more exciting problems. <br><br><ul><li>  Current and voltage harmonics.  Do they carry useful information for the home?  Often, bad consumers or sparkling contacts generate high order harmonics.  How long is the temporary resolution of the counters enough to detect them and make some decisions about disabling the ‚Äúbad loads‚Äù?  Or just give out alerts? </li><li>  Air conditioners and convectors.  If you start from the temperature in the room, you can understand in which mode the air conditioner works: does it try to cool the convector with wild persistence (the convector should be turned off) or do they work together to heat the room faster if the air conditioner is in reverse mode for heating? </li><li>  Goal.  If the energy profile changes and starts to differ significantly from the standard, then this may indicate that there is some obstacle, the oil thickens in the drives from low temperature, someone opens and closes the gate too often.  Here you can send warnings, turn off the power.  Will the controller, Influx and Grafana be enough for this?  Perhaps such things should be implemented in a separate script, signed only for messages with the values ‚Äã‚Äãof the parameters of energy consumption of the gate. </li><li>  Pumping station and well pump.  Together with the assessment of water consumption, it is possible to track the performance drop due to some malfunctions, leaks, problems with storage tanks. </li><li>  The operation of the septic tank compressor can also be assessed by its power consumption, although air consumption is more informative, in my opinion. </li><li>  Water heaters.  The water in the well is very hard; scum is formed fairly quickly.  Accordingly, the heating elements have to work more and in a more rigid mode, heating water from under the additional casing of the scale (it also starts to burn, if it is rather thick).  It will be interesting to understand if there is enough analysis of power consumption for detecting the formed scale (boilers do not have an interface to report the temperature of water in the tank)? </li><li>  Total power consumption - if the currents are within the limits, low-priority loads can be shut off. </li></ul><br>  I would be glad if someone offers an unexpected and interesting use of monitoring the energy consumption of individual devices. <br><br>  Until we meet again, friends! </div><p>Source: <a href="https://habr.com/ru/post/421689/">https://habr.com/ru/post/421689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421675/index.html">Finally there was a task that only quantum computers can solve.</a></li>
<li><a href="../421677/index.html">How to identify risks in state control and why machine learning for this</a></li>
<li><a href="../421683/index.html">Meeting #RuPostgres: scaling applications on PostgreSQL</a></li>
<li><a href="../421685/index.html">Why working in IT is not so cool</a></li>
<li><a href="../421687/index.html">How to organize Knowledge Sharing in and out</a></li>
<li><a href="../421691/index.html">Statistical Process Management (Part 1. Implementation Experience)</a></li>
<li><a href="../421693/index.html">The Story Of An API: How We Turned Frankenstein Into A Handsome Boy</a></li>
<li><a href="../421695/index.html">[Not] ordinary networks: how to detect water in your bag using Wi-Fi</a></li>
<li><a href="../421699/index.html">How to get rid of errors with tables of Active Object when restoring Jira from backup</a></li>
<li><a href="../421701/index.html">Sandbox and Python Learning Cheat Sheet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>