<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Energy accounting as part of the shopping center SCADA system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Let me tell you how I wrote a console program for taking readings from counters Mercury 230 in a shopping center. Link to the source at the end of the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Energy accounting as part of the shopping center SCADA system</h1><div class="post__text post__text-html js-mediator-article">  Let me tell you how I wrote a console program for taking readings from counters Mercury 230 in a shopping center.  Link to the source at the end of the article. <br><br>  It all began with the SCADA system.  We were lucky to get a project for the development and implementation of SCADA for a shopping center.  Well, how lucky ... In general, the development of this system is a separate story, which, if it is interesting to the reader, I will tell and share the stuffed cones.  Yes, and the system has not yet been fully accepted, therefore, until we shine with details. <br><br>  Briefly: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      - temperature control in the premises; <br>  - centralized ventilation control on schedule; <br>  - management of DHW feed; <br>  - accounting of water and electricity; <br>  - sms notifications. <br><br>  This article is about electricity. <br><a name="habracut"></a><br>  Electricians listened to the choice of model, so I didn‚Äôt have any particular problems here.  Decided to stay on Mercury.  For 3 phases - 234 types (electricians bought 230) for single-phase network 206th model.  Further, it turned out that electricians forged only three-phase meters throughout the shopping center.  Well, I just have less problems.  Although I do not understand why. <br><br>  Before that, I programmed mainly PLC and small C # scripts.  But then I decided that I could make energy accounting myself (I wanted to gain experience in programming).  I got excited, of course. <br><br>  The idea was: <br><br>  - the interrogator-server keeps the energy account in the database; <br>  - SCADA system is responsible for visualization <br><br><h3>  Polling method </h3><br>  The survey is implemented simply - in an infinite loop on a single RS485 port.  In general, for the operation of the dispatching system, I picked up MOXA UPORT 1650-16.  Under the survey gave only one port, but in order not to create a star (for RS-485 this is not desirable), he used a repeater.  It is strange that bourgeois repeaters RS-485 with a large number of inputs was not found.  However, there was a domestic Tahion PRT-1/8 (12) gizmo at 12 ports.  If it works out, I'll post a video of the work of the whole bunch.  Works good.  Only to MOXA UPORT 1650-16 there are claims, but that‚Äôs another story. <br><iframe width="560" height="315" src="https://www.youtube.com/embed/JcCIYbBeGUY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h3>  Development of the surveyor himself </h3><br>  About design patterns did not even hear.  Because I made mistakes right away, because  carried away inheritance (and not particularly well).  On smart books - it was necessary to apply the composition.  In the future, it will be necessary to recycle the entire library. <br><br>  The chain of inheritance turned out this: <br><br><pre><code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">MeterDevice</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mercury230</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mercury230_DatabaseSignals</span></span></code> </pre> <br>  <b>MeterDevice</b> is a common class for all counters.  It implements the exchange via a COM port with Modbus with a similar protocol; <br>  <b>Mercury230</b> - a class with a set of polling functions for a specific counter; <br>  <b>Mercury230_DatabaseSignals</b> is a class with specific meter parameters (currents, voltages, etc.) and the function of updating them.  Inheritance in it was not a convenient solution.  Since  Then I had problems with serialization and deserialization of objects.  But this class so firmly got into the code that it was impossible to retreat. <br><br>  I decided to make the <b>RXmes</b> structure key in the polling functions.  In it to store result of the answer and an array of bytes of the answer.  Any polling function (for example, a serial number request) operates within itself with this structure: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> error_type : <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> { none = <span class="hljs-number"><span class="hljs-number">0</span></span>, AnswError = <span class="hljs-number"><span class="hljs-number">-5</span></span>, <span class="hljs-comment"><span class="hljs-comment">//       CRCErr = -4, NoAnsw = -2, //         WrongId = -3, //     NoConnect = -1 //   }; public struct RXmes { public error_type err; public byte[] buff; public byte[] trueCRC; public void testCRC() { err = error_type.CRCErr; if (buff.Length &lt; 4) { err = error_type.CRCErr; return; } byte[] newarr = buff; Array.Resize(ref newarr, newarr.Length - 2); byte[] trueCRC = Modbus.Utility.ModbusUtility.CalculateCrc(newarr); if ((trueCRC[1] == buff.Last()) &amp;&amp; (trueCRC[0] == buff[(buff.Length - 2)])) { err = error_type.none; } } public void ReadArr(byte[] b) { buff = b; testCRC(); } } public RXmes SendCmd(byte[] data) { RXmes RXmes_ = new RXmes(); byte[] crc = Modbus.Utility.ModbusUtility.CalculateCrc(data); Array.Resize(ref data, data.Length + 2); data[data.Length - 2] = crc[0]; data[data.Length - 1] = crc[1]; rs_port.Write(data, 0, data.Length); System.Threading.Thread.Sleep(timeout); if (rs_port.BytesToRead &gt; 0) { byte[] answer = new byte[(int)rs_port.BytesToRead]; rs_port.Read(answer, 0, rs_port.BytesToRead); RXmes_.ReadArr(answer); if (RXmes_.err == error_type.none) { DataTime_last_contact = DateTime.Now; } return RXmes_; } RXmes_.err = error_type.NoConnect; return RXmes_; }</span></span></code> </pre> <br>  Thus, the function of obtaining the serial number of the Mercury 230 counter turned out to be this: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GiveSerialNumber</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] mes = {address, <span class="hljs-number"><span class="hljs-number">0x08</span></span> , <span class="hljs-number"><span class="hljs-number">0</span></span>}; RXmes RXmes = SendCmd(mes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RXmes.err == error_type.none) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytebuf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">7</span></span>]; Array.Copy(RXmes.buff, <span class="hljs-number"><span class="hljs-number">1</span></span>, bytebuf, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bytebuf; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br>  Who is interested to see other functions - you can see the source. <br><br><h3>  SCADA communication protocol </h3><br>  Initially, the simple TCP protocol of the north was simple.  SCAD's answer over TCP looked for Mercury 230 of that. <br><br>  <b>"Type = mecc230 * add = 23 * volt = 1: 221-2: 221-3: 221 * cur = 1: 1.2-2: 1.2-3: 1.2"</b> <br><br>  Scud data parsed and displayed on the icon of the corresponding counter <br>  Everything would be fine, but the customer decided (and rested his horn) that he needed all the data in a tabular form.  Yes, and wanted to set the limits of all parameters during operation.  And going beyond the limits should be displayed. <br><br>  Tearing your hair, because  SCADA did not know how to display tabular data, sat down to write a separate program for visualization. <br><br>  Its protocol was already becoming particularly inconvenient, since  the number of parameters grew.  For example, for the current appeared the upper chapel, the state of the accident, the hysteresis of the inclusion of the accident. <br>  It turned out that a separate class was formed for the parameters: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MetersParameter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { minalarm = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; maxalarm = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MetersParameter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> min, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> max, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hist, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> scalefactor = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">)</span></span> { MinValue = min; MaxValue = max; Hist = hist; minalarm = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; maxalarm = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; ScalingFactor = scalefactor; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> MaxValue { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> MinValue { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ScalingFactor { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//  .       public float Hist { set; get; } private bool minalarm; private bool maxalarm; public bool ComAlarm { get { return MinValueAlarm || MaxValueAlarm ; } } public virtual bool MinValueAlarm { get{ return minalarm; } } public virtual bool MaxValueAlarm { get{ return maxalarm; } } public virtual void RefreshData() { if (null != ParametrUpdated) { ParametrUpdated(); } if ((MinValue == 0) &amp;&amp; (MaxValue == 0)) { return; } float calc_par = parametr * ScalingFactor; if (calc_par &lt; (MinValue - Hist)) { minalarm = true; } if (calc_par &gt; (MinValue + Hist)) { minalarm = false; } if (calc_par &lt; (MaxValue - Hist)) { maxalarm = false; } if (calc_par &gt; (MaxValue + Hist)) { maxalarm = true; } } float parametr; public bool UseScaleForInput = false; public virtual float Value { set{ parametr = UseScaleForInput ? value / (ScalingFactor &lt;= 0 ? 1 : ScalingFactor) : value; RefreshData(); } get { return parametr * ScalingFactor; } } public void CopyLimits(MetersParameter ext_par) { this.MinValue = ext_par.MinValue; this.MaxValue = ext_par.MaxValue; this.Hist = ext_par.Hist; } }</span></span></code> </pre> <br>  Here I got the serialization of objects.  Having tried Byte, XML and JSON serialization, it was decided to stop at JSON (DataContractJsonSerializer).  It was easy to read by eye, the data volume was less than XML.  In general, DataContractJsonSerializer forgave the absence of a constructor with no arguments.  It made life much easier. <br><br><h3>  Database </h3><br>  Of course, the most important thing was the recording of meter readings.  Since  Scada system worked with MySql, then the surveyor was decided to tie with her.  There were no special problems. <br><br>  The question was only one - ‚Äúwhat data to record?‚Äù, Because  options counter gives quite a few.  Actually codes for the request: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> peroidQuery : <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> { afterReset = <span class="hljs-number"><span class="hljs-number">0x0</span></span>, thisYear = <span class="hljs-number"><span class="hljs-number">1</span></span>, lastYear = <span class="hljs-number"><span class="hljs-number">2</span></span>, thisMonth = <span class="hljs-number"><span class="hljs-number">3</span></span>, thisDay = <span class="hljs-number"><span class="hljs-number">4</span></span>, lastDay = <span class="hljs-number"><span class="hljs-number">5</span></span>, thisYear_beginning = <span class="hljs-number"><span class="hljs-number">9</span></span>, lastYear_beginning = <span class="hljs-number"><span class="hljs-number">0x0A</span></span>, thisMonth_beginning = <span class="hljs-number"><span class="hljs-number">0x0B</span></span>, thisDay_beginning = <span class="hljs-number"><span class="hljs-number">0x0C</span></span>, lastDay_beginning = <span class="hljs-number"><span class="hljs-number">0x0D</span></span> }</code> </pre> <br>  Initially, it was decided to record consumption per month and per day.  In addition, a simple mechanism for taking readings by months for a year was implemented.  And control the availability of this data.  If there was not enough data, they were added. <br><br>  But closer to the end, I get the requirement that the reports always have written indications at the beginning and at the end of the period.  People hired for maintenance didn‚Äôt like one ‚ÄúConsumed‚Äù column.  I had to add readings at the beginning of the month and day. <br><br><h3>  Total </h3><br>  It turned out a little crutch, but still a working program of electricity metering.  At the moment, the program interrogates about 70 counters.  The console application is spinning on the server, and the client side runs on the user's workplace. <br><br>  The source of the surveyor is posted on <a href="https://github.com/LevWi/electric-meter">GitHub</a> .  I will try to post the link to the client part later. <br><br><h4>  PS About the similarity of the protocol of Mercury 230 and SET-4tm </h4><br>  If someone did not come across.  That is such a plant them.  Frunze (in Nizhny Novgorod).  And the meters work with a very similar protocol.  Run through the manuals of both - one to one.  But, I heard that there are some differences in the protocols (I have not yet gone into it).  It is a pity that on the hands of no SET. <br>  Legs of similarity grow from the fact that the Mercury was developed by the former workers of Frunze.  So it goes.  It is strange why Mercury is more popular at the hearing. </div><p>Source: <a href="https://habr.com/ru/post/330980/">https://habr.com/ru/post/330980/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330970/index.html">Mobile Retargeting: How to Measure Performance</a></li>
<li><a href="../330972/index.html">For the first time in Russia at the robotic Olympiad will be held competitions drone</a></li>
<li><a href="../330974/index.html">Run Bare-metal application on Cyclone V SoC</a></li>
<li><a href="../330976/index.html">Career in Digital: what is it, who needs it, where to start</a></li>
<li><a href="../330978/index.html">You have the right to anonymity. Part 3. Law enforcement struggle with anonymity tools</a></li>
<li><a href="../330982/index.html">Analytics in recruitment: it is not your bigdata</a></li>
<li><a href="../330984/index.html">How I passed the CISSP certificate exam</a></li>
<li><a href="../330986/index.html">Apache Spark as the core of the project. Part 2. Streaming, and what we ran into</a></li>
<li><a href="../330988/index.html">Architecture and indexing algorithms audio records VKontakte</a></li>
<li><a href="../330990/index.html">Simulation of transients during electrical circuit switching by means of Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>