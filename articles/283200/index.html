<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transferring a virtual machine image between cloud hosters or installing Windows Server on Digital Ocean</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For example, Digital Ocean does not provide the ability to upload your virtual image, moreover, you also cannot connect an ISO image for installation ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transferring a virtual machine image between cloud hosters or installing Windows Server on Digital Ocean</h1><div class="post__text post__text-html js-mediator-article">  For example, Digital Ocean does not provide the ability to upload your virtual image, moreover, you also cannot connect an ISO image for installation (though there is a KVM - and thanks for that). <br>  So you have to go the tricky way and do everything through ssh.  The main idea is to unmount the root file system on the virtual machine, upload files / image from the old one, update the grub settings, update the network settings and fstab, reload. <br>  The most obvious in the first step.  You can unmount / and live system, it is real, albeit a chore.  It is much easier to add an ssh server and a couple of utilities to the initramdisk and do everything from there, because  At this stage of the OS boot, the root system is not yet mounted. <br>  Actually, the whole article is a demonstration of a utility for including an ssh server in a ramdisk + two disassembled examples. <br><img src="https://habrastorage.org/files/b68/8dc/0e4/b688dc0e4933496fad0cb5ae8234988f.jpg"><br><a name="habracut"></a><br><br><h1>  Moving a Debian server from Xen with para-virtualization to Digital Ocean. </h1><br>  It is important that the virtualka on DigitalOcean be with the ability to change the kernel from the virtual machine itself (In the DigitalOcean control panel, the Kernel tab should say that change the kernel inside the host). <br>  Xen source: <br><img src="https://habrastorage.org/files/106/ce1/06b/106ce106b16448e9881d233fdc0df221.png"><br>  There is a nginx with such a demo page <br><img src="https://habrastorage.org/files/4c7/fe5/99a/4c7fe599ad7147deb5307d1228e37633.png"><br><br><h2>  Step 1. Preparing the source server for migration </h2><br>  You can not prepare anything, just turn off the source server and give the files / image from the hypervisor, but this is not interesting and, moreover, the source may well be not on the virtual machine, but on bare hardware.  Therefore, the first step is to remount the root filesystem (and, accordingly, also connected FCs, if any) to read-only.  It is much easier to remount read-only than unmount it completely ‚Äî it is enough just to nail demons who can write something. <br><pre><code class="bash hljs">/etc/init.d/nginx stop apt-get install lsof rsync lsof /</code> </pre> <br>  We look what remains.  We are interested in the lines where the FD column ends with w or u <br><img src="https://habrastorage.org/files/2df/56b/627/2df56b62733049a89f1f2fe800bb5803.png"><br>  Aha, rsyslog stayed <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> 6288 mount -o remount,ro /</code> </pre><br>  If it worked out, then it is good; if not, then go on to look who keeps the files open for writing.  As a rule, it is enough to turn off all additionally installed daemons + syslog. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Step 2. Unmounting the root filesystem on the recipient server </h2><br>  The recipient will be Ubuntu 16.04.  In theory, it is absolutely not important that the recipient will stand before the transfer, since  all this will reboot, just a utility to automate the configuration of the initramdisk working with ubuntu / debian. <br>  So, freshly created ubuntu 16.04 on DigitalOcean: <br><pre> <code class="bash hljs">apt-get install -y git dropbear &amp;&amp; \ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/roginvs/early-ssh &amp;&amp; \ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> early-ssh &amp;&amp; \ ./build_deb.sh &amp;&amp; \ dpkg -i early-ssh*.deb &amp;&amp; \ sed -ie <span class="hljs-string"><span class="hljs-string">'s/DISABLED=1/DISABLED=0/'</span></span> /etc/early-ssh/early-ssh.conf &amp;&amp; \ update-initramfs -u &amp;&amp; \ reboot</code> </pre><br>  Ping the recipient's IP address and monitor the TTL.  As soon as the TLL in the responses changes, this means that the initramdisk has loaded and is waiting for connections.  By default, it will not wait long, if after 15 seconds no one is connected, then the download will go on. <br><img src="https://habrastorage.org/files/f28/510/e1e/f28510e1e17f4793bfbe27ada73a38e7.png"><br>  Connect via ssh and get the shell.  In my case, authorization at root is by key, but it will work with a password, even if sshd_config is 'PermitRootLogin without-password' (because as in initramdisk there is a dropbear, not sshd). <br><img src="https://habrastorage.org/files/5fb/9b7/edb/5fb9b7edb1a84450bf245f7c86c14abb.png"><br>  Actually, one section. <br><br><h2>  Step 3. Data Transfer </h2><br>  You can transfer all the data either through dd (of course, if the recipient's disk size is not less than the source), or through rsync.  dd would be preferable if there is not enough free space on the file system or there are a lot of small files. <br><br><h3>  Option from dd to ssh: </h3><h3><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/xvda2 bs=65536 | ssh root@198.199.127.149 <span class="hljs-string"><span class="hljs-string">'dd of=/dev/vda1 bs=65536'</span></span></code> </pre><br><br></h3><h3>  Option with dd without encryption, but with compression: </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   nc -q 1 -l 8000 | gzip -d | dd bs=65536 of=/dev/vda1 #   dd if=/dev/xvda2 bs=65536 | gzip | nc -q 1 198.199.127.149 8000</span></span></code> </pre><br>  From the next console, you can constantly send a USR1 signal to dd to see how things are going: <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -USR1 `pidof dd`; sleep 10; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br><br><h3>  Option with rsync: </h3><br>  We recreate the file system on the recipient and mount it: <br><pre> <code class="bash hljs">mkfs.ext3 /dev/vda1 mkdir /mnt mount /dev/vda1 /mnt</code> </pre><br>  The ext3 file system, not ext4, just because the source is ext3.  Now from the source server: <br><pre> <code class="bash hljs">rsync -aAXv --one-file-system --progress / root@198.199.127.149:/mnt/</code> </pre><br>  (Be careful with the slashes at the end, they should be) <br><br><h2>  Step 4. Checking the kernel, checking / etc / fstab, setting up the network, updating grub settings </h2><br>  Mount the freshly copied filesystem on the receiver and chroot there: <br><pre> <code class="bash hljs">mount /dev/vda1 /mnt mount -o <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /dev/ /mnt/dev/ mount -o <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /proc/ /mnt/proc/ mount -o <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /sys/ /mnt/sys/ chroot /mnt PATH=<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span>:/usr/sbin bash</code> </pre><br><br>  Check that the kernel is installed (this is necessary if the source OS was on xen with paravirtualization) <br><pre> <code class="bash hljs">apt-cache search linux-image apt-get install linux-image-3.16.0-4-amd64 dpkg-reconfigure linux-image-3.16.0-4-amd64</code> </pre><br><br>  Update network settings in / etc / network / interfaces <br><pre> <code class="bash hljs">nano /etc/network/interfaces</code> </pre><br>  There is a small pitfall: in some cases, on some kernels, interfaces may be called differently.  For example, in Ubuntu it may be called ens3, and on the Debian kernel it is already eth0.  It‚Äôs better to just create entries for both options.  Or, you can add the kernel settings in / etc / default / grub so that it does not use the ens names (replace / add the GRUB_CMDLINE_LINUX line): <br><pre> <code class="hljs erlang">... GRUB_CMDLINE_LINUX=<span class="hljs-string"><span class="hljs-string">"net.ifnames=0 biosdevname=0"</span></span> ...</code> </pre><br>  + delete the /etc/udev/rules.d/70-persistent-net.rules file so that the kernel starts reading interfaces with eth0 <br><br>  The root fs itself in / etc / fstab (The device is now called vda1 + delete swap) <br><pre> <code class="bash hljs">nano /etc/fstab</code> </pre><br><img src="https://habrastorage.org/files/5da/ab6/0eb/5daab60eb71b47aaa16be6bf40f6d6f7.png"><br>  It is possible to learn through blkid the UUID and enter it: <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">UUID</span></span>="66bd1995-a4e5-418f-a1f7-0ec2f81ac017" / ext4 errors=remount-ro <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><br>  Well, the bootloader: <br><pre> <code class="bash hljs">apt-get install grub2 grub-install /dev/vda update-grub2</code> </pre><br><br>  Everything, you can unmount everything and reboot: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> <span class="hljs-comment"><span class="hljs-comment">#  bash exit #  chroot cd / umount /mnt/dev umount /mnt/proc umount /mnt/sys umount /mnt reboot</span></span></code> </pre><br><br>  After rebooting, check that the web page opens from the new IP: <br><img src="https://habrastorage.org/files/72b/ac3/b84/72bac3b8490e4c4ba3c40ff72bac66ac.png"><br><br><h1>  Installing Windows Server 2012r2 on DigitalOcean </h1><br><br><h2>  Step 1. Preparing the source </h2><br>  With Windows, things are a little more complicated, so I first made a virtual machine in VmWare, and then I transferred it from the hypervisor.  When installing, I indicated that the OS will be Linux, the Lsi SAS disk driver. <br>  Installed Windows server needs to be prepared for migration: <br><br><h3>  Download drivers for KVM </h3><br>  Download <a href="">fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso</a> (https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers), unpack, install Tools and for each inf file for our version of perform <pre>  PnPUtil -i -a &lt;InfName&gt; .inf </pre><br><img src="https://habrastorage.org/files/978/125/cd1/978125cd126946b28b09978621705359.png"><br>  (Or immediately for all <pre>  forfiles / S / M * .inf / C "cmd / c pnputil -i -a @Path" </pre>  ) <br><br><h3>  A bit of crutch magic </h3><br>  Crutches are because, in a good way, you need to do this through unattended.xml.  We create the file c: \ firstrun.bat, and we write the following there, replacing mac / ip / mask / gateway / password with what we have on the receiver virtual machine: <br><pre> <code class="hljs pgsql">@Echo <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> :: Mac <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Windows format (dashes)! <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> MAC=<span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-number"><span class="hljs-number">-50</span></span><span class="hljs-number"><span class="hljs-number">-56</span></span><span class="hljs-number"><span class="hljs-number">-9</span></span>E-B8<span class="hljs-number"><span class="hljs-number">-57</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IP=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.85</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> MASK=<span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> GW=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ADMINPW=QWEasd123 echo Started &gt;&gt; c:\firstrun.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-type"><span class="hljs-type">date</span></span> /T &gt;&gt; c:\firstrun.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> /T &gt;&gt; c:\firstrun.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> ipconfig /<span class="hljs-keyword"><span class="hljs-keyword">all</span></span> &gt;&gt; c:\firstrun.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> echo "Start to search network interface" &gt;&gt; c:\firstrun.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> :start_loop <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> /f "delims=, tokens=1,3 skip=1" %%a <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> (<span class="hljs-string"><span class="hljs-string">'getmac /V /FO CSV'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /I %%b == "%MAC%" ( echo "Found card" &gt;&gt; firstrun.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> echo %%a &gt;&gt; firstrun.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> netsh interface ip <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> address %%a static %IP% %MASK% %GW% <span class="hljs-number"><span class="hljs-number">10</span></span> netsh interface ip <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dns %%a <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span> goto :end_loop ) ) ping <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> goto :start_loop :end_loop net <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> Administrator %ADMINPW% reg <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d <span class="hljs-number"><span class="hljs-number">0</span></span> /f NetSh Advfirewall <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> allprofiles state <span class="hljs-keyword"><span class="hljs-keyword">off</span></span> reg <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Setup\State" /v ImageState /f reg <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> "HKEY_LOCAL_MACHINE\SYSTEM\Setup" /v OOBEInProgress /t REG_DWORD /d <span class="hljs-number"><span class="hljs-number">0</span></span> /f reg <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> "HKEY_LOCAL_MACHINE\SYSTEM\Setup" /v RestartSetup /t REG_DWORD /d <span class="hljs-number"><span class="hljs-number">0</span></span> /f reg <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> "HKEY_LOCAL_MACHINE\SYSTEM\Setup" /v SetupPhase /t REG_DWORD /d <span class="hljs-number"><span class="hljs-number">0</span></span> /f reg <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> "HKEY_LOCAL_MACHINE\SYSTEM\Setup" /v SetupType /t REG_DWORD /d <span class="hljs-number"><span class="hljs-number">0</span></span> /f reg <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v DigitalOceanHack /f echo "Ok, reboot" &gt;&gt; c:\firstrun.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> shutdown -r -t <span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre><br><br>  Next, in the console, we add this script to autorun and do sysprep in audit: <br><pre> <code class="hljs tex">reg add "HKEY_LOCAL_MACHINE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentVersion</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Run</span></span></span></span>" /v DigitalOceanHack /t REG_SZ /d "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">firstrun</span></span></span></span>.bat" /f <span class="hljs-comment"><span class="hljs-comment">%WINDIR%\system32\sysprep\sysprep /generalize /audit /shutdown</span></span></code> </pre><br><br>  The image is ready, at the next boot it will start configuring itself. <br><div class="spoiler">  <b class="spoiler_title">You can do without sysprep</b> <div class="spoiler_text">  I transferred Windows 10 from ESXi to KVM, before the final shutdown I did: Device Manager -&gt; IDE ATA / ATAPI controller -&gt; on each right Update Driver Software -&gt; Browse my computer ... -&gt; Let me pick ... -&gt; Select "Standart ... "(Of course checkbox" Show compatible hardware "is not removed). <br>  It got normal. <br></div></div><br><br><h2>  Step 2. Unmounting the root file system in the source, re-partitioning </h2><br>  Boot into ramdisk as in the previous example, move the root file system, create new partitions at the beginning of the disk, update the grub settings: <br><pre> <code class="bash hljs">e2fsck -f /dev/vda1 resize2fs /dev/vda1 25G fdisk /dev/vda Command: d Command: n Select (default p): p Partition number: 1 First sector: 2048 Last sector: +716799 <span class="hljs-comment"><span class="hljs-comment">###      Windows = 716800   1 Command: n Select (default p): p Partition number: 2 First sector: 718848 Last sector: +32833535 ###        1 Command: n Select (default p): p Partition number: 3 First sector: 73400320 ###   25 = 52428800      125829120 . Last sector: +52428799 # 25   - 1 Command: t Partition number: 1 Partition type: 7 Command: t Partition number: 2 Partition type: 7 Command: a Partition number: 1 Command: a Partition number: 3 Command: w</span></span></code> </pre><br><img src="https://habrastorage.org/files/6ff/7fe/95f/6ff7fe95f3c843afb108c4383c8676c9.png"><br>  The first section is 350MB bootable for Windows, the second is Windows itself, the third, respectively, Linux.  From where these numbers come from - it will be clear in the next step, so far you can first make two random-sized partitions (but so that the last sector is not less than the size of the Windows image) and then re-create them from Ubuntu when the image is copied to the Ubuntu file system.  Ultimately, it is important that the Windows partitions are in the same places and the same size as the source image. <br>  I left so much on the root file system because I‚Äôll temporarily put a vmdk file there.  In theory, you can immediately write it through the pipe to the section. <br>  Now we copy Ubuntu (it still lies at the beginning of the disk), 25GB from / dev / vda since sector 2048 to / dev / vda3: <br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/vda bs=4096 skip=256 count=6553600 of=/dev/vda3</code> </pre><br>  (skip and count are 8 times reduced because the block is not 512, but 4096) <br>  Be sure to update the grub settings and edit / etc / fstab if necessary (replace / dev / vda1 with / dev / vda3): <br><pre> <code class="bash hljs">mkdir /mnt mount /dev/vda3 /mnt mount -o <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /dev/ /mnt/dev/ mount -o <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /proc/ /mnt/proc/ mount -o <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /sys/ /mnt/sys/ chroot /mnt PATH=<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span>:/usr/sbin grub-install /dev/vda update-grub2 nano /etc/fstab <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> / umount /mnt/dev umount /mnt/proc umount /mnt/sys umount /mnt reboot</code> </pre><br><br><h2>  Step 3. In any way, copy the vmdk file to the newly loaded ubuntu </h2><br>  Well, if the vmdk file immediately represents a disk image (if not, then you need to convert it to raw via "qemu-img convert -p -f vmdk original.vmdk -O raw converted.raw") <br><pre> <code class="bash hljs">fdisk Windows2012r2.vmdk</code> </pre><br><img src="https://habrastorage.org/files/046/443/8ed/0464438ededc40d3b91f416e62131086.png"><br>  Here, in fact, is where the values ‚Äã‚Äãfor / dev / vda1 and / dev / vda2 for the previous step come from. <br><br>  We copy Windows from an image in sections: <br><pre> <code class="bash hljs">dd bs=4096 skip=256 count=89600 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=Windows2012r2.vmdk of=/dev/vda1 dd bs=4096 skip=89856 count=4104192 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=Windows2012r2.vmdk of=/dev/vda2</code> </pre><br>  (skip and count also mixed 8 times) <br>  You can try to mount / dev / vda1 and / dev / vda2 in order to check that everything is OK, and, if necessary, correct the settings in the crutch script. <br><br>  We update grub, we look that he saw Windows: <br><pre> <code class="bash hljs">update-grub2</code> </pre><br>  Now we turn on Windows for the next reboot, it‚Äôs convenient if something goes wrong, you can come back by turning off and turning on the virtual machine: <br><pre> <code class="bash hljs">grub-reboot 2 reboot</code> </pre><br>  Because  an image prepared via sysprep + a crutch script, then Windows will want to reboot 2 times at intervals of several minutes.  Those.  2 more times will have to log in to ubuntu and run the last 2 commands. <br><br><h2>  Step 4. Start Windows by default </h2><br>  Instead of turning windows into defaults in grub, it's better to just add to /etc/rc.local: <br><pre> <code class="bash hljs">sleep 60 &amp;&amp; grub-reboot 2 &amp;&amp; reboot &amp;</code> </pre><br>  - if Windows stops loading, you can manage to log in to Ubuntu and make ‚Äúkillall sleep‚Äù. <br><br>  After a reboot, you can go via RDP: <br><img src="https://habrastorage.org/files/a86/8c5/3a0/a868c53a0e5d47a4b7f9f8da17ce51b7.png"><br><br>  References: <br>  <a href="https://habrahabr.ru/post/189564/">Install any Linux distribution on Digital Ocean</a> </div><p>Source: <a href="https://habr.com/ru/post/283200/">https://habr.com/ru/post/283200/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283194/index.html">Azure-IaaS-Digest number 6 (April-May)</a></li>
<li><a href="../283196/index.html">We present data and code in order: data and markup, part 2</a></li>
<li><a href="../283198/index.html">About the 1C: Enterprise Mobile Platform</a></li>
<li><a href="../2832/index.html">Apple TV is already everywhere in the world in February, and in Russia ???</a></li>
<li><a href="../28320/index.html">Evolution of the registration form on recordings.ru</a></li>
<li><a href="../283202/index.html">Laboratory: Rust - let's talk about Rust in Kaspersky Lab on May 17</a></li>
<li><a href="../283204/index.html">We build a pre-built dylib into the application.</a></li>
<li><a href="../283208/index.html">Using Matalysis in computer games (part 3)</a></li>
<li><a href="../28321/index.html">A set of software for the usual user</a></li>
<li><a href="../283210/index.html">We are looking for vulnerabilities using google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>