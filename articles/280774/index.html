<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Behavior Analysis with Apache Spark</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It will be about using Apache Spark to analyze behavioral factors on a site that has a very large attendance. Accounting for behavioral factors is ver...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Behavior Analysis with Apache Spark</h1><div class="post__text post__text-html js-mediator-article">  It will be about using Apache Spark to analyze behavioral factors on a site that has a very large attendance.  Accounting for behavioral factors is very often used to increase resource conversion.  In addition, the capabilities of the Internet allow you to very quickly and easily collect and analyze a huge amount of very different statistical information.  Code samples will be shown and some tips based on the author‚Äôs personal experience will be given. <br><a name="habracut"></a><br>  Behavioral factors are one of the most effective methods for identifying the value of a document.  In essence, these are the variables on the basis of which the decision on the rating of a particular entity will be made.  If there is relatively little information, then it can be presented in a human-friendly graphical form (histogram, matrix, heat map, regression analysis graph, or hierarchical cluster analysis dendrogram).  For example, in the R programming language (it is very often used in data analysis) it is quite convenient to display graphs (plot) or matrices (mosaicplot, image, persp, contour).  In addition, a lot of useful functions are built into the R programming language (descriptive statistics, combinatorics, probability theory).  I'm not even talking about libraries for more complex analysis (for example, Random forest). <br><br>  However, the most important limitation of the assessor is productivity.  A person cannot appreciate a huge amount of information in a short period of time.  On the other hand, there is a wide range of tasks where it is impossible to do without a person, since some things are almost impossible to evaluate with an algorithm. <br><br>  If there is so much information that it cannot even fit into the memory of a supercomputer (on one node), then distributed data processing is used at several stations.  For example, Apache Spark is one of the most popular frameworks for distributed data processing.  Some tasks can be performed literally with one command (line of code in the console): <br><pre><code class="scala hljs">sc.textFile(path).map(s =&gt; (s, <span class="hljs-number"><span class="hljs-number">1</span></span>)).reduceByKey((a, b) =&gt; a + b).saveAsTextFile(pathSave)</code> </pre> <br>  The mentioned fragment of the source code in the Scala programming language allows you to count events (lines) in the log, where each line is strictly one name (unique identifier) ‚Äã‚Äãof the event.  As a result of launching this program, we will see a directory with several text files containing the results of data processing.  The data processing report will be displayed in a convenient user interface (http://127.0.0.1:4040/jobs/) with detailed information, including a visual display: <br><img src="https://habrastorage.org/files/835/ce5/262/835ce526260c40108afefaedc8d8c48c.png"><br>  After the data is loaded from a text file (textFile), all strings will be written as a special distributed dataset RDD (Resilient Distributed Dataset).  Now with the obtained data you can perform various operations.  It is important to note that transformations (the term Transformations is used in the original documentation) do not modify the set (it is immutable), but create a new one.  Moreover, Spark will not perform operations with this set until the desired moment (commands from the Actions list). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this particular case, the data set will be transformed into a map (the map will apply an action to each element by creating a new RDD).  The key will be a string, and one will be entered as a value.  Another transformation (reduceByKey) is the reduction of set elements by key.  The specified formula (a + b) summarizes the values ‚Äã‚Äãfor each key to be abbreviated.  Thus, only unique keys will remain, and as values ‚Äã‚Äãthey will have the number of repetitions in the original set.  If there is a desire to further simplify the above example, then we recall countByValue, which will make the mentioned task quite trivial. <br><br>  But what if I need to perform a real cluster analysis using the KMeans method?  For this there is a package spark.mllib, which contains many ready-made algorithms (including, but not limited to: clustering, linear regression, classification, collaborative filtering, decision tree, random forests, gradient boosting). <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.spark.mllib.clustering.{<span class="hljs-type"><span class="hljs-type">KMeans</span></span>, <span class="hljs-type"><span class="hljs-type">KMeansModel</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.spark.mllib.linalg.<span class="hljs-type"><span class="hljs-type">Vectors</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lines = sc.textFile(pathCsv) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> data = lines.map(s =&gt; <span class="hljs-type"><span class="hljs-type">Vectors</span></span>.dense(s.split(<span class="hljs-string"><span class="hljs-string">";"</span></span>).map(_.toDouble))).cache() <span class="hljs-comment"><span class="hljs-comment">//      val clusters = KMeans.train(data, 3, 20) clusters.clusterCenters.mkString("\n") //   </span></span></code> </pre><br>  I would especially like to note that the accuracy of the detection of the number of clusters will affect the accuracy of the algorithm.  Therefore, it is better to clean and check the data in advance. <br><br>  Associative rules can be attributed to one of the most common methods of analyzing behavioral factors.  They are very often used when finding template actions, for example, a typical market basket in online stores.  The idea of ‚Äã‚Äãassociation rules is as follows: to establish the probability of meeting in the set of some elements upon the presence of others.  For example, by the presence of a flashlight in the basket, guess the presence of a battery for it.  Of course, we are talking not only about purchases, but about any other template actions.  I will give an example of such an analysis: <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.spark.mllib.fpm.<span class="hljs-type"><span class="hljs-type">AssociationRules</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.spark.mllib.fpm.<span class="hljs-type"><span class="hljs-type">FPGrowth</span></span>.<span class="hljs-type"><span class="hljs-type">FreqItemset</span></span> <span class="hljs-comment"><span class="hljs-comment">// ,     val freqItemsets = sc.parallelize(Seq( new FreqItemset(Array("milk"), 31L), new FreqItemset(Array("red", "milk", "fantazia"), 84L), new FreqItemset(Array("milk", "fantazia"), 89L), new FreqItemset(Array("lemon"), 49L), new FreqItemset(Array("red", "milk", "lemon"), 14L), new FreqItemset(Array("green", "lemon"), 25L) )) val results = new AssociationRules().setMinConfidence(0.5).run(freqItemsets) results.collect().foreach { rule =&gt; println(rule.antecedent.mkString(",") + " -&gt; " + rule.consequent.mkString(",") + " // " + rule.confidence) }</span></span></code> </pre><br>  The tasks of the analysis of behavioral factors also include various components of the activity of people in social networks.  For such tasks it is more convenient to present the data in the form of a graph.  Fortunately, there is a component called GraphX.  The meaning of this component is to simplify the distributed processing of graphs.  His work can be shown by the example of identifying PageRank for sites.  First of all, we will define nodes and edges of the graph, and then we will execute with them some of the most elementary operations: <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.spark.graphx._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.spark.rdd.<span class="hljs-type"><span class="hljs-type">RDD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> v = <span class="hljs-type"><span class="hljs-type">Array</span></span>( (<span class="hljs-number"><span class="hljs-number">1</span></span>L, (<span class="hljs-string"><span class="hljs-string">"www.1.com"</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>)), (<span class="hljs-number"><span class="hljs-number">2</span></span>L, (<span class="hljs-string"><span class="hljs-string">"www.2.com"</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)), (<span class="hljs-number"><span class="hljs-number">3</span></span>L, (<span class="hljs-string"><span class="hljs-string">"www.3.com"</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>)), (<span class="hljs-number"><span class="hljs-number">4</span></span>L, (<span class="hljs-string"><span class="hljs-string">"www.4.com"</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span>)), (<span class="hljs-number"><span class="hljs-number">5</span></span>L, (<span class="hljs-string"><span class="hljs-string">"www.5.com"</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>)), (<span class="hljs-number"><span class="hljs-number">6</span></span>L, (<span class="hljs-string"><span class="hljs-string">"www.6.com"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> e = <span class="hljs-type"><span class="hljs-type">Array</span></span>( <span class="hljs-type"><span class="hljs-type">Edge</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>L, <span class="hljs-number"><span class="hljs-number">5</span></span>L, <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-type"><span class="hljs-type">Edge</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>L, <span class="hljs-number"><span class="hljs-number">5</span></span>L, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-type"><span class="hljs-type">Edge</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>L, <span class="hljs-number"><span class="hljs-number">5</span></span>L, <span class="hljs-number"><span class="hljs-number">3</span></span>), <span class="hljs-type"><span class="hljs-type">Edge</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>L, <span class="hljs-number"><span class="hljs-number">5</span></span>L, <span class="hljs-number"><span class="hljs-number">4</span></span>), <span class="hljs-type"><span class="hljs-type">Edge</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>L, <span class="hljs-number"><span class="hljs-number">1</span></span>L, <span class="hljs-number"><span class="hljs-number">5</span></span>) ) <span class="hljs-comment"><span class="hljs-comment">//    val graph: Graph[(String, Int), Int] = Graph(sc.parallelize(v), sc.parallelize(e)) //    ,      graph.vertices.filter{ case (id, (url, visits)) =&gt; visits &gt; 35 }.collect().mkString("\n") //     for (triplet &lt;- graph.triplets.collect()) { print(s"Link from ${triplet.srcAttr._1} (visits = ${triplet.srcAttr._2}) ") println(s"to ${triplet.dstAttr._1} (visits = ${triplet.dstAttr._2})") } // ,     PageRank graph.pageRank(0.001, 0.4).vertices.collect().foreach { site =&gt; println("Site Id = " + site._1 + ", PR = " + site._2) }</span></span></code> </pre><br>  The Apache Spark framework has an API for popular programming languages ‚Äã‚Äã(Scala, Python, and Java).  There is an opinion that in the Java programming language the code is a bit cumbersome.  In addition, to perform relatively simple tasks, I do not really want to write an application in Java.  But if necessary, and Java.  Connecting to the application should not cause much difficulty.  In addition to importing libraries, nothing was needed: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Run</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SparkConf conf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SparkConf().setMaster(<span class="hljs-string"><span class="hljs-string">"local"</span></span>).setAppName(<span class="hljs-string"><span class="hljs-string">"HABR"</span></span>); JavaSparkContext ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JavaSparkContext(conf); <span class="hljs-comment"><span class="hljs-comment">/** *  ‚Ññ1.  */</span></span> JavaRDD&lt;Point&gt; points = ctx.textFile(path).map(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Function&lt;String, Point&gt;() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Point </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String line)</span></span></span><span class="hljs-function"> </span></span>{ Double t = Double.parseDouble(line); Double x = <span class="hljs-number"><span class="hljs-number">5.5</span></span> * (Math.cos(t) + Math.cos(<span class="hljs-number"><span class="hljs-number">1.1</span></span> * t) / <span class="hljs-number"><span class="hljs-number">1.1</span></span>); Double y = <span class="hljs-number"><span class="hljs-number">5.5</span></span> * (Math.sin(t) - Math.sin(<span class="hljs-number"><span class="hljs-number">1.1</span></span> * t) / <span class="hljs-number"><span class="hljs-number">1.1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(x, y); } }); points.saveAsTextFile(savePath); <span class="hljs-comment"><span class="hljs-comment">/** *  ‚Ññ2.   SQLContext */</span></span> String sql = <span class="hljs-string"><span class="hljs-string">"SELECT * FROM sites WHERE type = 'b' AND id IN (1,2)"</span></span>; SQLContext sqlContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLContext(ctx); DataFrame sites = sqlContext.read().json(jsonPath); sites.show(); sites.registerTempTable(<span class="hljs-string"><span class="hljs-string">"sites"</span></span>); DataFrame results = sqlContext.sql(sql); results.show(); } }</code> </pre><br>  As for the logic of calculating the rating, it is very dependent on the project.  General indicators (views, failures, time on the site, viewing depth, repeated visits) are not always more informative than specially tracked events.  In my personal experience, they usually followed a fairly commonplace path.  At the time of data preparation (the site is written in Yii 2, and the Java service is responsible for filling it), all documents were processed to populate the database.  At the stage of this processing, the document rating was calculated, and the finished result was recorded in the database. <br><br>  As you understand, it is not necessary to perform calculations dynamically (with each page refresh).  Moreover, on sites with a huge load even caching (Memcached, Redis, Tarantool) will not help.  Consequently, it is necessary to carry out all the calculations in advance, and the PHP application should be used only for display (the model receives the already calculated rating from the database and displays it in the view using the controller).  By the way, on the part of the site (in its database), the rating is best stored with an integer.  Another very simple schematic example for clarity. <br><br>  Create a migration for Yii 2: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">db</span></span>\<span class="hljs-title"><span class="hljs-title">Migration</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m160401_134629_doc</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createTable(<span class="hljs-string"><span class="hljs-string">'{{%doc}}'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;primaryKey(), <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;string(<span class="hljs-number"><span class="hljs-number">150</span></span>)-&gt;notNull()-&gt;unique(), <span class="hljs-string"><span class="hljs-string">'content'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;text()-&gt;notNull(), <span class="hljs-string"><span class="hljs-string">'rating'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;integer()-&gt;notNull()-&gt;defaultValue(<span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-string"><span class="hljs-string">'created_at'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;integer()-&gt;notNull(), <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;integer()-&gt;notNull(), ], <span class="hljs-string"><span class="hljs-string">'CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE=InnoDB'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;dropTable(<span class="hljs-string"><span class="hljs-string">'{{%doc}}'</span></span>); } }</code> </pre><br>  And after her and the model: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">common</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * This is the model class for table "{{%doc}}". * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $name * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $content * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $rating * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $created_at * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $updated_at */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Doc</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yii</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tableName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'{{%doc}}'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [[<span class="hljs-string"><span class="hljs-string">'name'</span></span>, <span class="hljs-string"><span class="hljs-string">'content'</span></span>, <span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span>], <span class="hljs-string"><span class="hljs-string">'required'</span></span>], [[<span class="hljs-string"><span class="hljs-string">'content'</span></span>], <span class="hljs-string"><span class="hljs-string">'string'</span></span>], [[<span class="hljs-string"><span class="hljs-string">'rating'</span></span>, <span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span>], <span class="hljs-string"><span class="hljs-string">'integer'</span></span>], [[<span class="hljs-string"><span class="hljs-string">'name'</span></span>], <span class="hljs-string"><span class="hljs-string">'string'</span></span>, <span class="hljs-string"><span class="hljs-string">'max'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">150</span></span>], [[<span class="hljs-string"><span class="hljs-string">'name'</span></span>], <span class="hljs-string"><span class="hljs-string">'unique'</span></span>], ]; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attributeLabels</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ID'</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Name'</span></span>, <span class="hljs-string"><span class="hljs-string">'content'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Content'</span></span>, <span class="hljs-string"><span class="hljs-string">'rating'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Rating'</span></span>, <span class="hljs-string"><span class="hljs-string">'created_at'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Created At'</span></span>, <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Updated At'</span></span>, ]; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> integer $limit * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Doc[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDocs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($limit = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">10</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::find()-&gt;orderBy(<span class="hljs-string"><span class="hljs-string">'rating DESC'</span></span>)-&gt;limit($limit)-&gt;all(); } }</code> </pre><br>  Naturally, in the real project, there was already a ready-made functional that would display a list of certain entities sorted by rating.  Thought indexes, which I have not described in the example.  But the simple controller looked like the one shown below: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">frontend</span></span>\<span class="hljs-title"><span class="hljs-title">controllers</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">common</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>\<span class="hljs-title"><span class="hljs-title">Doc</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">web</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *   (-10) * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $limit = <span class="hljs-number"><span class="hljs-number">10</span></span>; $cacheTime = <span class="hljs-number"><span class="hljs-number">60</span></span>; $docs = Doc::getDb()-&gt;cache(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($db)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($limit)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Doc::getDocs($limit); }, $cacheTime); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($docs)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;goHome(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'index'</span></span>, [<span class="hljs-string"><span class="hljs-string">'docs'</span></span> =&gt; $docs]); } }</code> </pre><br>  And there were no difficulties in changing the code on the site.  Actually, why should they arise?  The main work is done by a non-website: uploading data on the website will contain a pre-processed Spark field.  In secret, in a real project, the Scala programming language was used to write very compact code for Spark. <br><br>  Of course, if the task is simple, then there is no point in implementing very complex algorithms.  For the preparation of a moderate amount of data it will turn out to use a very simple service.  Let's look at a schematic prototype in Java without using third-party libraries.  The interface asks us to pass the document object to the method, and return the number (Double), which reflects the rating level. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRating</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Double </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rating</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Doc doc)</span></span></span></span>; }</code> </pre><br>  Accordingly, we add several classes that calculate the rating differently.  In order to avoid artificial complication and going beyond the scope of this article, we will add a logical constraint: let there be two types of document ratings on the site.  For the first type, we find the rating by the number of views (visits) of the document: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainRating</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRating</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Double </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rating</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Doc doc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Math.log(doc.getVisits()) * <span class="hljs-number"><span class="hljs-number">2</span></span>); } }</code> </pre><br>  And for the second we calculate by another fictional formula: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdditionalRating</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRating</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Double </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rating</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Doc doc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (doc.getEvents() * <span class="hljs-number"><span class="hljs-number">0.5</span></span>) + Math.random(); } }</code> </pre><br>  Next, we will create an abstract class for the future factory: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRatingFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> IRating </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRatingType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String type)</span></span></span></span>; }</code> </pre><br>  We will not forget about the factory itself: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RatingFactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRatingFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IRating </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRatingType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"main"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MainRating(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"additional"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AdditionalRating(); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } }</code> </pre><br>  I really do not want to resort to value judgments.  However, I had a very good impression about Apache Spark.  When creating a very high-performance statistical system, he played an important role.  Moreover, its use in ‚Äúproduction‚Äù pleasantly surprised me with its efficiency and simplicity.  But this is my personal opinion, which I just want to share, and not impose.  In any case, sufficiently detailed documentation and the presence of several English-language books help to quickly explore its main features. <br><br>  For several years I had the desire to find some almost perfect tool.  Honestly, it took me a long time to get rid of this naive idea.  Now in my beliefs there is another idea - there cannot be a ‚Äúmagic pill‚Äù.  The effectiveness of each instrument depends on the specific situation.  A lot of books and articles have already been written on this topic, but over the years of daily reading of books on these topics, I‚Äôm imbued with just one thought - it is very rarely possible to immediately design a huge statistical system or web resource.  More often, this is an evolutionary process, during the development of which new modules are born with new modern technologies and the ‚Äúvictim of refactoring‚Äù that has not passed the natural selection goes into history.  The world is not static, is it not?  Actually, I want to wish your systems continuous and constructive development. </div><p>Source: <a href="https://habr.com/ru/post/280774/">https://habr.com/ru/post/280774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280762/index.html">A brief history of Bitcoin Blockchain for dummies. Tale for adults</a></li>
<li><a href="../280764/index.html">What should be in the c-file, and what should be in the h-file?</a></li>
<li><a href="../280766/index.html">Bayesian neural network is now orange (part 2)</a></li>
<li><a href="../280768/index.html">StartCOM: Certificate Transparency, Free * EV SSL Certificates</a></li>
<li><a href="../280770/index.html">The digest of interesting materials for the mobile developer # 147 (March 28 - April 3)</a></li>
<li><a href="../280776/index.html">IBM is working to strengthen information protection of "connected" cars</a></li>
<li><a href="../280782/index.html">Java programmer cheat sheet 8. Libraries for working with Json (Gson, Fastjson, LoganSquare, Jackson, JsonPath and others)</a></li>
<li><a href="../280784/index.html">Java Programmer Cheat Sheet 6. List of useful links for a Java programmer</a></li>
<li><a href="../280786/index.html">Microservice Architecture, Spring Cloud and Docker</a></li>
<li><a href="../280788/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ205 (March 28 - April 3, 2016)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>