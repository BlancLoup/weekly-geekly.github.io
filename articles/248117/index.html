<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>evalidate: secure processing of custom expressions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why do you need 
 Different filtering is everywhere. For example, the firewall netfilter (iptables) has its own syntax for describing packets. In the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>evalidate: secure processing of custom expressions</h1><div class="post__text post__text-html js-mediator-article"><h1>  Why do you need </h1><br>  Different filtering is everywhere.  For example, the firewall netfilter (iptables) has its own syntax for describing packets.  In the .htaccess apache file, your language, how to determine who should be given access to the directory, who does not.  The DBMS has its own very powerful language (SQL WHERE ...) for filtering records.  In mail programs (thunderbird, gmail) - its own interface for describing filters, in accordance with which letters will be scattered in folders. <br><br>  And everywhere - your bike. <br><br>  For the accounting program, it may be convenient for you to allow the user to choose who will be paid a salary (all women, as well as men aged 25 to 32 years, or up to 50 years if the man has the name Vasya).  And to each suitable raise by user expression (+ 2000 rubles + 20% of the previous salary + 1000 rubles for each year of experience) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For an online store (or its admin) - find all laptops with memory from 4 to 8 Gb, which are more than 3 in stock, but not Acer, or even Acer, if they cost less than 30,000 rubles. <br><br>  Of course, you can add your complex system of filters and criteria, make a web interface for them, but would it be easier to do everything in a couple of lines? <br><br><pre><code class="python hljs">src=<span class="hljs-string"><span class="hljs-string">"(RAM&gt;=4 and RAM&lt;=8 and stock&gt;3 and not brand=='Acer') or (brand=='Acer' and price&lt;30000)"</span></span> success, result = evalidate.safeeval(src,notebook)</code> </pre> <br><a name="habracut"></a><br><br><h1>  I want and prickly </h1><br>  The obvious way to add any logic to the program is via <a href="https://docs.python.org/2/library/functions.html">eval ()</a> .  The solution is the simplest, most flexible, but there are big pitfalls - security.  What if a custom expression will do os.system ('rm -rf /')? <br><br>  An example of how you can "fill up" a python through eval (): <br>  <a href="http://stackoverflow.com/questions/13066594/is-there-a-way-to-secure-strings-for-pythons-eval">stackoverflow.com/questions/13066594/is-there-a-way-to-secure-strings-for-pythons-eval</a> <br>  <a href="http://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html">nedbatchelder.com/blog/201206/eval_really_is_dangerous.html</a> (translation: <a href="http://habrahabr.ru/post/221937/">habrahabr.ru/post/221937</a> ) <br>  <a href="http://tav.espians.com/a-challenge-to-break-python-security.html">tav.espians.com/a-challenge-to-break-python-security.html</a> <br><br><h1>  Right way </h1><br>  Often, the ‚Äúcorrect way‚Äù is recommended in the boards - use the python itself to parse the code from the text form into the AST tree, and then parse the tree yourself, separating the grain from the goats.  But how?  And then the main problem of bicycle marketing comes to the arena - until you find a suitable bicycle, or at least a good drawing ... it's easier to invent the bicycle itself. <br><br><h1>  Evalidate </h1><br>  Meet <a href="http://evalidate.readthedocs.org/en/latest/">evalidate</a> , my little bike for this purpose.  Someone can use it himself (I tried to make it quite flexible), and the rest of the source code can serve as an example of how this problem can be solved (well, how can you not write code, of course). <br><br>  We put pip <br><pre> <code class="bash hljs">pip install evalidate</code> </pre><br><br>  A simple example: <br><br>  We place a text search line on the bookstore's website (the value is passed to the src variable - here they are hardcoded so that the web application does not fence, but they are quite safe to take from the user's request), and users can search for books by any available criteria in any combination.  Instead of separate buttons to show ‚Äúbooks that are not available‚Äù, ‚Äúcheap books‚Äù, ‚Äúexpensive books‚Äù, ‚ÄúBooks of authors who died before World War II, lived in Australia or any of the African countries that (books) we have in stock more than in 10 copies, and cost less than $ 1 per 100 pages of the book "- just one text field. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> evalidate depot = [ { <span class="hljs-string"><span class="hljs-string">'book'</span></span>: <span class="hljs-string"><span class="hljs-string">'Sirens of Titan'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">'stock'</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> }, { <span class="hljs-string"><span class="hljs-string">'book'</span></span>: <span class="hljs-string"><span class="hljs-string">'Gone Girl'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">9.8</span></span>, <span class="hljs-string"><span class="hljs-string">'stock'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, { <span class="hljs-string"><span class="hljs-string">'book'</span></span>: <span class="hljs-string"><span class="hljs-string">'Choke'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-string"><span class="hljs-string">'stock'</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }, { <span class="hljs-string"><span class="hljs-string">'book'</span></span>: <span class="hljs-string"><span class="hljs-string">'Pulp'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>: <span class="hljs-number"><span class="hljs-number">7.45</span></span>, <span class="hljs-string"><span class="hljs-string">'stock'</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> } ] <span class="hljs-comment"><span class="hljs-comment">#src='stock==0' # books out of stock src='stock&gt;0 and price&gt;8' # expensive book available for sale for book in depot: success, result = evalidate.safeeval(src,book) if success: if result: print book else: print "ERR:", result</span></span></code> </pre><br><br>  In this case, in src we have "user" code, which can be somehow bad.  In the example, two variants of the ‚Äúgood‚Äù code, the first one shows the books that we don‚Äôt have in stock, the second one - the expensive books that are available.  If you try to slip a bad code (just which is not parsed, code with reference to variables that we don‚Äôt have in context, code that uses unresolved operations, for example Call (function call)), then success will be False, and the program will report an error ( But will not fall, and will not execute the bad code). <br><br>  Alternatively, you can use evalidate.evalidate () to get an AST tree that is generated via ast.parse (either exception if the code is not parsed or contains unauthorized operations), and then compile it and execute it via eval (). <br><pre> <code class="python hljs">node = evalidate.evalidate(src) code = compile(node,<span class="hljs-string"><span class="hljs-string">'&lt;usercode&gt;'</span></span>,<span class="hljs-string"><span class="hljs-string">'eval'</span></span>) result = eval(code,{},data)</code> </pre><br><br>  Well, also look at the module code (it‚Äôs a blessing), and make your bike :-) <br><br><h1>  Appeal to the community </h1><br>  Evalidate includes its default set of ‚Äúsafe‚Äù (?) Python operations.  Simply, in my personal opinion, they are safe.  This means that within 15 minutes it did not occur to me how to do something terrible, using only these operations.  But maybe you will come?  Or, maybe it is worth adding some more operations to the list that will make the default configuration more flexible (they will allow using a richer expression language) and at the same time will not create vulnerabilities?  Any ideas? </div><p>Source: <a href="https://habr.com/ru/post/248117/">https://habr.com/ru/post/248117/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248103/index.html">How to make QML friends with someone else's OpenGL context. Part II: Loading QML</a></li>
<li><a href="../248105/index.html">Internet test drive "Mechatronics and Robotics". Need help from the Community</a></li>
<li><a href="../248111/index.html">We write fast and economical JavaScript code</a></li>
<li><a href="../248113/index.html">Krita: Green coordinates or how to make a kangaroo from a dragon</a></li>
<li><a href="../248115/index.html">The sound on the chip AY-3-8910 (or Yamaha YM2149F) comes from the ZX Spectrum on the PC via USB</a></li>
<li><a href="../248119/index.html">3D to D</a></li>
<li><a href="../248121/index.html">Apple has blocked developer accounts in Crimea</a></li>
<li><a href="../248129/index.html">Art Feature Engineering in Machine Learning</a></li>
<li><a href="../248131/index.html">International isolation made Cuba an island of hackers</a></li>
<li><a href="../248133/index.html">Status + new hell of trolling on the Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>