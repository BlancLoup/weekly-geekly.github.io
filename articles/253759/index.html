<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux file system entirely on tmpfs - speed without compromise</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 It so happened that for five years my ntfs partition with the Windows operating system is located on the ramdisk. It was decided not by h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux file system entirely on tmpfs - speed without compromise</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  It so happened that for five years my ntfs partition with the Windows operating system is located on the ramdisk.  It was decided not by hardware, but in a purely software way, accessible on any PC with a sufficient amount of RAM: a ramdisk is created using the grub4dos bootloader, and Windows recognizes it using the firadisk driver. <br><br>  However, until recently, I did not know how to implement this for Linux.  No, of course, there are a huge number of Linux LiveCDs that are loaded into memory using the kernel options toram, copy2ram, etc., but this is not exactly that.  First, these are compressed file systems, usually squashfs, so any reading from them is accompanied by unpacking overhead, which is detrimental to performance.  Secondly, it is a rather complicated cascade mount system (since squashfs is a read-only system, and for the operation of the OS, a record is needed), but I wanted as simple as possible, which can ‚Äútake and transform like that‚Äù Linux is bootable entirely in ram. <br><br>  Below I will describe this method, which was successfully tested.  For the experiments was taken the most distinguished distribution of Linux - Debian. <br><a name="habracut"></a><br>  I used the network installation, from the very minimum set: <br>  <a href="http://ftp.nl.debian.org/debian/dists/unstable/main/installer-amd64/current/images/netboot/debian-installer/amd64/linux">http://ftp.nl.debian.org/debian/dists/unstable/main/installer-amd64/current/images/netboot/debian-installer/amd64/linux</a> <br>  <a href="">http://ftp.nl.debian.org/debian/dists/unstable/main/installer-amd64/current/images/netboot/debian-installer/amd64/initrd.gz</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But since the installation of Debian is not the subject of this article, I will not describe it in detail. <br><br>  Such a choice is generally dictated by the fact that there is never a lot of RAM and there is no intention of keeping something huge like KDE in it.  After installing the programs necessary for the work on the hard disk, one and a half gigabyte was used.  Installation was carried out in one section, without section swap.  The RAM on the computer is 16 gigabytes. <br><br><h4>  Actually, the way </h4><br>  1. In the / usr / share / initramfs-tools / scripts / local file, comment out the line: <br>  checkfs $ {ROOT} root <br>  and line: <br>  mount $ {roflag} -t $ {FSTYPE} $ {ROOTFLAGS} $ {ROOT} $ {rootmnt} <br>  and immediately after it we insert the following text: <br><br>  mkdir / ramboottmp <br>  mount $ {roflag} -t $ {FSTYPE} $ {ROOTFLAGS} $ {ROOT} / ramboottmp <br>  mount -t tmpfs -o size = 100% none $ {rootmnt} <br>  cd $ {rootmnt} <br>  tar -zxf /ramboottmp/ram.tar.gz <br>  umount / ramboottmp <br><br>  2. Run the mkinitramfs -o /initrd-ram.img command <br>  and after it has completed, we will return the / usr / share / initramfs-tools / scripts / local file to its original state. <br><br>  3. In the / etc / fstab file we comment out the line describing the mounting of the root partition / and insert the following line: <br>  none / tmpfs defaults 0 0 <br><br>  4. Download some other Linux from the LiveCD to completely get rid of the operating system under test, <br>  and archive the entire partition with its file system: <br>  cd / mnt / first &amp;&amp; busybox tar -czf /mnt/work/ram.tar.gz * <br>  after the end, we will return the / etc / fstab file to its original state. <br><br>  5. As a result, we have got Linux, consisting of only three files: <br>  Kernel, initrd-ram.img and ram.tar.gz.  The location of ram.tar.gz is specified in the root = kernel parameter in the grub bootloader menu: <br>  title Linux in RAM <br>  kernel / vmlinuz root = / dev / sdb1 <br>  initrd /initrd-ram.img <br><br>  This is all instruction.  Required Comments: <br>  - we will comment out checkfs because there is no such fsck to check tmpfs, did not write it; <br>  - we use busybox tar to create an archive instead of a simple tar, because there is no simple tar in the initrd, we will unpack our archive exactly busybox, and there is such a bug that it will not be able to unpack; <br>  - the asterisk in the command line is not terrible, since there are usually no hidden files and folders in the root, and they are archived in directories. <br>  - / mnt / first is the mounted partition with the OS under test, and / mnt / work / is the partition for the archive. <br><br><h4>  How it works? </h4><br>  We made a special initrd, which, when loaded, creates a root file system like tmpfs (this is all salt, since it is located in RAM), then looks at the root = section specified in the option, takes an archive file whose name is hardcoded (ram. tar.gz), and unpacks from it the whole FS tree to this tmpfs. <br><br>  So FS is in memory. <br><br>  Moreover, tmpfs has the advantageous differences from ramdisks (including the one I use for Windows) - it is not a block device, but a file system, it takes up space in the memory exactly as long as the files are occupied, and dynamically increases, if you install something, new files, and reduced if you uninstall software, delete files.  The remaining memory is available for the operating system, programs.  And Linux understands that it is ALREADY memory and does not need to be cached.  Wonderful thing! <br><br><h4>  Benefits </h4><br>  Yes, of course, caching in modern OS partially solves the problem of poor performance of disk devices, but it still takes time to first read the file from the disk, and it can also be unloaded from the cache at any time and then it will take time to reread it.  Placing the entire OS in memory is an uncompromising decision, guaranteeing the highest possible speed of reading and writing its files.  The simplest test using dd demonstrates 3 gigabytes per second for sequential reading and 2 gigabytes per second for sequential writing: <br><br>  dd if = / dev / zero of = / test bs = 1M count = 500 <br>  524288000 bytes (524 MB) copied, 0.268589 s, 2.0 GB / s <br><br>  dd if = / test of = / dev / null bs = 1M count = 500 <br>  524288000 bytes (524 MB) copied, 0.167294 s, 3.1 GB / s <br><br>  This is about 30 times faster than HDD, and 8 times faster than SSD. <br><br>  An advanced test using fio demonstrates iops 349059 with random reading and complete latency of 0.29 microseconds (the latency is two to three (decimal) ORDERS less than the SSD): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fb6/e86/efb/fb6e86efbb10ecf7f9300b4c98c34087.jpg" alt="randread 4K fio"><br><br><h4>  In work </h4><br>  The output of the free command in a typical working situation: <br><br>  total used free shared buffers cached <br>  Mem: 16469572 3236968 13232604 2075372 65552 2687436 <br><br>  Immediately after loading about 2 gigabytes of memory is used, of which 1.5 is occupied by the file system.  With 16 gigabytes of RAM, there is plenty of room for installing even large applications like LibreOffice or Blender.  The size of the ram.tar.gz file is approximately half a half, which allows storing it, the kernel and the initrd on any small flash drive or on a CD.  Hard disk may not be at all.  Such a system is not killed.  But the main thing is, of course, the speed of work. <br><br>  In conclusion, a thirty-second screencast on the actual speed of launching applications in such a system.  No, this is not the opening of applications from the tray, this is the launch of programs from the media, which in this case is tmpfs: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/EE1TpdjBLvM&amp;xid=17259,15700021,15700186,15700191,15700253&amp;usg=ALkJrhg0vO8Pef7niwi-5UDhKNHDG64W4Q" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/253759/">https://habr.com/ru/post/253759/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253743/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ152 (March 16 - 22, 2015)</a></li>
<li><a href="../253745/index.html">Creating full-fledged applications on Max 7. Part 1 - Task setting, visual programming</a></li>
<li><a href="../253749/index.html">RAII and unhandled exceptions</a></li>
<li><a href="../253751/index.html">We connect SAP Solution Manager and SAP WPB to the joy of users and support services</a></li>
<li><a href="../253755/index.html">Machine learning - 3. Poisson random process: views and clicks</a></li>
<li><a href="../253761/index.html">Pattern-matching (one more) in coffeescript</a></li>
<li><a href="../253763/index.html">Testing the Intel¬Æ Storage System JBOD 2000 Family Shelf</a></li>
<li><a href="../253765/index.html">Manage Azure virtual machines with PowerShell</a></li>
<li><a href="../253767/index.html">We invite you to participate in Security Meetup April 9</a></li>
<li><a href="../253769/index.html">How to catch what is not. Part Two: Projectile and Armor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>