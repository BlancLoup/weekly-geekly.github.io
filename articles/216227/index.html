<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a parser with XPath and Yii</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Sometimes there are tasks when you need to implement a wrapper for working with the API of a certain service for the needs of the custo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a parser with XPath and Yii</h1><div class="post__text post__text-html js-mediator-article"><h5>  Introduction </h5><br>  Sometimes there are tasks when you need to implement a wrapper for working with the API of a certain service for the needs of the customer and to do a similar task is basically quite simple, but the service does not always have this API, or the thought arises that it would be better if it were not, therefore you have to parse the entire content page . <br><br>  As an example for this article, we will use the XenForo <a href="http://9af5766eb2759a49.demo-xenforo.com/130/index.php">demo</a> forum and a previously created topic, from where we will parse the typical data: the title, the time of creation and the text of the topic itself, while the parsing will be carried out in an authorized forum account.  All other data can be taken by analogy. <br><br>  The parser itself is implemented as a component for convenient use in Yii2. <br><a name="habracut"></a><br><h5>  What do we need </h5><br><ul><li>  The cURL library will be used to parse the page, so it must be installed in advance. </li><li>  Since Yii will not be used much (for logging the process of parsing, the actual call of parsing and rendering the result), only to show the performance of the parser itself.  Therefore, for such tasks it is quite enough to use <a href="https://github.com/samdark/yii2-minimal">Yii2 minimal</a> . </li></ul><br><h5>  Let's start </h5><br>  Create the ParserXenforo component.  Since we don't need events, it will be enough to inherit from Object. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">components</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">base</span></span>\<span class="hljs-title"><span class="hljs-title">Object</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParserXenforo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre> <br><br>  We need to add properties and constants to load the page.  The host, username, password, curlOpt properties themselves will be set in the component settings. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">components</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">base</span></span>\<span class="hljs-title"><span class="hljs-title">Object</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParserXenforo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Uri      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> REQUEST_URI_LOGIN = <span class="hljs-string"><span class="hljs-string">'login/login'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *     cookies */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> COOKIES_FILE_NAME = <span class="hljs-string"><span class="hljs-string">'cookies.txt'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_data; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $host; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $username; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $password; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array  cURL */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $curlOpt; }</code> </pre><br><br>  Add page loading methods. <br>  First, we will implement a method to get the set header and user-agent values ‚Äã‚Äãthat will be stored in curlOpt, and in the future be passed to the cURL parameters <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurlOpt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($nameOpt)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($nameOpt !== <span class="hljs-string"><span class="hljs-string">'userAgent'</span></span> &amp;&amp; $nameOpt !== <span class="hljs-string"><span class="hljs-string">'header'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;curlOpt[$nameOpt]; }</code> </pre><br>  For authorization on the forum you need to transfer the username and password through POST.  To do this, we will create an authorization url (host + authorization url) <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLoginUrl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;host . <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::REQUEST_URI_LOGIN; }</code> </pre><br>  And the POST request string <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createPostRequestForCurl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'login='</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;username . <span class="hljs-string"><span class="hljs-string">'&amp;password='</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;password . <span class="hljs-string"><span class="hljs-string">'&amp;remember=1'</span></span>; }</code> </pre><br>  To save the authorization, we will use the file with cookies at runtime.  To get the full path of this file, create a method that receives the full path from the path alias and adds the file name to it. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPathToCookieFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($cookieFileName = self::COOKIES_FILE_NAME)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Yii::getAlias(<span class="hljs-string"><span class="hljs-string">'@app/runtime'</span></span>) . DIRECTORY_SEPARATOR . $cookieFileName; }</code> </pre><br>  We implement the method of parsing the page with the passed parameters.  First, we switch to action authorization, where we transmit POST values ‚Äã‚Äãand return to the transferred url, but already in an authorized account.  Just in case.  Since, for example, I often saw that a module for hiding content from unauthorized users is installed on this forum. <br>  After successful loading of data in _data, we log the Yii :: info () method that the data is loaded. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadUsingCurl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url)</span></span></span><span class="hljs-function"> </span></span>{ $ch = curl_init(); curl_setopt($ch, CURLOPT_URL, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;loginUrl); curl_setopt($ch, CURLOPT_FAILONERROR, <span class="hljs-number"><span class="hljs-number">1</span></span>); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="hljs-number"><span class="hljs-number">1</span></span>); curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="hljs-number"><span class="hljs-number">1</span></span>); curl_setopt($ch, CURLOPT_REFERER, $url); curl_setopt($ch, CURLOPT_HTTPHEADER, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getCurlOpt(<span class="hljs-string"><span class="hljs-string">'header'</span></span>)); curl_setopt($ch, CURLOPT_COOKIEFILE, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pathToCookieFile); curl_setopt($ch, CURLOPT_COOKIEJAR, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pathToCookieFile); curl_setopt($ch, CURLOPT_FRESH_CONNECT, <span class="hljs-number"><span class="hljs-number">1</span></span>); curl_setopt($ch, CURLOPT_USERAGENT, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getCurlOpt(<span class="hljs-string"><span class="hljs-string">'userAgent'</span></span>)); curl_setopt($ch, CURLOPT_POST, <span class="hljs-number"><span class="hljs-number">1</span></span>); curl_setopt($ch, CURLOPT_POSTFIELDS, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createPostRequestForCurl()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data = curl_exec($ch); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (curl_exec($ch) === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(curl_errno($ch) . <span class="hljs-string"><span class="hljs-string">': '</span></span> . curl_error($ch)); } curl_close($ch); Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'Loading data page'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; }</code> </pre><br><br>  The basic part of the component is implemented.  Now you need to connect it to the components and configure.  By specifying the data of your computer in the user-agent, for example, where the component is located, the base url and the data for authorization. <br>  The parameters for authorization were given in the admin: admin demo.  But only one was given for several days, but rather to Mar 24, 2014 at 7:26 AM <br><br><pre> <code class="php hljs">.... <span class="hljs-string"><span class="hljs-string">'components'</span></span> =&gt; [ ... <span class="hljs-string"><span class="hljs-string">'parser'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'app\components\ParserXenforo'</span></span>, <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://9af5766eb2759a49.demo-xenforo.com/130/index.php?'</span></span>, <span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, <span class="hljs-string"><span class="hljs-string">'curlOpt'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'userAgent'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36'</span></span>, <span class="hljs-string"><span class="hljs-string">'header'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'Accept: text/html, application/xml;q=0.9, application/xhtml+xml, image/png, image/jpeg, image/gif, image/x-xbitmap, */*;q=0.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'Accept-Language: en-US,en;q=0.8,ru;q=0.6,uk;q=0.4'</span></span>, <span class="hljs-string"><span class="hljs-string">'Accept-Charset: Windows-1251, utf-8, *;q=0.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'Accept-Encoding: deflate, identity, *;q=0'</span></span>, ] ] ], ... ], ....</code> </pre><br>  In the controller we can check the performance by calling in action and see if the app.log logs did everything well <br><br><pre> <code class="php hljs">$urlThread = <span class="hljs-string"><span class="hljs-string">'http://9af5766eb2759a49.demo-xenforo.com/130/index.php?threads/some-thread.1/'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \app\components\ParserXenforo $dataParse */</span></span> $dataParse = Yii::$app-&gt;parser-&gt;loadUsingCurl($urlThread);</code> </pre><br><br><h5>  Data parsing </h5><br>  Start by creating a method to get an object of the DOMDocument class of our page and add a property to store it.  Before disabling errors libxml and do the opposite after downloading.  To avoid some problems with the parsing of the page.  As a result, we get the DOM of our page for further work with it.  You could also use regular expressions.  But working with the DOM is more convenient in this case. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createDomDocument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_dom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DOMDocument(); libxml_use_internal_errors(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_dom-&gt;loadHTML(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data)) { Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'Create DomDocument'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'An error occurred when creating an object of class DOMDocument'</span></span>)); } libxml_use_internal_errors(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; }</code> </pre><br><br>  We proceed to the method of obtaining a new object of the DOMXPath class so that it is convenient to execute the specified XPath expression to obtain the required data. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createDomXpath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_xpath = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DOMXPath(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_dom); Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'Create DomXpath'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; }</code> </pre><br><br>  Well, now everything can be safely turned to the execution of XPath queries to get our data: title, timestamp and content. <br>  First we get the title and add the _title property <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseTitle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $xpathQuery = <span class="hljs-string"><span class="hljs-string">'*//h1'</span></span>; $nodes = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_xpath-&gt;query($xpathQuery, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_dom); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($nodes-&gt;length === <span class="hljs-number"><span class="hljs-number">0</span></span>) { Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'Error parse title'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_title = $nodes-&gt;item(<span class="hljs-number"><span class="hljs-number">0</span></span>)-&gt;nodeValue; Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parse title'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; }</code> </pre><br><br>  Next timestamp of our topic <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseTimestamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $xpathQuery = <span class="hljs-string"><span class="hljs-string">'*//p[@id="pageDescription"]/a/abbr'</span></span>; $nodes = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_xpath-&gt;query($xpathQuery, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_dom); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($nodes-&gt;length === <span class="hljs-number"><span class="hljs-number">0</span></span>) { Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'Error parse timestamp'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//   timestamp $this-&gt;_timestamp = $nodes-&gt;item(0)-&gt;getAttribute('data-time'); Yii::info(Yii::t('app', 'Parse timestamp')); return $this; }</span></span></code> </pre><br>  Last get the content <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseContent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $xpathQuery = <span class="hljs-string"><span class="hljs-string">'*//blockquote[@class="messageText ugc baseHtml"]'</span></span>; $nodes = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_xpath-&gt;query($xpathQuery, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_dom); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($nodes-&gt;length === <span class="hljs-number"><span class="hljs-number">0</span></span>) { Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'Error parse content'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_content = $nodes-&gt;item(<span class="hljs-number"><span class="hljs-number">0</span></span>)-&gt;nodeValue; Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parse content'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; }</code> </pre><br><br>  Wrap back a bit and consider in more detail what kind of XPath requests we made <br><ul><li>  '* // h1' look in the DOM h1.  * // means to search around the DOM </li><li>  * // p [@ id = "pageDescription"] / a / abbr look for the pc element id pageDescription which has a link with the abbr element </li><li>  * // blockquote [@ class = "messageText ugc baseHtml"] look for a quote with class messageText ugc baseHtml </li></ul><br><br>  Create a method for completing the parsing (it may not be entirely necessary, but it will still be more clearly seen that data parsing has been completed and all data has been received), as well as methods for accessing the received data <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> \app\components\ParserXenforo */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">endParse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_content, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_timestamp, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_content)) { Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'End parse'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Yii::info(Yii::t(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, <span class="hljs-string"><span class="hljs-string">'Some data were not received'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string title */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTitle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_title; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int timestamp */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTimestamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_timestamp; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string content */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_content; }</code> </pre><br><br><h5>  Output Results </h5><br>  We can say that the component is ready, we can see how it works by adding the necessary actions to our controller‚Äôs action and view their output <br><br><pre> <code class="php hljs">$urlThread = <span class="hljs-string"><span class="hljs-string">'http://9af5766eb2759a49.demo-xenforo.com/130/index.php?threads/some-thread.1/'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \app\components\ParserXenforo $dataParse */</span></span> $dataParse = Yii::$app-&gt;parser -&gt;loadUsingCurl($urlThread) -&gt;createDomDocument() -&gt;createDomXpath() -&gt;parseTitle() -&gt;parseTimeStamp() -&gt;parseContent() -&gt;endParse(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'index'</span></span>, [<span class="hljs-string"><span class="hljs-string">'data'</span></span> =&gt; $dataParse]);</code> </pre><br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> yii\web\View $this * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \app\components\ParserXenforo $data */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;title = <span class="hljs-string"><span class="hljs-string">'My Yii Application'</span></span>; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">h1</span></span></span><span class="hljs-class">&gt;&lt;?= $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">title</span></span></span><span class="hljs-class">; ?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">h1</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Created</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">At</span></span></span><span class="hljs-class">: &lt;?= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ymd</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">H</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">', $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timestamp</span></span></span><span class="hljs-class">); ?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">&gt;&lt;?= $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">content</span></span></span><span class="hljs-class">; ?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br><br>  The result is a similar result. <br><img src="//habrastorage.org/files/06a/245/95c/06a24595c7fa4eb5b0a8638f27c668c7.png" alt="image"><br><br><h5>  Conclusion </h5><br>  In this article, we looked at how to make a page content parser as a component for Yii using the example of parsing the XenForo forum topic. <br>  By analogy, you can make the parsing and other data, or create a slightly different class that will be used by us for parsing for example all the forum topics, in principle: <br><ul><li>  We get the pagination of the page if there is. </li><li>  We pass through the pages to get links to those and write to some intermediate repository. </li><li>  We get the content on these links. </li></ul><br>  The theoretical aspect was not covered in this article, the article was oriented to show on a less real but simple example how to get the page data. <br>  A link to the example code can be viewed in the resources. <br><br><h5>  Resources </h5><br>  <a href="http://rmcreative.ru/blog/post/yii2-minimal">Description Yii2 minimal</a> <br>  <a href="">Yii2 documentation</a> <br>  <a href="http://citforum.ru/internet/xpath/index.shtml">Xpath 1.0 specification in Russian</a> <br>  <a href="https://github.com/demetrodon/parser-xenforo">Source Code Repository</a> </div><p>Source: <a href="https://habr.com/ru/post/216227/">https://habr.com/ru/post/216227/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216215/index.html">Creating a failover IPSec VPN tunnel between Mikrotik RouterOS and Kerio Control</a></li>
<li><a href="../216219/index.html">We expand the functionality of the exchange of orders between 1C-Bitrix and 1C Enterprise UT 11</a></li>
<li><a href="../216221/index.html">4 ways to turn "No" into "Yes"</a></li>
<li><a href="../216223/index.html">Add Cyrillic to Source Sans Pro Font for Lumen Bootstrap Theme</a></li>
<li><a href="../216225/index.html">Optimization of the geometric algorithm of learning ANN in the analysis of independent components</a></li>
<li><a href="../216229/index.html">How is the infrastructure of data processing Sports.ru and Tribuna.com?</a></li>
<li><a href="../216231/index.html">Dorian / Satoshi Nakamoto made an official statement: ‚ÄúI have no relation to Bitcoin‚Äù</a></li>
<li><a href="../216233/index.html">The defeat of robots: the ups and downs of high-frequency trading (Part 1)</a></li>
<li><a href="../216235/index.html">The sacred cow, karma and mustache: how and why the Indians are not indifferent to IB</a></li>
<li><a href="../216237/index.html">Windows Pocket Concept</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>