<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Network caching in iOS. NSURLCache</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This topic is important when developing any application that interacts with the network. Here, competent use of the system's capabilities can signific...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Network caching in iOS. NSURLCache</h1><div class="post__text post__text-html js-mediator-article"> <i>This topic is important when developing any application that interacts with the network.</i>  <i>Here, competent use of the system's capabilities can significantly improve user interaction with the program.</i> <br><br>  <code>NSURLCache</code> is a comprehensive solution for caching network requests in RAM or on disk.  In accordance with <a href="https://developer.apple.com/library/mac/">Apple's documentation</a> , any request using <code>NSURLConnection</code> will be ‚Äúskipped‚Äù through <code>NSURLCache</code> . <br><br>  Caching reduces the number of necessary calls to the network, improves the impression of working with the program during the complete absence of the Internet or problems with a network connection. <br><a name="habracut"></a><br>  After downloading the server response, its copy is stored in the local cache.  The next time you send the same request, the answer will be returned instantly, without accessing the network.  <code>NSURLCache</code> returns user data in a transparent manner. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To use <code>NSURLCache</code> you need to set the value of the <code>sharedURLCache</code> singleton.  You can do this in the <code>application:didFinishLaunchingWithOptions:</code> method on iOS or in <code>applicationDidFinishLaunching:</code> - on Mac OS X: <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)application:(<span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span> *)application didFinishLaunchingWithOptions:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)launchOptions { <span class="hljs-built_in"><span class="hljs-built_in">NSURLCache</span></span> *URLCache = [[<span class="hljs-built_in"><span class="hljs-built_in">NSURLCache</span></span> alloc] initWithMemoryCapacity:<span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> diskCapacity:<span class="hljs-number"><span class="hljs-number">20</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> diskPath:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; [<span class="hljs-built_in"><span class="hljs-built_in">NSURLCache</span></span> setSharedURLCache:URLCache]; }</code> </pre><br>  You can manage caching settings - both on the client side and on the server side.  Competent choice of options can be useful when optimizing your application. <br><br><h4>  NSURLRequestCachePolicy </h4><br>  On the server request side, the caching policy is set using the <code>cachePolicy</code> property of the <code>cachePolicy</code> object.  You can choose one of the following options: <br><ul><li>  <code>NSURLRequestUseProtocolCachePolicy</code> is the default value.  The caching logic is determined by the implementation of the network protocol used in the request. </li><li>  <code>NSURLRequestReloadIgnoringLocalCacheData</code> - data is always loaded from the server, the contents of the cache are completely ignored. </li><li>  <code>NSURLRequestReloadIgnoringLocalAndRemoteCacheData</code> - the contents of the local cache are ignored.  In addition, the proxy server and other intermediate infrastructure should be instructed not to use a cached copy of the data whenever possible. </li><li>  <code>NSURLRequestReturnCacheDataElseLoad</code> - information is returned from the cache, and information about its relevance is not taken into account.  If there is no data in the cache, it is loaded from the network. </li><li>  <code>NSURLRequestReturnCacheDataDontLoad</code> - data is taken from the cache, information about their obsolescence is ignored.  However, if the stored information is missing, the request is immediately considered as not passed, without trying to get it from the server. </li><li>  <code>NSURLRequestReloadRevalidatingCacheData</code> - cached data is used only after preliminary confirmation of its validity by the server.  Data that has become irrelevant is pumped out of the network. </li></ul><br>  The differences between these options are not always obvious and often lead to confusion.  The fact that <code>NSURLRequestReloadIgnoringLocalAndRemoteCacheData</code> and <code>NSURLRequestReloadRevalidatingCacheData</code> <a href="https://gist.github.com/mattt/4753073">does</a> not add clarity is not added in principle. <br><br>  What you really need to know about <code>NSURLRequestCachePolicy</code> can be summarized as follows: <br><ul><li>  <code>UseProtocolCachePolicy</code> - default behavior </li><li>  <code>ReloadIgnoringLocalCacheData</code> - do not use cache </li><li>  <s><code>ReloadIgnoringLocalAndRemoteCacheData</code> - do not use the cache.</s>  <s>Quite</s> </li><li>  <code>ReturnCacheDataElseLoad</code> - use cache.  Ignore information about its relevance. </li><li>  <code>ReturnCacheDataDontLoad</code> - offline mode.  Use only cached data, regardless of their ‚Äúfreshness‚Äù </li><li>  <s><code>ReloadRevalidatingCacheData</code> - before using, ask the server how relevant the cache is</s> </li></ul><br><h4>  HTTP caching </h4><br>  Since the <code>NSURLConnection</code> class <code>NSURLConnection</code> designed to work with various network protocols (including FTP and HTTP / HTTPS), the caching documentation is described in a protocol-independent manner.  In this article we will consider it from the point of view of the HTTP protocol. <br><br>  In HTTP, server request and response <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">headers</a> are used to exchange meta information about coding, MIME types, caching, and so on. <br><br><h5>  Request headers </h5><br>  By default, <code>NSURLRequest</code> uses the current time to determine whether to return cached information.  For more fine-tuning, you can use the following headings: <br><ul><li>  <code>If-Modified-Since</code> - this header corresponds to the header of the <code>Last-Modified</code> response from the server.  Its value must be set to <code>Last-Modified</code> from the last access to this service. </li><li>  <code>If-None-Match</code> - corresponds to the <code>Etag</code> response.  Here you need to transfer the previous received value <code>Etag</code> . </li></ul><br><h5>  Response headers </h5><br>  With <code>NSHTTPURLResponse</code> , caching-related headers can also be returned: <br><ul><li>  <code>Cache-Control</code> - this header must be present in the response in order to enable HTTP caching on the client.  Its value may contain information about the duration of data storage in the cache, as well as the level of access to it.  Detailed information is available <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">here</a> . </li></ul><br>  In addition to <code>Cache-Control</code> , the server can send additional headers used for conditional data retrieval (see the previous section): <br><ul><li>  <code>Last-Modified</code> - the time of the last change of the requested resource.  For example, when receiving information about a photo album, the <code>Last-Modified</code> header may be set to a value equivalent to the date of the last photo. </li><li>  <code>Etag</code> is the content ID of the requested object.  In practice, this may be, for example, <a href="http://en.wikipedia.org/wiki/MD5">MD5-hash</a> of the resource status.  This is useful in the case of dynamically generated data for which the definition of <code>Last-Modified</code> problematic. </li></ul><br><h4>  NSURLConnectionDelegate </h4><br>  When processing the result of the request, the delegate of <code>NSURLConnection</code> has the ability to change the cached response using the <code>connection:willCacheResponse:</code> method.  An <code>NSCachedURLResponse</code> object is passed to this call, which contains a link to the source <code>NSURLResponse</code> and cached data in the form of <code>NSData</code> .  This object is created based on information obtained from a network connection.  Since you cannot change instances of the <code>NSCachedURLResponse</code> class, to edit any parameters, you need to create a new object using the <code>initWithResponse:data:userInfo:storagePolicy:</code> initializer <code>initWithResponse:data:userInfo:storagePolicy:</code> for example: <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-built_in"><span class="hljs-built_in">NSCachedURLResponse</span></span> *)connection:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> *)connection willCacheResponse:(<span class="hljs-built_in"><span class="hljs-built_in">NSCachedURLResponse</span></span> *)cachedResponse { <span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span> *mutableUserInfo = [[cachedResponse userInfo] mutableCopy]; <span class="hljs-built_in"><span class="hljs-built_in">NSMutableData</span></span> *mutableData = [[cachedResponse data] mutableCopy]; <span class="hljs-built_in"><span class="hljs-built_in">NSURLCacheStoragePolicy</span></span> storagePolicy = <span class="hljs-built_in"><span class="hljs-built_in">NSURLCacheStorageAllowedInMemoryOnly</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... return [[NSCachedURLResponse alloc] initWithResponse:[cachedResponse response] data:mutableData userInfo:mutableUserInfo storagePolicy:storagePolicy]; }</span></span></code> </pre><br>  If <code>connection:willCacheResponse:</code> returns <code>nil</code> , the answer will not be cached at all. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSCachedURLResponse</span></span> *)connection:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> *)connection willCacheResponse:(<span class="hljs-built_in"><span class="hljs-built_in">NSCachedURLResponse</span></span> *)cachedResponse { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; }</code> </pre><br>  <code>connection:willCacheResponse:</code> method <code>connection:willCacheResponse:</code> - optional.  If it is not implemented in the delegate, an automatically created instance of <code>NSCachedURLResponse</code> will be used. <br><br><h4>  Underwater rocks </h4><br>  There are several features when working with <code>NSURLCache</code> : <br><ul><li>  In <nobr>iOS 5,</nobr> disk caching is possible only when using HTTP, <a href="http://petersteinberger.com/blog/2012/nsurlcache-uses-a-disk-cache-as-of-ios5/">but not HTTPS</a> .  This support is implemented only in <nobr>iOS 6</nobr> . </li><li>  There are also some nuances when interacting with servers that <a href="http://blackpixel.com/blog/2012/05/caching-and-nsurlconnection.html">do not use caching headers</a> . </li></ul><br><h4>  Conclusion </h4><br>  The <code>NSURLCache</code> example once again shows us how important it is to know the capabilities of the system with which you work. <br><br>  Many developers invent their own bike for organizing caching, because they do not know about the capabilities of <code>NSURLCache</code> , which initialization takes only 2 lines of code and makes the work 100 times more efficient.  An even greater number do not even think about the advantages of network caching and do not use it, loading their server with a huge number of unnecessary requests. <br><br>  Thus, for optimal performance of your application, always initialize <code>NSURLCache</code> in the <code>application:didFinishLaunchingWithOptions:</code> method. </div><p>Source: <a href="https://habr.com/ru/post/179349/">https://habr.com/ru/post/179349/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179333/index.html">Windows NT kernel developer explains reasons for poor OS performance</a></li>
<li><a href="../179335/index.html">Stop solving global problems!</a></li>
<li><a href="../179337/index.html">How I calculated the millionth article in Russian Wikipedia</a></li>
<li><a href="../179339/index.html">Monitor Magazine (April 1992) and the Parables of Computer Residents</a></li>
<li><a href="../179345/index.html">NeoLucida - 21st Century Portable Camera-Lucid</a></li>
<li><a href="../179351/index.html">Mysterious stationery. Test 2</a></li>
<li><a href="../179359/index.html">MaskJS - HMV * framework</a></li>
<li><a href="../179367/index.html">We turn Google Search to face us</a></li>
<li><a href="../179369/index.html">What should an IT person do in the Russian army</a></li>
<li><a href="../179371/index.html">Some statistics on email marketing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>