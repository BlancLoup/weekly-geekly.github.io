<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows Trojan specializes in stealing data from isolated air-gapped computers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our analysts have discovered an unusual Trojan program for Windows, which specializes in infecting removable USB-drives and differs from other similar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows Trojan specializes in stealing data from isolated air-gapped computers</h1><div class="post__text post__text-html js-mediator-article">  Our analysts have discovered an unusual Trojan program for Windows, which specializes in infecting removable USB-drives and differs from other similar malware with interesting features.  One of such features of the Trojan is the fact that each of its copies is unique and is directly dependent on the particular drive infected by it, and it leaves no traces of work in the compromised system of the victim.  This method is used as a self-defense mechanism against copying your body from a disk with the subsequent analysis of its functions. <br><br><img src="https://habrastorage.org/files/9a2/257/dc1/9a2257dc18054d12a826f418d0599cbd.jpeg"><br><br>  In our study, we will present the technical features of this malicious program, which uses a special technique of compromising removable media.  This technique differs from the old known method based on the use of autofun.inf files or specially shaped shortcut files.  The malicious program resorts to the method of compromising portable (portable) versions of such well-known applications such as Firefox, NotePad ++ and TrueCrypt.  When a user starts such an application, it secretly launches this trojan on the user's system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  The malware consists of six files.  Four files are executable, and the other two are configuration files.  To protect files from analytics analysis, the Trojan uses two methods.  The first is based on file encryption using the AES-128 algorithm.  The second involves the generation of file names using cryptography. <br><br>  The encryption key of the symmetric AES algorithm is computed from the value of the removable device ID (Device ID), as well as several other disk-dependent values.  Thus, the malware can successfully work only with a specific device that has been compromised. <br><br>  Malware execution is based on the sequential execution of code from various executable files.  Since the files can be hidden in a portable version of the above applications, this will not attract the attention of the user.  To transfer control to the code in the next file in the chain, the malware calculates its name based on the calculation of the special value (hash), which is formed from the contents of this file and eight bytes of the value of its creation date.  Thus, the file names are different for each instance of the malware.  In addition, copying the malware to a different location will change the value of the date the file was created, that is, its actions cannot be replicated in another location.  For a better understanding of the file naming mechanism, see the image below. <br><br>  Analyzing this type of malware is quite challenging because we did not have access to one of the infected devices.  We also did not have a dropper of malware for infecting a removable drive in appropriate conditions.  Thus, we only had files that we found that were uploaded by users.  To decrypt the Trojan files, we had to use the brute force method to search for a unique device identifier and combine it with the value of the general properties of removable media.  After decrypting the files, we also needed to find out the correct order of the executable files and configuration files, because in the process of copying the malware file to us for analysis, the timestamp of its creation was changed. <br><br>  The flow of the malicious code is quite simple.  Each loader launches the next level loader for execution, the name of the executable file of which is calculated by the hash value in accordance with the algorithm for generating names described above.  However, the boot process must begin with the first level loader, otherwise the trojan completes its execution. <br><br><img src="https://habrastorage.org/files/587/188/c35/587188c35b1a42e79e49ee8934302b95.png"><br><br>  <b>First level loader</b> <br><br>  The first level loader is the starting point of the malicious program execution.  He also specializes in deceiving a user in such a way as to draw attention to the launch of a malicious file.  The task can be accomplished in several ways, but the most interesting of them is the method based on the use of portable versions of popular applications.  We recorded the use for this purpose of the application Notepad ++, which was equipped with a special malicious plug-in, as well as a portable version of the encryption application TrueCrypt, which included a library called ‚ÄúRichEd20.dll‚Äù.  The loader also checks its launch location and will perform its main launch functions on the execution of the payload file only in the case of removable USB storage media.  This check is necessary because the payload component stores the stolen data on the media. <br><br>  <b>Second level loader</b> <br><br>  The second level loader file will be detected by the first level loader using a special value based on the hash of the file content (see above) and, further, will be launched for execution.  Further, the configuration file of this bootloader will be found using the same hash value of the configuration file.  This configuration file contains the encrypted name of the parent process to verify.  Such an anti-debugging trick will lead to the completion of a malicious program if another process starts it, for example, the debugger.  The last step uses the hash of the contents of the configuration file to calculate the name of the executable file of the third-level loader. <br><br>  <b>Level 3 loader</b> <br><br>  The third level loader checks for the presence of anti-virus products in the system.  In the case of activity in the system of processes with the names ‚Äúavpui.exe‚Äù (belongs to Kaspersky antivirus) and ‚ÄúAVKTray.exe‚Äù (belongs to the antivirus G Data), the execution of the malware code stops.  Its configuration file is decrypted in the same way that was mentioned above several times.  The loader also creates a named pipe (named pipe) to transfer the configuration file to the payload.  The first 30 bytes of the SHA-512 hash calculated from the computer name are used as the channel object name. <br><br>  <b>Payload</b> <br><br>  At the last stage, the management receives the payload code that implements the data theft functions.  The executable file is embedded in the% windir% \ system32 \ svchost.exe -k netsvcs process created with the following command line.  The mentioned configuration data includes information about what data should be collected, how it should be encrypted, and where it should be stored.  In any case, the directory for saving files should be located on removable media.  In the sample we analyzed, the malware was configured to store files of the following type: images, documents, registry hive files (HKCU), a list of directory files of available disks.  Also, attackers are interested in information collected using an open source program called ‚ÄúWinAudit‚Äù.  This software specializes in data encryption using elliptical cryptography algorithms. <br><br>  <b>Conclusion</b> <br><br>  In addition to the interesting self-defense mechanism of this multi-stage malware, the relatively simple functions of stealing payload data are compensated for by the fact that it leaves no trace of its activity on the compromised computer.  After disconnecting from the removable storage system, no one will know that data was stolen from the computer. <br><br>  It should be noted that the task of reorienting malware to a new payload is not difficult and can be used by attackers in future malicious campaigns. <br><br>  As shown by our statistics on the distribution of this malware, it is not widespread.  On the other hand, its likely purpose is to use in directed attacks, especially on air-gapped computers isolated from the global network.  This measure is usually used to improve the security of the internal network and the computers connected to it. <br><br>  <b>Indicators of compromise</b> <br><br>  Detection names for anti-virus products: <br><br>  Payload files: Win32 / PSW.Stealer.NAI <br>  Loader files: Win32 / TrojanDropper.Agent.RFT <br><br>  SHA-1 hashes of decrypted files: <br><br>  2C188C395AB32EAA00E6B7AA031632248FF38B2E <br>  B03ABE820C0517CCEF98BC1785B7FD4CDF958278 <br>  66D169E1E503725A720D903E1DFAF456DB172767 <br>  4B2C60D77915C5695EC9D3C4364E6CD6946BD33C </div><p>Source: <a href="https://habr.com/ru/post/280085/">https://habr.com/ru/post/280085/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280075/index.html">Java "var" keyword: please, not this</a></li>
<li><a href="../280077/index.html">Oracle SPARC T7 and M7 Servers - A New Platform for Secure Computing</a></li>
<li><a href="../280079/index.html">Time to learn: Digest of free educational materials from Mail.Ru Group</a></li>
<li><a href="../280081/index.html">Sorting tables in Cach√© DBMS</a></li>
<li><a href="../280083/index.html">Microservices. How to do and when to apply?</a></li>
<li><a href="../280087/index.html">Superscalar stack processor: details</a></li>
<li><a href="../280089/index.html">Conference DUMP-2016: Review of the Web-design section</a></li>
<li><a href="../280091/index.html">Who are the most famous hackers in history?</a></li>
<li><a href="../280093/index.html">25 questions asked during an interview with Linux system administrators</a></li>
<li><a href="../280095/index.html">Emulate and intercept SIM commands via the SIM Toolkit on Android 5.1 and below (CVE-2015-3843)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>