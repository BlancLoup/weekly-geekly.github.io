<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Merging Rails and Merb: Performance (Part 2 of 6)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Six consecutive articles on the merger of Rails and Merb were published on www.engineyard.com from December 2009 to April 2010. This is the second art...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Merging Rails and Merb: Performance (Part 2 of 6)</h1><div class="post__text post__text-html js-mediator-article">  <i>Six consecutive articles on the merger of Rails and Merb were published on <a href="http://www.engineyard.com/">www.engineyard.com</a> from December 2009 to April 2010.</i>  <i>This is the second article.</i>  <i>The first is <a href="http://habrahabr.ru/blogs/ror/87907/">here</a> .</i> <br><br>  The next great improvement we hoped to bring to Rails from Merb was better performance.  Since Merb came after Rails, Merb developers had the opportunity to find out which parts of Rails were used more often and optimize their performance. <br><br>  We wanted to take performance-enhancing changes from Merb and transfer them to Rails 3. In this post, I‚Äôll cover several optimization points added to Rails 3: reducing controller time and (strong) acceleration of the collection of partials. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To begin with, we focused on the performance of several specific, but widely used parts of Rails: <br><ul><li>  Overhead (router plus price for entry and exit from the controller) </li><li>  render: text </li><li>  render: template </li><li>  render: partial </li><li>  render of several (10 and 100) identical partials in a cycle </li><li>  render of several (10 and 100) identical partials with the help of collection </li></ul><br>  This is clearly a rough estimate, but it covered most cases where performance could be significantly better, but the Rails developer was not able to improve it on his own. <br><br><h4>  Controller overhead </h4><br>  The first step was to improve the costs of the Rails controller.  In Rails 2.3, there is no way to test them, because you have to use <code>render :string</code> to send text to the client in response, which means doing the entire render process.  And yet, we wanted to reduce it as much as possible. <br><br>  By doing this, we used Stefan Kaes 'fork (Stefan Kaes' fork of ruby-prof), which <code>CallStackPrinter</code> with <code>CallStackPrinter</code> (the best way to visualize profile data from a Ruby application, from all I've seen).  We also wrote several benchmarks that could duplicate the profiler in the course of its work in order to focus on a particular site and obtain more accurate data. <br><br>  When we looked at the process of the controller, it turned out that the dominant part was occupied by the creation of an answer.  Rummaging deeper, we saw that ActionController installed the headers directly, then parsed them again before returning the answer to get additional information.  A good example of this phenomenon is the <code>Content-Type</code> header, which has two components (the content-type itself and the optional charset).  Both components were available in the Response object via a getter and a setter: <br><br><blockquote> <code><a href="http://s-c.me/7438/s"></a> <a href="http://s-c.me/7438/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">content_type</font> =(mime_type)&lt;br/&gt; <font color="#0000ff">self</font> .headers[ <font color="#008000">"Content-Type"</font> ] =&lt;br/&gt; <font color="#0000ff">if</font> mime_type =~ / <font color="#cc6633">charset</font> / || (c = <font color="#cc6633">charset</font> ). <font color="#0000ff">nil</font> ?&lt;br/&gt;      mime_type.to_s&lt;br/&gt; <font color="#0000ff">else</font> &lt;br/&gt; <font color="#008000">"#{mime_type}; charset=#{c}"</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#696969"># Returns the response's content MIME type, or nil if content type has been set.</font> &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">content_type</font> &lt;br/&gt; <font color="#cc6633">content_type</font> = <font color="#0000ff">String</font> (headers[ <font color="#008000">"Content-Type"</font> ] || headers[ <font color="#008000">"type"</font> ]). <font color="#0000ff">split</font> ( <font color="#008000">";"</font> )[ <font color="#008000">0</font> ]&lt;br/&gt; <font color="#cc6633">content_type</font> .blank? ? <font color="#0000ff">nil</font> : <font color="#cc6633">content_type</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#696969"># Set the charset of the Content-Type header. Set to nil to remove it.</font> &lt;br/&gt; <font color="#696969"># If no content type is set, it defaults to HTML.</font> &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">charset</font> =( <font color="#cc6633">charset</font> )&lt;br/&gt;  headers[ <font color="#008000">"Content-Type"</font> ] =&lt;br/&gt; <font color="#0000ff">if</font> <font color="#cc6633">charset</font> &lt;br/&gt; <font color="#008000">"#{content_type || Mime::HTML}; charset=#{charset}"</font> &lt;br/&gt; <font color="#0000ff">else</font> &lt;br/&gt; <font color="#cc6633">content_type</font> || <font color="#cc6633">Mime</font> ::HTML.to_s&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">charset</font> &lt;br/&gt; <font color="#cc6633">charset</font> = <font color="#0000ff">String</font> (headers[ <font color="#008000">"Content-Type"</font> ] || headers[ <font color="#008000">"type"</font> ]). <font color="#0000ff">split</font> ( <font color="#008000">";"</font> )[ <font color="#008000">1</font> ]&lt;br/&gt; <font color="#cc6633">charset</font> .blank? ? <font color="#0000ff">nil</font> : <font color="#cc6633">charset</font> .strip. <font color="#0000ff">split</font> ( <font color="#008000">"="</font> )[ <font color="#008000">1</font> ]&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</font></code> </blockquote> <br>  As you can see, the Response object worked directly with the Content-Type header, parsing part of the header if necessary.  This was particularly problematic because Response did extra work on the headers during the preparations before sending the response to the client: <br><br><blockquote> <code><a href="http://s-c.me/7439/s"></a> <a href="http://s-c.me/7439/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">assign_default_content_type_and_charset</font> !&lt;br/&gt; <font color="#0000ff">self</font> .content_type ||= <font color="#cc6633">Mime</font> ::HTML&lt;br/&gt; <font color="#0000ff">self</font> .charset ||= default_charset <font color="#0000ff">unless</font> sending_file?&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</font></code> </blockquote> <br>  That is, before sending the response, Rails again split the <code>Content-Type</code> header semicolon and then did more work with strings to connect them together again.  And of course, <code>Response#content_type=</code> used in other parts of Rails to properly set it depending on the type of template or inside the <code>respond_to</code> blocks. <br><br>  This did not take hundreds of milliseconds when queried, but in heavily cached applications, the costs could be higher than the cost of removing objects from the cache and returning them to the client. <br><br>  The solution in this case was to store the content type and charset in the fields of the response object and combine them with one simple quick operation when preparing the response. <br><br><blockquote> <code><a href="http://s-c.me/7440/s"></a> <a href="http://s-c.me/7440/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt;attr_accessor :charset, :content_type&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">assign_default_content_type_and_charset</font> !&lt;br/&gt; <font color="#0000ff">return if</font> headers[CONTENT_TYPE].present?&lt;br/&gt; &lt;br/&gt;  @content_type ||= <font color="#cc6633">Mime</font> ::HTML&lt;br/&gt;  @charset ||= <font color="#0000ff">self</font> . <font color="#0000ff">class</font> .default_charset&lt;br/&gt; &lt;br/&gt;  type = @content_type. <b>to_s</b> .dup&lt;br/&gt;  type &lt; &lt; <font color="#008000">"; charset=#{@charset}"</font> <font color="#0000ff">unless</font> @sending_file&lt;br/&gt; &lt;br/&gt;  headers[CONTENT_TYPE] = type&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</font></code> </blockquote> <br>  Now we just find the instance variables and create one String.  Multiple changes to these lines of code have reduced the time spent from approximately 400 microseconds to 100 microseconds.  Of course, not a lot of time, but it could really weaken performance-sensitive applications. <br><br><h4>  Render Partial Collection </h4><br>  Rendering a collection of partials was another good opportunity for optimization.  And in this case, the improvement was milliseconds, not microseconds! <br><br>  First, implementation in Rails 2.3: <br><br><blockquote> <code><a href="http://s-c.me/7441/s"></a> <a href="http://s-c.me/7441/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">render_partial_collection</font> (options = {}) <font color="#696969">#:nodoc:</font> &lt;br/&gt; <font color="#0000ff">return nil if</font> options[:collection].blank?&lt;br/&gt; &lt;br/&gt;  partial = options[:partial]&lt;br/&gt;  spacer = options[:spacer_template] ? <b>render</b> (:partial =&gt; options[:spacer_template]) : <font color="#008000">''</font> &lt;br/&gt;  local_assigns = options[:locals] ? options[:locals].clone : {}&lt;br/&gt;  as = options[:as]&lt;br/&gt; &lt;br/&gt;  index = <font color="#008000">0</font> &lt;br/&gt;  options[:collection].map <font color="#0000ff">do</font> |object|&lt;br/&gt;    _partial_path ||= partial ||&lt;br/&gt;      ActionController::RecordIdentifier.partial_path(object, controller. <font color="#0000ff">class</font> .controller_path)&lt;br/&gt;    template = _pick_partial_template(_partial_path)&lt;br/&gt;    local_assigns[template.counter_name] = index&lt;br/&gt;    result = template.render_partial( <font color="#0000ff">self</font> , object, local_assigns.dup, as)&lt;br/&gt;    index += <font color="#008000">1</font> &lt;br/&gt;    result&lt;br/&gt; <font color="#0000ff">end</font> .join(spacer).html_safe!&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</font></code> </blockquote> <br>  An important part is what happened inside the loop, which could happen hundreds of times in a large collection of partials.  In this case, the implementation in Merb had better performance, which we were able to transfer to Rails.  Here is the implementation of Merb. <br><br><blockquote> <code><a href="http://s-c.me/7444/s"></a> <a href="http://s-c.me/7444/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt;with = [opts. <b>delete</b> (:with)].flatten&lt;br/&gt;as = (opts. <b>delete</b> (:as) || template.match(%r[(?:.*/)?_([^\./]*)])[ <font color="#008000">1</font> ]).to_sym&lt;br/&gt; &lt;br/&gt; <font color="#696969"># Ensure that as is in the locals hash even if it isn't passed in here</font> &lt;br/&gt; <font color="#696969"># so that it's included in the preamble.</font> &lt;br/&gt;locals = opts.merge(:collection_index =&gt; - <font color="#008000">1</font> , :collection_size =&gt; with.size, as =&gt; opts[as])&lt;br/&gt;template_method, template_location = _template_for(&lt;br/&gt;  template,&lt;br/&gt;  opts. <b>delete</b> (: <font color="#0000ff">format</font> ) || content_type,&lt;br/&gt;  kontroller,&lt;br/&gt;  template_path,&lt;br/&gt;  locals.keys)&lt;br/&gt; &lt;br/&gt; <font color="#696969"># this handles an edge-case where the name of the partial is _foo.* and your opts</font> &lt;br/&gt; <font color="#696969"># have :foo as a key.</font> &lt;br/&gt;named_local = opts.key?(as)&lt;br/&gt; &lt;br/&gt;sent_template = with.map <font color="#0000ff">do</font> |temp|&lt;br/&gt;  locals[as] = temp <font color="#0000ff">unless</font> named_local&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">if</font> template_method &amp;&amp; <font color="#0000ff">self</font> . <b>respond_to</b> ?(template_method)&lt;br/&gt;    locals[:collection_index] += <font color="#008000">1</font> &lt;br/&gt;    send(template_method, locals)&lt;br/&gt; <font color="#0000ff">else</font> &lt;br/&gt; <font color="#0000ff">raise</font> TemplateNotFound, <font color="#008000">"Could not find template at #{template_location}.*"</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> .join&lt;br/&gt; &lt;br/&gt;sent_template &lt;br/&gt;</font></code> </blockquote> <br>  Now we understand that this is far from ideal.  A lot of things happen here (and I personally would like to see this method refactored).  But the interesting part is what happens inside the loop (starting with <code>sent_template = with.map</code> ).  Unlike ActionView, which figured out the name of the template, took the template object, the name of the counter, etc., Merb limited the activity inside the loop to setting several Hash values ‚Äã‚Äãand calling the method. <br><br>  For a collection of 100 partials, the difference between the costs could be about 10 ms and 3 ms.  For the collection of small partials, this was noticeable (and the reason for the inline partials, which were appropriate in order for the partials to come first). <br><br>  In Rails 3, we improved performance by reducing what happens inside the loop.  Unfortunately, one feature of Rails made optimizing a little more difficult.  In particular, you could render a partial using a heterogeneous collection (a collection containing Post, Article and Page objects, for example) and Rails would render the correct template for each object (Article objects are rendered in <code>_article.html.erb</code> , etc.) .  This means that it is not always possible to determine the exact pattern that needs to be rendered. <br><br>  Faced with this problem, we were not able to fully optimize the heterogeneous case, but we did <code>render :partial =&gt; "name", :collection =&gt; @array</code> faster.  To achieve this, we split the logic into 2 ways: faster for the case when we know the pattern, and slower for the case when it needs to be defined depending on the object. <br><br>  Here is what the render collection now looks like when we know the pattern: <br><br><blockquote> <code><a href="http://s-c.me/7443/s"></a> <a href="http://s-c.me/7443/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">collection_with_template</font> (template = @template)&lt;br/&gt;  segments, locals, as = [], @locals, @options[:as] || template.variable_name&lt;br/&gt; &lt;br/&gt;  counter_name = template.counter_name&lt;br/&gt;  locals[counter_name] = - <font color="#008000">1</font> &lt;br/&gt; &lt;br/&gt;  @collection.each <font color="#0000ff">do</font> |object|&lt;br/&gt;    locals[counter_name] += <font color="#008000">1</font> &lt;br/&gt;    locals[as] = object&lt;br/&gt; &lt;br/&gt;    segments &lt; &lt; template. <b>render</b> (@view, locals)&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt;  @template = template&lt;br/&gt;  segments&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</font></code> </blockquote> <br>  What's important, the loop itself is now small (even simpler than what happened inside the loop in Merb).  What else is worth noting is that in the process of improving the performance of the code, we created a PartialRenderer object to track the state.  Although you might think that creating a new object would be expensive, it turns out that creating objects in Ruby is relatively cheap and objects can offer caching options that are much more complicated in procedural code. <br><br>  For those who want to see improvements in pictures, here are a few things: first, the improvement between Rails 2.3 and Rails 3 in Ruby 1.9 (a smaller bar means more speed). <br><img src="https://habrastorage.org/getpro/habr/post_images/2fa/b1b/954/2fab1b9541a4501e2f2a97083d0f4cd2.jpg" alt="image"><br><br>  But for more expensive operations: <br><img src="https://habrastorage.org/getpro/habr/post_images/808/c45/2e5/808c452e5a003b4a57074e9c09fe8df3.jpg" alt="image"><br><br>  Finally, a comparison of Rails 3 on four platforms (Ruby 1.8, Ruby 1.9, Rubinius, and JRuby): <br><img src="https://habrastorage.org/getpro/habr/post_images/813/6aa/68d/8136aa68d23ae8119f44e66ea6f04ebc.jpg" alt="image"><br><br>  As you can see, Rails 3 is noticeably faster than Rails 2.3, and that all platforms (including Rubinius!) Are noticeably improved compared to Ruby 1.8.  In general, a wonderful year for Ruby! <br><br>  In the next post I‚Äôll tell you about the improvements in the Rails 3 API for plugin authors - follow the messages and, as always, leave comments! </div><p>Source: <a href="https://habr.com/ru/post/90160/">https://habr.com/ru/post/90160/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../90150/index.html">Finding an Alternative to Basecamp: Unfuddle.com Review</a></li>
<li><a href="../90151/index.html">Faith-driven development</a></li>
<li><a href="../90153/index.html">In the wake of RusKrypto'2010</a></li>
<li><a href="../90154/index.html">Electronic check-in for the Russian Railways train - export of a ticket to Google and Yandex. Calendar</a></li>
<li><a href="../90156/index.html">.Net and Navision 5.0 - Friendship Forever</a></li>
<li><a href="../90164/index.html">SunCalc - Solar Calculator</a></li>
<li><a href="../90166/index.html">How to make money on vending machines: VendExpo 2010</a></li>
<li><a href="../90167/index.html">Where is it all the valor?</a></li>
<li><a href="../90169/index.html">Advertising platform = provider?</a></li>
<li><a href="../90171/index.html">Termination of the Makhost services</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>