<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of computer networks. Subject number 6. VLAN, Trunk, and VTP and DTP protocols</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Happy New Year everyone! We continue to talk about networks and today we will touch on such an important topic in the switching world as VLAN. Let's s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of computer networks. Subject number 6. VLAN, Trunk, and VTP and DTP protocols</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/730/624/5b5/7306245b529346dba6f169eaac55087a.jpg"></div><br>  Happy New Year everyone!  We continue to talk about networks and today we will touch on such an important topic in the switching world as VLAN.  Let's see what he is and how to work with him.  And also we will sort the VTP and DTP protocols working with it. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Content</b> <div class="spoiler_text">  1) <a href="https://habrahabr.ru/post/307252/">Basic network terms, OSI network model and TCP / IP protocol stack.</a> <br>  2) <a href="https://habrahabr.ru/post/307714/">Top-level protocols.</a> <br>  3) <a href="https://habrahabr.ru/post/308636/">Protocols of lower levels (transport, network and channel).</a> <br>  4) <a href="https://habrahabr.ru/post/312340/">Network devices and types of cables used.</a> <br>  5) <a href="https://habrahabr.ru/post/314484/">The concept of IP addressing, subnet masks and their calculation.</a> <br>  6) The concept of VLAN, Trunk and VTP and DTP protocols. <br>  7) <a href="https://habrahabr.ru/post/321132/">Spanning Tree Protocol: STP.</a> <br>  8) <a href="https://habrahabr.ru/post/334778/">Channel Aggregation Protocol: Etherchannel.</a> <br>  9) Routing: static and dynamic on the example of RIP, OSPF and EIGRP. <br>  10) Network Address Translation: NAT and PAT. <br>  11) Reservation protocols for the first transition: FHRP. <br>  12) Computer network security and virtual private networks: VPN. <br>  13) Global networks and protocols used: PPP, HDLC, Frame Relay. <br>  14) Introduction to IPv6 configuration and routing. <br>  15) Network management and network monitoring. <br><br>  PS Perhaps over time, the list will be added. </div></div><br>  In previous articles, we have already worked with many network devices, understood how they differ from each other and considered what frames, packets, and other PDUs consist of.  In principle, with this knowledge, you can organize a simple local network and work in it.  But the world does not stand still.  There are more and more devices that load the network or even worse - they pose a security risk.  And, as a rule, ‚Äúdanger‚Äù appears before ‚Äúsecurity‚Äù.  Now I will show it with the simplest example. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d78/17b/60b/d7817b60b635420fbc9417076d373082.PNG"></div><br>  We will not touch on routers and different subnets for now.  Assume all nodes are on the same subnet. <br><br>  Immediately give a list of IP addresses: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  PC1 - 192.168.1.2/24 </li><li>  PC2 - 192.168.1.3/24 </li><li>  PC3 - 192.168.1.4/24 </li><li>  PC4 - 192.168.1.5/24 </li><li>  PC5 - 192.168.1.6/24 </li><li>  PC6 - 192.168.1.7/24 </li></ol><br>  We have 3 departments: management, accounting, personnel department.  Each department has its own switchboard and they are connected through the central upper one.  And PC1 sends ping to PC2. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/b67/ea3/4df/b67ea34dfb1c4249b97a440d99906d03.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/740/a5f/3e8/740a5f3e82964489acc209d28f24ee48.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e41/fff/269/e41fff269c364d7bb69c5a7f7b421528.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7fe/012/ff5/7fe012ff59a440ce975c639e73d3dbe9.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/068/502/5a6/0685025a69c04d6f8318d31d7805f354.PNG"></div><br>  Who wants to see it in the form of animation, open the spoiler (ping from PC1 to PC5 is shown there). <br><br><div class="spoiler">  <b class="spoiler_title">Network operation in one broadcast domain</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/347/d5c/51f/347d5c51f5b0460a81edd5584637c9f8.gif"><br><br></div></div><br>  Beautiful yes?  In previous articles, we have already talked more than once about the work of the ARP protocol, but this was last year, so I will briefly explain.  Since PC1 does not know the MAC address (or data link layer address) of PC2, it sends an ARP exploration to let it know.  It comes to the switch, from where it is relayed to all active ports, that is, to PC2 and to the central switch.  From the central switch will fly to neighboring switches, and so on, until it reaches all.  This is not a small traffic caused one ARP-message.  He received all the members of the network.  Large and unnecessary traffic is the first problem.  The second problem is security.  I think we noticed that the message reached even the accounting department, whose computers did not participate in it at all.  Any intruder connecting to any of the switches will have access to the entire network.  In principle, the network before and worked.  The computers were in the same channel environment and were separated only with the help of routers.  But time went and it was necessary to solve this problem on the channel level.  Cisco, as a pioneer, came up with its own protocol, which tagged frames and determined the belonging to a specific channel environment.  It was called <b>ISL (Inter-Switch Link)</b> .  Everyone liked this idea and IEEE decided to develop a similar open standard.  The standard is called <b>802.1q</b> .  He got a huge spread and Cisco decided to go on it too. <br>  And that's how VLAN technology is based on the operation of the 802.1q protocol.  Let's start talking about her. <br><br>  In part <a href="https://habrahabr.ru/post/308636/">3,</a> I showed what an ethernet frame looks like.  Look at it and refresh it.  This is what an untagged frame looks like. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/193/208/8c8/1932088c8c7f437dac56ac8a239e8b1c.png"></div><br><br>  Now take a look at the tagged. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fa8/70d/f0a/fa870df0ad52464aaaf22ca9083c02fc.png"></div><br><br>  As you can see, the difference is that a certain <b>tag</b> appears.  This is what is interesting to us.  Digging deeper.  It consists of 4 parts. <br><br>  1) <b>TPID (Tag Protocol ID) or Tagged Protocol Identifier</b> - consists of 2 bytes and is always 0x8100 for a VLAN. <br>  2) <b>PCP (English Priority Code Point) or priority value</b> - consists of 3 bits.  Used to prioritize traffic.  Steep and bearded system administrators know how to manage them correctly and operate them when there are different traffic on the network (voice, video, data, etc.) <br>  3) <b>CFI (English Canonical Format Indicator) or the canonical format indicator</b> is a simple field consisting of one bit.  If it is 0, then this is the standard MAC address format. <br>  4) <b>VID (English VLAN ID) or VLAN ID</b> - consists of 12 bits and shows which VLAN is in the frame. <br><br>  I want to focus attention on the fact that frame tagging is performed between network devices (switches, routers, etc.), and frames between the end node (computer, laptop) and network device are not tagged.  Therefore, the network device port can be in 2 states: <b>access</b> or <b>trunk</b> . <br><br><ul><li>  <b>Access port or access port</b> - a port located on a specific VLAN and sending untagged frames.  Typically, this is a port looking at a user device. </li><li>  <b>Trunk port or trunk port</b> - a port that transmits tagged traffic.  Typically, this port rises between network devices. </li></ul><br>  Now I will show it in practice.  I open the same lab.  I will not repeat the picture, but I will immediately open the switch and see what it has with the VLAN. <br><br>  I type the <b>show vlan</b> command. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fb5/f9f/646/fb5f9f646c364907900358437dad3d85.PNG"></div><br>  Lined up several tables.  We are essentially only the very first important.  Now I will show you how to read it. <br><br>  <u>1 column</u> is the VLAN number.  Number 1 is originally present here - this is the standard VLAN that is initially on each switch.  It performs another function, about which I will write below.  Reserved from 1002-1005 are also present.  This is for other channel environments that are hardly ever used.  You cannot delete them either. <br><br><pre><code class="hljs pgsql">Switch(config)#<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> vlan <span class="hljs-number"><span class="hljs-number">1005</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span> VLAN <span class="hljs-number"><span class="hljs-number">1005</span></span> may <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> be deleted.</code> </pre> <br>  When deleting, Cisco displays a message that this VLAN cannot be deleted.  Therefore, we live and do not touch these 4 VLANs. <br><br>  <u>Column 2</u> is the VLAN name.  When creating a VLAN, you can, at your discretion, come up with meaningful names for them to identify them later.  There is already default, fddi-default, token-ring-default, fddinet-default, trnet-default. <br><br>  <u>3 column</u> - status.  It shows the state of the VLAN.  At the moment, VLAN 1 or default is in the active state, and 4 of the following act / unsup (although active, but not supported). <br><br>  <u>4 column</u> - ports.  This shows which VLANs the ports belong to.  Now, when we have not touched anything, they are in default. <br><br>  Getting started configuring switches.  A good tone rule will give intelligent switches names.  What we do.  I bring the team. <br><br><pre> <code class="hljs lisp">Switch(<span class="hljs-name"><span class="hljs-name">config</span></span>)#hostname CentrSW CentrSW(<span class="hljs-name"><span class="hljs-name">config</span></span>)#</code> </pre> <br>  The rest are configured similarly, so I will show the updated topology diagram. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4d7/57e/3dc/4d757e3dc2ee4313be7e0a5720ad9328.PNG"></div><br>  Begin setup with switch SW1.  First, create a VLAN on the switch. <br><br><pre> <code class="hljs lua">SW1(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#vlan <span class="hljs-number"><span class="hljs-number">2</span></span> -  VLAN <span class="hljs-number"><span class="hljs-number">2</span></span> (VLAN <span class="hljs-number"><span class="hljs-number">1</span></span>   ,   ). SW1(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-vlan)#name Dir-ya -    VLAN    .</code> </pre> <br>  VLAN is created.  Now go to the ports.  The FastEthernet0 / 1 interface looks at PC1, and FastEthernet0 / 2 looks at PC2.  As mentioned earlier, the frames between them should be transmitted untagged, so we translate them into the Access state. <br><br><pre> <code class="hljs pgsql">SW1(config)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> -    <span class="hljs-number"><span class="hljs-number">1</span></span>- . SW1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> -     <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>. SW1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">2</span></span> -    <span class="hljs-number"><span class="hljs-number">2</span></span>- VLAN. SW1(config)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> -    <span class="hljs-number"><span class="hljs-number">2</span></span>- . SW1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> -     <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>. SW1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">2</span></span> -    <span class="hljs-number"><span class="hljs-number">2</span></span>- VLAN.</code> </pre> <br>  Since both ports are assigned to the same VLAN, they could still be configured as a group. <br><br><pre> <code class="hljs pgsql">SW1(config)#interface range fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> -        . SW1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-range)#switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> SW1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-range)#switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Configure access ports.  Now configure the trunk between SW1 and CentrSW. <br><br><pre> <code class="hljs delphi">SW1(config)#<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -    <span class="hljs-number"><span class="hljs-number">24</span></span>- . SW1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport mode trunk -     trunk. %LINEPROTO-<span class="hljs-number"><span class="hljs-number">5</span></span>-UPDOWN: Line protocol <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Interface</span></span> FastEthernet0/<span class="hljs-number"><span class="hljs-number">24</span></span>, changed state <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> down %LINEPROTO-<span class="hljs-number"><span class="hljs-number">5</span></span>-UPDOWN: Line protocol <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Interface</span></span> FastEthernet0/<span class="hljs-number"><span class="hljs-number">24</span></span>, changed state <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> up</code> </pre> <br>  We immediately see that the port has migrated.  In principle, this is enough for work.  But from a security point of view, only those VLANs that are really needed are allowed for transmission.  Let's get started <br><br><pre> <code class="hljs objectivec">SW1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)<span class="hljs-meta"><span class="hljs-meta">#switchport trunk allowed vlan 2 -    2- VLAN.</span></span></code> </pre> <br>  Without this command, all available VLANs will be transmitted.  Let's see how the table has changed with the <b>show vlan</b> command. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e00/31d/afd/e0031dafd82a4e7a9f843e3b0f47270f.PNG"></div><br>  A second VLAN appeared with the name Dir-ya and we see ports fa0 / 1 and fa0 / 2 that belong to it. <br><br>  To display only the top table, you can use the <b>show vlan brief</b> command. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d26/e71/519/d26e715193eb47e88d9633a3fcd4e7c8.PNG"></div><br>  You can still shorten the output, if you specify a specific VLAN ID. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/de6/47e/308/de647e30895f45bea90fad59ee0337ca.PNG"></div><br>  Or his name. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d05/fc9/2a2/d05fc92a2a514adfbbcadfae9052084c.PNG"></div><br>  All VLAN information is stored in flash memory in the vlan.dat file. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fcb/596/a1e/fcb596a1e0934097a619d1cfe4bb55d8.PNG"></div><br>  As you noticed, in none of the commands, there is no information about the trunk.  It can be viewed by another <b>show interfaces trunk</b> command. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cba/526/f27/cba526f27d03403ca5dae9488637d352.PNG"></div><br>  There is information about both the trunk ports and which VLANs they transmit.  There is also a <b>Native vlan</b> column.  This is exactly the traffic that should not be tagged.  If a non-tagged frame arrives at the switch, it is automatically assigned to Native Vlan (by default, in our case, this is VLAN 1).  Native VLAN is possible, and many say that you need to change for security purposes.  To do this, in the configuration mode of the trunk port, you need to apply the command - <b>switchport trunk native vlan X</b> , where <b>X</b> is the number of the assigned VLAN.  In this topology, we will not change, but knowing how to do it is useful. <br><br>  It remains to configure the rest of the device. <br><br>  <b>CentrSW:</b> <br>  The central switch is the link, which means that it should be aware of all VLANs.  Therefore, we first create them, and then translate all interfaces into trunk mode. <br><br><pre> <code class="hljs lisp">CentrSW(<span class="hljs-name"><span class="hljs-name">config</span></span>)#vlan <span class="hljs-number"><span class="hljs-number">2</span></span> CentrSW(<span class="hljs-name"><span class="hljs-name">config-vlan</span></span>)# name Dir-ya CentrSW(<span class="hljs-name"><span class="hljs-name">config</span></span>)#vlan <span class="hljs-number"><span class="hljs-number">3</span></span> CentrSW(<span class="hljs-name"><span class="hljs-name">config-vlan</span></span>)# name buhgalter CentrSW(<span class="hljs-name"><span class="hljs-name">config</span></span>)#vlan <span class="hljs-number"><span class="hljs-number">4</span></span> CentrSW(<span class="hljs-name"><span class="hljs-name">config-vlan</span></span>)# name otdel-kadrov CentrSW(<span class="hljs-name"><span class="hljs-name">config</span></span>)#interface range fastEthernet <span class="hljs-number"><span class="hljs-number">0/1</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> CentrSW(<span class="hljs-name"><span class="hljs-name">config-if-range</span></span>)#switchport mode trunk</code> </pre> <br>  Do not forget to save the config.  The <b>copy running-config startup-config</b> command <b>.</b> <br><br>  <b>SW2:</b> <br><br><pre> <code class="hljs lisp">SW2(<span class="hljs-name"><span class="hljs-name">config</span></span>)#vlan <span class="hljs-number"><span class="hljs-number">3</span></span> SW2(<span class="hljs-name"><span class="hljs-name">config-vlan</span></span>)#name buhgalter SW2(<span class="hljs-name"><span class="hljs-name">config</span></span>)#interface range fastEthernet <span class="hljs-number"><span class="hljs-number">0/1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> SW2(<span class="hljs-name"><span class="hljs-name">config-if-range</span></span>)#switchport mode access SW2(<span class="hljs-name"><span class="hljs-name">config-if-range</span></span>)#switchport access vlan <span class="hljs-number"><span class="hljs-number">3</span></span> SW2(<span class="hljs-name"><span class="hljs-name">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0/24</span></span> SW2(<span class="hljs-name"><span class="hljs-name">config-if</span></span>)#switchport mode trunk SW2(<span class="hljs-name"><span class="hljs-name">config-if</span></span>)#switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br>  <b>SW3:</b> <br><br><pre> <code class="hljs lisp">SW3(<span class="hljs-name"><span class="hljs-name">config</span></span>)#vlan <span class="hljs-number"><span class="hljs-number">4</span></span> SW3(<span class="hljs-name"><span class="hljs-name">config-vlan</span></span>)#name otdel kadrov SW3(<span class="hljs-name"><span class="hljs-name">config</span></span>)#interface range fastEthernet <span class="hljs-number"><span class="hljs-number">0/1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> SW3(<span class="hljs-name"><span class="hljs-name">config-if-range</span></span>)#switchport mode access SW3(<span class="hljs-name"><span class="hljs-name">config-if-range</span></span>)#switchport access vlan <span class="hljs-number"><span class="hljs-number">4</span></span> SW3(<span class="hljs-name"><span class="hljs-name">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0/24</span></span> SW3(<span class="hljs-name"><span class="hljs-name">config-if</span></span>)#switchport mode trunk SW3(<span class="hljs-name"><span class="hljs-name">config-if</span></span>)#switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br>  Notice that we raised and configured the VLAN, but the addressing of the nodes was left the same.  That is, virtually all nodes in the same subnet, but separated by VLAN-s.  So you can not do.  Each VLAN should be allocated a separate subnet.  I did this solely for educational purposes.  If each department were sitting on its own subnet, then they would have been limited a priori, since the switch does not know how to route traffic from one subnet to another (plus this is already a restriction at the network level).  And we need to limit the departments at the link level. <br>  Ping from PC1 to PC3 again. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2d7/be5/ab9/2d7be5ab91d7487c8301b14fb8d812a0.PNG"></div><br><br>  It goes into the course of ARP, which we need now.  Open it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/686/282/fac/686282fac76543b1a18f0e678fb647b7.PNG"></div><br><br>  So far, nothing new.  ARP is encapsulated in ethernet. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/119/330/94c/11933094cb4d4670964a05390e988045.PNG"></div><br><br>  The frame arrives at the switch and is tagged.  Now there is not a normal ethernet, but 802.1q.  Added fields, about which I wrote earlier.  This is a <b>TPID</b> that is 8100 and indicates that this is 802.1q.  And <b>TCI</b> , which combines 3 <b>PCP, CFI and VID</b> fields.  The number in this field is the VLAN number.  Moving on. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c00/be3/91b/c00be391b35f4a9195aa4f7b413baa7a.PNG"></div><br>  After the tag, it sends a frame to PC2 (since it is in the same VLAN) and to the central switch via the trunk port. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/135/3c6/83c/1353c683c33743b0817f365cc689096b.PNG"></div><br>  Since it was not strictly prescribed which types of VLANs to pass on which ports, it will send to both switches.  And here the switches, having seen the VLAN number, understand that they do not have devices with such a VLAN, and boldly discard it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ee7/8f9/4ca/ee78f94cae834814aa9e9624072598f3.PNG"></div><br>  PC1 is waiting for a response that never comes.  You can look under the spoiler in the form of animation. <br><br><div class="spoiler">  <b class="spoiler_title">Animation</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/726/f56/fa1/726f56fa1b714320a963becdece85c44.gif"><br><br></div></div><br>  Now the following situation.  The directorate hires another person, but there is no room in the directorate‚Äôs office and they are temporarily asked to place a person in the accounting department.  We solve this problem. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/60f/ef0/150/60fef015073344b0a21f785c2d470fb5.PNG"></div><br>  We connected a computer to the FastEthernet 0/3 port of the switch and assigned the IP address 192.168.1.8/24. <br>  Now I will configure the <b>SW2</b> switch.  Since the computer must be in the 2nd VLAN, which the switch does not know about, we will create it on the switch. <br><br><pre> <code class="hljs lisp">SW2(<span class="hljs-name"><span class="hljs-name">config</span></span>)#vlan <span class="hljs-number"><span class="hljs-number">2</span></span> SW2(<span class="hljs-name"><span class="hljs-name">config-vlan</span></span>)#name Dir-ya</code> </pre> <br>  Next, configure the FastEthernet 0/3 port, which looks at PC7. <br><br><pre> <code class="hljs lisp">SW2(<span class="hljs-name"><span class="hljs-name">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0/3</span></span> SW2(<span class="hljs-name"><span class="hljs-name">config-if</span></span>)#switchport mode access SW2(<span class="hljs-name"><span class="hljs-name">config-if</span></span>)#switchport access vlan <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  And the last - to configure the trunk port. <br><br><pre> <code class="hljs lua">SW2(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> SW2(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport trunk allowed vlan add <span class="hljs-number"><span class="hljs-number">2</span></span> -     .      <span class="hljs-string"><span class="hljs-string">"add"</span></span>.     ,         VLAN   .              VLAN,     .</code> </pre> <br>  So that the frames go beautifully, I will correct the central switch <b>CentrSW.</b> <br><br><pre> <code class="hljs lua">CentrSW(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> CentrSW(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">2</span></span> CentrSW(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> CentrSW(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span> CentrSW(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span> CentrSW(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br>  Checkout time.  Ping from PC1 to PC7. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/19d/1ba/b5e/19d1bab5ed7842e699f4de9449f7643e.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3ef/f26/0d6/3eff260d679545d7b04ed793d05d02b4.PNG"></div><br>  So far, the whole journey is similar to the previous one.  But from now on (from the image below), the central switch will make another decision.  It receives a frame and sees that it is patched by the 2nd VLAN.  So you need to send it only where it is allowed, that is, to port fa0 / 2. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/1b3/50d/8d5/1b350d8d54714ccbae7f8114094e2c7a.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/522/bf8/c78/522bf8c784684180b3871df255c8f162.PNG"></div><br><br>  And here he comes to SW2.  We open and see that it is still tagged.  But the next node is a computer and the tag must be removed.  Click on "Outbound PDU Details" to see how the frame will fly out of the switch. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b5f/5c8/f12/b5f5c8f126ee4208b7f9f24d909c1003.PNG"></div><br>  And really.  The switch will send the frame in a ‚Äúpure‚Äù form, that is, without tags. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/208/f48/7e3/208f487e3ff548f3a9f4e60b2e556607.PNG"></div><br>  ARP reaches PC7.  Open it and make sure that the frame is not tagged PC7 recognized himself and sends the answer. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1b1/82f/e46/1b182fe469e64cc2b91e273d10ecc24e.PNG"></div><br>  We open the frame on the switch and see that it will go tagged to send.  The next frame will travel the same way that it came. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e6f/6c1/1d1/e6f6c11d1fb343f8b0f5e15f0c836b08.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f75/a60/a47/f75a60a47f08448899240643f3fa6ee5.PNG"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ec2/063/8a7/ec20638a766a490f915ff748184c88d9.PNG"></div><br>  ARP comes to PC1, as indicated by a check mark on the envelope.  Now he knows the MAC address and he launches ICMP. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b60/199/c18/b60199c180f14f0aaecf447fa5eb0051.PNG"></div><br>  Open the package on the switch and see the same picture.  At the data link layer, the frame is tagged by the switch.  So it will be with every message. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/63d/b7f/b46/63db7fb465184409a0e6253c14bcafb3.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/230/4be/8c9/2304be8c960f42a28d764a7e60c82559.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f1f/66e/d35/f1f66ed3557f41eb8aaf13c28dd8d0cf.PNG"></div><br>  We see that the package successfully reaches PC7.  I will not show the way back, since it is similar.  If anyone is interested, you can see all the way on the animation under the spoiler below.  And if you want to pick this topology yourself, I attach a <a href="https://drive.google.com/open%3Fid%3D0BzKZChrEeV7zbDlpalo1Q25uOWs">link</a> to the lab. <br><br><div class="spoiler">  <b class="spoiler_title">VLAN operation logic</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a67/6c7/31f/a676c731fe0948e2a6766a67caffe923.gif"><br></div></div><br>  That's basically the most popular use of VLANs.  Regardless of physical location, you can logically combine nodes into groups, thereby isolating them from others.  It is very convenient when employees physically work in different places, but must be combined.  And of course, from the point of view of security, VLANs are not interchangeable.  The main thing is that a limited circle of people have access to network devices, but this is a separate topic. <br>  Have achieved restrictions at the link level.  Traffic no longer walks anywhere, but goes strictly according to its intended purpose.  But now the question arises that the departments need to communicate with each other.  And since they are in different channel environments, routing comes into play.  But before we start, we will put the topology in order.  The very first thing to which we add a hand is the addressing of nodes.  I repeat that each department must be on its own subnet.  Total we get: <br><br><ul><li>  Directorate - 192.168.1.0/24 </li><li>  Accounting - 192.168.2.0/24 </li><li>  Human Resources Department - 192.168.3.0/24 </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/files/381/6aa/9c5/3816aa9c52ea4302bba838e52285f457.PNG"></div><br>  Once the subnets are defined, we immediately address the nodes. <br><br><ol><li>  <b>PC1:</b> <br>  IP: 192.168.1.2 <br>  Mask: 255.255.255.0 or / 24 <br>  Gateway: 192.168.1.1 </li><li>  <b>PC2:</b> <br>  IP: 192.168.1.3 <br>  Mask: 255.255.255.0 or / 24 <br>  Gateway: 192.168.1.1 </li><li>  <b>PC3:</b> <br>  IP: 192.168.2.2 <br>  Mask: 255.255.255.0 or / 24 <br>  Gateway: 192.168.2.1 </li><li>  <b>PC4:</b> <br>  IP: 192.168.2.3 <br>  Mask: 255.255.255.0 or / 24 <br>  Gateway: 192.168.2.1 </li><li>  <b>PC5:</b> <br>  IP: 192.168.3.2 <br>  Mask: 255.255.255.0 or / 24 <br>  Gateway: 192.168.3.1 </li><li>  <b>PC6:</b> <br>  IP: 192.168.3.3 <br>  Mask: 255.255.255.0 or / 24 <br>  Gateway: 192.168.3.1 </li><li>  <b>PC7:</b> <br>  IP: 192.168.1.4 <br>  Mask: 255.255.255.0 or / 24 <br>  Gateway: 192.168.1.1 </li></ol><br>  Now about the changes in the topology.  We see that the router has been added.  It will just transfer traffic from one VLAN to another (in other words, route).  Initially, there is no connection between it and the switch, since the interfaces are turned off. <br>  At nodes such parameter as the gateway address was added.  They use this address when they need to send a message to a node located on another subnet.  Accordingly, each subnet has its own gateway. <br><br>  It remains to configure the router, and I open its CLI.  By tradition, I will give a meaningful name. <br><br><pre> <code class="hljs lisp">Router(<span class="hljs-name"><span class="hljs-name">config</span></span>)#hostname Gateway Gateway(<span class="hljs-name"><span class="hljs-name">config</span></span>)#</code> </pre> <br>  Next, go to the interface settings. <br><br><pre> <code class="hljs delphi">Gateway(config)#<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> -    . Gateway(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#no shutdown -  . %LINK-<span class="hljs-number"><span class="hljs-number">5</span></span>-CHANGED: <span class="hljs-keyword"><span class="hljs-keyword">Interface</span></span> FastEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span>, changed state <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> up %LINEPROTO-<span class="hljs-number"><span class="hljs-number">5</span></span>-UPDOWN: Line protocol <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Interface</span></span> FastEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span>, changed state <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> up</code> </pre> <br>  Now attention!  We enabled the interface, but did not hang an IP address on it.  The fact is that from the physical interface (fastethernet 0/0) you only need a link or channel.  The role of the gateways will be performed by virtual interfaces or subinterfaces.  Currently there are 3 types of VLAN.  Hence, the subinterfaces will be 3. We proceed to configure. <br><br><pre> <code class="hljs lua">Gateway(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.2</span></span> Gateway(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#encapsulation dot1Q <span class="hljs-number"><span class="hljs-number">2</span></span> Gateway(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#ip address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Gateway(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.3</span></span> Gateway(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#encapsulation dot1Q <span class="hljs-number"><span class="hljs-number">3</span></span> Gateway(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#ip address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Gateway(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.4</span></span> Gateway(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#encapsulation dot1Q <span class="hljs-number"><span class="hljs-number">4</span></span> Gateway(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#ip address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre> <br>  The router is configured.  Go to the central switch and configure the trunk port on it so that it passes tagged frames to the router. <br><br><pre> <code class="hljs lua">CentrSW(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> CentrSW(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport mode trunk CentrSW(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br>  The configuration is complete and proceed to practice.  I send ping from PC1 to PC6 (that is, to 192.168.3.3). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/496/fe9/4a1/496fe94a133e48d1827f114c300ac6cc.PNG"></div><br>  PC1 has no idea who PC6 is or 192.168.3.3, but knows that they are on different subnets (as he understands described in the <a href="https://habrahabr.ru/post/308636/">previous</a> article).  Therefore, he will send a message through the main gateway whose address is specified in its settings.  And although PC1 knows the IP address of the main gateway, there is not enough MAC address for complete happiness.  And he launches ARP. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c16/062/6fd/c160626fdfb24fa3a1d6dacb170acd65.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3c9/dcb/078/3c9dcb078660477db8159fbf8b49edc2.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ca3/378/596/ca3378596da94c3aa191337897c7dabc.PNG"></div><br>  Note.  As soon as the frame arrives at CentrSW, the switch does not send it to anyone.  It sends only to those ports where 2nd VLAN skipping is allowed.  That is, on the router and on SW2 (there is a user sitting in the 2nd VLAN). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/342/180/289/3421802895a04fe9863cc5c90b16d50a.PNG"></div><br>  The router recognizes itself and sends a response (indicated by the arrow).  And look at the bottom frame.  When SW2 received ARP from the central switch, it likewise did not send it to all computers, but sent only PC7, which sits in the 2nd VLAN.  But PC7 discards it, as it is not for it.  We look further. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fa4/91e/302/fa491e302d0341cbb676ff9667a5d776.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/54e/2d6/613/54e2d6613f1b4eec80114b69409f1c06.PNG"></div><br>  ARP reached PC1.  Now he knows everything and can send ICMP.  Once again I will pay attention to the fact that as the destination MAC address (link layer), there will be the address of the router, and as the destination IP address (network level), the address is PC6. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/aec/8f7/51c/aec8f751cb5948b09f2154be9ecdca7d.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/617/699/226/617699226d744e22a40bddda0db93d67.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/394/adb/86d/394adb86d359440d9f09448121d4becf.PNG"></div><br>  ICMP reaches the router.  He looks into his table and realizes that he does not know anyone under the address 192.168.3.3.  ICMP arrives discarding and starts scouting ARP. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7dd/b45/2c4/7ddb452c419246ba85a6b1d66b98cb80.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/194/c75/4d5/194c754d5cf94ca3aa0e66cddee17c0d.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1c8/ca7/552/1c8ca7552ba7405d8be85a9913d8d7f3.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a76/dad/905/a76dad905a09484098f4f698a103d316.PNG"></div><br>  PC6 recognizes itself and sends the answer. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b50/2ec/1a8/b502ec1a8cc3430192c67abbae173601.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e41/e10/af8/e41e10af81154aac83e9bd6b4aa31e1d.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a52/75a/2ff/a5275a2ff6c14dde93df57bcc1e3d8b1.PNG"></div><br>  The answer reaches the router and it adds an entry in its table.  You can view the ARP table with the <b>show arp</b> command. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c86/668/211/c86668211f854dc69f3eabf85c1b9e5b.PNG"></div><br>  Moving on.  PC1 is unhappy that no one answers it and sends the next ICMP message. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7f3/115/f31/7f3115f3172a41d2a315eafc58df6579.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/82c/5d5/d91/82c5d5d9107b4e369a2198b7be953ce9.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a48/3b7/e30/a483b7e304bb41ba801fb6d94a5f742f.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0e8/e82/4d1/0e8e824d1ff34e6cb590a85db45fd365.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c21/405/187/c2140518785d4b0e823ae85e6b5b123a.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/04d/92a/46b/04d92a46ba8a409789488c454547d4f2.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/6b2/f72/7a1/6b2f727a17994356af3d7c9f670cbbe7.PNG"></div><br>  This time ICMP comes without problems.  Back he will follow the same route.  I will only show the end result. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/807/2e7/f78/8072e7f7885441e4a4308aec02069177.PNG"></div><br>  The first packet was lost (as a result of ARP), and the second one came without problems. <br>  Who is interesting to see in the animation, welcome under the spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">InterVLAN Routing</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/8da/661/e15/8da661e15ca54b7b9ef2fbf6c48bf321.gif"><br></div></div><br>  So.  We have ensured that if the nodes are on the same subnet and one VLAN, then they will go directly through the switches.  In the case when it is necessary to transfer a message to another subnet and VLAN, then they will transmit via the Gateway router, which performs the ‚Äúinterwave‚Äù routing.  This topology is called <b>"router on a stick"</b> or <b>"router on a stick"</b> .  As you understand it is very convenient.  We created 3 virtual interfaces and drove different tagged frames on one wire.  Without using subinterfaces and VLANs, we would have to use a separate physical interface for each subnet, which is not at all profitable. <br><br>  By the way, this question is very well analyzed in this <a href="https://youtu.be/NriV67DU6eg%3Ft%3D684">video</a> (the video is about 3 hours, so the link is linked to exactly that point in time).  If after reading and watching the video I want to finish everything with my own hands, I attach a <a href="https://drive.google.com/open%3Fid%3D0BzKZChrEeV7zSTJvRzl1NGxid00">link</a> to download. <br><br>  We dealt with VLANs and proceed to one of the protocols working with it. <br>  <b>DTP (English Dynamic Trunking Protocol)</b> or in Russian <b>Dynamic Trunking Protocol</b> is a proprietary protocol of Cisco, which serves to implement the trunk mode between switches.  Although depending on the state, they may be consistent in access mode. <br><br>  There are 4 modes in DTP: Dynamic auto, Dynamic desirable, Trunk, Access.  Consider how they agree. <br><table><tbody><tr><th>  <b>Modes</b> </th><th>  <b>Dynamic auto</b> </th><th>  <b>Dynamic desirable</b> </th><th>  <b>Trunk</b> </th><th>  <b>Access</b> </th></tr><tr><td>  <b>Dynamic auto</b> </td><td>  Access </td><td>  Trunk </td><td>  Trunk </td><td>  Access </td></tr><tr><td>  <b>Dynamic desirable</b> </td><td>  Trunk </td><td>  Trunk </td><td>  Trunk </td><td>  Access </td></tr><tr><td>  <b>Trunk</b> </td><td>  Trunk </td><td>  Trunk </td><td>  Trunk </td><td>  No connection </td></tr><tr><td>  <b>Access</b> </td><td>  Access </td><td>  Access </td><td>  No connection </td><td>  Access </td></tr></tbody></table><br><br>  That is, the left column is the 1st device, and the top line is the 2nd device.  By default, switches are in dynamic auto mode.  If you look at the mapping table, the two switches in the ‚Äúdynamic auto‚Äù mode are matched to the ‚Äúaccess‚Äù mode.  Let's check it out.  I create a new lab and add 2 switches. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9bc/6de/48c/9bc6de48c02241f2abd311d463bd7cbf.PNG"></div><br>  Connect them until I will.  I need to make sure that both switches are in dynamic auto mode.  I will check with the <b>show interfaces switchport</b> command. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/793/65b/60f/79365b60ff554d0ba087ba9baca65c81.PNG"></div><div style="text-align:center;"><img src="https://habrastorage.org/files/125/110/858/12511085841846a081da98898a1607f5.PNG"></div><br>  The result of this command is very large, so I cut it off and selected points of interest.  Let's start with <b>Administrative Mode</b> .  This line shows in which of the 4 modes this port is working on the switch.  Make sure that ports on both switches are in Dynamic auto mode.  And the line <b>Operational Mode</b> shows in which mode of operation they have coordinated the work.  We have not connected them yet, so they are in the "down" state. <br><br>  Immediately give you good advice.  When testing any protocol, use filters.  Turn off the display of all unnecessary protocols. <br><br>  I put CPT in simulation mode and filter out all protocols except DTP. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5f1/5ae/195/5f15ae195554409ca83c1c55154ca500.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a56/25c/470/a5625c47099c4a72ad75db6d6a07ae77.PNG"></div><br>  I think everything is clear here.  I connect switches with cable and, when raising links, one of the switches generates a DTP message. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/40f/b85/2c7/40fb852c7d894b99a51254d7d63ab89e.PNG"></div><br>  I open it and see that it is a DTP encapsulated in an Ethernet frame.  He sends it to the multicast address "0100.0ccc.c.cccc", which relates to the DTP, VTP, CDP protocols. <br>  And pay attention to the 2 fields in the DTP header. <br><br>  1) <b>DTP Type</b> - here the sending inserts an offer.  That is, in what mode he wants to agree.  In our case, he suggests matching ‚Äúaccess‚Äù. <br>  2) <b>Neighbor MAC-address</b> - in this field, it writes the MAC address of its port. <br><br>  He sends and waits for a reaction from a neighbor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/734/fd3/c56/734fd3c56b314450b3473ff6824424cd.PNG"></div><br>  It reaches the SW1 message and it generates a reply.  Where also the ‚Äúaccess‚Äù mode is negotiated, inserts its MAC address and sends it to SW2. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4f7/8de/2e7/4f78de2e71574385a3660d83b05b5b59.PNG"></div><br>  Successfully reaches DTP.  In theory, they should have been coordinated in the ‚Äúaccess‚Äù mode.  I'll check. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fe1/9df/874/fe19df8742bb44cd95d4195d15a957ce.PNG"></div><div style="text-align:center;"><img src="https://habrastorage.org/files/6f0/569/886/6f05698861df40bdb94f33a745451f44.PNG"></div><br>  As expected, they agreed to the ‚Äúaccess‚Äù mode. <br>  Someone says that the technology is convenient and uses it.  But I highly recommend not using this protocol in my network.  I recommend this not only me, and now I will explain why.  The point is that this protocol opens a big security hole.  I will open the lab in which the work ‚ÄúRouter on a stick‚Äù was sorted out and add one more switch there. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/beb/6ca/ecc/beb6caeccefb49249d9034f64eba4ec7.PNG"></div><br>  Now I‚Äôll go into the settings of the new switch and strictly register the work in the trunk mode on the port. <br><br><pre> <code class="hljs lisp">New_SW(<span class="hljs-name"><span class="hljs-name">config</span></span>)#interface fastEthernet <span class="hljs-number"><span class="hljs-number">0/1</span></span> New_SW(<span class="hljs-name"><span class="hljs-name">config-if</span></span>)#switchport mode trunk</code> </pre> <br>  Connect them and see how they agreed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5fe/db1/7b9/5fedb17b9338401c8c67aa8a42d59c2e.PNG"></div><div style="text-align:center;"><img src="https://habrastorage.org/files/4ed/59d/212/4ed59d2120504b7da3162be55ff2df64.PNG"></div><br>  That's right.  The ‚Äúdynamic auto‚Äù and ‚Äútrunk‚Äù modes are matched to <b>trunk</b> mode.  Now we are waiting for someone to start being active.  Suppose PC1 decided to send someone a message.  Generates ARP and releases to the network. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1e5/43f/6eb/1e543f6eb0d348fc80b914a2de93de60.PNG"></div><br>  Let's skip his way to the moment when he gets on SW2. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c9f/585/a64/c9f585a64c8348bb9b81759a50c06516.PNG"></div><br>  And the most interesting. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/82f/41e/737/82f41e737e134aeabdaf3bd40bb2518c.PNG"></div><br>  He sends it to the newly connected switch.  I explain what happened.  As soon as we agreed with him on the trunk, he starts sending him all the incoming frames.  Although the diagram shows that the switch discards frames, it does not mean anything.  You can connect any sniffer device to the switch or instead of the switch and calmly watch what is happening in the network.  It seems he intercepted a harmless ARP.  But if you take a deeper look, you can see that the MAC address ‚Äú0000.0C1C.05DD‚Äù and the IP address ‚Äú192.168.1.2‚Äù are already known.  That is, PC1, without thinking, betrayed himself.  Now the attacker knows about such a computer.  In addition, he knows that he is sitting in the 2nd VLAN.  Then he can mess things up.  The most trivial thing is to change your MAC address, IP address, agree quickly in Access, and impersonate PC1.  But the most interesting.  After all, you can not immediately understand.  Usually, when we register the port operation mode, it is immediately displayed in the configuration.  I enter <b>show running-config</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/388/b8d/bc9/388b8dbc9f134d3985978145cb525e5c.PNG"></div><br>  But here the port settings are empty.  I enter <b>show interfaces switchport</b> and scroll to fa0 / 4. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/200/966/3d8/2009663d8a86432298eeca384b7081b3.PNG"></div><br>  And here we see that the trunk is agreed.  Not always show running-config gives comprehensive information.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, remember and other teams. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think it is clear why you can not trust this protocol. He seems to make life easier, but at the same time can create a huge problem. So rely on the manual method. When setting up, immediately identify yourself which ports will work in trunk mode, and which ones in access. And most importantly - always disable the negotiation. So that the switches do not try to agree with anyone. This is done with the command ‚Äúswitchport nonegotiate‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moving on to the next protocol. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VTP (English VLAN Trunking Protocol)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a proprietary protocol from Cisco, which is used to exchange information about VLANs.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imagine the situation that you have 40 switches and 70 VLANs. </font><font style="vertical-align: inherit;">For good, you need to manually create them on each switch and register on which trunk ports to allow transfer. </font><font style="vertical-align: inherit;">The case is dreary and long. </font><font style="vertical-align: inherit;">Therefore, the VTP can take on this task. </font><font style="vertical-align: inherit;">You create a VLAN on one switch, and all the others are synchronized with its base. </font><font style="vertical-align: inherit;">Take a look at the following topology.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/551/f8e/9a7/551f8e9a7f774195b9f4fe1c858692ee.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are 4 switches here. </font><font style="vertical-align: inherit;">One of them is a VTP server, and the other 3 are clients. </font><font style="vertical-align: inherit;">Those VLANs that will be created on the server are automatically synchronized on the clients. </font><font style="vertical-align: inherit;">I will explain how VTP works and what it can do.</font></font><br><br>  So.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VTP can create, modify and delete VLANs. </font><font style="vertical-align: inherit;">Each such action leads to the fact that the revision number increases (each action increases the number by +1). </font><font style="vertical-align: inherit;">After he sends the ads, where the number of the revision. </font><font style="vertical-align: inherit;">Clients who receive this announcement compare their revision number with the number that came. </font><font style="vertical-align: inherit;">And if the incoming number is higher, they synchronize their base with it. </font><font style="vertical-align: inherit;">Otherwise, the ad is ignored.</font></font><br><br>  But that is not all.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VTP has roles. </font><font style="vertical-align: inherit;">By default, all switches work as a server. </font><font style="vertical-align: inherit;">I'll tell you about them.</font></font><br><br><ol><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VTP Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Able all. </font><font style="vertical-align: inherit;">That is, creates, modifies, deletes VLANs. </font><font style="vertical-align: inherit;">If it receives an ad in which the revision is older than it, then it is synchronized. </font><font style="vertical-align: inherit;">Constantly sends announcements and relays from neighbors.</font></font></li><li> <b>VTP Client</b> ‚Äî    . ,    VLAN .  VLAN     .       VLAN-. </li><li> <b>VTP Transparent</b> ‚Äî    .  ,    VLAN    .          .     ,  ,      .    ,      ,         0. </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is all about VTP version 2. Another role has been added to VTP 3rd version - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VTP Off</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It does not transmit any ads. </font><font style="vertical-align: inherit;">The rest of the work is similar to the mode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transparent</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We read the theory and proceed to practice. </font><font style="vertical-align: inherit;">Verify that the central switch is in Server mode. </font><font style="vertical-align: inherit;">Enter the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">show vtp status command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4b2/81e/50b/4b281e50b8d041f48a06c865b249359c.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We see that the VTP Operating Mode: Server. </font><font style="vertical-align: inherit;">You may also notice that the VTP version is 2nd. </font><font style="vertical-align: inherit;">Unfortunately, 3rd version is not supported in CPT. </font><font style="vertical-align: inherit;">Revision version zero. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now configure the lower switches.</font></font><br><br><pre> <code class="hljs dos">SW1(config)#vtp <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> client Setting device to VTP CLIENT <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span>.</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We see a message that the device has switched to client mode. </font><font style="vertical-align: inherit;">The rest is configured exactly the same. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For devices to be able to exchange ads, they must be in the same domain. </font><font style="vertical-align: inherit;">And there is a feature. </font><font style="vertical-align: inherit;">If the device (in Server or Client mode) does not belong to any domain, then upon the first advertisement received, it will switch to the declared domain. </font><font style="vertical-align: inherit;">If the client is in some domain, then there will be no ads from other domains. </font><font style="vertical-align: inherit;">Open SW1 and make sure that it is not in any domain.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/06d/2eb/b52/06d2ebb5246e4ccdb79767f064bef2fa.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make sure it's empty. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now go to the central switch and translate it into a domain.</font></font><br><br><pre> <code class="hljs pgsql">CentrSW(config)#vtp <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> cisadmin.ru Changing VTP <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> cisadmin.ru</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We see the message that it was transferred to the cisadmin.ru domain. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check the status.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2cf/8cc/a6b/2cf8cca6bf40468a814a848e783b5d92.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And really. </font><font style="vertical-align: inherit;">The domain name has changed. </font><font style="vertical-align: inherit;">Please note that the revision number is still zero. </font><font style="vertical-align: inherit;">It will change as soon as we create a VLAN on it. </font><font style="vertical-align: inherit;">But before creating, you need to put the simulator into simulation mode in order to see how it will generate ads. </font><font style="vertical-align: inherit;">We create the 20th VLAN and see the following image.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/782/751/550/7827515508404340b65962c71de7719b.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As soon as the VLAN is created and the revision number has increased, the server generates announcements. </font><font style="vertical-align: inherit;">He has two of them. </font><font style="vertical-align: inherit;">First, open the one to the left. </font><font style="vertical-align: inherit;">This announcement is called ‚ÄúSummary Advertisement‚Äù or in Russian ‚Äúconsolidated announcement‚Äù. </font><font style="vertical-align: inherit;">This ad is generated by the switch every 5 minutes, where it talks about the domain name and the current revision. </font><font style="vertical-align: inherit;">See how it looks.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e64/fe5/90b/e64fe590b7254409a13190968b3c8ebc.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the Ethernet frame, note the Destination MAC address. </font><font style="vertical-align: inherit;">It is the same as above when DTP was generated. </font><font style="vertical-align: inherit;">That is, in our case, only those who are running VTP will respond to it. </font><font style="vertical-align: inherit;">Now look at the next field.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ed0/e05/84c/ed0e0584ca5841abab934908ae0a9e32.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is all the information. </font><font style="vertical-align: inherit;">Walk through the most important fields.</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Management Domain Name - the name of the domain itself (in this case, cisadmin.ru). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Updater Identity - identifier of the person who updates. </font><font style="vertical-align: inherit;">Here, as a rule, the IP address is recorded. </font><font style="vertical-align: inherit;">But since the address was not assigned to the switch, the field is empty</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update Timestamp - update time. </font><font style="vertical-align: inherit;">Time on the switch has not changed, so there is a factory.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5 Digest - MD5 hash. </font><font style="vertical-align: inherit;">It is used to verify credentials. </font><font style="vertical-align: inherit;">That is, if the password is on the VTP. </font><font style="vertical-align: inherit;">We did not change the password, so the default hash.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now look at the next generated message (the one on the right). </font><font style="vertical-align: inherit;">It is called a ‚ÄúSubset Advertisement‚Äù or ‚ÄúDetailed Ad.‚Äù </font><font style="vertical-align: inherit;">This is such detailed information about each VLAN transmitted.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a57/3a6/1e8/a573a61e88834128930c656a18140f04.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think it‚Äôs understandable here. </font><font style="vertical-align: inherit;">Separate header for each VLAN type. </font><font style="vertical-align: inherit;">The list is so long that it does not fit on the screen. </font><font style="vertical-align: inherit;">But they are exactly the same, except for the names. </font><font style="vertical-align: inherit;">I will not bother with my head, which means every code. </font><font style="vertical-align: inherit;">Yes, and in the CPT, they are more convention here. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We look what happens next.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3e7/238/321/3e723832175f4ab380f0ad261e37d2df.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receive clients ads. </font><font style="vertical-align: inherit;">They see that the revision number is higher than theirs and synchronize the base. </font><font style="vertical-align: inherit;">And they send a message to the server that the base of VLANs has changed.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a5e/216/10f/a5e21610fa234add87743f73af32a5bc.PNG"></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How VTP works</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/files/07e/4a4/523/07e4a452374e4fc78a31e08d1d61a9b3.gif"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is how VTP works. </font><font style="vertical-align: inherit;">But he has very big minuses. </font><font style="vertical-align: inherit;">And these cons in terms of security. </font><font style="vertical-align: inherit;">I will explain on the example of the same lab. </font><font style="vertical-align: inherit;">We have a central switch, on which VLANs are created, and then, via a multicast, it synchronizes them with all the switches. </font><font style="vertical-align: inherit;">In our case, he talks about VLAN 20. I suggest once again to look at its configuration.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3ac/2e4/426/3ac2e442634642edb51c4816cbc7f006.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And here we are adding a new switch to the network. </font><font style="vertical-align: inherit;">It does not have new VLANs other than the standard ones and it does not belong to any VTP domain, but the revision number is tied up.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/eaf/a69/fed/eafa69fed7eb4f2a8d5dc1dab8787a1f.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And before plugging it into the network, we transfer the port to trunk mode. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2be/085/4cd/2be0854cd6ed446bb87acd3f00e0b84a.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now I switch CPT to ‚ÄúSimulation Mode‚Äù and filter everything except VTP. </font><font style="vertical-align: inherit;">Connect and watch what happens.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c9e/89b/b36/c9e89bb36627460483d4dde44b769f60.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f5d/4d1/86f/f5d4d186fcab4ff99dfedff8c36d2ed8.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After some time, a VTP message comes to NewSW, from where it finds out that the network has a VTP domain "cisadmin.ru". </font><font style="vertical-align: inherit;">Since he was not previously in another domain, he automatically enters it.</font></font> Check it out. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/181/d38/520/181d3852075447c6811a0ac090b048d8.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now it is in the same domain, but with the revision number above. </font><font style="vertical-align: inherit;">He forms a VTP message where he talks about it.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2e7/b86/a03/2e7b86a03f8b49d7b197c4c2626e417a.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SW1 will fall under the distribution first. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ba8/3af/41a/ba83af41a97b4288bf5181b1fa80c8c7.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that 2 VTP messages arrive at once from SW1 (from NewSW and from CentrSW). </font><font style="vertical-align: inherit;">In a message from NewSW, he sees that the revision number is higher than his and synchronizes his base. </font><font style="vertical-align: inherit;">But the message from CentrSW is already outdated for him, and he discards it. </font><font style="vertical-align: inherit;">Check what has changed on SW1.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d1f/ce2/763/d1fce276399f498596d4b518d1ec6011.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The revision number has been updated and, most interestingly, the VLAN database. </font><font style="vertical-align: inherit;">Now it is empty.</font></font> We look further. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3c1/bab/7fc/3c1bab7fcc7c4fbeb1991534826215ee.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a6a/21b/654/a6a21b654432482088288b2e46e847c3.PNG"></div><br>  Note.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The server receives a VTP message, where the revision number is higher than that of it. </font><font style="vertical-align: inherit;">He understands that the network has changed and it is necessary to adapt to it. </font><font style="vertical-align: inherit;">Check the configuration.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/11d/4ce/96c/11d4ce96c3d143da9b95ddbd0a408189.PNG"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The configuration of the central server has changed and now it will broadcast it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now imagine that we have not one VLAN, but hundreds. </font><font style="vertical-align: inherit;">In such a simple way you can put the network. </font><font style="vertical-align: inherit;">Of course, the domain can be password protected and the attacker will be harder to cause harm. </font><font style="vertical-align: inherit;">And imagine the situation that your switch broke and you urgently need to replace it. </font><font style="vertical-align: inherit;">You or your colleague run to the warehouse behind the old switchboard and forget to check the revision number. </font><font style="vertical-align: inherit;">It is higher than the rest. </font><font style="vertical-align: inherit;">What happens next, you have already seen. </font><font style="vertical-align: inherit;">Therefore, I recommend not using this protocol. </font><font style="vertical-align: inherit;">Especially in large corporate networks. </font><font style="vertical-align: inherit;">If you are using 3rd party VTP, feel free to switch the switches to ‚ÄúOff‚Äù mode. </font><font style="vertical-align: inherit;">If the 2nd version is used, then transfer to the ‚ÄúTransparent‚Äù mode.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Who is interested to see it in the form of animation, open the spoiler. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connecting a switch with a higher revision</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/files/c70/1b3/dc0/c701b3dc0def4ada90f99fabc6cd34ed.gif"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For those who want to work with this lab, I attach a </font></font><a href="https://drive.google.com/open%3Fid%3D0BzKZChrEeV7zdXRkbG1yNkFfdnc"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, the article about the VLAN came to an end. </font><font style="vertical-align: inherit;">If you have any questions, feel free to ask.</font></font> Thanks for reading. </div><p>Source: <a href="https://habr.com/ru/post/319080/">https://habr.com/ru/post/319080/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319066/index.html">Google earned so much that it was not necessary to think about money. Until now</a></li>
<li><a href="../319072/index.html">Configuring the virtual machine SPICE console in OpenStack</a></li>
<li><a href="../319074/index.html">Analysis of the report of Baruch Sadogursky with JPoint 2015</a></li>
<li><a href="../319076/index.html">Create an honest Forex</a></li>
<li><a href="../319078/index.html">Step by Step Guide: Building JDK9 from Source on Windows 10</a></li>
<li><a href="../319082/index.html">Dual Wan and the features of the implementation of NetWatch in MikroTik</a></li>
<li><a href="../319084/index.html">Google‚Äôs promises started to come true - now https sites are marked as trusted</a></li>
<li><a href="../319086/index.html">From nuclear power plants to data centers: a new trend in the world of telecommunications</a></li>
<li><a href="../319088/index.html">Darken an image in CollapsingToolbarLayout or Image Scrim</a></li>
<li><a href="../319092/index.html">Lebab is like Babel, just the opposite</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>