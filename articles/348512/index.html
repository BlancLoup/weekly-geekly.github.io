<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The transition from AngularJS to Angular: problems and solutions of the hybrid mode (2/3)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The transition in a hybrid mode is a natural procedure, well prepared and described by the Angular team. However, in practice there are difficulties a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The transition from AngularJS to Angular: problems and solutions of the hybrid mode (2/3)</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/by/tg/lu/bytglukba7ikxywjls-n2lq6jww.jpeg"></p><br><p>  The transition in a hybrid mode is a natural procedure, well prepared and described by the Angular team.  However, in practice there are difficulties and gaps that have to be solved on the fly.  In today's continuation of our article about the migration to Angular, we‚Äôll tell you about the problems that the Skyeng team faced and share our solutions. </p><a name="habracut"></a><br><p>  <a href="https://habrahabr.ru/company/skyeng/blog/348356/">The first part</a> , the <a href="https://habrahabr.ru/company/skyeng/blog/348606/">third part</a> . </p><br><h4 id="dinamicheskaya-kompilyaciya-iz-stroki">  Dynamic string compilation </h4><br><p>  In angularjs, it's very simple: </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> compiledContent = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$compile(template)(scope); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$element.append(compiledContent);</code> </pre> <br><p>  And in Angular, not really. </p><br><p>  <strong>The first solution</strong> is to take a variant from the angulyar through the JiT compiler.  It implies that in the production of the assembly, despite the AoT compilation of static components, the heavy compiler still drags to build dynamic templates.  It looks something like this: </p><br><pre> <code class="hljs lua">//    import {NgModule, Compiler} from <span class="hljs-string"><span class="hljs-string">"@angular/core"</span></span>; import {JitCompilerFactory} from <span class="hljs-string"><span class="hljs-string">"@angular/compiler"</span></span>; export <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compilerFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new JitCompilerFactory([{ useDebug: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, useJit: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }]).createCompiler(); } @NgModule({ providers: [ { provide: Compiler, useFactory: compilerFactory }, ... ], declarations: [ DynamicTemplateComponent, ] }) export class DynamicModule { } //  import { Component, Input, Injector, Compiler, ReflectiveInjector, ViewContainerRef, NgModule, ModuleWithProviders, ComponentRef, OnInit, OnChanges, SimpleChanges, } from <span class="hljs-string"><span class="hljs-string">"@angular/core"</span></span>; import {COMPILER_PROVIDERS} from <span class="hljs-string"><span class="hljs-string">"@angular/compiler"</span></span>; @Component({ selector: <span class="hljs-string"><span class="hljs-string">"vim-base-dynamic-template"</span></span>, template: <span class="hljs-string"><span class="hljs-string">""</span></span>, }) export class DynamicTemplateComponent implements OnInit, OnChanges { @Input() moduleImports?: ModuleWithProviders[]; @Input() template: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>; private componentRef: ComponentRef&lt;any&gt; | null = null; private dynamicCompiler: Compiler; private dynamicInjector: Injector; constructor( private injector: Injector, private viewContainerRef: ViewContainerRef, ) { } public ngOnInit() { this.dynamicInjector = ReflectiveInjector.resolveAndCreate(COMPILER_PROVIDERS, this.injector); this.dynamicCompiler = this.injector.get(Compiler); this.compileComponent(this.template, this.moduleImports); } public ngOnChanges(changes: SimpleChanges) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.dynamicCompiler &amp;&amp; changes.template) { this.compileComponent(this.template, this.moduleImports); } } private compileComponent(template: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, imports: ModuleWithProviders[] = []): void { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.componentRef) { this.componentRef.destroy(); } const component = Component({ template })(class {}); const module = NgModule({ imports, declarations: [ component ] })(class {}); this.dynamicCompiler.compileModuleAndAllComponentsAsync(module) .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(factories =&gt; factories.componentFactories.filter(factory =&gt; factory.componentType === component)[<span class="hljs-number"><span class="hljs-number">0</span></span>]) .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(componentFactory =&gt; { this.componentRef = this.viewContainerRef.createComponent( componentFactory, null, this.viewContainerRef.injector ); }); } }</code> </pre> <br><p>  And everything seems to be relatively good (the thick compiler in the bundle is nevertheless leveled by a mountain of other libs and the code of the project itself, if this is more than the todo list), but here we entered this particular problem: </p><br><p><img src="https://habrastorage.org/webt/ng/6q/-5/ng6q-5nddxvogfqt8adk6no7ifs.png"><br>  <a href="https://github.com/angular/angular/issues/19902">https://github.com/angular/iss/issues/19902</a> </p><br><p>  Six seconds to compile one of our slides with exercises, albeit a rather large one.  Given that three seconds goes incomprehensible simple.  Judging by the answer in the issue, the situation in the coming months will not change, and we had to find another solution. </p><br><p>  It also turned out that in this case we cannot use the factories already compiled during AoT assembly of the components used in the slides, since  There is no possibility to fill the JiT compiler cache.  Such components were essentially compiled two times - on the back-end with the AoT build and in run-time when compiling the first slide. </p><br><p>  <strong>The second</strong> quick-and-easy <strong>solution</strong> was to compile templates via <code>$compile</code> from angularjs (we still have hybrid and angularis): </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DynamicTemplateController</span></span></span><span class="hljs-class"> </span></span>{ static $inject = [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$compile</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$element</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scope</span></span></span><span class="hljs-string">"</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> template: string; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> compiledScope: ng.IScope; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $compile: ng.ICompileService, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $element: ng.IAugmentedJQuery, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $scope: ng.IScope, ) { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $onChanges() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.compileTemplate(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> compileTemplate(): void { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.compiledScope) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.compiledScope.$destroy(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$element.empty(); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.compiledScope = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$scope.$new(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$element.append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$compile(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.template)(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.compiledScope)); } }</code> </pre> <br><p>  The Angular component used an upgraded version of <code>DynamicTemplateComponent</code> from Angular, which used the <code>$compile</code> service to build a template in which all the components were downgraded from the Angular.  Such a short layer of angular -&gt; angularjs ($ compile) -&gt; angular. </p><br><p>  This option has some problems, for example, the impossibility of injecting components through an assembler component from angularis, but the main thing is that it will not work after the end of the upgrade and the cutting of the angularis. </p><br><p>  Additional googling and populating the people in the gitter of the angulyar led to a <strong>third solution</strong> : variations on what is used directly on the off-site of the angulyar for such a case, namely inserting the template directly into the DOM and manually initializing all known components on top of the found tags.  <a href="https://stackblitz.com/edit/angular-build-content%3Ffile%3Dapp%252Fbuild-content%252Fcomponent%252Fbuild-content%252Fbuild-content.ts">Code by reference</a> . </p><br><p>  We insert the incoming template into the DOM as is, for each known component (we obtain the <code>CONTENT_COMPONENTS</code> token in the service), we search for the corresponding DOM nodes and initialize. </p><br><p>  Of the minuses: </p><br><ul><li>  we put a bit clumsily injectors for the correct operation of the injections of the parents; </li><li>  a small hack to support content projection with selects (pulled a couple of methods from the <code>@angular/upgrade</code> module); </li><li>  Inputs are only static and only string; </li><li>  full confidence in the incoming html (inserted without processing, as it may contain inline styles and any other obscenity from our admin panel); </li><li>  incorrect sequence of init hooks for parents-children (first <code>OnInit/AfterViewInit</code> parents, only then <code>OnInit/AfterViewInit</code> children). </li></ul><br><p>  But in general, we have a rather smart way to initialize a dynamic template, which basically solves our problem specifically with angulyar tools and without lags, as with the JiT compiler. </p><br><p>  It would seem that this can be stopped, but for us the problem has not been completely solved because of how the angular works with content projection.  We need the contents of some components (by type of spoilers) to initialize only under certain conditions, which is impossible when using the usual <code>ng-content</code> , and we cannot insert the <code>ng-template</code> due to the way the content is assembled.  In the future, we will look for a more flexible solution, perhaps, we will replace the html content with a JSON structure, according to which we will render the slide with ordinary angural components, taking into account the dynamic display / hiding of a part of the content (will require the use of self-written components instead of <code>ng-content</code> ). </p><br><p>  Someone can approach the <strong>fourth option</strong> , which will be officially available as a beta with the release of angular 6 - <code>@angular/elements</code> .  These are custom elements implemented through the angular.  We register by some tag, in any way we insert this tag into the DOM, and a full-fledged angular component with all the usual functionality is automatically initialized on it.  Of the restrictions - interaction with the main application only through events on such an element. </p><br><p>  Information on them is currently available only in the form of several speeches from ng-conferences, articles on these speeches and technical demos: </p><br><ul><li>  <a href="https://www.youtube.com/watch%3Fv%3DvHI5C-9vH-E">https://www.youtube.com/watch?v=vHI5C-9vH-E</a> </li><li>  <a href="https://medium.com/vincent-ogloblinsky/export-angular-components-as-custom-elements-with-angular-elements-a2a0bfcd7f8a">https://medium.com/vincent-ogloblinsky/export-angular-components-as-custom-elements-with-angular-elements-a2a0bfcd7f8a</a> </li><li>  <a href="https://stackblitz.com/edit/ng-be-2017-demo-elements-hello-world-with-angular%3Ffile%3Dregular-app%252Fmodule.ts">https://stackblitz.com/edit/ng-be-2017-demo-elements-hello-world-with-angular?file=regular-app%2Fmodule.ts</a> </li></ul><br><p>  The Angulyar site plans right away, with the first version of <code>@angular/elements</code> , to switch to them instead of the current build method: </p><br><ul><li>  <a href="https://github.com/angular/angular/pull/21939">https://github.com/angular/angular/pull/21939</a> </li><li>  <a href="https://github.com/angular/angular/pull/22028">https://github.com/angular/angular/pull/22028</a> </li></ul><br><h2 id="change-detection">  Change detection </h2><br><p>  In the hybrid, there are several unpleasant problems with the work of the CD between angular and angularis, namely: </p><br><h4 id="angularjs-v-zone-angular">  AngularJS in the Angular zone </h4><br><p>  Immediately after hybrid initialization, we will get a performance drop due to the fact that angularjs code will run in the angular zone, and any <code>setTimeout</code> / <code>setInterval</code> and other asynchronous actions from the angularjs code and from the thirdparty libraries used will pull the CD angular tick, which yank <code>$digest angularjs</code> .  Those.  if earlier we could not worry about extra digests from the activity of third-party libs, since  angularjs requires explicit kicking of the CD, now it will work for every sneeze. </p><br><p>  It is repaired by forwarding <code>NgZone</code> service to angularjs (through downgrade) and revising the initialization of third-party libs or native timeouts in <code>ngZone.runOutsideAngular</code> .  In the future, they promise the possibility of initializing a hybrid so that the CD of the angulyar and the angulyazh do not pull each other in principle (the angularis will work outside the angular area), and for the interaction between different pieces it will be necessary to clearly pull the CD of the corresponding framework. </p><br><h4 id="downgradecomponent-i-changedetectionstrategyonpush">  downgradeComponent and ChangeDetectionStrategy.OnPush </h4><br><p>  Downgrade components do not work correctly with <code>OnPush</code> - when you change inputs, the CD on this component does not twitch.  <a href="https://stackblitz.com/edit/angular-hybrid-downgraded-onpush">Code</a> </p><br><p>  If you comment out <code>changeDetection: ChangeDetectionStrategy.OnPush,</code> at <code>angular.component</code> , then the counter will be updated correctly </p><br><p>  From solutions, only remove <code>OnPush</code> from the component while it is being used in the patterns of the angular components. </p><br><h2 id="ui-router">  UI Router </h2><br><p>  We originally had a ui-router that works with a new angular and has a bunch of hacks for working in a hybrid mode.  With him there was a lot of fuss over the bootstrap of the application and problems with the protractor. </p><br><p>  As a result, we came to such initialization hacks: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {NgModuleRef} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"@angular/core"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {UpgradeModule} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"@angular/upgrade/static"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {UrlService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"@uirouter/core"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {getUIRouter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"@uirouter/angular-hybrid"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {UrlRouterProvider} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"@uirouter/angularjs"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> function deferAndSyncUiRouter(angularjsModule: ng.IModule): void { angularjsModule .config([ <span class="hljs-string"><span class="hljs-string">"$urlServiceProvider"</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($urlServiceProvider: UrlRouterProvider)</span></span></span><span class="hljs-function"> =&gt;</span></span> $urlServiceProvider.deferIntercept()]) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> NOTE: uglyhack due to bug with protractor https:<span class="hljs-regexp"><span class="hljs-regexp">//gi</span></span>thub.com/ui-router/angular-hybrid/issues/<span class="hljs-number"><span class="hljs-number">39</span></span> .run([ <span class="hljs-string"><span class="hljs-string">"$$angularInjector"</span></span>, $$angularInjector =&gt; { const url: UrlService = getUIRouter($$angularInjector).urlService; url.listen(); url.sync(); }]); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> function bootstrapWithUiRouter(platformRef: NgModuleRef&lt;any&gt;, angularjsModule: ng.IModule): void { const injector = platformRef.injector; const upgradeModule = injector.get(UpgradeModule); upgradeModule.bootstrap(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body, [ angularjsModule.name ], { strictDi: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); }</code> </pre> <br><p>  and in main.ts: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> angular <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"angular"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {platformBrowserDynamic} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"@angular/platform-browser-dynamic"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {setAngularLib} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"@angular/upgrade/static"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppMainOldModule} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./app.module.main"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {deferAndSyncUiRouter, bootstrapWithUiRouter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"../bootstrap-with-ui-router"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppMainModule} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./app.module.main.new"</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> NOTE: uglyhack https:<span class="hljs-regexp"><span class="hljs-regexp">//gi</span></span>thub.com<span class="hljs-regexp"><span class="hljs-regexp">/angular/angular/issues/16484#issuecomment-298852692 setAngularLib(angular); /</span></span>/ TODO: remove after upgrade deferAndSyncUiRouter(AppMainOldModule); platformBrowserDynamic() .bootstrapModule(AppMainModule) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> TODO: remove after upgrade .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(platformRef =&gt; bootstrapWithUiRouter(platformRef, AppMainOldModule));</code> </pre> <br><p>  There are places that are not obvious even according to the official documentation of the router, for example, using angularjs-like injections for <code>OnEnter</code> / <code>OnExit</code> hooks in the angular part of the routing: </p><br><pre> <code class="hljs matlab">testBaseOnEnter.$inject = [ <span class="hljs-string"><span class="hljs-string">"$transition$"</span></span> ]; export <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testBaseOnEnter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(transition: Transition)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">roomsService</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transition</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">injector</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RoomsService</span></span></span><span class="hljs-function">&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RoomsService)</span></span></span><span class="hljs-function">; ... } // </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">page</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ROOMS_TEST_STATES</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">url</span></span></span><span class="hljs-function">: "/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-function">/{</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hash</span></span></span><span class="hljs-function">:</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[az]</span></span></span><span class="hljs-function">{8}}?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tool</span></span></span><span class="hljs-function">&amp;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">studentId</span></span></span><span class="hljs-function">", ... </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEnter</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testBaseOnEnter</span></span></span><span class="hljs-function">, },</span></span></code> </pre> <br><p>  Information about this had to be obtained through the gitter ui-router channel, part of it was already included in the documentation. </p><br><h2 id="protractor">  Protractor </h2><br><p>  A bunch of e2e tests work through a protractor.  Of the problems in the hybrid mode, we faced only the fact that the <code>waitForAngular</code> method had completely <code>waitForAngular</code> .  The QA team cracked some of their hacks, and also asked us to implement a meta-tag in the header with a counter of active api requests, so that, on the basis of this, we could understand when the main activity on the page stopped. </p><br><p>  The counter was made through the HttpClient Interseptors that appeared in ng4: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Injectable()</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PendingApiCallsCounterInterceptor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpInterceptor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> pendingApiCallsCounterService: PendingApiCallsCounterService, ) { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> intercept(req: HttpRequest&lt;any&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;any&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pendingApiCallsCounterService.increment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next.handle(req) .<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pendingApiCallsCounterService.decrement()); } } <span class="hljs-meta"><span class="hljs-meta">@Injectable()</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PendingApiCallsCounterService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> apiCallsCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> counterElement: HTMLMetaElement; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counterElement = document.createElement(<span class="hljs-string"><span class="hljs-string">"meta"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counterElement.name = COUNTER_ELEMENT_NAME; document.head.appendChild(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counterElement); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.updateCounter(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> decrement(): void { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.apiCallsCounter -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.updateCounter(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> increment(): void { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.apiCallsCounter += <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.updateCounter(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> updateCounter(): void { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counterElement.setAttribute(<span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.apiCallsCounter.toString()); } } <span class="hljs-meta"><span class="hljs-meta">@NgModule({ providers: [ { provide: HTTP_INTERCEPTORS, useClass: PendingApiCallsCounterInterceptor, multi: true }, PendingApiCallsCounterService, ] })</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppModule</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre> <br><p>  At the <a href="https://habrahabr.ru/company/skyeng/blog/348606/">end of this story,</a> we share new conventions that help the team get used to working at Angular. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348512/">https://habr.com/ru/post/348512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348500/index.html">Modern CSS for dinosaurs</a></li>
<li><a href="../348502/index.html">We are looking for hover support on css</a></li>
<li><a href="../348506/index.html">Kickstarter and games in 2017</a></li>
<li><a href="../348508/index.html">Interesting surprises ConcurrentDictionary (+ analysis of the problem with DotNext 2017 Moscow)</a></li>
<li><a href="../348510/index.html">We build a distributed reactive application and solve consistency problems.</a></li>
<li><a href="../348516/index.html">Create a concept game without programming skills: how we conducted the first PixJam in the company</a></li>
<li><a href="../348518/index.html">The fall of the cryptocurrency market: causes and prospects</a></li>
<li><a href="../348520/index.html">Your Composer package is broken: update your license ID</a></li>
<li><a href="../348522/index.html">PowerAR - combine PowerBI and ARKit on the tabletop</a></li>
<li><a href="../348524/index.html">GeekBrains begins to prepare full-cycle JavaScript developers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>