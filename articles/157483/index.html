<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Procurement "Import-Export"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good health to all habrazhiteli! 
 MODx Revolution is convenient in many ways. If in MODx Evolution you could do everything, then in MODx Revolution y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Procurement "Import-Export"</h1><div class="post__text post__text-html js-mediator-article"><h4>  Good health to all habrazhiteli! </h4><br>  MODx Revolution is convenient in many ways.  If in MODx Evolution you could do everything, then in MODx Revolution you can do absolutely everything.  There would be a fantasy and patience.  However, after the appearance of Revolution many people wondered how to drag content from one engine to another.  It's one thing if you have a dozen resources.  Here kopipasta help you.  Another thing is content collections, catalogs, and the like. <br><a name="habracut"></a><br><br><h5>  Prehistory </h5><br>  I had two collections - a joke and epic.  In the first one I collected my favorite jokes, in the second - stories from ‚ÄúYaplakal‚Äù, ‚ÄúIThappens‚Äù and other interesting portals.  All this hung on Evolution 1.0.5.  However, one day I transferred my entire multi-domain site to one engine and one database.  In general, I switched to Revolution.  Naturally there was a question about the transfer of content.  With the section "about myself" and the music section, everything was simple - copy-paste.  On the forum, I did not steamed at all - it is still on phpBB.  But with the anecdote and epic writer, the question had to be put on the back burner, because all the patience that had been accumulated there would not be enough ... <br><br><h5>  Export </h5><br>  On the old site there lived a tiny snippet of importing a random joke from a joke.  In fact, an anecdot could export data.  Later, I made a special page that exported all the contents of the site in JSON format, and forgot about it.  When there was a question about the transfer of data, I remembered about it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Why json?  Yes, simply, probably, because I was tired of all hell with all XML parsers.  For nothing, that for JSON there are simple functions - <b>json_encode</b> and <b>json_decode</b> .  This extremely convenient circumstance makes the option with JSON much more preferable than all other options. <br><br>  With export to JSON, everything is simple.  So the contents of the page to export (template _blank): <br><pre><code class="html hljs xml">{"items":[ [[Ditto? &amp;startID=`162` &amp;tpl=`cat` &amp;tplLast=`catLast`]] ]}</code> </pre> <br>  Content of cat chunk: <br><pre> <code class="html hljs xml"> { "name":"[+pagetitle+]", "alias":"[+alias+]", "template":"[+template+]", "hidemenu":"[+hidemenu+]", "content":[ [!Ditto? &amp;startID=`[+id+]` &amp;tpl=`item` &amp;tplLast=`itemLast`!] ] },</code> </pre><br>  catLast is the same, only without a comma at the end.  Item chunk content: <br><pre> <code class="html hljs xml"> { "name":"[+pagetitle+]", "alias":"[+alias+]", "template":"[+template+]", "hidemenu":"[+hidemenu+]", "content":"[+content:strip:noquotes+]" },</code> </pre><br>  itemLast is the same, only without a comma at the end. <br><br>  Phx snippet: noquotes: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// Remove r &amp; n return str_replace('"','&amp; quot ;',$output); //     ! * </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  <i>* spaces are related to how the HTML entity Habrahabr interprets.</i> <br><br>  The result is an impressive such file.  Yes, the main thing - do not forget to set the data type on the export page.  The data type is <b>text / javascript</b> .  Somehow you can immediately export Ditto data to JSON.  But there was no time to understand this question. <br><br><h5>  Import </h5><br>  File received.  What's next?  And then I came across an <a href="http://habrahabr.ru/post/148876/">article on the creation of a social network on MODx</a> and saw exactly how programmatically you can create new documents in MODx Revolution.  An idea was born, and after it a snippet: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//   JSON- //      function addItem($ctx,$pagetitle,$template,$isfolder,$hidemenu,$parent,$alias,$content,$td){ global $modx; $newResource = $modx-&gt;newObject('modResource'); $newResource-&gt;fromArray(array( 'pagetitle'=&gt;$pagetitle, 'longtitle'=&gt;$pagetitle, 'content'=&gt;$content, 'template'=&gt;$template, 'isfolder'=&gt;$isfolder, 'hidemenu'=&gt;$hidemenu, 'parent'=&gt;$parent, 'published'=&gt;'1', 'alias'=&gt;$alias, 'context_key'=&gt;$ctx )); if ($newResource-&gt;save()) { $id = $newResource-&gt;get('id'); $modx-&gt;cacheManager-&gt;refresh(); $modx-&gt;reloadConfig(); if (is_array($td)) { foreach($td as $key=&gt;$val) { $tvar = $modx-&gt;newObject('modTemplateVarResource'); $tvar-&gt;set('contentid',$id); $tvar-&gt;set('tmplvarid',$key); $tvar-&gt;set('value',$val); $tvar-&gt;save(); } } return $id; } else { return false; } } // ,        function handleItem($ctx,$item,$parent,$tpls,$tvs,$handleChildren=false){ $hidm = isset($item['hidemenu'])?$item['hidemenu']:'0'; $isf = is_array($item['content'])?'1':'0'; $content = is_array($item['content'])?'':$item['content']; $tpl = array_key_exists('tpl'.$item['template'],$tpls)?$tpls['tpl'.$item['template']]:'0'; $td = array(); foreach($tvs as $tvn=&gt;$tvv) if (array_key_exists($tvn,$item)) $td[$tvv] = $item[$tvn]; $ret = ''; if ($id = addItem($ctx,$item['name'],$tpl,$isf,$hidm,$parent,$item['alias'],$content,$td)) { $ret = 'Resource ¬´&lt;b&gt;'.$item['name'].'&lt;/b&gt;¬ª imported successfully! ' . 'New ID: &lt;b&gt;'.$id.'&lt;/b&gt;&lt;br /&gt;'; if (is_array($item['content']) &amp;&amp; $handleChildren) foreach ($item['content'] as $i) $ret.= handleItem($ctx,$i,$id,$tpls,$tvs,$handleChildren); return $ret; } else { return 'Resource ¬´&lt;b&gt;'.$item['name'].'&lt;/b&gt;¬ª not imported!&lt;br /&gt;'; } } //   $cons = '&lt;h1&gt;Import item log&lt;/h1&gt;'; //       (    ) $item_count = isset($itemCount)?$itemCount:4; // ,    if (!isset($curContext)) $curContext = 'web'; // ""     (    ) $next_items = isset($_GET['jsonimportnext'])?intval($_GET['jsonimportnext']):0; //   $tpls = array(); if (isset($templates)) { $tmp = explode(',',$templates); foreach($tmp as $val) { $tpls_d = explode('=&gt;',$val); $tpls['tpl'.$tpls_d[0]] = $tpls_d[1]; } } //  TV- $tvs = array(); if (isset($tvParams)) { $tmp = explode(',',$tvParams); foreach($tmp as $val) { $tvs_d = explode('=&gt;',$val); $tvs[$tvs_d[0]] = $tvs_d[1]; } } //   if (isset($source) &amp;&amp; isset($rootID)) { if ($import_content = @file_get_contents($source)) { $import_data = json_decode($import_content,true); $import_count = count($import_data['items']); if ($item_count != 0) { for($c = 0; $c &lt; $item_count; $c++) { $n = $item_count*$next_items+$c; if (isset($import_data['items'][$n])) $cons.= handleItem($curContext,$import_data['items'][$n],$rootID,$tpls,$tvs); } $this_res = $modx-&gt;resource-&gt;get('alias'); $this_res.= '.html'; if (($item_count*$next_items+$item_count-1)&lt;$import_count) { $cons.= '&lt;br /&gt;&lt;a href="'.$this_res.'?jsonimportnext=' . ($next_items+1).'"&gt;' . 'Import next items&lt;/a&gt;&lt;br /&gt;'; } else { $cons.= '&lt;br /&gt;&lt;a href="'.$this_res.'"&gt;Start&lt;/a&gt;'; } } else { foreach ($import_data['items'] as $item) $cons.= handleItem($curContext,$item,$rootID,$tpls,$tvs,true); } } else { $cons.= 'Cannot get source!&lt;br /&gt;'; } } else { $cons.= 'Invalid execution parameters!&lt;br /&gt;'; } return $cons;</span></span></code> </pre><br><br>  I must say: it does not pretend to a universal solution.  The code is practically not commented out, alas.  Too hurry to share with the needy.  If the solution seems interesting, I will continue to develop the work and maybe create a full-fledged superstructure over MODx. <br><br>  The snippet receives the following parameters as input: <br><ul><li>  <b>source</b> (required) - the source of the JSON file. </li><li>  <b>itemCount</b> - the number of imported items in a single pass (for not very productive systems).  The default is 4. If set to 0, everything will be processed at once, moreover, recursively. </li><li>  <b>templates</b> - <b>template</b> matching.  Comma-separated lists of comparisons in the format old_id =&gt; new_id, where old_id is the id of the template of the old site, new_id is the id of the template of the new site.  If the parser does not find a match, the template 0 is set (empty). </li><li>  <b>tvParams</b> - TV parameter mapping.  Comma-separated lists of comparisons in the format old_name =&gt; new_id, where old_name is the name of the variable of the old site, new_id is the id of the variable of the new site.  If the parser does not find a match, the variable is skipped. </li><li>  <b>curContext</b> (required) - current context.  In principle, if you do not set the context, then it will be installed in the "web". </li><li>  <b>rootID</b> (required) - resource id where documents will be imported. </li></ul><br><br>  Why talk about performance.  But the fact is that when I launched the first version of the snippet, where everything should be processed recursively, the server gave me error 502.  Simply put the hoster hacked to a high load.  No wonder - there were so many documents. <br><br><h5>  How to use </h5><br>  First, we write a simple template: <br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/xhtml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xml:lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ru"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"content-type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/html; charset=utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>[[*pagetitle]]<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">body</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">font</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">12px</span></span></span><span class="css"> monospace; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">align</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"center"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align: left; width: 800px;"</span></span></span><span class="hljs-tag">&gt;</span></span> [[!importJSON? &amp;source=`[[*sourceURL]]` &amp;itemCount=`6` &amp;templates=`[[*templatesReplace]]` &amp;tvParams=`[[*tvsReplace]]` &amp;curContext=`[[*currentContext]]` &amp;rootID=`[[*importDestination]]`]] <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Then we create and bind the TV-parameters <b>sourceURL, templatesReplace, tvsReplace, currentContext, importDestination to the template</b> .  No need to swear at currentContext and broadcast to me about context_key.  In theory, you can create one page and import data into different contexts.  Actually everything.  In addition, I will say how I used this thing.  Immediately I will make a note that I did without categories in the export template, changing the startID each time.  Due to load limitations.  The sequence of my actions. <br><ol><li>  On the old site, open the export file for editing.  We put on the further action "continue." </li><li>  On the new site, open the file for editing, where we transfer the content (hereinafter the import file).  Change the template to the import template from JSON, save. </li><li>  In the parameters of the import file, we set the current context, the URL of the export file, pattern matching and TV parameters.  We save. </li><li>  In the export file, we change the value in startID to the id of the parent resource, from where we will export the content.  We save. </li><li>  In the import file, set the id of the resource where we will import.  We save. </li><li>  Call the import file for viewing.  Then we repeat until at the end there is a link that says ‚ÄúStart‚Äù: <br><ol><li>  We are waiting for the download to complete. </li><li>  Click on the link ‚ÄúImport next items‚Äù </li></ol></li><li>  After we have imported everything from the necessary resource, we return to step 4, if something else needs to be imported. </li></ol><br><br>  Yes, I know, for greater performance it would be possible to do everything by direct queries to the database.  Only, firstly, not the fact that this would correct the situation with the 502nd error.  Secondly, there was no time to study what is affected in the database when creating a resource, except for site_content.  Thirdly, I would have written such a decision, I would have been immediately stumbled with the wording ‚Äúa-how-well-XPDO‚Äù. <br><br>  Once again I remind you that this is only a preliminary draft decision.  Thank you all for your attention to my next bike! </div><p>Source: <a href="https://habr.com/ru/post/157483/">https://habr.com/ru/post/157483/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157467/index.html">Ghost: The Idea of ‚Äã‚ÄãSimple WordPress Blogger</a></li>
<li><a href="../157469/index.html">Whether Americans will fly to Mars - how it depends on the results of the election of the President of the United States</a></li>
<li><a href="../157471/index.html">Time Machine: backup file size limit</a></li>
<li><a href="../157477/index.html">Account without registration</a></li>
<li><a href="../157481/index.html">Features of working with Apple push notification service</a></li>
<li><a href="../157485/index.html">Photos jobs habrovchan</a></li>
<li><a href="../157487/index.html">Elon Musk. Mission to mars</a></li>
<li><a href="../157489/index.html">Big update ObjectScript 0.99-vm3. Part 1: Register Virtual Machine</a></li>
<li><a href="../157491/index.html">Jottacloud cloud storage</a></li>
<li><a href="../157493/index.html">What should a student do? Steve Ballmer will answer - online broadcast of Student Day, 10:00</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>