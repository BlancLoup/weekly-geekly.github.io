<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GUI for php, or we cross written extension with a screenshot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will discuss the practical application of the gtkPHP7 extension, which we wrote earlier in this article , and srcphp (php screenshot) wri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GUI for php, or we cross written extension with a screenshot</h1><div class="post__text post__text-html js-mediator-article">  This article will discuss the practical application of the gtkPHP7 extension, which we wrote earlier in <a href="https://habrahabr.ru/post/311506/">this article</a> , and srcphp (php screenshot) written in <a href="https://habrahabr.ru/post/310694/">this article</a> .  Since the publication of the article, where we wrote the extension gtkPHP7 several days have passed.  And I was thinking how to build this library so that it would be in the spirit of php.  Simple and convenient to use, as well as could satisfy (so far only my) needs for it.  For details, I ask under the cat. <br><br><img src="https://habrastorage.org/files/51c/a83/8e2/51ca838e29434b50b543d19289ae6eb0.png"><br><a name="habracut"></a><br>  <b>Today we will touch on several topics:</b> <br><br>  2. 1. The principle of the expansion <br>  2. The technical side of the solution <br>  3. Tools debug expansion 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Expansion principle </h3><br>  The main goal was usability.  As we all know, php works in one thread, there are, of course, extensions that allow us to create threads and work with them, but in the case of using threads, difficulties arise related to managing them.  And in principle, while this is not necessary.  Therefore, for me, the priority was the straightness of the logic of work, i.e.  if we call the class method: <br><br><pre><code class="php hljs">$result = $gtk-&gt;alert(<span class="hljs-string"><span class="hljs-string">" !"</span></span>); var_dump($result);</code> </pre> <br>  Then we get the following result: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7a5/b7e/bb8/7a5b7ebb834145f199092ff7df39b683.png"></div><br>  And when you click on the ok button: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/6d6/34b/bec/6d634bbecf75474fb75478f887c984ac.png"></div><br>  That is, the concept is to become PHP, start-&gt; any execution of any sequential actions-&gt; completion of the script. <br><br><h3>  The technical side of the issue </h3><br>  I decided to split the extension to the main part (main.cpp), and modules, each of which implement one or another widget for use in php.  To do this, I created the src / folder where the actual code lies, and transferred all the sources to a new directory.  When the source is transferred, we need to fix the Makefile as follows, specifying where the .cpp files are located: <br><br><pre> <code class="bash hljs">SOURCES = $(wildcard src/*.cpp)</code> </pre><br>  Below is an example of a class that implements the preview window: <br><br><div class="spoiler">  <b class="spoiler_title">The same screen and hat</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/51c/a83/8e2/51ca838e29434b50b543d19289ae6eb0.png"></div></div><br>  File previewWindow.h <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GtkPhpPreviewWindow</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: Gtk::Window *mainWindow = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      protected: int statusUpload = 0; //    upload int statusCancel = 0; //    cancel public: std::string preview(char *fileSrc); //     void uploadClick(); // callback  void cancelClick(); std::string getStatusUpload(); //     };</span></span></code> </pre><br>  Next, let's take a look at the file itself, namely, analyze the preview. <br><br><div class="spoiler">  <b class="spoiler_title">listing preview</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * run preview window */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> GtkPhpPreviewWindow::preview(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *fileSrc) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> argc = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **argv = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> app = Gtk::Application::create(argc, argv, <span class="hljs-string"><span class="hljs-string">"org.gtkmm.gtkphp7"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> refBuilder = Gtk::Builder::create(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { refBuilder-&gt;add_from_file(<span class="hljs-string"><span class="hljs-string">"picview.glade"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Glib::FileError &amp;ex) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"FileError: "</span></span> &lt;&lt; ex.what() &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Gtk::BuilderError &amp;ex) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"BuilderError: "</span></span> &lt;&lt; ex.what() &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } refBuilder-&gt;get_widget(<span class="hljs-string"><span class="hljs-string">"window1"</span></span>,mainWindow); Gtk::Image *image = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; refBuilder-&gt;get_widget(<span class="hljs-string"><span class="hljs-string">"preview"</span></span>, image); Gtk::Button *buttonUpload = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; refBuilder-&gt;get_widget(<span class="hljs-string"><span class="hljs-string">"upload"</span></span>, buttonUpload); buttonUpload-&gt;signal_clicked().connect( sigc::mem_fun(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, &amp;GtkPhpPreviewWindow::uploadClick) ); Gtk::Button *buttonCancel = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; refBuilder-&gt;get_widget(<span class="hljs-string"><span class="hljs-string">"cancel"</span></span>, buttonCancel); buttonCancel-&gt;signal_clicked().connect( sigc::mem_fun(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, &amp;GtkPhpPreviewWindow::cancelClick) ); image-&gt;<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(fileSrc); app-&gt;run(*mainWindow); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getStatusUpload(); }</code> </pre><br></div></div><br>  The method turned out to be quite long, so let's try to consider only the key points. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> app = Gtk::Application::create(argc, argv, <span class="hljs-string"><span class="hljs-string">"org.gtkmm.gtkphp7"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> refBuilder = Gtk::Builder::create(); refBuilder-&gt;add_from_file(<span class="hljs-string"><span class="hljs-string">"picview.glade"</span></span>);</code> </pre><br>  With these three lines we create an instance of the application and the builder (something like a factory in php).  And load the picview.glade file. <br><br>  Yes, to facilitate the creation of forms, I used glade - a form editor for gtk. <br><br><div class="spoiler">  <b class="spoiler_title">Preview in glade</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/1af/d5d/11d/1afd5d11ddc54a0ea5a0e892adc8eafd.png"><br></div></div><br>  By creating a file describing the position of the elements (or in other words layouts) in xml format.  We simply load it and take the elements we need: <br><br><pre> <code class="cpp hljs"> Gtk::Button *buttonCancel = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; refBuilder-&gt;get_widget(<span class="hljs-string"><span class="hljs-string">"cancel"</span></span>, buttonCancel); <span class="hljs-comment"><span class="hljs-comment">//   buttonCancel-&gt;signal_clicked().connect( sigc::mem_fun(*this, &amp;GtkPhpPreviewWindow::cancelClick) //     );</span></span></code> </pre><br>  In cancelClick: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * callback cancel button */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> GtkPhpPreviewWindow::cancelClick() { statusCancel = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> mainWindow; }</code> </pre><br>  We remove mainWindow and set the status of the cancel button as clicked.  The final touch is to launch the application (in this case, display the window): <br><br><pre> <code class="cpp hljs">app-&gt;run(*mainWindow);</code> </pre><br>  At this moment, a ‚Äúloop‚Äù is created, which keeps the window open, and does not continue.  But the moment we click on the button, we delete mainWindow, and the program goes to the method: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * get status upload * @return */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> GtkPhpPreviewWindow::getStatusUpload() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (statusUpload == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"upload"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"cancel"</span></span>; } }</code> </pre><br>  which returns a string indicating what was pressed. <br><br><h3>  Debugging tools </h3><br>  Probably every ‚ÄúC‚Äù programmer knows what gdb is, but not every php programmer knows about it, although it can be very useful, even if you are not developing in ‚ÄúC‚Äù.  For example, I somehow learned why apache gave segfault and generated core dump ... <br><br>  So, gdb - gnu debuger debugger for c and c ++ can do a lot: set breakpoints, read memory dumps, build stack trace.  So, imagine that your extension falls from segfault, but rather php (since the extension is connected to the interpreter).  Like everything, compiled and should work.  But no. <br><br>  First we need to recompile our project, with the option -g.  For this, I fixed the Makefile: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">COMPILER</span></span> = g++ -g</code> </pre> <br>  And compiled with this option.  After that, a php script was written that caused the core dump, and launched under gdb: <br><br><pre> <code class="hljs ruby">$ gdb php $ /..  gdb ../ (gdb) run ./test.php <span class="hljs-comment"><span class="hljs-comment">#      $ ....     coredump (gdb) bt #  backtrace   </span></span></code> </pre><br>  Thus, gdb shows us the error that occurred, and the backtrace, by which you can determine exactly what the problem is (at least for me the project is small). <br><br>  <b>As a conclusion</b> <br>  After debugging the extensions, I integrated the gui into the screenshot: <br><br><div class="spoiler">  <b class="spoiler_title">New code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/php &lt;?php require_once('classis/autoload.php'); class screenShoter { protected $_nameScreenshot = null; protected $_config = null; protected $_gtk = null; public function __construct() { $this-&gt;_gtk = new GtkPhp(); $request = new Request(); if(isset($argv[1]) &amp;&amp; $argv[1] == '--getToken') { echo $request-&gt;getOauthLink();die; } $home = $_SERVER['HOME']; $this-&gt;_config = include($home . '/.config/scrphp/config.php'); $this-&gt;_nameScreenshot = date('Y_m_d_G_i_s_') . 'screen.png'; $this-&gt;scrot(); } public function scrot() { $this-&gt;_gtk-&gt;alert(",       Ok   ,  "); system('scrot -s /tmp/'.$this-&gt;_nameScreenshot); $resultPrev = $this-&gt;_gtk-&gt;preview('/tmp/'.$this-&gt;_nameScreenshot); if($resultPrev == 'upload') { $this-&gt;upload(); } else { $this-&gt;scrot(); } } public function upload() { $request = new Request(); $result = $request -&gt;setToken($this-&gt;_config['token']) -&gt;setFileNameOnDisk($this-&gt;_nameScreenshot) -&gt;setPathToFile('/tmp/'.$this-&gt;_nameScreenshot) -&gt;upload() -&gt;publicateFile(); $url = $result['public_url']; $this-&gt;_gtk-&gt;alert("  :".$url); } } new screenShoter();</span></span></code> </pre><br></div></div><br>  This script works in three steps: <br><br>  1. Alert, which displays a hint how to make a screenshot: <br><br><img src="https://habrastorage.org/files/183/763/1dc/1837631dc1114d70b8309a2474fae3c4.png"><br><br>  2. After selecting a site and creating a screenshot, a preview opens: <br><br><img src="https://habrastorage.org/files/33e/dfd/b9d/33edfdb9dcca466e9ab178d76f6977e8.png"><br><br>  3. After clicking on the upload button, an alert appears with a link <br><br><img src="https://habrastorage.org/files/773/0dc/3e7/7730dc3e79614954bd42bdf8fcef24a6.png"><br><br>  In conclusion. <br><br>  Repository links: <br><blockquote>  1. <a href="https://github.com/lnroma/gtkPHP7">gtkPHP7</a> <br>  2. <a href="https://github.com/lnroma/srcphp">srcphp screenshot</a> </blockquote><br>  Dependencies: <br><blockquote>  1. gtkmm3 <br>  2. gtk3 <br>  3. glade </blockquote></div><p>Source: <a href="https://habr.com/ru/post/311746/">https://habr.com/ru/post/311746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311736/index.html">Report from Moscow Python Meetup September 22</a></li>
<li><a href="../311738/index.html">Backup and restore mail from the cloud using Veeam Backup for Microsoft Office 365</a></li>
<li><a href="../311740/index.html">Opus about startaparstvom and competitions in one part</a></li>
<li><a href="../311742/index.html">IPv6 in Microsoft Azure</a></li>
<li><a href="../311744/index.html">Working with Big Data with the help of GPU: accelerating the work of databases dozens of times</a></li>
<li><a href="../311748/index.html">How about putting each function in your file?</a></li>
<li><a href="../311750/index.html">Programming & Music: ADSR-signal envelope. Part 2</a></li>
<li><a href="../311752/index.html">How to choose the best RKO when opening a business</a></li>
<li><a href="../311754/index.html">‚ÄúAdmin: password‚Äù problem: standard passwords helped create a botnet from almost 400,000 IoT devices</a></li>
<li><a href="../311756/index.html">We launch a simple blog on Wagtail CMS (Django) - part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>