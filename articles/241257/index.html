<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Make an anonymous access point based on Raspberry Pi and TOR</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 From the use of the TOR network, I was deterred by the need to deal with the program settings every time, I wanted some more general solu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Make an anonymous access point based on Raspberry Pi and TOR</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  From the use of the TOR network, I was deterred by the need to deal with the program settings every time, I wanted some more general solution that was made outside of the used PC.  The other day I came across <a href="https://www.kickstarter.com/projects/augustgermar/anonabox-a-tor-hardware-router">this project</a> and realized that he would solve all my difficulties.  But since the project was <a href="http://www.tomshardware.com/news/anonabox-tor-kickstarter-suspended-router,27919.html">frozen</a> , in order to experiment, the idea came to create such an access point yourself. <br><br>  Now this Raspberry Pi (well, little red!) Is giving away an anonymous internet connection within my apartment: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/622/2c2/0f3/6222c20f34e149d986234bb63cc819e5.jpg"><br><br>  In this article I will tell you how I taught my ‚Äúraspberry‚Äù to perform the functions of an access point with the direction of all TCP traffic through the TOR network.  I ask under the cat. <br><a name="habracut"></a><br><h2>  Training </h2><br>  So, what do we need: <br><ul><li>  1 x Raspberry Pi </li><li>  1 x USB WiFi adapter </li></ul><br>  I bought my Raspberry Pi <a href="http://thepihut.com/collections/raspberry-pi">here</a> , but the delivery to the Russian Federation was denied with reference to ‚Äútoo unpredictable post service‚Äù, so for many it would be more convenient to use the following store or find something third. <br><br>  The WiFi adapter was chosen like this - <a href="https://www.modmypi.com/raspberry-pi-accessories/networking/wireless-usb-1n-nano-adaptor-802.11N-wifi-dongle">Nano WiFi Dongle</a> . <br><br>  Let's start the setup based on the fact that Raspbian OS is already installed on the ‚Äúraspberry‚Äù.  You can always get a pre-installed image on <a href="http://www.raspberrypi.org/downloads/">the device‚Äôs official website</a> or you can go through the whole process from scratch by downloading the <a href="http://www.raspbian.org/RaspbianInstaller">installer</a> . <br><br>  First of all, we connect the device to the wired network and install the necessary software, other packages are either already installed in the system, or will be installed according to dependencies: <br><br><pre><code class="bash hljs">apt-get update <span class="hljs-comment"><span class="hljs-comment">#   -   #apt-get upgrade -y apt-get install -y tor isc-dhcp-server hostapd iptables-persistent</span></span></code> </pre> <br>  This preparatory part is completed. <br><br><h2>  Configure the access point </h2><br>  Physically we connect the WiFi adapter and add the following lines to the <b>/ etc / network / interfaces</b> file: <br><br><pre> <code class="bash hljs">auto wlan0 iface wlan0 inet static address 192.168.55.1 netmask 255.255.255.0</code> </pre><br>  We configure hostapd - the demon who turns our device into an access point.  First, specify the path to the configuration file in <b>/ etc / default / hostapd</b> : <br><br><pre> <code class="bash hljs">DAEMON_CONF=<span class="hljs-string"><span class="hljs-string">"/etc/hostapd/hostapd.conf"</span></span></code> </pre><br>  Next, fill in the configuration file itself, <b>/etc/hostapd/hostapd.conf</b> : <br><br><pre> <code class="bash hljs">interface=wlan0 <span class="hljs-comment"><span class="hljs-comment">#     ssid=anonymous_ap hw_mode=g #       channel=11 #   MAC-     macaddr_acl=0 #           1     wpa=0 #wpa_key_mgmt=WPA-PSK #wpa_pairwise=TKIP CCMP #wpa_ptk_rekey=600 # ,   #wpa_passphrase=hidemyass</span></span></code> </pre><br>  A slightly non-trivial activation of the 802.11n standard, which this adapter supports: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># iwgetid --protocol wlan0 wlan0 Protocol Name:"IEEE 802.11bgn"</span></span></code> </pre><br>  Simply changing the <b>hw_mode</b> parameter to ‚Äún‚Äù resulted in a negative result; the wireless connection did not rise after the restart: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/init.d/hostapd restart [ ok ] Stopping advanced IEEE 802.11 management: hostapd. [FAIL] Starting advanced IEEE 802.11 management: hostapd failed! # tail /var/log/syslog | grep 'anonymous-ap' Oct 21 09:31:37 anonymous-ap ifplugd(mon.wlan0)[7490]: Link beat lost. Oct 21 09:31:38 anonymous-ap ifplugd(mon.wlan0)[7490]: Exiting. Oct 21 09:31:38 anonymous-ap ifplugd(wlan0)[1684]: Link beat lost. Oct 21 09:31:48 anonymous-ap ifplugd(wlan0)[1684]: Executing '/etc/ifplugd/ifplugd.action wlan0 down'. Oct 21 09:31:49 anonymous-ap ifplugd(wlan0)[1684]: Program executed successfully.</span></span></code> </pre><br>  <a href="http://wireless.kernel.org/en/users/Documentation/hostapd">It turns out</a> that hw_mode should be left in the value of ‚Äúg‚Äù, but add the line ‚Äúieee80211n = 1‚Äù, which we do, restarting the daemon along the way: <br><br><pre> <code class="bash hljs">\<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"\nieee80211n=1"</span></span> &gt;&gt; /etc/hostapd/hostapd.conf service hostapd restart</code> </pre><br>  Next, we configure DHCP by editing the <b>/etc/dhcp/dhcpd.conf</b> file: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    option domain-name "anonymous-ap.local"; #   subnet 192.168.55.0 netmask 255.255.255.0 { range 192.168.55.10 192.168.55.100; option domain-name-servers 8.8.4.4, 8.8.4.4; option routers 192.168.55.1; interface wlan0; }</span></span></code> </pre><br>  Do not forget to restart the service: <br><br><pre> <code class="bash hljs">/etc/init.d/isc-dhcp-server restart</code> </pre><br><br><h2>  TOR setting </h2><br>  Very simple, because  we do not use the device as an exit point or relay-server, we only enter the TOR network.  To do this, we bring the file <b>/ etc / tor / torrc</b> to the following form: <br><br><pre> <code class="bash hljs">VirtualAddrNetwork 172.16.0.0/12 AutomapHostsSuffixes .onion,.<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> AutomapHostsOnResolve 1 TransPort 9040 TransListenAddress 192.168.55.1 DNSPort 53 DNSListenAddress 192.168.55.1</code> </pre><br><br><h2>  Configuring packet forwarding </h2><br>  Quickly activate forvarding at the kernel level: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'net.ipv4.ip_forward=1'</span></span> &gt;&gt; /etc/sysctl.conf sysctl -p</code> </pre><br>  We configure iptables to route all client tcp traffic to the TOR network, leaving SSH access and DNS requests: <br><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 22 -j REDIRECT --to-ports 22 iptables -t nat -A PREROUTING -i wlan0 -p udp --dport 53 -j REDIRECT --to-ports 53 iptables -t nat -A PREROUTING -i wlan0 -p tcp --syn -j REDIRECT --to-ports 9040 iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE <span class="hljs-comment"><span class="hljs-comment">#      iptables-persistent,      iptables-save &gt; /etc/iptables/rules.v4</span></span></code> </pre><br>  Strictly speaking, there are other configuration options.  So, you can configure the access point for simple forwarding packets to the ‚Äúnormal‚Äù network while maintaining access to pseudo-domains in the ".onion" zone.  <a href="https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy">Read more here</a> . <br><br><h2>  Completion and verification </h2><br>  After a purely formal reboot, our device will be ready to distribute anonymous Internet: <br><br><pre> <code class="bash hljs">shutdown -r now</code> </pre><br>  Now we will try to connect from a laptop, phone or tablet, and a visit to <a href="https://check.torproject.org/">this page</a> will determine whether everything is configured correctly, here is an example of a success message: <br><br><img src="https://habrastorage.org/files/80c/964/7b7/80c9647b745d4a31b0e838c466fc71c0.png"><br><br>  It should be noted that in reality, the TOR verification service is likely to additionally offer you to install the <a href="">Tor Browser Bundle</a> and this is not accidental.  It is important to understand that the use of the TOR network by itself will not give a full guarantee of anonymity and browsers such as IE, Chrome and Safari may well continue to send any information about the user. <br><br>  In addition, this method in no way guarantees complete protection, for a more reliable anonymization, you should study <a href="https://trac.torproject.org/projects/tor/wiki">this</a> selection of articles. <br><br>  I hope the recipe will be useful, I will be glad to add! </div><p>Source: <a href="https://habr.com/ru/post/241257/">https://habr.com/ru/post/241257/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241237/index.html">Cheat Sheet Management Services CentOS 7 with systemd</a></li>
<li><a href="../241245/index.html">Internet office switch</a></li>
<li><a href="../241247/index.html">Irrational use of Digitalocean</a></li>
<li><a href="../241253/index.html">Python Meetup 09/26/14: Improving code and speeding up Python</a></li>
<li><a href="../241255/index.html">Pooling database connections on node.js</a></li>
<li><a href="../241259/index.html">Traffic generation by our subscribers exceeded 256 Gbit / s! Sale of servers with a channel of 10 Gb / s</a></li>
<li><a href="../241261/index.html">Microsoft Azure Cloud Hot Announcements: Bigger, Faster, and More Open</a></li>
<li><a href="../241263/index.html">Rushim Captcha SilkRoad 2.0</a></li>
<li><a href="../241265/index.html">How to quickly and easily write DSL in Ruby</a></li>
<li><a href="../241267/index.html">Ciklum Java Subbotnik in Kiev, November 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>