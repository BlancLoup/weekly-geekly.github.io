<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Objective-C Runtime from the inside</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(original - Mike Ash, taken from here ) 

 Many Cocoa developers have a rather vague idea of ‚Äã‚Äãthe Objective-C Runtime API. They know that it exists s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Objective-C Runtime from the inside</h1><div class="post__text post__text-html js-mediator-article">  <i>(original - Mike Ash, taken <a href="http://www.mikeash.com/pyblog/friday-qa-2009-03-13-intro-to-the-objective-c-runtime.html">from here</a> )</i> <br><br>  Many Cocoa developers have a rather vague idea of ‚Äã‚Äãthe Objective-C Runtime API.  They know that it exists somewhere there (some do not even know it!), That it is important, and Objective-C is not functional without it, but usually all knowledge is limited to it. <br><br>  Today I will talk about how Objective-C works at the Runtime level and how you can use it. <br><a name="habracut"></a><br><h4>  Objects </h4><br>  In Objective-C, we are constantly dealing with objects, but what exactly is an object?  Let's try to build something that will help shed light on this question. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, we all know that we refer to objects using pointers, for example, <b>NSObject *</b> .  We also know that we create them using <b>+ alloc</b> .  All we can learn about this from the documentation is that this happens by calling <b>+ allocWithZone:.</b>  Continuing our research chain, we find the <b>NSDefaultMallocZone</b> , which is created using ordinary <b>malloc</b> .  And that's it! <br><br>  But what are the created objects?  Well, let's see: <br><pre><code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> @interface A : NSObject { @public int a; } @end @implementation A @end @interface B : A { @public int b; } @end @implementation B @end @interface C : B { @public int c; } @end @implementation C @end int main(int argc, char **argv) { [NSAutoreleasePool new]; C *obj = [[C alloc] init]; obj-&gt;a = 0xaaaaaaaa; obj-&gt;b = 0xbbbbbbbb; obj-&gt;c = 0xcccccccc; NSData *objData = [NSData dataWithBytes:obj length:malloc_size(obj)]; NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Object contains %@"</span></span></span><span class="hljs-meta">, objData); return 0; }</span></span></code> </pre> <br>  We built a hierarchy of classes, each of which contains variables, and filled them with quite obvious values.  We then retrieved the data in a digestible form using <b>malloc_size</b> to get the correct length and used <b>NSData</b> to print everything in hex.  Here's what we got at the exit: <br><pre> <code class="objectivec hljs"> <span class="hljs-number"><span class="hljs-number">2009</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-27</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">04.904</span></span> a.out[<span class="hljs-number"><span class="hljs-number">22090</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>b] Object contains &lt;<span class="hljs-number"><span class="hljs-number">20300000</span></span> aaaaaaaa bbbbbbbb cccccccc&gt;</code> </pre><br>  We see that the class has consistently filled the memory cells ‚Äî first the variable A, then its successor B, and then C. Everything is simple! <br>  But what about <b>20.3 million</b> at the very beginning?  They come before A, and therefore, most likely, belong to <b>NSObject</b> .  Let's look at the definition of <b>NSObject</b> . <br><pre> <code class="objectivec hljs"> <span class="hljs-comment"><span class="hljs-comment">/*********** Base class ***********/</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> </span></span>{ Class isa; }</code> </pre><br>  As you can see, again some kind of variable.  But what is this <b>Class</b> ?  We pass by the definition that <b>Xcode</b> offers us and we get into <i>usr / include / objc / objc.h</i> , in which we find the following: <br><pre> <code class="objectivec hljs"> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> objc_class *Class;</code> </pre><br>  Go ahead to /usr/include/objc/runtime.h and see: <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> objc_class { Class isa; <span class="hljs-meta"><span class="hljs-meta">#if !__OBJC2__ Class super_class OBJC2_UNAVAILABLE; const char *name OBJC2_UNAVAILABLE; long version OBJC2_UNAVAILABLE; long info OBJC2_UNAVAILABLE; long instance_size OBJC2_UNAVAILABLE; struct objc_ivar_list *ivars OBJC2_UNAVAILABLE; struct objc_method_list **methodLists OBJC2_UNAVAILABLE; struct objc_cache *cache OBJC2_UNAVAILABLE; struct objc_protocol_list *protocols OBJC2_UNAVAILABLE; #endif } OBJC2_UNAVAILABLE;</span></span></code> </pre><br>  Thus, <b>Class</b> is a pointer to a structure that ... Starts with another <b>Class.</b> <br>  Let's see another class, <b>NSProxy</b> <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSProxy</span></span></span><span class="hljs-class"> </span></span>{ Class isa; }</code> </pre><br>  And here he is.  One more, id, behind which any object in Objective-C can hide <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> objc_object { Class isa; } *<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>;</code> </pre><br>  And again he.  Obviously, every object in Objective-C must begin with <b>Class</b> <i>isa</i> , even class objects.  So what is it? <br>  As the name and type imply, the isa variable indicates which class this or that object belongs to.  Every object in Objective-C must begin with <i>isa</i> , otherwise the runtime will not know what to do with it.  All information about the type of each particular object is hidden behind this tiny pointer.  The remaining piece of the object, in terms of runtime, is simply a huge BLOB, which does not give any information.  Only classes can give this piece some meaning. <br><br><h4>  Classes </h4><br>  What then is actually contained in the classes?  The answer to this question will help us to find the ‚Äúinaccessible‚Äù fields of the structure (those after #if! __ OBJC2__, they are left here for compatibility with pre-Leopard, and you should not use them if you are developing the Floor Leopard and above, however, they help us understand what kind of information is hidden there).  First comes <i>isa</i> , allowing you to work with the class as with an object.  Then there is a link to Class - the ancestor, in order not to break the hierarchy of classes.  Next comes some basic class information.  But the most interesting is at the end.  This is a list of variables, a list of methods and a list of protocols.  All this is available during the performance, and can be changed there! <br><br>  <i>I missed the cache, as it is not very interesting from the point of view of manipulation during execution, but it is worth telling about the role it plays in principle.</i>  <i>Every time you send a message ([foo bar]), the Runtime searches for it in the list of object class methods.</i>  <i>But since this is just a linear list, this process is quite long.</i>  <i>A cache is a hash table that contains methods already called before.</i>  <i>That is why the first method call can be much longer than all subsequent ones.</i> <br><br>  By exploring runtime.h, you can discover many functions for accessing and modifying these elements.  Each function begins with a prefix that shows what it is dealing with.  Basic ones start with <i>objc_</i> , functions for working with classes on <i>class_</i> , and so on.  For example, you can call <i>class_getInstanceMethod</i> to find out information about a particular method, such as an argument list / return type.  Or you can add a new method using <i>class_addMethod</i> .  You can even create entire classes with <i>objc_allocateClassPair</i> during execution! <br><br><h4>  Practical application </h4><br>  There are many options for applying this Runtime meta-information, here are some of them. <br><ol><li>  <b>Automatic search for variables / methods.</b>  Apple has already implemented this in the form of Key-Value Coding: you specify a name, in accordance with this name you get a variable or method.  You can do it yourself, if you are not satisfied with the Apple implementation ( <i>note the translator - for example, like this</i> <a href="http://www.mikeash.com/pyblog/key-value-observing-done-right.html">Better key-value observing for Cocoa</a> ) <br></li><li>  <b>Automatic registration / call subclasses.</b>  Using <i>objc_getClassList</i> you can get a list of classes already known to Runtime and, following the class hierarchy, find out which subclasses are inherited from this class.  This gives you the opportunity to write subclasses that will be responsible for specific data formats, or something like that, and then give the superclass the opportunity to find them yourself, saving themselves from the tedious need to register them all by hand. </li><li>  <b>Automatically call method for each class.</b>  This can be useful for unit-testing frameworks and similar things.  Very similar to # 2, but with an emphasis on finding possible methods, rather than a class hierarchy </li><li>  <b>Overloading methods during execution.</b>  Runtime provides you with a complete set of tools to change the implementation of class methods, without having to change anything in their source code. </li><li>  <b>Bridging</b> With the ability to dynamically create classes and view the required fields, you can create a bridge between Objective-C and another (fairly dynamic) language. </li><li>  <b>And many many others!</b>  Do not limit yourself to the list presented above. </li></ol><br><h4>  Conclusion </h4><br>  Objective-C is a powerful language, with a comprehensive Runtime API playing a key role in its dynamism.  It may not be so pleasant to mess with all this C code, but the possibilities that it opens are truly enormous. <br><br>  <i>(note of the translator - for those who are no longer eager to play around with all this endless dynamism of Objective-C, but do not want to deal with runtime.h, Mike Ash <a href="https://github.com/mikeash/MAObjCRuntime">put a</a> project <a href="https://github.com/mikeash/MAObjCRuntime">on GitHub</a> - a wrapper over runtime.h, which provides full access to all the goodies described above, but in the usual Objective-C syntax.)</i> </div><p>Source: <a href="https://habr.com/ru/post/148922/">https://habr.com/ru/post/148922/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148911/index.html">Haiku. Start</a></li>
<li><a href="../148913/index.html">In the US, approved medical "edible" chips</a></li>
<li><a href="../148916/index.html">Localization of mobile applications. Part 2</a></li>
<li><a href="../148918/index.html">Nokia is going to sell off Qt assets</a></li>
<li><a href="../148920/index.html">Meet the free and free font "Oranienbaum"</a></li>
<li><a href="../148924/index.html">LTE in the regions or we are also not lucky</a></li>
<li><a href="../148925/index.html">Results and statistics of the first Habrakamp</a></li>
<li><a href="../148926/index.html">We write a simple map using Nokia Maps JS API</a></li>
<li><a href="../148927/index.html">Visual Studio 2012 will be available on September 12</a></li>
<li><a href="../148928/index.html">Creating and registering the Metro style component for WinRT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>