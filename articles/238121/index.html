<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows Identity Foundation - for ASP.NET MVC projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to talk about how you can use the Windows Identity Foundation in your ASP.NET MVC projects, and write your Identity Serv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows Identity Foundation - for ASP.NET MVC projects</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/139/293/bb8/139293bb8ae64330bc46950a52c022f6.png"><br>  In this article, I would like to talk about how you can use the Windows Identity Foundation in your ASP.NET MVC projects, and write your Identity Server on a WIF platform.  Firstly, because there is enough general information on the Internet, but when it comes to specifics, problems arise.  Since the ideology and particular cases can still be found, but when it comes to specifics, you have to collect bit by bit.  And secondly, what Microsoft is now offering, using add-ons on Visual Studio, is not quite good, I would even say, is completely inappropriate when developing solutions that are more complicated than a home page or a business card site.  Among other things, I don‚Äôt really like it when the mythical configuration wizard did what it did with the solution, and said that ‚Äúit should work‚Äù. <br><a name="habracut"></a><br>  As an example, we will create, and configure, the most primitive client that will authenticate through the most primitive authorization server (Identity Server) working under the <a href="http://en.wikipedia.org/wiki/WS-Federation">WS-Federation</a> protocol. <br><br>  In order to decide in which cases it makes sense to ‚Äúmake a fuss‚Äù with your authorization server, just look at how it works.  So, we want to provide the client with several services, for example, several sites, for example with WCF services, and let's say REST API.  Agree that it will be quite uncomfortable for the user to separately log in to each of our sites when switching from one to another.  There is a rather simple idea, which is that when a user is authorized on one of the services (resources), a certain Token is issued.  And later, another, or the same, service (resource) already trusts the authorized user, based on the client‚Äôs existence of this very token, and so on ... <br><br>  Just for clarity of understanding, I will give the comparison you like (unfortunately I found references to it).  For example, a person receives a passport, after a certain verification procedure, and later, when submitting his passport, a person is trusted, based on his passport.  In this comparison, the person‚Äôs passport is the client's token. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We can immediately conclude that it is often meaningless to issue a ‚Äúpassport‚Äù if it will be checked only in one place. <br><br>  Of course, the token, like the passport, has a lifetime, and in the same way, the token can be recreated, based on the obsolete one.  And by analogy, like a passport, a token can be different, i.e.  to be almost anything, either it is a request header or a base64 string, such as JWT Token ( <a href="http://angular-tips.com/blog/2014/05/json-web-tokens-introduction/">JSON Web Token</a> ).  And in fact, the token itself contains information about itself (the time when it was created last time, the public key of the certificate, etc.), as well as a list of stamps containing information about the client.  To describe the token, we will use the SAML ( <a href="http://en.wikipedia.org/wiki/Security_Assertion_Markup_Language">Security Assertion Markup Language</a> ) <a href="http://en.wikipedia.org/wiki/Security_Assertion_Markup_Language">language</a> . <br><br>  Another important concept is the claims.  Brands are part of our token, and carry information about the client as a whole.  Actually, this is a dictionary consisting of a Key / Value pair, in which Key is a namespace describing the type of the Value field, and the Value field itself is a simple string.  In .Net this is represented by a typed list: <br><br><pre><code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimsList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">List</span></span>&lt;Claim&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"</span></span>, <span class="hljs-string"><span class="hljs-string">"Tester"</span></span>) };</code> </pre> <br>  There are a number of registered neymspeysov, which is more than enough to describe the client profile, from the list of roles to avatars.  If desired, we can create our own namespaces, the only thing to remember is that the object itself Claim, must be serialized. <br><br>  From here you can probably make two main conclusions, the first is that for simply authorizing a user on the site, using Identity Server is simply unjustified, and the second is that since we are going to transfer a token between different resources, we will need transport security in the first place.  And so we will start, and perhaps we will begin with setting up the transport, because if we don‚Äôt have a trusted transport, we simply won‚Äôt be able to work anything, and for this, first of all, we will need a certificate. <br><br><h3>  Creating a certificate </h3><br>  Approximately from this point on, many developers have questions about creating a certificate, setting up HTTPS on the server, and so on.  To work and debug, we need the IIS installed locally, a simple ASP.NET MVC application that will be our client site, and a trusted certificate.  We need not just a certificate, but a certificate issued for any domain name, to buy it, for testing purposes is not economically profitable, so we will make it ourselves. <br><br>  For example, the domain name that we will use for testing purposes will be <b>identity.com</b> .  First, to create a certificate, we use the <b>makecert</b> utility. <br><pre> <code class="hljs pgsql">makecert -r -n "CN=*.identity.com" -cy authority -b <span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">2000</span></span> -e <span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">2099</span></span> -a sha1 -sr localMachine -sky Exchange -sp "Microsoft RSA SChannel Cryptographic Provider" -sy <span class="hljs-number"><span class="hljs-number">12</span></span> -sv <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span>.com.pvk <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span>.com.cer</code> </pre><br>  As a result of the execution, we will get two <b>identity.com.pvk</b> and <b>identity.com.cer</b> files. This is all very clear, and <b>there is</b> more than enough information on the <b>makecert</b> utility.  The only point that I would like to dwell on in more detail is the CN for which we issue the certificate.  If you issue a certificate just for <b>identity.com</b> , then, in the future, it will be inconvenient to locally model the situation with distributed resources, but using <b>*</b> greatly simplifies our task ie  <b>* .identity.com</b> .  Using <b>*</b> allows us to locally create an arbitrary number of domains like <b>‚Äúany name‚Äù .identity.com</b> . <br><br>  Next, to verify the publisher's certificate, we use the <a href="http://msdn.microsoft.com/en-us/library/f657tk8f(v%3Dvs.110).aspx">cert2spc</a> utility. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">cert2spc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">identity</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">identity</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.spc</span></span></code> </pre><br>  And as a result, we get the <b>identity.com.spc</b> file, which we need for the <b>pvk2pfx</b> utility.  With the help of which we will generate the <b>pfx</b> file we <b>need</b> . <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">pvk2pfx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-pvk</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">identity</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pvk</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-spc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">identity</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.spc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-pfx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">identity</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pfx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-pi</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">qwerty</span></span>"</code> </pre><br>  As a result, we received an identity.com.pfx file containing a private key with the password qwerty.  It remains to register it IIS and in the system. <br><br><h3>  HTTPS setup </h3><br>  In order for our IIS server to start working with our certificate, first, we need to import our pfx file into the Trusted Root Certification Authorities zone through the MMC snap-in, and perform the Import in the IIS server itself, in the Server Certificates section. <br><br>  Now everything is ready for setting up our client site.  To do this, create a new site in IIS, with the name client.identity (in other matters, no matter what), the main thing is that the App Pool of our site works under .Net 4.0 (this is if the site is compiled under .Net 4.0, 4.5).  And we point the Physical path to the directory of our client site. <br><img src="https://habrastorage.org/files/d53/42d/46a/d5342d46ac23481f9f5268839cf0fcc1.png"><br>  Next, set up our HTTPS, in the Binding section.  After selecting https in the type field, we need to select our generated certificate, and only after that the Host name field becomes available for editing.  If we generated the certificate with " <b>*</b> ", then we can indicate almost any name of our site, the main thing would be to end with <b>identity.com</b> , i.e.  the name of our test domain.  Further we can change our bindings in the Bindings section of our site.  Only the last ‚Äústroke‚Äù remains, so change the hosts file along the path (c: \ Windows \ System32 \ drivers \ etc \) and add a line with the name of our site binding: <br><pre> <code class="hljs css">127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">client</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.identity</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code> </pre><br>  Everything, you can check the work of the local https, just to the address: <i><a href="https://client.identity.com/">client.identity.com</a></i> . <br><img src="https://habrastorage.org/files/934/a7a/adb/934a7aadb02740d1922868e5f02a297e.png"><br>  As a result, we should see our web application, and in the address bar, the fact that our certificate is trusted, i.e.  no browser warnings. <br><br>  If you download IdentityTrainingKitVS2010 from the Microsoft site, you can make your life a little easier by running SetupCertificates.cmd, for example, following the path IdentityTrainingKitVS2010 \ Labs \ MembershipAndFederation \ Source \ Setup \ Scripts \ SetupCertificates.cmd <br><br>  This script will do almost the same thing, only for the already prepared certificate from the examples localhost.pfx (it has the password xyz).  Accordingly, access to the site (for example, Default Web Site) will work through localhost, and all your applications that need to work via https should be created either as a Web Site, but as a Web Application, under a localhost site. <br><br><h3>  Configuring the client application </h3><br>  Now we need to make some customization of our client application.  To begin with, in the project settings, set the address of our site for the Custom Web Server field. <br><img src="https://habrastorage.org/files/082/973/cc3/082973cc323d48bc91e842432516b729.png"><br>  This will give Visual Studio the opportunity, at startup, to automatically do Attach to Process to the w3wp.exe process (IIS site process). <br><br>  Now, we need to deal with the references of our site, and add two assemblies from GAC, <b>System.IdentityModel.dll</b> and <b>System.IdentityModel.Services.dll</b> .  As well as removing unnecessary, what will disturb us is NUget DotNetOpenAuth packages, we will not need them, but will only interfere, and for this, you need to remove the <b>Microsoft.AspNet.WebPages.OAuth</b> package.  If, for some reason, you do not want to touch them, then as an option, is to set up registration in web.config. <br><br>  And the last step in setting up the client application is setting up the web.config itself.  First, in the sysytem.web section, set the authentication method to none. <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">authentication</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"None"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  Next, register our section for the Identity Model in the configSections section: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"system.identityModel"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.IdentityModel.Configuration.SystemIdentityModelSection, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"system.identityModel.services"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Add and configure these sections, first system.identityModel: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.identityModel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">identityConfiguration</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">saveBootstrapContext</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">audienceUris</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://client.identity.com/"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">audienceUris</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">issuerNameRegistry</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.IdentityModel.Tokens.ConfigurationBasedIssuerNameRegistry, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">trustedIssuers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">thumbprint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BDB8FF11361F312C06EDF1D20B05E775A123BE22"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://server.identity.com/issue/wsfed"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">trustedIssuers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">issuerNameRegistry</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">certificateValidation</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">certificateValidationMode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"None"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">identityConfiguration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.identityModel</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  To begin with, in the audienceUris section, add the address of our client site, then add an entry in the trustedIssuers section, where the thumbprint is the Thumbprint value from our generated <b>identity.crt</b> file, or another transport certificate the server will work on. <br><img src="https://habrastorage.org/files/6cd/1cf/9ea/6cd1cf9eaee84abe8cf95182eeaabf2b.png"><br>  Only without spaces.  And the name field is the address of our future server, for example, in our case <a href="https://server.identity.com/">server.identity.com</a> + / issue / wsfed.  It is not necessary to use wsfed, especially in our case a future server - it could be anything.  Just wsfed is short for <a href="http://en.wikipedia.org/wiki/WS-Federation">WS-Federation</a> . <br>  Next, add the system.identityModel.services section: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.identityModel.services</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">federationConfiguration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cookieHandler</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">requireSsl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wsFederation</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">passiveRedirectEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">issuer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://server.identity.com/issue/wsfed"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">realm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://client.identity.com/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">reply</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://client.identity.com/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">requireHttps</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">federationConfiguration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.identityModel.services</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Everything is simple enough, iisuer is our server from the section above, and reply is where the address is, then reply to the server. <br><br>  It remains to register the modules in the system.webServer section. <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WSFederationAuthenticationModule"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.IdentityModel.Services.WSFederationAuthenticationModule, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">preCondition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"managedHandler"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SessionAuthenticationModule"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.IdentityModel.Services.SessionAuthenticationModule, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">preCondition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"managedHandler"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modules</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Everything, it is possible to check the work of our client, it is enough to try with View to call any method or method of the controller marked with the Authorize attribute. <br><br>  After starting the application (by F5), and the user tries to call our method, we will see a GET request to the address of our future server: <br><pre> <code class="bash hljs">https://server.identity.com/issue/wsfed?wa=wsignin1.0&amp;wtrealm=https%3a%2f%2fclient.identity.com%2f&amp;wctx=rm%3d0%26id%3dpassive%26ru%3d%252fAccount&amp;wct=2014-09-23T13%3a36%3a21Z&amp;wreply=https%3a%2f%2fclient.identity.com%2f</code> </pre><br>  This is an authorization request from the client to the server at <a href="https://server.identity.com/issue/wsfed">server.identity.com/issue/wsfed</a> . <br><br>  The above is quite enough for minimal configuration of a client application working with WIF Identity Server, even if you use a third-party server, the main thing is for the server to support <a href="http://en.wikipedia.org/wiki/WS-Federation">WS-Federation</a> . <br><br><h3>  Server creation </h3><br>  Before you start creating an Identity server, you need to mention such a thing as STS ( <a href="http://en.wikipedia.org/wiki/Security_token_service">Security Token Service</a> ).  In fact, this is a service, and it does not matter in which language and platform it is written.  And our ASP.NET MVC Identity Server is essentially a UI shell.  To create our own STS, since we still use .Net, it will be convenient for us to use the tools that are in the platform. <br><br>  Our Identity Server, as well as the client, is essentially an ASP.NET MVC application, for which you also need to configure HTTPS, and, in our case, we will assign it a binding <a href="https://server.identity.com/">server.identity.com</a> using the same one generated by us certificate. <br><br>  Create a SignIn View for the SignIn method of the Account controller, and add an entry to the web.config: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">authentication</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Forms"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">forms</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">loginUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"~/Account/signin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">timeout</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2880"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">authentication</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  And add to routes, a record for the controller method that will be executed when accessing via the issue / wsfed path. <br><pre> <code class="hljs cs">routes.MapRoute(<span class="hljs-string"><span class="hljs-string">"wsfederation"</span></span>, <span class="hljs-string"><span class="hljs-string">"issue/wsfed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { controller = <span class="hljs-string"><span class="hljs-string">"WSFederation"</span></span>, action = <span class="hljs-string"><span class="hljs-string">"issue"</span></span> });</code> </pre><br>  This is the path our client &lt;&gt; / issue / wsfed addresses.  If we control the controller, mark it with the Authorize attribute, then the client application, when trying to log in, will first fall on the SignIn method of the Account controller, which in turn will return View, with the login form of our server. <br><br>  Next, the user enters the data required to enter (for example, login password), and falls on the Issue method.  Please note that RequestString does not change, but remains the same as the client application. <br><br>  In order for our server to understand what exactly the client wants from it, let's sort the query arguments: <br><pre> <code class="hljs pgsql"> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> ActionResult Issue() { WSFederationMessage message = WSFederationMessage.CreateFromUri(HttpContext.Request.Url); // Sign <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> var signinMessage = message <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SignInRequestMessage; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signinMessage != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ProcessWSFederationSignIn(signinMessage); } // Sign <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> var signoutMessage = message <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SignOutRequestMessage; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signoutMessage != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ProcessWSFederationSignOut(signoutMessage); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("Error"); }</code> </pre><br>  Accordingly, the WSFederationMessage.CreateFromUri method returns the instance of the heirs of the abstract class WSFederationMessage.  Next, perform actions, or login, or exit. <br><br>  When logging in via the WS-Federation protocol, we run the static method: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">FederatedPassiveSecurityTokenServiceOperations</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ProcessSignInRequest</span></span></code> </pre><br>  This method, based on the received instance of the SignInRequestMessage class, and the list of stamps (Claims), will form some RequestSecurityToken object, which is essentially our client token, and will give it to the GetScope method of our STS service.  To create our STS service, we will inherit from the SecurityTokenService abstract class: <br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TokenService</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SecurityTokenService</span></span></span></span></code> </pre><br>  and block the GetScope method: <br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Scope </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetScope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ClaimsPrincipal principal, RequestSecurityToken request</span></span></span><span class="hljs-function">)</span></span></code> </pre><br>  it is in this method that the requestSecurityToken.T. object will be analyzed or populated.  directly the formation itself, and the verification of the client token.  I simply see no point in describing the whole test, since the easiest way to go through the debugging method is because there is nothing trivial in the method. <br><br>  In principle, the above described in its very minimum is enough to get a primitive Identity Server through which the client can log in. <br><br>  If it will be interesting how this all works, I ‚Äúglued together‚Äù a simplified client and server, on <a href="https://github.com/valkovnet/IdentityServer">github</a> . <br>  This is just a lightweight version of the server <a href="">https://github.com/thinktecture/Thinktecture.IdentityServer.v2</a> , collected so far, for the moment, for demonstration purposes and nothing more, and of course does not hold water. <br><br><h3>  Finally </h3><br>  What I would like, personally, I get as a result, so this is a full-fledged Identity Server, in which all work with the user profile is moved  login, registration, social network, view your profile, etc.  Accordingly, with the proper level of security.  But in fact, that the server itself could be connected to the resource being developed, and each time not to spend time on the authorization system.  And of course, I would like to integrate server operation, with WCF and REST services, with distribution of access to methods according to client roles.  But this is only in the plans. <br><br><h3>  useful links </h3><br>  What is the Windows Identity Foundation: <a href="http://msdn.microsoft.com/ru-ru/library/ee748475.aspx">http://msdn.microsoft.com/ru-ru/library/ee748475.aspx</a> <br>  Sources of several Identity servers and useful libraries: <a href="https://github.com/thinktecture">https://github.com/thinktecture</a> <br>  A good report on Claims-based authorization: <a href="https://www.youtube.com/watch%3Fv%3DWHSDIiwQlS8">https://www.youtube.com/watch?v=WHSDIiwQlS8</a> <br>  More examples: <a href="http://claimsid.codeplex.com/">http://claimsid.codeplex.com</a> <br>  And the codeproject: <a href="http://www.codeproject.com/Articles/504399/Understanding-Windows-Identity-Foundation-WIF">http://www.codeproject.com/Articles/504399/Understanding-Windows-Identity-Foundation-WIF</a> </div><p>Source: <a href="https://habr.com/ru/post/238121/">https://habr.com/ru/post/238121/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238109/index.html">Monitoring the availability of servers from Infobox</a></li>
<li><a href="../238113/index.html">The problems of high-frequency trading are deeper than it seems</a></li>
<li><a href="../238115/index.html">Seven A / B tests, without which not a single good email newsletter can do</a></li>
<li><a href="../238117/index.html">uLogin, as a means of cheating customers likes</a></li>
<li><a href="../238119/index.html">As it turned out, everyone knows, but not everyone understands. Transactions in mysql and SELECT FOR UPDATE</a></li>
<li><a href="../238123/index.html">Do it yourself! Kite Aerial Kite Aerial Photography</a></li>
<li><a href="../238125/index.html">The Martian orbital satellites MAVEN and Mangalyaan transmitted the first photos of Mars</a></li>
<li><a href="../238127/index.html">Controlled Internet: is the devil so scary how it is painted?</a></li>
<li><a href="../238129/index.html">Analysis of existing approaches to face recognition</a></li>
<li><a href="../238131/index.html">folly :: fbvector - improved std :: vector from Facebook</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>