<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Incorrect use of atoms and the elusive bug in VCL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bug finder 
 I was tormented by a bug for a long time, due to the inadequate behavior of the Delphi controls after a long uptime of the system and int...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Incorrect use of atoms and the elusive bug in VCL</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/126/f63/314/126f633143ba7a5cb18e518876963848.gif" alt="image" align="left"><br><h4>  Bug finder </h4><br>  I was tormented by a bug for a long time, due to the inadequate behavior of the Delphi controls after a long uptime of the system and intensive debugging.  The lists ceased to be updated, the buttons were pressed, the input fields began to lose focus.  And everything was sad, and restarting the IDE did not help.  Moreover, after restarting the IDE - it itself began to fail as well.  I had to reboot. <br>  Today it got me, and I began to look for her.  I must say no avail. <br>  Having pledged window messages, I began to analyze what went wrong. <a name="habracut"></a><br>  It turned out that there are such lines in the module Control.pas: <br><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindControl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Handle: HWnd)</span></span></span><span class="hljs-function">:</span></span> TWinControl; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> OwningProcess: DWORD; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Handle &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (GetWindowThreadProcessID(Handle, OwningProcess) &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (OwningProcess = GetCurrentProcessId) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> GlobalFindAtom(PChar(ControlAtomString)) = ControlAtom <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Result := Pointer(GetProp(Handle, MakeIntAtom(ControlAtom))) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Result := ObjectFromHWnd(Handle); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  and <i>GetProp (Handle, MakeIntAtom (ControlAtom))</i> always returns 0. Then it turned out that <i>ControlAtom</i> is 0 for some reason, and <i>GlobalFindAtom (PChar (ControlAtomString))</i> also returns 0. <br>  <i>ControlAtomString</i> and <i>ControlAtom are initialized</i> in the <i>InitControls</i> procedure, which is called in the module initialization section: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitControls</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> UserHandle: HMODULE; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-meta"><span class="hljs-meta">{$IF NOT DEFINED(CLR)}</span></span> WindowAtomString := Format(<span class="hljs-string"><span class="hljs-string">'Delphi%.8X'</span></span>,[GetCurrentProcessID]); WindowAtom := GlobalAddAtom(PChar(WindowAtomString)); ControlAtomString := Format(<span class="hljs-string"><span class="hljs-string">'ControlOfs%.8X%.8X'</span></span>, [HInstance, GetCurrentThreadID]); ControlAtom := GlobalAddAtom(PChar(ControlAtomString)); RM_GetObjectInstance := RegisterWindowMessage(PChar(ControlAtomString)); <span class="hljs-meta"><span class="hljs-meta">{$IFEND}</span></span></code> </pre> <br>  <i>ControlAtomString is</i> filled correctly, but <i>ControlAtom is</i> filled with zero.  There are no checks for errors here, so this came back much later, alas.  If you insert <i>GetLastError</i> after <i>GlobalAddAtom</i> , it will return <i>ERROR_NOT_ENOUGH_MEMORY</i> .  And if you also carefully read the remark on MSDN to <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms649060(v%3Dvs.85).aspx">GlobalAddAtom</a> , then you will notice: <br><blockquote>  Global atoms are not automatically deleted when the application terminates.  For the GlobalAddAtom function, there is a corresponding call to the GlobalDeleteAtom function. </blockquote><br><br>  Everything at once becomes clear.  If it is incorrect to terminate the application, then global atoms will leak.  And the cat wept at the named atoms: 0xC000-0xFFFF, that is, only 16383. That is,  each dll, and each exe-shnik written in Delphi using VCL with incorrect completion leaves the leaked global atoms behind.  To be more precise - then 2-3 atoms for each instance: <br>  <b>ControlAtom</b> and <b>WindowAtom</b> in Controls.pas, and <b>WndProcPtrAtom</b> in Dialogs.pas <br><br><h4>  Workaround </h4><br>  View created atoms is not difficult.  Here is the code for a simple application listing global string atoms: <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">program</span></span> EnumAtomsSample; <span class="hljs-meta"><span class="hljs-meta">{$APPTYPE CONSOLE}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> Windows, SysUtils; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAtomName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(nAtom: TAtom)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n: Integer; tmpstr: <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> [<span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">255</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> Char; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> n := GlobalGetAtomName(nAtom, PChar(@tmpstr[<span class="hljs-number"><span class="hljs-number">0</span></span>]), <span class="hljs-number"><span class="hljs-number">256</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Result := <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Result := tmpstr; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnumAtoms</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; s: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := MAXINTATOM <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> MAXWORD <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> s := GetAtomName(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s &lt;&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> WriteLn(s); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> EnumAtoms; ReadLn; <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> E: Exception <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Writeln(E.ClassName, <span class="hljs-string"><span class="hljs-string">': '</span></span>, E.<span class="hljs-keyword"><span class="hljs-keyword">Message</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  You can make sure that atoms flow by running any VCL project, and nailing it through the task manager. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since the atoms are global, we can nail them regardless of who they were created by.  It remains to somehow learn to determine that the atom is leaked. <br>  If you pay attention to the names of atoms, then for <br>  WndProcPtrAtom is WndProcPtr [HInstance] [ThreadID] <br>  ControlAtom is ControlOfs [HInstance] [ThreadID] <br>  WindowAtom is Delphi [ProcessID] <br>  In all cases, we can understand that the atom is most likely created by Delphi by the specific prefix + one or two 32-bit numbers in HEX-e.  In addition, either ProcessID or ThreadID is recorded in the HEX.  We can easily check there is such a process or flow in the system.  If not, then we have a clearly leaked atom, and we can risk releasing it.  Yes, yes, take a chance.  The fact is that after we made sure that there is no thread / process with such an ID, and we are going to delete an atom, this process can appear, with exactly the same ID, and turn out to be a Delphi process.  If in the interval between checking and deleting this happens, we will kill the atom in a valid application.  The situation is extremely unlikely, because in the interval between the check, a Delphic process must be created, it must be exactly the same ID, and you must have time to initialize your atoms.  I do not see any other workarounds (without editing the VCL code) to solve this problem. <br><br>  I wrote a console tool for cleaning such leaked global atoms. <div class="spoiler">  <b class="spoiler_title">Here is the code for this tool:</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">program</span></span> AtomCleaner; <span class="hljs-meta"><span class="hljs-meta">{$APPTYPE CONSOLE}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> Windows, SysUtils; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> THREAD_QUERY_INFORMATION = $<span class="hljs-number"><span class="hljs-number">0040</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenThread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dwDesiredAccess: DWORD; bInheritHandle: BOOL; dwThreadId: DWORD)</span></span></span><span class="hljs-function">:</span></span> THandle; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> kernel32; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ThreadExists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ThreadID: Cardinal)</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> h: THandle; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> h := OpenThread(THREAD_QUERY_INFORMATION, False, ThreadID); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> h = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := False; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := True; CloseHandle(h); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryHexChar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c: Char; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b: Byte)</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := True; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>..<span class="hljs-string"><span class="hljs-string">'9'</span></span>: b := Byte(c) - Byte(<span class="hljs-string"><span class="hljs-string">'0'</span></span>); <span class="hljs-string"><span class="hljs-string">'a'</span></span>..<span class="hljs-string"><span class="hljs-string">'f'</span></span>: b := (Byte(c) - Byte(<span class="hljs-string"><span class="hljs-string">'a'</span></span>)) + <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-string"><span class="hljs-string">'A'</span></span>..<span class="hljs-string"><span class="hljs-string">'F'</span></span>: b := (Byte(c) - Byte(<span class="hljs-string"><span class="hljs-string">'A'</span></span>)) + <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Result := False; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryHexToInt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value: Cardinal)</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; chval: Byte; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := True; value := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Length(s) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> TryHexChar(s[i], chval) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := False; <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; value := value <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>; value := value + chval; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAtomName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(nAtom: TAtom)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n: Integer; tmpstr: <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> [<span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">255</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> Char; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> n := GlobalGetAtomName(nAtom, PChar(@tmpstr[<span class="hljs-number"><span class="hljs-number">0</span></span>]), <span class="hljs-number"><span class="hljs-number">256</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Result := <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Result := tmpstr; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloseAtom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(nAtom: TAtom)</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n: Integer; s: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := False; s := GetAtomName(nAtom); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> s = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; WriteLn(<span class="hljs-string"><span class="hljs-string">'Closing atom: '</span></span>, IntToHex(nAtom, <span class="hljs-number"><span class="hljs-number">4</span></span>), <span class="hljs-string"><span class="hljs-string">' '</span></span>, s); GlobalDeleteAtom(nAtom); Result := True; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessAtom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(nAtom: TAtom)</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; n: Integer; id: Cardinal; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := False; s := GetAtomName(nAtom); n := Pos(<span class="hljs-string"><span class="hljs-string">'ControlOfs'</span></span>, s); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Delete(s, <span class="hljs-number"><span class="hljs-number">1</span></span>, Length(<span class="hljs-string"><span class="hljs-string">'ControlOfs'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Length(s) &lt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; Delete(s, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> TryHexToInt(s, id) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ThreadExists(id) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>(CloseAtom(nAtom)); <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; n := Pos(<span class="hljs-string"><span class="hljs-string">'WndProcPtr'</span></span>, s); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Delete(s, <span class="hljs-number"><span class="hljs-number">1</span></span>, Length(<span class="hljs-string"><span class="hljs-string">'WndProcPtr'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Length(s) &lt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; Delete(s, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> TryHexToInt(s, id) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ThreadExists(id) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>(CloseAtom(nAtom)); <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; n := Pos(<span class="hljs-string"><span class="hljs-string">'Delphi'</span></span>, s); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Delete(s, <span class="hljs-number"><span class="hljs-number">1</span></span>, Length(<span class="hljs-string"><span class="hljs-string">'Delphi'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Length(s) &lt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> TryHexToInt(s, id) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> GetProcessVersion(id) = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> GetLastError = ERROR_INVALID_PARAMETER <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>(CloseAtom(nAtom)); <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnumAndCloseAtoms</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> i := MAXINTATOM; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> i &lt;= MAXWORD <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ProcessAtom(i) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Inc(i); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> EnumAndCloseAtoms; <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> E: Exception <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Writeln(E.ClassName, <span class="hljs-string"><span class="hljs-string">': '</span></span>, E.<span class="hljs-keyword"><span class="hljs-keyword">Message</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br></div></div><br>  Just run, leaking atoms cleaned.  Check, maybe right now you have leaked atoms in the system. <br><br><h4>  Finally </h4><br>  Code inspection has shown that these global atoms are used only for <i>SetProp</i> and <i>GetProp</i> functions.  It is completely incomprehensible why the Delphi developers decided to use atoms.  After all, both of these functions work fine with pointers to strings.  It is enough to pass a unique string, which itself already exists, because the atom is initialized with it. <br>  The logic of such comparisons in the VCL code is also incomprehensible: <br>  <i>if GlobalFindAtom (PChar (ControlAtomString)) = ControlAtom then</i> <br>  Both variables are initialized in the same place.  The string is going to be unique (from HInstance and ThreadID).  Verification will always return true.  Alas, Delphi is now promoting new features, FMX-s all.  It is unlikely that they will fix this bug.  Personally, I don't even have the desire to report on QC, knowing how it is fixed.  But to live with this somehow necessary.  Those interested can execute the code of the above tool when starting their application.  In my opinion, this is better than waiting for leaked atoms. <br>  Well, in our own development, you should try to avoid global atoms, because the OS does not control their leakage. <br><br>  <a href="">Tulsa + source</a> </div><p>Source: <a href="https://habr.com/ru/post/217189/">https://habr.com/ru/post/217189/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217175/index.html">Notch refused to release Minecraft for Oculus Rift</a></li>
<li><a href="../217179/index.html">Visualization of personal expenses</a></li>
<li><a href="../217183/index.html">Translation and dubbing video MARS ONE WAY</a></li>
<li><a href="../217185/index.html">Qqt - syntactic sugar for Qt</a></li>
<li><a href="../217187/index.html">Results of the past months: Seed, Oriense-1, OrPI, OrCC, StartupCup, Technopark</a></li>
<li><a href="../217193/index.html">3d terrain on 3d printer</a></li>
<li><a href="../217195/index.html">IBM provides developers with free access to Power Systems servers in the cloud</a></li>
<li><a href="../217201/index.html">Debug Mail - an easy to use smtp server for developers</a></li>
<li><a href="../217203/index.html">Properties framework for Qt</a></li>
<li><a href="../217205/index.html">The logic of thinking. Subtotal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>