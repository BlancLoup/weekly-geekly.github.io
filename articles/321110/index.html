<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recursive multiple add IP to lock in the .htaccess file</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task. The web server in the home folder ~ / public_html in the usual way are the directories of various sites. In the same usual way, each .htaccess f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recursive multiple add IP to lock in the .htaccess file</h1><div class="post__text post__text-html js-mediator-article">  <b>Task.</b>  The web server in the home folder ~ / public_html in the usual way are the directories of various sites.  In the same usual way, each .htaccess file is located in each site directory.  It is known that with the help of this file, <a href="http://htaccess.ru/info/ip-filtering/">access to IP is also limited</a> .  In my case, this file looks like this: <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> Allow,Deny Allow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> Deny <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">194.87</span></span><span class="hljs-number"><span class="hljs-number">.147</span></span><span class="hljs-number"><span class="hljs-number">.196</span></span></code> </pre> <br>  This record (block) is found in each .htaccess file of each site in the public_html folder only once.  And if you want to block access to all sites by IP, for example 194.165.16.76 - in each file, a new line is added after the line ‚ÄúAllow from all‚Äù: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Deny</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> 194<span class="hljs-selector-class"><span class="hljs-selector-class">.165</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.76</span></span></code> </pre> <br>  <b>Question: what to do when there are not 2 and not 3 sites on the server, but much more?</b> <br>  Here is how I tried to solve this problem. <br><a name="habracut"></a><br><h3>  Find command </h3><br>  <a href="http://www.opennet.ru/docs/RUS/linux_base/node149.html">The find command</a> will help us find all .htaccess files recursively, starting from the specified folder, if we execute the following from any location: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">find ~/public_html -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -name .htaccess</code> </pre> <br><h3>  Parameter ‚Äìexec </h3><br>  Next, we need to perform some file manipulations, namely: <br><br><ol><li>  Find the line "Allow from all" </li><li>  Insert after it the line "Deny from 194.165.16.76" </li></ol><br>  The ‚Äìexec parameter for the find command will help us in this.  In particular, I used the <a href="http://rus-linux.net/MyLDP/consol/sed.html">sed streaming editor</a> .  That is, for a particular case, the command helps me for a specific .htaccess file: <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">"/Allow from all/a Deny from 194.165.16.76"</span></span> .htaccess</code> </pre> <br>  Now, combine together find and sed: <br><br><pre> <code class="bash hljs">find ~/public_html -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -name .htaccess ‚Äì<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> sed -i <span class="hljs-string"><span class="hljs-string">"/Allow from all/a Deny from 194.165.16.76"</span></span> {} \;</code> </pre> <br>  By executing this command, bash will find all .haccess files and insert Deny from 194.165.16.76 into them immediately after Allow from all. <br><br><h3>  Bash script </h3><br>  Cut one part of the routine, Go ahead, trying to ensure that not to type the same long teams each time.  Create a ~ / addblacklistip file in the home folder with the following contents: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash me=`basename $0` if [[ $# -lt 2 ]]; then echo "Usage $me &lt;start_path&gt; &lt;IP_address&gt;" exit fi find $1 -type f -name .htaccess -exec sed -i "/Allow from all/a Deny from $2" {} \;</span></span></code> </pre> <br>  Next, execute the command: <br><br><pre> <code class="bash hljs">chmod +x ~/addblacklistip</code> </pre> <br>  Our script is ready to use.  For example, to add blocking by IP 7.7.7.7 to all .htaccess files, simply execute the command: <br><br><pre> <code class="bash hljs">~/addblacklistip ~/public_html 7.7.7.7</code> </pre> <br><h2>  Notes and Additions </h2><br><h3>  <font color="#cc0000">WHAT YOU DO - YOU DO AT YOUR OWN RISK!</font> </h3><br>  First, check all the commands and scripts that you run many times.  Especially when it comes to .htaccess files.  Secondly, do not be lazy to create a test daddy with subfolders and .htaccess files to check everything. <br><br><h3>  If your blocking section looks different ... </h3><br>  Add to the place where you would like to make new entries about blocking, a keyword, for example #Add next IP here.  It might look like this: <br><br><pre> <code class="bash hljs">Order Allow,Deny Allow from all Deny from 194.87.147.196 <span class="hljs-comment"><span class="hljs-comment">#Add next IP here Deny from 194.87.147.196</span></span></code> </pre> <br>  And in the script line: <br><br><pre> <code class="bash hljs">find <span class="hljs-variable"><span class="hljs-variable">$1</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -name .htaccess -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> sed -i <span class="hljs-string"><span class="hljs-string">"/Allow from all/a Deny from </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$2</span></span></span><span class="hljs-string">"</span></span> {} \;</code> </pre> <br>  replace with line: <br><br><pre> <code class="bash hljs">find <span class="hljs-variable"><span class="hljs-variable">$1</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -name .htaccess -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> sed -i <span class="hljs-string"><span class="hljs-string">"/#Add next IP here/a Deny from </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$2</span></span></span><span class="hljs-string">"</span></span> {} \;</code> </pre> <br>  Now new blocking entries will appear after the key entry #Add next IP here. <br><br><h3>  If all sites are not in the ~ / public_html folder, but in ~ / www? </h3><br>  Just execute the script with the following parameters: <br><br><pre> <code class="bash hljs">~/addblacklistip ~/www 7.7.7.7</code> </pre> <br>  where 7.7.7.7 is the blocked IP. <br><br><h3>  If I have a lot of IP to add? </h3><br>  How much?  There is a separate topic for the analysis of the issue and further automation. </div><p>Source: <a href="https://habr.com/ru/post/321110/">https://habr.com/ru/post/321110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321100/index.html">DUMP-2017: the new season. We meet on April 14 in Yekaterinburg</a></li>
<li><a href="../321102/index.html">"Clock Signal Component Issue" or again a massive marriage in Cisco devices</a></li>
<li><a href="../321104/index.html">Node.js, Express and MongoDB: API in half an hour</a></li>
<li><a href="../321106/index.html">Data Oriented Design in practice</a></li>
<li><a href="../321108/index.html">We start the gas flow rate sensor</a></li>
<li><a href="../321112/index.html">Osiris - the new reincarnation of the Locky Trojan</a></li>
<li><a href="../321114/index.html">The deadline of the Stepik Contest contest is extended until March 31, it's time to create IT tasks</a></li>
<li><a href="../321116/index.html">[Free pizza] Hacking a pizza delivery site, hacking mobidel.ru</a></li>
<li><a href="../321118/index.html">"There is nowhere less": scientists from IBM have stored information in the atom</a></li>
<li><a href="../321120/index.html">"100,000 times faster": ultra-short light pulses in computing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>