<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A few words about vSphere vFRC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starting with vSphere 5.5, a feature such as vFRC appeared in the VMWare vSphere Enterprise Plus license. 
 What is it and for what? 
 vFRC - vFlash R...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A few words about vSphere vFRC</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/01c/49b/be9/01c49bbe936da4e837d07c486fdabb52.jpg" alt="image"><br><a name="habracut"></a><br>  Starting with vSphere 5.5, a feature such as vFRC appeared in the VMWare vSphere Enterprise Plus license. <br>  What is it and for what? <br>  vFRC - vFlash Read Cashe is the function of caching read operations of the virtual machine disk to the local SSD drive of the virtualization host. <br>  That is, insert the SSD drive in the ESXi host.  in the host settings, add this disk (s) to the vFRC pool, go to the properties of the virtual machine, and for each of its disks, if necessary, add the necessary size vFRC.  For example, a disk at VM on 100 GB, added vFRC on 20 GB.  Got some kind of hybrid drive.  All write operations go to the main one, and all read operations are cached on the vFRC SSD mirror.  According to a certain statistical algorithm, the most frequent read requests blocks remain in this cache.  When migrating a VM to a neighboring vFRC host, the disk data of this VM is also transferred to the FRC pool of the new host.  If there is no vFRC pool there, or there is not enough space in it, then vFRC is disabled for such a machine.  The operation of this rule has the ability to customize. <br><br>  I have long wanted to test this technology and now, finally, my hands have reached. <br>  A PNY 120 GB SSD (eMLC) was inserted into the ESXi host and configured as vFRC. <br>  An attempt to test in the forehead did not show good results.  IOMETER did not want to give an increase in IOPS. <br>  Began to study the issue and found that when connecting vFRC we have the ability to specify the size of the block that will be used for caching.  The default block size is 8 kilobytes.  The problem, as it turned out, was buried here. <br>  ESXi has tools for collecting and analyzing statistics on VM communication with a disk subsystem.  In the same place we can look at the statistics of circulation by blocks of various sizes.  An analysis of these statistics will show us the block size most often used by the system.  It all depends on the service that creates the disk load. <br><br><a name="vscsiStats"></a><br>  So, to view statistics using <b>vscsiStats</b> , <b>enable</b> SSH on the ESXi host and connect to the command line.  <i>I will make a reservation that part of the data in an article from google and documentation.</i> <br>  1.Watch the list of machines and disks they use on the host: <b>vscsiStats -l</b> <br>  2. Let's start collecting statistics on the disk of interest: <b>vscsiStats -s -w YYYYY -i XXXX</b> (Where YYYYY would have virtual machine GroupGand and XXXX its Virtual SCSI Disk handleID) <br>  3. Next, run the standard load and wait. <br>  4. <b>See</b> our stats: <b>vscsiStats -p ioLength -c -w YYYYY -i XXXX</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We get a printout of the form: <br>  min, 512 <br>  ‚Ä¢ max, 1052672 <br>  ‚Ä¢ mean, 18434 <br>  ‚Ä¢ count, 21150 <br>  ‚Ä¢ Frequency, Histogram Bucket Limit <br>  ‚Ä¢ 1576,512 <br>  ‚Ä¢ 1073,1024 <br>  ‚Ä¢ 539.2048 <br>  ‚Ä¢ 375.4095 <br>  ‚Ä¢ <b>5219</b> , <b>4096</b> <br>  ‚Ä¢ 428,8191 <br>  ‚Ä¢ 4246,8192 <br>  ‚Ä¢ 787.16383 <br>  ‚Ä¢ 1858.16384 <br>  ‚Ä¢ 3877,32768 <br>  ‚Ä¢ 62.49152 <br>  ‚Ä¢ 405,65535 <br>  ‚Ä¢ 155,65536 <br>  ‚Ä¢ 32,81920 <br>  ‚Ä¢ 324.131072 <br>  ‚Ä¢ 138,262144 <br>  ‚Ä¢ 9,524288 <br>  ‚Ä¢ 47,524288 <br>  Where the first column indicates the number of blocks (hits), and the second column indicates the size of these blocks.  We are looking for the largest number and we understand which block is the most popular among us.  In our particular case, this is 4 kilobytes. <br><img src="https://habrastorage.org/getpro/habr/post_images/8de/4a1/24a/8de4a124a94e3af42c8cece1aa2664a1.png" alt="image"><br><br>  <b>Finishing</b> statistics collection: <b>vscsiStats -x</b> <br>  And we change the size of the used block in the vFRC settings of the VM disk. <br><br>  Now, how to view vFRC job statistics?  In graphic form in any way.  Command line only.  Not convenient, probably in the future they will finish, because vSphere has a convenient and powerful graphical interface for working with statistics. <br><br>  All the same in the command line we are looking for a disk cache that serves our VM: <br>  <b>~ # esxcli storage vflash cache list</b> <br>  vfc-413278667-vfrc-test <br><br>  We look at its details: <br>  <b>~ # esxcli storage vflash cache get -c vfc-413278667-vfrc-test</b> <br>  World ID: 2299121 <br>  Cachename: vfc-413278667-vfrc-test <br>  Vmdkname: vfrc-test-flat.vmdk <br><br>  We look at the statistics: <br>  <b>~ # esxcli storage vflash cache stats get -c vfc-413278667-vfrc-test</b> <br><br>  Or reset the statistics: <br>  <b>~ # esxcli storage vflash cache stats reset -c vfc-413278667-vfrc-test</b> <br><br>  Fine.  Let's see how it works in reality. <br>  We cling to VM a new thick (Thick Eager Zeroed) disk for 5 gigabytes, we connect to it a vFRC disk, also for 5 gigabytes.  We create a cache of the most efficient working conditions.  The entire VM disk is covered in a read cache. <br><br>  Launch IOMETER and watch. <br>  64 threads, 1 worker, 4kb BS, 100% random, 100% read <br><br>  To begin with, we put a virtual machine disk on a storage system that provides 10,000 IOPS for random reading. <br>  IOMETER honestly shows them.  For a couple of minutes, nothing happens, but after IOPS numbers start to grow smoothly.  After 2 hours, they reach the level of 15.000 IOPS and this is limited.  It seems that we have reached the limit and all our data is cached. <br><img src="https://habrastorage.org/getpro/habr/post_images/12b/6fc/a63/12b6fca63f4dcf572e5089fc9ed37faa.png" alt="image"><br><br>  We check, go to the storage system and look at the IOPS that reach it. <br><img src="https://habrastorage.org/getpro/habr/post_images/9eb/530/1dc/9eb5301dcf4e1a234892976f8cf4b43a.png" alt="image"><br><br>  Yes, we see that about 1700 IOPS reach the VM disk.  Perhaps not 100% of the data is in the cache.  Perhaps this is a feature of the technology.  I can not argue. <br><br>  Next, we try to transfer the VM disk to a deliberately fast storage system, which provides guaranteed 60.000 IOPS for random reading. <br>  Everything is logical, we see only 16.000 IOPS.  the data is taken from vFRC, and not from the VM disk, otherwise we would get significantly larger IOPS. <br><img src="https://habrastorage.org/getpro/habr/post_images/ca7/d40/afc/ca7d40afc94fb83a7ed6859b4945257c.png" alt="image"><br><br>  For the final check, we transfer the VM disk to a deliberately slow stack, which gives no more than 200 IOPS for random reading (1 SATA 7.2k disk) <br>  We get 7.000 IOPS !!!  Great result for such a slow storage! <br><img src="https://habrastorage.org/getpro/habr/post_images/659/b12/454/659b124548f579011a2cbb9427488886.png" alt="image"><br><br>  What can we get from statistics? <br>  Enter the command and see: <br><img src="https://habrastorage.org/getpro/habr/post_images/b5f/197/6ff/b5f1976ff6f4b5e5fc5a79fafe73b059.png" alt="image"><br><br>  So, my opinion - statistics is no good.  Not only that the data it does not understand the mere mortal, as they are also taken from the ceiling.  Suppose the most interesting indicator, the percentage of hitting the cache, from the very beginning of the test was equal to 36, after which within 2 hours it went down to 32%.  Fake.  The remaining parameters are no better and have no relation to reality.  Personally, I rejected the statistics.  No good. <br>  The statistics of the vSphere itself is also oddity.  After connecting the vFRC, the statistics on transferring the amount of data for reading and writing all VM disks stops being saved.  That is, there is just zero.  The recording latency becomes about 50ms (although in reality it is not).  Such it is only displayed in the statistics.  Upgrading to vSphere 5.5-u2 did not correct the situation. <br><br>  What does the statistics on VM latency for reading from the vSphere graphical environment show us?  And everything is fine there: <br><img src="https://habrastorage.org/getpro/habr/post_images/83d/16b/f04/83d16bf0436a763c91cb58fdf0942551.png" alt="image"><br><br>  Excellent latency.  The effect of changing storage for the VM disk is not detected. <br><br>  A small conclusion: the technology is quite suitable and working.  Yes, there are some flaws, but they will probably be fixed, and you can use it now :) <br>  For greater efficiency, it is recommended to use a PCI-E SSD under vFRC.  PCI-E cards must be compatible with ESXi at the driver level. </div><p>Source: <a href="https://habr.com/ru/post/235785/">https://habr.com/ru/post/235785/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235773/index.html">In the footsteps of "Game of Thrones"</a></li>
<li><a href="../235777/index.html">WordPress 4.0 Benny Release</a></li>
<li><a href="../235779/index.html">September 13th - Programmer's Day (early congratulations)</a></li>
<li><a href="../235781/index.html">How are designers worse than musicians?</a></li>
<li><a href="../235783/index.html">Experience successful crowdfunding. Top 5 best projects Indiegogo</a></li>
<li><a href="../235789/index.html">Rust: how code can be both fast and secure. Stepan Koltsov's story in Yandex</a></li>
<li><a href="../235795/index.html">Android NDK: working with OpenSL ES</a></li>
<li><a href="../235799/index.html">Those who want to teach children to program and make games</a></li>
<li><a href="../235801/index.html">09.09.2014 | Autumn presentation of Apple's new products</a></li>
<li><a href="../235803/index.html">Containerization - new shared-hosting</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>