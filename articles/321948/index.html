<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Porting is a delicate matter: checking Far Manager for Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the popular file managers in the Microsoft Windows environment is Far Manager, who took the baton from Norton Commander, which was created for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Porting is a delicate matter: checking Far Manager for Linux</h1><div class="post__text post__text-html js-mediator-article">  One of the popular file managers in the Microsoft Windows environment is Far Manager, who took the baton from Norton Commander, which was created for DOS.  Far Manager makes it easy to work with the file system (creating, editing, viewing, copying, moving, searching, deleting files), and also expands the standard functionality (work with the network, archives, backup copies, etc.).  Recently, work has been done on porting Far Manager to Linux, and an alpha version has been released to date.  The PVS-Studio team could not ignore this event and decided to check the quality of the adapted code. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/653/5ce/b44/6535ceb440001a72c4d871694d28f6c9.png" alt="Picture 24"></div><a name="habracut"></a><br><h2>  A bit about Far Manager </h2><br>  Far Manager is a console file manager for operating systems of the Microsoft Windows family, focused on working with a keyboard.  FAR Manager inherits a two-window ideology, standard (default) colors and command system (keyboard control) from the well-known Norton Commander file manager and provides a convenient user interface for working with files (creating files and directories, viewing, editing, copying, renaming, deleting etc.). <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a5b/d2a/dd6/a5bd2add6414264bdf0645e1745a8e0b.png" alt="Figure 1 - Far Manager 2 on Windows (click on image to enlarge)"></div><p></p><br>  <font color="#999999"><i>Figure 1 - Far Manager 2 on Windows (click on image to enlarge)</i></font> <br><br>  The author of the program is Eugene Roshal.  The first version was released on September 10, 1996.  The latest version, to which Roshal had a hand, is dated June 23, 2000 (version 1.65).  In fact, since the development of the FAR Manager, the FAR Group has been involved.  The next release v1.70 is dated March 29, 2006.  On December 13, 2008, version 2.0 is released, the program has become free (open source) and distributed under a modified BSD license.  All Far versions from 1.70 to 2.0 have virtually no external differences, and do not require any additional efforts from the user to master the program when switching to the new version.  Since version 1.80, Unicode support has been added.  The latest released version is 3.0 dated November 4, 2016. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On August 10, 2016, the first test build of the <a href="https://github.com/elfmz/far2l">Far2l</a> file manager (Linux) was published.  At the moment, the assembly contains a built-in working terminal, as well as Align, AutoWrap, Colorer, DrawLine, Editcase, FarFTP, FarLng, MultiArc, NetBox, SimpleIndent, TmpPanel plugins.  The code is distributed under the GPLv2 license. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9c9/a15/478/9c9a154789ca797b7a418526ab18c607.png" alt="Figure 2 - Far Manager 2 on Linux (click on image to enlarge)"></div><p></p><br>  <font color="#999999"><i>Figure 2 - Far Manager 2 on Linux (click on image to enlarge)</i></font> <br><br><h2>  From words to deeds </h2><br>  After checking the project Far2l, 1038 general-purpose warnings were received.  The following diagram shows the distribution of warnings by confidence level: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/458/f8a/18f/458f8a18f54d7beaa591151ae1022bd3.png" alt="Figure 1 - Distribution of warnings by confidence (importance)"></div><p></p><br>  <font color="#999999"><i>Figure 1 - Distribution of warnings by confidence (importance)</i></font> <br><br>  We briefly comment on the diagram: 153 warnings of the High level, 336 warnings of the Medium level, 549 warnings of the Low level were received. <br><br>  Despite the rather large number of warnings, it is worth remembering that not every one of them is a real mistake.  After reviewing the report containing only warnings of the High and Medium level, I highlighted 250 cases, which are most likely real errors. <br><br>  If we take the levels High and Medium, it turns out that the percentage of false positives was about 49%.  In other words, every second warning reveals a defect in the code. <br><br>  Now let's determine the relative density of real errors found by the PVS-Studio analyzer.  The total number of lines of the source code (SLOC) is 538675. Therefore, the density will be equal to 0.464 errors per 1000 lines of code.  Someday we will collect these numbers and write a general article about the quality of the code of various projects. <br><br>  It should be noted that this indicator does not demonstrate the overall density of errors for the entire project - it can be more (the analyzer did not work on a real error) or less (the analyzer worked on the correct code).  As a rule, on other projects we get <i>the</i> greater density of errors found.  We can say that from the point of view of code quality, the porting was successful.  However, it is strongly recommended to correct the errors found, because they are far from harmless. <br><br><h2>  Test results </h2><br>  I want to warn you in advance that for readability, the code will be refactored.  Also, the article contains not all errors found during the test, but only the most interesting ones. <br><br><h3>  Copy paste </h3><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/83a/8e4/e4a/83a8e4e4a6285c34e50dd7abc9cdf4a2.png" alt="Picture 28"></div><p></p><br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V501/">V501</a> There are identical sub-expressions 'Key == MCODE_F_BM_GET' ||  operator.  macro.cpp 4819 <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> KeyMacro::GetKey() { .... DWORD Key = !MR ? MCODE_OP_EXIT : GetOpCode(MR, Work.ExecLIBPos++); .... <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (Key) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MCODE_F_BM_POP: { TVar p1, p2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Key == MCODE_F_BM_GET) VMStack.Pop(p2); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Key == MCODE_F_BM_GET <span class="hljs-comment"><span class="hljs-comment">// &lt;= || Key == MCODE_F_BM_DEL || Key == MCODE_F_BM_GET // &lt;= || Key == MCODE_F_BM_GOTO) { VMStack.Pop(p1); } .... } } }</span></span></code> </pre> <br>  The <i>Key</i> variable was twice compared with the constant <i>MCODE_F_BM_GET</i> .  This is probably a typo, and <i>Key</i> should be compared with some constant.  The analyzer found 3 more similar places: <br><br><ul><li>  <i>V501 There are identical sub-expressions '! StrCmpN (CurStr, L "! /", 2)' to the left and to the right of the '||'</i>  <i>operator.</i>  <i>fnparce.cpp 291</i> </li><li>  <i>V501 There are identical sub-expressions'! StrCmpN (CurStr, L "! = /", 3) 'to the left of the' ||</i>  <i>operator.</i>  <i>fnparce.cpp 291</i> </li><li>  <i>V501 There are identical sub-expressions "KEY_RCTRL"</i>  <i>operator.</i>  <i>keyboard.cpp 1830</i> </li></ul><br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V581/">V581</a> The conditional expressions of the 'if' are agreed alongside each other are identical.  Check lines: 267, 268. APIStringMap.cpp 268 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WINPORT</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GetStringType)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( DWORD type, LPCWSTR src, INT count, LPWORD chartype )</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count--) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = *src; WORD type1, type3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* C3_NOTAPPLICABLE */</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((c&gt;=<span class="hljs-number"><span class="hljs-number">0xFFE0</span></span>)&amp;&amp;(c&lt;=<span class="hljs-number"><span class="hljs-number">0xFFE6</span></span>)) type3 |= C3_FULLWIDTH; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if ((c&gt;=0xFFE0)&amp;&amp;(c&lt;=0xFFE6)) type3 |= C3_SYMBOL; // &lt;= .... } .... }</span></span></code> </pre> <br>  Apparently, the second condition was written on the principle of Copy-Paste and it is absolutely identical to the first.  However, if this was the intention, then the code can be simplified by removing the second condition: <br><br><pre> <code class="cpp hljs">.... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((c&gt;=<span class="hljs-number"><span class="hljs-number">0xFFE0</span></span>)&amp;&amp;(c&lt;=<span class="hljs-number"><span class="hljs-number">0xFFE6</span></span>)) type3 |= C3_FULLWIDTH | C3_SYMBOL; ....</code> </pre> <br>  The error found was far from the only one: <br><br><ul><li>  <i>V581 The conditional expressions of the 'if' are located alongside each other are identical.</i>  <i>Check lines: 272, 273. APIStringMap.cpp 273</i> </li><li>  <i>V581 The conditional expressions of the 'if' are located alongside each other are identical.</i>  <i>Check lines: 274, 275. APIStringMap.cpp 275</i> </li><li>  <i>V581 The conditional expressions of the 'if' are located alongside each other are identical.</i>  <i>Check lines: 6498, 6503. macro.cpp 6503</i> </li><li>  <i>V581 The conditional expressions of the 'if' are located alongside each other are identical.</i>  <i>Check lines: 1800, 1810. vmenu.cpp 1810</i> </li><li>  <i>V581 The conditional expressions of the 'if' are located alongside each other are identical.</i>  <i>Check lines: 3353, 3355. wrap.cpp: 3355</i> </li></ul><br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V523/">V523</a> The 'then' statement is equivalent to the 'else' statement.  Queque.cpp 358 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> FTP::AddToQueque(FAR_FIND_DATA* FileName, LPCSTR Path, BOOL Download) { .... <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *m; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Download) m = <span class="hljs-built_in"><span class="hljs-built_in">strrchr</span></span>(FileName-&gt;cFileName, <span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;= else m = strrchr(FileName-&gt;cFileName, '/'); // &lt;= .... }</span></span></code> </pre> <br>  I suspect that here the condition was written on the ‚ÄúCopy-Paste‚Äù principle: regardless of the <i>Download</i> value ( <i>TRUE</i> , <i>FALSE</i> ), the position of the last occurrence of the '/' character will be saved in the <i>m</i> pointer. <br><br><h3>  Indefinite behavior </h3><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/119/ef8/92e/119ef892e282a2048af006f6302d452a.png" alt="Picture 37"></div><p></p><br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V567/">V567</a> Undefined behavior.  The 'Item [FocusPos] -&gt; Selected' variable is used while being used between sequence points.  dialog.cpp 3827 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Dialog::Do_ProcessSpace() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Item[FocusPos]-&gt;Flags &amp; DIF_3STATE) (++Item[FocusPos]-&gt;Selected) %= <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= else Item[FocusPos]-&gt;Selected = !Item[FocusPos]-&gt;Selected; .... }</span></span></code> </pre> <br>  Here there is a clear undefined behavior: the variable <i>Item [FocusPos] -&gt; Selected is</i> changed twice in one sequence point (increment and modulo 3 division with assignment of the result). <br><br>  Another place with similar undefined behavior was found: <br><br><ul><li>  <i>V567 Undefined behavior.</i>  <i>The ':: ViewerID' variable</i>  <i>viewer.cpp 117</i> </li></ul><br>  <b>Analyzer warning</b> : V610 Undefined behavior.  Check the shift operator '&lt;&lt;'.  The size of the operand (wchar_t) * 8 'is the left operand.  RegExp.cpp 4467 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> rechar wchar_t #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RE_CHAR_COUNT (1 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; sizeof(rechar) * 8) int RegExp::Optimize() { .... for (op=code; ; op=op-&gt;next) { switch (OP.op) { .... case opType: { for (int i = 0; i &lt; RE_CHAR_COUNT; i++) // &lt;= { if (ISTYPE(i, OP.type)) { first[i]=1; } } break; } } .... } .... }</span></span></span></span></code> </pre> <br>  The essence of the error is as follows: in Linux, the <i>wchar_t</i> type is 4 bytes in size.  Consequently, a sign <i>int</i> (4 bytes) is shifted 32 bits to the left.  According to the C ++ 11 standard, if the left operand is a significant positive number, shifting left by N bits will result in undefined behavior if N is not less than the number of bits in the left operand.  The correct code will look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> rechar wchar_t #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RE_CHAR_COUNT (static_cast</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;int64_t&gt;(1) &lt;&lt; sizeof(rechar) * 8) int RegExp::Optimize() { .... for (int64_t i = 0; i &lt; RE_CHAR_COUNT; i++) { .... } .... }</span></span></span></span></code> </pre> <br>  Several more locations were found leading to unspecified behavior when shifting to the left: <br><br><ul><li>  <i>V610 Undefined behavior.</i>  <i>Check the shift operator '&lt;&lt;'.</i>  <i>The size of the operand (wchar_t) * 8 'is the left operand.</i>  <i>RegExp.cpp 4473</i> </li><li>  <i>V610 Undefined behavior.</i>  <i>Check the shift operator '&lt;&lt;'.</i>  <i>The size of the operand (wchar_t) * 8 'is the left operand.</i>  <i>RegExp.cpp 4490</i> </li><li>  <i>V610 Undefined behavior.</i>  <i>Check the shift operator '&lt;&lt;'.</i>  <i>The size of the operand (wchar_t) * 8 'is the left operand.</i>  <i>RegExp.cpp 4537</i> </li><li>  <i>V610 Undefined behavior.</i>  <i>Check the shift operator '&lt;&lt;'.</i>  <i>The size of the operand (wchar_t) * 8 'is the left operand.</i>  <i>RegExp.cpp 4549</i> </li><li>  <i>V610 Undefined behavior.</i>  <i>Check the shift operator '&lt;&lt;'.</i>  <i>The size of the operand (wchar_t) * 8 'is the left operand.</i>  <i>RegExp.cpp 4561</i> </li></ul><br><h3>  Wrong work with memory </h3><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/35f/cf5/576/35fcf5576ed518a90836a7378d30d60c.png" alt="Picture 41"></div><p></p><br><br>  Let's start a new section with a little warm-up.  I suggest trying to find the error yourself (the hint is in the <i>TreeItem :: SetTitle function</i> ). <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnicodeString</span></span></span><span class="hljs-class"> {</span></span> .... UnicodeString(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *lpwszData) { SetEUS(); Copy(lpwszData); } .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> wchar_t *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CPtr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_pData-&gt;GetData(); } <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_pData-&gt;GetData(); } .... } <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> UnicodeString FARString; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TreeItem</span></span></span><span class="hljs-class"> {</span></span> FARString strName; .... } TreeItem **ListData;</code> </pre><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TreeList::SetTitle() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetFocus()) { <span class="hljs-function"><span class="hljs-function">FARString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strTitleDir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">L"{"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *Ptr = ListData ? ListData[CurFile]-&gt;strName : <span class="hljs-string"><span class="hljs-string">L""</span></span>; .... } .... }</code> </pre> <br>  <b>Analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V623/">V623</a> Consider inspecting the '?:' Operator.  A temporary object of the UnicodeString type is being created and subsequently destroyed.  Check third operand.  treelist.cpp 2093 <br><br>  An obvious mistake, isn't it?  In the current context, the <i>ListData</i> variable <i>[CurFile] -&gt; strName</i> is an object of the <i>UnicodeString</i> class.  In the <i>UnicodeString</i> class, the implicit conversion operator is overloaded to the <i>const wchar_t * type</i> .  Now notice the ternary operator in the <i>TreeList :: SetTitle function</i> : the second and third operands are of different types ( <i>UnicodeString</i> and <i>const char [1],</i> respectively).  The implication was that if the first operand returns <i>false</i> , then the <i>Ptr</i> pointer will be addressed to an empty string.  Since the constructor of the <i>UnicodeString</i> class is not declared as <i>explicit</i> , it will actually create a temporary object containing an empty string that will implicitly cast to <i>const wchar_t *</i> ;  then the temporary object will be destroyed and <i>Ptr</i> will indicate invalid data.  The corrected code will look like this: <br><br><pre> <code class="cpp hljs">.... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *Ptr = ListData ? ListData[CurFile]-&gt;strName.CPtr() : <span class="hljs-string"><span class="hljs-string">L""</span></span>; ....</code> </pre> <br>  The following code is notable for the fact that two diagnostics worked on it simultaneously. <br><br>  <b>Analyzer Warnings</b> : <br><br><ul><li>  <a href="http://www.viva64.com/ru/w/V779/">V779</a> Unreachable code detected.  It is possible that an error is present.  7z.cpp 203 </li><li>  <a href="http://www.viva64.com/ru/w/V773/">V773</a> The 't' pointer.  A memory leak is possible.  7z.cpp 202 </li></ul><br><pre> <code class="cpp hljs">BOOL WINAPI _<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">export</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SEVENZ_OpenArchive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *Name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *Type)</span></span></span><span class="hljs-function"> </span></span>{ Traverser *t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Traverser(Name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!t-&gt;Valid()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> t; } <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> s_selected_traverser; s_selected_traverser = t; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TRUE; }</code> </pre> <br>  What can be found here?  First, indeed, there is an unreachable code in the <i>if statement</i> : if the condition is met, the function returns <i>FALSE</i> , completing its work.  And because of the unreachable code, only a memory leak occurred - the object by pointer <i>t is</i> not deleted.  To correct errors, it is enough to swap two operators inside the block. <br><br>  The following code will show how you can make a mistake when determining the size of an object of a class (structure) through a pointer. <br><br>  <b>Analyzer Warnings</b> : <br><br><ul><li>  <a href="http://www.viva64.com/ru/w/V568/">If you‚Äôre a</a> sizeof () ‚Äô‚Äô  filelist.cpp 672 </li><li>  <a href="http://www.viva64.com/ru/w/V568/">If you‚Äôre a</a> sizeof () ‚Äô‚Äô  filelist.cpp 673 </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> FileList::VMProcess(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OpCode, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *vParam, <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> iParam) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (OpCode) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MCODE_V_PPANEL_PREFIX: <span class="hljs-comment"><span class="hljs-comment">// PPanel.Prefix { PluginInfo *PInfo = (PluginInfo *)vParam; memset(PInfo, 0, sizeof(PInfo)); // &lt;= PInfo-&gt;StructSize = sizeof(PInfo); // &lt;= .... } .... } }</span></span></code> </pre> <br>  Both errors are that <i>sizeof (PInfo)</i> instead of the expected structure size will return a pointer size (4 or 8 bytes).  Accordingly, <i>memset will</i> fill only the first 4 (8) bytes of the structure with zeros, and the pointer size will be written in the <i>PInfo-&gt; StructSize</i> field.  The correct code will look like this: <br><br><pre> <code class="cpp hljs">.... PluginInfo *PInfo = (PluginInfo*)vParam; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(PInfo, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*PInfo)); PInfo-&gt;StructSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*PInfo); ....</code> </pre> <br>  The analyzer found a couple of similar places: <br><br><ul><li>  <i>If you‚Äôre a sizeof () ‚Äô</i>  <i>history.cpp 594</i> </li><li>  <i>If you‚Äôre a sizeof () ‚Äô‚Äô</i>  <i>plugins.cpp 682</i> </li></ul><br><h3>  Strange conditions </h3><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b8/648/db6/0b8648db625e589a9437ab0de776c209.png" alt="Picture 39"></div><p></p><br>  And again I suggest a small warm-up - try to find the error yourself in the next part of the code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FTP::ProcessKey(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Key, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ControlState) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !ShowHosts &amp;&amp; (ControlState == <span class="hljs-number"><span class="hljs-number">0</span></span> || ControlState == PKF_SHIFT) &amp;&amp; Key == VK_F6) { FTP *ftp = OtherPlugin(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !ftp &amp;&amp; ControlState == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; Key == VK_F6) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; } .... } .... }</code> </pre> <br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V560/">V560</a> A part of conditional expression is always true: Key == 0x75.  Key.cpp 493 <br><br>  Pay attention to the external and internal conditions: in them, <i>Key is</i> compared with the constant <i>VK_F6</i> .  If the control flow reaches an internal condition, then the <i>Key</i> variable is guaranteed to be equal to <i>VK_F6</i> and the second check of this variable will be superfluous.  In simplified form, the second condition will look like this: <br><br><pre> <code class="cpp hljs">.... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !ftp &amp;&amp; ControlState == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; } ....</code> </pre> <br>  The analyzer warns about this error and some similar ones: <br><br><ul><li>  <i>V560 A part of the conditional expression is always true:! Cps.</i>  <i>DString.cpp 47</i> </li><li>  <i>V560 A part of the conditional expression is always true:! ShowHosts.</i>  <i>FGet.cpp 139</i> </li><li>  <i>V560 A part of the conditional expression is always false:! Wsz.</i>  <i>cnDownload.cpp 190</i> </li><li>  <i>V560 A part of the conditional expression is always true! UserReject.</i>  <i>extract.cpp 485</i> </li><li>  <i>And 8 additional diagnostic messages.</i> </li></ul><br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V503/">V503</a> This is a nonsensical comparison: pointer &lt;= 0. fstd_exSCPY.cpp 8 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StrCpy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dest, LPCSTR src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dest_sz)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(dest &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return NULL; .... }</span></span></code> </pre> <br>  This code contains a meaningless comparison of a pointer with a negative number (pointers do not work with memory areas with negative addresses).  The revised code might look like this: <br><br><pre> <code class="cpp hljs">.... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(dest == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; ....</code> </pre> <br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V584/">V584</a> The <i>FADC_ALLDISKS</i> value is present on both sides of the '==' operator.  The expression is not correct.  findfile.cpp 3116 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> FINDASKDLGCOMBO { FADC_ALLDISKS, FADC_ALLBUTNET, .... }; FindFiles::FindFiles() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( FADC_ALLDISKS + SearchMode == FADC_ALLDISKS <span class="hljs-comment"><span class="hljs-comment">// &lt;= || FADC_ALLDISKS + SearchMode == FADC_ALLBUTNET) { .... } .... }</span></span></code> </pre> <br>  The analyzer detected a suspicious first sub-condition.  Based on the <i>FINDASKDLGCOMBO</i> enumeration, the <i>FADC_ALLDISKS</i> constant is 0, <i>FADC_ALLBUTNET</i> is 1. If we substitute the numerical values ‚Äã‚Äãof the constants in the conditional expression, we get the following: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">0</span></span> + SearchMode == <span class="hljs-number"><span class="hljs-number">0</span></span> || <span class="hljs-number"><span class="hljs-number">0</span></span> + SearchMode == <span class="hljs-number"><span class="hljs-number">1</span></span>) { .... }</code> </pre> <br>  Based on the code above, the whole condition can be simplified: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( SearchMode == FADC_ALLDISKS || SearchMode == FADC_ALLBUTNET) { .... }</code> </pre> <br><h3>  Incorrect work with the format string </h3><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/286/298/e7e/286298e7e539c1831e700b9eb811c4e2.png" alt="Picture 40"></div><p></p><br>  <b>Analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V576/">V576</a> Incorrect format.  Consider checking the fourth argument of the swprintf function.  The char type argument is expected.  FarEditor.cpp 827 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> FarEditor::showOutliner(Outliner *outliner) { .... <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> cls = Character::toLowerCase((*region)[region-&gt;indexOf(<span class="hljs-string"><span class="hljs-string">':'</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>]); si += swprintf(menuItem+si, <span class="hljs-number"><span class="hljs-number">255</span></span>-si, <span class="hljs-string"><span class="hljs-string">L"%c "</span></span>, cls); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }</span></span></code> </pre> <br>  This is probably a porting error.  The problem is that in Visual C ++, wide-string output functions interpret specifiers in a format string non-routinely: <i>% c</i> expects a wide character (wide char, <i>wchar_t</i> ).  In Linux, things are different: in accordance with the standard specified by the <i>% c</i> specifier, a multibyte symbol (multibyte symbol, <i>char</i> ) will be expected.  The correct code will look like this: <br><br><pre> <code class="cpp hljs">si += swprintf(menuItem+si, <span class="hljs-number"><span class="hljs-number">255</span></span>-si, <span class="hljs-string"><span class="hljs-string">L"%lc "</span></span>, cls);</code> </pre> <br>  <b>Analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V576/">V576</a> Incorrect format.  Consider checking the fourth argument of the swprintf function.  The type of symbols is expected.  cmddata.cpp 257 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CommandData::ReadConfig() { .... wchar Cmd[<span class="hljs-number"><span class="hljs-number">16</span></span>]; .... wchar SwName[<span class="hljs-number"><span class="hljs-number">16</span></span>+ASIZE(Cmd)]; swprintf(SwName,ASIZE(SwName), <span class="hljs-string"><span class="hljs-string">L"switches_%s="</span></span>, Cmd); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }</span></span></code> </pre> <br>  A similar situation: the format string contains the <i>% s</i> specifier, therefore, a multibyte string ( <i>char *</i> ) is expected.  However, the following parameter was passed a wide string ( <i>wchar_t *</i> ).  The correct code will look like this: <br><br><pre> <code class="cpp hljs">swprintf(SwName,ASIZE(SwName), <span class="hljs-string"><span class="hljs-string">L"switches_%ls="</span></span>, Cmd);</code> </pre> <br>  The analyzer also warns of two other incorrect ways of passing parameters in accordance with the format string: <br><br><ul><li>  <i>V576 Incorrect format.</i>  <i>Consider checking the fprintf function.</i>  <i>The char type argument is expected.</i>  <i>vtansi.cpp 1033</i> </li><li>  <i>V576 Incorrect format.</i>  <i>Consider checking the fprintf function.</i>  <i>The char type argument is expected.</i>  <i>vtansi.cpp 1038</i> </li></ul><br><h2>  findings </h2><br>  What can I say about the Far port on Linux?  Yes, mistakes were found enough, but do not forget that the project is in the alpha version and continues to evolve.  Using the methodology of static code analysis, errors can be found at an early stage and prevent them from entering the repository.  It is worth noting that all the benefits of static analysis will manifest themselves only with its regular use (as a last resort - during the "night" assemblies). <br><br>  On my own behalf, I propose to evaluate the benefits of static analysis using PVS-Studio: the product is available for Microsoft Windows and deb / rpm-based Linux distributions, allowing you to quickly and regularly check your project.  Also, if you are a student, an individual developer, or participate in the development of an open non-commercial project, then the possibility of using PVS-Studio for <a href="http://www.viva64.com/ru/b/0457/">free is</a> offered. <br><br>  In this introductory video you can learn how to install PVS-Studio for Linux and quickly check your project (using the example of Far Manager): <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/4SZxwRKo_os" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Also, if you know an interesting project that you should check out, then you can offer it to us on <a href="https://github.com/viva64/pvs-studio-check-list">GitHub</a> .  Read more in the article: " <a href="http://www.viva64.com/ru/b/0473/">Offer a project for testing with the PVS-Studio analyzer: now on GitHub</a> ". <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0478/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Phillip Khandeliants.  <a href="http://www.viva64.com/en/b/0478/">Porting is a Delicate Matter: Checking Far Manager under Linux</a> <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/321948/">https://habr.com/ru/post/321948/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321936/index.html">Octodon tries his hand at MotoModoStroenii</a></li>
<li><a href="../321938/index.html">Hanami v1.0.0.beta1 released</a></li>
<li><a href="../321940/index.html">How to get work experience without having work experience: tearing the vicious circle of a novice designer</a></li>
<li><a href="../321944/index.html">How 3 thousand rubles and simple methods to improve the efficiency of the data center helped save a lot of money</a></li>
<li><a href="../321946/index.html">Google released TensorFlow 1.0</a></li>
<li><a href="../321950/index.html">Superjob Data Science Meetup</a></li>
<li><a href="../321952/index.html">Partly cloudy: reduce the cost of backups</a></li>
<li><a href="../321956/index.html">Affiliate networks: where to get offers in traffic arbitration?</a></li>
<li><a href="../321958/index.html">How to publish the application in the Oculus Store and who needs it: the experience of Russian developers</a></li>
<li><a href="../321962/index.html">nodejs: SSO authentication via Kerberos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>