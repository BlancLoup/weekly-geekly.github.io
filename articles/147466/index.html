<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MVC approach to the implementation of the user interface in Delphi. Part 3. Objects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous parts of the article ( 1 , 2 ), I showed how to work with the internal data of the application and the user interface through one entr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MVC approach to the implementation of the user interface in Delphi. Part 3. Objects</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/e1a/797/17d/e1a79717d9da444c6a396dd57bfac2a2.png"><br>  In the previous parts of the article ( <a href="http://habrahabr.ru/post/147133/">1</a> , <a href="http://habrahabr.ru/post/147198/">2</a> ), I showed how to work with the internal data of the application and the user interface through one entry point - the model.  Model changes are automatically reflected in the user interface.  At the same time, to simplify, as a model, I used simple form property classes, whose setter can bring the GUI interface to the current state of the model.  In this part of the article I will show how the interface can react to changes in the objects themselves within the application. <br><a name="habracut"></a><br><br>  To start this article, I would like to consider the error, or rather the inaccuracy made in the previous part of the article.  The code for adding and deleting roles for the currently selected user presented there correctly changed the internal state of the object, but did not update the user interface at all.  More precisely, the interface could be updated only after switching from one user to another and vice versa.  As correctly noted in the comments, to correct this flaw, it was enough to insert the call to the FtUUrRoles method in the btAddRoleClick, btDelRoleClick procedure code.  It will work, but this is not at all what we need.  This method is bad because in all places where employee roles can potentially change, you need to insert a call to update the user interface each time.  And I want to forget once and for all about the need to do something with the GUI in the places where we work with the object.  I want the GUI to react to changes to the object itself and redraw itself when I change the fields of the object. <br><br>  To do this, I will extend the TUser class as follows: <br><pre><code class="delphi hljs">TUser = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ... FOnChangeRoles: TNotifyEvent; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoChangeRoles</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> OnChangeRoles: TNotifyEvent <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FOnChangeRoles <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FOnChangeRoles; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUser</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoChangeRoles</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Assigned(FOnChangeRoles) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> FOnChangeRoles(Self); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I added the simplest notification event to the TUser object, which will notify us of changes in the employee's role list.  In this case, the SetRoles method of the TUser class will look as follows: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUser</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetRoles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value: TIntList)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> SameIntLists(Roles, Value) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Roles := Value; DoChange; <span class="hljs-comment"><span class="hljs-comment">//   end; end;</span></span></code> </pre><br><br>  As long as the OnChangeRoles event of the TUser class is not overridden (by default, FOnChangeRoles is nil), the DoChangeRoles call simply does nothing.  In order to be able to somehow react to this event, you need to assign the appropriate handler to the TUser objects. <br>  It is logical to get this handler at the form class: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TfmUserRights</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcRolesChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FillUserRoles; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  Now we need to hang this event handler on the objects of the TUser class: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TfmUserRights</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FillUsers</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FUsers.Free; <span class="hljs-comment"><span class="hljs-comment">//   ,    FUsers := GetUsers; for i := 0 to FUsers.Count-1 do FUsers[i].OnChangeRoles := ProcRolesChanged; ... end;</span></span></code> </pre><br><br>  Here, in general, that's all :).  Now, when the object's roles are changed, the OnChangeRoles event will fire, the assigned handler of which will call FillUserRoles and update the GUI (refill the list of roles).  With these corrections, the code from the previous article will work correctly. <br><br><h5>  Could it have been better? </h5><br>  1) In the context of the previous article, I needed to respond only to a change in the list of roles, so I started a specific event that responds only to a change in the Roles field of the TUser class.  Often you need to respond to changing not one, but several (and maybe all) fields of the object.  In this case, it was better to start the event not OnChangeRoles, but simply OnChange, although the handler in this case should not only rebuild the list of roles, but also update any other information about the user that could be displayed in the window at that time.  Accordingly, the call to DoChange would not only be in SetRoles, but also in the setters of the rest of the TUser object fields, which I would like to monitor for changes.  And here the main task is not to forget to add this call to DoChange when adding a new field to the object, since  miss it pretty easy. <br>  2) Based on the principles of secure programming, if we register an event handler (as they say, ‚Äúsubscribe‚Äù to an event), then we have to remove this subscription (‚Äúunregister‚Äù the handler), i.e.  return OnChangeRoles to its original state or at worst in nil.  Whether it is necessary to carry out this deregistration is decided individually in each case.  First of all it depends on the ratio of the lifetime of TUser objects and the form object.  If the form lives longer TUser'a, then in principle deregistration is not required.  If, on the contrary, TUser can still live after the destruction of the form, then of course in OnDestroy the form needs to be written in the spirit of <br><pre> <code class="delphi hljs"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FUsers.Count-<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> FUsers[i].OnChangeRoles := <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>;</code> </pre><br>  If this is not done, then when trying to change a TUser object after destroying a form, TUser may try to call an event handler that refers to the method of an already destroyed object (form) and in the best case we will get Access Violation. <br>  3) When we work with lists of objects, assigning a handler to each object is not always convenient.  If the list items know about the list itself (for example, they refer to it through the Owner), you can make TUser doChange objects simply call Owner.DoChange, and start a custom event (property FOnChange) at the list itself (on TObjectList) .  Although this in general does not change anything in meaning. <br><br>  The considered method can be considered as a subscription to notifications with one subscriber.  However, this is not a full subscription to notifications.  Notifications are good because you can subscribe to as many subscribers as you want.  Now we look at how this is done.  Let's switch to another task. <br><br><h5>  Notifications with multiple subscribers </h5><br>  This template is often used in well-written MDI applications (and indeed in any multi-window applications).  The template is used when the same data can be displayed in several windows of the system, and when changing this data through one window, it is necessary that they are synchronously updated in all windows.  However, these windows are not necessarily instances of a window of the same class and do not necessarily have the same user interface.  On the contrary, the windows can be completely different.  They only display the same information.  For example, a list of employees is displayed in one window, and a card of this employee is displayed in another, where you can change some of its characteristics.  At the same time, it is required that by pressing the ‚ÄúSave‚Äù button on the employee card, the data would be updated both in the employee card and in the general list of employees. <br>  Template multiple subscription to the notification is convenient to use when there is a long-lived object.  His lifetime should be obviously longer than the lifetime of those objects that subscribe to notifications from him.  Suppose we have a class manager responsible for working with employees (in particular, saving changes to TUser objects in the database): <br><pre> <code class="delphi hljs">TUsersMngr = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(aUser: TUser)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  All windows, in which any employee-related information can be displayed, want to respond to calls to SaveUser.  In this case, the TUserMngr class will need to store references to all handlers that can subscribe to the employee save event: <br><pre> <code class="delphi hljs">TUsersMngr = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FNotifiers: <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> TNotifyEvent; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegChangeNotifier</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aProc: TNotifyEvent)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnregChangeNotifier</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aProc: TNotifyEvent)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NotifierRegistered</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aProc: TNotifyEvent)</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Code of implementation of these methods:</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUsersMngr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegChangeNotifier</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aProc: TNotifyEvent)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> NotifierRegistered(aProc) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; i := Length(FNotifiers); SetLength(FNotifiers, i+<span class="hljs-number"><span class="hljs-number">1</span></span>); FNotifiers[i] := aProc; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUsersMngr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnregChangeNotifier</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aProc: TNotifyEvent)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; vDel: Boolean; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-comment"><span class="hljs-comment">//  ,       (    RegChangeNotifier),     vDel := False; for i := 0 to High(FNotifiers) do if vDel then FNotifiers[i-1] := FNotifiers[i] else if (TMethod(aProc).Code = TMethod(FNotifiers[i]).Code) and (TMethod(aProc).Data = TMethod(FNotifiers[i]).Data) then vDel := True; if vDel then SetLength(FNotifiers, Length(FNotifiers) - 1); end; function TUsersMngr.NotifierRegistered( const aProc: TNotifyEvent): Boolean; var i: Integer; begin //       TMethod   for i := 0 to High(FNotifiers) do if (TMethod(aProc).Code = TMethod(FNotifiers[i]).Code) and (TMethod(aProc).Data = TMethod(FNotifiers[i]).Data) then begin Result := True; Exit; end; Result := False; end;</span></span></code> </pre><br></div></div><br><br>  With this functionality, you can easily subscribe to changes to objects of interest from any window: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUsersListForm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FormCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... UsersMngr.RegChangeNotifier(ProcUsersChanges); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUsersListForm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FormDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> UsersMngr.UnregChangeNotifier(ProcUsersChanges); ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUsersListForm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcUsersChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> RefillUsersList; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  Now that we have understood how this will be used, let us go back directly to the moment of notification, i.e.  at the time of the event: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUsersMngr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(aUser: TUser)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> aUser.Changed <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... <span class="hljs-comment"><span class="hljs-comment">//   aUser   ... DoUserChangeNotify; //   end; end; procedure TUsersMngr.DoUserChangeNotify; var i: Integer; begin for i := 0 to High(FNotifiers) do FNotifiers[i](Self); end;</span></span></code> </pre><br><br>  Now when you save the TUser object, all forms will be notified of this if they have not forgotten to subscribe to the corresponding event. <br><br><h5>  Handler lockout </h5><br>  The above code is good as long as there are no operations in the system at once on a large number of objects.  Perhaps not the best example: a group of employees was trained and each of them received some kind of certificate that was the same for all.  We select 10 employees in the list, click "Add certificate".  Next, the UserMngr.Show call is alternated for each of these 10 employees.  At the same time, after each employee is saved, the DoUserChangeNotify change event is triggered, which causes the list of employees to be rebuilt in all open windows (and each rebuild will still cause the list of employees to be re-requested from the database or from the application server).  As a result, saving changes for 10 employees will be sooooo slow and in addition we will get a lot of blinks in the open application windows (the lists will be rearranged 10 times).  Now I will describe a simple way to avoid this: <br><pre> <code class="delphi hljs">TUsersMngr = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FLock: Integer; FChanged: Boolean; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeginUpdate</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndUpdate</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUsersMngr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... FLock := <span class="hljs-number"><span class="hljs-number">0</span></span>; FChanged := False; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUsersMngr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeginUpdate</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Inc(FLock); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUsersMngr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndUpdate</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Assert(FLock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); Dec(FLock); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FLock = <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Changed <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> DoUserChangeNotify(Self); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  The notification method will also change: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUsersMngr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoUserChangeNotify</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FLock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">//      begin FChanged := True; // ,     Exit; end; FChanged := False; for i := 0 to High(FNotifiers) do FNotifiers[i](Self); end;</span></span></code> </pre><br><br>  Through FLock, the blocking level is tracked (nested calls to BeginUpdate..EndUpdate are allowed).  FChanged is a flag that allows us to remember whether an event occurred within the lock session at least once.  If it did occur, then at the moment of leaving the blocking session (i.e., at the moment when the EndUpdate of the top level is called), the event will be automatically triggered. <br><br>  Thus, the change code of a set of objects can be easily protected from unnecessary event triggering: <br><pre> <code class="delphi hljs">UsersMngr.BeginUpdate; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FSomeUsers[i] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> UsersMngr.Save(FSomeUsers[i]); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> UsersMngr.EndUpdate; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  It is convenient to use such a lock in other cases, for example, when it is necessary to transfer an object from one state to another, changing at the same time not one, but several of its fields.  However, some intermediate object states (some combinations of field values) may be considered invalid from the point of view of the GUI.  Accordingly, it is necessary not to let the GUI know at all that the object passed through such states.  In this case, the change of the object is also carried out within the session of its update, when the triggering of events about the change of this object is blocked. <br><br><h5>  Total </h5><br>  Events are one of the good techniques for connecting objects to a GUI.  This template is used not only when programming the GUI, but in many other cases.  In the article, we looked at options for implementing a subscription to notifications with one and with multiple subscribers.  On this cycle of articles on programming GUI in MVC-style is likely to be completed.  If someone has any questions regarding the approaches to the implementation of the GUI in Delphi, please leave them in the comments and maybe this series of articles will continue successfully.  I also propose in the comments (and maybe in separate articles!) To share their techniques for the successful implementation of typical tasks in Delphi.  And do not <a href="http://lurkmore.to/%25D0%2597%25D0%25B0%25D0%25BA%25D0%25BE%25D0%25BF%25D0%25B0%25D0%25B9%25D1%2582%25D0%25B5_%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D1%2582%25D0%25BD%25D0%25BE">bury any flight attendants</a> , Delphi still live;) <br><br>  Have a nice day, everyone! <br><br>  PS Links to previous parts of the article: <br>  <a href="http://habrahabr.ru/post/147133/">Part 1. Tick.</a> <br>  <a href="http://habrahabr.ru/post/147198/">Part 2. Lists.</a> </div><p>Source: <a href="https://habr.com/ru/post/147466/">https://habr.com/ru/post/147466/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147456/index.html">Scheme of undersea internet cables 2012</a></li>
<li><a href="../147459/index.html">Ultrabook Review SONY VAIO T13</a></li>
<li><a href="../147460/index.html">OS X Mountain Lion GM and Xcode 4.4 GM are available to developers.</a></li>
<li><a href="../147463/index.html">Android 4.1.1 source code "Jelly Bean"</a></li>
<li><a href="../147464/index.html">Github gets its first investment</a></li>
<li><a href="../147467/index.html">The man brought the virtual girl into the real world</a></li>
<li><a href="../147468/index.html">Turbo button against procrastination</a></li>
<li><a href="../147469/index.html">XMPP operation using jquery</a></li>
<li><a href="../147470/index.html">OSS for business</a></li>
<li><a href="../147471/index.html">Invite on Windows Store or how to get into Windows 8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>