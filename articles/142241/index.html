<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimization of flatpages project on django under the minimum system requirements. Joke article</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are a lot of letters under the cut, but don't worry - you all know them. 


 Prehistory 
 That's more interesting 

 Once upon a time, we with m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimization of flatpages project on django under the minimum system requirements. Joke article</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/065/6c3/e79/0656c3e793d25ca5f23e3155a6a8ec69.jpg"><br><br>  There are a lot of letters under the cut, but don't worry - you all know them. <br><a name="habracut"></a><br><br><h4>  Prehistory </h4><br>  <i>That's more interesting</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Once upon a time, we with my beloved tried to make their first small project.  Then I was engaged only in design, so the programmer had to be hired: I gave him layouts, he gave us the layout and the application itself.  I remember hosting cost us about 130-150 rubles - of course it was LAMP. <br><br>  As it is, usually, the first pancake happens.  The time has passed and we are ripe for the second project.  Now I could do everything myself.  Throwing over the design, I started the layout, and then the application itself.  This time, nothing substantial: a simple website with a bunch of statics is not even interesting. <br><br>  On a hosting, I habitually figured out this way: open the tariffs page on a VPS, choose the first line from the bottom - well, somewhere between 800-1000 rubles.  "So much?  We used to pay 200 rubles ... ‚Äù- the spouse was puzzled.  Indeed, why more something?  The answer, of course, is obvious: VPS, how not to twist, junga there, here and there, ‚Äúthis is not some kind of joy for you!‚Äù - but what about Joomla?  Joomla, won: 100 rubles.  live a month happily.  But this is too simple an answer, so not interesting. <br><br><h4>  Task </h4><br>  And so we have a task: the minimum VPS and the finished project on django are statics, a couple of forms, an admin panel, and so on.  Synthetic minimum: 200 MB of RAM, 500 MHz percent, on a screw - well, let it be two gigabytes for everything along with the system. <br><br><h5>  DB </h5><br>  The bottleneck in the problem: RAM.  Take sqlite.  Wait.  What ?!  I'm serious, he is not so <a href="http://opensimulator.org/wiki/NHibernate_Performance_Testing">bad</a> .  We compensate its shortcomings with a cache <br><br><h5>  Cache </h5><br>  We take all the most powerful: nginx + memcached and teach you how to work with jung. <br><br><h5>  Web server </h5><br>  It will be <a href="http://projects.unbit.it/uwsgi/">uwsgi</a> - fast and fashionable.  For fans of spherical-vacuum <a href="http://nichol.as/benchmark-of-python-web-servers">tests,</a> you can look. <br><br><h5>  Sessions </h5><br>  Sessions need to be stored somewhere.  I usually use redis, but not here.  Memkeshd is also not suitable: given the caching architecture, we will often reset the entire cache, and with them the sessions will <em>be deleted</em> .  Comes to the aid of a new jung 1.4.  This is a cookie-based session.  The principle is simple: all data about the session is stored in cookies by the user.  The data itself is not encrypted, but integrity is ensured by a cryptographic signature.  More can be read <a href="http/sessions/">at the docks</a> . <br><br><h5>  Content </h5><br>  It's all just take MarkDown.  "Why Marcown?"  He's cool.  He's awesome.  Even this article I write on it.  It will help us ease the size of the database, it does not contain tags.  The text in MD, sometimes, is half the easier way to do it from the fckeditor alike editor and is 100 times more pleasant to the eye.  In addition, the text should be formatted with the styles of the site, not the editor: some styles rule everything - just like Sauron. <br><br><h5>  Soft </h5><br>  Take Ubuntu server minimal to get the newest and fastest software: nginx, memcached, python 2.7.  In general, it is better to do something easier like slitaz, puppy linux, slax - if only because the minimum for ubunt is 128 MB of RAM, and the tuned ‚Äúbase system‚Äù + some software I have had more than a gigabyte on the screw.  Server distribution, <em>sir</em> .  But we decided to enjoy the article, in general, we will know the measure. <br><br><h4>  Development </h4><br><h5>  Django </h5><br>  First we need to set up our config junga: <br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     . #   ,       js. SESSION_ENGINE = 'django.contrib.sessions.backends.signed_cookies' SESSION_COOKIE_HTTPONLY = True # https://docs.djangoproject.com/en/1.4/ref/settings/#std:setting-USE_I18N #    .    : This provides an easy way to turn it off, for performance.       ,     ,      USE_I18N = False # https://docs.djangoproject.com/en/1.4/ref/settings/#use-l10n #       .    pytils    . USE_L10N = False # https://docs.djangoproject.com/en/1.4/ref/settings/#use-tz #      USE_TZ = False #  ,     .      . TEMPLATE_CONTEXT_PROCESSORS = ( # default template context processors "django.contrib.auth.context_processors.auth", # "django.core.context_processors.debug", # "django.core.context_processors.i18n", # "django.core.context_processors.media", "django.core.context_processors.static", #"django.core.context_processors.tz", "django.contrib.messages.context_processors.messages", # required by django-admin-tools 'django.core.context_processors.request', 'orangetrans.utils.context_processors.common', ) # Sentry     ,     . # include_html     ,       . #        . # https://docs.djangoproject.com/en/1.4/topics/logging/#django.utils.log.AdminEmailHandler LOGGING = { ‚Ä¶ 'handlers': { 'mail_admins': { 'level': 'ERROR', 'filters': ['require_debug_false'], 'class': 'django.utils.log.AdminEmailHandler', 'include_html': True, } }, ‚Ä¶ } #       ""  SEND_BROKEN_LINK_EMAILS = True</span></span></code> </pre> <br><h5>  Cache </h5><br>  This is the strongest part of the project.  Kesh will be our shield in front of a slow backend.  Many, of course, have already guessed what it was about. <br><br>  How will this work?  It's simple: the user requests the page, nzhinks looks at whether this page is in the cache, if not, janga generates it, puts it in the cache and gives it to the nzhinksu, next time the frontend will give it away.  Those.  in fact, it‚Äôs enough to go through the site once and all subsequent times our site will work with the speed of memkeshd + nzhinks. <br><br>  Really cool?  Well, almost, this type of cache is well suited for our case, for a complex project it has many drawbacks.  For example, we cannot update the form filled in by the user, because every time entering the URL, the user will receive the same form from the cache: without the completed data and received errors.  We do not need praise for fashion :) <br><br><h6>  Django </h6><br>  The form will be sent to us on Ajax, we just need to show it once, and the data and errors we will have to go to js.  Fallback option without Ajax (you always do it, right? :) we will not cache.  There is still a moment, the form works for us through a post.  Starting with some version of jung (1.2?), Protection against <a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">csrf attacks</a> has become mandatory for POST requests.  In our case, this is a callback request: one number field and no personal data.  To disable protection for a specific view, you simply need to wrap it in the <a href="https://docs.djangoproject.com/en/1.4/ref/contrib/csrf/">csrf_exempt</a> decorator. <br><br>  To implement our plan, we write middleware.  On the Internet there is an article on how to implement the work of such a bundle.  It is written for previous versions of junga and I did not understand without viewing the raw materials.  I will correct and silently update it.  So in the middleware: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.core.cache <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cache <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> settings <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NginxMemCacheMiddleWare</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request, response)</span></span></span><span class="hljs-function">:</span></span> url = request.get_full_path() cache_it = <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> settings.DEBUG \ <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> request.method == <span class="hljs-string"><span class="hljs-string">'GET'</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> response.status_code == <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cache_it: stoplist = [ x <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> settings.CACHE_IGNORE_REGEXPS <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> re.match(x, url) ] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> stoplist: cache.set(url, response.content) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response</code> </pre><br>  We only cache GET, do not cache during development and 404. And why?  That is why bots in search of the admin or the attacker himself can clog the memory with any rubbish. <br><br>  Let's go back to the config: <br><pre> <code class="python hljs">CACHES = { <span class="hljs-string"><span class="hljs-string">'default'</span></span>: { <span class="hljs-string"><span class="hljs-string">'BACKEND'</span></span>: <span class="hljs-string"><span class="hljs-string">'django.core.cache.backends.memcached.MemcachedCache'</span></span>, <span class="hljs-string"><span class="hljs-string">'LOCATION'</span></span>: <span class="hljs-string"><span class="hljs-string">'unix:/tmp/memcached.sock'</span></span>, <span class="hljs-string"><span class="hljs-string">'KEY_PREFIX'</span></span>: <span class="hljs-string"><span class="hljs-string">'YOURSITE'</span></span>, } }</code> </pre><br>  Everything is simple: backend memkeshd, socket and prefix.  By the way, pylibmc I could not get through a socket, something he did not like, and all the same.  I took python-memcached. <br><pre> <code class="python hljs">CACHE_IGNORE_REGEXPS = ( re.compile(<span class="hljs-string"><span class="hljs-string">r'/admin.*'</span></span>), re.compile(<span class="hljs-string"><span class="hljs-string">r'/some_url.*'</span></span>), )</code> </pre><br>  This is a list of URLs prohibited for caching, which was mentioned just above.  Do not forget to add our new middleware in MIDDLEWARE_CLASSES in settings. <br><br>  By the way, you can use the <a href="https://github.com/bartTC/django-memcache-status">django-memcache-status</a> program to monitor the memkeshd <a href="https://github.com/bartTC/django-memcache-status">status</a> .  She draws a nice scale of used allocated memory for memkeshd in the admin panel and shows a lot of information.  To be honest, I didn‚Äôt find a special use for her :) just dilute the already boring admin panel for flatpage.  Unfortunately she is not friendly with django-admin-tools. <br><br><h6>  Nginx </h6><br>  Config for server dev, later we will update it: <br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> dev { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:8000</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> dev.local; <span class="hljs-attribute"><span class="hljs-attribute">charset</span></span> utf-<span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> ~^/(media|static) { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /home/user/project; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; break; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$request_method</span></span> = POST) { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://dev; break; } <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> <span class="hljs-string"><span class="hljs-string">"text/html; charset=utf-8"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$memcached_key</span></span> <span class="hljs-string"><span class="hljs-string">"YOURSITE:1:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request_uri</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">memcached_pass</span></span> unix:/tmp/memcached.sock; <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> <span class="hljs-number"><span class="hljs-number">502</span></span> = <span class="hljs-variable"><span class="hljs-variable">@fallback</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-variable"><span class="hljs-variable">@fallback</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://dev; } }</code> </pre><br>  See this line: 'set $ memcached_key "YOURSITE: 1: $ request_uri";'?  This is where all the magic happens.  Each page is stored in a cache with a key prefix + cache version + full URL.  It is enough to open the page once, janga will put it in the cache after the key, and the next time the nzhinks will get it by this key.  Even if you turn off the jungle site will be operational.  Post requests we immediately pass back to the backend without twitching the memkey.  Another point: I use het keys for fallback mode if the user has js disabled (I have noscript: P): there are all sorts of tabs, so that's why request_uri instead of uri is the last URL without het keys. <br><br>  Starting with jangi 1.3, we don‚Äôt need to form the whole key by ourselves.  It is enough to pass the unique part to the set (), get (), delete () methods, and the rest will do the janga on its own.  The unique part in our case is the absolute URL of the page. <br><br>  With our usual gzip, there is a small problem: nzhinks do not compress, what takes from memkeshd.  I found on the network a 4-year-old patch for version 0.6 of the Nzhinks, and it was already 1. * in the yard.  If you do not serve IE6, you can turn on compression in the jung itself and already give compressed content.  In our case, the starper browser is important.  For everything else, gzip will work. <br><br><h6>  Memecached </h6><br>  Let's say memcached work through a socket, /etc/memcached.conf: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#-s unix socket path to listen on (disables network support) -s /tmp/memcached.sock #-a access mask for unix socket, in octal (default 0700) -a 0777</span></span></code> </pre><br><h5>  Statics </h5><br>  I use jquery and html5shim for IE.  Praise Google, it will ease our lot: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://html5shim.googlecode.com/svn/trunk/html5.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The rest of the statics squeeze using <a href="https://github.com/jezdez/django_compressor">django-compressor</a> .  I use less - django-compressor can also compile it in css.  If you also use less, do not forget to put node.js on the server and the compiler itself.  For all statics we will enable compression and glue together: js with js, css c css.  Beauty. <br><br>  The application also gives the files unique names, so when the source changes, new ones with new names will be compiled, so the user will download them in a new way and won‚Äôt ask the question ‚Äúwhy does everything look so strange?‚Äù.  By the way, junga 1.4 also can. <br><br><h4>  Local test </h4><br>  Ok, we are almost done. <br>  Take your favorite virtual machine, install the system and deploy our project.  At the same time, let's prepare everything for production: let's update the requirements for pip, which, for some reason, are always irrelevant and configure the uwsgi-server.  There is one thing with the processor: the virtual box and the player do not know how to give a certain amount of hertz, we will limit ourselves to one core. <br><br>  On setting up a uwsgi server, I recommend reading the <a href="https://docs.djangoproject.com/en/1.4/howto/deployment/wsgi/uwsgi/">docks</a> and another <a href="http://welinux.ru/post/3452/">article on welinux</a> .  It makes no sense to explain this here: take the example of the config from the docks and launch it.  The only thing I recommend is to specify <a href="http://projects.unbit.it/uwsgi/wiki/Doc">virtualenv</a> , because most of the problems associated with the pythonpath and the environment - oh, how much time I killed until I guessed to look at the docks.  Judging by Google: I am not the only one, the people are perverted as they can: they add ways to the environment from scripts, etc.  And all the good old rtfm. <br><br>  And so, everything is ready.  Let's open the private mode in the browser so that everything is fair, we will measure for how much we get the page: <br><pre> <code class="bash hljs">18 requests ‚ùò 284.93KB transferred ‚ùò 1.11s (onload: 1.12s, DOMContentLoaded: 979ms)</code> </pre><br>  Turn on the cache, generate the cache, open a new private browser: <br><pre> <code class="bash hljs">18 requests ‚ùò 298.09KB transferred ‚ùò 291ms (onload: 293ms, DOMContentLoaded: 150ms)</code> </pre><br>  Perform a POST request (then I will explain why).  It executes <a href="https://docs.djangoproject.com/en/dev/ref/models/querysets/">get_or_create a</a> couple of times: <br><pre> <code class="bash hljs">21 ms.  .</code> </pre><br>  As you can see there is a gain, as well as a little more weight without gzip. <br>  Cool?  Cool. <br><br><h4>  Can be cooler </h4><br>  Here is what we do: <br><ul><li>  since version 1.3 junga collects all the statics of all applications in a folder with statics (manage.py collectstatic) - you can‚Äôt think of anything better.  We put everything in memory; </li><li>  bd we have this file and the application will access it as a file, and put it in memory; </li><li>  we will adjust copying once an hour on the screw to sleep easy. </li></ul><br>  Static is 2 megabytes and the database will not grow more than a couple megabytes - we take 5 MB.  Create a directory in memory: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    /etc/fstab: tmpfs /mnt/project/ tmpfs size=5M,mode=0777 0 0 #   $ sudo mkdir /mnt/project/ #     ,     : $ sudo mount /mnt/project/ # mode=0777    ,    $ mkdir /mnt/project/static $ mkdir /mnt/project/db</span></span></code> </pre><br>  If you have correctly assembled your project, then all the static will be in the application directories.  To do this, static should be placed in the static of each application, more and more in the <a href="https://docs.djangoproject.com/en/dev/ref/contrib/staticfiles/">docks</a> .  So janga can find and assemble them in the right place.  We do: <br><pre> <code class="hljs smalltalk">#          . #    ,    : <span class="hljs-type"><span class="hljs-type">STATIC_ROOT</span></span> = <span class="hljs-type"><span class="hljs-type">COMPRESS_ROOT</span></span> = <span class="hljs-string"><span class="hljs-string">'/mnt/project/static/'</span></span> #     (--noinput    ,  -      ): <span class="hljs-string"><span class="hljs-string">$ </span></span>./manage.py collectstatic --noinput -c #    .     : <span class="hljs-type"><span class="hljs-type">DATABASES</span></span> = { <span class="hljs-string"><span class="hljs-string">'default'</span></span>: { <span class="hljs-string"><span class="hljs-string">'ENGINE'</span></span>: <span class="hljs-string"><span class="hljs-string">'django.db.backends.sqlite3'</span></span>, <span class="hljs-string"><span class="hljs-string">'NAME'</span></span>: <span class="hljs-string"><span class="hljs-string">'/mnt/project/db/db'</span></span>, } } #   <span class="hljs-string"><span class="hljs-string">$ </span></span>cp -r project/db /mnt/project/db/db #   <span class="hljs-string"><span class="hljs-string">$ </span></span>killall -<span class="hljs-type"><span class="hljs-type">HUP</span></span> uwsgi</code> </pre><br>  Automation of all this at the start and backup crown will leave as a homework. <br><br>  Update njinks config: <br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> project { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> unix:/tmp/project.sock; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> project.ru www.project.ru; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$host</span></span> = www.project.ru){ <span class="hljs-attribute"><span class="hljs-attribute">rewrite</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^(.*)$</span></span> http://project.ru<span class="hljs-variable"><span class="hljs-variable">$1</span></span> <span class="hljs-literal"><span class="hljs-literal">permanent</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /static { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /mnt/project/; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">expires</span></span> max; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /media { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /project/; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">expires</span></span> <span class="hljs-number"><span class="hljs-number">5d</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/uwsgi_params; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$request_method</span></span> = POST) { <span class="hljs-attribute"><span class="hljs-attribute">uwsgi_pass</span></span> project; } <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> <span class="hljs-string"><span class="hljs-string">"text/html; charset=utf-8"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$memcached_key</span></span> <span class="hljs-string"><span class="hljs-string">"project:1:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request_uri</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">memcached_pass</span></span> unix:/tmp/memcached.sock; <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> <span class="hljs-number"><span class="hljs-number">502</span></span> = <span class="hljs-variable"><span class="hljs-variable">@fallback</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-variable"><span class="hljs-variable">@fallback</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/uwsgi_params; <span class="hljs-attribute"><span class="hljs-attribute">uwsgi_pass</span></span> project; } }</code> </pre><br>  Media we physically stayed where it was.  Static moved, the rest we have already seen. <br>  It is worth noting the line 'expires max' for static: this is not cool.  And what if tomorrow we correct the picture, m?  If you use django-compressor, you'll be pleasantly surprised to see this in css: /static/i/button-small.png?e59177bafc62. <br><br>  Without cache: <br><pre> <code class="bash hljs">14 requests ‚ùò 284.93KB transferred ‚ùò 743ms (onload: 775ms, DOMContentLoaded: 708ms)</code> </pre><br>  With cache: <br><pre> <code class="bash hljs">14 requests ‚ùò 298.09KB transferred ‚ùò 174ms (onload: 175ms, DOMContentLoaded: 140ms)</code> </pre><br>  POST: <br><pre> <code class="bash hljs">17ms</code> </pre><br>  There is a gain.  Small, but there is.  And with more attendance it will become noticeable. <br><br><h4>  Backups </h4><br>  Usually I'm so wasteful that I use Dropbox, but <a href="http://en.wikipedia.org/wiki/WebDAV">WebDav</a> is more appropriate <a href="http://en.wikipedia.org/wiki/WebDAV">here</a> .  Simple and fairly detailed instructions you will find on <a href="http://www.mydrive.ch/en/help">MyDrive</a> .  The blessing now is full of services - choose.  This will allow us to save space on the screw and take backups to the cloud at the same time. <br><br><h4>  So what have we done? </h4><br><ul><li>  we saved resources by replacing mysql with sqlite (and spent them a little by putting the database in memory :) however until then we achieved great speed; </li><li>  used cookie-based sessions - they are from the user, which means we should not care about their storage, cleaning and other nonsense; </li><li>  we optimized the work of jangi, mainly admin panels, by turning off the translation, but this is the non-cacheable part, which means it is important; </li><li>  nzhinks, janga and memkeshd communicate through sockets - I don‚Äôt know how much it will add, but it should be faster than through ports; </li><li>  we used, probably, the fastest cache of existing ones and, if properly used, we can give odds in speed to more abrupt sites; </li><li>  part of the static is placed outside, which means the site will load even faster: from different sources or from the local cache (something popular); </li><li>  we squeezed our static, put it in memory and give it through the njinks; </li><li>  backups?  Checked. </li></ul><br><h4>  So what's the joke? </h4><br>  It was interesting to me to solve the problem, just like that, out of curiosity and unaccustomed to work in close conditions.  Basically, the solutions are harmless and even useful, but some are extremely sporty: the selected cache is impractical, and sqlite will not allow to greatly expand the project (back-office for call processing, for example).  And in my right mind I won't save on the server, so all this is nothing more than a fan. <br><br>  Look like that's it.  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/142241/">https://habr.com/ru/post/142241/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142235/index.html">Real-world text mining using machine learning</a></li>
<li><a href="../142236/index.html">Playing cubes with Kinect</a></li>
<li><a href="../142238/index.html">ZFConf 2010: How It Was (video reports)</a></li>
<li><a href="../142239/index.html">1C products - service, sale from Infors</a></li>
<li><a href="../142240/index.html">SVG stacks</a></li>
<li><a href="../142242/index.html">Compression without loss of information. Part one</a></li>
<li><a href="../142243/index.html">How would I do BusyIndicator</a></li>
<li><a href="../142244/index.html">Do you really want to use the cancel button in your apps?</a></li>
<li><a href="../142245/index.html">Visual monitoring of a large number of objects (for example, IPTV channels) using Arduino</a></li>
<li><a href="../142247/index.html">The Pirate Bay: and .torrent files have not gone anywhere</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>