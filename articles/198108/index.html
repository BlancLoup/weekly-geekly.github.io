<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ICMP port knocking in OpenWRT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Impressed with the article I decided to implement such a solution on a home router, running OpenWRT (Bleeding Edge r38381). The solution is probably n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ICMP port knocking in OpenWRT</h1><div class="post__text post__text-html js-mediator-article">  Impressed with the <a href="http://habrahabr.ru/post/186488/">article</a> I decided to implement such a solution on a home router, running OpenWRT (Bleeding Edge r38381).  The solution is probably not as elegant as on Mikrotik, but the main thing is that it is working and without scripts and cron.  It can also be taken as a basis for implementation on other Linux operating systems.  Who cares please under the cat. <a name="habracut"></a><br><br>  I had to climb a lot of resources.  I also thought of writing scripts by tracking LOG or ULOG events from iptables in the system log.  I even came across a project - <a href="http://joker.linuxstuff.pl/specter/">Specter</a> , with which you can implement a reaction (execution of scripts) to ULOG events from iptables, which is not in ulogd.  <a href="http://www.portknocking.org/view/implementations">There is a</a> large selection of old projects for implementing Port knocking, but I didn‚Äôt want to compile on a router or virtual server at all.  When searching for a solution, I often came across tips about the speed and convenience of ipsets, so as not to pile on iptables with a bunch of ‚Äúidentical‚Äù rules.  And the keys "--match-set" and "--add-set" were noticed in them, further searches led to the solution. <br>  In general, it was decided to use ipsets, since  you do not need to monitor anything and write reactions to events outside of iptables. <br><br>  So, the solution is implemented using purely iptables and ipset.  For ease of perception, the combination of ‚Äúknocks‚Äù will be the same as in the above article.  Let me remind you - 2 ICMP packets in a row of 70 bytes in size and 2 ICMP packets in a row of 100 bytes in size.  <u>Well, do not forget about the size of the header ICMP parquet (28 bytes)</u> . <br>  In my case, after the corresponding knocks, the connection is allowed on port 1194 / tcp for the OpenVPN server for the IP address from which the knocks were made.  The instructions for setting up OpenVPN server on OpenWRT can be found on the official <a href="http://wiki.openwrt.org/inbox/vpn.howto">Wiki</a> , because  this is beyond the scope of this article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Preparing ipsets </h4><br>  It should be noted that the support for the rules for creating ipsets in the OpenWRT firewall settings file appeared only from the Attitude Adjustment release, although in the r36349 revision did not work ( <u>When applying the rules, it issued a warning that no datatype was specified for ipsets</u> ). <br><br>  But ipsets can be created by handles, it is desirable to create them when loading, for example: write in /etc/rc.local. <br><pre><code class="bash hljs">ipset create knock1 <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:ip ipset create knock2 <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:ip ipset create knock3 <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:ip ipset create AllowedVPN <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:ip</code> </pre> <br>  If fw3 supports creating ipsets (fw3 is the OpenWRT firewall management tool itself, a detailed description of the settings can be found on the official <a href="http://wiki.openwrt.org/doc/uci/firewall">Wiki</a> ), then the following items are added to the firewall settings file <b>/ etc / config / firewall</b> : <pre> <code class="bash hljs">config ipset option enabled 1 option name knock1 option storage <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span> option match src_ip config ipset option enabled 1 option name knock2 option storage <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span> option match src_ip config ipset option enabled 1 option name knock3 option storage <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span> option match src_ip config ipset option enabled 1 option name AllowedVPN option storage <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span> option match src_ip</code> </pre><br><br><h4>  ICMP sequence trapping logic </h4><br><h5>  Catch the first knock </h5><br><pre> <code class="bash hljs">icmptype 8 length 98 ! match-set knock1 src ! match-set knock2 src ! match-set knock3 src ! match-set AllowedVPN src add-set knock1 src</code> </pre> <br>  The outgoing ICMP address of a packet of 98 bytes is entered in the ipset knock1, if it is not in the other ipsets. <br><br><h5>  We catch the second knock </h5><br><pre> <code class="bash hljs">icmptype 8 length 98 match-set knock1 src ! match-set knock2 src ! match-set knock3 src ! match-set AllowedVPN src add-set knock2 src</code> </pre>  The outgoing address of an ICMP packet with a size of 98 bytes is entered into the ipset knock2, if it already exists in the ipset knock1 and not in the rest. <br><br><h5>  Catch the third knock </h5><br><pre> <code class="bash hljs">icmptype 8 length 128 match-set knock1 src match-set knock2 src ! match-set knock3 src ! match-set AllowedVPN src add-set knock3 src</code> </pre>  The outgoing ICMP address of a 128-byte packet is recorded in the ipset knock3, if it is also present in the ipset-a knock1 and knock2, but not in AllowedVPN. <br><br><h5>  Catch the fourth knock </h5><br><pre> <code class="bash hljs">icmptype 8 length 128 match-set knock1 src match-set knock2 src match-set knock3 src ! match-set AllowedVPN src add-set AllowedVPN src</code> </pre><br>  The outgoing ICMP packet address of 128 bytes is entered in ipset AllowedVPN, if it is also present in ipset knock1, knock2 and knock3. <br>  <u>In order for the sequence to be caught correctly, the rules in iptables must be entered in the reverse order</u> .  Otherwise, the first ‚Äúknock‚Äù will be caught by the first and second rules at once, just as the third ‚Äúknock‚Äù will be caught by the third and fourth rules at once. <br>  <u>Additional checks for the absence of other ipsets are indicated for accurate triggering of the ‚Äúknock‚Äù sequence</u> . <br><br>  Below is a sequence of iptables commands for entering input_rule into the chain (a specially created chain in the OpenWRT firewall for user rules) are added to <b>/etc/firewall.user</b> . <br><pre> <code class="bash hljs">iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j SET --add-set AllowedVPN src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j SET --add-set knock3 src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j SET --add-set knock2 src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j SET --add-set knock1 src</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">The same rules, but with logging to the system log</b> <div class="spoiler_text"><pre> <code class="bash hljs">iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j LOG --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix <span class="hljs-string"><span class="hljs-string">"(KNOCK4 O) "</span></span> iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j SET --add-set AllowedVPN src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j LOG --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix <span class="hljs-string"><span class="hljs-string">"(KNOCK3 O) "</span></span> iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j SET --add-set knock3 src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j LOG --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix <span class="hljs-string"><span class="hljs-string">"(KNOCK2 O) "</span></span> iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j SET --add-set knock2 src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j LOG --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix <span class="hljs-string"><span class="hljs-string">"(KNOCK1 O) "</span></span> iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set AllowedVPN src -j SET --add-set knock1 src</code> </pre> <br></div></div><br><h4>  "The most important" rule </h4><br>  It is this rule that allows incoming connections on port 1194 / tcp, if the IP address from which the connection is made, is in the ipset AllowedVPN. <br><pre> <code class="bash hljs">config <span class="hljs-string"><span class="hljs-string">'rule'</span></span> option enabled 1 option <span class="hljs-string"><span class="hljs-string">'target'</span></span> <span class="hljs-string"><span class="hljs-string">'ACCEPT'</span></span> option <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-string"><span class="hljs-string">'VPN'</span></span> option <span class="hljs-string"><span class="hljs-string">'src'</span></span> <span class="hljs-string"><span class="hljs-string">'wan'</span></span> option <span class="hljs-string"><span class="hljs-string">'proto'</span></span> <span class="hljs-string"><span class="hljs-string">'tcp'</span></span> option <span class="hljs-string"><span class="hljs-string">'dest_port'</span></span> <span class="hljs-string"><span class="hljs-string">'1194'</span></span> option <span class="hljs-string"><span class="hljs-string">'extra'</span></span> <span class="hljs-string"><span class="hljs-string">'-m set --match-set AllowedVPN src'</span></span></code> </pre><br>  Otherwise, it can be written in /etc/firewall.user <pre> <code class="bash hljs">iptables -A input_rule -p tcp --dport 1194 -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j ACCEPT</code> </pre><br><h4>  Port knocking </h4><br>  To produce Port knocking in Windows, use the command <br>  <b>ping readyshare.mydomain.ua -l 70 -n 2 &amp;&amp; ping readyshare.mydomain.ua -l 100 -n 2</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8fa/e38/87d/8fae3887dec82c298595cdd6a2f7b3cb.png"><br><br><h4>  Close access </h4><br>  Fully paint the logic will not, because  it is very similar to the one described above, just the logic of the check in the rules is inverted and deletes from the ipsets.  Well, accordingly, if there is no IP address in ipset-e AllowedVPN, then there is no access. <br>  <u>The sequence of "knocks" is the same as when opening access.</u> <br>  Below is a sequence of iptables commands for input_rule, file <b>/etc/firewall.user</b> <br><pre> <code class="bash hljs">iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j SET --del-set AllowedVPN src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j SET --del-set knock3 src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j SET --del-set knock2 src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j SET --del-set knock1 src</code> </pre><br><div class="spoiler">  <b class="spoiler_title">The same rules for blocking but logging to the system log</b> <div class="spoiler_text"><pre> <code class="bash hljs">iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j LOG --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix <span class="hljs-string"><span class="hljs-string">"(KNOCK4 C) "</span></span> iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j SET --del-set AllowedVPN src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j LOG --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix <span class="hljs-string"><span class="hljs-string">"(KNOCK3 C) "</span></span> iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 128 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j SET --del-set knock3 src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j LOG --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix <span class="hljs-string"><span class="hljs-string">"(KNOCK2 C) "</span></span> iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ! --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j SET --del-set knock2 src iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j LOG --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix <span class="hljs-string"><span class="hljs-string">"(KNOCK1 C) "</span></span> iptables -A input_rule -p icmp -m icmp --icmp-type <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>-request -m length --length 98 -m <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> 10/s -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock1 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock2 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set knock3 src -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set AllowedVPN src -j SET --del-set knock1 src</code> </pre></div></div><br><br>  I hope my experience will be useful to others. <br><br>  A good <a href="http://www.qccolab.com/wp-content/uploads/2013/04/ipset-slides.pdf">presentation</a> on Chris Cooper's ipset-am from QC Co-Lab, from which I began to make a start when building a solution. </div><p>Source: <a href="https://habr.com/ru/post/198108/">https://habr.com/ru/post/198108/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198098/index.html">Write Back in MS SQL Server Analysis Service cubes</a></li>
<li><a href="../198100/index.html">ActiveRecord and transaction rollback in Yii</a></li>
<li><a href="../198102/index.html">We control the webcam with the joystick</a></li>
<li><a href="../198104/index.html">Under the hood at Dictionary and ConcurrentDictionary</a></li>
<li><a href="../198106/index.html">Old, kind ‚ÄúThe Matrix‚Äù or visualizer for matrix version one</a></li>
<li><a href="../198110/index.html">Install pyload as standalone rocking for ReadyNAS DUO v2</a></li>
<li><a href="../198112/index.html">Translation of the book ‚ÄúAvailable 3D printing for science, education and sustainable development‚Äù (Low-cost 3D Printing for Science, Education and Sustainable Development), 2013</a></li>
<li><a href="../198114/index.html">Impractical triage - meaningless and merciless</a></li>
<li><a href="../198116/index.html">Compile the code from the code to reproduce the race of the two processes.</a></li>
<li><a href="../198118/index.html">Intergeo 2013. Essen. Germany. Laser scan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>