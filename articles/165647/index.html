<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sharing service of screenshots and code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many of you have probably heard about the services that allow sharing screenshots with one click of a button. The general concept is as follows: you p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sharing service of screenshots and code</h1><div class="post__text post__text-html js-mediator-article">  Many of you have probably heard about the services that allow sharing screenshots with one click of a button.  The general concept is as follows: you press a hot key, select an area of ‚Äã‚Äãthe screen, and in the clipboard you get a link to a screenshot that is automatically uploaded to some kind of hosting.  Also, many of you probably used other services - allowing you to publish a fragment of the source code and get a link to a page displaying this source code with syntax highlighting. <br><br>  We combined these two ideas and made a project with the following features: <br><br><ul><li>  Publication of screenshots and sources by pressing hotkeys </li><li>  Open Source - you can fork / raise on your server / add new features </li><li>  Direct link to images, lack of advertising </li><li>  Cross platform </li><li>  Resistance to high loads (hosted in the cloud) </li></ul><br><a name="habracut"></a><br>  The service consists of the following components: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Client application </li><li>  Server daemon taking screenshots </li><li>  Web interface </li></ul><br><br>  The client application takes a screenshot and sends it to the server.  The server daemon receives the file, generates a unique name for it and writes it to a specific folder.  All received files are accessible via the http protocol ‚Äî nginx is used for this purpose.  Nginx + php &amp; fastcgi is also used for the syntax highlighting library. <br><br><h3>  Client application </h3><br>  For the development of the client application, the Qt framework was chosen.  Advantages - good documentation, cross-platform, a large number of libraries.  And in general we like him.  In addition, we had to use the qxt library for cross-platform work with global hotkeys. <br><br>  The application consists of the following classes: <br><br><ul><li>  Application </li><li>  Network </li><li>  Configwidget </li><li>  ImageSelectWidget </li><li>  LanguageSelectDialog </li><li>  Scanhotkeydialog </li></ul><br><br>  <i>Application</i> - here is implemented work with global hotkeys, getting screenshots, work with tray and clipboard. <br><br>  <i>Network</i> - work with the network, i.e. connection to the server, sending data via a simple http-like protocol, receiving a link from the server. <br><br>  <i>ConfigWidget, ImageSelectWidget, LanguageSelectDialog, ScanHokeyDialog</i> are simple classes that are responsible for the <i>config</i> window, the image selection window, the programming language, and the hotkeys settings. <br><br>  During application initialization, the following occurs.  First we check if the application is already running.  From the cross-platform solutions, the easiest option to check was to run QLocalServer, and try to connect to it at startup.  If the connection fails, then this is a new launch and we are working, otherwise we exit. <br><br><pre><code class="cpp hljs">QLocalSocket socket; socket.connectToServer(APP_NAME); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (socket.waitForConnected(<span class="hljs-number"><span class="hljs-number">500</span></span>)) { qDebug() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Application already launched!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } _localServer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QLocalServer(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_localServer-&gt;listen(APP_NAME)) { QLocalServer::removeServer(APP_NAME); _localServer-&gt;listen(APP_NAME); }</code> </pre> <br><br>  Then we register hot keys.  Using libqxt with hotkeys is pretty easy.  You need to create a hotkey, specify a key combination for it and associate with the slot, which will be executed by pressing this hotkey: <br><br><pre> <code class="cpp hljs">_shortcutScreenFull = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QxtGlobalShortcut; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_shortcutScreenFull-&gt;setShortcut(QKeySequence(fullHotkey))) qDebug() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Error activating hotkey:"</span></span> &lt;&lt; fullHotkey; connect(_shortcutScreenFull, SIGNAL(activated()), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SLOT(processScreenshotFull()))</code> </pre><br><br>  The procedure for obtaining a screenshot looks like.  We get a screenshot, save it in the required format in QBuffer, get an array of QByteArray bytes and send it to the server: <br><br><pre> <code class="cpp hljs">QPixmap pixmap = QPixmap::grabWindow(QApplication::desktop()-&gt;winId()); QByteArray imageBytes; <span class="hljs-function"><span class="hljs-function">QBuffer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buffer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;imageBytes)</span></span></span></span>; buffer.open(QFile::WriteOnly); pixmap.save(&amp;buffer, imagetype.toAscii().constData()); buffer.close(); _network-&gt;upload(imageBytes, imagetype);</code> </pre><br><br>  The protocol for sending the file by the client to the server is as follows.  Customer sends: <br><pre> <code class="cpp hljs">proto=pastexen version=<span class="hljs-number"><span class="hljs-number">1.0</span></span> type=jpg size=<span class="hljs-number"><span class="hljs-number">142034</span></span> binary_data</code> </pre><br><br>  Where jpg is the file type;  142034 - file size in bytes;  binary_data - file contents <br><br>  After receiving the file, the server responds: <br><pre> <code class="cpp hljs">proto=pastexen version=<span class="hljs-number"><span class="hljs-number">1.0</span></span> url=http:<span class="hljs-comment"><span class="hljs-comment">//host.tst/file1.jpg</span></span></code> </pre><br><br>  url - a direct link to a file or to a page with decorated text with syntax highlighting <br><br>  In the upload method of the Network class, we connect to the server, create a package according to the protocol and transfer it: <br><br><pre> <code class="cpp hljs"> _socket.connectToHost(_serverAddr, <span class="hljs-number"><span class="hljs-number">9876</span></span>); _socket.waitForConnected(); QByteArray arr; arr.append(<span class="hljs-string"><span class="hljs-string">"proto=pastexen\n"</span></span>); arr.append(<span class="hljs-string"><span class="hljs-string">"version=0.2\n"</span></span>); arr.append(<span class="hljs-string"><span class="hljs-string">"type="</span></span> + type + <span class="hljs-string"><span class="hljs-string">"\n"</span></span>); arr.append(QString(<span class="hljs-string"><span class="hljs-string">"size=%1\n\n"</span></span>).arg(data.size())); arr.append(data); _socket.write(arr);</code> </pre><br><br>  As soon as we receive the answer, we extract the link from it, and throw the linkReceived signal: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QByteArray arr = _socket.readAll(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString link = getValue(arr, <span class="hljs-string"><span class="hljs-string">"url"</span></span>); <span class="hljs-function"><span class="hljs-function">emit </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">linkReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(link)</span></span></span></span>; _socket.disconnectFromHost();</code> </pre><br><br>  We catch the signal in the Application class, copy the received link to the clipboard, show the message in the tray: <br><br><pre> <code class="cpp hljs">QApplication::clipboard()-&gt;setText(link); _trayIcon-&gt;showMessage(tr(<span class="hljs-string"><span class="hljs-string">"Done!"</span></span>), tr(<span class="hljs-string"><span class="hljs-string">"File shared!"</span></span>), QSystemTrayIcon::Information, <span class="hljs-number"><span class="hljs-number">6500</span></span>);</code> </pre><br><br>  Similarly implemented sending source code. <br><br><h3>  Server part </h3><br>  The server daemon was also made using Qt.  We tested the resulting solution under load (1000 simultaneously transmitted files) and decided that it would suit us. <br><br>  The server is implemented on the basis of a thread pool.  All connected clients are distributed between existing threads, work with clients occurs in asynchronous mode.  Saving the received data to files is also carried out in the hotel stream. <br><br>  The application uses classes: <br><br><ul><li>  Server </li><li>  ThreadPool </li><li>  Saver </li><li>  Socket </li></ul><br><br>  In the Server class, a tcp server (QTcpServer) is created, new connections are processed.  For the connected client, a Socket is created, which will be executed in one of the threads provided by ThreadPool_. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> socket = _server.nextPendingConnection(); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Socket(socket, ThreadPool::getNextThread(), it.value());</code> </pre><br><br>  In addition, when connecting, it checks whether the user has exceeded the limit. <br>  In the constructor of the Socket class, it is transferred to the execution thread passed to it (i.e., all events associated with this class will be processed in the event-loop_e running in another thread).  To do this, use the moveToThread function. <br><br>  Also inside the Socket, the incoming data is processed, a save signal is sent (emit saveFile).  This signal will process the class Saver, which is running in another thread.  After Saver saves everything to a file, it will send a signal that will process the Socket and send a link to the file to the client. <br><br><h3>  Hosting </h3><br>  The project was planned from the very beginning as open-source.  And when he was almost ready, there was a question about hosting.  We needed some kind of reliable hositng that could withstand the habra-effect.  It also raised the question of who will pay for this hosting, and whether we will get (financially) tired of supporting the project over time.  Therefore, we sent letters to several large companies with a proposal to participate in our project by providing us with hosting.  Having received several answers, we settled on a Scalaksi cloud hosting. <br><br>  The server has been installed debian, nginx, configured rc scripts and automatic restart using monit. <br><br><h3>  Future of the project </h3><br>  In the next version of the program, we plan to make the following features: <br><br><ul><li>  Add a transfer function by pressing a single button from the clipboard using the translate service, for example from Google. </li><li>  Preview pictures. </li><li>  Mac build (if someone can build qt applications under a poppy, help wouldn‚Äôt hurt) </li><li>  Internationalization </li><li>  Maybe you can offer something else. </li></ul><br><br><h3>  Links </h3><br>  <a href="http://pastexen.com/">pastexen.com</a> - the official website of the project <br>  <a href="https://github.com/bakwc/Pastexen">github.com/bakwc/Pastexen</a> - sources on github <br>  <a href="http://scalaxy.ru/">Scalaxy.ru</a> - <a href="http://scalaxy.ru/">Scalaxi</a> company, which provided cloud hosting to the project </div><p>Source: <a href="https://habr.com/ru/post/165647/">https://habr.com/ru/post/165647/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165637/index.html">MIT has developed a synthetic "muscle" that works on water</a></li>
<li><a href="../165639/index.html">Tyunim keyboard correctly</a></li>
<li><a href="../165641/index.html">Programming on Android for a web developer or a quick start for the little ones. Part 3</a></li>
<li><a href="../165643/index.html">What's inside the cable station headend</a></li>
<li><a href="../165645/index.html">Progressive JPEG: new best practice</a></li>
<li><a href="../165649/index.html">Javascript: from beginning to end</a></li>
<li><a href="../165657/index.html">The new Samsung refrigerator offers recipes based on its contents.</a></li>
<li><a href="../165659/index.html">Procrastination New tasks. Part 2</a></li>
<li><a href="../165661/index.html">Quipu is an esoteric programming language based on the Incas nodular script</a></li>
<li><a href="../165663/index.html">Optimization of LIKE expression when using Sqlite in iOS application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>