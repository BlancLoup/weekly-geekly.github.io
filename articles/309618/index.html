<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A little bit about ARM Security Extensions (aka ARM TrustZone)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is this article about 


 On Habr√© several times mentioned SMM - mode of the x86 / 64 processor which has more privileges than even the hyperviso...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A little bit about ARM Security Extensions (aka ARM TrustZone)</h1><div class="post__text post__text-html js-mediator-article"><h1>  What is this article about </h1><br><p>  On Habr√© several times mentioned <abbr title="System Management Mode">SMM</abbr> - mode of the x86 / 64 processor which has more privileges than even the hypervisor mode.  Something similar is in the ARMv7 and ARMv8 architecture processors.  The computational cores of these architectures may have an optional extension called ARM Security Extensions, which will allow to divide the executable code, memory and peripherals into two domains - trusted and untrusted.  The official marketing name for this technology is ARM TrustZone.  But techies often prefer to talk about security extensions. </p><br><p>  This will be a review article, so I will not go into the deaf technical jungle.  However, technical details will be present.  The first part of the article will be devoted to the question of why this is all needed, and the second - how it works in general terms.  If society is interested, the next article will contain more technical details.  Who cares - welcome under cat. </p><a name="habracut"></a><br><h1>  Why do we need ARM Security Extensions </h1><br><p>  Although the name contains the word "security", these extensions are needed not only to implement security-related functions in the usual sense of the word.  When we say security, we usually think about encryption, access restriction, <abbr title="Trusted Platform Module">TPM</abbr> , secure storage, and so on.  Security extensions allow you to implement all these functions, but they are also used for such things as, for example, starting and stopping processor cores, rebooting the system, etc. </p><br><h2>  Not quite security features </h2><br><p>  We all know that there is such a thing as BIOS (and now EFI).  Their task is to initialize the system, load the OS, provide the OS with information about the system, assist the OS in managing the computer. </p><br><p>  Historically, on ARM-based platforms there is no (more precisely, there was not) an analogue of BIOS.  Usually, a simple bootloader was present in the ROM code, which found and loaded the full bootloader.  Often, such a full-fledged bootloader is u-boot.  U-boot, in turn, initiated a minimum of peripherals (for example, started a DRAM controller), found and started the linux kernel.  The linux kernel, in turn, could completely wipe the u-boot out of memory, because it is no longer needed.  And everything, after loading the kernel was completely provided to itself.  All the information about the system where it works was sewn directly into it (or on the side, in a special structure called the device tree).  All operations for managing the system (for example, overclocking the processor) the kernel had to perform itself. </p><br><p>  This was inconvenient for a number of different reasons.  For example, manufacturers do not want to give core developers control over all sorts of "delicate" modules such as caches and buses.  Or, for example, the procedure for resetting the chip requires some tricky manipulations that are inconvenient to produce from the kernel code. </p><br><p>  In short, the need for something like a BIOS exists.  Only in ARM systems it calls Secure Monitor and works thanks to Security Extensions.  In my experience, it is most often used to start and stop additional cores in a multiprocessor system, control the bus, transfer running code between powerful and weak cores in the big.LITTLE achrititure, activate the hypervisor mode, and similar delicate things. </p><br><h2>  Security features </h2><br><p>  Security extensions allow you to run on the side of another OS with its own kernel and user applications.  It is commonly called Trusted OS.  This OS will have its own protected memory and access to the protected periphery, for example, crypto-accelerator.  Two examples of such OSs are google trusty and open source <a href="https://github.com/OP-TEE/optee_os">OP-TEE</a> .  There is a consortium of <a href="http://www.globalplatform.org/">Global Platform</a> which has developed general requirements for such an OS called <a href="http://www.globalplatform.org/mediaguidetee.asp">Trusted Execution Environment</a> . </p><br><p>  Google, for example, uses its OS to securely store keys ( <a href="https://source.android.com/security/keystore/">keymaster's</a> android service).  Motorola once used a proprietary implementation of a secure OS for <abbr title="Digital rights management">DRM</abbr> .  There was generally a fantastic system: the user could store and play DRM-videos, while even the android core could not at any time gain access to the memory where the decompressed (or at least decoded) video frames were stored.  But at the same time, Android could, for example, draw controls on top of such a video. </p><br><p>  Custom applications can be loaded into a secure OS (naturally signed).  This allows for example to drive a banking application there for payments via NFC or a virtual SIM card.  True, to be honest, in practice, I have not yet come across this. </p><br><p>  Also secure extensions allow you to organize Secure Boot: the root of trust is the ROM code that verifies the signature of the next bootloader, the bootloader can verify the kernel signature by contacting Secure Monitor.  The kernel, in turn, can also check the signatures of the executable code.  Thus, the main components will be protected from change. The technology is controversial, but some developers of android-devices love it very much. </p><br><h1>  How it all works </h1><br><p>  Information on technical details is open.  You can download the ARM Technical Reference Manual and read it yourself.  In addition, the web lacks all sorts of beautiful presentations.  I will not go into the deep jungle, just describe the main ideas.  I will use the terminology from ARMv8, because it is more consistent in comparison with the terms used in ARMv7. </p><br><h2>  CPU Modes </h2><br><p>  This section will provide some technical details.  If system programming is an absolutely dark topic for you, you can skip this section. </p><br><p>  Actually, everyone probably heard about the protection rings in x86.  In ARM, there is exactly the same thing, only here they are called Exception Levels (abbreviated as EL).  They can be from two to four (or six, depending on how you count).  These are the modes of operation of the processor.  The higher the Exception Level, the more privileges the code executing in it has. </p><br><p>  All ARMv7 or ARMv8 cores support at least two of them: EL0 and EL1. </p><br><p>  Custom programs (for example, your browser) work on EL0.  The code executing in EL0 has no privileges: it cannot (usually) work with peripherals, reconfigure the <abbr title="Memory Management Unit">MMU</abbr> , prohibit (and allow) interrupts, and handle exceptional situations.  But the browser does not need this.  And if you still need, then you need to ask the kernel OS. </p><br><p>  On the EL1, the kernel and drivers work.  They, respectively, have the opportunity to work with the periphery, to program the MMU and further on the list.  Even 10 years ago, this would be quite enough.  But technology does not stand still. </p><br><p>  Two more ELs may appear if the processor core includes additional extensions: virtualization extensions and security extensions.  Moreover, both of these extensions are optional (although they are present in all modern chips) and the processor can have either any of them, or both.  A large part of the ARM Technical Reference Manual is devoted to the interaction of these extensions. </p><br><p>  So, if there is virtualization extensions in the kernel, then EL2 appears.  At this level, the hypervisor works.  Also, the MMU becomes a two-stage and a virtual interrupt controller appears.  But this is another story to tell separately. </p><br><p> If security extensions are present in the processor, then the EL3 mode and the S-EL0 and S-EL1 modes appear.  In addition, the concept of secure mode appears (and accordingly non-secure mode) - these are processor modes orthogonal exception levels.  EL3 has the same privileges as EL2, plus another feature.  Only in EL3 mode can the code switch the processor between secure and non-secure mode.  What is the difference between them?  And the difference is only in the value of one bit - <abbr title="Non-secure">NS</abbr> . </p><br><p>  The fact is that security extensions are not only extensions for the compute core.  These extensions also affect the MMU, interrupt controller, and bus controller.  For example, the bus controller checks the value of this NS bit itself when accessing memory and peripherals.  If the memory is marked as secure, then access to it can only be obtained from secure mode.  This means that neither the kernel of the normal OS, nor the hypervisor can read / change the "safe" memory.  The same with the periphery.  If an interrupt arrives which is marked as secure, then the interrupt will not be processed by the normal OS, but by the trusted OS from the secure mode. </p><br><p>  It turns out that two worlds live in the same processor: the normal world and the secure world (these are terms from the official documentation, if that).  At what secure world can interfere in the affairs of the normal world, but not vice versa.  In EL3 mode, a secure monitor works, which serves as a Charon - allows you to get from one world to another. </p><br><p><img src="http://infocenter.arm.com/help/topic/com.arm.doc.prd29-genc-009492c/vsd/ch3_worlds.svg" alt="Worlds interaction"></p><br><p>  As you probably already guessed, the S-EL0 and S-EL1 modes are EL0 and EL1 analogues from the normal world.  In S-EL1, the core of the "safe" OS runs, and in S-EL0 - applications (for example, the same virtual SIM card).  The picture above uses the terminology from ARMv7, but it‚Äôs easy to understand what‚Äôs what (I hope). </p><br><h2>  Normal World and Secure World interaction </h2><br><p>  The processor always starts in secure-mode (because otherwise it will not get there).  Trusted OS is loaded and initialized, after which the processor goes into non-secure mode and loads the normal OS. </p><br><p><img src="http://www.virtualopensystems.com/static/vosapp/images/atf_layer_extensions.png" alt="Boot process"></p><br><p>  It would seem that with all its capabilities the secure world should occupy a dominant position in the system.  But actually the opposite is true.  Most of the time it is inactive.  Only when a normal OS needs some services, does it turn to the secure monitor and control passes to the secure world.  Thus, it is the normal world that decides when the secure world will work.  This is done in order not to interfere with the user to work with the device, watch videos and listen to music.  After all, if a secure world takes control at an inopportune moment, then it can disrupt normal world. </p><br><p>  In fact, the secure world has the ability to get control bypassing the normal world using interrupts.  For example, you can start a timer that will periodically call a secure world.  But this is not usually done for the reasons indicated above.  User experience is paramount. </p><br><p>  For the linux kernel, there is a patch set that allows normal applications to interact with applications running on Trusted OS, according to the GlobalPlatform TEE specifications, which I already mentioned above.  So developers can write applications that (with minor changes) will be able to work on any compatible Trusted OS. </p><br><h2>  Paranoiac corner </h2><br><p>  Can a secure world keep track of you?  Theoretically, yes.  In practice, I had access to a proprietary trusted OS, which was then installed on user devices.  In their code, I did not see such functions.  Which, of course, does not mean anything. </p><br><p>  If secure boot is activated on your device, then you have problems.  In the sense that you can not do anything with code running in a secure world.  True, you also can not do anything with code running in kernel mode. </p><br><p>  Fortunately, SoCs with a secure boot enabled are quite rare and they try not to sell them to everyone.  Therefore, you rather have the opportunity to replace the trusted OS with your own.  True, there is still a ROM code with which you can do almost nothing.  And if the secure monitor is sewn into a ROM code, then again you have problems.  But, there are SoCs, on which you can install your secure monitor.  For example - Renesas RCAR H3.  So all is not lost. </p><br><p>  For those who want to experiment - there is an opportunity to raise Trusted OS on the Raspberry PI.  How to do this is written in the documentation for OP-TEE. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/309618/">https://habr.com/ru/post/309618/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309606/index.html">Moscow JS Meetup in Badoo</a></li>
<li><a href="../309608/index.html">Business planning web studio at the start</a></li>
<li><a href="../309612/index.html">What interesting things have I learned in two years of developing and promoting a mobile game?</a></li>
<li><a href="../309614/index.html">‚ÄúNot a single break‚Äù: what is the cost of making an online broadcast that will not fall, slow down and cause pain in the eyes?</a></li>
<li><a href="../309616/index.html">Google Analytics for Telegram Bot</a></li>
<li><a href="../309622/index.html">Manual start timer (work on bugs)</a></li>
<li><a href="../309624/index.html">The work of NSFetchRequest and NSFetchedResultsController, as well as why there is a grocery market</a></li>
<li><a href="../309626/index.html">The logic of consciousness. Part 5. The semantic approach to the analysis of information</a></li>
<li><a href="../309628/index.html">Script for those who are too lazy to understand Linux</a></li>
<li><a href="../309630/index.html">Expert Opinions on Google‚Äôs 20% Rule</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>