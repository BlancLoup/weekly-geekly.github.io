<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Again about leaky abstractions (or about unpredictable environments)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, quite a simple part of the program under Windows. There is a file containing several entries. And they need to be filtered in a certain way. 

 Th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Again about leaky abstractions (or about unpredictable environments)</h1><div class="post__text post__text-html js-mediator-article">  So, quite a simple part of the program under Windows.  There is a file containing several entries.  And they need to be filtered in a certain way. <br><br>  The solution is quite simple - open the file, read the records one by one, we write the necessary ones to a temporary file.  Close the file.  Remove it.  Rename temporary to original.  Everything is so simple that I will not even give the code.  Is this a sufficient reason for the article? <br><br>  While everything is working, there is no reason to write about it, and the truth is not.  But then suddenly one day ‚Äúeverything falls‚Äù, because  renaming does not occur due to an ‚ÄúAccess denied‚Äù error.  This happens very rarely, but still much more often to suspect cosmic rays. <br><a name="habracut"></a><br>  We start the excavation.  The first clue found: in the process of digging, this alarmed quote from Microsoft's documentation was alarmed: <br><blockquote>  Function for deletion on close.  Therefore, it is not true that the file is deleted.  ERROR_ACCESS_DENIED. </blockquote>  In terms of symptoms, it‚Äôs very similar, but where do these ‚Äúother handlers‚Äù come from, if, apart from us, nobody does and shouldn‚Äôt do anything with this file?  And we have no other threads with threads that would do something with this file? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The culprit was found thanks to SysInternals and their ProcessMonitor.  We launch it, install the filter on our long-suffering file and long and aggressively try to reproduce it.  Reproducible.  We look.  And what do we see there? <br><blockquote>  01. 2: 25: 28.3162097 PM our_prog.exe 1288 CreateFile our.file SUCCESS Desired Access: Generic Read / Write <br>  02. 2: 25: 28.3164513 PM our_prog.exe 1288 WriteFile our.file SUCCESS Offset: 0, Length: 898, Priority: Normal <br>  ... <br>  34. 2: 25: 28.3173405 PM our_prog.exe 1288 WriteFile our.file SUCCESS Offset: 35,290, Length: 1,113 <br>  35. 2: 25: 28.3173493 PM our_prog.exe 1288 WriteFile our.file SUCCESS Offset: 36,403, Length: 1,128 <br>  36. 2: 25: 28.3173736 PM our_prog.exe 1288 FlushBuffersFile our.file SUCCESS <br>  37. 2: 25: 28.3174212 PM our_prog.exe 1288 WriteFile our.file SUCCESS Offset: 0, Length: 40,960, <br>  38. 2: 25: 28.3175927 PM Explorer.EXE 1884 QueryBasicInformationFile our.file SUCCESS <br>  39. 2: 25: 28.3176144 PM Explorer.EXE 1884 CloseFile our.file SUCCESS <br>  40. 2: 25: 28.3263642 PM Explorer.EXE 1884 CreateFile our.file SUCCESS Desired Access: Read Attributes, <br>  41. 2: 25: 28.3294990 PM our_prog.exe 1288 CloseFile our.file SUCCESS <br>  42. 2: 25: 28.3351356 PM our_prog.exe 1288 CreateFile our.file SUCCESS Desired Access: Read Attributes, Delete, <br>  43. 2: 25: 28.3351856 PM our_prog.exe 1288 QueryAttributeTagFile our.file SUCCESS Attributes: A, ReparseTag: 0x0 <br>  44. 2: 25: 28.3352020 PM our_prog.exe 1288 SetDispositionInformationFile our.file SUCCESS Delete: True <br>  45. 2: 25: 28.3352218 PM our_prog.exe 1288 CloseFile our.file SUCCESS <br>  46. ‚Äã‚Äã2: 25: 28.3358275 PM our_prog.exe 1288 CreateFile our.file DELETE PENDING Desired Access: Generic Read / Write, <br>  47. 2: 25: 28.3362207 PM our_prog.exe 1288 CreateFile our.file DELETE PENDING Desired Access: Generic Read / Write, <br>  48. 2: 25: 28.3367696 PM Explorer.EXE 1884 QueryBasicInformationFile our.file SUCCESS <br>  49. 2: 25: 28.4279152 PM Explorer.EXE 1884 CloseFile our.file SUCCESS <br>  50. 2: 25: 28.4282859 PM Explorer.EXE 1884 CreateFile our.file NAME NOT FOUND Desired Access: Read Attributes, <br>  ... <br>  83. 2: 25: 29.3497760 PM our_prog.exe 1288 CreateFile our.file SUCCESS Desired Access: Generic Read / Write, </blockquote>  And we see the following there (extra data is deleted so as not to clutter up).  Lines 1 to 36 - we create a file, write to it, make flush.  The most interesting begins in lines 38-40.  Explorer.exe appears in them and starts reading our file. <br><br>  In line 41 we close our file.  In line 42 - delete.  And since explorer.exe still reads it, the file is not deleted.  What we can see in lines 46 and 47 when we try to rename our temporary file to the main one (DELETE PENDING status instead of SUCCESS). <br><br>  Explorer.exe finishes reading only in line 49. Only at this moment the file is physically deleted (which is indirectly indicated by line 50, where our persistent explorer.exe again tries to open the file for reading, but it fails because the file no longer). <br><br>  What follows from this?  Thanks to Microsoft Windows, even the simple operation of deleting a file now needs to be done in the style of paranoid programming.  They called the delete function, made sure that it returned OK, and entered the wait cycle "until the file has been physically deleted yet."  Well, yes, without knowing that ‚Äúshe has a neon inside her‚Äù, practically nothing can be done ... <br><br>  But now I doubt that such an approach is a common practice.  So that during any work with files in Windows, to keep in mind that the OS will at any time decide something to do with files without your knowledge, and write code that is resistant to it.  In this connection, the survey is lower. </div><p>Source: <a href="https://habr.com/ru/post/450700/">https://habr.com/ru/post/450700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450694/index.html">Why does Jeff Bezos recommend scaling failures and watching science fiction</a></li>
<li><a href="../450696/index.html">CRUD widget generator for Yii</a></li>
<li><a href="../450698/index.html">Gears in Box2D</a></li>
<li><a href="../4507/index.html">Mail.Ru launches video hosting</a></li>
<li><a href="../45070/index.html">Project EmForge.</a></li>
<li><a href="../450702/index.html">The place is damned?</a></li>
<li><a href="../450704/index.html">Security Week 19: vulnerabilities in IP cameras, GPS trackers and wireless monitors</a></li>
<li><a href="../450710/index.html">Midi reconstruction from Synthesia video clips (and similar ones)</a></li>
<li><a href="../450712/index.html">DotNetRu at the DotNext 2019 Piter conference</a></li>
<li><a href="../450718/index.html">What's new in RxJS v6.5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>