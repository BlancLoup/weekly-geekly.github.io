<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>In defense of swap [in Linux]: common misconceptions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Note trans. : This fascinating article, revealing in detail the purpose of swap in Linux and responding to a common misconception about it, was writte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>In defense of swap [in Linux]: common misconceptions</h1><div class="post__text post__text-html js-mediator-article">  <i><b>Note</b></i>  <i><b>trans.</b></i>  <i>: This fascinating article, revealing in detail the purpose of swap in Linux and responding to a common misconception about it, was written by Chris Down - SRE from Facebook, who, in particular, is developing new metrics in the kernel that help analyze the load on the RAM.</i>  <i>And he begins his story with a concise TL; DR ...</i> <br><br><img src="https://habrastorage.org/webt/7a/io/tf/7aiotfjgvdmjiv33-1ihirx_x7c.png"><a name="habracut"></a><br><br><h2>  TL; DR </h2><br><ul><li>  Swap is a fairly important part of a well-functioning system.  Without it, it is more difficult to achieve reasonable memory management. </li><li>  Swap is needed not so much for urgent memory acquisition, but for even and efficient memory release.  To use it as an “urgent memory” is generally very harmful. </li><li>  Disabling swap does not save you from disk I / O problems with memory contention — disk I / O simply moves from anonymous pages to file pages.  Not only can this be less effective, since there remains a smaller pool of pages available for release, but in itself can contribute to the emergence of this high competition. </li></ul><br><h2>  Foreword </h2><br>
     <a href="https://www.youtube.com/watch%3Fv%3DikZ8_mRotT4">cgroup v2</a>,            ,            ,  « »   .<br>
<br>
     swap.  swap       ,    Linux  .          — ,   ,         ,      .    ,   ,        :        , ,   ,   ,  swap —  -     ,     ,    .<br>
<br>
      swap':       «  »     ,               .<br>
<br>
        : «Linux    », «swap       »  ..             ,    «» swap       ,       , —         .<br>
<br>
      ,   Linux-    ,     /   swap    <code>vm.swappiness</code>,   0.<br>
<br>
<h2></h2><br>
 ,   swap'       —    ,            Linux,   ,     .<br>
<br>
<h3> </h3><br>
 Linux     ,         .    —   ,  swap .<br>
<br>
,  <a href="https://en.wikipedia.org/wiki/Page_(computer_memory)"><i></i></a> («» ,   4k),       ,   .   ,      ,   ,           .    <a href="https://en.wikipedia.org/wiki/Page_cache"> </a> <i>[page cache]</i>,           <i>[file]</i> .<br>
<br>
  ,     ,    , ,   <code>malloc</code>            <code>MAP_ANONYMOUS</code>  <code>mmap</code>.  «»  —   ,     «», —          <i>[anon]</i> .<br>
<br>
    :  , slab-,   ,   , —             ,       , , ,      .<br>
<br>
<h3>    </h3><br>
             . «» <i>[reclaim]</i> ,   ,   ,       .<br>
<br>
       . ,    <i>[clean]</i>, .. ,          ,     ,        -  .<br>
<br>
     ,  . ,    <i>[dirty]</i>, .. ,         ,        .       <i>[reclamation]</i>,         ,    .<br>
<br>
     . ,              ,      (..   ).<br>
<br>
<h3>  swap'</h3><br>
  ,   swap  Linux,           RAM   . , ,  ,        Google   «what is swap»:<br>
<br>
<blockquote>«   swap —   ;    ,    -       ,    RAM.   «»   ,    ,       swap, ,    . [..]     RAM          ,       swap-».</blockquote><br>
,             —  « »,     Linux  , ,         swap'.  ,          swap',    .<br>
<br>
    ,    «»,          ,         , —  ,          . …  ,          ?<br>
<br>
      swap. Swap —    ,  «» <i>[unreclaimable]</i>, ,        .  ,          ,          (   ),       .<br>
<br>
Swap —      ,     « ».  swap     —   -     .<br>
<br>
,      « »      ?        :<br>
<br>
<ol>
<li>            .         /,     «» (   ) .     ,     .</li>
<li>         ,    .             -  ,   <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D1%2582%25D0%25BA%25D0%25B0%25D0%25B7_%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B8%25D1%2586%25D1%258B">  </a>       .</li>
</ol><br>
<h2>    swap   </h2><br>
              swap.   «  »    <a href="https://www.youtube.com/watch%3Fv%3DikZ8_mRotT4">  cgroup v2</a>.<br>
<br>
<h3>       </h3><br>
<ul>
<li> <b>  swap</b>:     swap  ,            .              .</li>
<li> <b> swap</b>:     swap    ,       .  ,      ,         -   ,      .</li>
</ul><br>
<h3>      </h3><br>
<ul>
<li> <b>  swap</b>:       .        —    ,         (  <i>[thrashing]</i>).</li>
<li> <b> swap</b>:    , ..     .      ,        .    .    ,      ,      / ,    :    disk I/O - swapping'        ,    .</li>
</ul><br>
<h3>     </h3><br>
<ul>
<li> <b>  swap</b>:     ,            OOM killer  .               ,    .</li>
<li> <b> swap</b>: OOM killer  ,          .     ,      OOMing' .     —    . ,              OOMing'.   ,         — OOM killer       .  ,     ,          <i>(..      — <b>. .</b>)</i>         .</li>
</ul><br>
<h2>,    swap,       ?</h2><br>
   ,         cgroup v2?<br>
<br>
,         ,        .   ,       ,  <code>vm.swappiness</code>.    : <code>vm.swappiness</code>    ,           ,       ,      .<br>
<br>
   <code>mlock</code>     ,            <code>LD_PRELOAD</code>,         .  ,    ,     -  ,             <code>mlockall</code>,        ,   .<br>
<br>
 cgroup v2     cgroup  <code>memory.low</code>,                .  ,    swapping  ,             .     swap'      ,       swap       .  swap'        ,        ,   swapper'.  ,      ,           «».<br>
<br>
        OOM killer.   OOM killer      ,   <i></i>      , ,     .         ,    OOM killer'.<br>
<br>
  ,             Linux.   ,  -    ,    :  ,      .. —             ,      .      Facebook,  <a href="https://patchwork.kernel.org/project/LKML/list/%3Fsubmitter%3D45">Johannes'</a>     ,     , —      .           cgroup v2,   <a href="https://youtu.be/ikZ8_mRotT4%3Ft%3D2145">  </a>    .<br>
<br>
<h2></h2><br>
<h3>  swap'   ?</h3><br>
     swap-,     ,     ,           ,        .  —       ,      ,      ,    .<br>
<br>
        (4.0+) ,   swap'   ,  .     kswapd —    ,     swap', —        swap,    ,   swap'  .     swapping'    swap-  .  ,      4.0+,  swap     swapping'.  ,      swap    ,      .<br>
<br>
    ,      ,     ,   .        swap',         ( ) .       2-3  swap'    ,             ( ).           ,      ,    swap'   .   , ,    swap           .  atop      <code>SWAPSZ</code>  ,      swap.                — ,          (  ).   ,       swap,           .<br>
<br>
       swap'.   swap     ,    ,       .  SSD     ,       /    ,    .   ,       ,  ,      ,   .   ,               swapping'  , ,  ,    ,        .<br>
<br>
  /,   swap      <i>[hibernate]</i>,     ,  swap-         .<br>
<br>
<h3>    swappiness?</h3><br>
-,  ,   <code>vm.swappiness</code>.    (sysctl),          .      : <code>file_prio</code> (   )  <code>anon_prio</code> (   ). <code>vm.swappiness</code>   ,      <code>anon_prio</code>      200  <code>file_prio</code>,   <code>vm.swappiness = 50</code>   <code>anon_prio</code>  50  <code>file_prio</code>  150 (     —      ).<br>
<br>
 ,  <b><code>vm.swappiness</code> —        ,       ,           </b>.   ,     ,           swap     .    ,     ,   swapping'        .     -  ,   swap    ,  ,  «» ,  swappiness       swapping'      ,    .  SSD-      ,   <code>vm.swappiness = 100</code> (..  )   .    swapping    , ..      ,          .<br>
<br>
   ,        ,    ,    ,    ,  —  ,      .        ,          .<br>
<br>
  <code>vm.swappiness</code>,   <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git/patch/%3Fid%3Dfe35004fbf9eaf67482b074a2e032abb9c89b1dd">  </a>  ,  Satoru Moriya  vmscan  2012 :       <code>vm.swappiness = 0</code>.<br>
<br>
    ,    <code>vm.swappiness = 0</code>      ( )   ,        .   ,        ,            ,             .  <code>vm.swappiness = 1</code> —  ,   ,            ,   .<br>
<br>
    — <code>vm.swappiness = 60</code>.          ,      ,    .     ,    «  swap'   ?»,       <code>vm.swappiness</code>           ( ).   ,      <a href="https://youtu.be/ikZ8_mRotT4%3Ft%3D2145"> refault</a>   <i>(.  «<a href="https://lwn.net/Articles/495423/">refault distance-based file cache sizing</a>» — <b>. .</b>)</i>,         ,    «page refaulting»  cgroup v2.<br>
<br>
<h2></h2><br>
<ul>
<li> Swap —        ,      ,        .     swap   ,    ,       ,     ,   - .</li>
<li>  swap      /     —  I/O       .       ,     ,   ,           .</li>
<li> Swap    OOM kill ,   ,  ,        .  OOM killer     ,      .       :<br>
<ul>
<li>            ,     (cgroup)     .     ,      Unix         .         <a href="https://youtu.be/ikZ8_mRotT4%3Ft%3D2145">refault detection</a>.</li>
<li>     (,  , swapping)    (per-cgroup)   <code>memory.low</code>,            swap.</li>
</ul></li>
</ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348324/">https://habr.com/ru/post/348324/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348308/index.html">Digital events in Moscow from February 5 to 11</a></li>
<li><a href="../348310/index.html">“VITAMIN ROSTA”: how LANIT attracts young people and how young professionals get into LANIT</a></li>
<li><a href="../348312/index.html">How to "learn to learn" - tips, advice and research</a></li>
<li><a href="../348314/index.html">Parsers, word processing. Just about the complicated. CFG, BNF, LL (k), LR (k), PEG and other scary words</a></li>
<li><a href="../348320/index.html">As I prepared a visual novel</a></li>
<li><a href="../348326/index.html">Big Migration: How we raised a private cloud at RISC</a></li>
<li><a href="../348328/index.html">Creating a bonus system in Unity</a></li>
<li><a href="../348330/index.html">AI @ MIPT: “Neuromorphic computations and brain mechanisms”</a></li>
<li><a href="../348332/index.html">Bored mail or how to send messages from the site to Telegram via Node.js (Express)</a></li>
<li><a href="../348334/index.html">Game design to life. An example of the analysis of the mechanics of the game</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>