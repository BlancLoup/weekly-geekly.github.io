<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Forwarding a video card to a guest OS from a KVM hypervisor using VFIO technology</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 The article describes a method for forwarding physical devices from a KVM hypervisor to a guest OS using VFIO technology implemented in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Forwarding a video card to a guest OS from a KVM hypervisor using VFIO technology</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  The article describes a method for forwarding physical devices from a <b>KVM</b> hypervisor to a guest OS using <b>VFIO</b> technology implemented in linux kernel 3.9. *. <br>  The material is not a guide to action (approx. Tutorial).  All the instructions described are at your own risk. <br><br>  The experiment is performed under Ubuntu OS 13.10: <br><br><ul><li>  kernel: 3.11.0-15-generic </li><li>  qemu: 1.5.0 </li><li>  seabios: 1.7.3 </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Hardware part of the stand: <br><br><ul><li>  mat.  Fee: AMD990FX </li><li>  processor: AMD FX-8120 </li><li>  operas  memory: DDR3 PC3-14900 </li><li>  video card: ATI RADEON HD 7750 </li><li>  video card (guest): NVIDIA GTX560-TI </li></ul><br><br>  <i>The video card for the guest system and the host, perhaps, presumably, any (NVIDIA, ATI RADEON).</i> <br>  <i>The motherboard must have an I / O memory management unit (IOMMU) - AMD-Vi or VT-d technology.</i> <br>  <i>If an Intel processor is used, it must also support VT-d.</i> <br>  <i>Regardless of the chosen platform, IVRS / DMAR tables should be implemented in the BIOS of the motherboard.</i> <br><a name="habracut"></a><br><h3>  Training </h3><br>  <b>It is strongly recommended to update the BIOS.</b>  <b>boards from the manufacturer's site before the start of the experiment.</b> <br><br>  We check the support for forwarding technology. <br><pre><code class="bash hljs">$ dmesg | grep AMD-Vi [ 1.279788] AMD-Vi: Found IOMMU at 0000:00:00.2 <span class="hljs-built_in"><span class="hljs-built_in">cap</span></span> 0x40 [ 1.279790] AMD-Vi: Interrupt remapping enabled [ 1.292879] AMD-Vi: Lazy IO/TLB flushing enabled</code> </pre> <br><br>  We include modules in the core. <br><pre> <code class="bash hljs">$ cat /etc/modules <span class="hljs-comment"><span class="hljs-comment"># /etc/modules: kernel modules to load at boot time. lp rtc pci_stub vfio vfio_iommu_type1 vfio_pci #vfio_pci_vga (For now, this component is in the stock Ubuntu kernel.) kvm kvm_amd</span></span></code> </pre><br><pre> <code class="bash hljs">$ sudo update-initramfs -u</code> </pre><br><br>  We disable the devices being forwarded (for convenience, the controller usb ports are also forwarded). <br><pre> <code class="bash hljs">$ lspci -nn | grep NVIDIA 03:00.0 VGA compatible controller [0300]: NVIDIA Corporation GF114 [GeForce GTX 560 Ti] [10de:1200] (rev a1) 03:00.1 Audio device [0403]: NVIDIA Corporation GF114 HDMI Audio Controller [10de:0e0c] (rev a1)</code> </pre><br><pre> <code class="bash hljs">$ cat /etc/default/grub | grep GRUB_CMDLINE_LINUX_DEFAULT GRUB_CMDLINE_LINUX_DEFAULT=<span class="hljs-string"><span class="hljs-string">"quiet splash pci-stub.ids=10de:1200,10de:0e0c,1002:4397,1002:4396"</span></span></code> </pre><br><pre> <code class="bash hljs">$ sudo update-grub</code> </pre><br><br>  After a reboot, it should work: <br><pre> <code class="bash hljs">$ dmesg | grep pci-stub [ 3.163062] pci-stub: add 10DE:1200 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 3.163088] pci-stub 0000:03:00.0: claimed by stub [ 3.163100] pci-stub: add 10DE:0E0C sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 3.163116] pci-stub 0000:03:00.1: claimed by stub [ 3.163124] pci-stub: add 1002:4397 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 3.163136] pci-stub: add 1002:4396 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000</code> </pre><br><br>  Create a script to connect the device to the VFIO-PCI. <br><pre> <code class="bash hljs">$ cat /usr/bin/vfio-bind <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash modprobe vfio-pci for dev in "$@"; do vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done</span></span></code> </pre><br><pre> <code class="bash hljs">$ sudo chmod 755 /usr/bin/vfio-bind</code> </pre><br><br>  And we add it to the autorun (we take the keys from the lspci call - discussed above). <br><pre> <code class="bash hljs">$ cat /etc/rc.local <span class="hljs-comment"><span class="hljs-comment">#!/bin/sh -e /usr/bin/vfio-bind 0000:03:00.0 0000:03:00.1 0000:00:12.0 0000:00:12.2 exit 0</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Small process automation</b> <div class="spoiler_text">  <b>Attention: set your parameters!</b> <br><br><pre> <code class="bash hljs">$ cat pass.sh <span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #configs modules="pci_stub;vfio;vfio_iommu_type1;vfio_pci;kvm;kvm_amd" grub="quiet splash pci_stub.ids=10de:1200,10de:0e0c,1002:4397,1002:4396" autorun="/usr/bin/vfio-bind 0000:03:00.0 0000:03:00.1 0000:00:12.0 0000:00:12.2" #functions split() { #$1 - file, $2 - param arr=$(echo $2 | tr ";" "\n") for x in $arr do echo $x &gt;&gt; $1 done } replaceParam() { #$1 - file, $2 - param, $3 - value cur_val=`cat $1 | grep $2` sed "s/$cur_val/$2=\"$3\"/g" -i $1 } autorunAdd() { #$1 - param str='$i \'"$1"'\n' sed -i -e "$str" /etc/rc.local } pause() { read -p "$1" -n1 -s echo } #info virtualization dmesg | grep AMD-Vi pause 'Press any key to continue or CTRL-C to exit...' #modules load split '/etc/modules' "$modules" update-initramfs -u #grub config replaceParam '/etc/default/grub' 'GRUB_CMDLINE_LINUX_DEFAULT' "$grub" update-grub autorunAdd "$autorun"</span></span></code> </pre><br><pre> <code class="bash hljs">$ cat vfio-bind <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash modprobe vfio-pci for dev in "$@"; do vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done</span></span></code> </pre><br><pre> <code class="bash hljs">$ sudo cp vfio-bind /usr/bin/ $ sudo chmod 755 /usr/bin/vfio-bind $ sudo chmod 755 pass.sh $ sudo bash pass.sh</code> </pre><br></div></div><br><br><h3>  Launch </h3><br>  WINDOWS 7 with paravirtual VIRTIO drivers is used as a guest OS.  In accordance with this selected virtual machine equipment. <br><br><pre> <code class="bash hljs">$ cat win7_vfio_test.sh <span class="hljs-comment"><span class="hljs-comment">#! /bin/sh IS_TAP0_EXISTS=`ifconfig | grep -c tap0` if [ $IS_TAP0_EXISTS = 0 ] ; then sudo tunctl -t tap0 &amp;&amp; sudo ifconfig tap0 0.0.0.0 promisc up &amp;&amp; sudo brctl addif br0 tap0 &amp;&amp; echo 'Success: tap0 interface created.' || echo 'Error: tap0 interface is not created.' else echo 'Success: tap0 interface already exists.' fi #init kvm-qemu sudo qemu-system-x86_64 \ -boot menu=on \ -enable-kvm \ -M q35 \ -m 1024 \ -cpu host \ -rtc base=localtime \ -smp 1,sockets=1,cores=1,threads=1 \ -bios /usr/share/qemu/bios.bin \ -acpitable file=/usr/share/seabios/q35-acpi-dsdt.aml \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root \ -device ahci,bus=pcie.0,id=ahci \ -device virtio-balloon-pci,id=balloon0,bus=pcie.0,addr=0x6 \ -drive file='/dev/sdc6',if=none,id=drive-virtio-disk0,format=raw -device virtio-blk-pci,scsi=off,bus=pcie.0,addr=0x5,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=2 \ -drive file='windows7.iso',if=none,id=drive-ide0-1-0,readonly=on,format=raw -device ide-cd,bus=ide.1,unit=0,drive=drive-ide0-1-0,id=ide0-1-0,bootindex=1 \ -drive file='virtio-win-0.1-74.iso',if=none,id=drive-ide0-2-0,readonly=on,format=raw -device ide-cd,bus=ide.2,unit=0,drive=drive-ide0-2-0,id=ide0-2-0 \ -netdev tap,ifname=tap0,id=hostnet0,script=no,downscript=no -device virtio-net-pci,netdev=hostnet0,mac=52:54:00:26:7F:96,id=net0 \ -device vfio-pci,host=00:12.0,bus=pcie.0 \ -device vfio-pci,host=00:12.2,bus=pcie.0 \ -device vfio-pci,host=03:00.0,bus=root,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=03:00.1,bus=root,addr=00.1 \ -vga none \ -nographic #-vnc 127.0.0.1:0</span></span></code> </pre><br><br>  In the VM, the hard disk partition is forwarded -drive file = <b>/ dev / sdc6</b> . <br>  The initial installation was done without forwarding physical devices (you can use -vnc 127.0.0.1 stray or a standard console). <br>  Arguments -vga none -nographic should be added when forwarding video card components (-device vfio-pci). <br><br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/211909/">https://habr.com/ru/post/211909/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211891/index.html">Unfulfilled hopes: what was planned and what happened in the program ‚ÄúSpace Shuttle‚Äù</a></li>
<li><a href="../211893/index.html">Homemade curtain drive</a></li>
<li><a href="../211899/index.html">Features of MVP implementation for Windows Forms</a></li>
<li><a href="../211903/index.html">This is our world</a></li>
<li><a href="../211905/index.html">Use Audio API to create vocoder</a></li>
<li><a href="../211911/index.html">Watch the Olympics using IPTV</a></li>
<li><a href="../211913/index.html">Screw ActiveRecord to the site</a></li>
<li><a href="../211915/index.html">Virtualization with OpenVZ</a></li>
<li><a href="../211917/index.html">Data backup with btrfs and LVM bash scripts</a></li>
<li><a href="../211921/index.html">Forward notifications of incoming calls and SMS to the computer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>