<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Forwarding a video card to a virtual machine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is said that modern hardware virtualization support technologies (VT-d from Intel, IOMMU from AMD) allow the physical device on the PCI bus to be d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Forwarding a video card to a virtual machine</h1><div class="post__text post__text-html js-mediator-article">  It is said that modern hardware virtualization support technologies (VT-d from Intel, IOMMU from AMD) allow the physical device on the PCI bus to be directly managed by the virtual machine.  Including a video card. <br>  Imagination draws this configuration: a desktop server with a hypervisor, it runs a guest user operating system that has access to the necessary I / O devices, one or two unpretentious servers as needed, and how many virtual machines are needed for inhuman experiments.  We manage the hypervisor through the console in the guest OS either remotely, from a laptop, for example. <br>  Inspired by this picture, I decided to try it, but it turned out that passthrough the video adapter was not a trivial task.  Only a month after three butting with iron and reading the forums managed to get a positive result.  I tried <a href="http://www.vmware.com/">VMware</a> and <a href="http://xen.org/">Xen as a hypervisor</a> .  It turned out only with Xen. <br><a name="habracut"></a><br>  Short. <br>  Iron: <ul><li>  <a href="http://www.gigabyte.ru/products/page/mb/ga-q67m-d2h-b3rev_10/">Gigabyte GA-Q67M-D2H-B3</a> motherboard <br>  BIOS Firmware - F5 <br>  Setup: CPU-&gt; Intel Virtualization Technology = ON <br>  Setup: Chipset-&gt; North Bridge-&gt; VT-d = ON </li><li>  Intel Core i5 2500 3.3 GHz processor </li><li>  Memory 16 GB </li><li>  ATI Radeon HD 3470 in the first PCIe slot, used by the hypervisor </li><li>  ATI Radeon HD 3450 in the second PCIe slot, guest OS is given </li><li>  Intel network adapter in a PCI slot </li></ul><br>  Soft: <ul><li>  XCP (Xen Cloud Platform) 1.0 (XenServer build 42052c) </li><li>  Citrix XenCenter to manage </li><li>  Windows 7 64 bit as guest OS, ATI Catalyst 12.1 </li></ul><br>  At first, I experimented with VMware vSphere 5.0 for a long time.  Actually, the hardware configuration was chosen just for her.  On the way, a number of interesting details opened up: for example, the VT-d should be supported by the processor (they write that processors with the K index are not suitable), and by the chipset and the motherboard.  With video cards in general, the trouble is: it‚Äôs known that with the majority this trick doesn‚Äôt work, with some (rather short list), some succeed, others don‚Äôt.  A long and informative (although not too joyful) discussion was here: <br>  <a href="http://communities.vmware.com/thread/297072">VMware Communities: VMDirectPath and ATI Radeon</a> .  Radeon 3450 went, perhaps, in favorites as one of the most forwarded cards. <br>  I went through a decent amount of various iron combinations.  The competition involved two motherboards, three video cards, plus an integrated SandyBridge video (IGD), three network adapters and one processor.  Several times I threw these fruitless attempts for a week or two, then I came up with some options.  On the way, there was one moment when it almost turned out: the virtual machine correctly identified the monitor, but it did not go further.  I rested on the fact that the card seemed to be normally forwarded to a virtual machine, and the device manager appeared to be exactly, but Catalyst stubbornly refused to deal with it.  The map is as lively but not working. <br><br><img src="https://habrastorage.org/storage2/5ab/41a/bdd/5ab41abddf8a0055dd499a2f29480c55.png" alt="device manager"><br><br>  You could try a lot more: Windows XP and Linux as guest systems (set Windows 7 in 32 and 64-bit versions), get another video card ... In the end, spat and decided to go in from the other end, trying another hypervisor.  Without further thinking, he took what was in plain sight: <a href="http://xen.org/">Xen</a> as part of the <a href="http://xen.org/products/cloudxen.html">Xen Cloud Platform</a> (XCP). <br>  XCP delivered without a hitch. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/ba2/dfa/75f/ba2dfa75fd8b7840e1dfd9f850a8e93f.jpg" alt="xcp"><br><br>  For a while I stumped the question: how to steer this system?  In the sense, there must be some kind of management console, preferably under Windows?  Having picked up half a day with conditionally- <a href="http://sourceforge.net/projects/openxenmanager/">staffed OpenXenManager,</a> I came to the conclusion that either the skis do not go, or this cross-platform tool does not live on Windows.  Once or twice she connected to the server, but she died somewhere in the process, the rest of the times she hung dumb when connected, merging an irresistible stream of exceptions into the Python console. <br>  Fortunately, a broader view of the surrounding Internet has revealed to me that <a href="http://www.citrix.com/lang/English/lp/lp_2307783.asp">Citrix XenCenter</a> can perfectly control opensen-Xen, and is completely free.  However, when connecting, it shouts that the Evaluation period will expire on your server in N days, but people in the know write that it‚Äôs just that they don‚Äôt know about the opensource of the server‚Äôs edition, but in fact everything will work. <br>  XenCenter allows you to create-enable-suppress virtuals, and device forwarding must be configured from the sysadmin-friendly command line interface. <br><br><img src="https://habrastorage.org/storage2/f8b/e56/91e/f8be5691e37ff43c3fc706ecf17d12d3.png" alt="command line"><br><br>  Against expectations, problems did not happen here.  I did everything according to the <a href="http://support.citrix.com/article/CTX125574">manual</a> , and it was enough for him alone.  Here the people complain that the documentation for Xen is not enough.  So another time, and well, that is not enough, if this is enough.  How much I read about vSphere, and all to no avail ... However, I don‚Äôt want to say bad words about vSphere.  Under it, but the iron is so tuned that Xen flew straight with a whistle. <br>  So, with the help of XenCenter, I organized a virtual machine about two cores and 4 GB of memory, rolled the seventh 64-bit Windows and went to forward it. <br><br>  Corresponding to the manual, edit <code>/boot/extlinux.conf</code> by inserting the line <code>"iommu=1 iommu_inclusive_mapping=1"</code> after each occurrence of <code>"/boot/xen.gz"</code> <br>  <code>extlinux /boot</code> . <br>  <code>pciback</code> skip the steps associated with the <code>pciback</code> module - they write that in the six it is already compiled into the kernel. <br>  We do xe vm-list and find the uuid of our <code>uuid=d103a91d-5c38-844f-14d5-64b3c495eb08</code> , I have <code>uuid=d103a91d-5c38-844f-14d5-64b3c495eb08</code> <br>  We execute the <code>lspci</code> command and find our map in the output, for example, 02: 00.0 VGA compatible ..., 02: 00.1 Audio ... (the two surprisingly correspond to the slot number where the card is inserted). <br>  Write a single-line view script <br> <code>xe vm-param-set other-config:pci=0/0000:02:00.0,0/0000:02:00.1 uuid=d103a91d-5c38-844f-14d5-64b3c495eb08</code> <br>  In addition to the video adapter, I still have a sound on the card - so, remembering the rake I was attacking in the vSphere, I add both devices: 0/0000: 02: 00.0, 0/0000: 02: 00.1. <br>  Execute the script.  To control <code>xe vm-param-list uuid=d103a91d-5c38-844f-14d5-64b3c495eb08 | more</code>  <code>xe vm-param-list uuid=d103a91d-5c38-844f-14d5-64b3c495eb08 | more</code> - really <br>  We stop and restart the virtual machine (they write that it is this way, and not a reboot - I will not check it once more). <br>  At the first attempt, the card is in my first PCIe slot (01: 00.0, 01: 00.1) and is used by default by the hypervisor.  After restarting the virtual machine, the monitor goes out. <br>  In XenCenter (from a laptop) we go into the virtual console and after logging in to Windows we see that it asks for a reboot.  A sign that she has found a new device.  We will not refuse her.  Reboot.  Indeed, the Device Manager has a new Radeon 3450 video adapter with the Microsoft WDDM 1.1 driver.  From previous experience it is known that the driver is needed native.  I download and install fresh ATI Catalist 12.1, the one after installation, as usual, asks for a reboot.  Reboot ... Opanki.  The first attempt is covered with a copper basin: the hypervisor falls.  Yes ... vSphere in such a situation won a convincing victory over the virtual machine, arranging for it BSOD. <br>  We re-issue the host and, on the recommendation of the best dog breeders, see what the team writes to us <br>  <code>dmesg</code> .  She writes, among other things, this: <br><br> <code>pciback 0000:01:00.1: secondary bus reset failed for device ‚Äî all functions need to be co-assigned ‚Äî err: 6 <br> pciback 0000:01:00.1: FLR functionality not supported; attempts to use secondary bus reset unsuccessful; <br> pciback 0000:01:00.1: FLR not performed for device <br></code> <br><br>  It seems that the transfer of the card to the hot does not shine.  Okay.  Let's give the hypervisor your VGA adapter, the benefit of the video cards is enough for me now.  We rearrange the Radeon 3450 in the second slot, in the first we place the 3470 lying next to it. We attach a monitor to each card.  We include a host, we start a virtualka.  Windows asks to restart after changing the configuration.  Reboot.  Login ... <br><br><img src="https://habrastorage.org/storage2/069/8a5/33a/0698a533af38798eaabb5ab0c2f248d7.png" alt="xencenter: guest os console"><br><br>  In the XenCenter console, the screen saver freezes, and I do not immediately realize that the right monitor is lit in blue <br><br><img src="https://habrastorage.org/storage2/705/e9a/c64/705e9ac646e105321a17015b4cf91f77.jpg" alt="windows logon screen"><br>  It still happened. <br>  Total, on Xen has grown together for 3 days (after 3 months practiced on VMware). <br><br>  I logged in.  The picture on the monitor is the most ordinary, without features.  The resolution of 1920x1200 holds.  Not tupit (although not drove tests).  YouTube video is playing normally. <br><br>  On this joyful note, I will complete my truthful report, and I will do the forwarding of the keyboard, mouse, and other peripherals. <br><br>  Update: <br>  I threw the keyboard and mouse, I write from virtual under Win7.  Nothing here, you can live. <br>  Performance Index 3.5 <br><img src="https://habrastorage.org/storage2/006/62c/0ef/00662c0ef69318b2f8167e6ee8d25d93.png" alt="windows performance index"><br>  I haven‚Äôt even turned off Aero and other visual effects that are <s>harmful to our cause</s> , but it works smartly. <br><br>  USB forwarding is rude and cynical: <br> <code>xe vm-param-set other-config:pci=0/0000:02:00.0,0/0000:02:00.1,0/0000:00:1a.0,0/0000:00:1d.0 uuid=d103a91d-5c38-844f-14d5-64b3c495eb08</code> <br>  That is, donated a virtual USB controller.  On the other hand, Xen is still without them. <br><br>  What else?  Put XenCenter, Xen normally administered (who would doubt).  An external USB drive, of course, also hooks normally.  Now we need to understand how to forward a CD-ROM. <br><br>  Unfortunately, nothing came out of my <a href="http://wiki.xen.org/xenwiki/XenUSBPassthrough">USB Passthrough</a> , as well as the <a href="http://wiki.xen.org/xenwiki/XenVGAPassthrough">Xen VGA Passthrough</a> ( <b>Scraelos</b> ) rightly mentioned in the comments, because there is no "/ etc / xen / cfgfile" file under the XCP.  How to register the necessary settings using <code>xe</code> - I did not understand.  If experts Xen help, I will be very grateful. <br><br>  Update: ToDo: <br><ul><li>  Forward CD-ROM (-) </li><li>  <b>Configure static IP (+)</b> </li><li>  Test performance (partially done) </li><li>  <b>Try to transplant dom0 to IGD, one PCIe slot will be freed (-)</b> </li><li>  <b>Try to transplant dom0 on the onboard NIC, free PCI slot (+)</b> </li><li>  Try Vpom dom0 keyboard on PS / 2 </li><li>  Organize a file system for data exchange between guest OS </li><li>  Arrange switching between guest OS (scripts, probably) </li></ul><br><br>  Update 06.02.2012: <br>  dom0 at IGD refused to change over in a categorical form.  In addition, I tried again to forward the primary VGA adapter - to no avail.  Returned to the previous configuration of the adapters. <br>  Rested in the problem with probrosom CD (DVD) -Writer.  The CD-ROM is being forwarded normally, but only RO, and I need RW.  On this occasion, I found 2 recommendations: <a href="http://forums.citrix.com/message.jspa%3FmessageID%3D1534093">plug in and forward a separate SATA controller</a> and use a USB CD / DVD-Writer (the benefit of USB is being forwarded).  Unfortunately, even these (imkho, crutch) solutions have not worked for me at the moment.  The controller refused to forward.  Attempting to connect a regular SATA CD / DVD drive via a USB-SATA adapter did not lead to anything good.  I continue the experiments. </div><p>Source: <a href="https://habr.com/ru/post/137327/">https://habr.com/ru/post/137327/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137316/index.html">Collisions in 512-bit MD5 blocks</a></li>
<li><a href="../137317/index.html">18 facts about John Skyte</a></li>
<li><a href="../137318/index.html">Javascript Optimization: time-tested experience</a></li>
<li><a href="../137322/index.html">Where to store user settings</a></li>
<li><a href="../137324/index.html">Cheat Sheet for Django 1.3</a></li>
<li><a href="../137329/index.html">E1 + iPhone</a></li>
<li><a href="../137331/index.html">Review of programs for monitoring the consumption of mobile Internet</a></li>
<li><a href="../137332/index.html">An office that is always at hand: an example of how a virtual desktop works on portable devices</a></li>
<li><a href="../137333/index.html">When need RVM, and when enough rbenv</a></li>
<li><a href="../137334/index.html">Using vkontakte js api for semi-automatic posting of messages from rss feeds</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>