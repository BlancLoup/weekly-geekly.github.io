<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Character preparation for Blend4Web</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The site developers engine published a lot of materials, including on this topic. All "chewed" and in Russian. But the incident - the task was not eas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Character preparation for Blend4Web</h1><div class="post__text post__text-html js-mediator-article">  The site developers engine published a lot of materials, including on this topic.  All "chewed" and in Russian.  But the incident - the task was not easy, even for a person who has solid experience with Blender and sincerely considers himself a game developer.  Some stages caused critical attacks of ‚Äúfreezing‚Äù, resulting from a misunderstanding of the features of working with the engine and, frankly speaking, poor JavaScript knowledge. <br><br>  An important factor was the attempt to transfer the experience of working with Unity (c #) to a completely different platform.  And it was a serious mistake.  Blend4Web is a tool sharpened solely for creating WebGL applications, which gives a solid advantage over the cross-platform Unity, but also imposes some limitations.  In connection with the termination of support for the web player and the poor performance of the Unity WebGL exporter, the Blend4Web platform looks very interesting.  Therefore, you want - you do not want, and it is necessary to understand. <br><br>  This lesson is a compilation of your own experience, hints of b4w developers, official documentation.  Designed, first of all, on beginners and based on my game project. <br><a name="habracut"></a><br>  A game character, in my understanding, is an object capable of moving, ‚Äúthinking‚Äù and interacting with other objects.  I will leave the implementation of AI for the next article, but for now the conversation will be about basic actions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Blend4Web is based on Blender, so all settings for models and scenes are performed in this editor, which favorably distinguishes b4w from other solutions. <br><br>  The game level can be created in different ways: <br><ul><li>  Static  All models, objects are pre-arranged on the base scene.  It uses the standard Blender functions to connect objects from third-party blend files (Link).  Thus, the entire level is completely loaded into memory, and the developer has the ability to access objects using the Blend4Web API.  This is an easy way, but it has a drawback - a long download, which is critical for browser games. </li><li>  Dynamic.  There is a main scene, and all the necessary objects are independent files and are loaded using the Blend4Web API. </li></ul><br>  As planned, the game has fish - evil and not very fast and slow, large and small.  If they are rigidly placed at the level, then replay value will not be at the height.  Much more interesting if they are generated in different places, quality and quantity.  Yes, and network traffic is saved.  Therefore, I definitely chose the second download option. <br><br>  In addition, I‚Äôll dwell on acting characters.  For my game, I came up with an unusual gameplay with indirect control.  In fact, the player helps, and does not affect the main character.  And here it is important that all the characters move along predetermined trajectories, but the paths and destination points are generated randomly or depending on the tasks at hand. <br><br>  It turns out that the characters need two main actions: <br><ul><li>  Follow the route. </li><li>  Deviate from the trajectory to perform the task or when meeting with another object. </li></ul><br>  These requirements simplify the use and tuning of physics.  Only simple colliders are needed. <br><br><h4>  Step 1. Setting up the model in Blender </h4><br>  So, let's say there is a ready-made gaming model and its resources are located in the appropriate SDK folders.  It is desirable to fulfill this requirement, since in the latest version of the engine it was possible to automate the processes of building and debugging through the web interface.  However, the requirements are simple: <br><br>  Scene files (blend) should be located in the <i>sdk \ blender \ project</i> directory. <br>  Resource files, as well as exported JSON from scenes, are placed in <i>sdk \ deploy \ assets \ project</i> . <br>  Scripts, HTML, CSS in the folder <i>sdk \ apps_dev \ project</i> . <br><br>  The b4w engine does not work with the original blend files, but with the JSON format.  The export is done from the Blender menu: <i>File |</i>  <i>Export |</i>  <i>Blend4Web (JSON)</i> .  Note that the exporter surpasses the entire Blender scene.  Therefore, it is necessary to remove from it objects that are not involved in the game, for example, a high-poly original.  Of course, the API allows you to select the necessary objects from the scene, but the entire file will be downloaded over the network. <br><br>  The second feature is the use of modifiers.  There is no need to apply them and, thereby, cut off the opportunity to correct the model.  Just tick the <i>Apply Modifiers</i> option or even better in the <i>Apply Scale and Modifiers</i> option.  These parameters are in the Object panel of the selected object. <br><br><img src="https://habrastorage.org/files/f91/3a8/153/f913a81531b645fb965f236cd39ea705.jpg"><br><br>  It is important to give intelligible names to materials, objects, textures.  Indeed, in the future, access from the code to them is performed using names.  Latin, underscore and numbers are suitable.  It is worth avoiding the standard automatic names for Blender, where dots are used. <br><br>  The simplest way to check the model settings is to view it in the browser using a special utility.  The program can be launched automatically after JSON export, if you enable the Run in Viewer option (on the left in the B4W Export JSON panel).  Note that the option is available only when the project is saved in the correct sdk \ blender \ folder for the SDK. <br><br>  The viewer allows you to twist, consider the model from all sides, adjust the parameters of the scene, and most importantly - signals possible problems with JSON.  A small traffic light in the corner of the screen (see fig.) Warns of the ‚Äúpatient‚Äù state.  Red and yellow - something is wrong and you should look at the logs in the browser console. <br><br><img src="https://habrastorage.org/files/211/5b0/0be/2115b00becf245f2b14eaf3c26cd1881.jpg"><br><br>  If at this stage everything is fine, then it's time to do physics.  Usually, for the balance between speed and quality, not the original forms of the model are used, but its simplified variations.  Moreover, such simple primitives as cube, sphere, capsule are most often taken.  Personally, I stopped at a simple cube, since the game will need to calculate the collision, and not the exact physical effects. <br><br><img src="https://habrastorage.org/files/9f3/9e7/186/9f39e7186ec64cdab0254444fb16d813.jpg"><br><br>  For this, I added a new primitive Cube to the scene.  Made it root (parent) in relation to the model, and also grouped everything into one whole.  If you do not know how to do this - here is a step by step algorithm: <br><br><ul><li>  Select model, then collider.  Press CTRL + P and select Object in the menu that appears. </li><li>  To group the selected objects, press CTRL + G. </li></ul><br>  After these actions, the collider named Fish became the root (see fig. Above).  It is he who will participate in physical activities, move around the scene, and the model is obtained, just a ‚Äúpassenger‚Äù. <br><br>  So, all the physical settings are made with respect to the cube-collider.  The first thing you need to do is turn off the rendering in the engine render, because you only need its form, not the view.  Check the <i>Do Not Render</i> option in the settings as in the figure above.  The second is to enable the <i>Force Dynamic Object</i> option.  This is necessary for the performance of some of the necessary API functions.  But all the other parameters are in the Physics panel. <br><br><img src="https://habrastorage.org/files/fec/20d/bf7/fec20dbf7bdd4d5b80ddd2f5704df743.jpg"><br><br>  In fact, the physics of an object in Blend4Web is very easy to activate.  It is enough to set a tick in <i>Object Physics</i> and the model will interact with the outside world.  The type of interaction is determined by the Type parameter.  In the picture, Dynamic is selected and this is not accidental, because the fish model is mobile.  For fixed elements of the scene, such as walls, stairs and other obstacles, you must install the type Static. <br><br>  The view of the collider is selected in the <i>Collision Bounds</i> tab.  The picture shows Box as the most appropriate shape for the parallelepiped.  Of course, for your model, you can choose any of the available physical primitives. <br><br>  And the last - option <i>Charaster</i> .  By name it is clear that it activates.  Yes, indeed, the developers of Blend4Web took care of the users and added quick settings for the main parameters of the character's movement: walking, jumping, running, walking, etc.  Of course, this is not particularly applicable to fish, but without the inclusion of this option, some API functions will not work. <br><br>  Basically, everything.  You can export the scene and move on to programming. <br><br><h4>  Step 2. Program code. </h4><br>  In one of the <a href="http://habrahabr.ru/post/264115/">articles</a> I have already talked about the features of creating applications Blend4Web.  Therefore, I will not repeat, but go straight to the topic of the lesson. <br><br>  As you know, the Blend4Web API functions are grouped into separate modules and these modules must be declared before use: <br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,   AI  b4w.register("game_fish", function(exports, require) { //  var m_scenes = b4w.require("scenes"); var m_cfg = b4w.require("config"); var m_data = b4w.require("data"); var m_trans = b4w.require ("transform"); var m_phy = b4w.require ("physics"); var m_obj = b4w.require ("objects"); ‚Ä¶ var APP_ASSETS_PATH = m_cfg.get_std_assets_path() + "waterhunter/"; exports.new_fishes = function() { //-  } }</span></span></code> </pre> <br>  Suppose a situation where the main scene of the game is already loaded and it is necessary to release the first fish in the ‚Äúpool‚Äù.  Then in the main script there will be lines: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  AI  var m_fish = b4w.require("game_fish"); ‚Ä¶ //  m_fish.new_fishes();</span></span></code> </pre><br><br>  The first thing a module should do is download a file with a model. <br><pre> <code class="javascript hljs">exports.new_fishes = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//-  m_data.load(APP_ASSETS_PATH +‚Äùfish.json‚Äù, fish_loaded_cb,null,true,true); }</span></span></code> </pre><br>  The function m_data.load is responsible for loading JSON files.  Working with it has several subtleties, but first you need to clarify what the scene hierarchy is from the point of view of the engine. <br><br>  All scenes in the application have a specific sequence number, which is assigned when downloading files.  The lowest, basic level is the first loaded scene and its number is 0. All the rest will receive the next numbers 1,2,3 ... n. <br><br>  The zero level is of particular importance compared to the others.  All global settings, NLA logic (if used), lighting and cameras are taken from this scene.  Accordingly, subsequent files are loaded into the application without global variables, and the existing cameras and light sources are ignored. <br><br>  The sequence number assigned to the loaded level allows you to identify the object.  For example, in different scenes there are objects with the same name Empty.  By specifying the name and the number of the scene, you will get access to the desired object. <br><br>  Now back to the download: <br><pre> <code class="javascript hljs">m_data.load(APP_ASSETS_PATH +‚Äùfish.json‚Äù, fish_loaded_cb,<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  The first value that is passed to the function is the file name (‚Äúfish.json‚Äù).  Moreover, it is desirable to use a constant to specify the directory.  The fact is that after the final build of the project, the scattered files in the SDK folders are grouped in one place.  The action takes place automatically and in order to avoid problems with lost files, this constant is needed.  It is previously declared in the variable area: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> APP_ASSETS_PATH = m_cfg.get_std_assets_path() + <span class="hljs-string"><span class="hljs-string">"waterhunter/"</span></span>;</code> </pre><br>  The second value (fish_loaded_cb) is the name of the function that will be called after the download is complete.  There are several nuances that you need to know ... <br><br>  The actual file loading is asynchronous and the original load function returns control to the main thread BEFORE loading is complete.  Unfortunately, in the official SDK documentation this moment is not specified, which led to the fabulous loss of my time when trying to figure out why the code does not work. <br><br>  The third value (null is indicated) is the name of the function transmitting data about the boot process.  Useful for creating preloaders.  I don't need it now.  Read about creating preloader in this <a href="http://habrahabr.ru/post/264115/">article</a> . <br><br>  The fourth value (set to true) in the SDK engine is indicated as wait_complete_loading.  This, in fact, confused me earlier.  In fact, this parameter is only responsible for calling fish_loaded_cb.  If set to true, the callback will be executed after loading all the file data.  False - an early function call, after loading key objects (for example, sounds are not). <br><br>  The latter value is responsible for the state of new objects added to the scene.  In this case, they turn off, become invisible and do not react to physics.  This allows you to place them and prepare for action. <br><br>  So, the object is loaded into the scene.  Now all the action goes to the function: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fish_loaded_cb</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data_id</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//data_id -     //-  }</span></span></code> </pre><br>  Here some code is already supposed to be connected with the logic of the object - this is the topic of the next article.  But something I still add. <br><br>  The main control of the motion of an object is concentrated in two modules of the engine: transform, physics. <br><br>  <i>Transform</i> contains basic functions for moving, rotating, scaling objects.  And it happens instantly, for a frame change.  Thus, movement is possible only when using a constantly generated event.  Note that the Blend4Web API offers its own event implementation. <br><br>  <i>Physics</i> is a module that offers a large number of functions related to physics.  Please note that some of them require the activation of the Charaster settings in Blender (see above).  This, first of all, concerns the movement control of the character.  Since the action is based on physics, there is no need to use events. <br><br>  Consider a simple example of moving a character forward: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fish_loaded_cb</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data_id</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//         data_id var obj_fish = m_scenes.get_object_by_name ("fish", data_id); //   m_phy.set_character_move_dir(obj_fish,1, 0); }</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/268937/">https://habr.com/ru/post/268937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268927/index.html">Experiment: Should I use forms in email</a></li>
<li><a href="../268929/index.html">Event-oriented Python backtesting step by step. Part 4</a></li>
<li><a href="../268931/index.html">5 internships for programmers abroad</a></li>
<li><a href="../268933/index.html">Megahakaton IoT Russia from Intel and Microsoft</a></li>
<li><a href="../268935/index.html">Programming Philosophy 10 - AI</a></li>
<li><a href="../268939/index.html">Cybercriminals use Win32 / Brolux.A banking trojan to compromise users in Japan</a></li>
<li><a href="../268941/index.html">Mail Productivity: How Evernote was created for Outlook</a></li>
<li><a href="../268945/index.html">The program of the second international conference of mobile developers MBLTdev is published.</a></li>
<li><a href="../268947/index.html">A multi-line textarea placeholder that works in Firefox</a></li>
<li><a href="../268949/index.html">PostgreSQL Evangelist Memo: criticize MySQL correctly</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>