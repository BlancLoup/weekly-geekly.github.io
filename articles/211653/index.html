<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Buffer for buffers or write a virtual clipboard in C # not in 30 lines of code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that in such gloomy weather, having overlaid myself with pills and cold medications, I decided to share with the habr-community a tool ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Buffer for buffers or write a virtual clipboard in C # not in 30 lines of code</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/236/acf/4b6/236acf4b69a69980747d144678d3be75.jpg"><br><br>  It so happened that in such gloomy weather, having overlaid myself with pills and cold medications, I decided to share with the habr-community a tool I had made for myself and had been using it for almost a month now.  This is a windows program that intercepts text copying to the clipboard and allows you to paste any fragment from the previously copied text. <a name="habracut"></a><br><br><h4>  How it all began </h4>  Like any programmer, I constantly have to work with the code.  Besides writing C # code, I constantly have to write sql queries.  Moreover, quite complex queries: queries with subqueries, with subqueries, with a bunch of LEFT JOIN and RIGHT JOINs.  Making a decomposition of such requests into its separate parts, it is easy to get confused as to what and why / why all this was written. <br><div class="spoiler">  <b class="spoiler_title">A typical example of one sql query (do not even try to understand what it does)</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(t_step3.half_step3 - <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_step1.bonus, <span class="hljs-number"><span class="hljs-number">0</span></span>) - <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_step2.bonus, <span class="hljs-number"><span class="hljs-number">0</span></span>)), <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'bonus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders2cat.order_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'id'</span></span>, (t_o.balance_rub - <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(t_orders2cat.dprice_rub - t_orders2cat.delivery_cost_rub) - <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_gurkin.half_step3, <span class="hljs-number"><span class="hljs-number">0</span></span>) - <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_o2p.cost_expenses_rub, <span class="hljs-number"><span class="hljs-number">0</span></span>)) * ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(base_on_tender = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_category_percent.percent, <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(base_on_tender = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_category_percent.percent, <span class="hljs-number"><span class="hljs-number">1</span></span>) - <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_category_percent.percent, <span class="hljs-number"><span class="hljs-number">1</span></span>) - <span class="hljs-number"><span class="hljs-number">0.5</span></span>) ) - <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(t_orders.tech_helper_id != <span class="hljs-number"><span class="hljs-number">0</span></span>, t_users.tech_bonus_percent, <span class="hljs-number"><span class="hljs-number">0</span></span>) ) / <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'half_step3'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders2cat, t_orders <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_category_percent <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.category_percent_id = t_category_percent.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_users <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.tech_helper_id = t_users.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> order_id, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(cost_expenses_rub) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'cost_expenses_rub'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders2pnr <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_orders2pnr.order_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(cost_expenses_rub) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o2p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.id = t_o2p.order_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'order_id'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(deg_discount(deg_convert_money( t_orders.rate_eur, t_orders.rate_usd, t_orders.rate_jpy, t_orders2cat.price, t_orders2cat.currency_id, t_orders.currency_id), t_orders2cat.discount) * t_orders2cat.count - t_orders2cat.dprice_rub - t_orders2cat.delivery_cost_rub - <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_orders2pnr.cost_expenses_rub, <span class="hljs-number"><span class="hljs-number">0</span></span>) ) * t_p.balance_rub / t_orders.balance <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'half_step3'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_orders2pnr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.id = t_orders2pnr.order_id, t_orders2cat, t_cat, t_vendors, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> order_id, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(summa_rub) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'balance_rub'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_p, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_o.id, <span class="hljs-keyword"><span class="hljs-keyword">GREATEST</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_o.date_shipment, t_o.date_pnr_finish), <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_o.date_pnr_finish, t_o.date_shipment), <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_payments.date_payment)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_closed'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(t_payments.summa_rub) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'balance_rub'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(t_orders2cat.id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'orders2cat_count'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_orders2cat.date_from) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_shipment'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_orders2cat.status_id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'orders2cat_status'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(t_orders2pnr.id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'pnr_count'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_orders2pnr.date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_pnr_finish'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_orders2pnr.status_id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'pnr_status'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_orders2cat <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.id = t_orders2cat.order_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_orders2pnr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.id = t_orders2pnr.order_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.items_finished &gt;= t_orders.items_count <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.summa - t_orders.balance &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_orders.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_payments.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_payments.order_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> date_closed) = <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> in_date) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders.id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.id = t_p.order_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.id = t_orders2cat.order_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders2cat.cat_id = t_cat.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_cat.vendor_id = t_vendors.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_vendors.user_id = <span class="hljs-number"><span class="hljs-number">158</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_orders.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_gurkin <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.id = t_gurkin.order_id, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_o.id, <span class="hljs-keyword"><span class="hljs-keyword">GREATEST</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_o.date_shipment, t_o.date_pnr_finish), <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_o.date_pnr_finish, t_o.date_shipment), <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_payments.date_payment)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_closed'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(t_payments.summa_rub) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'balance_rub'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(t_orders2cat.id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'orders2cat_count'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_orders2cat.date_from) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_shipment'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_orders2cat.status_id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'orders2cat_status'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(t_orders2pnr.id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'pnr_count'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_orders2pnr.date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_pnr_finish'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_orders2pnr.status_id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'pnr_status'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_orders2cat <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.id = t_orders2cat.order_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_orders2pnr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.id = t_orders2pnr.order_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.items_finished &gt;= t_orders.items_count <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.summa - t_orders.balance &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_orders.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_payments.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_payments.order_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> date_closed) = <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> in_date) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders2cat.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders2cat.order_id = t_orders.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_orders2cat.order_id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_step3 <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id, t_o.average_curs * (t_orders.summa - <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_gurkin.step1, <span class="hljs-number"><span class="hljs-number">0</span></span>)) * ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(base_on_tender = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_category_percent.percent, <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(base_on_tender = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_category_percent.percent, <span class="hljs-number"><span class="hljs-number">1</span></span>) - <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_category_percent.percent, <span class="hljs-number"><span class="hljs-number">1</span></span>) - <span class="hljs-number"><span class="hljs-number">0.5</span></span> ) ) - <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(t_orders.tech_helper_id != <span class="hljs-number"><span class="hljs-number">0</span></span>, t_users.tech_bonus_percent, <span class="hljs-number"><span class="hljs-number">0</span></span>) ) / <span class="hljs-number"><span class="hljs-number">100</span></span> * <span class="hljs-number"><span class="hljs-number">0.3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'bonus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_category_percent <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.category_percent_id = t_category_percent.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_users <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.tech_helper_id = t_users.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'order_id'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(deg_discount(deg_convert_money( t_orders.rate_eur, t_orders.rate_usd, t_orders.rate_jpy, t_orders2cat.price, t_orders2cat.currency_id, t_orders.currency_id), t_orders2cat.discount) * t_orders2cat.count) * t_o.payment_rub / t_o.payment_currency <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'step1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders, t_orders2cat, t_cat, t_vendors, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(t_payments.summa_rub) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'payment_rub'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(deg_convert_money(t_rates.eur, t_rates.usd, t_rates.jpy, t_payments.summa_rub, <span class="hljs-number"><span class="hljs-number">1</span></span>, t_orders.currency_id)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'payment_currency'</span></span>, t_orders.summa <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders, t_payments, t_rates <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders.id = t_payments.order_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_payments.date_rates = t_rates.date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders.date_firstpay) = <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments.date_payment) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_payments.order_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> payment_currency / t_orders.summa &gt;= <span class="hljs-number"><span class="hljs-number">0.3</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders.id = t_orders2cat.order_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders2cat.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders2cat.cat_id = t_cat.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_vendors.user_id = <span class="hljs-number"><span class="hljs-number">158</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_cat.vendor_id = t_vendors.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_o.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_gurkin <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.id = t_gurkin.order_id, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(t_payments.summa_rub) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(deg_convert_money(t_rates.eur, t_rates.usd, t_rates.jpy, t_payments.summa_rub, <span class="hljs-number"><span class="hljs-number">1</span></span>, t_orders.currency_id)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'average_curs'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments, t_rates, t_orders, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_payments.order_id, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(t_payments.date_payment) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_payment'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-number"><span class="hljs-number">0.3</span></span> &lt;= ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(deg_convert_money(t_rates.eur, t_rates.usd, t_rates.jpy, t_p.summa_rub, <span class="hljs-number"><span class="hljs-number">1</span></span>, t_o.currency_id)) / t_o.summa <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'summa_cur'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_p, t_orders <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o, t_rates <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_p.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_p.date_rates = t_rates.date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_p.date_payment &lt;= t_payments.date_payment <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_o.id = t_payments.order_id ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_payments.order_id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_payments.order_id = t_o.order_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_payments.order_id = t_orders.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_payments.date_rates = t_rates.date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments.date_payment) &lt;= <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_o.date_payment) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_orders.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders.id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.user_id = in_user_id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_step1 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_step3.id = t_step1.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(t_payments.summa_rub) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(deg_convert_money(t_rates.eur, t_rates.usd, t_rates.jpy, t_payments.summa_rub, <span class="hljs-number"><span class="hljs-number">1</span></span>, t_orders.currency_id)) * (t_orders.summa - <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_gurkin.step2, <span class="hljs-number"><span class="hljs-number">0</span></span>)) * ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(base_on_tender = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_category_percent.percent, <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(base_on_tender = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_category_percent.percent, <span class="hljs-number"><span class="hljs-number">1</span></span>) - <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(t_category_percent.percent, <span class="hljs-number"><span class="hljs-number">1</span></span>) - <span class="hljs-number"><span class="hljs-number">0.5</span></span> ) ) - <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(t_orders.tech_helper_id != <span class="hljs-number"><span class="hljs-number">0</span></span>, t_users.tech_bonus_percent, <span class="hljs-number"><span class="hljs-number">0</span></span>) ) / <span class="hljs-number"><span class="hljs-number">100</span></span> * <span class="hljs-number"><span class="hljs-number">0.3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'bonus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments, t_rates, t_orders <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_category_percent <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.category_percent_id = t_category_percent.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_users <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.tech_helper_id = t_users.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'order_id'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(deg_discount(deg_convert_money( t_orders.rate_eur, t_orders.rate_usd, t_orders.rate_jpy, t_orders2cat.price, t_orders2cat.currency_id, t_orders.currency_id), t_orders2cat.discount) * t_orders2cat.count) * t_o.payment_rub / t_o.payment_currency <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'step2'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders, t_orders2cat, t_cat, t_vendors, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(t_payments.summa_rub) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'payment_rub'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(deg_convert_money(t_rates.eur, t_rates.usd, t_rates.jpy, t_payments.summa_rub, <span class="hljs-number"><span class="hljs-number">1</span></span>, t_orders.currency_id)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'payment_currency'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments, t_rates, t_orders, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_o.id, <span class="hljs-keyword"><span class="hljs-keyword">GREATEST</span></span>(date_exit, date_payment) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_payment_bonus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_containers.date_port_exit) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_exit'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders2cat, t_invoices2orders2cat, t_containers2invoices, t_containers, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders, t_orders2cat <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders.id = t_orders2cat.order_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> &lt;= ALL (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_o2c.status_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders2cat <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o2c <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_o2c.order_id = t_orders.id) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_orders.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders2cat.id = t_invoices2orders2cat.order2cat_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_invoices2orders2cat.invoice_id = t_containers2invoices.invoice_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_containers2invoices.container_id = t_containers.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders2cat.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_o.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_payments.order_id, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(t_payments.date_payment) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_payment'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-number"><span class="hljs-number">0.8</span></span> &lt;= ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(deg_convert_money(t_rates.eur, t_rates.usd, t_rates.jpy, t_p.summa_rub, <span class="hljs-number"><span class="hljs-number">1</span></span>, t_o.currency_id)) / t_o.summa <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'summa_cur'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_p, t_orders <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o, t_rates <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_p.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_o.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_p.date_rates = t_rates.date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_p.date_payment &lt;= t_payments.date_payment <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_o.id = t_payments.order_id ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_payments.order_id ) t_p <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_o.id = t_p.order_id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_payments.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_payments.date_rates = t_rates.date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_payments.order_id = t_orders.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments.date_payment) &lt;= <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_o.date_payment_bonus) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_orders.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders.id = t_orders2cat.order_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders2cat.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders2cat.cat_id = t_cat.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_vendors.user_id = <span class="hljs-number"><span class="hljs-number">158</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_cat.vendor_id = t_vendors.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_o.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_gurkin <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_orders.id = t_gurkin.order_id, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_o.id, <span class="hljs-keyword"><span class="hljs-keyword">GREATEST</span></span>(date_exit, date_payment) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_payment_bonus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t_containers.date_port_exit) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_exit'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders2cat, t_invoices2orders2cat, t_containers2invoices, t_containers, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_orders.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders, t_orders2cat <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders.id = t_orders2cat.order_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> &lt;= ALL (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_o2c.status_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_orders2cat <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o2c <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_o2c.order_id = t_orders.id) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_orders.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_orders2cat.id = t_invoices2orders2cat.order2cat_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_invoices2orders2cat.invoice_id = t_containers2invoices.invoice_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_containers2invoices.container_id = t_containers.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders2cat.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_o.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t_payments.order_id, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(t_payments.date_payment) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'date_payment'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-number"><span class="hljs-number">0.8</span></span> &lt;= ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(deg_convert_money(t_rates.eur, t_rates.usd, t_rates.jpy, t_p.summa_rub, <span class="hljs-number"><span class="hljs-number">1</span></span>, t_o.currency_id)) / t_o.summa <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'summa_cur'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_p, t_orders <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o, t_rates <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_p.order_id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_o.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_p.date_rates = t_rates.date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_p.date_payment &lt;= t_payments.date_payment <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_o.id = t_payments.order_id ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_payments.order_id ) t_p <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_o.id = t_p.order_id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t_o.id = t_payments.order_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.id = t_o.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_orders.user_id = in_user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t_payments.date_rates = t_rates.date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_payments.date_payment) &lt;= <span class="hljs-keyword"><span class="hljs-keyword">EXTRACT</span></span>(YEAR_MONTH <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_o.date_payment_bonus) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t_orders.id ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t_step2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t_step3.id = t_step2.id;</code> </pre> </div></div><br>  After reading the article <a href="http://habrahabr.ru/post/208314/">Writing a virtual clipboard in C #</a> , I decided to try in action what <a href="http://habrahabr.ru/users/yanzlatov/" class="user_link">yanzlatov</a> offered us, but his version was unacceptable for me: in many ways, the inconvenience to the fast access of the buffers copied to the buffer, the glitch ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Requirements </h5>  Having formulated clear requirements for what I needed, it was decided to re-write the bike. <br><ul><li>  Since I work on a laptop (Win7x64), on a home computer (Win8.1x64) and on a work computer (Win8x64), the developed application should work on three axes Windows 7x64, 8x64, 8.1x64 with .Net Framework version 4 and higher . </li><li>  The application must be silently loaded at the time of loading the OS </li><li>  When copying text to the clipboard, the application must save this text in memory. </li><li>  When inserting text (for example, by pressing ctrl + v or the corresponding menu item), the last text sent to the buffer should be inserted </li><li>  When you press <b>ctrl + alt + v</b> , a window should appear with a choice of buffer </li><li>  Buffer history should be maintained even after reboot. </li><li>  Full hotkey support is essential. </li><li>  Since the number of stored items can be huge, you need a convenient search through all items. </li></ul><br><br><h4>  Code </h4><img src="https://habrastorage.org/getpro/habr/post_images/702/bec/67f/702bec67f517dee450e10abf34c72934.png"><br>  The project source can be downloaded <a href="https://github.com/kin9pin/ClipboardToClipboard">here</a> .  Exe file can be picked up <a href="">here</a> . <br>  I will not focus on all the code.  I will dwell on some points. <br><br>  At the very beginning of the launch, a check is made with the help of a mutex so that another instance of the application is not running: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> createdNew; Mutex mutex = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mutex(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"MY_UNIQUE_MUTEX_ClipboardToClipboard"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> createdNew); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!createdNew) { MessageBox.Show(<span class="hljs-string"><span class="hljs-string">"        "</span></span>, Application.ProductName, MessageBoxButtons.OK, MessageBoxIcon.Warning); Process.GetCurrentProcess().Kill(); } ... ... ... mutex.ReleaseMutex(); }</code> </pre><br><br>  The process of intercepting pressing the ctrl + alt + v combination <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> EventCtrlAltVHandler EventPressCtrlAltV; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Keys lastKey = Keys.FinalMode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HookCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nCode, IntPtr wParam, IntPtr lParam</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((nCode &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (wParam == (IntPtr)WM_KEYDOWN)) { Keys key = (Keys)Marshal.ReadInt32(lParam); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastKey == Keys.LMenu &amp;&amp; key == Keys.V) EventPressCtrlAltV(); lastKey = key; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CallNextHookEx(_hookID, nCode, wParam, lParam); }</code> </pre><br><br>  In MainForm.cs there is a function that simulates pressing ctrl + { <em>key</em> }.  In my case it was ctrl + v on the selected item from the list. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendCtrlhotKey</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key</span></span></span><span class="hljs-function">)</span></span> { keybd_event(VK_CONTROL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); keybd_event((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)key, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); keybd_event((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)key, <span class="hljs-number"><span class="hljs-number">0</span></span>, KEYEVENTF_KEYUP, <span class="hljs-number"><span class="hljs-number">0</span></span>); keybd_event(VK_CONTROL, <span class="hljs-number"><span class="hljs-number">0</span></span>, KEYEVENTF_KEYUP, <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre><br><br>  In principle, there is nothing so special there.  The history is stored in the xml-file, the settings are right in the properties of the application ... Who is interested in trying to see and figure out for yourself.  If you have questions, I can answer them. <br><br><h4>  How in practice it all looks and works. </h4>  It's all very simple.  Run exe-shnik.  Select the text fragment, click ctrl + c and a notification appears in the system tray: <br><img src="https://habrastorage.org/getpro/habr/post_images/0e7/c3e/66b/0e7c3e66b0cba3c0c1a64417221da736.jpg"><br><br>  It would seem that this feature is useless, but behind it is a steeper feature - if you click on the pop-up help, a window will open with the possibility of adding a comment: <br><img src="https://habrastorage.org/getpro/habr/post_images/956/093/4f6/9560934f65fc45bd2bb2a7aa802f06d4.jpg"><br><br>  What to do with this comment, I will tell later. <br><br>  Now suppose that we needed to paste the text that the FIG knows when it was copied to the clipboard.  There is nothing easier - press ctrl + alt + v: <br><img src="https://habrastorage.org/getpro/habr/post_images/807/9fb/033/8079fb03328814570d96fc6444c442b4.jpg"><br><br>  We can right there, moving the list with the keys up or down, select the text we need.  At the same time, when moving in the list by elements, a tooltip appears, which can be useful if the text is multi-line.  By the way, here is the comment that you could have indicated earlier: <br><img src="https://habrastorage.org/getpro/habr/post_images/ea0/960/0b7/ea09600b78b60093ba91694a460c223e.jpg"><br><br>  Agree, a very handy feature when editing a Hindu code) <br><br>  So, you have selected the item you want in the list.  Now just press Enter and the text is inserted into the position of your editor where the cursor is. <br><br>  In this main window, you can either delete the selected fragment by element using the Del key, or completely clear the entire buffer of buffers;  You can set the selected item to comment using the ctrl + R combination. <br><img src="https://habrastorage.org/getpro/habr/post_images/947/61f/3fc/94761f3fc09273da4f5aede2c9a2970f.jpg"><br><br>  Pressing escape, the window is hidden in the tray. <br>  Separate attention deserves a search.  If you need to find something in among the buffers, then you can quickly switch to the search: ctrl + alt + v -&gt; ctrl + f.  In this case, the focus is set in the search bar. <br><img src="https://habrastorage.org/getpro/habr/post_images/600/834/059/600834059e42480f36579a1a00a0fba6.jpg"><br>  Enter a few key letters, press Enter -&gt; now the focus will be on the list, where you can again move the keys up or down.  If there is text in the search bar and there is text, then pressing escape clears the text field.  Pressing escape again hides the window. <br><br>  In the settings, nothing special.  Somehow realized the level of transparency, thought it would be a useful feature.  In fact, it turned out that there was little sense from her.  Left it, but for myself, transparency left 100%: <br><img src="https://habrastorage.org/getpro/habr/post_images/da2/d97/6ab/da2d976abbc42d932dceb64b025064d1.jpg"><br><br><h4>  Conclusion </h4>  I hope that my tool will be useful to you.  All source code is presented as is.  You can change it at your discretion, you can add salt / pepper, kittens, etc., to your taste, etc. without my permission.  I'm not a patent troll) </div><p>Source: <a href="https://habr.com/ru/post/211653/">https://habr.com/ru/post/211653/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211640/index.html">What is the use of a 3D printer?</a></li>
<li><a href="../211642/index.html">How I earned $ 500K on machine learning and high-frequency trading - Part 2</a></li>
<li><a href="../211644/index.html">The KUB-Mini controller - protection and monitoring with reservation</a></li>
<li><a href="../211645/index.html">How to spoil password security by following Habr's tips</a></li>
<li><a href="../211651/index.html">E-commerce trends: What is most important for an online store? Part 2</a></li>
<li><a href="../211655/index.html">Artificial intelligence in flight simulators</a></li>
<li><a href="../211657/index.html">ASUS Fonepad Note 6 Review</a></li>
<li><a href="../211659/index.html">Three rules for designing interfaces with high-speed user interaction</a></li>
<li><a href="../211661/index.html">Cross-platform https server with non-blocking sockets</a></li>
<li><a href="../211663/index.html">Overview of the Android core features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>