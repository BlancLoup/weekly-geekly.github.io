<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASP.NET MVC, WebApi, SignalR and UnityContainer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is known that all good Jedi use dependency injection ( translation ) in their projects; this increases the concentration of midichlorians in the bl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASP.NET MVC, WebApi, SignalR and UnityContainer</h1><div class="post__text post__text-html js-mediator-article">  It is known that all good Jedi use <a href="http://martinfowler.com/articles/injection.html">dependency injection</a> ( <a href="http://yugeon-dev.blogspot.ru/2010/07/inversion-of-control-containers-and_21.html">translation</a> ) in their projects; this increases the concentration of midichlorians in the blood and the testability of the code in the application.  In this article I want to consider some aspects of using <a href="http://unity.codeplex.com/">UnityContainer</a> in an ASP.NET application, namely, the use of dependency injection through controller constructors in ASP.NET MVC and WebApi and hubs in SignalR.  An example application is present. <br><br><img src="http://i1.asp.net/media/44907/dependency-injection-golf.png?raw=true&amp;cdn_id=2013-03-19-001" alt="Dependency Injection - Golf analogy"><br><a name="habracut"></a><br><br><h4>  Theory </h4><br>  Suppose that we have <a href="http://msdn.microsoft.com/ru-ru/library/ms172334.aspx">an open universal</a> repository interface: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br>  And we really want to get an instance of this repository in the controller, but with a specific type already.  I chose this example specifically, since this principle is often used when working with EntityFramework.  In addition, it allows you to demonstrate the difficulties that can be encountered when trying to get this type in the controller.  Consider the possible options. <br><br><h5>  Using the Service Locator </h5><br>  In this case, we simply store the container instance in a static field and, if necessary, obtain the required objects from it. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Global</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IUnityContainer ServiceLocator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnityContainer(); }</code> </pre> <br>  We register a specific class somewhere in Global.asax when loading the application. <br><br><pre> <code class="cs hljs">Global.ServiceLocator.RegisterType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IRepository&lt;&gt;), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Repository&lt;&gt;));</code> </pre> <br>  We get the repository in the controller. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repository = Global.ServiceLocator.Resolve&lt;IRepository&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); }</code> </pre> <br>  Everything works just fine, and the amount of code is minimal.  The problem is that now our controller depends on <code>Global.ServiceLocator</code> .  This, of course, is not as scary as dependence on a particular class, but it can also decently poison life during testing, especially if tests are run in parallel in several threads, and each test wants to use its own repository implementation. <br><br><h5>  Using Dependency Resolver </h5><br>  ASP.NET MVC, WebApi and SignalR provide excellent opportunities for expansion, in particular, the possibility of replacing the standard DependencyResolvers used by the infrastructure to resolve dependencies.  About how to do this, you can read the following articles: <br><br><ul><li>  <a href="http://www.asp.net/mvc/tutorials/hands-on-labs/aspnet-mvc-4-dependency-injection">How to do it in ASP.NET MVC 4;</a> </li><li>  <a href="http://www.asp.net/web-api/overview/extensibility/using-the-web-api-dependency-resolver">How to do it in the Web API</a> ; </li><li>  <a href="http://www.kevgriffin.com/using-unity-for-dependency-injection-with-signalr/">How to do it in SignalR;</a> </li></ul><br>  In all cases, we need to create our own class that implements the necessary <code>IDependencyResolver</code> and register it with the appropriate infrastructure.  I want to note that in each case, these interfaces have the same name, but are in different namespaces and have slightly different methods.  But they have one thing in common: if the requested type cannot be resolved, then they return <code>null</code> .  Or they are trying to find this type in <code>DefaultDependencyResolver</code> , in the case of SignalR, since it is in it that all components of its infrastructure are registered.  Obviously, this behavior is fundamentally different from what the <code>IUnitiContainer.Resolve()</code> method <code>IUnitiContainer.Resolve()</code> , which in this case simply throws an exception. <br><br>  It would seem, what's the problem?  Use the <code>IUnityContainer.IsRegistered()</code> extension <code>IUnityContainer.IsRegistered()</code> and, if the type is not registered, return <code>null</code> . <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> T TryResolve&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IUnityContainer container) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isRegistered = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> typeToCheck = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (T); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (typeToCheck.IsInterface || typeToCheck.IsAbstract) { isRegistered = container.IsRegistered(typeToCheck); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isRegistered &amp;&amp; typeToCheck.IsGenericType) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> openGenericType = typeToCheck.GetGenericTypeDefinition(); isRegistered = container.IsRegistered(openGenericType); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isRegistered ? container.Resolve&lt;T&gt;() : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(T); }</code> </pre> <br>  The above example is taken from the <a href="http://unitymvc3.codeplex.com/">Unity.MVC3</a> implementation.  His only problem is that in our example it will not work. <br><br><blockquote>  System.ArgumentException: The supplied type IRepository`1 doesn‚Äôt have the same type of argument as the target type Repository`1. </blockquote><br>  Well, let's try using the <code>try/catch</code> . <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> T TryResolve&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IUnityContainer container) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> container.Resolve&lt;T&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(T); } }</code> </pre> <br>  Even if we consider that managing the flow of execution through exceptions is a bad practice, this method has some performance problems. <br><br><blockquote>  <b>Time comparsion with 100,000 iterations.</b> <br><ol><li>  Elapsed (Resolve when registered): 00.38940s </li><li>  Elapsed (TryResolve when registered): 00.37679s </li><li>  Elapsed (TryResolve when does't registered): 00.00393s </li><li>  Elapsed (Resolve with IsRegistered when registered): 01.00460s </li><li>  Elapsed (Resolve with IsRegistered when does't registered): 00.72297s </li><li>  Elapsed (Resolve with Exception when registered): 00.32938s </li><li>  Elapsed (Resolve with Exception when does't registered): 05.60332s </li></ol></blockquote><br>  The first line shows the result of the test using a simple call to the <code>Resolve</code> method without any checks.  In the second and third - the <code>TryResolve</code> method, which will be <code>TryResolve</code> below.  In the fourth and fifth - check through <code>IsRegistered()</code> .  In the last two, using a <code>try/catch</code> .  It can be seen that the execution time in the third and seventh lines differs 1500 times.  This, of course, may be imperceptible in a real application, but still, not pleasant. <br><br>  In the depths of the UnityContainer method, the TryResolve method refers to the <code>UnityContainer.registeredNames.registeredKeys</code> field of type <code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code></code> <code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <h5> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </h5> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <h4> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </h4> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <pre> <code class="hljs lua"><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[<span class="hljs-number"><span class="hljs-number">0</span></span>]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType(<span class="hljs-string"><span class="hljs-string">"Microsoft.Practices.Unity.NamedTypesRegistry, "</span></span> + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredNames"</span></span>, flags); var registeredKeysInfo = registryType.GetField(<span class="hljs-string"><span class="hljs-string">"registeredKeys"</span></span>, flags); // Create <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code><code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> &lt;typeparamref name=<span class="hljs-string"><span class="hljs-string">"T"</span></span> /&gt; without name. /// If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract class <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> it is<span class="hljs-string"><span class="hljs-string">'t registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is'</span></span>t registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>) { bool resolve; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsInterface || <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsAbstract) { // Get the dictionary with registered types <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names. var keys = GetRegisteredKeys((UnityContainer) container); // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interface <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the container. resolve = IsRegistered(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, keys); // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> still is<span class="hljs-string"><span class="hljs-string">'t registered and it'</span></span>s generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> generic <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition is registered. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resolve &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.IsGenericType) { var openGenericType = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can be created <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it immediately. resolve = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } // If <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> is registered <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> resolve it <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nothing was found. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolve ? container.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, Dictionary&lt;Type, List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;&gt; keys) { List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; names; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, out names)) { // By default <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> without name is registered with null <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names.Exists(name =&gt; ReferenceEquals(name, null))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> classes are registered <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, <span class="hljs-string"><span class="hljs-string">"container == null"</span></span>); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Data {0} of type {1}"</span></span>, i, typeof (T)); } } public void Dispose() { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"Repository&lt;{0}&gt;.Dispose"</span></span>, typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC <span class="hljs-number"><span class="hljs-number">4</span></span> Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Data from DataController"</span></span>; var data = _repository.GetData(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; _repository; public DataWebApiController(IRepository&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; GetData() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Visual Studio <span class="hljs-number"><span class="hljs-number">2012</span></span></a> ,   <a href="http://vswebessentials.com/">Web Essentials <span class="hljs-number"><span class="hljs-number">2012</span></span></a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     <span class="hljs-string"><span class="hljs-string">"Hide overridden Visual Studio menu items"</span></span>   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/knockout/knockout.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/jquery/jquery.d.ts"</span></span> /&gt; /// &lt;reference <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=<span class="hljs-string"><span class="hljs-string">"../typings/signalr/signalr.d.ts"</span></span> /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> Request <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: get, post, delete, put. * @param url A <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. * @param dataType The <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of data that you<span class="hljs-string"><span class="hljs-string">'re expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { '</span></span>RequestVerificationToken<span class="hljs-string"><span class="hljs-string">': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it'</span></span>s empty <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. */ errorMessage = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Displays optional text. */ text = ko.observable(<span class="hljs-string"><span class="hljs-string">""</span></span>); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connect to hubs. */ constructor() { this.dataHub = $.connection[<span class="hljs-string"><span class="hljs-string">"dataHub"</span></span>]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"SignalR"</span></span>); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text(<span class="hljs-string"><span class="hljs-string">"WebApi"</span></span>); ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/api/dataWebApi"</span></span>) .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest(<span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"/Data"</span></span>, null, <span class="hljs-string"><span class="hljs-string">"html"</span></span>) .done(data =&gt; { this.data([]); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { this.text(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>); this.data([]); this.errorMessage(<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); } private showData(data: <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[]) { this.data(data); this.errorMessage(<span class="hljs-string"><span class="hljs-string">""</span></span>); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span2"</span></span>&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"btn-group btn-group-vertical"</span></span> data-toggle=<span class="hljs-string"><span class="hljs-string">"buttons-radio"</span></span>&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: signalrBtnClick"</span></span>&gt;SignalR&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: apiBtnClick"</span></span>&gt;WebApi&lt;/button&gt; &lt;button class=<span class="hljs-string"><span class="hljs-string">"btn span2"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"click: staticBtnClick"</span></span>&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"span5"</span></span>&gt; &lt;div data-bind=<span class="hljs-string"><span class="hljs-string">"visible: errorMessage() != ''"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"text-error"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"text: errorMessage"</span></span>&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"well"</span></span> data-bind=<span class="hljs-string"><span class="hljs-string">"visible: text() != ''"</span></span>&gt; &lt;p data-bind=<span class="hljs-string"><span class="hljs-string">"html: text"</span></span>&gt;&lt;/p&gt; &lt;ol data-bind=<span class="hljs-string"><span class="hljs-string">"foreach: data"</span></span>&gt; &lt;li&gt;&lt;span data-bind=<span class="hljs-string"><span class="hljs-string">"text: $data"</span></span>&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src=<span class="hljs-string"><span class="hljs-string">"~/signalr/hubs"</span></span>&gt; &lt;/script&gt; &lt;script <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; var <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> = { waitSeconds: <span class="hljs-number"><span class="hljs-number">15</span></span>, urlArgs: <span class="hljs-string"><span class="hljs-string">"bust="</span></span> + new Date().getTime() }; &lt;/script&gt; &lt;script data-main=<span class="hljs-string"><span class="hljs-string">"/scripts/app/init"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@Scripts.Url("</span></span>~/Scripts/<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.js<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   <span class="hljs-string"><span class="hljs-string">"Use the AMD module"</span></span>  <span class="hljs-literal"><span class="hljs-literal">true</span></span>   <span class="hljs-string"><span class="hljs-string">"Tools"</span></span>-<span class="hljs-string"><span class="hljs-string">"Options"</span></span>-<span class="hljs-string"><span class="hljs-string">"Web Essentials"</span></span>-<span class="hljs-string"><span class="hljs-string">"TypeScript"</span></span>-<span class="hljs-string"><span class="hljs-string">"Compiler flags"</span></span>. <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </pre> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> <h4> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </h4> <code><code><code>Dictionary&lt;Type, List&gt;     . ,     ,     null .   ,  TryResolve</code>     ,    ,       ,   ,     <code>Linq</code>         . ,    ,      ,   ,     .         ,  ,    <code>private</code>    <code>internal</code> .         (expression trees)   (reflection). <br> <br> <code class="cs">using System; using System.Collections.Generic; using System.Diagnostics; using System.Linq.Expressions; using System.Reflection; using Microsoft.Practices.Unity; namespace CommonInfrastructure { public static class UnityExtensions { private static readonly Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt; GetRegisteredKeys; private static readonly ResolverOverride[] EmptyResolverOverrides = new ResolverOverride[0]; static UnityExtensions() { // Get information about fileds. var unityType = typeof (UnityContainer); var registryType = Type.GetType("Microsoft.Practices.Unity.NamedTypesRegistry, " + unityType.Assembly.FullName); const BindingFlags flags = BindingFlags.Instance | BindingFlags.NonPublic; var registeredNamesInfo = unityType.GetField("registeredNames", flags); var registeredKeysInfo = registryType.GetField("registeredKeys", flags); // Create and compile expression to accessing the field // UnityContainer.registeredNames.registeredKeys of type Dictionary&lt;Type, List&lt;string&gt;&gt; var unityParam = Expression.Parameter(unityType); GetRegisteredKeys = Expression .Lambda&lt;Func&lt;UnityContainer, Dictionary&lt;Type, List&lt;string&gt;&gt;&gt;&gt;( Expression.Field( Expression.Field( unityParam, registeredNamesInfo), registeredKeysInfo), unityParam) .Compile(); } ....</code> <br>     <code>internal</code>  <code>NamedTypesRegistry</code> ,     .  <code>FieldInfo</code>    .      <code class="cs">Func&lt;UnityContainer, Dictionary&lt;Type, List&gt;&gt; GetRegisteredKeys = container =&gt; container.registeredNames.registeredKeys;. <br> <br> .... /// &lt;summary&gt; /// Try to resolve an instance of requested type &lt;typeparamref name="T" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static T TryResolve&lt;T&gt;(this IUnityContainer container) where T : class { return (T) TryResolve(container, typeof (T)); } /// &lt;summary&gt; /// Try to resolve an instance of requested &lt;paramref name="type" /&gt; without name. /// If type is interface or abstract class and it is't registered then return null. /// &lt;/summary&gt; public static object TryResolve(this IUnityContainer container, Type type) { bool resolve; if (type.IsInterface || type.IsAbstract) { // Get the dictionary with registered types and names. var keys = GetRegisteredKeys((UnityContainer) container); // Check if interface or abstract type is registered in the container. resolve = IsRegistered(type, keys); // If type still is't registered and it's generic type then check if generic type definition is registered. if (!resolve &amp;&amp; type.IsGenericType) { var openGenericType = type.GetGenericTypeDefinition(); resolve = IsRegistered(openGenericType, keys); } } else { // If type can be created then resolve it immediately. resolve = true; } // If type is registered then resolve it or return null if nothing was found. return resolve ? container.Resolve(type, null, EmptyResolverOverrides) : null; } private static bool IsRegistered(Type type, Dictionary&lt;Type, List&lt;string&gt;&gt; keys) { List&lt;string&gt; names; if (keys.TryGetValue(type, out names)) { // By default type without name is registered with null string. if (names.Exists(name =&gt; ReferenceEquals(name, null))) { return true; } } return false; } } }</code> <br>      ,      ,          .     ,   ,     . <br> <br> , ,    UnityContainer        ,  ,   : <a href="http://blogs.msdn.com/b/erwinvandervalk/archive/2009/02/13/test-if-classes-are-registered-in-unity.aspx">Test if classes are registered in unity</a> . ,   ,      . <br> <br>   <br> ASP.NET MVC, WebApi  SignalR         <code>I*Activator</code> .  ASP.NET MVC  <code>System.Web.Mvc.IControllerActivator</code> ,  WebApi  <code>System.Web.Http.Dispatcher.IHttpControllerActivator</code> ,  SignalR  <code>Microsoft.AspNet.SignalR.Hubs.IHubActivator</code> .      <code>Create</code> ,            .             . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Web.Mvc; using System.Web.Routing; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityControllerActivator : IControllerActivator { private readonly IUnityContainer _container; public UnityControllerActivator(IUnityContainer container) { _container = container; } public IController Create(RequestContext requestContext, Type controllerType) { return (IController) _container.Resolve(controllerType); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System; using System.Diagnostics; using System.Net.Http; using System.Web.Http.Controllers; using System.Web.Http.Dispatcher; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHttpControllerActivator : IHttpControllerActivator { private readonly IUnityContainer _container; public UnityHttpControllerActivator(IUnityContainer container) { _container = container; } public IHttpController Create(HttpRequestMessage request, HttpControllerDescriptor controllerDescriptor, Type controllerType) { return (IHttpController) _container.Resolve(controllerType); } } }</code> <br> <b>SignalR</b> <br> <code class="cs">using System.Diagnostics; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; namespace WebApp.Infrastructure { public sealed class UnityHubActivator : IHubActivator { private readonly IUnityContainer _container; public UnityHubActivator(IUnityContainer container) { Debug.Assert(container != null, "container == null"); _container = container; } public IHub Create(HubDescriptor descriptor) { var hubType = descriptor.HubType; return hubType != null ? _container.Resolve(hubType) as IHub : null; } } }</code> <br>    . <br> <br> <code class="cs">using System.Web.Http; using System.Web.Http.Dispatcher; using System.Web.Mvc; using Microsoft.AspNet.SignalR; using Microsoft.AspNet.SignalR.Hubs; using Microsoft.Practices.Unity; using WebApp.Infrastructure; using WebApp.Models; namespace WebApp.App_Start { public static class ContainerConfig { public static void Config() { var container = new UnityContainer(); MapTypes(container); // Set resolver to MVC. var controllerActivator = new UnityControllerActivator(container); ControllerBuilder.Current.SetControllerFactory(new DefaultControllerFactory(controllerActivator)); // Set resolver to WebApi. var httpControllerActivator = new UnityHttpControllerActivator(container); GlobalConfiguration.Configuration.Services.Replace(typeof (IHttpControllerActivator), httpControllerActivator); // Set resolver to SignalR. var hubActivator = new UnityHubActivator(container); GlobalHost.DependencyResolver.Register(typeof (IHubActivator), () =&gt; hubActivator); } private static void MapTypes(IUnityContainer container) { container.RegisterType(typeof(IRepository&lt;&gt;), typeof(Repository&lt;&gt;)); } } }</code> <br>        ,  ,  <code>Global.asax</code> .  ,  SignalR      . <br> <br> <code class="cs">using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing; using WebApp.App_Start; namespace WebApp { public class MvcApplication : HttpApplication { protected void Application_Start() { ContainerConfig.Config(); SignalRConfig.Config(RouteTable.Routes); AreaRegistration.RegisterAllAreas(); WebApiConfig.Config(GlobalConfiguration.Configuration); FilterConfig.Config(GlobalFilters.Filters); RouteConfig.Config(RouteTable.Routes); BundleConfig.Config(BundleTable.Bundles); AuthConfig.Config(); } } }</code> <br>        . <br> <br>  <br>      ,          .     ,   <code>GetData()</code>     ,    ,      . ,        . <br> <br> <code class="cs"> public sealed class Repository&lt;T&gt; : IRepository&lt;T&gt; { public IEnumerable&lt;string&gt; GetData() { for (int i = 0; i &lt; 10; i++) { yield return string.Format("Data {0} of type {1}", i, typeof (T)); } } public void Dispose() { Debug.WriteLine("Repository&lt;{0}&gt;.Dispose", typeof (T)); } }</code> <br>    ASP.NET MVC  WebApi      Controllers,    .  ,       <code>System.Web.Mvc.AuthorizeAttribute</code>  <code>System.Web.Http.AuthorizeAttribute</code>     .      ASP.NET MVC 4 Web Application - Single Page Application,     ,         . <br> <br> <b>ASP.NET MVC</b> <br> <code class="cs">using System.Web.Mvc; using WebApp.Models; namespace WebApp.Controllers { [Authorize] public sealed class DataController : Controller { private readonly IRepository&lt;int&gt; _repository; public DataController(IRepository&lt;int&gt; repository) { _repository = repository; } // GET: /Data/ public ActionResult Index() { ViewBag.Title = "Data from DataController"; var data = _repository.GetData(); return View(data); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br> <b>WebApi</b> <br> <code class="cs">using System.Collections.Generic; using System.Web.Http; using WebApp.Filters; using WebApp.Models; namespace WebApp.Controllers { [Authorize] [ValidateHttpAntiForgeryToken] public sealed class DataWebApiController : ApiController { private readonly IRepository&lt;string&gt; _repository; public DataWebApiController(IRepository&lt;string&gt; repository) { _repository = repository; } // GET /api/DataWebApi/ public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>   Hubs     .     <code>Microsoft.AspNet.SignalR.AuthorizeAttribute</code> . <br> <br> <b>SignalR</b> <br> <code class="cs">using System.Collections.Generic; using Microsoft.AspNet.SignalR; using WebApp.Models; namespace WebApp.Hubs { [Authorize] public sealed class DataHub : Hub { private readonly IRepository&lt;double&gt; _repository; public DataHub(IRepository&lt;double&gt; repository) { _repository = repository; } public IEnumerable&lt;string&gt; GetData() { return _repository.GetData(); } protected override void Dispose(bool disposing) { _repository.Dispose(); base.Dispose(disposing); } } }</code> <br>         .      ,             . <br> <br>      TypeScript.       <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34790">TypeScript for Visual Studio 2012</a> ,   <a href="http://vswebessentials.com/">Web Essentials 2012</a> .  ,   ,     <code>Scripts/app</code> .    NuGet : <a href="http://twitter.github.com/bootstrap/">Twitter.Bootstrap</a> , <a href="http://requirejs.org/">RequireJs</a> , <a href="http://knockoutjs.com/index.html">KnockoutJs</a> , <a href="http://jquery.com/">jQuery</a> , <a href="https://github.com/SignalR">SignalR</a> ,   <a href="http://nuget.org/packages%3Fq%3DTypeScript.DefinitelyTyped">TypeScript Definitions</a>  .       TypeScript.     ReSharper,           TypeScript,   ,     "Hide overridden Visual Studio menu items"   .          AMD . <br> <br> <b>/scripts/app/app.ts</b> <br> <code>/// &lt;reference path="../typings/knockout/knockout.d.ts" /&gt; /// &lt;reference path="../typings/jquery/jquery.d.ts" /&gt; /// &lt;reference path="../typings/signalr/signalr.d.ts" /&gt; /** * Helper method to creating ajax requests with anti firgery token. * @param type Request type: get, post, delete, put. * @param url A string containing the URL to which the request is sent. * @param data Data to be sent to the server. Before sending serializes to Json format. * @param dataType The type of data that you're expecting back from the server. Default is Json. */ function ajaxRequest(type: string, url: string, data?: any, dataType: string = "json") { var headers = {}; var antiForgeryToken = $("#antiForgeryToken").val(); if (antiForgeryToken) { headers = { 'RequestVerificationToken': antiForgeryToken } } return $.ajax(url, { headers: headers, dataType: dataType, contentType: "application/json", cache: false, type: type, data: data ? data.toJson() : null }); } interface IDataHub { client: {}; server: { getData(): JQueryDeferred; }; } export class AppViewModel { private dataHub: IDataHub; /** If error occurred this field should contain error message. Otherwise it's empty string. */ errorMessage = ko.observable(""); /** Displays optional text. */ text = ko.observable(""); /** Data received from server. */ data = ko.observableArray([]); /** Create ViewModel and connect to hubs. */ constructor() { this.dataHub = $.connection["dataHub"]; $.connection.hub .start() .fail(e =&gt; this.onFail(e)); } /** Receive data from SignalR hub. */ signalrBtnClick() { this.text("SignalR"); this.dataHub.server .getData() .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from WebApi controller. */ apiBtnClick() { this.text("WebApi"); ajaxRequest("get", "/api/dataWebApi") .done(d =&gt; this.showData(d)) .fail(e =&gt; this.onFail(e)); } /** Receive data from static page controller. */ staticBtnClick() { ajaxRequest("get", "/Data", null, "html") .done(data =&gt; { this.data([]); this.errorMessage(""); this.text(data); }) .fail(e =&gt; this.onFail(e)); } private onFail(error: string) { this.text("Error!"); this.data([]); this.errorMessage(error); } private showData(data: string[]) { this.data(data); this.errorMessage(""); } }</code> <br>    ,    ,     <code>DataHub</code> . ,      <code>*BtnClick</code> ,            . <br> <br> <code class="html">&lt;div class="row"&gt; &lt;div class="span2"&gt; &lt;div class="btn-group btn-group-vertical" data-toggle="buttons-radio"&gt; &lt;button class="btn span2" data-bind="click: signalrBtnClick"&gt;SignalR&lt;/button&gt; &lt;button class="btn span2" data-bind="click: apiBtnClick"&gt;WebApi&lt;/button&gt; &lt;button class="btn span2" data-bind="click: staticBtnClick"&gt;Static page&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="span5"&gt; &lt;div data-bind="visible: errorMessage() != ''"&gt; &lt;span class="text-error" data-bind="text: errorMessage"&gt;&lt;/span&gt; &lt;/div&gt; &lt;div class="well" data-bind="visible: text() != ''"&gt; &lt;p data-bind="html: text"&gt;&lt;/p&gt; &lt;ol data-bind="foreach: data"&gt; &lt;li&gt;&lt;span data-bind="text: $data"&gt;&lt;/span&gt;&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;</code> <br>     ,  -  ,  <code>require.js</code>    .      ,        <code>~/signalr/hubs</code> .       <code>init.ts</code> ,    RequireJs .       ,  RequireJs   . <br> <br> <code>&lt;script src="~/signalr/hubs"&gt; &lt;/script&gt; &lt;script type="text/javascript"&gt; var require = { waitSeconds: 15, urlArgs: "bust=" + new Date().getTime() }; &lt;/script&gt; &lt;script data-main="/scripts/app/init" type="text/javascript" src="@Scripts.Url("~/Scripts/require.js")"&gt; &lt;/script&gt;</code> <br>  <code>init.ts</code>         .       TypeScript   "Use the AMD module"  true   "Tools"-"Options"-"Web Essentials"-"TypeScript"-"Compiler flags". <br> <br> <b>/scripts/app/init.ts</b> <br> <code>import app = module("app"); $(() =&gt; { ko.applyBindings(new app.AppViewModel()); });</code> <br>   <code>export</code>  , ,    .       <code>import</code>  <code>module</code> ,           .      . <br> <br> <img src="https://habrastorage.org/storage2/d62/880/33b/d6288033bb839f884b10887f28c464e8.png"> <br> <br>  <br>    ,       ASP.NET       .      ,          ,    . TypeScript       ,       NuGet   TypeScript Definitions.  , ,    ,  JetBrains <a href="http://blogs.jetbrains.com/dotnet/2013/03/introducing-the-resharper-8-eap/"></a>  TypeScript   ReSharper    . SignalR    .  ,  WebSockets    Windows7,  ,           ,      .</code></code> </div><p>Source: <a href="https://habr.com/ru/post/175161/">https://habr.com/ru/post/175161/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175139/index.html">Website transfer from Visual Studio 2012 to hosting. Parallels Plesk Panel</a></li>
<li><a href="../175143/index.html">Increase usability by 1000% or ‚Äúpaper prototyping‚Äù</a></li>
<li><a href="../175149/index.html">Fifth round of the Windows Phone Next App Star contest</a></li>
<li><a href="../175151/index.html">Metric # 2 - Podcast on technologies and design of interfaces and services</a></li>
<li><a href="../175155/index.html">What we know about high density servers</a></li>
<li><a href="../175167/index.html">Firefox 20 release</a></li>
<li><a href="../175169/index.html">Dell Inspiron 7720 Laptop Video Review</a></li>
<li><a href="../175173/index.html">Blocking a resource by the decision of the prosecutor's office</a></li>
<li><a href="../175177/index.html">Free calls to USA and Canada from any SIP device</a></li>
<li><a href="../175183/index.html">Service Aereo wins in court, but expects lobbying in Congress</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>