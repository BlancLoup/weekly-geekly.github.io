<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We punch VMware vCenter</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Virtual system security is now a fashion trend, so you can not ignore this issue. Today we will break the very heart of the VMware infrastructure - th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We punch VMware vCenter</h1><div class="post__text post__text-html js-mediator-article">  Virtual system security is now a fashion trend, so you can not ignore this issue.  Today we will break the very heart of the VMware infrastructure - the vCenter server.  In this case, we will use 0-day vulnerabilities so that life does not seem like honey.  We will break with old-school methods that are not related to virtual technologies: the trend, of course, is fashionable, but the bugs are all the same trivial. <br><br>  PS: As usual in responsible white hats, all the bugs described here should already be closed, they were 0-actions at the time of hacking, that is, in 2011.  This text was published in Hacker No. 7/12 (162) and also served as the basis for reports at CONFidence 2012, PHD 2012 and Defcon 20. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  VMware vCenter </h4><br><br>  Many corporate systems live in virtual environments.  It's cheaper.  It is more convenient, it is cooler!  The leader in providing these very environments is the notorious VMware company.  These guys have a cool hypervisor and, which is also important, a bunch of software for convenient deployment, management and control.  All this makes VMware solutions flexible, scalable and, ultimately, effective.  For convenient administration of all this cool money, the guys have developed server software that consolidates the entire administrative part of the infrastructure - VMware vCenter.  That is, you have, for example, 10 iron machines with VMware ESX (i).  They have a total of 50 running virtual machines.  To administer this virtual zoo is rather inconvenient if you do not have this vCenter itself.  In addition, thanks to vCenter, all sorts of tricks are possible, such as transparent migration of virtual images in the event one ESX fails to work, etc. In short, a mega-friendly and important thing.  On this advertising is over.  The main point is that if an evil hackIr breaks your vCenter - the whole network is in his nasty hands. <br><br><h4>  Breaking through the defense </h4><br><br>  The famous researcher Claudio Criscone has repeatedly come across this ‚Äúcenter‚Äù, and therefore knows how to break it.  Here I am in one of the pen tests I ran into this software and decided to use the wisdom of Claudio to fill it all.  Actually, Claudio's idea was simple: our friend found a vulnerability in the vCenter update manager.  The vulnerability was not even the fault of VMware programmers.  The fact is that the web interface of this manager (hangs on TCP port 9084) uses Jetty as the web server.  Therefore, Claudio found the vulnerability there.  Vulnerability - a classic of the genre: going beyond the directory: <br><br> <code><a href="http://target/"></a> target:9084/vci/download/health.xml/%3f/../../../../../../FILE.EXT</code> <br> <br><img src="https://habrastorage.org/storage2/107/44f/48e/10744f48e75e352d855926c508e8362e.png"><br>  Slide Claudio from the Blackhat Conference ;-) <br><br>  It's simple: we read any files for which the account, from which vCenter is running, has enough rights.  But the question that Claudio asked is how to read the file?  In general, he rummaged through the file system and found a wonderful access log file in which the session code was stored (see screenshot of the slide). <br><br><img src="https://habrastorage.org/storage2/37d/93a/0d0/37d93a0d0b84ad11d9e335e5343c8936.png"><br>  The contents of the malicious file ;-) <br><br>  What is this code?  The fact is that the vSphere client works with the vCenter via the SOAP protocol, that is, it is normal HTTPS traffic, the body of which is an XML structure with data, commands, etc. At the same time, after administrator authentication, the code of the SOAP session is written to it , and subsequently this code is checked as a cookie with PHPSESSIONID, an analog type 8) Obviously, having stolen this code, we can slip it into our SOAP request, and vCenter will think that we have already authenticated as a kind of admin (if the session is still alive) ).  That is, Claudio suggests reading a log with these SOAP codes through a vulnerability in the Jetty web server. <br><br> <code><a href="http://target/"></a> target:9084/vci/download/health.xml/%3f/../../../../../../ProgramData\VMware\VMware VirtualCenter\Logs\vpxd-profiler-6.log</code> <br> <br>  Then you should substitute these codes in requests from vSphere.  For this, he even developed a proxy server, which on the fly replaces the session code in packages from vSphere, and included this proxy as part of his add-on to Metasploit - VASTO.  In addition, in this addon there are many other chips, but now we will not talk about it. <br><br>  In this way, our Italian friend from Google suggests punishing vCenter.  But the trouble is that all these bugs were outdated by the time of my pen test (spring-summer 2011): we had to deal with the latest software version, which means that Jetty was patched-patched. <br><br>  <i>Does the projectile fall into the same funnel twice?</i> <br><br>  Frustrated (freebies did not work), I began to think what to do.  In general, any pen-tester in such a situation will simply pass by and write in a report that there are no vulnerabilities on this resource.  But, as usual, feeling the disturbances in the Force, I did not trust these to your patches.  Something made me continue to mock Jetty, combining options for an exploit to go beyond the catalog.  And after 15 minutes I got the result.  Already in another place of the same update manager, again there was a vulnerability: <br><br> <code><a href="http://target/"></a> target:9084/vci/download/.\..\..\..\..\..\..\..\..\FILE.EXT</code> <br> <br>  This is already something, because you can go read a file with SOAP-codes! <br><br><img src="https://habrastorage.org/storage2/a04/354/5f2/a043545f244078b4115ef4b919162714.png"><br>  Trying to find your happiness ... <br><br>  But again, disappointment awaited us - the session codes are no longer contained in this wonderful file.  One can only note the excellent work of programmers from VMware, who swept the logs and made us badby.  Well, let's find out for ourselves what else could be on the file system, which is useful to us ... The very first thing that comes to mind is to steal the secret key for SSL.  Then with this key we can intercept SSL traffic and decrypt it (wireshark allows you to do this without problems).  The key itself can be found as follows: <br><br> <code><a href="http://target/"></a> target:9084/vci/downloads/.\..\..\..\..\..\..\..\Documents and Settings\All Users\Application Data\VMware\VMware VirtualCenter\SSL\rui.key</code> <br> <br>  Accordingly, if we organize the man-in-the-middle attack using ARP SPOOFING, we will be able to intercept traffic between the server and the administrative workstation.  By the way, IP addresses of administrators and their logins can still be found in the profiler file.  Of course, we can replace the SSL certificate (cain can do this without problems) and decrypt traffic without stealing the key, but then the administrator will see a warning about an invalid SSL certificate.  If we stole the key, the administrator will not see anything, as the certificate will be correct.  That is, such an attack is more cunning and secretive ... <br><br><img src="https://habrastorage.org/storage2/484/cbe/22a/484cbe22a8f6ac3a8a9428a3b7fcb3c1.png"><br>  Warning about a fake certificate! <br><br>  <b>VMware vCenter Orchestrator</b> <br><br>  But on the server with vCenter there is one more wonderful thing that comes with a free appendage and is installed at will - this is the ‚ÄúOrchestrator‚Äù.  Another management interface, this time by the ‚ÄúCenter‚Äù itself.  What is it for?  And this is not less cool stuff.  It is used to manage the data center lifecycle.  This is a whole framework for developing and automating various processes in a virtual infrastructure.  In short, it's cool and that's it.  Studying the file system, I came across the following file: <br><br> <code><a href="http://target/"></a> target:9084/vci/download/.\..\..\..\..\..\..\..\..\Program files\VMware\Infrastructure\Orchestrator\configuration\jetty\etc\passwd.properties</code> <br> <br><img src="https://habrastorage.org/storage2/ecc/5a5/ec2/ecc5a5ec2ee0d57d247f4f4f9999571f.png"><br>  Already something! <br><br>  That's exactly how we get some MD5-hash.  Obviously, there is hidden the password from the administrative account in this very ‚ÄúOrchestrator‚Äù.  What can I say?  Using MD5 without salt is not a secret.  So in this context, we very quickly got the password (in the screenshot, the default hashed password, by the way, so administrators can also cause problems).  Using the received password, we logged in through the web interface.  Comfortable, cute, pretty design, but we need more.  Having checked the web interface, we noticed that the same vCenter Server is used to manage the virtual infrastructure, which means that the Orchestrator should be able to authenticate there.  And he knows how, because somewhere in the settings an access password is set. <br><br><img src="https://habrastorage.org/storage2/feb/c26/95f/febc2695fc315c1c0b1184dbd4e5596e.png"><br>  Access settings to vCenter. <br><br>  Having opened the HTML code, I was happy: the password is displayed there in the clear as it is, although visually, in the browser, it hides behind the asterisks. <br><br><img src="https://habrastorage.org/storage2/135/1b8/be0/1351b8be0d8d289adf3d25bffaed3bc3.png"><br>  Admin account from vCenter is ours! <br><br>  In addition, there passwords from the mail account, from domain accounts and from other things that the "Orchestra" should be able to use.  Directly password manager for a hacker!  It is clear that the entire system was successfully hacked, not only virtual, but also a domain controller, which means everything that was there. <br><br><h4>  Moarrrrrr! </h4><br><br>  It would seem that everything, but there is one more detail.  As you noticed, the ‚ÄúOrchestrator‚Äù stores passwords somewhere.  And so that they can be obtained in its pure form and use.  This tells us that it was possible not to break the MD5-hash, but to look for where these passwords lie.  Having rummaged a bit, I did find them: for example, the password for vCenter access is stored: <br><br> <code><a href="http://target/"></a> target:9084/vci/download/.\..\..\..\..\..\..\..\..\Program Files\VMware\Infrastructure\Orchestrator\app-server\server\vmo\conf\plugins\VC.xml</code> <br> <br>  And, judging by the format of the encoded string, this encryption is reversible.  Even similar passwords look encrypted very similar. <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">virtual-infrastructure-hosts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">virtual-infrastructure-host</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"VirtualCenterHost"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://new-virtual-center-host:443/sdk<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">administrator-username</span></span></span><span class="hljs-tag">&gt;</span></span>vmware<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">administrator-username</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">administrator-password</span></span></span><span class="hljs-tag">&gt;</span></span>000a506275767b74786b383a4a60be767864740329d5fcf324ec7fc98b1e0aaeef <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">administrator-password</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span>%u<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pattern</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">virtual-infrastructure-host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">virtual-infrastructure-hosts</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Another interesting file is C: \ Program Files \ VMware \ Infrastructure \ Orchestrator \ app-server \ server \ vmo \ conf \ vmo.propirties.  Here the password from the DBMS is encoded in the same way. <br><br>  It remains to understand the essence of the coding method and understand whether our guess is correct or not.  This is where my friend and colleague comes in, and also the CTF-team player LeetMore - Alexander <a href="https://habrahabr.ru/users/jug/" class="user_link">jug</a> Minozhenko.  For him, such puzzles are like two fingers ... With one of his eyes, he determined that the first two bytes describe the length of the entire password, and then comes the coded representation.  Sasha simply decompiled the Orchestrator Java class, which is responsible for saving the password, and parsed the encoding algorithm.  The point is simple: we take the password length, then we encode every byte of the password in Hex, adding to it the position number of the byte (starting from zero).  Thus, the coded value of ‚ÄúPassword01.‚Äù Looks like: <br><br> <code>000a506275767b74786b383a4a60be767864740329d5fcf324ec7fc98b1e0aaeef</code> <br> <br>  Sasha wrote a decoder (on Ruby): <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  pass = "010506275767b74786b383a4a60be767864740329d5fcf324ec7fc98b1e0aaeef" #  len = (pass[0..2]).to_i #  3    enc_pass = pass[3..-1].scan(/.{2}/) #  hex-   dec_pass = (0...len).collect do |i| byte = enc_pass[i].to_i(16) #  hex    byte -= i #        byte.chr end # ‚Äì  : ‚ÄúPassword01.‚Äù puts "Password: #{dec_pass.join()}"</span></span></code> </pre><br><br>  Thus, the attack is reduced to the use of our 0-day, to read the file, and the second - to decode passwords from the read files.  And again we get full access to vCenter.  In a few seconds ... (the corresponding module for Metasploit is ready) <br><br><h4>  The final </h4><br><br>  As you can see, 0-dei are simple and dangerous.  What else can be said? .. If administrators filtered access using a firewall, restricting access to administrative ports, it would be much more difficult to launch an attack.  Much remains behind the scenes, because the protection of the virtual infrastructure is not the matter of one minute and not one server.  I can advise everyone VMware Hardening Guide (http://www.vmware.com/files/pdf/techpaper/VMW-TWP-vSPHR-SECRTY-HRDNG-USLET-101-WEB-1.pdf).  This PDF contains many places you should pay attention to.  That's all, do not get sick! </div><p>Source: <a href="https://habr.com/ru/post/151704/">https://habr.com/ru/post/151704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151696/index.html">Forced HTTP session breaks with MiTM</a></li>
<li><a href="../151697/index.html">Update banking application. Preview and invitation to implement your ideas in our application (by our developers)</a></li>
<li><a href="../151698/index.html">A simple sms bot on the shell</a></li>
<li><a href="../151700/index.html">Yate: Yandex.Mail has moved to a new template engine</a></li>
<li><a href="../151703/index.html">Easy walk from functor through monad to arrow</a></li>
<li><a href="../151705/index.html">A new world record for overclocking the Intel Core i7 3770K on the ASRock Z77 OC Formula</a></li>
<li><a href="../151706/index.html">Opus free audio codec officially became IETF standard</a></li>
<li><a href="../151709/index.html">Practical application of MSP430 for web-developer</a></li>
<li><a href="../151712/index.html">Using Visual Studio 2010 shell to compile projects using gcc on Linux</a></li>
<li><a href="../151713/index.html">Creating a Centralized AD: Object Naming Standards, Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>