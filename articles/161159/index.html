<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hacking old captcha site Habrahabr</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 

 This article briefly describes the captcha hacking process used earlier when entering the Habrahabr site. 
 The aim of the work is to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hacking old captcha site Habrahabr</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br><br>  This article briefly describes the captcha hacking process used earlier when entering the Habrahabr site. <br>  <b>The aim of the</b> work is to apply knowledge in practice and test the complexity of the captcha. <br>  In developing the algorithm used Matlab. <br><br><a name="habracut"></a><br><h3>  Task Overview </h3>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The old captcha Habrahabr looked like this: <br><table><tbody><tr><th><img src="https://habrastorage.org/storage2/4d7/9ec/b0c/4d79ecb0c4cdde320a0b3121e2cd713c.png"><br></th><th><img src="https://habrastorage.org/storage2/9c4/149/2fb/9c41492fb69a74d6293a3d6b8bff16ca.png"><br></th><th><img src="https://habrastorage.org/storage2/ea0/030/0e6/ea00300e645477835b215569dbe61fea.png"><br></th><th><img src="https://habrastorage.org/storage2/279/ab8/f8d/279ab8f8d2a16d326c32b3a11f4ba03a.png"><br></th><th><img src="https://habrastorage.org/storage2/479/bf2/de0/479bf2de02597e4138290e9ccd741083.png"></th></tr></tbody></table><br>  The main difficulties of recognizing this captcha: <br><ol><li>  Distorted characters </li><li>  Noise and blur </li><li>  Character sizes are very different. </li><li>  Intersection of characters </li></ol><br>  Honestly, I didn‚Äôt always succeed in reading the captcha correctly the first time, since often the symbols A and 4, L and 4 were indistinguishable. <br><br>  Yet, despite some difficulties, consider the main ideas for reading this captcha. <br><br><h3>  Stage 1. Building a segmentation system </h3><br><br>  Each character recognition system can be represented as follows: <br><img src="https://habrastorage.org/storage2/cd4/fcb/88e/cd4fcb88e5b48336440df325ab191971.png"><br><br>  In our case, it is necessary to implement the last two subsystems. <br><br>  A detailed analysis of the captcha under study made it possible to identify its main features: <br><ol><li>  There are always 6 symbols on the captcha. </li><li>  Always use a similar (most likely the same) method of noise reduction. </li><li>  Rarely intersecting or overlapping characters </li></ol><br>  Based on this, the following segmentation algorithm was built: <br><ol><li>  Remove noise </li><li>  Binarize image </li><li>  Select the 6 largest connectivity areas </li></ol><br><br><div class="spoiler">  <b class="spoiler_title">Implementing Segmentation in Matlab</b> <div class="spoiler_text"><pre><code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">function</span></span> [ rects ] = segmentator( aImg, nRect, lightMode ) %find all symbols on habrahabr login captcha %use: rects = segmentator( aImg, nRect ) %<span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: % rects - rects coordinates % aImg - resized image <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> % nRect - count of rect to find % lightMode - find all rects without imOpen % ,          . if nargin &lt; 4 fSRects = 0; end if nargin &lt; 3 lightMode = 0; end minX = 8; if lightMode minX = 11; end %px minY = 16; if lightMode minY = 18; end %px %% </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Change</span></span></span><span class="hljs-class"> color mode to 8-bit gray if(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">),2) &gt; 2) aImg = imadjust(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rgb2gray</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">)); end %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Save</span></span></span><span class="hljs-class"> aImg aImgCopy = aImg; %structuring element for imopen se = strel('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">disk'</span></span></span><span class="hljs-class">, 2); %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Remove</span></span></span><span class="hljs-class"> some noise aImg(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class"> &gt; 0.92) = 1; aImg = imopen(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imadjust</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">), se); if lightMode aImg = aImgCopy; end imBW3 = adaptivethreshold(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">,50,0.2,0); if ~lightMode imBW3 = imopen(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imBW3</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">se</span></span></span><span class="hljs-class">); end %% find rects imBin = 1 - imBW3; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CC</span></span></span><span class="hljs-class"> = bwconncomp(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imBin</span></span></span><span class="hljs-class">); numPixels = cellfun(@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numel</span></span></span><span class="hljs-class">,</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CC</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelIdxList</span></span></span><span class="hljs-class">); [biggest, idx] = sort(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numPixels</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">descend'</span></span></span><span class="hljs-class">); bb = regionprops(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CC</span></span></span><span class="hljs-class">, '</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">'); if lightMode imshow(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImgCopy</span></span></span><span class="hljs-class">); end %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Primitive</span></span></span><span class="hljs-class"> filter %copy only good rects bbCounter = 1; for i = 1 : length(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bb</span></span></span><span class="hljs-class">) curRect = bb(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">; if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">curRect</span></span></span><span class="hljs-class">(3) &lt; minX || curRect(4) &lt; minY) continue; end bbNew(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbCounter</span></span></span><span class="hljs-class">) = bb(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">); bbCounter = bbCounter + 1; end if bbCounter == 1 rects = {-1}; return; end if </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DEBUG_MODE</span></span></span><span class="hljs-class"> for i = 1:length(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">) rectangle('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Position</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, '</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EdgeColor'</span></span></span><span class="hljs-class">, 'r'); end end %analize count of rects %1: if rectC == nrect -&gt; all rects find %2: else if rectC &gt; nrect -&gt; delete smallest %3: else -&gt; find subrects if nRect == length(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">) || fSRects == 1 rects = {</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(1:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">}; elseif nRect &lt; length(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">) rects = deleteSmallest( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nRect</span></span></span><span class="hljs-class"> ) else for i = 1 : length(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">) curRect = bbNew(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">; rectArea(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">) = curRect(3) .* curRect(4); end needRect = nRect - length(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">); aImg = aImgCopy; [biggest, idx] = sort(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rectArea</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">descend'</span></span></span><span class="hljs-class">); switch(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">needRect</span></span></span><span class="hljs-class">) %@todo: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Redesign</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">check</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">constant</span></span></span><span class="hljs-class">) case 1 subRects{1} = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(1)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, 2 ); subRectIdx = idx(1); case 2 if( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">biggest</span></span></span><span class="hljs-class">(1) &gt; 2 * biggest(2) ) subRects{1} = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(1)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, 3 ); subRectIdx = idx(1); else subRects{1} = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(1)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, 2 ); subRects{2} = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(2)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, 2 ); subRectIdx = idx(1:2); end case 3 if( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">biggest</span></span></span><span class="hljs-class">(1) &gt; 3 * biggest(2) ) subRects{1} = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(1)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, 4 ); subRectIdx = idx(1); elseif( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">biggest</span></span></span><span class="hljs-class">(1) &gt; 1.5 * biggest(2) ) subRects{1} = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(1)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, 3 ); subRects{2} = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(2)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, 2 ); subRectIdx = idx(1:2); else subRects{1} = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(1)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, 2 ); subRects{2} = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(2)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, 2 ); subRects{3} = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(3)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">, 2 ); subRectIdx = idx(1:3); end otherwise display('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Not</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">supported</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now'</span></span></span><span class="hljs-class">); %@todo: add more mode rects = {-1}; return; end %create return value rC = 1; for srC = 1:length(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbNew</span></span></span><span class="hljs-class">) if(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sum</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">srC</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subRectIdx</span></span></span><span class="hljs-class">)) curIdx = find(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subRectIdx</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">srC</span></span></span><span class="hljs-class">); for srC2 = 1 : length(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subRects</span></span></span><span class="hljs-class">{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">curIdx</span></span></span><span class="hljs-class">}) rects(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rC</span></span></span><span class="hljs-class">) = subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">curIdx</span></span></span><span class="hljs-class">}(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">srC2</span></span></span><span class="hljs-class">); rC = rC + 1; end else rects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rC</span></span></span><span class="hljs-class">} = bbNew(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">srC</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">; rC = rC + 1; end end end end function [ subRects ] = findSubRects( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">curRect</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nSubRect</span></span></span><span class="hljs-class"> ) coord{1} = [0]; pr(1) = 100; coord{2} = [0 40]; pr(2) = 60; coord{3} = [0 30 56]; pr(3) = 44; coord{4} = [0 23 46 70]; pr(4) = 30; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MIN_AREA</span></span></span><span class="hljs-class"> = 250; if </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DEBUG_MODE</span></span></span><span class="hljs-class"> imshow(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">); end wide = curRect(3); for i = 1 : nSubRect subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}(1) = curRect(1) + coord{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nSubRect</span></span></span><span class="hljs-class">}(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">) * wide / 100; subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}(2) = curRect(2); subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}(3) = wide * pr(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nSubRect</span></span></span><span class="hljs-class">) / 100; subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}(4) = curRect(4); rect{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">} = imcrop(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aImg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subRects</span></span></span><span class="hljs-class">{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}); tmpRect = rect{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}; lvl = graythresh(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmpRect</span></span></span><span class="hljs-class">); tmpRect = imadjust(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmpRect</span></span></span><span class="hljs-class">); tmpRect(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmpRect</span></span></span><span class="hljs-class"> &gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lvl</span></span></span><span class="hljs-class"> + 0.3) = 1;imshow(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmpRect</span></span></span><span class="hljs-class">); tmpRect(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmpRect</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lvl</span></span></span><span class="hljs-class"> - 0.3) = 0;imshow(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmpRect</span></span></span><span class="hljs-class">); imbw3 = multiScaleBin(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmpRect</span></span></span><span class="hljs-class">, 0.22, 1.4, 30, 1);imshow(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imbw3</span></span></span><span class="hljs-class">); imbin = 1 - imbw3; %imBin = binBlur(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmpRect</span></span></span><span class="hljs-class">, 13, 1); imshow(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imBin</span></span></span><span class="hljs-class">); %other method of %adaptive binarization cc = bwconncomp(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imbin</span></span></span><span class="hljs-class">); numpixels = cellfun(@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numel</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cc</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelIdxList</span></span></span><span class="hljs-class">); [biggest, idx] = sort(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numpixels</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">descend'</span></span></span><span class="hljs-class">); bb = regionprops(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cc</span></span></span><span class="hljs-class">, '</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Boundingbox</span></span></span><span class="hljs-class">'); imshow(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rect</span></span></span><span class="hljs-class">{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}); %find biggest rect clear rectArea; for j = 1 : length(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bb</span></span></span><span class="hljs-class">) rectArea(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">) = bb(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">(3) .* bb(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">(4); end [biggest, idx] = sort(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rectArea</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">descend'</span></span></span><span class="hljs-class">); newRect = bb(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">(1)).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">; rectangle('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Position</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">newRect</span></span></span><span class="hljs-class">, '</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EdgeColor</span></span></span><span class="hljs-class">', '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r'</span></span></span><span class="hljs-class">); if newRect(3) * newRect(4) &gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MIN_AREA</span></span></span><span class="hljs-class"> subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}(1) = subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}(1) + newRect(1) - 1; subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}(2) = subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}(2) + newRect(2) - 1; subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}(3) = newRect(3); subRects{</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">}(4) = newRect(4); end end end function [ retValue ] = deleteSmallest( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbRects</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nRects</span></span></span><span class="hljs-class"> ) %1: calc area for i = 1 : length(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbRects</span></span></span><span class="hljs-class">) curRect = bbRects(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">; rectArea(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">) = curRect(3) .* curRect(4); end %2: sort area [~, idx] = sort(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rectArea</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">descend'</span></span></span><span class="hljs-class">); idx = idx(1:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nRects</span></span></span><span class="hljs-class">); idx = sort(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">); %copy biggest retValue = {</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bbRects</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idx</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BoundingBox</span></span></span><span class="hljs-class">}; end function [ imBIN ] = sauvola( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">X</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> ) h = fspecial('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">average'</span></span></span><span class="hljs-class">); local_mean = imfilter(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">X</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">h</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">symmetric'</span></span></span><span class="hljs-class">); local_std = sqrt(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imfilter</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">X</span></span></span><span class="hljs-class"> .^ 2, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">h</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">symmetric'</span></span></span><span class="hljs-class">)); imBIN = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">X</span></span></span><span class="hljs-class"> &gt;= (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">local_mean</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">local_std</span></span></span><span class="hljs-class">); end</span></span></code> </pre> <br></div></div><br><br>  We remove noise very simply, for this we make all pixels of an image that are lighter than a certain level white. <br>  Processing Example: <br><table><tbody><tr><th>  Original image <br></th><th>  Image after processing <br></th></tr><tr><td><img src="https://habrastorage.org/storage2/455/a85/d96/455a85d96aebbf0819f60254fd0adc80.png"><br></td><td><img src="https://habrastorage.org/storage2/c3f/829/c8d/c3f829c8d77b8a779fded9f8eb5e53b0.png"><br></td></tr></tbody></table><br>  For binarization, we use an adaptive binarization algorithm, in which for each pixel (or regions of pixels) its own binarization threshold is defined [ <a href="http://homepages.inf.ed.ac.uk/rbf/HIPR2/adpthrsh.htm">Adaptive binarization</a> ]. <br>  Examples of binarization: <br><table><tbody><tr><th>  A good example of segmentation (3XJ6YR) <br></th><th>  An example of glued and broken characters (4TAMMY) <br></th></tr><tr><td><img src="https://habrastorage.org/storage2/ccd/67e/504/ccd67e5041330d0b178112895eaeda82.png"><br></td><td><img src="https://habrastorage.org/storage2/3b6/942/03b/3b694203b726cc39b6bb93b85e401b70.png"><br></td></tr></tbody></table><br>  To search for characters in the image, it was decided to use the method of searching for connected areas, which in Matlab can be done using functions: <br><pre> <code class="matlab hljs">CC = bwconncomp(imBin); bb = regionprops(CC, <span class="hljs-string"><span class="hljs-string">'BoundingBox'</span></span>);</code> </pre><br>  After that, analyze the areas obtained, select the largest of them, if necessary, break into subregions (in the case of glued characters).  The case when gaps appear in the characters is not provided. <br><br>  Examples of the final result of segmentation: <br><table><tbody><tr><td><img src="https://habrastorage.org/storage2/93e/2e4/495/93e2e449545e575c3bd53499c8e69e3a.png"><br></td><td><img src="https://habrastorage.org/storage2/5d3/5a3/c3b/5d35a3c3bd4cce16b60694a20778c1b8.png"><br></td><td><img src="https://habrastorage.org/storage2/21c/46e/c0a/21c46ec0ad5c3d82040940db6d8ca11e.png"><br></td><td><img src="https://habrastorage.org/storage2/0ec/e22/d53/0ece22d53df57f7e8624092b0cc9fac4.png"><br></td><td><img src="https://habrastorage.org/storage2/fbe/ed6/1e9/fbeed61e9d371695bee983b35f28a000.png"><br></td></tr></tbody></table><br><br>  The quality of the segmentation is satisfactory, proceed to the next stage. <br><br><h3>  Stage 2. Creating a training sample </h3><br>  After segmentation, we get a set of coordinates of rectangles that are supposedly contain captcha symbols. <br>  Therefore, we first manually recognize all captis and rename them (at that moment I felt like a professional captcha discerner, it‚Äôs a pity that I didn‚Äôt pay 1 cent for each recognized one).  Then use the following script to form a training sample: <br><div class="spoiler">  <b class="spoiler_title">Script to create a training sample</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">%CreateTrainSet.m clear; clc; workDir = <span class="hljs-string"><span class="hljs-string">'.\captch'</span></span>; fileList = dir([workDir <span class="hljs-string"><span class="hljs-string">'\*.png'</span></span>]); N_SYMB = <span class="hljs-number"><span class="hljs-number">6</span></span>; SYMB_W = <span class="hljs-number"><span class="hljs-number">18</span></span>; %px SYMB_H = <span class="hljs-number"><span class="hljs-number">28</span></span>; %px WIDTH = <span class="hljs-number"><span class="hljs-number">166</span></span>; %px HIGH = <span class="hljs-number"><span class="hljs-number">75</span></span>; %px SAVE_DIR = [workDir <span class="hljs-string"><span class="hljs-string">'\Alphabet'</span></span>]; %process data <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CC = <span class="hljs-number"><span class="hljs-number">1</span></span> : length(fileList) imName = fileList(CC).name; recognizedRes = imName(<span class="hljs-number"><span class="hljs-number">1</span></span>:N_SYMB); %<span class="hljs-keyword"><span class="hljs-keyword">open</span></span> image [cdata, map] = imread( [workDir <span class="hljs-string"><span class="hljs-string">'\'</span></span> imName] ); %change color mode <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ~isempty( map ) cdata = ind2rgb( cdata, map ); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> %resize image cdata = imresize(cdata, [HIGH WIDTH], <span class="hljs-string"><span class="hljs-string">'lanczos3'</span></span>); %find <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> symbols <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> image rects = segmentator(cdata, N_SYMB, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> rects{<span class="hljs-number"><span class="hljs-number">1</span></span>} == <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> %imcrop <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> save <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> length(rects) == N_SYMB <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ~exist(SAVE_DIR) mkdir(SAVE_DIR); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j = <span class="hljs-number"><span class="hljs-number">1</span></span> : N_SYMB <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ~exist([SAVE_DIR <span class="hljs-string"><span class="hljs-string">'\'</span></span> recognizedRes(j)]) mkdir([SAVE_DIR <span class="hljs-string"><span class="hljs-string">'\'</span></span> recognizedRes(j)]); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> imList = dir([SAVE_DIR <span class="hljs-string"><span class="hljs-string">'\'</span></span> recognizedRes(j) <span class="hljs-string"><span class="hljs-string">'\*.jpg'</span></span>]); newname = num2str(length(imList) + <span class="hljs-number"><span class="hljs-number">1</span></span>); nameS = floor(log10(length(imList) + <span class="hljs-number"><span class="hljs-number">1</span></span>)) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> z = nameS : <span class="hljs-number"><span class="hljs-number">4</span></span> newname = [<span class="hljs-string"><span class="hljs-string">'0'</span></span> newname]; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> tim = imcrop(cdata, rects{j}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( size( size(tim), <span class="hljs-number"><span class="hljs-number">2</span></span> ) &gt; <span class="hljs-number"><span class="hljs-number">2</span></span> ) tim = imadjust(rgb2gray(tim)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> tim = imresize(tim, [SYMB_H SYMB_W], <span class="hljs-string"><span class="hljs-string">'lanczos3'</span></span>); imwrite(tim, [SAVE_DIR <span class="hljs-string"><span class="hljs-string">'\'</span></span> recognizedRes(j) <span class="hljs-string"><span class="hljs-string">'\'</span></span> newname <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br><br>  After creating the sample, you need to clean it of the wrong characters that appear due to inaccurate segmentation. <br>  An interesting fact is that the captcha uses only 23 Latin characters. <br>  Training sample is present in the materials attached to the article. <br><br><h3>  Stage 3. Neural network training </h3><br>  Neural Network Toolbox is used to train the neural network. <br>  The learning function is described below: <br><div class="spoiler">  <b class="spoiler_title">Creation and training of a neural network</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> [net, alphabet, inpD, tarD] = train_NN(alphabet_dir, IM_W, IM_H, neuronC) %inputs: % alphabet_dir - <span class="hljs-type"><span class="hljs-type">path</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> directory <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> alphabet % IM_W - image width % IM_H - image height % neuronC - count <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> neuron <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hidden layer %outputs: % net - trained net % alphabet - net alphabet % inpD - <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> data % tarD - target data % % Vadym Drozd drozdvadym@gmail.com dirList = dir([alphabet_dir <span class="hljs-string"><span class="hljs-string">'\'</span></span>]); dir_name = {dirList([dirList(:).isdir]).name}; alphabetSize = length(dir_name) - <span class="hljs-number"><span class="hljs-number">2</span></span>; try a = <span class="hljs-keyword"><span class="hljs-keyword">load</span></span>([alphabet_dir <span class="hljs-string"><span class="hljs-string">'\'</span></span> <span class="hljs-string"><span class="hljs-string">'trainData_'</span></span> num2str(IM_W) <span class="hljs-string"><span class="hljs-string">'x'</span></span> num2str(IM_H) <span class="hljs-string"><span class="hljs-string">'_.dat'</span></span>], <span class="hljs-string"><span class="hljs-string">'-mat'</span></span>); catch <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> try target = a.target; inpData = a.inpData; alphabet = a.alphabet; catch <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i = <span class="hljs-number"><span class="hljs-number">3</span></span> : length(dir_name) alphabet(i - <span class="hljs-number"><span class="hljs-number">2</span></span>) = dir_name{i}; imgList = dir([alphabet_dir <span class="hljs-string"><span class="hljs-string">'\'</span></span> alphabet(i - <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">'\*.jpg'</span></span>]); t_tar = zeros(alphabetSize, length(imgList)); t_tar(i - <span class="hljs-number"><span class="hljs-number">2</span></span>,:) = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j = <span class="hljs-number"><span class="hljs-number">1</span></span> : length(imgList) im = imread([alphabet_dir <span class="hljs-string"><span class="hljs-string">'\'</span></span> dir_name{i} <span class="hljs-string"><span class="hljs-string">'\'</span></span> imgList(j).name]); im = imresize(im, [IM_H IM_W], <span class="hljs-string"><span class="hljs-string">'lanczos3'</span></span>); %resize image im = imadjust(im); im = <span class="hljs-type"><span class="hljs-type">double</span></span>(im) /<span class="hljs-number"><span class="hljs-number">255.0</span></span>; im = im(:); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> i == <span class="hljs-number"><span class="hljs-number">3</span></span> &amp;&amp; j == <span class="hljs-number"><span class="hljs-number">1</span></span> inpData = im; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> inpData = [inpData im]; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> i == <span class="hljs-number"><span class="hljs-number">3</span></span> target = t_tar; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> target = [target t_tar ]; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> train NN toc min_max = minmax(inpData); habrNN = newff(min_max, [IM_H * IM_W neuronC <span class="hljs-number"><span class="hljs-number">23</span></span>], {<span class="hljs-string"><span class="hljs-string">'logsig'</span></span>, <span class="hljs-string"><span class="hljs-string">'tansig'</span></span>,<span class="hljs-string"><span class="hljs-string">'logsig'</span></span>}, <span class="hljs-string"><span class="hljs-string">'trainrp'</span></span>); habrNN.trainParam.min_grad = <span class="hljs-number"><span class="hljs-number">10E-12</span></span>; habrNN = train(habrNN, inpData, target); display(<span class="hljs-string"><span class="hljs-string">'Training time:'</span></span>); timeE = toc; display(timeE); net = habrNN; inpD = inpData; tarD= target; save([alphabet_dir <span class="hljs-string"><span class="hljs-string">'\'</span></span> <span class="hljs-string"><span class="hljs-string">'trainData_'</span></span> num2str(IM_W) <span class="hljs-string"><span class="hljs-string">'x'</span></span> num2str(IM_H) <span class="hljs-string"><span class="hljs-string">'_.dat'</span></span>], <span class="hljs-string"><span class="hljs-string">'inpData'</span></span>, <span class="hljs-string"><span class="hljs-string">'target'</span></span>, <span class="hljs-string"><span class="hljs-string">'alphabet'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br><br>  The following neural network architecture is chosen: <br><img src="https://habrastorage.org/storage2/f40/d29/52b/f40d2952b08b45f34098bfbc86dca211.png"><br><br>  The size of the images arriving at the input of the neural network is 10 * 12 pixels.  As it is known, training of a neural network is not easy, because it is not immediately known what the network architecture should be, the number of neurons in each of the layers, and it is not known which of the many minima the training of the network rolls down.  Therefore, training was conducted several times, after which one of the best results was chosen. <br><br><h3>  Stage 4. Algorithm Testing </h3><br>  The following script was written for testing the algorithm: <br><br><div class="spoiler">  <b class="spoiler_title">The script for captcha recognition</b> <div class="spoiler_text"><pre> <code class="hljs python">%% captchReader.m clear; close all; clc; cdir = <span class="hljs-string"><span class="hljs-string">'./captch/'</span></span>; fileList = dir([ cdir <span class="hljs-string"><span class="hljs-string">'\*.png'</span></span>]); load(<span class="hljs-string"><span class="hljs-string">'49_67_net.mat'</span></span>); load(<span class="hljs-string"><span class="hljs-string">'alphabet.mat'</span></span>); N_SYMB = <span class="hljs-number"><span class="hljs-number">6</span></span>; SYMB_W = <span class="hljs-number"><span class="hljs-number">10</span></span>; SYMB_H = <span class="hljs-number"><span class="hljs-number">12</span></span>; WIDTH = <span class="hljs-number"><span class="hljs-number">166</span></span>; %px HIGH = <span class="hljs-number"><span class="hljs-number">75</span></span>; %px SHOW_RECT = <span class="hljs-number"><span class="hljs-number">1</span></span>; %<span class="hljs-number"><span class="hljs-number">1</span></span> - show rects, <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> - don<span class="hljs-string"><span class="hljs-string">'t show correct = 0; %correct recognized results correctSymbC = 0; allSymbC = 0; for CC = 1 : length(fileList) imName = fileList(CC).name; %open image [cdata, map] = imread( [cdir '</span></span>\<span class="hljs-string"><span class="hljs-string">' imName] ); %change color mode if ~isempty( map ) cdata = ind2rgb( cdata, map ); end %resize image cdata = imresize(cdata, [HIGH WIDTH], '</span></span>lanczos3<span class="hljs-string"><span class="hljs-string">'); display(CC); if ( size( size(cdata), 2 ) &gt; 2 ) cdata = imadjust(rgb2gray(cdata)); end rects = segmentator(cdata, N_SYMB, 0); if SHOW_RECT imshow(cdata); for i = 1:length(rects) colors = {'</span></span><span class="hljs-string"><span class="hljs-string">r', '</span></span>y<span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-string"><span class="hljs-string">b', '</span></span>g<span class="hljs-string"><span class="hljs-string">', '</span></span>c<span class="hljs-string"><span class="hljs-string">', '</span></span>m<span class="hljs-string"><span class="hljs-string">'}; rectangle('</span></span>Position<span class="hljs-string"><span class="hljs-string">', rects{i}, '</span></span>EdgeColo<span class="hljs-string"><span class="hljs-string">r', colors{i}); end end if rects{1} == -1 continue; end %recognize recognized = zeros(1, N_SYMB); if length(rects) == N_SYMB for j = 1 : N_SYMB tim = imcrop(cdata, rects{j}); %resize image tim = imadjust(imresize(tim, [SYMB_H SYMB_W], '</span></span>lanczos3<span class="hljs-string"><span class="hljs-string">')); res = net(tim(:)); [sort_res, idx] = sort(res, '</span></span>descend<span class="hljs-string"><span class="hljs-string">'); recognized(j) = alphabet(idx(1)); end end correctSymbC = sum( (recognized - imName(1:6)) == 0); allSymbC = allSymbC + N_SYMB; if strcmp(recognized, imName(1:6)) correct = correct + 1; end if SHOW_RECT title(['</span></span>Recognize: <span class="hljs-string"><span class="hljs-string">' recognized]); end end fprintf('</span></span>CAPTCH precision <span class="hljs-keyword"><span class="hljs-keyword">is</span></span>: %<span class="hljs-number"><span class="hljs-number">2.2</span></span>f %%<span class="hljs-string"><span class="hljs-string">', 100 * correct / length(fileList)); fprintf('</span></span>Symbol precision: %<span class="hljs-number"><span class="hljs-number">2.2</span></span>f %%<span class="hljs-string"><span class="hljs-string">', 100 * correctSymbC / allSymbC);</span></span></code> </pre><br></div></div><br><br>  Recognition examples: <br><br><table><tbody><tr><td><img src="https://habrastorage.org/storage2/cd3/413/577/cd341357743a549893d0d69ba11454be.png"><br></td><td><img src="https://habrastorage.org/storage2/e2a/ec8/ee7/e2aec8ee769419eeeaa5bb3ef344ad5f.png"><br></td></tr><tr><td><img src="https://habrastorage.org/storage2/427/7c4/e3e/4277c4e3e7e72f6325b5b02ad2b3f186.png"><br></td><td><img src="https://habrastorage.org/storage2/6c8/303/6a8/6c83036a81e15563ac95b6bb710eb381.png"><br></td></tr><tr><td><img src="https://habrastorage.org/storage2/c83/156/178/c83156178f5752b9a08d5a2cd825430f.png"><br></td><td><img src="https://habrastorage.org/storage2/c0e/126/ab2/c0e126ab295f7c7dc7b0b838cd17ef45.png"><br></td></tr></tbody></table><br>  As a result, we obtained the following results: <br>  Number of correctly recognized captchas: 49.17% <br>  Number of characters recognized correctly: 87.02% <br><br><h3>  findings </h3><br>  As it turned out the captcha is not very complicated and is easily cracked.  For its complication, it is necessary to use more intersections of symbols, as well as their different number. <br>  To improve the current recognition quality, you can make the following improvements: <br><ul><li>  improve the segmentation algorithm (for example using a histogram) </li><li>  increase the training sample </li></ul><br><br>  If you liked the article, in the next one I can tell you in detail about the main approaches to the recognition of a human face. <br><br><h3>  Sample Tutorial Sources </h3><br>  <a href="">Sources</a>  <a href="">Dropbox</a> <br>  <a href="http://narod.ru/disk/64250468001.bf92f15eafee2f2d13b9a0b4830ac70a/HabrahabrCaptchReader.zip.html">Yandex People</a> </div><p>Source: <a href="https://habr.com/ru/post/161159/">https://habr.com/ru/post/161159/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161145/index.html">Fujitsu Storage Systems: ETERNUS Family</a></li>
<li><a href="../161151/index.html">Telecommunications cabinet or server rack (theory in practice)</a></li>
<li><a href="../161153/index.html">The search for products and services Lokata now on Windows 8</a></li>
<li><a href="../161155/index.html">Cycle splitting as an example of high-level optimization</a></li>
<li><a href="../161157/index.html">Animation of a sheet with sprites using steps ()</a></li>
<li><a href="../161161/index.html">Brussels Philharmonic plays music with Samsung GALAXY Note 10.1</a></li>
<li><a href="../161163/index.html">AWS Insight: How ELB Works</a></li>
<li><a href="../161171/index.html">Apple launches iTunes Store tomorrow in Russia</a></li>
<li><a href="../161173/index.html">Video review tablet Lenovo IdeaTab A2109</a></li>
<li><a href="../161177/index.html">With (unofficial) computer graphics day!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>