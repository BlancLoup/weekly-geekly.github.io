<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>POWA-like PostgreSQL Monitoring with Prometheus</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 


 We used the excellent POWA utility for a long time to collect and easily view data on how PostgreSQL works (overall server performance,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>POWA-like PostgreSQL Monitoring with Prometheus</h1><div class="post__text post__text-html js-mediator-article"><h2 id="predystoriya">  Prehistory </h2><br><p>  We used the excellent <a href="https://dalibo.github.io/powa/">POWA</a> utility for a long time to collect and easily view data on how PostgreSQL works (overall server performance, slowest queries, most frequent queries).  However, this solution was far from ideal and we managed to find a better option, moreover, fully integrated with our main monitoring system. </p><a name="habracut"></a><br><p>  POWA minimally satisfied most of our needs: </p><br><ul><li>  Easy to install and use (install the extension for Postgres, install the web muzzle, use it); </li><li>  It has a web interface (the developers do not have access to the production server, but we want to watch how the database behaves); </li><li>  Collects the minimum required for us metrics. </li></ul><br><p>  However, there were unpleasant cons: </p><br><ul><li>  It is inconvenient to watch data from multiple servers; </li><li>  The interface is not customizable; </li><li>  It is not possible to fasten (without pain) centralized authorization; </li><li>  There is no way to add your metrics; </li><li>  No integration with our monitoring system (we use Prometheus to collect metrics and Grafana to visualize them). </li></ul><br><p>  A couple of POWA screenshots for an example: </p><br><p><img src="https://habrastorage.org/webt/vo/cl/dq/vocldqlk0is8vnlatswlg_zjkjk.png"><br><img src="https://habrastorage.org/webt/4m/3t/ei/4m3teigrg3wxyiieogusmq__z1g.png"></p><br><p>  In this regard, it was decided to try to collect metrics from PostgreSQL using <a href="https://github.com/wrouesnel/postgres_exporter">postgres_exporter</a> for Prometheus. </p><br><h2 id="ustanovka">  Installation </h2><br><p>  TL; DR: here is the role for Ansible, was written under CentOS 7, but after minimal edits (replacing firewalld with iptables) should work on any system with systemd - <a href="https://github.com/UnitedTraders/ansible-postgresql-exporter">https://github.com/UnitedTraders/ansible-postgresql-exporter</a> </p><br><h3 id="arhitektura-resheniya">  Solution Architecture </h3><br><p>  I will not talk in detail about Prometheus itself, there is enough material about it, but I will go through the general architecture and the exporter. </p><br><p>  Prometheus uses the pull metrics collection model: he has a list of exporters and he polls them over HTTP, collecting a list of metrics from them and putting them into his store. </p><br><p>  An exporter is an agent that collects metrics directly from the entity (the server as a whole, or a specific application) that needs to be monitored.  Prometheus has rich possibilities for instrumentation, therefore, exporters are available for most popular applications, and it‚Äôs easy to write your own if necessary. </p><br><p>  postgres_exporter works as follows: it connects to PostgreSQL, performs queries to service tables, and exposes the results in a special format using an internal HTTP server to collect them by Prometheus.  An important point: in addition to a large set of default queries, you can define your own and collect any data that can be obtained using SQL, including some business metrics. </p><br><p>  Thus, setting postgres_exporter'a boils down to three actions: </p><br><ul><li>  Install postgres_exporter on the server that we want to monitor; </li><li>  Write requests (if needed) to monitor your settings; </li><li>  Show Prometheus server where to get metrics. </li></ul><br><h3 id="ustanovka-eksportera">  Exporter Installation </h3><br><p>  The exporter is written in Go, so everything is trivial: </p><br><ul><li>  Download the binary from <a href="https://github.com/wrouesnel/postgres_exporter/releases">https://github.com/wrouesnel/postgres_exporter/releases</a> </li><li> We define the environment variable in the env file <code>DATA_SOURCE_NAME="postgresql://postgres@localhost:5432/?sslmode=disable"</code> </li><li>  Create a systemd unit, such as this: </li></ul><br><pre> <code class="hljs ruby">[Unit] Description=Prometheus exporter <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Postgresql (<span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/wrouesnel</span></span><span class="hljs-regexp"><span class="hljs-regexp">/postgres_exporter) [Service] WorkingDirectory=/opt</span></span><span class="hljs-regexp"><span class="hljs-regexp">/postgres_exporter EnvironmentFile=/opt</span></span><span class="hljs-regexp"><span class="hljs-regexp">/postgres_exporter/env</span></span> ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/opt/postgres</span></span>_exporter/postgres_exporter_v<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">4.1_</span></span>linux-amd64/postgres_exporter --extend.query-path=<span class="hljs-regexp"><span class="hljs-regexp">/opt/postgres</span></span>_exporter/metrics.yaml --web.listen-address=<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">9187</span></span> User=pg_exporter [Install] WantedBy=multi-user.target</code> </pre> <br><ul><li>  Create a file with custom queries for your metrics (see below); </li><li>  We start the service. </li></ul><br><h3 id="nastroyka-svoih-metrik">  Customize your metrics </h3><br><p>  By default, postgres_exporter cannot collect data on requests.  But PostgreSQL has a very useful extension, <code>pg_stat_statements</code> , which is exactly what it does.  Installing pg_stat_statements comes down to three simple steps: </p><br><ul><li>  Install contrib modules for PostgreSQL; </li><li>  Add the post_gresql.conf parameter to <code>shared_preload_libraries = 'pg_stat_statements'</code> ; </li><li>  Create an extension in the postgrese itself: <code>CREATE EXTENSION pg_stat_statements</code> . </li></ul><br><p>  Since  it was important for us to collect the query execution time first, then the file with metrics turned out like this: </p><br><pre> <code class="hljs sql">pg_database: query: " <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pg_database.datname, pg_database_size(pg_database.datname) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_database<span class="hljs-string"><span class="hljs-string">" metrics: - datname: usage: "</span></span>LABEL<span class="hljs-string"><span class="hljs-string">" description: "</span></span><span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">database</span></span><span class="hljs-string"><span class="hljs-string">" - size: usage: "</span></span>GAUGE<span class="hljs-string"><span class="hljs-string">" description: "</span></span>Disk <span class="hljs-keyword"><span class="hljs-keyword">space</span></span> used <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">database</span></span><span class="hljs-string"><span class="hljs-string">" pg_stat_statements: query: "</span></span><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> queryid, datname, <span class="hljs-keyword"><span class="hljs-keyword">left</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">query</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> short_query, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(calls) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> calls, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(total_time) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> total_time, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(min_time) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> min_time, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(max_time) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> max_time, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(mean_time*calls)/<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(calls) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> mean_time <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_statements <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_database <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pg_stat_statements.dbid = pg_database.oid <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> queryid, short_query, datname<span class="hljs-string"><span class="hljs-string">" metrics: - queryid: usage: "</span></span>LABEL<span class="hljs-string"><span class="hljs-string">" description: "</span></span><span class="hljs-keyword"><span class="hljs-keyword">Query</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span><span class="hljs-string"><span class="hljs-string">" - datname: usage: "</span></span>LABEL<span class="hljs-string"><span class="hljs-string">" description: "</span></span><span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span><span class="hljs-string"><span class="hljs-string">" - short_query: usage: "</span></span>LABEL<span class="hljs-string"><span class="hljs-string">" description: "</span></span><span class="hljs-keyword"><span class="hljs-keyword">Query</span></span> limited <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> symbols<span class="hljs-string"><span class="hljs-string">" - calls: usage: "</span></span>COUNTER<span class="hljs-string"><span class="hljs-string">" description: "</span></span><span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> times executed<span class="hljs-string"><span class="hljs-string">" - total_time: usage: "</span></span>COUNTER<span class="hljs-string"><span class="hljs-string">" description: "</span></span>Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> milliseconds<span class="hljs-string"><span class="hljs-string">" - min_time: usage: "</span></span>GAUGE<span class="hljs-string"><span class="hljs-string">" description: "</span></span><span class="hljs-keyword"><span class="hljs-keyword">Minimum</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> milliseconds<span class="hljs-string"><span class="hljs-string">" - max_time: usage: "</span></span>GAUGE<span class="hljs-string"><span class="hljs-string">" description: "</span></span>Maximum <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> milliseconds<span class="hljs-string"><span class="hljs-string">" - mean_time: usage: "</span></span>GAUGE<span class="hljs-string"><span class="hljs-string">" description: "</span></span>Mean <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> milliseconds<span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre> <br><p>  There is one pitfall here: records from pg_stat_statements need to be aggregated, because  In this table there can be several records with the same combination of query id, database id and query.  The presence of such records leads to a fall in postgres_exporter, since  it forms the names of the metrics based on this data, and they must be unique. </p><br><p>  For simplicity, I did not add read / write metrics (shared_blks_written, etc., they are added by analogy).  Also, I repeat, similar queries can be made to any table, and not just to pg_stat_statements. </p><br><h3 id="primery-zaprosov-v-prometheus">  Prometheus Request Examples </h3><br><p>  With the above config, the exporter will generate a significant number of metrics - 5 pieces for each type of request.  We will aggregate them on the side of Prometheus. </p><br><p>  Examples of requests (immediately with graphan variables for templating): </p><br><ul><li>  <code>sum(rate(pg_stat_statements_mean_time{datname!~"template.*", datname!~"postgres", instance=~"$server"}[1m])) by (instance)</code> - the average time of the request for the last minute across the server </li><li>  <code>sum(rate(pg_stat_statements_mean_time{datname!~"template.*", datname!~"postgres", instance=~"$server", datname=~"$database"}[1m])) by (datname)</code> - average time request for the last minute on the selected database </li><li>  <code>sum(increase(pg_stat_statements_calls{datname!~"template.*", datname!~"postgres", instance=~"$server", datname=~"$database"}[1m])) by (datname)</code> - number of requests per minute to base </li><li>  <code>topk(20, increase(pg_stat_statements_calls{instance=~"$server", datname=~"$database"}[10m]))</code> - top-20 of the most frequent database queries in the last 10 minutes </li><li>  <code>topk(20, pg_stat_statements_mean_time{instance=~"$server", datname=~"$database"})</code> - top-20 longest queries to the database </li></ul><br><p>  In graphan, it looks like this ( <a href="">link</a> to json): </p><br><p><img src="https://habrastorage.org/webt/q0/bn/fr/q0bnfrpmjot92cpzg50b8c9-dqo.png"></p><br><p><img src="https://habrastorage.org/webt/z0/vn/tp/z0vntpw_ubstw7w8benh8p4dal0.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/345370/">https://habr.com/ru/post/345370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345358/index.html">Creating a Christmas animation with Wolfram Language</a></li>
<li><a href="../345362/index.html">Monte Carlo option premium calculation vs Black-Scholes formula</a></li>
<li><a href="../345364/index.html">We include support for TLS v1.3 in Nginx using the example of Debian 9</a></li>
<li><a href="../345366/index.html">Richard Hamming: "There are thoughts you can't think about"</a></li>
<li><a href="../345368/index.html">A selection of tutorials on AR / VR</a></li>
<li><a href="../345372/index.html">Dagger 2 for novice Android developers. Dagger 2. Advanced. Part 1</a></li>
<li><a href="../345374/index.html">Mikrotik RoS 6.41: Big Changes in Bridging and VLAN</a></li>
<li><a href="../345376/index.html">Study Tuples in C # 7</a></li>
<li><a href="../345380/index.html">The complete guide to Splash Screen on Android</a></li>
<li><a href="../345382/index.html">Symfony Flex Private Recipes: Creating, Customizing, and Using</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>