<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DCF77: how does the exact time signaling system work?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr. 

 Probably many who buy a clock or weather station, saw on the package logo Radio Controlled Clock or even Atomic Clock. This is very conven...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DCF77: how does the exact time signaling system work?</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr. <br><br>  Probably many who buy a clock or weather station, saw on the package logo Radio Controlled Clock or even Atomic Clock.  This is very convenient, because it is enough to put the clock on the table, and after some time they will automatically adjust to the exact time. <br><br><img src="https://habrastorage.org/webt/ev/vs/ia/evvsia3kcrvsnw_gxwoe_jen5r0.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's figure out how it works and write a decoder in Python. <br><a name="habracut"></a><br>  There are different time synchronization systems.  The most popular in Europe is the German <a href="https://en.wikipedia.org/wiki/DCF77">DCF-77 system</a> , Japan has its own <a href="https://en.wikipedia.org/wiki/JJY">JJY</a> system, the USA has the <a href="https://en.wikipedia.org/wiki/WWVB">WWVB</a> system, and so on.  Further, the story will be about DCF77, as the most relevant and accessible for reception in some places of the European part of Russia and neighboring countries (residents of the Far East may have the opposite opinion, although they, in turn, can receive and analyze the Japanese signal;). <br><br>  Everything written further will be about DCF77. <br><br><h2>  Receive signal </h2><br>  DCF77 is a long-wave station operating at 77.5 kHz and transmitting signals in amplitude modulation.  The station with a capacity of 50 kW is located 25 km from Frankfurt, it began work in 1959, in 1973 the date information was added to the exact time.  The wavelength at 77KHz is quite large, so the dimensions of the antenna field are also quite decent (photo from Wikipedia): <br><br><img src="https://habrastorage.org/webt/df/du/2l/dfdu2lbixopwvordolwij3w_ncs.png"><br><br>  With such an antenna and input power, the reception area covers almost the whole of Europe, Belarus, Ukraine and part of Russia. <br><br><img src="https://habrastorage.org/webt/my/xz/wu/myxzwuf8yjqunjcn5rah1f1oyry.png"><br><br>  Anyone can record a signal.  To do this, just go to the online receiver <a href="http://websdr.ewi.utwente.nl:8901/">http://websdr.ewi.utwente.nl:8901/</a> , select 76.5KHz frequency and USB modulation there.  A picture of something like this should open: <br><br><img src="https://habrastorage.org/webt/d4/yt/lc/d4ytlcfvkgf_7ea-vgytr-eljum.png"><br><br>  In the same place we press the download button and record a fragment of several minutes in length.  Of course, if you have a ‚Äúreal‚Äù receiver that can record a frequency of 77.5KHz, you can also use it. <br><br>  Of course, receiving accurate time radio signals via the Internet, we will not get really accurate time - the signal is transmitted with a delay.  But our goal is only to understand the structure of the signal, for this Internet recording is more than enough.  In real life, of course, specialized devices are used for receiving and decoding, which will be discussed below. <br><br>  So, we got a record, let's proceed to its processing. <br><br><h2>  Signal decoding </h2><br>  Load the file using Python and see its structure: <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> scipy.io <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wavfile <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> scipy <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> signal <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> matplotlib.pyplot <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> plt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np sample_rate, data = wavfile.read(<span class="hljs-string"><span class="hljs-string">"dcf_websdr_2019-03-26T20_25_34Z_76.6kHz.wav"</span></span>) plt.plot(data[:<span class="hljs-number"><span class="hljs-number">100000</span></span>]) plt.show()</code> </pre> <br>  We see typical amplitude modulation: <br><br><img src="https://habrastorage.org/webt/ls/ew/oz/lsewoz-zrzcjvpfcr4pbtnmbmva.png"><br><br>  To simplify decoding, let's take the signal envelope using the Hilbert transform: <br><br><pre> <code class="python hljs">analytic_signal = signal.hilbert(data) A = np.abs(analytic_signal) plt.plot(A[:<span class="hljs-number"><span class="hljs-number">100000</span></span>])</code> </pre> <br>  Result in an enlarged form: <br><br><img src="https://habrastorage.org/webt/ny/gn/ac/nygnacnm-kwcoba12j6vks-ixk0.png"><br><br>  Smooth out emissions from noise using a low-pass filter, at the same time we calculate the average value, it is useful later for parsing. <br><br><pre> <code class="python hljs">b, a = signal.butter(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>/sample_rate) zi = signal.lfilter_zi(b, a) A, _ = signal.lfilter(b, a, A, zi=zi*A[<span class="hljs-number"><span class="hljs-number">0</span></span>]) avg = (np.amax(A) + np.amin(A))/<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Result (yellow line): almost square wave, which is fairly easy to analyze. <br><br><img src="https://habrastorage.org/webt/fa/yp/wn/faypwn97babbqqgosvekm7eys90.png"><br><br><h2>  Parsing </h2><br>  First you need to get a bit sequence.  The structure of the signal itself is very simple. <br><br><img src="https://habrastorage.org/webt/hm/hy/s5/hmhys54d9zic5a6ltn7e32oyklg.png"><br><br>  The pulses are divided into second intervals.  If the distance between pulses is 0.1 s (i.e., the length of the pulse itself is 0.9 s), add ‚Äú0‚Äù to the bit sequence, if the distance is 0.2 s (ie, length 0.8 s), add ‚Äú1‚Äù.  The end of each minute is indicated by a ‚Äúlong‚Äù pulse, 2s long, the bit sequence is reset to zero, and the filling starts anew. <br><br>  The above is easy to write in Python. <br><br><pre> <code class="python hljs">sig_start, sig_stop = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> pos = <span class="hljs-number"><span class="hljs-number">0</span></span> bits_str = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> pos &lt; cnt - <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> A[pos] &lt; avg <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> A[pos+<span class="hljs-number"><span class="hljs-number">1</span></span>] &gt; avg: <span class="hljs-comment"><span class="hljs-comment"># Signal begin sig_start = pos if A[pos] &gt; avg and A[pos+1] &lt; avg: # Signal end sig_stop = pos diff = sig_stop - sig_start if diff &lt; 0.85*sample_rate: bits_str += "1" if diff &gt; 0.85*sample_rate and diff &lt; 1.25*sample_rate: bits_str += "0" if diff &gt; 1.5*sample_rate: print(bits_str) bits_str = "" pos += 1</span></span></code> </pre><br>  As a result, we get a sequence of bits, in our example for two minutes it looks like this: <br><br> <code>0011110110111000001011000001010000100110010101100010011000 <br> 0001111100110110001010100001010000100110010101100010011000</code> <br> <br>  By the way, it is interesting that there is a ‚Äúsecond layer‚Äù of data in the signal.  The bit sequence is also encoded with <a href="https://en.wikipedia.org/wiki/DCF77">phase modulation</a> .  In theory, this should provide more robust decoding even in the case of a weak signal. <br><br>  Our last step: get the actual data.  Bits are transmitted once per second, so we have only 59 bits in which a lot of information is encoded: <br><br><img src="https://habrastorage.org/webt/e2/r1/le/e2r1le0xrrrgenjxxlpmwo5h3v0.png"><br><br>  Bits are described in <a href="https://en.wikipedia.org/wiki/DCF77">Wikipedia</a> , and they are quite curious.  The first 15 bits are not used, although there were plans to use for warning systems <s>and civil defense</s> .  Bit A1 indicates that in the next hour the clock will be switched to daylight saving time.  Bit A2 indicates that an <a href="https://en.wikipedia.org/wiki/Leap_second">extra second</a> will be added in the next hour, which is sometimes used to correct the time according to the rotation of the Earth.  The remaining bits encode the hours, minutes and date. <br><br><img src="https://habrastorage.org/webt/fh/ti/oj/fhtiojtscjytfzu1rk4a_0yt4pw.png"><br><br>  For those who want to experiment on their own, the code for decoding is given under the spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bits)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> bits[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'0'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> bits[<span class="hljs-number"><span class="hljs-number">20</span></span>] != <span class="hljs-string"><span class="hljs-string">'1'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> minutes, hours, day_of_month, weekday, month, year = map(convert_block, (bits[<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">28</span></span>], bits[<span class="hljs-number"><span class="hljs-number">29</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>], bits[<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>], bits[<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>], bits[<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>], bits[<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>])) days = (<span class="hljs-string"><span class="hljs-string">'Sunday'</span></span>, <span class="hljs-string"><span class="hljs-string">'Monday'</span></span>, <span class="hljs-string"><span class="hljs-string">'Tuesday'</span></span>, <span class="hljs-string"><span class="hljs-string">'Wednesday'</span></span>, <span class="hljs-string"><span class="hljs-string">'Thursday'</span></span>, <span class="hljs-string"><span class="hljs-string">'Friday'</span></span>, <span class="hljs-string"><span class="hljs-string">'Saturday'</span></span>, <span class="hljs-string"><span class="hljs-string">'Sunday'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'{dow}, {dom:02}.{mon:02}.{y}, {h:02}:{m:02}'</span></span>.format(h=hours, m=minutes, dow=days[weekday], dom=day_of_month, mon=month, y=year)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convert_ones</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bits)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum(<span class="hljs-number"><span class="hljs-number">2</span></span>**i <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, bit <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(bits) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> bit == <span class="hljs-string"><span class="hljs-string">'1'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convert_tens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bits)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>*convert_ones(bits) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">right_parity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bits, parity_bit)</span></span></span><span class="hljs-function">:</span></span> num_of_ones = sum(int(bit) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> bit <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bits) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> num_of_ones % <span class="hljs-number"><span class="hljs-number">2</span></span> == int(parity_bit) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convert_block</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bits, parity=False)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> parity <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> right_parity(bits[:<span class="hljs-number"><span class="hljs-number">-1</span></span>], bits[<span class="hljs-number"><span class="hljs-number">-1</span></span>]): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> ones = bits[:<span class="hljs-number"><span class="hljs-number">4</span></span>] tens = bits[<span class="hljs-number"><span class="hljs-number">4</span></span>:] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> convert_tens(tens) + convert_ones(ones)</code> </pre><br></div></div><br>  Running the program, we will see something like this: <br><br> <code>0011110110111000001011000001010000100110010101100010011000 <br> Tuesday, 26.03.19, 21:41 <br> 0001111100110110001010100001010000100110010101100010011000 <br> Tuesday, 26.03.19, 21:42</code> <br> <br>  Actually, that's all the magic.  The advantage of such a system is that decoding is extremely simple, and can be done on any, very simple microcontroller.  Just count the length of the pulses, accumulate 60 bits, and at the end of each minute we get the exact time.  Compared to other time synchronization methods (GPS, for example, or, God forbid, the Internet :), this radio synchronization practically does not require electricity - for example, an ordinary home weather station works for about a year with 2 AA batteries.  Therefore, even watches are made with radio synchronization, not to mention, of course, wall or street stations. <br><br>  Convenience and simplicity DCF attract homemade lovers.  For only $ 10-20, you can buy a ready-made module from an antenna with a ready-made receiver and a TTL output that can be connected to an Arduino or another controller. <br><br><img src="https://habrastorage.org/webt/po/ph/mk/pophmk5x_xmgb3dzozwu34sbxya.png"><br><br>  For Arduino already written and <a href="https://github.com/udoklein/dcf77">ready libraries</a> .  However, and so it is known - whatever you do on the microcontroller, you get either a clock or a weather station.  With such a device to get the exact time is really easy, if of course be in the reception area.  Well, you can hang the inscription "Atomic Clock" on the clock, and at the same time explain to everyone that the device is actually synchronized using an atomic clock. <br><br>  Those interested can even upgrade the old grandmother's clock by installing a new mechanism with radio synchronization in them: <br><br><img src="https://habrastorage.org/webt/om/5w/2k/om5w2k-nno2ueo5tpxk6pkrrpls.png"><br><br>  You can find one on ebay using the keywords "Radio Controlled Movement." <br><br>  And finally, a life hack for those who read this far.  Even if in the next couple of thousands of kilometers there is not a single radio signal transmitter, it‚Äôs easy to generate such a signal yourself.  On Google Play, there is a program called ‚ÄúDCF77 Emulator‚Äù that outputs the signal to the headphones.  According to the author, if you wind the headphone wire around the clock, they will catch the signal (I wonder how, because ordinary headphones will not give out a 77KHz signal, but probably reception comes at the expense of harmonics).  The program did not work on my Android 9 at all - there was simply no sound (or maybe I didn‚Äôt hear it - 77KHz, after all :), but maybe someone will have better luck.  Some, however, make themselves a full-fledged DCF signal generator, which is easy to do on the same Arduino or ESP32: <br><br><img src="https://habrastorage.org/webt/vs/ye/jk/vsyejk6pr6mxfymg55fqscbzn1i.png"><br>  (source <a href="https://sgfantasytoys.wordpress.com/2015/05/13/synchronize-radio-controlled-watch-without-access/">sgfantasytoys.wordpress.com/2015/05/13/synchronize-radio-controlled-watch-without-access</a> ) <br><br><h2>  Conclusion </h2><br>  The DCF system turned out to be really quite simple and convenient.  With a simple and cheap receiver, you can have the exact time anytime, anywhere, of course in the reception area.  It seems that even despite the widespread digitalization and the ‚ÄúInternet of things‚Äù, such simple solutions will be in demand for a long time. </div><p>Source: <a href="https://habr.com/ru/post/445470/">https://habr.com/ru/post/445470/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445456/index.html">Search at a speed of 1 TB / s</a></li>
<li><a href="../445458/index.html">Electronic Arts will deal with 350 employees and "reduce presence" in Russia</a></li>
<li><a href="../445460/index.html">Interactivity without gadgets</a></li>
<li><a href="../445464/index.html">Reducing the sample size of experimental data without losing information</a></li>
<li><a href="../445468/index.html">Team from Russia ranked third in the Imagine Cup competition in Europe, Africa and the Middle East</a></li>
<li><a href="../445472/index.html">The decision on YouTube is made, censored to be! and as always, Russia didn‚Äôt do without</a></li>
<li><a href="../445474/index.html">MODX Digest # 2.1 (March 11 - March 25, 2019)</a></li>
<li><a href="../445478/index.html">The European Parliament still adopted amendments to EU copyright law</a></li>
<li><a href="../445480/index.html">Mat elephant and horse. Deletana Triangles</a></li>
<li><a href="../445486/index.html">Compare yandex and mail: student experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>