<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reflections on the implementation of the social graph</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 We are all accustomed to using social networks. One of their foundations is the establishment of socially significant links between users. A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reflections on the implementation of the social graph</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  We are all accustomed to using social networks.  One of their foundations is the establishment of socially significant links between users.  As a rule, these connections are friendship or fans (followers). <br><br>  I don‚Äôt know what I‚Äôve found on me, but after returning from school (I work as a teacher) I decided to try to create something on my favorite rails that could help me to realize the functionality of a social graph on the school website.  And I decided not to limit myself to two types of connections. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's try to fantasize about the social graph and write some Rails code. <br><br><a name="habracut"></a><br><br>  Some time ago I had to deal with the implementation of social connections in ROR projects several times.  In the first case, it was a project in which friendship was realized between the participants, in the second they created follower-type communications.  Both projects are commercial - I don‚Äôt name them.  Excuse me. <br><br>  The general essence was that a connection was created with a name similar to <b>Friendship</b> in which there were 2 user identifiers and the state of this connection.  <b>pending</b> - a friend request has been submitted and is awaiting confirmation, <b>accepted</b> - the request is confirmed and active, <b>rejected</b> - the application is rejected, <b>deleted</b> - the connection has been deleted. <br><br>  In addition, I noticed that usually when creating a connection from one person No. 1 to person No. 2 (in those implementations I saw) <b>, a second twin connection is created</b> , which differs only in that the users id are swapped.  The status of the twin is copied from the original with each change.  This approach is understandable - the selection of links for a specific user is carried out by a single query to the database.  However, you need an additional entry in the database and ensuring control of the change in the status of the entry. <br><br>  Looking ahead, I will say that I decided in my version of the code not to produce records and went the way of submitting 2 queries to the database. <br><br><h4>  The world is more complicated than it is displayed on social networks </h4><br><br>  In large projects there is not a large number of links.  Why?  I dont know.  Perhaps the human psyche is not yet ready for this, but ... In a private conversation with one of my former teachers from a local university, the thought slipped through: <b>connections between people are more complicated than it is represented in networks</b> .  There are teachers and students, chiefs and subordinates, officers and their soldiers, site administrators, and users, parents and children, and so on, and so forth. <br><br>  Did you notice?  Often the roles of people in the relationship are not equal, it is not easy for you - friends.  Everything is a little more complicated. <br><br>  Also, as a rule, social connection has a context (life, work, army, school) - i.e.  the place where this connection was established. <br><br>  What I don't like on social networks now?  So this is what adding friends as casual acquaintances or people you only know in person, and then removing them from your ‚Äútrack record‚Äù during an audit ( <s>bad mood</s> ) sometimes has to be explained - they say I'm sorry, <b>you are not the enemy to me and I personally have nothing against you</b> - but <b>I don‚Äôt want</b> to keep you on ‚Äúfriends‚Äù anymore - we haven‚Äôt seen each other for several years ( <s>and I don‚Äôt even remember your name</s> ) - sorry, but I don‚Äôt see much point. <br><br>  This I lead to the fact that it would be great if in the social.  Networks have been provided for different options - an acquaintance, a sports trainer, my grandmother, a classmate from school, a <s>drinking companion</s> , a colleague from work, a chef, a head of a department, etc. <br><br>  Spending 45 minutes on Rails 3, I tried to build up a prototype of what unexpectedly agitated my sore teacher mind. <br><br><h4>  Model </h4><br><br>  The model (I will call it Graph) contains 2 id users (the applicant and the recipient), the status of the application, the role of the sender and the role of the recipient, as well as the context of social connection. <br><pre><code class="ruby hljs">rails g model graph <span class="hljs-symbol"><span class="hljs-symbol">context:</span></span>string <span class="hljs-symbol"><span class="hljs-symbol">sender_id:</span></span>integer <span class="hljs-symbol"><span class="hljs-symbol">sender_role:</span></span>string <span class="hljs-symbol"><span class="hljs-symbol">recipient_id:</span></span>integer <span class="hljs-symbol"><span class="hljs-symbol">recipient_role:</span></span>string <span class="hljs-symbol"><span class="hljs-symbol">state:</span></span>string</code> </pre> <br><br>  What gives the following migration: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateGraphs</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Migration </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">up</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create_table</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">graphs</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">integer</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_role</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">integer</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_role</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timestamps</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">down</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drop_table</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">graphs</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br>  Run in console: <br><pre> <code class="ruby hljs">rake <span class="hljs-symbol"><span class="hljs-symbol">db:</span></span>migrate</code> </pre> <br>  That will create for us in a DB the necessary table with the set fields. <br><br>  In the <b>Graph</b> model file itself, I determined by the <b>state machine</b> what states the graph element can accept, and the <b>scope</b> will allow me to supplement the database queries with the necessary conditions. <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Graph</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pending</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pending</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">accepted</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">accepted</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rejected</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rejected</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleted</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleted</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#state pending, accepted, rejected, deleted state_machine :state, :initial =&gt; :pending do event :accept do transition :pending =&gt; :accepted end event :reject do transition :pending =&gt; :rejected end event :delete do transition all =&gt; :deleted end event :initial do transition all =&gt; :pending end end end</span></span></span></span></code> </pre><br><br>  In the User model (it is, in any <b>case</b> , in every Rails App), I will first add a method: <b>graph_to</b> , which will return me a graph element to this user (if the graph element exists) or simply create a new element. <br><br>  The graph element I build from the current user to another user, in some context, where I am someone and the recipient is also someone (according to predefined roles). <br>  By default, the context is life, and users have roles ‚Äî a friend. <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">graph_to</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">another_user</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">={:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">=&gt;:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">live</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">me_as</span></span></span><span class="hljs-class">=&gt;:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">friend</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">him_as</span></span></span><span class="hljs-class">=&gt;:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">friend</span></span></span><span class="hljs-class">}) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Graph</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_id</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_role</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">me_as</span></span></span><span class="hljs-class">], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_id</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">another_user</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_role</span></span></span><span class="hljs-class">=&gt;[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">him_as</span></span></span><span class="hljs-class">]).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class"> || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">graphs</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">( :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_role</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">me_as</span></span></span><span class="hljs-class">], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_id</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">another_user</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_role</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">him_as</span></span></span><span class="hljs-class">]) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br>  Experiments will require a lot of user relationship records.  Therefore, I created a rake, which from the console allows me to create several dozen users and establish random connections between them. <br><br>  I explain for those who can not read ruby. <br><ul><li>  The code creates users </li><li>  Relationship contexts are established. </li><li>  User roles are set for each context. </li><li>  Applications are randomly submitted and applications receive a status as well </li></ul><br><pre> <code class="ruby hljs">namespace <span class="hljs-symbol"><span class="hljs-symbol">:db</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> namespace <span class="hljs-symbol"><span class="hljs-symbol">:graphs</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment"># rake db:graphs:create desc 'create graphs for development' task :create =&gt; :environment do i = 1 puts 'Test users creating' 100.times do |i| u = User.new( :login =&gt; "user#{i}", :email =&gt; "test-user#{i}</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ya</span></span></span><span class="hljs-comment">.ru", :name=&gt;"User Number #{i}", :password=&gt;'qwerty', :password_confirmation=&gt;'qwerty' ) u.save puts "test user #{i} created" i = i.next end#n.times puts 'Test users created' contexts = [:live, :web, :school, :job, :military, :family] roles={ :live=&gt;[:friend,:friend], :web=&gt;[:moderator, :user], :school=&gt;[:teacher, :student], :job=&gt;[:chief, :worker], :military=&gt;[:officer, :soldier], :family=&gt;[:child, :parent] } users = User.where("id &gt; 10 and id &lt; 80") #70 users test_count = 4000 test_count.times do |i| sender = users[rand(69)] recipient = users[rand(69)] context = contexts.rand # :job role = roles[context].shuffle # [:worker, :chif] # trace p "test graph #{i}/#{test_count} " + sender.class.to_s+" to "+recipient.class.to_s + " with context: " + context.to_s graph = sender.graph_to(recipient, :context=&gt;context, :me_as=&gt;role.first, :him_as=&gt;role.last) graph.save # set graph state reaction = [:accept, :reject, :delete, :initial].rand graph.send(reaction) end# n.times end# db:graphs:create end#:graphs end#:db</span></span></code> </pre><br><br><h4>  Inverted Graph Elements </h4><br>  Since I said earlier that I didn‚Äôt want to create a twin record for each social link this time, I‚Äôll have to take every link both in the forward and in the opposite direction. <br><br>  I will do this by adding lines to the User model: <br><pre> <code class="ruby hljs">has_many <span class="hljs-symbol"><span class="hljs-symbol">:graphs</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:foreign_key=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:sender_id</span></span> has_many <span class="hljs-symbol"><span class="hljs-symbol">:inverted_graphs</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:class_name</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Graph'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:foreign_key=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:recipient_id</span></span></code> </pre><br>  Each user has many direct links (where he is the initiator of the link), and reverse, where he is the recipient of the request for a social link.  These elements differ only in different foreign keys. <br><br>  In order to select all the social links of a given user, I will have to select all of his direct and feedback links, and then combine the arrays of records.  For example, to select all the added superiors from my work, you need to write something like the following: <br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accepted_chiefs_from_job</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chiefs</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">graphs</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accepted</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">where</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:context</span></span></span></span><span class="hljs-function"><span class="hljs-params"> =&gt; </span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:job</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:recipient_role=&gt;</span></span></span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:chief</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment"># my graphs _chiefs = inverted_graphs.accepted.where(:context =&gt; :job, :sender_role=&gt;:chief) # foreign graphs chiefs | _chiefs end</span></span></code> </pre><br>  Operator |  is an operator to combine arrays.  For me, so very beautiful. <br><br><h4>  Some meta programming and ruby ‚Äã‚Äãmagic </h4><br>  I have a lot of contexts and user roles in relationships.  I need a lot of methods similar to the above method <b>accepted_chiefs_from_job</b> which selects all my superiors from work, whom I agreed to add.  <b>You do not think to write them in hand?</b> <br>  We use meta-programming, so that Ruby himself creates the necessary methods for us and makes the appropriate samples.  The magic method <b>method_missing (method_name, * args)</b> will help in this.  This method is called when Ruby does not find any method.  It is here that we will explain to him what needs to be done in the case when he encounters an attempt to fetch data from the graph. <br><br>  Ruby himself will create methods like these: <br><pre> <code class="ruby hljs">user.accepted_friends_from_live user.rejected_friends_from_live user.deleted_friends_from_live user.deleted_chiefs_from_job user.accepted_chiefs_from_job user.rejected_chiefs_from_job user.accepted_teachers_from_school user.deleted_teachers_from_school</code> </pre><br><br>  Add the following to the User model: <br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">method_missing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(method_name, *args)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> /^(.*)<span class="hljs-number"><span class="hljs-number">_</span></span>(.*)_from<span class="hljs-number"><span class="hljs-number">_</span></span>(.*)$/.match(method_name.to_s) match = $~ state = match[<span class="hljs-number"><span class="hljs-number">1</span></span>].to_sym role = match[<span class="hljs-number"><span class="hljs-number">2</span></span>].singularize.to_sym context = match[<span class="hljs-number"><span class="hljs-number">3</span></span>].to_sym graphs.send(state).where(<span class="hljs-symbol"><span class="hljs-symbol">:context</span></span> =&gt; context, <span class="hljs-symbol"><span class="hljs-symbol">:recipient_role=&gt;role</span></span>) <span class="hljs-params"><span class="hljs-params">| inverted_graphs.send(state).where(:context =&gt; context, :sender_role=&gt;role) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">else</span></span></span><span class="hljs-params"> </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span><span class="hljs-params"> </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br><br>  If <b>method_missing (method_name, * args)</b> does not find any method, then it will try to parse it on a regular basis.  If the regulars match the name of the methods of our graph, then Ruby will compose the query on the data obtained from the string and return the result.  If the callable method does not fit the regular <b>schedule</b> , then <b>method_missing (method_name, * args)</b> will simply go to its standard behavior, <b>super</b> , and will probably give a code execution error. <br><br>  Summary User Code: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pages</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">graphs</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreign_key</span></span></span><span class="hljs-class">=&gt;:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inverted_graphs</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class_name</span></span></span><span class="hljs-class"> =&gt; '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Graph</span></span></span><span class="hljs-class">', :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreign_key</span></span></span><span class="hljs-class">=&gt;:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_missing</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_name</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> /^(.*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_</span></span></span><span class="hljs-class">(.*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_from_</span></span></span><span class="hljs-class">(.*)$/.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_name</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class"> = $~ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class">[1].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_sym</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">role</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class">[2].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">singularize</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_sym</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class">[3].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_sym</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">graphs</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_role</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">role</span></span></span><span class="hljs-class">) | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inverted_graphs</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_role</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">role</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">else</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">super</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">graph_to</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">another_user</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">={:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">=&gt;:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">live</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">me_as</span></span></span><span class="hljs-class">=&gt;:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">friend</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">him_as</span></span></span><span class="hljs-class">=&gt;:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">friend</span></span></span><span class="hljs-class">}) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Graph</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_id</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_role</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">me_as</span></span></span><span class="hljs-class">], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_id</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">another_user</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_role</span></span></span><span class="hljs-class">=&gt;[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">him_as</span></span></span><span class="hljs-class">]).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class"> || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">graphs</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">( :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_role</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">me_as</span></span></span><span class="hljs-class">], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_id</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">another_user</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_role</span></span></span><span class="hljs-class">=&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">him_as</span></span></span><span class="hljs-class">]) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><h4>  Well that's all </h4><br>  Now perform the rake: <br><pre> <code class="ruby hljs">rake <span class="hljs-symbol"><span class="hljs-symbol">db:</span></span><span class="hljs-symbol"><span class="hljs-symbol">graphs:</span></span>create</code> </pre> <br>  Run rails console <br><pre> <code class="ruby hljs">rails c</code> </pre> <br>  We try to perform: <br><pre> <code class="ruby hljs">u = User.find(<span class="hljs-number"><span class="hljs-number">10</span></span>) u.graph_to(User.first, <span class="hljs-symbol"><span class="hljs-symbol">:context=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:job</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:me_as=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:boss</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:him_as=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:staff_member</span></span>) u.graph_to(User.last, <span class="hljs-symbol"><span class="hljs-symbol">:context=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:school</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:me_as=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:student</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:him_as=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:teacher</span></span>) u.graph_to(User.find(<span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-symbol"><span class="hljs-symbol">:context=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:school</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:me_as=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:student</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:him_as=&gt;</span></span><span class="hljs-symbol"><span class="hljs-symbol">:school</span></span>) u.accepted_friends_from_live u.rejected_friends_from_live u.deleted_friends_from_live u.deleted_chiefs_from_job u.accepted_chiefs_from_job u.rejected_chiefs_from_job</code> </pre><br><br>  PS: <br>  Applied programmers respect and wish good luck from the school teacher! </div><p>Source: <a href="https://habr.com/ru/post/112221/">https://habr.com/ru/post/112221/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112208/index.html">Quest do it yourself</a></li>
<li><a href="../112210/index.html">Names for metavariables</a></li>
<li><a href="../112215/index.html">Windows Phone 7 Games Review (Part 1)</a></li>
<li><a href="../112216/index.html">Simple things with difficult AppEngine</a></li>
<li><a href="../112217/index.html">The book "Branding and identification of the present and the future"</a></li>
<li><a href="../112222/index.html">Data structures: binary heap</a></li>
<li><a href="../112227/index.html">Weekday cloud development, part one</a></li>
<li><a href="../112229/index.html">The amendment to allow free copying of books for libraries really gave a red light</a></li>
<li><a href="../112230/index.html">Search Trends at Euronews</a></li>
<li><a href="../112232/index.html">Americans bought 15% of Kaspersky Lab shares</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>