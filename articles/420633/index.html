<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write GeoIP exporter for Prometheus with visualizations in Grafana in 15 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to all! 


 I want to share with you how easy it is to write my exporter for Prometheus at Golang and show how this can be done using the exampl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write GeoIP exporter for Prometheus with visualizations in Grafana in 15 minutes</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/gq/e3/ss/gqe3ssl-nxvojbk1gnvm794kihi.png"></p><br><p>  Hello to all! </p><br><p>  I want to share with you how easy it is to write my exporter for Prometheus at Golang and show how this can be done using the example of a small program that keeps track of where the current TCP connections are geographically established. </p><a name="habracut"></a><br><h1 id="0-disclaimer">  0. Disclaimer </h1><br><p>  I would like right at the very beginning to outline, so to speak, the <em>scope of</em> this publication and say about what it <em>does not</em> tell, so that later there are no questions: </p><br><ul><li>  Yes, this is not <em>customer</em> visualization.  This is a visualization of <em>remote connections</em> .  That is, it does not divide connections into those in which the connection was initiated by the remote server and those that were initiated by this machine, and will show everything on the map - for example, the server with the repository, where updates are now being downloaded to your machine. </li><li>  Yes, I understand that there are anonymization tools on the network that hide the real client IP.  The purpose of this tool is not to identify the exact GPS coordinates of any client, but to have at least a general idea of ‚Äã‚Äãtheir geography. </li><li>  whois provides information more accurate than the country of the IP address, but here I was bound by the limit of the plugin for Grafan, which only renders countries, but not cities. </li></ul><br><h1 id="1-pishem-back-end-eksporter-na-go">  1. We write "back-end": exporter on go </h1><br><p>  So, the first thing we need to do is to write an exporter, which will actually collect data from our server and give it to Prometheus.  The choice of languages ‚Äã‚Äãhere is great: Prometheus has <a href="https://prometheus.io/docs/instrumenting/clientlibs/">client libraries</a> for writing exporters in many popular languages, but I chose Go, firstly, because it is so "more native" (since Prometheus itself is written on it), well, secondly, since I use in my DevOps practice. </p><br><p>  Well, pretty lyrics, let's get down to the code.  Let's start writing "from the bottom up": first, functions for determining the country by IP and the list of remote IP addresses itself, and then sending all this to Prometheus. </p><br><h2 id="11-opredelyaem-stranu-po-ip-adresu">  1.1.  We determine the country by IP address </h2><br><p> Well, there‚Äôs absolutely everything in the forehead, I didn‚Äôt become philosophical and just used the service <a href="https://freegeoip.net/">freegeoip.net</a> , whose API at the time of writing this article has already become deprecated, and now they offer to register for free and be able to make 10,000 requests per month (which is enough ).  Everything is simple: there is an endpoint of the form <code>http://api.ipstack.com/&lt;IP&gt;?access_key=&lt;API_KEY&gt;</code> , which simply returns json to us with the field <code>country_code</code> we need - this is all that we need for visualization. <br>  So, we will write a package for pulling the country by IP. </p><br><div class="spoiler">  <b class="spoiler_title">We import the necessary ones and create a structure into which the received json object will be 'unpacked'.</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Package geo implements function for searching // for a country code by IP address. package geo import ( "encoding/json" "fmt" "io/ioutil" "net/http" ) // Type GeoIP stores whois info. type GeoIP struct { Ip string `json:""` CountryCode string `json:"country_code"` CountryName string `json:""` RegionCode string `json:"region_code"` RegionName string `json:"region_name"` City string `json:"city"` Zipcode string `json:"zipcode"` Lat float32 `json:"latitude"` Lon float32 `json:"longitude"` MetroCode int `json:"metro_code"` AreaCode int `json:"area_code"` }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">... and the function itself, which will return us the country code.</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Function GetCode returns country code by IP address. func GetCode(address string) (string, error) { response, err = http.Get("http://api.ipstack.com/" + address + "?access_key=&lt;API_KEY&gt;&amp;format=1&amp;legacy=1") if err != nil { fmt.Println(err) return "", err } defer response.Body.Close() body, err = ioutil.ReadAll(response.Body) if err != nil { fmt.Println(err) return "", err } err = json.Unmarshal(body, &amp;geo) if err != nil { fmt.Println(err) return "", err } return geo.CountryCode, nil }</span></span></code> </pre> </div></div><br><p>  Pay attention to the <code>legacy=1</code> parameter; I have to use it for backward compatibility;  you, of course, if you use their API, use the latest version. </p><br><h2 id="12-formiruem-spisok-tcp-soedineniy">  1.2.  Creating a list of TCP connections </h2><br><p>  Here, use the <code>github.com/shirou/gopsutil/net</code> package and filter the connections with <code>ESTABLISHED</code> status, excluding local IP addresses and addresses from the custom blacklist, which can be sent to the exporter at launch (for example, to exclude all your own public IP addresses) </p><br><div class="spoiler">  <b class="spoiler_title">Package with function returning map [string] int: number of connections from the country.</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Package conn implements function for collecting // active TCP connections. package conn import ( "log" "github.com/gree-gorey/geoip-exporter/pkg/geo" "github.com/shirou/gopsutil/net" ) // Type Connections stores map of active connections: country code -&gt; number of connections. type Connections struct { ConnectionsByCode map[string]int `json:"connections_by_code"` } // Function RunJob retrieves active TCP connections. func (c *Connections) RunJob(p *Params) { if p.UseWg { defer p.Wg.Done() } c.GetActiveConnections(p.BlackList) } // Function GetActiveConnections retrieves active TCP connections. func (c *Connections) GetActiveConnections(blackList map[string]bool) { cs, err := net.Connections("tcp") if err != nil { log.Println(err) } c.ConnectionsByCode = make(map[string]int) for _, conn := range cs { if _, ok := blackList[conn.Raddr.IP]; !ok &amp;&amp; (conn.Status == "ESTABLISHED") &amp;&amp; (conn.Raddr.IP != "127.0.0.1") { code, err := geo.GetCode(conn.Raddr.IP) if code != "" &amp;&amp; err == nil { _, ok := c.ConnectionsByCode[code] if ok == true { c.ConnectionsByCode[code] += 1 } else { c.ConnectionsByCode[code] = 1 } } } } }</span></span></code> </pre> </div></div><br><h2 id="13-i-nakonec-otpravlyaem-vse-v-prometheus">  1.3.  And finally, send everything to Prometheus </h2><br><p>  More precisely, he will take everything.  Just listen to the port and give it collected metrics. <br>  Using <code>github.com/prometheus/client_golang/prometheus</code> we create a <code>Gauge</code> type metric.  In fact, it was possible to create a <code>Counter</code> , just later we would use the <code>rate</code> when querying the database.  Perhaps the latter, from the point of view of Prometheus, is more effective, but while I was writing this exporter (six months ago) I was just starting to get acquainted with Prometheus and for me <code>Gauge</code> was enough: </p><br><pre> <code class="go hljs">location = prometheus.NewGaugeVec( prometheus.GaugeOpts{ Name: <span class="hljs-string"><span class="hljs-string">"job_location"</span></span>, Help: <span class="hljs-string"><span class="hljs-string">"Location connections number"</span></span>, }, []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{<span class="hljs-string"><span class="hljs-string">"location"</span></span>}, )</code> </pre> <br><p>  By collecting metrics using the preceding paragraphs, we update our vector: </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> code, number := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> c.ConnectionsByCode { location.With(prometheus.Labels{<span class="hljs-string"><span class="hljs-string">"location"</span></span>: code}).Set(<span class="hljs-keyword"><span class="hljs-keyword">float64</span></span>(number)) }</code> </pre> <br><p>  We start all this with an infinite loop in a separate gorutin, and in the main one we simply bind the port and wait for our metrics to be taken by Prometheus: </p><br><pre> <code class="go hljs">prometheus.MustRegister(location) http.Handle(<span class="hljs-string"><span class="hljs-string">"/metrics"</span></span>, prometheus.Handler()) log.Fatal(http.ListenAndServe(*addr, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>))</code> </pre> <br><p>  Actually, all the code can be viewed in the <a href="https://github.com/gree-gorey/geoip-exporter">repository on GitHub</a> , I do not want to copy-paste everything here. </p><br><h1 id="2-front-end-grafana">  2. "Front-end": Grafana </h1><br><p>  But for a start, of course, you need to tell Prometheus to collect our metrics: </p><br><pre> <code class="hljs 1c"> - job_name: 'GeoIPExporter' scrape_interval: <span class="hljs-number"><span class="hljs-number">10</span></span>s static_configs: - targets: ['127.0.0.1:<span class="hljs-number"><span class="hljs-number">9300</span></span>']</code> </pre> <br><p>  (or using service discovery, if you, for example, Kubernetes).  Prometheus can be forced to re-read the config by sending a <code>HUP</code> signal to it: </p><br><pre> <code class="hljs matlab">$ pgrep <span class="hljs-string"><span class="hljs-string">"^prometheus$"</span></span> | xargs -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> kill -HUP {}</code> </pre> <br><p>  We go to it in the UI and check that the metrics are collected: </p><br><p><img src="https://habrastorage.org/webt/5g/h_/l3/5gh_l30rao_r6ojiqarwfulix8a.png"></p><br><p>  Great, now it's the Grafan's turn.  We will use the plugin <code>grafana-worldmap-panel</code> , which must be pre-installed: </p><br><pre> <code class="hljs sql">$ grafana-cli plugins <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> grafana-worldmap-panel</code> </pre> <br><p>  Next, go to it in the UI and click add panel -&gt; Worldmap Panel.  In the Metrics tab, enter the following query: </p><br><pre> <code class="hljs lisp">sum(<span class="hljs-name"><span class="hljs-name">job_location</span></span>) by (<span class="hljs-name"><span class="hljs-name">location</span></span>)</code> </pre> <br><p>  And specify the legend format: <code>{{location}}</code> .  It should look like this: </p><br><p><img src="https://habrastorage.org/webt/cu/kt/_i/cukt_i2hl1ffyfmc8fzh0gez-fg.png"></p><br><p>  Next, go to the Worldmap tab and configure everything as in the screenshot: </p><br><p><img src="https://habrastorage.org/webt/7b/a3/5k/7ba35kxctwe4buw3coyyjtsugnm.png"></p><br><p>  And that's it!  Enjoying our map. </p><br><p>  In this simple way, you can make a beautiful map of compounds in Grafan. </p><br><p>  Thank you for your attention and waiting for your comments. </p><br><h2 id="todo">  Todo </h2><br><p>  Of course, to use the tool for its intended purpose, you need to finish it: filter the addresses of local subnets and much more.  By the way, if anyone is interested and wants to develop this exporter - welcome to the repository on GitHub! </p><br><h2 id="links">  Links </h2><br><ul><li>  <a href="https://prometheus.io/docs/instrumenting/clientlibs/">Prometheus client libraries</a> </li><li>  <a href="https://ipstack.com/">Geolocation API</a> </li><li>  <a href="https://github.com/shirou/gopsutil">psutil for golang</a> </li><li>  <a href="https://github.com/grafana/worldmap-panel">Worldmap Panel Plugin for Grafana</a> </li><li>  <a href="https://github.com/gree-gorey/geoip-exporter">Project repository on GitHub</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/420633/">https://habr.com/ru/post/420633/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420623/index.html">Distributed C ++ applications with minimal effort</a></li>
<li><a href="../420625/index.html">KDD 2018, first day, tutorials</a></li>
<li><a href="../420627/index.html">Asynchronous C # programming: how are you doing with performance?</a></li>
<li><a href="../420629/index.html">PHP Digest No. 137 (August 6 - 20, 2018)</a></li>
<li><a href="../420631/index.html">We are not afraid of "clouds"</a></li>
<li><a href="../420635/index.html">AI, practical course. The basic model of recognition of emotions in images</a></li>
<li><a href="../420637/index.html">WANHAO D9 / 300 3D Printer Review: Video</a></li>
<li><a href="../420639/index.html">Akka antipatterns: too many actors</a></li>
<li><a href="../420641/index.html">Technical support 3CX responds: backup and restore 3CX from the command line</a></li>
<li><a href="../420643/index.html">Almost everything is the same, only 10 times cheaper</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>