<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We assemble a laser projector from the parts available</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UPD: Added board files from DAC to GitHub 

 Initially, I planned to make a laser harp , but so far I have an intermediate result - a device that can ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We assemble a laser projector from the parts available</h1><div class="post__text post__text-html js-mediator-article">  <b>UPD:</b> Added board files from DAC to GitHub <br><br>  Initially, I planned to make a <a href="http://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B0%25D0%25B7%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B0%25D1%2580%25D1%2584%25D0%25B0">laser harp</a> , but so far I have an intermediate result - a device that can be used as a laser projector - to draw different shapes with a laser, recorded in ILDA files.  I am aware that many who take up the laser projector assembly, as a device that controls galvanometers (they did not understand how best to translate into Russian the combination of ‚Äúgalvo scanner"), use cheap, slightly modified sound cards for the computer. , because ultimately I will need a completely autonomous device that can work without a computer. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/QHp79ptwRd4%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700191,15700253&amp;usg=ALkJrhjAJ5YlTJu84ev-UZoHrPTrxTg2YA" frameborder="0" allowfullscreen=""></iframe>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's see what my laser projector consists of.  The cost of all parts was about 8,000 rubles, of which more than half is a 70mW laser module. <br><ol><li>  <a href="http://www.ebay.com/itm/20Kpps-HightSpeed-galvo-scanner-max35Kpps-/251501064829%3Fpt%3DUS_Stage_Lighting_Single_Units%26hash%3Ditem3a8ea1b27d">Galvanometers and drivers for them</a> to deflect the laser beam along the X / Y axis </li><li>  532nm 70mW laser module powered by 5V Dragon Lasers SGLM70 </li><li>  Texas Instruments Stellaris Launchpad </li><li>  Homemade board with <a href="http://www.analog.com/static/imported-files/data_sheets/AD7249.pdf">AD7249BRZ</a> DAC </li><li>  Power Supply </li></ol><br><a name="habracut"></a><br><h4>  Iron </h4><br>  My system uses the Stellaris Launchpad as a ‚Äúbrain‚Äù (because it is fast enough and has USB hardware support) and a 12-bit dual-channel DAC with an Analog Devices <a href="http://www.analog.com/static/imported-files/data_sheets/AD7249.pdf">AD7249BRZ</a> serial interface.  To control the deviation of the beam to the driver input, you need to apply an analog signal in the range from -5 to 5 volts.  AD7249BRZ DAC just can work in this mode (as well as from 0 to 5 volts and from 0 to 10 volts).  For him, I spread a special board in Eagle that connects to the Stellaris Launchpad.  The board requires bipolar powering, which is obtained using the <a href="http://www.intersil.com/content/dam/Intersil/documents/icl7/icl7660.pdf">ICL7660</a> microcircuit.  To convert the only output voltage supplied with galvanometers of a power supply unit (15V) into the ones I needed, I used the LM317 linear regulator, which later turned out to be not the most optimal solution, especially for powering the laser module - because LM is a large radiator (visible on video) after 10 minutes of operation, it heats up to 70 degrees. Without a radiator, it just overheated very quickly and was disconnected from overheating (and with it the laser module, which is why I initially decided that it burned down and almost put aside a couple of bricks  When it was re-energized, it did not turn on - as it turned out later, until the microcircuit cools down. <br><br>  The laser module initially did not support TTL modulation, so when I got tired of just driving the laser in different directions, I thought about switching the beam on and off at the right times.  To do this, it was necessary to refine the laser module with a soldering iron.  Fortunately, almost all Chinese laser modules are very similar to each other, simple, and made on an LM358 operational amplifier.  Soldering to his legs 3 and 4 (non-inverting input and ground respectively) emitter and collector of the first bipolar transistor 2N4401 I got, I thus had the opportunity to modulate the operation of the laser, sending a control signal to the base of the transistor: <br><img src="https://habrastorage.org/getpro/habr/post_images/a79/17b/8a8/a7917b8a862cdf9b9afa3916221ba185.jpg"><br><h6>  File Modified Laser Module </h6><br>  The circuit and board for the AD7249BRZ is presented below.  Perhaps an attentive reader will find an error in the circuit, because for unknown reasons it seems that the part with an operational amplifier does not work in order to make the output signal of the circuit <a href="http://ru.wikipedia.org/wiki/%25D0%2591%25D0%25B0%25D0%25BB%25D0%25B0%25D0%25BD%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25BA%25D0%25BB%25D1%258E%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5">balanced</a> for greater protection against interference.  My copy instead of a balanced signal gives an unbalanced, but, nevertheless, everything works and so. <br><img src="https://habrastorage.org/getpro/habr/post_images/f84/06b/c26/f8406bc265d01d86de56e5af03c44b2e.jpg"><br>  I hope you are not afraid of the terrible image of the board with a touch at the conclusions of the chip, which was formed after wiping with ethyl alcohol.  By the way, for this reason, it is recommended to wash the flux with isopropyl alcohol, as it does not leave such stains.  By the way, who cares what kind of connectors such with a latch on the board are Molex connectors (22-23-2021 sockets, 22-01-3027 plug, 08-50-0114 contact for plug), I ordered them through Digikey, because for the Chinese, they are somehow indecently expensive. <br><br><h4>  Soft </h4><br>  On this kind of all the fun about the iron part ends, so go to the soft part.  It consists of two parts - a program for the PC and firmware for the Stellaris Launchpad, which implements a USB bulk device with its own packet format of 32 bits each.  The format of the sample is described by the following structure: <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> x:<span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  X unsigned rx:4; //  (/ ) unsigned y:12; //  Y unsigned ry:4; //   } sample_t;</span></span></code> </pre> <br>  The device uses USB-buffers of 512 bytes in size, which from the PC with a certain margin, and with such a speed as not to cause an overflow or underflow of the buffer, writes data.  The used galvanometers are designed to display 20,000 points per second, that is, this is the required sampling frequency.  In the function of processing data from USB, the processing speed is regulated with the help of the banal <code>SysCtlDelay</code> .  By adjusting the value, you can adjust the system so that the ILDA test image is displayed correctly: <br><img src="https://habrastorage.org/getpro/habr/post_images/bd6/3b6/0e5/bd63b60e53c92baf1fa65e1ee9636866.jpg"><br>  The green LED on the video at the beginning of the post flashes after processing each pack of 20,000 samples.  That is, ideally, it should flash exactly 1 time per second. <br><br>  The software for the PC is based on <code>playilda.c</code> from the <code>playilda.c</code> package, but from there everything is superfluous and instead of interacting with the JACK server, libusb is used to send data packets to the Stellaris Launchpad. <br><div class="spoiler">  <b class="spoiler_title">PC source code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdlib.h&gt; #include &lt;sys/time.h&gt; #include &lt;time.h&gt; #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;libusb-1.0/libusb.h&gt; #include &lt;iostream&gt; #include &lt;string&gt; #include &lt;vector&gt; #define MAGIC 0x41444C49 static inline uint16_t swapshort(uint16_t v) { return (v &gt;&gt; 8) | (v &lt;&lt; 8); } float scale = 1.0; typedef struct { uint32_t magic; uint8_t pad1[3]; uint8_t format; char name[8]; char company[8]; uint16_t count; uint16_t frameno; uint16_t framecount; uint8_t scanner; uint8_t pad2; } __attribute__((packed)) ilda_hdr; #define BLANK 0x40 #define LAST 0x80 typedef struct { int16_t x; int16_t y; int16_t z; uint8_t state; uint8_t color; } __attribute__((packed)) icoord3d; typedef struct coord3d { int16_t x; int16_t y; int16_t z; uint8_t state; coord3d(int16_t x, int16_t y, int16_t z, uint8_t state) : x(x), y(y), z(z), state(state) { } } coord3d; typedef struct { std::vector&lt;coord3d&gt; points; int position; } frame; frame rframe; int subpos; int divider = 1; int loadildahdr(FILE *ild, ilda_hdr &amp; hdr) { if (fread(&amp;hdr, sizeof(hdr), 1, ild) != 1) { std::cerr &lt;&lt; "Error while reading header" &lt;&lt; std::endl; return -1; } if (hdr.magic != MAGIC) { std::cerr &lt;&lt; "Invalid magic" &lt;&lt; std::endl; return -1; } if (hdr.format != 0) { fprintf(stderr, "Unsupported section type %d\n", hdr.format); return -1; } hdr.count = swapshort(hdr.count); hdr.frameno = swapshort(hdr.frameno); hdr.framecount = swapshort(hdr.framecount); } int loadild(const std::string &amp; file, frame &amp; frame) { int i; FILE *ild = fopen(file.c_str(), "rb"); if (!ild) { std::cerr &lt;&lt; "Cannot open " &lt;&lt; file &lt;&lt; std::endl; return -1; } ilda_hdr hdr; loadildahdr(ild, hdr); for (int f = 0; f &lt; hdr.framecount; f++) { std::cout &lt;&lt; "Frame " &lt;&lt; hdr.frameno &lt;&lt; " of " &lt;&lt; hdr.framecount &lt;&lt; " " &lt;&lt; hdr.count &lt;&lt; " points" &lt;&lt; std::endl; icoord3d *tmp = (icoord3d*)calloc(hdr.count, sizeof(icoord3d)); if (fread(tmp, sizeof(icoord3d), hdr.count, ild) != hdr.count) { std::cerr &lt;&lt; "Error while reading frame" &lt;&lt; std::endl; return -1; } for(i = 0; i &lt; hdr.count; i++) { coord3d point(swapshort(tmp[i].x), swapshort(tmp[i].y), swapshort(tmp[i].z), tmp[i].state); frame.points.push_back(point); } free(tmp); loadildahdr(ild, hdr); } fclose(ild); return 0; } short outBuffer[128]; int process() { frame *frame = &amp;rframe; short *sx = &amp;outBuffer[0]; short *sy = &amp;outBuffer[1]; for (int frm = 0; frm &lt; 64; frm++) { struct coord3d *c = &amp;frame-&gt;points[frame-&gt;position]; *sx = 4095 - (2047 + (2048 * c-&gt;x / 32768)) * scale; *sy = (2047 + (2048 * c-&gt;y / 32768)) * scale; if(c-&gt;state &amp; BLANK) { *sx |= 1 &lt;&lt; 15; } else { *sx &amp;= ~(1 &lt;&lt; 15); } sx += 2; sy += 2; subpos++; if (subpos == divider) { subpos = 0; if (c-&gt;state &amp; LAST) frame-&gt;position = 0; else frame-&gt;position = (frame-&gt;position + 1) % frame-&gt;points.size(); } } return 0; } int main(int argc, char **argv) { libusb_device_handle *dev; libusb_context *ctx = NULL; int ret, actual; ret = libusb_init(&amp;ctx); if(ret &lt; 0) { fprintf(stderr,"Couldn't initialize libusb\n"); return EXIT_FAILURE; } libusb_set_debug(ctx, 3); dev = libusb_open_device_with_vid_pid(ctx, 0x1cbe, 0x0003); if(dev == NULL) { fprintf(stderr, "Cannot open device\n"); return EXIT_FAILURE; } else printf("Device opened\n"); if(libusb_kernel_driver_active(dev, 0) == 1) { fprintf(stderr, "Kernel driver active\n"); libusb_detach_kernel_driver(dev, 0); } ret = libusb_claim_interface(dev, 0); if(ret &lt; 0) { fprintf(stderr, "Couldn't claim interface\n"); return EXIT_FAILURE; } // To maintain our sample rate struct timespec ts; ts.tv_sec = 0; ts.tv_nsec = 2000000; memset(&amp;rframe, 0, sizeof(frame)); if (loadild(argv[1], rframe) &lt; 0) { fprintf(stderr, "Failed to load ILDA\n"); return EXIT_FAILURE; } while(1) { process(); if(nanosleep(&amp;ts, NULL) != 0) fprintf(stderr, "Nanosleep failed"); ret = libusb_bulk_transfer(dev, (1 | LIBUSB_ENDPOINT_OUT), (unsigned char*)&amp;outBuffer, 256, &amp;actual, 0); if(ret != 0 || actual != 256) fprintf(stderr, "Write error\n"); } libusb_release_interface(dev, 0); libusb_close(dev); libusb_exit(ctx); return 0; }</span></span></span></span></code> </pre><br></div></div><br>  In the <code>main()</code> function, nanosleep also controls the frequency with which new data is sent to the microcontroller. <br>  The complete source code for the controller firmware can be viewed <a href="https://github.com/madprogrammer/lm4f-laser">on GitHub</a> . <br><br><h4>  Future plans </h4><br>  In the future, it is planned to finish these things to a state similar to the laser harp originally intended.  For this, one and not two mirrors is enough, since the laser beam moves only along one axis.  The principle of the harp is that the controller lights and extinguishes the laser beam at known points in time, creating a laser ‚Äúkeyboard‚Äù in the air.  The performer, blocking a bright laser beam with his hand in a light-reflecting glove, activates the photosensitive element at the base of the harp.  Since the microcontroller knows at which moment which part of the keyboard he ‚Äúpainted‚Äù, it can determine which of the rays was blocked.  The next step is to form the corresponding MIDI message and send it to a computer or a connected hardware synthesizer to form a sound. </div><p>Source: <a href="https://habr.com/ru/post/225531/">https://habr.com/ru/post/225531/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225517/index.html">Creating a game on the engine Sprite Kit (Part 1)</a></li>
<li><a href="../225519/index.html">Installing Alfresco Community 4.2.f on a dedicated virtual server</a></li>
<li><a href="../225523/index.html">Profitable online store. Part I: A Review of Metrics and Ways to Increase Profits</a></li>
<li><a href="../225527/index.html">Monitoring Java applications in Zabbix, customizing JavaGateway for JMX LLD</a></li>
<li><a href="../225529/index.html">ROADAR Personal</a></li>
<li><a href="../225533/index.html">Samsung Introduces New 845DC EVO SSD Series</a></li>
<li><a href="../225535/index.html">Released record long-term software, created 54 years</a></li>
<li><a href="../225537/index.html">DevConf :: Mobi - as early as next week on June 14, a section program was formed</a></li>
<li><a href="../225539/index.html">How IPv6 helps routers break</a></li>
<li><a href="../225543/index.html">How to develop secure applications for Android. Yandex Workshop</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>