<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fast blur according to Gauss</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Gaussian blur filter (commonly known as ‚Äúgaussian blur‚Äù in Photoshop) is often used by itself or as part of other image processing algorithms. Nex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fast blur according to Gauss</h1><div class="post__text post__text-html js-mediator-article">  The Gaussian blur filter (commonly known as ‚Äúgaussian blur‚Äù in Photoshop) is often used by itself or as part of other image processing algorithms.  Next will be described a method that allows you to get a blur with a speed that does not depend on the blur radius using <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">filters with infinite impulse response</a> . <a name="habracut"></a><br><br>  The description of the <a href="http://homepage.tudelft.nl/e3q6n/publications/1998/ICPR98LVTYPV/ICPR98LVTYPV.pdf">method is in English</a> .  But there is no information in Russian.  In addition, I have made some changes. <br><br>  So, let the original image be set by the brightness <i>x</i> ( <i>m, n</i> ).  Gaussian blur with radius <i>r</i> is calculated by the formula 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/79a/5df/cc6/79a5dfcc681479ce55fda6852dfaab2b.png" alt="image"><br><br>  The summation limits for <i>u</i> and <i>v</i> can be chosen as plus or minus a few sigma, i.e.  radii <i>r</i> , which gives the complexity of the algorithm of order O ( <i>r <sup>2</sup></i> ) operations per pixel.  For large <i>r</i> and multi-megapixel images, it's not too cool, is it? <br><br>  The first acceleration gives the separability property of the Gaussian blur.  That is, you can filter along the <i>x</i> axis for each row, filter the resulting image by <i>y</i> by each column and get the same result with complexity O ( <i>r</i> ) operations per pixel.  Already better.  We will also use this property, so further all the arguments will be for the one-dimensional case where you need to get <i>y</i> ( <i>n</i> ) with <i>x</i> ( <i>n</i> ). <br><br>  This will help us filters with infinite impulse response.  The idea of ‚Äã‚Äãthe filter is as follows: the values ‚Äã‚Äãof <i>y</i> ( <i>n</i> ) are calculated recursively using the formula: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/12a/899/233/12a899233ade61a887b7eba302d67520.png" alt="image"><br><br>  Where <i>a <sub>k</sub></i> and <i>b <sub>i</sub></i> are some of the pre-calculated coefficients, and <i>y</i> ( <i>n</i> ) and <i>x</i> ( <i>n</i> ) with <i>n</i> &lt;0 are set to zero. <br><br>  The part of the formula that depends on <i>b <sub>i</sub></i> reduces to a <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D1%2581_%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B9">simple convolution with a finite kernel</a> .  Since we want the filter to read faster, then we will look for our filter for the case <i>P</i> = 0, that is, considering a single coefficient <i>b <sub>0</sub></i> . <br><br>  Just in case, let me remind you that any linear filter (and the IIR filter is also linear) is completely characterized by its response to the delta function equal to 1 at point 0, and 0 at all other points.  The part that depends on the coefficients <i>a</i> in response to such a function either disperses and goes to infinity (I would like to avoid this), or it will give us a beautiful decreasing tail.  For example, like this: <br><br><img src="https://habrastorage.org/storage2/bf1/4a1/3df/bf14a13dfa8ce483b36baded442acf12.png"><br><br>  Looks like gauss?  Well, yes, something is already there, but somehow it looks kosoboko.  Therefore, the idea of ‚Äã‚Äãthe algorithm will be as follows: we filter in one direction (in a cycle from 0 to <i>n <sub>max</sub></i> ), and then the result is reversed (from <i>n <sub>max</sub></i> to 0), with the same coefficients.  Mathematically, you should get a strictly symmetric curve (therefore, it doesn‚Äôt matter if you first filter there and then back, or vice versa).  A little running forward, that's what happens if you filter it in the reverse order: <br><br><img src="https://habrastorage.org/storage2/f77/f12/90e/f77f1290ea33fc56d18b82a5d5e4f383.png"><br><br>  Here it is.  Almost what we need.  Almost, because in fact, of course, not really.  The curve goes into the negative area a bit, and generally differs from the exact Gaussian.  But for most applications, all this is quite acceptable, in addition, if you need to be considered quite certainly, you can increase the order of the <i>Q</i> filter. <br><br>  So, it remains to calculate the filter coefficients <i>a</i> .  Further, all the formulas will go for the case <i>Q</i> = 3. <br><br>  In general, filters are studied using the so-called <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B4%25D0%25B0%25D1%2582%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2584%25D1%2583%25D0%25BD%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F">transfer function</a> .  Those interested can read what it is all about, and for a start, it will be enough for us to begin with that it simply exists and has certain properties.  The general view of this function for a linear filter will be as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b07/b58/31b/b07b5831b38e7639db3d1947388728eb.png" alt="image"><br><br>  Or for our case <i>Q</i> = 3, <i>P</i> = 1: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cd/d21/4d4/6cdd214d4e3e4352d335195892cc195e.png" alt="image"><br><br>  Since there are polynomials in the numerator and denominator, they can be factorized.  The numerator, in general, will give us zeros (in our case, there are no zeros), and the denominator will give us poles: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/99e/dcb/5fd/99edcb5fd4fd6674564081d7b8f1ba61.png" alt="image"><br><br>  in our case, 1 / <i>Z</i> <sub>0</sub> , 1 / <i>Z</i> <sub>1</sub> , 1 / <i>Z</i> <sub>2</sub> .  Note that the poles unambiguously determine the coefficients <i>a <sub>k of</sub></i> our filter (all IIR filters are usually searched for precisely through the poles, and not directly).  By the way, it is easier to get the coefficients by poles than vice versa (to do this, multiply the polynomials, and vice versa - to solve a power equation). <br><br>  The most important theoretical postulate, which is useful to us: if the complex poles lie inside the unit circle, i.e.  modulo less than one, (or, which is the same, the inverse values ‚Äã‚Äãof <i>Z</i> <sub>0</sub> , <i>Z</i> <sub>1</sub> , <i>Z</i> <sub>2</sub> lie outside the unit circle), the filter will be stable, the result will not run away to infinity. <br><br>  We also note that by calling arbitrary complex conjugate <i>Z</i> <sub>0</sub> , <i>Z</i> <sub>1</sub> and real <i>Z</i> <sub>2</sub> (again, all modulo more than one), we can build a filter on them.  In the product, everything will turn into strictly real coefficients <i>a</i> . <br><br>  The coefficient <i>b</i> <sub>0</sub> works like a filter's ‚Äúvolume coefficient‚Äù. <br><br>  So, the task has been reduced to the definition of three coefficients <i>Z</i> <sub>0</sub> , <i>Z</i> <sub>1</sub> , <i>Z</i> <sub>2</sub> .  Since, I repeat, two of them are complex conjugate, and the third is real, then you need to find the real and imaginary parts of the first, and the real part of the third.  That is, three real numbers: real ( <i>Z</i> <sub>0</sub> ), im ( <i>Z</i> <sub>0</sub> ), <i>Z</i> <sub>2</sub> <br><br>  These three numbers must be expressed in terms of the filter radius we need.  Note that in reality it makes sense to consider for <i>r</i> greater than or equal to two, for smaller values ‚Äã‚Äãit is faster to filter by multiplication. <br><br>  Then I went a little different way than in the work "Recursive Gaussian Derivative Filters".  There they extended the case with <i>r</i> = 2 to all others, and I determined the best coefficients for all radii from 2 to 2048, with an exponential step.  I wrote an optimization algorithm that looks for the closest curve using the method of minimizing the modulus of the maximum difference.  An additional condition was the preservation of the total energy by the filter, i.e.  so that the function <i>x</i> ( <i>n</i> ) = const goes into itself, which gives the condition <br><br>  <i>b</i> <sub>0</sub> = 1- ( <i>a</i> <sub>1</sub> + <i>a</i> <sub>2</sub> + <i>a</i> <sub>3</sub> ) <br><br>  I tried different optimization algorithms, and the best ones produced a slightly modified genetic algorithm.  (Perhaps, about the optimization, you can write a separate note). <br><br>  Those interested can see the results on <a href="https://docs.google.com/spreadsheet/ccc%3Fkey%3D0AjXrkuK-SHYNdEp1VWR0cU8tS3FEUEhlLUo0UWE1ZVE">google spreadsheet</a> . <br><br>  It can be seen that for the case of <i>r</i> = 2, the results differ from those in the work.  Why so, I can not say, while according to my calculations, my coefficients give a smaller, by 40 percent, error. <br><br>  Then I used not the letter but the spirit of the article, and began to look for data as <br><br>  real ( <i>Z</i> <sub>0</sub> ) = cos ( <i>W</i> ( <i>r</i> ) / <i>r</i> ) * e <sup>A ( <i>r</i> ) / <i>r</i></sup> <br>  im ( <i>Z</i> <sub>0</sub> ) = sin ( <i>W</i> ( <i>r</i> ) / <i>r</i> ) * e <sup>A ( <i>r</i> ) / <i>r</i></sup> <br>  <i>Z</i> <sub>2</sub> = e <sup><i>B</i> ( <i>r</i> ) / <i>r</i></sup> <br><br>  Those.  then you just need to pick up three similar functions, each of which tends in the limit in the constant.  I was looking for a function in a relationship <br><br>  ( <i>k</i> <sub>3</sub> <i>r</i> <sup>3</sup> + <i>k</i> <sub>2</sub> <i>r</i> <sup>2</sup> + <i>k</i> <sub>1</sub> <i>r</i> + <i>k</i> <sub>0</sub> ) / <i>r</i> <sup>3</sup> <br><br>  and picked up the coefficients in the simplest way - just using <a href="http://www.wolframalpha.com/">Wolfram Mathematica</a> .  By the way, if you carefully study the graphics data from the tables, it is clear that the function has a somewhat sawtooth structure.  Therefore, when approximating, we will lose a little in accuracy, but in fact just a little bit - the values ‚Äã‚Äãfrom the table will give an error 10 percent less than those obtained by polynomials. <br><br>  Here you go.  For those who are already confused about what and what should be considered, I‚Äôll give the final function code in C to calculate the coefficients: <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gaussCoef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sigma, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params">], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *b0)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> sigma_inv_4; sigma_inv_4 = sigma*sigma; sigma_inv_4 = <span class="hljs-number"><span class="hljs-number">1.0</span></span>/(sigma_inv_4*sigma_inv_4); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> coef_A = sigma_inv_4*(sigma*(sigma*(sigma*<span class="hljs-number"><span class="hljs-number">1.1442707</span></span>+<span class="hljs-number"><span class="hljs-number">0.0130625</span></span>)<span class="hljs-number"><span class="hljs-number">-0.7500910</span></span>)+<span class="hljs-number"><span class="hljs-number">0.2546730</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> coef_W = sigma_inv_4*(sigma*(sigma*(sigma*<span class="hljs-number"><span class="hljs-number">1.3642870</span></span>+<span class="hljs-number"><span class="hljs-number">0.0088755</span></span>)<span class="hljs-number"><span class="hljs-number">-0.3255340</span></span>)+<span class="hljs-number"><span class="hljs-number">0.3016210</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> coef_B = sigma_inv_4*(sigma*(sigma*(sigma*<span class="hljs-number"><span class="hljs-number">1.2397166</span></span><span class="hljs-number"><span class="hljs-number">-0.0001644</span></span>)<span class="hljs-number"><span class="hljs-number">-0.6363580</span></span>)<span class="hljs-number"><span class="hljs-number">-0.0536068</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> z0_abs = <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span>(coef_A); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> z0_real = z0_abs*<span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(coef_W); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> z0_im = z0_abs*<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(coef_W); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> z2 = <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span>(coef_B); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> z0_abs_2 = z0_abs*z0_abs; a[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">1.0</span></span>/(z2*z0_abs_2); a[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (z0_abs_2+<span class="hljs-number"><span class="hljs-number">2</span></span>*z0_real*z2)*a[<span class="hljs-number"><span class="hljs-number">2</span></span>]; a[<span class="hljs-number"><span class="hljs-number">1</span></span>] = -(<span class="hljs-number"><span class="hljs-number">2</span></span>*z0_real+z2)*a[<span class="hljs-number"><span class="hljs-number">2</span></span>]; *b0 = <span class="hljs-number"><span class="hljs-number">1.0</span></span> - a[<span class="hljs-number"><span class="hljs-number">0</span></span>] - a[<span class="hljs-number"><span class="hljs-number">1</span></span>] - a[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre> <br><br>  Everything!  Now, you need to write the code itself.  Calculation, of course, needs to be made during float, but modern computers consider floating-point numbers (especially with sse) rather quickly.  Programmers from Intel, by the way, have attended to the optimization of Gauss-IIR filters for the vector instructions of the processor <a href="http://software.intel.com/en-us/articles/iir-gaussian-blur-filter-implementation-using-intel-advanced-vector-extensions/">have already written an entire article</a> .  True, they consider it a little differently, but the main optimization methods are described well. <br><br>  In the end, you can give an example of what happened: <br><br><img src="https://habrastorage.org/storage2/2e2/51e/145/2e251e14546301f95f086c025d860d4a.png"><br><br>  The picture is almost the same as ‚Äúfair‚Äù.  However, if you open it in Photoshop and study it carefully, you can find the difference. <br><br>  <sub>PS This is true my first post on Habr√©, I could miss something.</sub>  <sub>If you have questions, I will answer in the comments.</sub> </div><p>Source: <a href="https://habr.com/ru/post/151157/">https://habr.com/ru/post/151157/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151148/index.html">RailsClub'Moscow 2012. Interview with Wynn Netherland</a></li>
<li><a href="../151150/index.html">web and MVC: debriefing</a></li>
<li><a href="../151152/index.html">Client for SOAP API Russian Post in Python</a></li>
<li><a href="../151153/index.html">How to avoid Internet autism?</a></li>
<li><a href="../151156/index.html">Optimization of custom firmware HTC Desire HD (Virtuous Infinity)</a></li>
<li><a href="../151159/index.html">Find IT - job fair for IT-specialists</a></li>
<li><a href="../151161/index.html">Hard Drive Soldering Stand</a></li>
<li><a href="../151162/index.html">Asana in detail and how to use it</a></li>
<li><a href="../151163/index.html">Unobvious optimization in speed when solving a specific problem in Python</a></li>
<li><a href="../151165/index.html">Growing black swans</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>