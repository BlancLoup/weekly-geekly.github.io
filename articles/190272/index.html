<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two-wheeled automation of uploading files to the server from Notepad ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It just so happened that by work, I have to edit the files to which I have access only through the CMS Bitrix file manager, which entails opening mult...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two-wheeled automation of uploading files to the server from Notepad ++</h1><div class="post__text post__text-html js-mediator-article">  It just so happened that by work, I have to edit the files to which I have access only through the CMS Bitrix file manager, which entails opening multiple tabs in the browser and a huge amount of unnecessary gestures necessary only to edit a few files. <br>  Below I will tell how I solved this problem with the help of Node.js and free time. <br><a name="habracut"></a><br>  The first thing I did was find out how the bitrix approaches editing files in general.  Everything turned out to be quite simple and did not exceed my expectations at all - the text of the file is sent to the server by the form along with the file name, where the php script opens the specified file and writes the contents to it. <br>  The most logical thing that occurred to me was to imitate sending the form to the same handler. <br>  To do this, you need to do 3 things: <br><ul><li>  Pretend to be a browser </li><li>  Pretend to be a user who has rights to edit files. </li><li>  Submit Form </li></ul><br>  Anyone who knows at least a little about the <a href="http://ru.wikipedia.org/wiki/%25C7%25E0%25E3%25EE%25EB%25EE%25E2%25EA%25E8_HTTP">http</a> protocol knows that the User-Agent string in the request header is responsible for determining the client program. <br>  It is here that you should indicate the signature of the program under which we mask.  I have this: <br><br> <code>Mozilla/5.0 (Windows NT 6.1; WOW64; rv:22.0) Gecko/20100101 Firefox/22.0</code> <br> <br>  Slightly more complicated is the situation with impersonation of the user.  By the method of typing, or rather the successive removal of cookies, it was found that in order for the site to consider the user logged in - he only needed his username and current <a href="http://www.php.su/articles/%3Fcat%3Dexamples%26page%3D070">phpsessid</a> .  I already know the login, but you can find out the session number in several ways. <br>  First, you can simply view it using the ‚ÄúDeveloper Tools‚Äù available in any browser. <br>  Secondly, since we are sending the form, you can first send the login form to the site so that the session number comes in the form of a cookie. <br>  Considering that in any case file uploading is connected with the entrance to the site, I decided to use the first method, however, instead of opening FireBug every time, I simply added phpsessid output to one of the site pages. <br>  The last and most important thing that we need to do is send the data to the server as if from a form. <br>  Here, too, there is nothing difficult.  In the same request header, specify the Content-Type, which determines the type of content attached to the header, and add the Content-Length, which is necessary for the server to know how much content to accept. <br>  After that, in the body of the request, we send the serialized data, which is the text of the file, its name on the server, and some other variables necessary for the form handler. <br>  Now that the ‚Äúcalculations‚Äù are over, we can proceed to practice. <br>  To begin with, we will determine what information is generally needed to successfully upload files to the server.  In addition to the specified login and session number, the path to the files on the local machine and the path on the server where these files will be saved are required. <br>  The first was decided to be passed to the script as an argument, and all other information stored in a file in the folder that is passed to the script. <br>  In nodejs, the command line arguments are stored in the <b>argv</b> field of the global <b>process</b> variable, and even if no arguments are passed to the program, there are 2 lines in the <b>process.argv</b> array - ‚Äúnode‚Äù and the name of the program being executed, so the first argument is at offset 2. First, we check to see if at least some argument is passed to our script, and if it does not suddenly appear, we exit. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(process.argv.length&lt;<span class="hljs-number"><span class="hljs-number">3</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>); process.exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Having received the path to the local folder, open the file <i>config.json</i> that should be there. <br>  The fs (FileSystem) module is responsible for working with files in nodejs.  Modules in nodejs are essentially just sets of functions, but we all know that functions in javascript are not exactly like in other languages. <br>  We also need quite an ordinary function <b>fs.readFile (path, callback)</b> which, as you yourself can guess, reads the contents of the file.  If everything is clear with the first of its arguments, then the second is a function that will be executed when the file is fully read.  Moreover, the program will not stop waiting for this moment, but will continue its execution.  Such an approach to program organization is called Event-Oriented Programming.  So - read the settings file in the specified folder.  Its contents will be passed to the callback function as the second argument.  The first is an error or false if everything is fine. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ,     fs fs.readFile(process.argv[2]+'\config.json', function (err, data) { if (err) throw err; c = JSON.parse(data);//    json       //...-     });</span></span></code> </pre><br><br>  Next, you need to get a list of files in the folder and upload each file to the server, unless this file is a configuration file or another file to be ignored. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//...   fs.readdir(process.argv[2],function(err,files){ //      if (err) throw err; files.forEach(function(el,index,array){ if(el.split('.').length&gt;1) if(el!='config.json' &amp;&amp; el!='.git' &amp;&amp; el!='.gitattributes' &amp;&amp; el!='.gitignore') //    upload(el); //     }); });</span></span></code> </pre><br><br>  Having received the name of the file, we can read its contents and send it to the server.  That is what we will do.  In order to send an http request to nodejs there is an <b>http</b> module.  Having connected it, we can call the <b>http.request</b> function <b>(method, path, port, hostname, headers, callback)</b> , where the penultimate argument literally makes us omnipotent, because it allows you to send a request with any header, exactly here we specify the User-Agent, the cookie and the content type of the request.  By making a request, we get it into a variable, through which we can influence its behavior.  For example, the <b>write ()</b> and <b>end ()</b> methods.  Send data in the request body with the only difference that write can be called several times in a row, and end - only once.  immediately after calling it, the completion of the request. <br>  As mentioned earlier, the data must be sent in serialized form, namely, as we would have seen in the address bar.  In nodejs there is a module for working with such data, and it is called querystring.  It allows you to save an object in a string and vice versa.  All form data is stored in the global <i>query</i> variable, which we serialize for later submission. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> querystring = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'querystring'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"  %s:"</span></span>,file); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileData=fs.readFileSync(process.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]+<span class="hljs-string"><span class="hljs-string">'\\'</span></span>+file); <span class="hljs-comment"><span class="hljs-comment">//    query.path=c.path+file;//       query.filesrc=fileData.toString(); var str=querystring.stringify(query);//    var len=str.length; var request = http.request( //   { method:'post', path:'/bitrix/admin/fileman_file_edit.php', port:80, hostname:'***.****.ru', headers:{ 'host':'***.****.ru', 'User-Agent':'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:22.0) Gecko/20100101 Firefox/22.0', 'Cookie':'PHPSESSID='+c.phpsessid+';BITRIX_SM_LOGIN='+c.login, 'Content-Type':'application/x-www-form-urlencoded', 'Content-Length':len } },rListener); //         request.end(str); //    ( )    }</span></span></code> </pre><br><br>  Well, in order to know whether our file has been downloaded or if our works were in vain, we accept the response to the request.  The callback that is called when the answer is received, the first argument takes all the response information, including the status.  By the same method of typing, it was found that when the file was successfully downloaded, the redirect returned in return, in the remaining cases the page came back. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rListener</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status=<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(response.statusCode){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">302</span></span>: status=<span class="hljs-string"><span class="hljs-string">' '</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    -   case 200: status='  ';break; default : status=''; } console.log('%s (%d).',status,response.statusCode); }</span></span></code> </pre><br><br>  The full script code is <a href="https://github.com/MadridianFox/Deploy_To_Bitrix">here</a> . <br>  Having such a bike, it‚Äôs pretty easy to set up a script call by pressing a key in your favorite editor.  I have this Notepad ++ with the NppExec plugin. </div><p>Source: <a href="https://habr.com/ru/post/190272/">https://habr.com/ru/post/190272/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190258/index.html">Safety of bank plastic cards - myth or reality?</a></li>
<li><a href="../190260/index.html">How I found a vulnerability on phpclub.ru</a></li>
<li><a href="../190266/index.html">Perl6 - Working with Data Types</a></li>
<li><a href="../190268/index.html">What does business process automation using IBM BPM and J2EE provide?</a></li>
<li><a href="../190270/index.html">Scientific and educational comics for children - issue 2</a></li>
<li><a href="../190274/index.html">Say no to formatting with spaces and enterrs.</a></li>
<li><a href="../190278/index.html">How not to learn English words</a></li>
<li><a href="../190280/index.html">My experience with SOINN</a></li>
<li><a href="../190286/index.html">General psychology: usability</a></li>
<li><a href="../190290/index.html">Runet in pictures. Shopping without borders</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>