<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Face Detection with Movidius Neural Compute Stick</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, the Movidius Neural Compute Stick (NCS) device was released , which is a hardware accelerator for neural networks with a USB interfac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Face Detection with Movidius Neural Compute Stick</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, the <a href="https://developer.movidius.com/">Movidius Neural Compute Stick (NCS)</a> device was <a href="https://developer.movidius.com/">released</a> , which is a hardware accelerator for neural networks with a USB interface.  I was interested in the potential use of the device in the field of robotics, so I purchased it and decided to launch some kind of neural network.  However, most of the existing examples for NCS solve the problem of image classification, but I wanted to try something else, namely, face detection.  In this publication, I would like to share the experience gained during such an experiment. <br><br>  All code can be found <a href="https://github.com/BeloborodovDS/NCS-face">on GitHub</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb2/ef3/d2b/eb2ef3d2bcc492a8f77cf195143cf4d6.jpg" alt="image"></div><br><a name="habracut"></a><br><h4>  More about NCS </h4><br>  Neural Compute Stick is a device designed to accelerate neural networks (mainly convolutional) at the stage of application (inference).  The idea is that NCS can be connected to a robot or drone and run neural networks where there are not enough computational resources for this.  For example, NCS can be connected to the Raspberry Pi. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The framework for this device, also <a href="https://github.com/movidius/ncsdk">known</a> as <a href="https://github.com/movidius/ncsdk">NCSDK</a> , includes APIs for Python and C ++, as well as several useful utilities that allow you to compile a neural network into a format that NCS understands, measure the time it takes to calculate on each layer and test the network.  The initial data can be pre-trained neural networks in the Caffe or TensorFlow format. <br><br><h4>  Model selection </h4><br>  Great, we want to solve the face detection problem.  There are two quite popular neural network architectures for detection tasks: Fast-RCNN / Faster-RCNN and YOLO.  I did not want to train my model at this stage, so I decided to search for the finished one. <br><br>  The difficulty lies in the fact that NCSDK does not support all of the features available in Caffe and TensorFlow, so arbitrary architecture may simply not compile.  For example, not all types of layers are supported, and the architecture should have exactly one input layer (a full list of restrictions and supported layers for Caffe can be seen <a href="https://movidius.github.io/ncsdk/Caffe.html">here</a> ).  The first face detection model I was able to find (Faster-RCNN) did not satisfy both requirements. <br><br>  Then I stumbled upon a trained <a href="https://github.com/dannyblueliu/YOLO-version-2-Face-detection">model</a> of the <a href="https://arxiv.org/abs/1506.02640">YOLO</a> architecture.  The only problem was that the neural network was in Darknet format, although the architecture itself looked appropriate for NCS, so the idea was to convert the neural network to Caffe format. <br><br><h4>  Model conversion </h4><br>  To convert the model, I decided to use <a href="https://github.com/marvis/pytorch-caffe-darknet-convert">this project</a> , which allows you to switch between the formats Darknet, Pytorch and Caffe. <br><br>  I run the converter in the Docker container - this is a trick that appeared due to the fact that the version of Caffe installed by NCSDK did not like the converter, and I did not want to touch the system configuration: <br><br><pre><code class="bash hljs">sudo docker run -v `<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>`:/workspace/data \ -u `id -u` -ti dlconverter:latest bash -c \ <span class="hljs-string"><span class="hljs-string">"python ./pytorch-caffe-darknet-convert/darknet2caffe.py \ ./data/yolo-face.cfg ./data/yolo-face_final.weights \ ./data/yolo-face.prototxt ./data/yolo-face.caffemodel"</span></span></code> </pre> <br>  It turns out something interesting: the model is converted, but a warning is issued that the layers like Crop, Dropout and Detection could not be recognized, which is why the converter missed them.  Is it possible to do without these layers?  It turns out you can.  If you look closely at the Darknet <a href="https://github.com/dannyblueliu/YOLO-version-2-Face-detection">code</a> , you will notice the following: <br><br>  A layer of type Crop is needed only at the learning stage.  He is committed to expanding the sample, turning the image at random angles and cutting out random fragments from it.  At the application stage, it is not required. <br><br>  Dropout is a little more interesting.  A dropout layer is also needed mainly at the training stage (the Dropout layer resets the outputs of neurons with probability <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>p</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.259ex" height="1.817ex" viewBox="-38.5 -520.7 542 782.1" role="img" focusable="false" style="vertical-align: -0.607ex; margin-left: -0.089ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-70" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>p</mi></math></span></span><script type="math/tex" id="MathJax-Element-1"> p </script>  ) in order to avoid retraining and increase the ability of the model to generalize.  At the application stage, it can be eliminated, but it is necessary to scale the outputs of the neurons so that the expectation of values ‚Äã‚Äãat the inputs of the next layer does not change, so that the model‚Äôs behavior is preserved (divided by <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>1</mn><mo>&amp;#x2212;</mo><mi>p</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.172ex" height="2.298ex" viewBox="0 -728.2 2226.9 989.6" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-31" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-2212" x="722" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-70" x="1723" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1</mn><mo>‚àí</mo><mi>p</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> 1-p </script>  ).  If you look at the Darknet code, you can see that the Dropout layer not only clears some outputs, but also scales all others, so the Dropout layer can be safely removed. <br><br>  As for the layer detection, it is the last one and is engaged in transferring the outputs from the penultimate layer to a more readable form, and also considers the loss function at the training stage.  We do not need to count the loss function, but translating the result into a readable form is useful.  In the end, I decided to just use the function for the last layer straight from Darknet (having edited it a little), from there I also took the function for NMS (Non maximum suppression - removal of redundant limiting frames).  They are in the files detection_layer.c and detection_layer.h. <br><br>  Here it is worth making a remark about what the penultimate layer does.  In the architecture of YOLO (You only look once), the image is divided into blocks by grid size. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>n</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.226ex" height="1.937ex" viewBox="0 -728.2 3972.5 834" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6E" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-74" x="850" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-69" x="1212" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6D" x="1557" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-65" x="2436" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-73" x="2902" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6E" x="3372" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-3"> n \ times n </script>  (in this case <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi><mo>=</mo><mn>11</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.818ex" height="1.937ex" viewBox="0 -728.2 2935.6 834" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6E" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-3D" x="878" y="0"></use><g transform="translate(1934,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-31" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi><mo>=</mo><mn>11</mn></math></span></span><script type="math/tex" id="MathJax-Element-4"> n = 11 </script>  ), and for each block is predicted <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>5</mn><mi>m</mi><mo>+</mo><mi>c</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.05ex" height="2.057ex" viewBox="0 -728.2 3035.4 885.9" role="img" focusable="false" style="vertical-align: -0.366ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-35" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6D" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-2B" x="1601" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-63" x="2601" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>5</mn><mi>m</mi><mo>+</mo><mi>c</mi></math></span></span><script type="math/tex" id="MathJax-Element-5"> 5m + c </script>  values ‚Äã‚Äãwhere <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>m</mi><mo>=</mo><mn>2</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.301ex" height="1.937ex" viewBox="0 -728.2 2713.1 834" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6D" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-3D" x="1156" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-32" x="2212" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>m</mi><mo>=</mo><mn>2</mn></math></span></span><script type="math/tex" id="MathJax-Element-6"> m = 2 </script>  - the number of bounding boxes for each block, and <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>c</mi><mo>=</mo><mn>1</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.268ex" height="1.937ex" viewBox="0 -728.2 2268.1 834" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-63" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-3D" x="711" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-31" x="1767" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>c</mi><mo>=</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-7"> c = 1 </script>  - number of classes.  The values ‚Äã‚Äãthemselves are: coordinates, width, height and confidence value for each of <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>m</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.04ex" height="1.455ex" viewBox="0 -520.7 878.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6D" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>m</mi></math></span></span><script type="math/tex" id="MathJax-Element-8"> m </script>  frames (that is, a total of five values), as well as the probability of finding an object in this block for each class.  Total is obtained <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>n</mi><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mo stretchy=&quot;false&quot;>(</mo><mn>5</mn><mi>m</mi><mo>+</mo><mi>c</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mn>1331</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="32.271ex" height="2.66ex" viewBox="0 -832 13894.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6E" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-74" x="850" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-69" x="1212" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6D" x="1557" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-65" x="2436" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-73" x="2902" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6E" x="3372" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-74" x="4222" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-69" x="4584" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6D" x="4929" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-65" x="5808" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-73" x="6274" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-28" x="6744" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-35" x="7133" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6D" x="7634" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-2B" x="8734" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-63" x="9735" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-29" x="10168" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-3D" x="10836" y="0"></use><g transform="translate(11892,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-33" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-33" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-31" x="1501" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>n</mi><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mo stretchy="false">(</mo><mn>5</mn><mi>m</mi><mo>+</mo><mi>c</mi><mo stretchy="false">)</mo><mo>=</mo><mn>1331</mn></math></span></span><script type="math/tex" id="MathJax-Element-9"> n \ times n \ times (5m + c) = 1331 </script>  values.  The Detection layer only separates different types of data and brings them into a structured view. <br><br>  One problem remains: the converter generates a .prototxt file with the format of the input layer, which NCSDK cannot parse.  The differences are exclusively decorative: the converter records the size of the input layer in the format: <br><br><pre> <code class="bash hljs">input_dim: x input_dim: y input_dim: z input_dim: w</code> </pre> <br>  And the mvNCCompile utility, which should compile a neural network into a clear NCS file, wants to see the format: <br><br><pre> <code class="bash hljs">input_shape { dim: x dim: y dim: z dim: w }</code> </pre> <br>  The utils / fix_proto_input_format.py Python script is designed to solve this problem (not by doing this yourself). <br><br><h4>  Compiling model </h4><br>  Now that the model has been translated into the Caffe format, you can compile it.  This is done quite simply: <br><br><pre> <code class="bash hljs">mvNCCompile -s 12 -o graph -w yolo-face.caffemodel yolo-face-fix.prototxt</code> </pre> <br>  This command should generate a binary graph file, which is a graph of computations in a format understood by NCS. <br><br><h4>  Image preprocessing </h4><br>  It is important to properly organize the processing of images before loading them into the graph of calculations, otherwise the neural network will not work as intended.  As data for the neural network, I will use the frames from the webcam obtained using OpenCV. <br><br>  Judging by the code of the demo for Darknet, before downloading the image you need to compress it to the size <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-10-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>448</mn><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mn>448</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.412ex" height="2.057ex" viewBox="0 -780.1 5774.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-34"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-34" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-38" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-74" x="1751" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-69" x="2113" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-6D" x="2458" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-65" x="3337" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMATHI-73" x="3803" y="0"></use><g transform="translate(4273,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-34"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-34" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-38" x="1001" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>448</mn><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mn>448</mn></math></span></span><script type="math/tex" id="MathJax-Element-10"> 448 \ times 448 </script>  (and not caring about proportions), normalized to the segment <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-11-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>[</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy=&quot;false&quot;>]</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.653ex" height="2.66ex" viewBox="0 -832 2003.2 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-5B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-30" x="278" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-2C" x="779" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-31" x="1224" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/347438/&amp;xid=17259,1500008,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh-cIADbeOVZx8bx4Y8CXUahhAFdw#MJMAIN-5D" x="1724" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">[</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="false">]</mo></math></span></span><script type="math/tex" id="MathJax-Element-11"> [0,1] </script>  each pixel and invert the channel order from BGR to RGB.  In general, the BGR variant is considered standard in Caffe and OpenCV, and RGB is considered standard in Darknet, but the converter knows nothing about it, and as a result, the channels still need to be inverted. <br><br><h4>  Contact NCS and download data </h4><br>  Here it is worth noting that I use C ++, not Python, because I am guided by the use of the device in robotics and I believe that with C ++ you can achieve greater speed.  It is because of this that additional difficulties appear: the computation graph receives as input and outputs data in the fp16 format (16-bit floating point numbers), which are not implemented in C ++ by default.  In the NCSDK examples, this problem is solved using the floattofp16 and fp16tofloat functions torn from Numpy, so I use the same solution. <br><br>  In order to start interacting with NCS, you need to perform a number of actions: <br><br><ul><li>  Call mvncGetDeviceName to get the name NCS </li><li>  Open device by name with mvncOpenDevice </li><li>  Load the contents of the graph file into the buffer (there is no special function for this, you need to use your own) </li><li>  Post computation graph using mvncAllocateGraph </li></ul><br>  The functions mvncLoadTensor and mvncGetResult are used to load data and get results.  In this case, you need to remember about the conversion of data and results in fp16 and back. <br><br>  To stop working with NCS, you need to free the resources allocated for the calculation graph (mvncDeallocateGraph) and close the device (mvncCloseDevice). <br><br>  Since interacting with NCS requires quite a lot of actions, I wrote a wrapper class that (besides the constructor and destructor) has only two functions: load_file to initialize the device and the graph, and load_tensor to load the data and get the result. <br><br><h4>  Profiler </h4><br>  NCSDK has a useful utility that allows you not only to evaluate the performance of each layer, but also to create a calculation graph scheme that reflects the characteristics of each element (by the way, it‚Äôs not necessary to transfer the layer weights themselves): <br><br><pre> <code class="bash hljs">mvNCProfile yolo-face-fix.prototxt -w yolo-face.caffemodel -s 12</code> </pre> <br><h4>  What happened in the end </h4><br>  The final result is as follows: <br><br>  The original model (.cfg and .weights) is converted into Caffe format (.prototxt and .caffemodel) using a converter, the input format is corrected in the .prototxt file using a Python script, after which the model is compiled into a graph file - convert and graph to Makefile <br><br>  In the program itself, for each received frame, preprocessing is performed, translated into the fp16 format and loaded into the calculation graph.  The result is transferred from fp16 to float format and passed to a function that simulates the work of the last Detection layer.  Then apply Non maximum suppression. <br><br>  The demo proudly delivers 4.5 frames per second - this is not enough.  The problem, apparently, is that this architecture is of the type that is sharpened more for accuracy than for speed.  The speed of work can be significantly increased if you use "mobile" architectures like Tiny YOLO - for this you have to look for a new model or train your own.  However, this example shows that a Darknet neural network can be compiled and run on the Neural Compute Stick. </div><p>Source: <a href="https://habr.com/ru/post/347438/">https://habr.com/ru/post/347438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347428/index.html">5 development trends of microservices in 2018</a></li>
<li><a href="../347430/index.html">Anti-virus report for 2017: forget about malware</a></li>
<li><a href="../347432/index.html">POS, security and that's it. Parse the vulnerabilities of the popular Retail-system</a></li>
<li><a href="../347434/index.html">AI Tournament for Industrial Air Hockey Robots</a></li>
<li><a href="../347436/index.html">SEO for Google in 2018: well forgotten new</a></li>
<li><a href="../347440/index.html">Salaries of IT Professionals at the End of 2017: My Circle Salary Service Report</a></li>
<li><a href="../347442/index.html">Designing a fire pumping station</a></li>
<li><a href="../347444/index.html">Gestalt principles in user interface design</a></li>
<li><a href="../347446/index.html">Mission Impossible or get a certificate</a></li>
<li><a href="../347448/index.html">‚ÄúCourse on hyperscale‚Äù: there are almost 400 hyper-scalable data centers in the world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>