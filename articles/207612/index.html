<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Node.JS + taskset == a bit of weird humor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I regularly hear a phrase like ‚ÄúNode.js is not suitable for high-speed content‚Äù. 

 I wanted to see for myself. 

 I wanted to write a comment on that...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Node.JS + taskset == a bit of weird humor</h1><div class="post__text post__text-html js-mediator-article">  I regularly hear a phrase like ‚ÄúNode.js is not suitable for high-speed content‚Äù. <br><br>  I wanted to see for myself. <br><br>  I wanted to write a comment on <a href="http://habrahabr.ru/post/207460/">that</a> article, but changed my mind and wrote more.  The author of that article, thank you very much for the interesting topic, hurt. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On the Internet, someone is wrong.  Our beat!  It's a shame, yes.  I made some conclusions for myself, but these are my subjective numbers.  What to think in general - I do not know, please write your opinion in kamentah. <br><br>  <b>UPD 3</b> According to the results of the discussion, what I needed to write from the very beginning was found, what I meant, namely: that the test is not representative, the only thing that it shows is that On My very weak machine, the node lags on Nginx half an order .  Noda, like Nginx, does almost nothing, in this sense they are ‚Äúequal‚Äù.  I wanted to show that there is a taskset, that a node can not overload a percent under certain conditions, that it is not necessary to believe the tests. <br><br>  Link to GIT under the cut is.  There are some configs that are optimal only for me.  The article is confused and for the most part comic.  Please - do not read if you are not ready to be suspicious of numbers, benchmarks and strange conclusions of people unfamiliar to you, expressing their thoughts with the constantly changing context of associative references to the humanitarian thinking. <br><br>  <b>UPD 1 a</b> little bit like ‚Äúhumor‚Äù, m. B.  so it will be more correct. <br>  <b>UPD 2</b> Do not believe a single word! <br><br><a name="habracut"></a><br><br>  I am a shaman!  I quietly take a tambourine in my hands and uncover the <a href="http://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B0%25D1%2580%25D0%25B3%25D0%25B0%25D0%25BD">harp</a> ... <br><br>  I do not like resources, because  I understand that in case of emergency I will not have them. <br>  Therefore, I have them very modest: <a href="http://ru.wikipedia.org/wiki/AMD_Brazos">AMD C-60</a> /4 Gb / SSD. <br><br>  All this is packed in a netbook, weighs about a kilogram and is managed by Linux Mint.  I anticipate questions, so I will answer immediately.  Yes, it also happens that I cook.  I also know how to embroider with a cross like <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D1%2582_%25D0%259C%25D0%25B0%25D1%2582%25D1%2580%25D0%25BE%25D1%2581%25D0%25BA%25D0%25B8%25D0%25BD">Matroskin</a> .  <a href="http://lurkmore.to/%25D0%2593%25D0%25B8%25D1%2582%25D0%25B0%25D1%2580%25D0%25B0">I sing the guitar</a> like <a href="http://lurkmore.to/%25D0%25AD%25D0%25BB%25D0%25B2%25D0%25B8%25D1%2581">Elvis</a> .  At home there I can hammer a nail with pliers.  In general - a gift to the family: an indispensable specialist of a wide profile. <br><br>  And I enjoy programming in JavaScript.  No, I can read Python, Ruby, PHP, Perl, VB, C #, Java, etc.  But I can not write, "the soul does not lie."  And I have no education, IT-shnoy, so I use banal logic and the fact that by nature I sometimes prefer to think with my own head, and not with someone else's.  And so I live. <br><br>  Customers have set me the task of spherical comparative analysis of Node.JS and Nginx.  Since  it was necessary to measure the potential performance of the node itself, then the task was set slyly: <br><br>  - NGINX gives only its default static index.html page. <br>  - The Node server must count the connections and give the result in each response, as well as the maximum number. <br>  - Client software should count the number of processed requests per second, i.e.  successfully completed with status 200 OK. <br><br>  It is clear that nginx will win.  But the essence is not in it, but in comparison.  Those.  exactly how many times the node interpreter is worse than the static Nginx. <br><br>  Of course, I understand that it is also possible to force a node to render static.  But you try to teach nginx business logic in a dozen tables in a couple of hours? <br><br>  The link to git will be at the end.  Use Case for those who are "in the tank" will be there. <br><br>  I'll tell you a little how I came to this, to, so to speak, dispel doubts. <br><br>  We all know that modern processors work consistently. <br><br>  We know everything, but we understand what we want, and not as it is right! <br><br>  Tell me, can you think of several things at once?  And if at this moment the phone rings and you need to answer the call?  And if, in parallel with the phone, a person-colleague approaches you, to whom [oh || mu] do you have sympathy and ask some very important question?  And if, at the same time, a BOSS man passes by suddenly, looks at the screen on which Lurk flaunts in an undisturbed browser window or something else? <br><br>  This is the same - interrupt handling and stack overflow. <br><br>  It would seem - what does asynchrony? <br><br>  But, if you, all of a sudden, for some terrible reason still did not fully understand, I advise you to think again. <br><br>  For example, your brain can hold 8 operational tasks, for example, by analogy with 8 cores of the core.  The rest - they are somewhere there, sometime they will be, they are still far away. <br><br>  Think how you can imagine it, play <a href="http://en.wikipedia.org/wiki/Zebra_Puzzle">Estinstein</a> Chtol.  It turns out you have all the multithreading there only in your head to hold (as in L1-L2 Cache), meaning, yes - without the leaf (Mem)? <br><br><hr><br><br>  Now let's count. <br><br>  You run your attachment on the node, you have a standard code there, maybe <a href="http://nodejs.org/api/cluster.html">from here</a> . <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cluster = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'cluster'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> numCPUs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'os'</span></span>).cpus().length; ... for (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; numCPUs; i++) { cluster.fork(); ...</code> </pre> <br><br>  Or something similar, with multithreading. <br><br>  What do you think, who will drive the flows? <br><br>  That's right - Operating System. <br>  And in the system who drives them? <br><br>  That's right - Linux Kernel \ Windows Core - Hardware Abstraction Layer (hal.dll, I guess I could be wrong). <br><br>  So far, it seems, there is nothing suspicious. <br><br>  But let's still think a little more! <br>  Suppose, besides the node, nothing else is established at all. <br><br>  What else is on this "hardware" besides her? <br>  That's right - Operating System. <br><br>  And in it all the tripe that steers the flow.  Doesn't it seem mysterious to you that such a simple thing as consecutive instructions, even in asynchronous mode, is serviced and abstracted by such a complex thing as multithreading and parallelism of tasks in the kernel world? <br><br>  So, each of the iron cores of the processor counts sequentially.  Above them is the executable kernel code, which is of the type EVERYTHING trying to present as a parallel multitasking and other ryushechki.  Inside, under the control of the OS kernel, a single-threaded code of node processes, of which we have 8 pieces, is spinning, according to the number of CPU cores. <br><br>  What will happen to polymers when we get ‚ÄúIO‚Äù to the core via the network stack, for example via HTTP?  It seems that the OS kernel is coping ... <br><br>  And if the node has already disposed of everything on all 8 cores?  It seems that the OS kernel is also coping ... <br><br>  But here I would like to look at the benchmark! <br><br>  Let's do it! <br><br><ol><li>  Let's compare the node with Nginx, as described in the problem above. </li><li>  Compare the responsiveness of the node with a full CPU and without it. </li></ol><br><br>  I‚Äôll say right away that I ran all the tests for 10 minutes, while doing the usual tasks such as code and surfing. <br><br>  Yes, in order to make the process work only on certain kernels in Linux, there is a taskset. <br><br>  In the node, I use it like this: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> PID = process.pid; exec(<span class="hljs-string"><span class="hljs-string">'taskset -pc '</span></span> + affinity + <span class="hljs-string"><span class="hljs-string">' '</span></span> + PID);</code> </pre><br><br>  I also wrote software for requests on the node via <a href="https://github.com/mikeal/request">request.js</a> , it was important not to forget about http.agent.maxSockets.  It was possible, of course, CURL, but I wanted to count everything myself. <br><br>  So, the first test: servers on Nginx and Node, Max 10,000 open requests.  In reality, it turned out less, of course.  This digit is simply the number of requests in the array of requests and not their actual value per second.  It is possible and more requests, but I measured the difference, not performance. <br><br>  On my hardware, the node sustained more than 1200 responses per second.  And nginx withstood them around 3,500. <br><br>  I understand that such rubbish to someone is not an indicator.  But I am very much even an indicator, given that the node's server without any cluster is spinning on the zero core, and the requests are on the first. <br><br>  Those.  the difference is not even orders of magnitude, but only at times! <br><br>  It is interesting that at first the return gradually increases, then the final figure stabilizes.  About three minutes later. <br><br>  The second test was for the node itself: <br><br><table><tbody><tr><td></td><td>  Mode </td><td>  ~ RPS </td><td>  ~ PWait </td><td>  ~ Meme </td></tr><tr><td>  one. </td><td>  When the server node and software requests did not receive affinity at all. </td><td>  1400 </td><td>  6.5 </td><td>  95M </td></tr><tr><td>  2 </td><td>  Server and Requests with affinity from the test with nginx. </td><td>  ~ 1200-1300 </td><td>  ~ 5.2 </td><td>  85M </td></tr><tr><td>  3 </td><td>  Server with affinity, requests without. </td><td>  1100 </td><td>  ~ 5.5 </td><td>  100M </td></tr><tr><td>  four. </td><td>  Server without affinity, requests with it. </td><td>  1200 </td><td>  ~ 6. </td><td>  90M </td></tr></tbody></table><br><br>  All measurements of the figures were made visually after 3 minutes of work, when everything is stabilized. <br>  Interestingly, the memory node ‚Äúintensively eats‚Äù at first, then falls a little bit, apparently the collector is working. <br><br>  <b>~ RPS</b> - roughly Requests Per Second. <br>  <b>~ PWait</b> - approximate page timeout in a real browser.  An indirect indicator of system loading when doing something else besides looking at running digits. <br><br>  For memory, I spied through htop. <br><br>  Emm - that is, everything is as if in the limit of statistical error. <br><br>  Just imagine that besides the node there are also DB, redis, HaProxy and Nginx. <br>  + Business logic is real, not a pair of adders. <br>  Whose will be "sneakers"? <br><br>  My conclusions for me: <br>  0. Node - already quite good as an interpreter. <br><ol><li>  Leave one core of the system itself, if possible. </li><li>  Leave more cores to the system if I need to ‚Äútwist‚Äù something else on it. </li><li>  The rest can be given to Node servers for 100% recycling. </li></ol><br><br>  <a href="https://github.com/wentout/nodejs_benchmark">Git</a> with dough. <br><br>  Promised Use Case: <br><ul><li>  If someone does not know, the installation of dependencies is done as <b>npm install</b> . </li><li>  If nothing is changed, then after <b>node test_requester.js,</b> you need to press Enter once to start the queries. </li><li>  Stop on Ctrl + C. </li><li>  It's all in the console.  Offtopic - I use Guake Terminal - IMHO: very convenient. </li><li>  The server starts as node test_httpserver.js. </li></ul><br><br>  Yes, and do not do tests, if you do not understand the architecture of systems at the iron level.  Want to understand - smoke manuals, for example: C. Petzold - ‚ÄúCode.  The secret language of computer science. "Everything is detailed there in a very accessible language.  I even read her grandfather, and my grandfather is 75 years old and he is a former miner. <br><br>  Just in case, I will explain - if you have 4 cores, of which real 2, then numCPUs can lie to you mercilessly. <br><br>  Yes, and my configs, if interested: <br><br><div class="spoiler">  <b class="spoiler_title">cat /etc/sysctl.conf</b> <div class="spoiler_text">  fs.file-max = 65535 <br><br>  kernel.max_lock_depth = 4096 <br>  fs.mqueue.queues_max = 1024 <br>  fs.mqueue.msg_max = 2048 <br>  fs.mqueue.msgsize_max = 16384 <br>  fs.inotify.max_user_watches = 1048576 <br>  fs.inotify.max_queued_events = 65536 <br>  fs.inotify.max_user_instances = 16384 <br>  net.ipv4.tcp_fin_timeout = 150 <br>  kernel.sem = 1000 32000 128 2048 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">cat /etc/security/limits.conf</b> <div class="spoiler_text">  root hard msgqueue 131072 <br>  root soft msgqueue 131072 <br>  root hard sigpending 131072 <br>  root soft sigpending 131072 <br>  root hard nproc 131072 <br>  root soft nproc 131072 <br>  root hard core 131072 <br>  root soft core 131072 <br>  root hard nofile 131072 <br>  root soft nofile 131072 <br><br>  * hard msgqueue 131072 <br>  * soft msgqueue 131072 <br>  * hard sigpending 131072 <br>  * soft sigpending 131072 <br>  * hard nproc 131072 <br>  * soft nproc 131072 <br>  * hard core 131072 <br>  * soft core 131072 <br>  * hard nofile 131072 <br>  * soft nofile 131072 <br></div></div><br><br>  <b>Checked without these configs, it turned out better by 30 percent.</b> <br>  ... </div><p>Source: <a href="https://habr.com/ru/post/207612/">https://habr.com/ru/post/207612/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207596/index.html">LG taught smart home to talk through the instant messenger Line</a></li>
<li><a href="../207602/index.html">Glowing snowballs, or decorating the New Year with ‚Äúimprovised materials‚Äù</a></li>
<li><a href="../207604/index.html">‚ÄúSun for Plankton‚Äù - the basis of light-modeling in DIALux</a></li>
<li><a href="../207606/index.html">Hello, my name is SiTLar, I am 30 years old and I am writing a self-documenting code</a></li>
<li><a href="../207608/index.html">New Year Testing Wiren Board</a></li>
<li><a href="../207614/index.html">Data transfer in the vehicle monitoring system - DDF technology</a></li>
<li><a href="../207616/index.html">Python-digest # 8. News, interesting projects, articles and interviews [December 20, 2013 - December 27, 2013]</a></li>
<li><a href="../207620/index.html">Porting contrib themes to Drupal 8: Getting Twig themes</a></li>
<li><a href="../207622/index.html">SIP / SIMPLE text messages in Asterisk</a></li>
<li><a href="../207624/index.html">White and black</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>