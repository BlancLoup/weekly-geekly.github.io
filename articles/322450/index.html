<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Immunitable data in C ++. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My comrades turned to me through a lichku, saying that they did not want to comment on what they did not understand or did not fully understand...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Immunitable data in C ++. Part 2</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  My comrades turned to me through a lichku, saying that they did not want to comment on what they did not understand or did not fully understand and asked for clarification.  Based on the questions I sent, I will try to give answers in an accessible form. </p><br><h1>  What is the use of immutable data in C ++? </h1><a name="habracut"></a><br><h2>  Reduced side effects </h2><br><p>  In C ++ there is physical and logical constancy.  Physical means that the object does not change (except for brute force).  Logical means that the object is outwardly unchanged, but can change the internal state. </p><br><p>  For example, </p><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Test</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  m_object } private: mutable Object m_object; }; const Test test(...); test.foo();</span></span></code> </pre> <br><p>  The object has changed.  Where it can be found: </p><br><ul><li>  caching; </li><li>  shared data; </li><li>  internal counters (for example, the number of function calls for this object), etc. </li></ul><br><p>  There are situations when we do not need such surprises.  Create an initially immutable object: </p><br><pre> <code class="cpp hljs">Immutable&lt;Test&gt; test(...);</code> </pre> <br><p>  use </p><br><pre> <code class="cpp hljs">test.foo();</code> </pre> <br><p>  or there is no operator yet.: </p><br><pre> <code class="cpp hljs">test().foo();</code> </pre> <br><p>  The test object remains unchanged.  Where it is needed: </p><br><p>  1) in parallel programming; <br>  2) when working with the "thing in itself" and we do not want surprises. </p><br><h2>  Additional level of protection </h2><br><p>  I'll start with an example: </p><br><p>  There is a constant object </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span></span>; f(x);</code> </pre> <br><p>  and function </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Test &amp;a)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">const_cast</span></span>&lt;Test&amp;&gt;(a) = value; ... }</code> </pre> <br><p>  This may be a violation, there may be an error, <strong>but the compiler does not even peep</strong> . </p><br><p>  Consider another situation.  There is an immutable object: </p><br><pre> <code class="cpp hljs">Immutable&lt;Type&gt; x(...); f(x);</code> </pre> <br><p>  and </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Immutable&lt;Test&gt; &amp;a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const_cast</span></span>&lt;Immutable&lt;Test&gt; &amp;&gt;(a) = value; }</code> </pre> <br><p>  <strong>The compiler will swear.</strong> </p><br><p>  You can break only with the help of reinterpret_cast, which can be broken off if the protected object is stored in a non-standard way (for example, in compressed / encrypted / serialized form). </p><br><p>  The same effect with </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Immutable&lt;Test&gt; &amp;a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const_cast</span></span>&lt;Immutable&lt;Test&gt; &amp;&gt;(a) = value; }</code> </pre> <br><p>  Applying Immutable, says that the object should not change. </p><br><h2>  Application in specific areas </h2><br><p>  I will not talk about FP, agent-oriented programming, about the model of actors and the blackboard, but I will say about parallel programming (the model of actors and the blackboard are actively used there). </p><br><p>  And I will say first in an informal, somewhat exaggerated way. </p><br><p>  Suppose there is a project on git (or on another version control system).  There are N programmers.  Everyone must make their version of the project.  What is being done: </p><br><ul><li>  access to the project is limited, so as not to spoil; </li><li>  everyone do fork; </li><li>  working with him; </li><li>  when finished bears the boss with the words "I dodel'". </li></ul><br><p>  The result, the initial project is whole, the boss can choose from the fork-s. </p><br><p>  Transferring this to parallel programming: </p><br><ul><li>  there are some initial data (about which it is known to a minimum); </li><li>  there are threads that must process data; </li><li>  data should be processed in different streams without problems. </li></ul><br><h2>  Contract Programming </h2><br><p>  Immunity says that there are no surprises when working with them. </p><br><h2>  Aesthetics and self-documentation </h2><br><p>  This is a question of taste, but it seems that the expression of the form </p><br><pre> <code class="cpp hljs">Immutable&lt;Type **&gt; p(...);</code> </pre> <br><p>  looks clearer than </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Type *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> p = ‚Ä¶;</code> </pre> <br><p>  because Immunity immediately says that the object <strong>should not change in any way, that constancy is used for both the address and the content</strong> . </p><br><h2>  Curvature or straightness of implementation </h2><br><p>  This is also a matter of taste.  But the implementation is made in accordance with the principles of the OP, while leaving room for effective work in the C ++ style.  See "Overhead".  You can use both the universal class Immutable and the auxiliary classes immutable :: array, immutable :: pointer, etc. These auxiliary classes are not related to each other. </p><br><h2>  Overhead </h2><br><p>  You can make an object immutable initially and pass it by reference.  Copies can do if necessary.  No one forces you to use what you do not use. </p><br><p>  If you want to work with internal data, you can get a copy of the internal data ONCE and work with them.  For this there is a function value. </p><br><p>  Here you can argue that by gaining access to internal data, you can spoil immobility.  First, value returns constant data, and secondly, it is the programmer‚Äôs conscious actions.  Many library classes return a native representation of objects, playing with which you can spoil. </p><br><p>  But this, once again, the programmer receives internal data, and in this case constant, and this is the <strong>CONSCIOUS</strong> actions of the programmer. </p><br><h2>  Optional but useful </h2><br><p>  For further study, I recommend: </p><br><p>  <strong>Matthew Wilson "A Practical Approach to Solving C ++ Programming Problems":</strong> <br>  the author of the book proposes an implementation of what he lacks in C ++ (up to C ++ 11, but some of the issues are still relevant), for example, property, etc. </p><br><p>  <strong>Andrei Alexandrescu ‚ÄúProgramming language D‚Äù</strong> , he has a peculiar style, but it is interesting to read how contract programming is built into PL. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/322450/">https://habr.com/ru/post/322450/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322440/index.html">Full automation of the ‚Äúdevelopment‚Äù environment using docker-compose</a></li>
<li><a href="../322442/index.html">MIPSfpga and in-circuit debugging</a></li>
<li><a href="../322444/index.html">Tete-a-tete: ask the right questions</a></li>
<li><a href="../322446/index.html">Emoji.prototype.length - a story about emotional characters in Unicode</a></li>
<li><a href="../322448/index.html">About spaghetti, or how to explore the business processes of an organization</a></li>
<li><a href="../322452/index.html">How to conduct A / B testing on Twitch</a></li>
<li><a href="../322454/index.html">Four non-secret advice Stirlitz</a></li>
<li><a href="../322458/index.html">After stealth: how to preserve the freshness of horror games</a></li>
<li><a href="../322460/index.html">Documenting # microservices</a></li>
<li><a href="../322462/index.html">sip messages: delayed delivery</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>